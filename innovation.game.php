<?php
 /**
  *------
  * BGA framework: © Gregory Isabelli <gisabelli@boardgamearena.com> & Emmanuel Colin <ecolin@boardgamearena.com>
  * Innovation implementation : © Jean Portemer <jportemer@gmail.com>
  * 
  * This code has been produced on the BGA studio platform for use on http://boardgamearena.com.
  * See http://en.boardgamearena.com/#!doc/Studio for more information.
  * -----
  * 
  * innovation.game.php
  *
  * This is the main file for your game logic.
  *
  * In this PHP file, you are going to defines the rules of the game.
  *
  */


require_once(APP_GAMEMODULE_PATH.'module/table/table.game.php');
require_once('modules/Innovation/Utils/Arrays.php');
require_once('modules/Innovation/Utils/Strings.php');
require_once('modules/Innovation/GameState.php');

use Innovation\Utils\Arrays;
use Innovation\Utils\Strings;
use Innovation\GameState;

/* Exception to be called when the game must end */
class EndOfGame extends Exception {}

class Innovation extends Table
{
    /** @var GameState An inverted control structure for accessing game state in a testable manner */
    private GameState $innovationGameState;

    function __construct()
    {
        // Your global variables labels:
        //  Here, you can assign labels to global variables you are using for this game.
        //  You can use any number of global variables with IDs between 10 and 99.
        //  If your game has options (variants), you also have to associate here a label to
        //  the corresponding ID in gameoptions.inc.php.
        // Note: afterwards, you can get/set the global variables with getGameStateValue/setGameStateInitialValue/setGameStateValue
        parent::__construct();
        $this->innovationGameState = new GameState($this);
        // NOTE: The following values are unused and safe to use: 20-22, 24-25, 50-68, 90-93
        self::initGameStateLabels(array(
            'number_of_achievements_needed_to_win' => 10,
            'turn0' => 11,
            'first_player_with_only_one_action' => 12,
            'second_player_with_only_one_action' => 13,
            'has_second_action' => 14,
            'game_end_type' => 15,
            'player_who_could_not_draw' => 16,
            'winner_by_dogma' => 17,
            'active_player' => 18,
            'endorse_action_state' => 19, // 0 = not allowed to do an endorse action, 1 = allowed to do an endorse action, 2 = currently executing an effect for the 1st time, 3 = currently executing an effect for the 2nd time
            'sharing_bonus' => 23,
            'special_type_of_choice' => 26,
            'choice' => 27,
            'can_pass' => 28,
            'n_min' => 29,
            'n_max' => 30,
            'solid_constraint' => 31,
            'splay_direction' => 32,
            'owner_from' => 33,
            'location_from' => 34,
            'owner_to' => 35,
            'location_to' => 36,
            'bottom_to' => 37,
            'age_min' => 38,
            'age_max' => 39,
            'color_array' => 40,
            'with_icon' => 41,
            'without_icon' => 42,
            'not_id' => 43,
            'n' => 44,
            'id_last_selected' => 45,
            'age_last_selected' => 46,
            'color_last_selected' => 47,
            'score_keyword' => 48,
            'card_id_1' => 69,
            'card_id_2' => 70,
            'card_id_3' => 71,
            'require_achievement_eligibility' => 72,
            'has_demand_effect' => 73,
            'has_splay_direction' => 74,
            'owner_last_selected' => 75,
            'type_array' => 76,
            'icon_array' => 49,
            'age_array' => 77,
            'player_array' => 78,
            'icon_hash_1' => 79,
            'icon_hash_2' => 80,
            'icon_hash_3' => 81,
            'icon_hash_4' => 82,
            'icon_hash_5' => 83,
            'enable_autoselection' => 84,
            'include_relics' => 85,
            'bottom_from' => 86,
            'with_bonus' => 87,
            'without_bonus' => 88,
            'card_ids_are_in_auxiliary_array' => 89,
            
            'melded_card_id' => 94, // ID of the card which was melded
            'relic_id' => 95, // ID of the relic which may be seized
            'current_action_number' => 96, // -1 = none, 0 = free action, 1 = first action, 2 = second action
            'current_nesting_index' => 97, // 0 refers to the originally executed card, 1 refers to a card exexcuted by that initial card, etc.
            'release_version' => 98, // Used to help release new versions of the game without breaking existing games (undefined or 0 = base game, 1 = Artifacts, 2 = Echoes, 3 = Cities, 4 = 4th edition base game)
            'debug_mode' => 99, // 0 for disabled, 1 for enabled
            
            'game_type' => 100, // 1 for normal game, 2 for team game
            'game_rules' => 101, // 1 for third edition, 2 for first edition
            'artifacts_mode' => 102, // 1 for "Disabled", 2 for "Enabled without Relics", 3 for "Enabled with Relics"
            'cities_mode' => 103, // 1 for "Disabled", 2 for "Enabled"
            'echoes_mode' => 104, // 1 for "Disabled", 2 for "Enabled"
            'extra_achievement_to_win' => 110 // 1 for "Disabled", 2 for "Enabled"
        ));
    }
    
    protected function getGameName()
    {
        return "innovation";
    }

    // TODO(4E): Simulate migration.
    function upgradeTableDb($from_version) {
        if (is_null(self::getUniqueValueFromDB("SHOW COLUMNS FROM `player` LIKE 'player_icon_count_7'"))) {
            self::applyDbUpgradeToAllDB("ALTER TABLE DBPREFIX_player ADD `player_icon_count_7` SMALLINT UNSIGNED NOT NULL DEFAULT 0;");
        }
        if (is_null(self::getUniqueValueFromDB("SHOW COLUMNS FROM `player` LIKE 'democracy_counter'"))) {
            self::applyDbUpgradeToAllDB("ALTER TABLE DBPREFIX_player ADD `democracy_counter` TINYINT UNSIGNED NOT NULL DEFAULT 0;");
        }
        // TODO(4E): Update what we are using to compare from_version. 
        if ($from_version <= 2302100853) {
            self::initGameStateLabels(array(
                'icon_array' => 49,
            ));
            $this->innovationGameState->set('icon_array', Arrays::getArrayAsValue([1,2,3,4,5,6]));
        }
        if ($from_version <= 2302100853) {
            self::initGameStateLabels(array(
                'endorse_action_state' => 19,
            ));
            $this->innovationGameState->set('endorse_action_state', 0);
        }
    }

    //****** CODE FOR DEBUG MODE
    function debug_draw($card_id) {
        if ($this->innovationGameState->get('debug_mode') == 0) {
            return; // Not in debug mode
        }
        $player_id = self::getCurrentPlayerId();
        $card = self::getCardInfo($card_id);
        $card['using_debug_buttons'] = true;
        if ($card['location'] == 'achievements' || $card['location'] == 'board' || $card['location'] == 'deck' || $card['location'] == 'relics' || $card['location'] == 'score' || ($card['location'] == 'hand' && $card['owner'] != $player_id)) {
            self::transferCardFromTo($card, $player_id, 'hand');
        } else if ($card['location'] == 'removed') {
            throw new BgaUserException("This card is removed from the game");
        } else {
            throw new BgaUserException(self::format("This card is in {player_name}'s {location}", array('player_name' => self::getPlayerNameFromId($card['owner']), 'location' => $card['location'])));
        }
    }
    function debug_meld($card_id) {
        if ($this->innovationGameState->get('debug_mode') == 0) {
            return; // Not in debug mode
        }
        // The melding is being done in two steps because otherwise many of the transitions would not be supported.
        $player_id = self::getCurrentPlayerId();
        $card = self::getCardInfo($card_id);
        $card['using_debug_buttons'] = true;
        if (!($card['location'] == 'hand' && $card['owner'] == $player_id)) {
            self::debug_draw($card_id);
            $card = self::getCardInfo($card_id);
            $card['using_debug_buttons'] = true;
        }
        self::transferCardFromTo($card, $player_id, 'board');
    }
    function debug_tuck($card_id) {
        if ($this->innovationGameState->get('debug_mode') == 0) {
            return; // Not in debug mode
        }
        // The tucking is being done in two steps because otherwise many of the transitions would not be supported.
        $player_id = self::getCurrentPlayerId();
        $card = self::getCardInfo($card_id);
        $card['using_debug_buttons'] = true;
        if (!($card['location'] == 'hand' && $card['owner'] == $player_id)) {
            self::debug_draw($card_id);
            $card = self::getCardInfo($card_id);
            $card['using_debug_buttons'] = true;
        }
        self::transferCardFromTo($card, $player_id, 'board', /*bottom_to=*/ true);
    }
    function debug_score($card_id) {
        if ($this->innovationGameState->get('debug_mode') == 0) {
            return; // Not in debug mode
        }
        $player_id = self::getCurrentPlayerId();
        $card = self::getCardInfo($card_id);
        $card['using_debug_buttons'] = true;
        if ($card['location'] == 'hand' || $card['location'] == 'board' || $card['location'] == 'deck') {
            self::scoreCard($card, $player_id);
        } else if ($card['location'] == 'achievements') {
            throw new BgaUserException("This card is used as an achievement");
        } else if ($card['location'] == 'relics') {
            throw new BgaUserException("This card is used as a relic");
        } else if ($card['location'] == 'removed') {
            throw new BgaUserException("This card is removed from the game");
        } else {
            throw new BgaUserException(self::format("This card is in {player_name}'s {location}", array('player_name' => self::getPlayerNameFromId($card['owner']), 'location' => $card['location'])));
        }
    }
    function debug_achieve($card_id) {
        if ($this->innovationGameState->get('debug_mode') == 0) {
            return; // Not in debug mode
        }
        $player_id = self::getCurrentPlayerId();
        $card = self::getCardInfo($card_id);
        $card['using_debug_buttons'] = true;
        if ($card['location'] == 'achievements' && $card['owner'] == $player_id) {
            throw new BgaUserException("You already have this card as an achievement");
        } else if ($card['location'] == 'removed') {
            throw new BgaUserException("This card is removed from the game");
        } else if ($card['owner'] == 0 || $card['location'] == 'hand' || $card['location'] == 'board' || $card['location'] == 'score') {
            try {
                self::transferCardFromTo($card, $player_id, "achievements");
            }
            catch (EndOfGame $e) {
                // End of the game: the exception has reached the highest level of code
                self::trace('EOG bubbled from self::debug_achieve');
                $this->gamestate->nextState('justBeforeGameEnd');
                return;
            }
        } else {
            throw new BgaUserException(self::format("This card is in {player_name}'s {location}", array('player_name' => self::getPlayerNameFromId($card['owner']), 'location' => $card['location'])));
        }
       
    }
    function debug_return($card_id) {
        if ($this->innovationGameState->get('debug_mode') == 0) {
            return; // Not in debug mode
        }
        $player_id = self::getCurrentPlayerId();
        $card = self::getCardInfo($card_id);
        $card['using_debug_buttons'] = true;

        if ($card['location'] == 'forecast') {
            $card = self::transferCardFromTo($card, $player_id, 'revealed');
            $card['using_debug_buttons'] = true;
        }

        if ($card['location'] == 'deck') {
            throw new BgaUserException("This card is already in the deck");
        } else if ($card['location'] == 'relics') {
            throw new BgaUserException("This card is already in the relics area");
        } else if ($card['location'] == 'removed') {
            throw new BgaUserException("This card is removed from the game");
        } else if ($card['id'] >= 1100) {
            self::transferCardFromTo($card, 0, 'fountains');
        } else if ($card['id'] >= 1000) {
            self::transferCardFromTo($card, 0, 'flags');
        } else if ($card['location'] == 'hand' || $card['location'] == 'board' || $card['location'] == 'score' || $card['location'] == 'display' || $card['location'] == 'achievements' || $card['location'] == 'revealed') {
            try {
                self::returnCard($card);
            }
            catch (EndOfGame $e) {
                // End of the game: the exception has reached the highest level of code
                self::trace('EOG bubbled from self::debug_return');
                $this->gamestate->nextState('justBeforeGameEnd');
                return;
            }
        } else {
            throw new BgaUserException(self::format("This card is in {player_name}'s {location}", array('player_name' => self::getPlayerNameFromId($card['owner']), 'location' => $card['location'])));
        }
    }
    function debug_topdeck($card_id) {
        if ($this->innovationGameState->get('debug_mode') == 0) {
            return; // Not in debug mode
        }
        // The topdecking is being done in two steps because otherwise many of the transitions would not be supported.
        $player_id = self::getCurrentPlayerId();
        $card = self::getCardInfo($card_id);
        $card['using_debug_buttons'] = true;
        if (!($card['location'] == 'hand' && $card['owner'] == $player_id)) {
            self::debug_draw($card_id);
            $card = self::getCardInfo($card_id);
            $card['using_debug_buttons'] = true;
        }
        self::transferCardFromTo($card, 0, 'deck', /*bottom_to=*/ false);
    }
    function debug_dig($card_id) {
        if ($this->innovationGameState->get('debug_mode') == 0) {
            return; // Not in debug mode
        }
        $player_id = self::getCurrentPlayerId();
        $card = self::getCardInfo($card_id);
        $card['using_debug_buttons'] = true;
        if (self::getArtifactOnDisplay($player_id) != null) {
            throw new BgaUserException("There is already an Artifact on display");
        } else if ($card['location'] == 'achievements') {
            throw new BgaUserException("This card is used as an achievement");
        } else if ($card['location'] == 'relics') {
            throw new BgaUserException("This card is used as a relic");
        } else if ($card['location'] == 'removed') {
            throw new BgaUserException("This card is removed from the game");
        } else if ($card['location'] == 'deck') {
            try {
                self::transferCardFromTo($card, $player_id, "display");
            }
            catch (EndOfGame $e) {
                // End of the game: the exception has reached the highest level of code
                self::trace('EOG bubbled from self::debug_dig');
                $this->gamestate->nextState('justBeforeGameEnd');
                return;
            }
        } else {
            throw new BgaUserException(self::format("This card is in {player_name}'s {location}", array('player_name' => self::getPlayerNameFromId($card['owner']), 'location' => $card['location'])));
        }
    }
    function debug_foreshadow($card_id) {
        if ($this->innovationGameState->get('debug_mode') == 0) {
            return; // Not in debug mode
        }
        $player_id = self::getCurrentPlayerId();
        $card = self::getCardInfo($card_id);
        $card['using_debug_buttons'] = true;
        if ($card['location'] == 'achievements') {
            throw new BgaUserException("This card is used as an achievement");
        } else if ($card['location'] == 'relics') {
            throw new BgaUserException("This card is used as a relic");
        } else if ($card['location'] == 'removed') {
            throw new BgaUserException("This card is removed from the game");
        } else if ($card['location'] == 'deck') {
            try {
                self::transferCardFromTo($card, $player_id, "forecast");
            }
            catch (EndOfGame $e) {
                // End of the game: the exception has reached the highest level of code
                self::trace('EOG bubbled from self::debug_foreshadow');
                $this->gamestate->nextState('justBeforeGameEnd');
                return;
            }
        } else {
            throw new BgaUserException(self::format("This card is in {player_name}'s {location}", array('player_name' => self::getPlayerNameFromId($card['owner']), 'location' => $card['location'])));
        }
    }
    function debug_splay($color, $direction) {
        if ($this->innovationGameState->get('debug_mode') == 0) {
            return; // Not in debug mode
        }
        $player_id = self::getCurrentPlayerId();
        self::splay($player_id, $player_id, $color, $direction);
    }
    //******
    
    /*
        setupNewGame:
        
        This method is called only once, when a new game is launched.
        In this method, you must setup the game according to the game rules, so that
        the game is ready to be played.
    */
    protected function setupNewGame($players, $options = array())
    {
        self::DbQuery("DELETE FROM player WHERE TRUE"); 
        
        // Set the colors of the players with HTML color code
        // The available colors are blue, red, green and yellow
        // There are compatible with player preferences
        $default_colors = array("0000ff", "ff0000", "008000", "ffa500", "0000000");
        
        // Create players
        // Note: if you added some extra field on "player" table in the database (dbmodel.sql), you can initialize it there.
        
        $game_type = $this->innovationGameState->get('game_type');
        $individual_game = self::decodeGameType($game_type) == 'individual';
        
        if ($game_type > 2) { // Team game with fixed teams (1 vs 2 or vs 3 or vs 4)
            $teammate_of_first = $game_type - 1; // 2nd if game_mode is 3, 3rd if game_mode is 4, 4th if game_mode is 5
            $players = self::rearrangePlayersForFixedTeams($players, $teammate_of_first);
        }
        
        $sql = "INSERT INTO player (player_id, player_color, player_canal, player_name, player_avatar, player_team) VALUES ";
        $values = array();
        $t = 0;
        
        foreach($players as $player_id => $player) {
            $color = $default_colors[$t]; // There is a blue team and a red team: preferences of players on colors are disabled
            $values[$player_id] = "('".$player_id."','$color','".$player['player_canal']."','".addslashes($player['player_name'])."','".addslashes($player['player_avatar'])."',".($t+1).")";
            if ($individual_game) {
                $t++;
            }
            else { // Team game: the players of the same team are sit in front of each other
                $t = ($t+1)%2;
            }
        }
        $sql .= implode($values, ',');
        self::DbQuery($sql);
        if ($individual_game) { // We can take into account the preferences of players on colors
            self::reattributeColorsBasedOnPreferences($players, $default_colors);
        }
        self::reloadPlayersBasicInfos();
        
        /************ Start the game initialization *****/

        // Indicate that this production game was created after the 4th edition base game was released
        // TODO(FIGURES): Update this before releasing future expansions.
        $this->innovationGameState->setInitial('release_version', 4);

        // Init global values with their initial values
        $this->innovationGameState->set('debug_mode', $this->getBgaEnvironment() == 'studio' ? 1 : 0);
        
        // Number of achievements needed to win: 6 with 2 players, 5 with 3 players, 4 with 4 players and 6 for team game
        $number_of_achievements_needed_to_win = $individual_game ? 8 - count($players) : 6;
        $this->innovationGameState->setInitial('number_of_achievements_needed_to_win', $number_of_achievements_needed_to_win);

        // Add one required achievement for each expansion
        if ($this->innovationGameState->artifactsExpansionEnabled()) {
            $this->innovationGameState->increment('number_of_achievements_needed_to_win');
        }

        if ($this->innovationGameState->citiesExpansionEnabled()) {
            $this->innovationGameState->increment('number_of_achievements_needed_to_win');
        }
        
        if ($this->innovationGameState->echoesExpansionEnabled()) {
            $this->innovationGameState->increment('number_of_achievements_needed_to_win');
        }
        // Add extra achievement to win
        if ($this->innovationGameState->get('extra_achievement_to_win') > 1) {
            $this->innovationGameState->increment('number_of_achievements_needed_to_win');
        }

        // Flag used to know if we are still on turn0 (1) or not (0)
        $this->innovationGameState->setInitial('turn0', 1);
        
        // Flags used to know if the player has one or two actions to perform
        $this->innovationGameState->setInitial('first_player_with_only_one_action', 1);
        $this->innovationGameState->setInitial('second_player_with_only_one_action', count($players) >= 4 ? 1 : 0); // used when >= 4 players only
        $this->innovationGameState->setInitial('has_second_action', 1);
        $this->innovationGameState->setInitial('current_action_number', -1);
        $this->innovationGameState->setInitial('endorse_action_state', 0);
        
        // Flags used when the game ends to know how it ended
        $this->innovationGameState->setInitial('game_end_type', -1); // 0 for game end by achievements, 1 for game end by score, -1 for game end by dogma
        $this->innovationGameState->setInitial('player_who_could_not_draw', -1); // When end of game by score, id of the player who triggered it

        // Flag used to remember whose turn it is
        $this->innovationGameState->setInitial('active_player', -1);
        
        // Flags used in dogma to remember player roles and which card it is, which effect (yet -1 as default value since there are not currently in use)
        $this->innovationGameState->setInitial('sharing_bonus', -1); // 1 if the dogma player will have a sharing bonus, else 0
        $this->innovationGameState->setInitial('current_nesting_index', -1);
        self::DbQuery("
            INSERT INTO nested_card_execution (
                nesting_index,
                card_id,
                executing_as_if_on_card_id,
                launcher_id,
                current_player_id,
                current_effect_type,
                current_effect_number,
                step,
                step_max
            ) VALUES (0, -1, -1, -1, -1, -1, -1, -1, -1)");
        
        // Flag used for player interaction in dogma to remember what splay is proposed (-1 as default and if the choice does not involve splaying)
        $this->innovationGameState->setInitial('splay_direction', -1);
        
        // Flags used to describe the range of the selection the player in dogma must take (yet -1 as default value since there are not currently in use)
        $this->innovationGameState->setInitial('special_type_of_choice', -1); // Indicate the type of choice the player faces. See encodeSpecialTypeOfChoice() for possible values.
        $this->innovationGameState->setInitial('choice', -1); // Numeric choice when the player has to make a special choice (-2 if the player passed)
        $this->innovationGameState->setInitial('n_min', -1); // Minimal number of cards to be chosen (999 stands for all possible)
        $this->innovationGameState->setInitial('n_max', -1); // Maximal number of cards to be chosen (999 stands for no limit)
        $this->innovationGameState->setInitial('solid_constraint', -1); // 1 if there need to be at least n_min cards to trigger the effect or 0 if it is triggered no matter what, which will consume all eligible cards (do what you can rule)
        $this->innovationGameState->setInitial('owner_from', -1); // Owner from whom choose the card (0 for nobody, -2 for any player, -3 for any opponent, -4 for any other player)
        $this->innovationGameState->setInitial('location_from', -1); // Location from where choose the card (0 for deck, 1 for hand, 2 for board, 3 for score)
        $this->innovationGameState->setInitial('owner_to', -1); // Owner to whom the chosen card will be transfered (0 for nobody)
        $this->innovationGameState->setInitial('location_to', -1); // Location where the chosen card will be transfered (0 for deck, 1 for hand, 2 for board, 3 for score)
        $this->innovationGameState->setInitial('age_min', -1); // Age min of the card to be chosen
        $this->innovationGameState->setInitial('age_max', -1); // Age max of the card to be chosen
        $this->innovationGameState->setInitial('age_array', -1); // List of selectable ages encoded in a single value
        $this->innovationGameState->setInitial('color_array', -1); // List of selectable colors encoded in a single value
        $this->innovationGameState->setInitial('type_array', -1); // List of selectable types encoded in a single value
        $this->innovationGameState->setInitial('icon_array', -1); // List of selectable icons encoded in a single value
        $this->innovationGameState->setInitial('player_array', -1); // List of selectable players encoded in a single value (players are listed by their 'player_no', not their 'player_id')
        $this->innovationGameState->setInitial('with_icon', -1); // 0 if there is no specific icon for the card to be selected, else the number of the icon needed
        $this->innovationGameState->setInitial('without_icon', -1); // 0 if there is no specific icon for the card to be selected, else the number of the icon which can't be selected
        $this->innovationGameState->setInitial('not_id', -1); // id of a card which cannot be selected, else -2
        $this->innovationGameState->setInitial('card_id_1', -1); // id of a card which is allowed to be selected, else -2
        $this->innovationGameState->setInitial('card_id_2', -1); // id of a card which is allowed to be selected, else -2
        $this->innovationGameState->setInitial('card_id_3', -1); // id of a card which is allowed to be selected, else -2
        $this->innovationGameState->setInitial('icon_hash_1', -1); // icon hash of a card which is allowed to be selected, else -1
        $this->innovationGameState->setInitial('icon_hash_2', -1); // icon hash of a card which is allowed to be selected, else -1
        $this->innovationGameState->setInitial('icon_hash_3', -1); // icon hash of a card which is allowed to be selected, else -1
        $this->innovationGameState->setInitial('icon_hash_4', -1); // icon hash of a card which is allowed to be selected, else -1
        $this->innovationGameState->setInitial('icon_hash_5', -1); // icon hash of a card which is allowed to be selected, else -1
        $this->innovationGameState->setInitial('enable_autoselection', -1); // 1 if cards are allowed to be autoselected during an interaction
        $this->innovationGameState->setInitial('include_relics', -1); // 1 if relics cards are allowed to be selected during an interaction
        $this->innovationGameState->setInitial('with_bonus', -1); // 1 if only cards with a bonus are allowed to be selected during an interaction
        $this->innovationGameState->setInitial('without_bonus', -1); // 1 if only cards without a bonus are allowed to be selected during an interaction
        $this->innovationGameState->setInitial('card_ids_are_in_auxiliary_array', -1); // 1 if only cards whose ID are in the auxiliary array are allowed to be selected during an interaction
        $this->innovationGameState->setInitial('can_pass', -1); // 1 if the player can pass else 0
        $this->innovationGameState->setInitial('n', -1); // Actual number of cards having being selected yet
        $this->innovationGameState->setInitial('id_last_selected', -1); // Id of the last selected card
        $this->innovationGameState->setInitial('age_last_selected', -1); // Age of the last selected card
        $this->innovationGameState->setInitial('color_last_selected', -1); // Color of the last selected card
        $this->innovationGameState->setInitial('owner_last_selected', -1); // Owner of the last selected card
        $this->innovationGameState->setInitial('score_keyword', -1); // 1 if the action with the chosen card will be scoring, else 0
        $this->innovationGameState->setInitial('require_achievement_eligibility', -1); // 1 if the numeric achievement card can only be selected if the player is eligible to claim it based on their score
        $this->innovationGameState->setInitial('has_demand_effect', -1); // 1 if the card to be chosen must have a demand effect on it
        $this->innovationGameState->setInitial('has_splay_direction', -1); // List of splay directions encoded in a single value
        
        // Flags specific to the meld action
        $this->innovationGameState->setInitial('relic_id', -1);
        $this->innovationGameState->setInitial('melded_card_id', -1);
        
        // Init game statistics
        self::initStat('table', 'turns_number', 0);
        self::initStat('player', 'turns_number', 0);
        self::initStat('table', 'actions_number', 0);
        self::initStat('player', 'actions_number', 0);
        
        self::initStat('table', 'end_achievements', false);
        self::initStat('table', 'end_score', false);
        self::initStat('table', 'end_dogma', false);
        self::initStat('table', 'fission_triggered', false);

        self::initStat('player', 'achievements_number', 0);
        self::initStat('player', 'score', 0);
        self::initStat('player', 'max_age_on_board', 0);    
        self::initStat('player', 'draw_actions_number', 0);
        self::initStat('player', 'meld_actions_number', 0);
        self::initStat('player', 'dogma_actions_number', 0);
        self::initStat('player', 'achieve_actions_number', 0);
        self::initStat('player', 'special_achievements_number', 0);
        self::initStat('player', 'dogma_actions_number_with_i_demand', 0);
        self::initStat('player', 'dogma_actions_number_with_sharing', 0);
        self::initStat('player', 'i_demand_effects_number', 0);
        self::initStat('player', 'sharing_effects_number', 0);
        
        // Add cards from expansions that are in use.
        if ($this->innovationGameState->artifactsExpansionEnabled()) {
            self::DbQuery("UPDATE card SET location = 'deck', position = NULL WHERE 110 <= id AND id <= 214");
            if ($this->innovationGameState->artifactsExpansionEnabledWithRelics()) {
                self::DbQuery("UPDATE card SET location = 'relics', position = 0 WHERE is_relic");
            }
        }

        if ($this->innovationGameState->citiesExpansionEnabled()) {
            self::DbQuery("UPDATE card SET location = 'deck', position = NULL WHERE 220 <= id AND id <= 324");
            self::DbQuery("UPDATE card SET location = 'achievements' WHERE 325 <= id AND id <= 329");
        }

        if ($this->innovationGameState->echoesExpansionEnabled()) {
            self::DbQuery("UPDATE card SET location = 'deck', position = NULL WHERE 330 <= id AND id <= 434");
            self::DbQuery("UPDATE card SET location = 'achievements' WHERE 435 <= id AND id <= 439");
        }

        if (!$this->innovationGameState->usingFourthEditionRules()) {
            // Certain cards got new symbols in the 4th edition, so we need to revert them when using an earlier edition
            self::DbQuery("UPDATE card SET spot_2 = 6 WHERE id = 96"); // Software
            self::DbQuery("UPDATE card SET spot_3 = 6 WHERE id = 98"); // Robotics
            self::DbQuery("UPDATE card SET spot_3 = 1 WHERE id = 100"); // Self Service
            self::DbQuery("UPDATE card SET spot_3 = 6, spot_4 = 3, dogma_icon = 6 WHERE id = 104"); // The Internet
            // Remove age 11 cards from play when using an earlier edition
            self::DbQuery("UPDATE card SET location = 'removed' WHERE age = 11");
        }
        
        // Initialize Artifacts-specific statistics
        if ($this->innovationGameState->artifactsExpansionEnabled()) {
            self::initStat('player', 'dig_events_number', 0);
            self::initStat('player', 'free_action_dogma_number', 0);
            self::initStat('player', 'free_action_return_number', 0);
            self::initStat('player', 'free_action_pass_number', 0);
            self::initStat('player', 'dogma_actions_number_targeting_artifact_on_board', 0);
            self::initStat('player', 'dogma_actions_number_with_i_compel', 0);
            self::initStat('player', 'i_compel_effects_number', 0);
            
            // Initialize Relic-specific statistics
            if ($this->innovationGameState->artifactsExpansionEnabledWithRelics()) {
                self::initStat('player', 'relics_seized_number', 0);
                self::initStat('player', 'relics_stolen_number', 0);
            }
        }

        // Initialize Cities-specific statistics
        if ($this->innovationGameState->citiesExpansionEnabled()) {
            self::initStat('player', 'endorse_actions_number', 0);
            self::initStat('player', 'city_cards_drawn_number', 0);
        }

        // Initialize Echoes-specific statistics
        if ($this->innovationGameState->echoesExpansionEnabled()) {
            self::initStat('player', 'foreshadowed_number', 0);
            self::initStat('player', 'promoted_number', 0);
            self::initStat('player', 'executed_echo_effect_number', 0);
        }
        
        // Store the age of each card when face-up
        self::DbQuery("UPDATE card SET faceup_age = (CASE id WHEN 188 THEN 11 ELSE age END)");

        // Card shuffling in decks
        self::shuffle();
        
        // Isolate one base card of each age (except the highest age) to create the available age achievements
        self::extractAgeAchievements();
        
        // Deal 2 cards of age 1 to each player
        for ($times = 0; $times < 2; $times++) {
            foreach ($players as $player_id => $player) {
                self::executeDraw($player_id, 1);
            }
        }

        // Add information to the database about which cards have a demand.
        foreach ($this->textual_card_infos as $id => $card_info) {
            if (self::getDemandEffect($id) !== null) {
                self::DbQuery(self::format("UPDATE card SET has_demand = TRUE WHERE id = {id}", array("id" => $id)));
            }
        }

        // Activate first player
        $this->activeNextPlayer();

        /************ End of the game initialization *****/
    }

    /*
        getAllDatas: 
        
        Gather all informations about current game situation (visible by the current player).
        
        The method is called each time the game interface is displayed to a player, ie:
        _ when the game starts
        _ when a player refreshes the game page (F5)
    */
    protected function getAllDatas() {
        $result = array();
        
        $result['debug_mode'] = $this->innovationGameState->get('debug_mode');

        // Get static information about all cards
        $cards  = array();
        foreach (self::getStaticInfoOfAllCards() as $card) {
            $cards[$card['id']] = $card;
        }
        $result['cards'] = $cards;

        $result['fourth_edition'] = $this->innovationGameState->usingFourthEditionRules();
        $result['artifacts_expansion_enabled'] = $this->innovationGameState->artifactsExpansionEnabled();
        $result['relics_enabled'] = $this->innovationGameState->artifactsExpansionEnabledWithRelics();
        $result['cities_expansion_enabled'] = $this->innovationGameState->citiesExpansionEnabled();
        $result['echoes_expansion_enabled'] = $this->innovationGameState->echoesExpansionEnabled();
        // TODO(FIGURES): Update this when the expansion is added.
        $result['figures_expansion_enabled'] = false;
    
        $current_player_id = self::getCurrentPlayerId();    // !! We must only return information visible by this player !!
        
        // Get information about players
        $players = self::getCollectionFromDb("SELECT player_id, player_score, player_team, player_eliminated FROM player");
        $result['players'] = $players;
        $result['current_player_id'] = $current_player_id;
        
        // Public information

        // Number of achievements needed to win
        $result['number_of_achievements_needed_to_win'] = $this->innovationGameState->get('number_of_achievements_needed_to_win');
        
        // All boards
        $result['board'] = self::getBoards(self::getAllPlayerIds());
        
        // Splay state for stacks on board
        $result['board_splay_directions'] = array();
        $result['board_splay_directions_in_clear'] = array();
        foreach($players as $player_id => $player) {
            $result['board_splay_directions'][$player_id] = array();
            $result['board_splay_directions_in_clear'][$player_id] = array();
            for($color = 0; $color < 5 ; $color++) {
                $direction = self::getCurrentSplayDirection($player_id, $color);
                $result['board_splay_directions'][$player_id][] = $direction;
                $result['board_splay_directions_in_clear'][$player_id][] = self::getSplayDirectionInClear($direction);
            }
        }

        // Artifacts on display
        $result['artifacts_on_display'] = self::getArtifactsOnDisplay($players);
        
        // Backs of the cards in hands
        $result['hand_counts'] = array();
        for ($type = 0; $type <= 4; $type++) {
            for ($is_relic = 0; $is_relic <= 1; $is_relic++) {
                foreach ($players as $player_id => $player) {
                    $result['hand_counts'][$player_id][$type][$is_relic] = self::countCardsInLocationKeyedByAge($player_id, 'hand', $type, $is_relic);
                }
            }
        }

        // Backs of the cards in forecast piles
        $result['forecast_counts'] = array();
        for ($type = 0; $type <= 4; $type++) {
            for ($is_relic = 0; $is_relic <= 1; $is_relic++) {
                foreach ($players as $player_id => $player) {
                    $result['forecast_counts'][$player_id][$type][$is_relic] = self::countCardsInLocationKeyedByAge($player_id, 'forecast', $type, $is_relic);
                }
            }
        }

        // Backs of the cards in score piles
        $result['score_counts'] = array();
        for ($type = 0; $type <= 4; $type++) {
            for ($is_relic = 0; $is_relic <= 1; $is_relic++) {
                foreach ($players as $player_id => $player) {
                    $result['score_counts'][$player_id][$type][$is_relic] = self::countCardsInLocationKeyedByAge($player_id, 'score', $type, $is_relic);
                }
            }
        }
        
        // Score (totals in the score piles) for each player
        $result['score'] = array();
        foreach ($players as $player_id => $player) {
            $result['score'][$player_id] = self::getPlayerScore($player_id);
        }
        
        // Revealed cards
        $result['revealed'] = array();
        foreach($players as $player_id => $player) {
            $result['revealed'][$player_id] = self::getCardsInLocation($player_id, 'revealed');
        }

        // Unclaimed relics
        $result['unclaimed_relics'] = self::getCardsInLocation(0, 'relics');
        
        // Unclaimed achievements
        // TODO(#229): Deprecate this and add a new unclaimed_special_achievements entry.
        $result['unclaimed_achievements'] = self::getCardsInLocation(0, 'achievements');
        $result['unclaimed_standard_achievement_counts'] = array();
        for ($type = 0; $type <= 4; $type++) {
            for ($is_relic = 0; $is_relic <= 1; $is_relic++) {
                $result['unclaimed_standard_achievement_counts'][$type][$is_relic] = self::countCardsInLocationKeyedByAge(0, 'achievements', $type, $is_relic);
            }
        }
        
        // Claimed achievements for each player
        // TODO(#229): Pass counts instead of list of cards (the flags and fountains will still need the full cards passed).
        $result['claimed_achievements'] = array();
        foreach ($players as $player_id => $player) {
            $result['claimed_achievements'][$player_id] = self::getCardsInLocation($player_id, 'achievements');
        }
        
        // Ressources for each player
        $result['ressource_counts'] = array();
        foreach ($players as $player_id => $player) {
            $result['ressource_counts'][$player_id] = self::getPlayerResourceCounts($player_id);
        }
        
        // Max age on board for each player
        $result['max_age_on_board'] = array();
        foreach ($players as $player_id => $player) {
            $result['max_age_on_board'][$player_id] = self::getMaxAgeOnBoardTopCards($player_id);
        }
        
        // Remaining cards in deck
        for ($type = 0; $type <= 4; $type++) {
            $result['deck_counts'][$type] = self::countCardsInLocationKeyedByAge(0, 'deck', $type);
        }
        
        // Turn0 or not
        $result['turn0'] = $this->innovationGameState->get('turn0') == 1;
        
        // Number of achievements needed to win
        $result['number_of_achievements_needed_to_win'] = $this->innovationGameState->get('number_of_achievements_needed_to_win');
        
        // Link to the current dogma effect (if any)
        $nested_card_state = self::getCurrentNestedCardState();
        if ($nested_card_state == null) {
            $JSCardEffectQuery = null;
        } else {
            $current_effect_type = $nested_card_state['current_effect_type'];
            $current_effect_number = $nested_card_state['current_effect_number'];
            $card_id = $nested_card_state['card_id'];

            // Echo effects are sometimes executed on cards other than the card being dogma'd
            if ($current_effect_type == 3) {
                $nesting_index = $nested_card_state['nesting_index'];
                $card_id = self::getUniqueValueFromDB(
                    self::format("SELECT card_id FROM echo_execution WHERE nesting_index = {nesting_index} AND execution_index = {effect_number}",
                        array('nesting_index' => $nesting_index, 'effect_number' => $current_effect_number)));
            }

            $JSCardEffectQuery = $card_id == -1 ? null : self::getJSCardEffectQuery(self::getCardInfo($card_id), $current_effect_type, $current_effect_number);
        }
        $result['JSCardEffectQuery'] = $JSCardEffectQuery;
        
        // Whose turn is it?
        $active_player = $this->innovationGameState->get('active_player');
        $result['active_player'] = $active_player == -1 ? null : $active_player;
        if ($active_player != -1) {
            $action_number = $this->innovationGameState->get('current_action_number');
            $result['action_number'] = $action_number;
            $card = self::getArtifactOnDisplay($active_player);
            if ($card !== null && $this->gamestate->state()['name'] == 'artifactPlayerTurn') {
                $result['artifact_on_display_icons'] = array();
                $result['artifact_on_display_icons']['resource_icon'] = $card['dogma_icon'];
                $result['artifact_on_display_icons']['resource_count_delta'] = self::countIconsOnCard($card, $card['dogma_icon']);
            }
        }
        
        // Private information
        $result['my_hand'] = Arrays::flatten(self::getCardsInLocationKeyedByAge($current_player_id, 'hand'));
        $result['my_forecast'] = Arrays::flatten(self::getCardsInLocationKeyedByAge($current_player_id, 'forecast'));
        $result['my_score'] = Arrays::flatten(self::getCardsInLocationKeyedByAge($current_player_id, 'score'));
        
        // My wish for splay
        $result['display_mode'] = self::getPlayerWishForSplay($current_player_id);        
        $result['view_full'] = self::getPlayerWishForViewFull($current_player_id);

        // Counters used for the Monument special achievement
        $result['monument_counters'] = self::getFlagsForMonument($current_player_id);
        
        return $result;
    }

    /*
        getGameProgression:
        
        Compute and return the current game progression.
        The number returned must be an integer beween 0 (=the game just started) and
        100 (= the game is finished or almost finished).
    
        This method is called each time we are in a game state with the "updateGameProgression" property set to true 
       
    */
    function getGameProgression()
    {    
        // Start or end of game
        $current_state = $this->gamestate->state();
        switch($current_state['name']) {
        case 'gameSetup':
        case 'turn0':
            return 0;
        case 'whoBegins':
            return 1;
        case 'justBeforeGameEnd':
        case 'gameEnd':
            return 100;
        }
        // For other states (all included in player action)
        $players = self::loadPlayersBasicInfos();
        
        // The total progression is a mix of:
        // -the progression of the decreasing number of cards in deck (end of game by score)
        // -the progression of each player in terms of the achievements they get
        
        // Progression in cards
        // Hypothesis: a card of age 9 is drawn three times quicker than a card of age 1. Cards of age 10 are worth six times a card of age 1 because if there are none left it is the end of the game
        $weight = 0;
        $total_weight = 0;
        
        // TODO(4E): Update game progression calculations.
        $number_of_cards_in_decks = self::countCardsInLocationKeyedByAge(0, 'deck', /*type=*/ 0);
        for($age=1; $age<=10; $age++) {
            $n = $number_of_cards_in_decks[$age];
            switch($age) {
            case 1:
                $n_max  = 14 - 2 * count($players); // number of cards in the deck at the beginning: 14 (15 minus one taken for achievement) minus the cards dealt to the players at the beginning
                $w = 1; // weight for cards of age 1: 1
                break;
            case 10:
                $n++; // one more "virtual" card because the game is not over where the tenth age 10 card is drawn (but quite...)
                $n_max = 11; // number of cards in the deck at the beginning: 10, +1 one more "virtual" card because the game is not over when the last is drawn
                $w = 6; // weight for cards of age 10: 6
                break;
            default:
                $n_max = 9; // number of cards in the deck at the beginning: 9 (10 minus one taken for achievement)
                $w = ($age-1) / 4 + 1; // weight between 1.25 (for age 2) and 3 (for age 9)
                break;
            };
            $weight += ($n_max - $n) * $w; // What is really important are the cards already drawn
            $total_weight += $n_max  * $w;
        }
        $progression_in_cards = $weight/$total_weight;
        
        // Progression of players
        // This is the ratio between the number of achievements the player have got so far and the number of achievements needed to win the game
        $progression_of_players = array();
        $n_max = $this->innovationGameState->get('number_of_achievements_needed_to_win');
        foreach($players as $player_id=>$player) {
            $n = self::getPlayerNumberOfAchievements($player_id);
            $progression_of_players[] = $n/$n_max;
        }
        
        // If any of the above progression was 100%, the game would be over. So, 100% is a kind of "absorbing" element. So,the method is to multiply the complements of the progression.
        // A complement is defined as 100% - progression
        $complement = 1 - $progression_in_cards;
        foreach($progression_of_players as $progression) {
            $complement *= 1 - $progression;
        }
        $final_progression = 1 - $complement;
        
        // Convert the final result in percentage
        $percentage = intval(100 * $final_progression);
        $percentage = min(max(1, $percentage), 99); // Set that progression between 1% and 99%
        return $percentage;
    }


//////////////////////////////////////////////////////////////////////////////
//////////// Utility functions
////////////    

    /*
        In this space, you can put any utility methods useful for your game logic
    */
    
    function getFaceupAgeLastSelected() {
        return self::getUniqueValueFromDB(self::format("SELECT faceup_age FROM card WHERE id = {id}", array('id' => $this->innovationGameState->get('id_last_selected'))));
    }
    
    /** integer division **/
    function intDivision($a, $b) {
        return (int)($a/$b);
    }

    /** Returns the card types in use by the current game **/
    function getActiveCardTypes() {
        $active_types = array(0);
        if ($this->innovationGameState->artifactsExpansionEnabled()) {
            $active_types[] = 1;
        }
        if ($this->innovationGameState->citiesExpansionEnabled()) {
            $active_types[] = 2;
        }
         if ($this->innovationGameState->echoesExpansionEnabled()) {
            $active_types[] = 3;
        }
        // TODO(FIGURES): Update this when implementing the expansion.
        return $active_types;
    }

    function playerIdToPlayerNo($player_id) {
        return self::getUniqueValueFromDB(self::format("SELECT player_no FROM player WHERE player_id = {player_id}", array('player_id' => $player_id)));
    }

    function playerNoToPlayerId($player_no) {
        return self::getUniqueValueFromDB(self::format("SELECT player_id FROM player WHERE player_no = {player_no}", array('player_no' => $player_no)));
    }

    function getAllPlayerIds() {
        return self::getObjectListFromDB("SELECT player_id FROM player", true);
    }

    function getAllActivePlayerIds() {
        return self::getObjectListFromDB("SELECT player_id FROM player WHERE player_eliminated = 0", true);
    }

    function getActiveOpponentIds($player_id) {
        return self::getObjectListFromDB(self::format("
            SELECT
                player_id
            FROM
                player
            WHERE
                player_eliminated = 0 AND
                player_team <> (
                    SELECT
                        player_team
                    FROM
                        player
                    WHERE
                        player_id = {player_id}
                )
        ", array('player_id' => $player_id)), true);
    }

    function getAllActivePlayers() {
        return self::getObjectListFromDB("SELECT player_no FROM player WHERE player_eliminated = 0", true);
    }

    function getOtherActivePlayers($player_id) {
        return self::getObjectListFromDB(self::format("
            SELECT
                player_no
            FROM
                player
            WHERE
                player_eliminated = 0 AND
                player_id <> {player_id}
        ", array('player_id' => $player_id)), true);
    }

    function getActiveOpponents($player_id) {
        return self::getObjectListFromDB(self::format("
            SELECT
                player_no
            FROM
                player
            WHERE
                player_eliminated = 0 AND
                player_team <> (
                    SELECT
                        player_team
                    FROM
                        player
                    WHERE
                        player_id = {player_id}
                )
        ", array('player_id' => $player_id)), true);
    }

    function getActiveOpponentsWithFewerPoints($player_id) {
        return self::getObjectListFromDB(self::format("
            SELECT
                player_no
            FROM
                player
            WHERE
                player_eliminated = 0 AND
                player_team <> (
                    SELECT
                        player_team
                    FROM
                        player
                    WHERE
                        player_id = {player_id}
                ) AND
                player_innovation_score < (
                    SELECT
                        player_innovation_score
                    FROM
                        player
                    WHERE
                        player_id = {player_id}
                )
        ", array('player_id' => $player_id)), true);
    }

    function isEliminated($player_id) {
        return self::getUniqueValueFromDB(self::format("SELECT player_eliminated FROM player WHERE player_id={player_id}", array('player_id' => $player_id)));
    }
    
    /** log for debugging **/
    function log() {
        $args = func_get_args();
        $line = Array();
        foreach ($args as $arg) {
            $line[] = is_string($arg) ? $arg : var_export($arg, true);
        }
        self::DbQuery("INSERT INTO logs (line) VALUE ('".mysql_escape_string(implode("\n\n", $line))."')");
    }
    
    
    /** Formatting **/
    function format($msg, $vars)
    {
        /** Format the string using named or unamed parameters **/
        $vars = (array)$vars;

        $msg = preg_replace_callback('#\{\}#', function($r){
            static $i = 0;
            return '{'.($i++).'}';
        }, $msg);

        return str_replace(
            array_map(function($k) {
                return '{'.$k.'}';
            }, array_keys($vars)),

            array_values($vars),

            $msg
       ) ;
    }
    
    /** Utility for team game **/
    function rearrangePlayersForFixedTeams($player_array, $partnair_of_first) {
        // The goal of this function is to rearrange the player array so that the first player in the lobby plays with his partnair ($partnair_of_first) as decide in the options
        
        // "Fix" the player table order so that it is in the range 1..nbr_players
        $unfixed_player_table_orders = array();
        foreach($player_array as $player_id => $player) {
            $unfixed_player_table_orders[] = $player["player_table_order"];
        }
        sort($unfixed_player_table_orders);
        $fixed_player_table_orders = array();
        foreach($unfixed_player_table_orders as $key => $val) {
            $fixed_player_table_orders[$val] = $key + 1;
        }
        
        // Locate who was the first player in the lobby
        $player_no = 0;
        foreach($player_array as $player_id => $player)
        {
            $player_table_order = $fixed_player_table_orders[$player['player_table_order']];
            if ($player_table_order == 1) {
                $first_player_no = $player_no;
            }
            else if ($player_table_order == $partnair_of_first) {
                $partnair_of_first_no = $player_no;
            }
            $player_no++;
        }
        
        // Check if the playing order needs to be changed
        if (($first_player_no + 2) % 4 == $partnair_of_first_no) { // Players are already on their right places (teammates are facing each other)
            return $player_array;
        }
        
        // Determine the neighbor of the first player in the lobby who is an opponent
        if (($first_player_no + 1) % 4 == $partnair_of_first_no) {
            $neighbor_opponent_no = ($first_player_no + 3) % 4;
        }
        else {
            $neighbor_opponent_no = ($first_player_no + 1) % 4;
        }
        
        // Swap the seats of the first player in the lobby with that opponent
        $player_order = array_keys($player_array);
        
        $first_player_id = $player_order[$first_player_no];
        $neighbor_opponent_id = $player_order[$neighbor_opponent_no];
        $player_order[$first_player_no] = $neighbor_opponent_id;
        $player_order[$neighbor_opponent_no] = $first_player_id;
        
        // Made this change effective in the whole array
        $new_player_array = array();
        foreach($player_order as $player_id) {
            $new_player_array[$player_id] = $player_array[$player_id];
        }
        return $new_player_array;
    }
    
    /** Database manipulations **/
    function shuffle() {
        /** Shuffle all cards in their piles grouped by type and age, at the beginning of the game **/
        
        // Generate a random number for each card in the deck
        self::DbQuery("
        INSERT INTO random
            SELECT
                id,
                type,
                age,
                RAND() AS random_number
            FROM
                card 
            WHERE
                location = 'deck'
        ");
        
        // Give the new position based on the random number of the card, in the type and age pile it belongs to
        self::DbQuery("
        INSERT INTO shuffled
            SELECT
                a.id,
                (
                    SELECT
                        COUNT(*)
                    FROM
                        random AS b
                    WHERE
                        b.age = a.age AND
                        b.type = a.type AND
                        b.random_number < a.random_number
                ) AS new_position
            FROM
                random AS a
        ");
        
        // Assign this new position to the actual database
        self::DbQuery("
        UPDATE
            card AS a
            INNER JOIN shuffled AS b
                ON a.id = b.id
        SET
            a.position = b.new_position
        WHERE
            b.new_position IS NOT NULL
        ");
        
        // Empty auxiliary tables
        self::DbQuery("
        DELETE FROM
            random
        ");
        
        self::DbQuery("
        DELETE FROM
            shuffled
        ");
    }
    
    function extractAgeAchievements() {
        /** Take the top card from each pile from age 1 to age 9, in the beginning of the game; these will be used as achievements **/
        if ($this->innovationGameState->get('release_version') >= 2) {
            self::DbQuery(self::format("
                UPDATE
                    card as a
                    INNER JOIN (SELECT age, MAX(position) AS position FROM card WHERE type = 0 GROUP BY age) as b ON a.age = b.age
                SET
                    a.location = 'achievements',
                    a.position = 0
                WHERE
                    a.position = b.position AND
                    a.type = 0 AND
                    a.age BETWEEN 1 AND {max_achievement_age}
                ", ["max_achievement_age" => $this->innovationGameState->usingFourthEditionRules() ? 10 : 9]));
        } else {
            self::DbQuery("
                UPDATE
                    card as a
                    INNER JOIN (SELECT age, MAX(position) AS position FROM card WHERE type = 0 GROUP BY age) as b ON a.age = b.age
                SET
                    a.location = 'achievements',
                    a.position = a.age-1
                WHERE
                    a.position = b.position AND
                    a.type = 0 AND
                    a.age BETWEEN 1 AND 9
                ");
        }
        
    }
    
    function tuckCard($card, $owner_to) {
        return self::transferCardFromTo($card, $owner_to, 'board', /*bottom_to=*/ true);
    }

    function scoreCard($card, $owner_to) {
        return self::transferCardFromTo($card, $owner_to, 'score', /*bottom_to=*/ false, /*score_keyword=*/ true);
    }

    function returnCard($card) {
        return self::transferCardFromTo($card, 0, 'deck');
    }

    /**
     * Executes the transfer of the card, returning the new card info.
     **/
    function transferCardFromTo($card, $owner_to, $location_to, $bottom_to = null, $score_keyword = false, $bottom_from = false) {

        // Get updated state of card in case a stale reference was passed.
        $using_debug_buttons = array_key_exists('using_debug_buttons', $card);
        $card = self::getCardInfo($card['id']);
        if ($using_debug_buttons) {
            $card['using_debug_buttons'] = true;
        }

        // Do not move the card at all.
        if ($location_to == 'none') {
            return;
        }

        // Relics are not returned to the deck.
        if ($card['is_relic'] && $location_to == 'deck') {
            $location_to = 'relics';
        }

        // By default, cards are returned to the bottom of the deck, but other cards are returned to the top of their locations
        if ($bottom_to === null) {
            $bottom_to = $location_to == 'deck';
        }

        $id = $card['id'];
        $age = $card['age'];
        $type = $card['type'];
        $is_relic = $card['is_relic'];
        $color = $card['color'];
        $owner_from = $card['owner'];
        $location_from = $card['location'];
        $position_from = $card['position'];
        $splay_direction_from = $card['splay_direction'];
        
        // Determine the splay direction of destination if any
        if ($location_to == 'board') {
            // The card must continue the current splay
            $splay_direction_to = self::getCurrentSplayDirection($owner_to, $color);
        }
        else { // $location_to != 'board'
            $splay_direction_to = 'NULL';
        }
        
        // Filter from
        $filter_from = self::format("owner = {owner_from} AND location = '{location_from}'", array('owner_from' => $owner_from, 'location_from' => $location_from));
        switch ($location_from) {
        case 'deck':
            $filter_from .= self::format(" AND type = {type} AND age = {age}", array('type' => $type, 'age' => $age));
            break;
        case 'achievements':
            // For games that were started before Echoes was released, we don't have to worry about new achievements being added
            if ($this->innovationGameState->get('release_version') < 2 || $age == null) {
                break;
            }
            // The player's achievement pile is not grouped by type or age
            if ($owner_from != 0) {
                break;
            }
        case 'hand':
        case 'forecast':
        case 'score':
        case 'relics':
            $filter_from .= self::format(" AND type = {type} AND age = {age} AND is_relic = {is_relic}", array('type' => $type, 'age' => $age, 'is_relic' => $is_relic));
            break;
        case 'board':
            $filter_from .= self::format(" AND color = {color}", array('color' => $color));
            break;
        case 'removed':
        case 'junk':
            $filter_from = self::format("id = {id}", array('id' => $id)); // Always use position 0
            break;
        default:
            break;
        }
        
        // Filter to
        $filter_to = self::format("owner = {owner_to} AND location = '{location_to}'", array('owner_to' => $owner_to, 'location_to' => $location_to));
        switch ($location_to) {
        case 'deck':
            $filter_to .= self::format(" AND type = {type} AND age = {age}", array('type' => $type, 'age' => $age));
            break;
        case 'achievements':
            // For games that were started before Echoes was released, we don't have to worry about new achievements being added.
            if ($this->innovationGameState->get('release_version') < 2 || $age == null) {
                break;
            }
            // The player's achievement pile is not grouped by type or age
            if ($owner_to != 0) {
                break;
            }
        case 'hand':
        case 'forecast':
        case 'score':
        case 'relics':
            $filter_to .= self::format(" AND type = {type} AND age = {age} AND is_relic = {is_relic}", array('type' => $type, 'age' => $age, 'is_relic' => $is_relic));
            break;
        case 'board':
            $filter_to .= self::format(" AND color = {color}", array('color' => $color));
            break;
        case 'removed':
        case 'junk':
            $filter_to = self::format("id = {id}", array('id' => $id)); // Always use position 0
            break;
        default:
            break;
        }
        
        // Get the position of destination and update some other card positions if needed
        if ($bottom_to) { // The card must go to bottom of the location: update the position of the other cards accordingly
            // Execution of the query
            self::DbQuery(self::format("
                UPDATE
                    card
                SET
                    position = position + 1
                WHERE
                    {filter_to}
            ",
                array('filter_to' => $filter_to)
           ));
            $position_to = 0;
        } else { // $bottom_to is false
            // new_position = number of cards in the location
            $position_to = self::getUniqueValueFromDB(self::format("
            SELECT
                COUNT(position)
            FROM
                card
            WHERE
                {filter_to}
            ",
                array('filter_to' => $filter_to)
           )); 
        }

        // Execute the transfer
        self::DbQuery(self::format("
            UPDATE
                card
            SET
                owner = {owner_to},
                location = '{location_to}',
                position = {position_to},
                selected = FALSE,
                splay_direction = {splay_direction_to}
            WHERE
                id = {id}
        ",
            array('owner_to' => $owner_to, 'location_to' => $location_to, 'position_to' => $position_to, 'id' => $id, 'splay_direction_to' => $splay_direction_to)
       ));
        
        // Update the position of the cards of the location the transferred card came from to fill the gap
        self::DbQuery(self::format("
            UPDATE
                card
            SET
                position = position - 1 
            WHERE
                {filter_from} AND
                position > {position_from}
        ",
            array('filter_from' => $filter_from, 'position_from' => $position_from)
        ));

        if ($location_to == 'forecast') {
            self::incStat(1, 'foreshadowed_number', $owner_to);
        }
        
        $transferInfo = array(
            'owner_from' => $owner_from,
            'location_from' => $location_from,
            'position_from' => $position_from,
            'splay_direction_from' => $splay_direction_from, 
            'owner_to' => $owner_to,
            'location_to' => $location_to,
            'position_to' => $position_to,
            'splay_direction_to' => $splay_direction_to, 
            'bottom_from' => $bottom_from,
            'bottom_to' => $bottom_to,
            'score_keyword' => $score_keyword,
        );
        
        // Update the current state of the card
        $card['owner'] = $owner_to;
        $card['location'] = $location_to;
        $card['position'] = $position_to;        
        $card['splay_direction'] = $splay_direction_to;
        
        $current_state = $this->gamestate->state();
        if ($current_state['name'] != 'gameSetup') {
            try {
                self::updateGameSituation($card, $transferInfo);
                if ($card['type'] == 2 && $location_to == 'board') { // city card going on a board
                    if ($bottom_to) { // tuck
                        if (self::hasRessource($card, 8)) { // has a flag
                            self::claimSpecialAchievement($owner_to, 328); // Glory
                        }
                        if (self::hasRessource($card, 9)) { // has a fountain
                            self::claimSpecialAchievement($owner_to, 329); // Victory
                        }
                    } else { // meld
                        $current_splay_direction = self::getCurrentSplayDirection($owner_to, $card['color']);
                        if (self::hasRessource($card, 11) && $current_splay_direction == 1) { // has a left arrow and already splayed left
                            self::claimSpecialAchievement($owner_to, 325); // Legend
                        }
                        if (self::hasRessource($card, 12) && $current_splay_direction == 2) { // has a right arrow and already splayed right
                            self::claimSpecialAchievement($owner_to, 326); // Repute
                        }
                        if (self::hasRessource($card, 13) && $current_splay_direction == 3) { // has an up arrow and already splayed up
                            self::claimSpecialAchievement($owner_to, 327); // Fame
                        }
                    }
                }
            }
            catch (EndOfGame $e) {
                self::trace('EOG bubbled from self::transferCardFromTo');
                throw $e; // Re-throw exception to higher level
            }
            finally {
                // Determine if the loss of the card from its location of depart breaks a splay. If it's the case, change the splay_direction of the remaining card to unsplay (a notification being sent).
                if ($location_from == 'board' && $splay_direction_from > 0) {
                    $number_of_cards_in_pile = self::getUniqueValueFromDB(self::format("
                        SELECT
                            COUNT(*)
                        FROM
                            card
                        WHERE
                            owner={owner_from} AND
                            location='board' AND
                            color={color}
                    ",
                        array('owner_from'=>$owner_from, 'color'=>$color)
                    ));
                    
                    if ($number_of_cards_in_pile <= 1) {
                        self::splay($owner_from, $owner_from, $color, 0); // Unsplay
                    }
                }
            }
        }
        return $card;
    }
    
    /** Splay mechanism **/

    function unsplay($player_id, $target_player_id, $color) {
        self::splay($player_id, $target_player_id, $color, /*splay_direction=*/ 0, /*force_unsplay=*/ true);
    }

    function splayLeft($player_id, $target_player_id, $color) {
        self::splay($player_id, $target_player_id, $color, /*splay_direction=*/ 1);
    }

    function splayRight($player_id, $target_player_id, $color) {
        self::splay($player_id, $target_player_id, $color, /*splay_direction=*/ 2);
    }

    function splayUp($player_id, $target_player_id, $color) {
        self::splay($player_id, $target_player_id, $color, /*splay_direction=*/ 3);
    }

    function splayAslant($player_id, $target_player_id, $color) {
        self::splay($player_id, $target_player_id, $color, /*splay_direction=*/ 4);
    }

    function splay($player_id, $target_player_id, $color, $splay_direction, $force_unsplay=false) {

        // Return early if the stack is already splayed in the requested direction.
        if (self::getCurrentSplayDirection($target_player_id, $color) == $splay_direction) {
            return;
        }

        // Return early if a stack with less than 2 cards is attempting to be splayed.
        if ($splay_direction >= 1 && self::countCardsInLocationKeyedByColor($target_player_id, 'board')[$color] <= 1) {
            return;
        }

        self::DbQuery(self::format("
            UPDATE
                card
            SET
                splay_direction = {splay_direction}
            WHERE
                owner = {owner} AND
                location = 'board' AND
                color = {color}
         ",
            array('owner' => $target_player_id, 'color' => $color, 'splay_direction' => $splay_direction)
        ));
        
        self::notifyForSplay($player_id, $target_player_id, $color, $splay_direction, $force_unsplay);

        $end_of_game = false;

        try {
            self::updateFlagsAndFountains();
        } catch(EndOfGame $e) {
            $end_of_game = true;
        }

        try {
            self::checkForSpecialAchievements();
        } catch(EndOfGame $e) {
            $end_of_game = true;
        }

        if ($end_of_game) {
            self::trace('EOG bubbled from self::splay');
            throw $e; // Re-throw exception to higher level
        }
        
        // Changing a splay results in a Cities card being drawn (as long as there isn't already one in hand)
        if ($this->innovationGameState->citiesExpansionEnabled() && $splay_direction > 0 && self::countCardsInLocation($player_id, 'hand', /*type=*/ 2) == 0) {
            self::executeDraw($player_id, self::getAgeToDrawIn($player_id), 'hand', /*bottom_to=*/ false, /*type=*/ 2);
        }
        
        self::recordThatChangeOccurred();
    }
    
    /* Rearrangement mechanism */
    function rearrange($player_id, $color, $permutations) {
        
        $old_board = self::getCardsInLocationKeyedByColor($player_id, 'board');
        
        foreach($permutations as $permutation) {
            $data = $permutation;
            $data['player_id'] = $player_id;
            $data['color'] = $color;
            $data['position_plus_delta'] = $data['position'] + $data['delta'];
            self::DbQuery(self::format("
                UPDATE
                    card
                SET
                    position = (CASE position
                                WHEN  {position} THEN {position_plus_delta}
                                ELSE {position}
                                END)
                WHERE
                    owner = {player_id} AND
                    location = 'board' AND
                    color = {color} AND
                    position IN ({position}, {position_plus_delta})
            ",
                $data
            ));
        }
        
        $new_board = self::getCardsInLocationKeyedByColor($player_id, 'board');
        
        $actual_change = $old_board[$color] != $new_board[$color];
        
        if ($actual_change) {
            self::updatePlayerRessourceCounts($player_id);
            self::recordThatChangeOccurred();
        }
        
        return $actual_change;
    }
    
    /** Selection card management **/
    function markAsSelected($card_id) {
        /**
        Mark one card via its id.
        **/
        self::DbQuery(self::format("
            UPDATE
                card
            SET
                selected = TRUE
            WHERE
                id = {card_id}
        ",
            array('card_id' => $card_id)
        ));
    }
    
    function unmarkAsSelected($card_id) {
        /**
        Mark one card via its id.
        **/
        self::DbQuery(self::format("
            UPDATE
                card
            SET
                selected = FALSE
            WHERE
                id = {card_id}
        ",
            array('card_id' => $card_id)
        ));
    }

    function countSelectedCards() {
        return self::getUniqueValueFromDB("
            SELECT
                COUNT(*)
            FROM
                card
            WHERE
                selected IS TRUE
        ");
    }
    
    function getSelectedCards() {
        return self::getObjectListFromDB("SELECT * FROM card WHERE selected IS TRUE ORDER BY location, position");
    }
    
    function getVisibleSelectedCards($player_id) {
        return self::getObjectListFromDB(self::format("
            SELECT
                *
            FROM
                card
            WHERE
                selected IS TRUE AND
                (location = 'board' OR owner = {player_id} AND location != 'achievements')
                
        ", // A player can see the versos of all cards on all boards and all the cards in his hand and his score
            array('player_id' => $player_id)
        ));
    }
    
    function getSelectableRectos($player_id) {
        return self::getObjectListFromDB(self::format("
            SELECT
                owner, location, age, type, is_relic, position
            FROM
                card
            WHERE
                selected IS TRUE AND
                location != 'board' AND
                (owner != {player_id} OR location = 'score' OR location = 'forecast' OR location = 'achievements')
        ", // The opposite of the cards the player can see except that we potentially select the cards in his score pile too (to enable direct selection if the player is lazy to see the card in his score pile for transfer)
            array('player_id' => $player_id)
        ));
    }

    function deselectAllCards() {
        /**
        Deselect all cards.
        **/
        
        self::DBQuery("
            UPDATE
                card
            SET
                selected = FALSE
        ");
    }
    
    /** Notification system for transfer **/
    function notifyAll($notification_type, $notification_log, $notification_args) {
        self::notifyAllPlayersBut(array(), $notification_type, $notification_log, $notification_args);
    }
    
    function notifyAllPlayersBut($player_ids, $notification_type, $notification_log, $notification_args) {
        /**
        Notify all players except the players in the list $player_ids (or with only one value, one can pass directly the id of the player to exclude).
        The spectators are notified as well.
        **/
        if (!is_array($player_ids)) { // The first argument is a single value
            // Transform to an array with one element
            $player_ids = array($player_ids);
        }
        
        // Notify players
        foreach (self::getAllPlayerIds() as $player_id) {
            if (in_array($player_id, $player_ids)) {
                continue;
            }
            self::notifyPlayer($player_id, $notification_type, $notification_log, $notification_args);
        }
        
        // Notify spectator: same message but have to redirect on other handler in JS for spectators to see messages in logs
        self::notifyAllPlayers($notification_type . '_spectator', '', array_merge($notification_args, array('notification_type' => $notification_type, 'log' => $notification_log))); // Players won't suscribe to this: it is filtered by the JS
    }
    
    function updateGameSituation($card, $transferInfo) {
        self::recordThatChangeOccurred();

        $owner_from = $transferInfo['owner_from'];
        $owner_to = $transferInfo['owner_to'];
        $location_from = $transferInfo['location_from'];
        $location_to = $transferInfo['location_to'];
        $bottom_to = $transferInfo['bottom_to'];
        $age = $card['age'];
        
        $score_from_update = $location_from == 'score' || $location_from == 'board';
        $score_to_update = $location_to == 'score' || $location_to == 'board';
        
        $max_age_on_board_from_update = $location_from == 'board';
        $max_age_on_board_to_update = $location_to == 'board';

        $active_player_id = self::getActivePlayerId();
        
        $progressInfo = array();
        // Update player progression if applicable
        // TODO(4E): Remove the no_players_involved case. There is always a player which initiates the action.
        $no_players_involved = $owner_from == 0 && $owner_to == 0 && $location_to != 'junk';
        $one_player_involved = array_key_exists('using_debug_buttons', $card) // Debug buttons can be used by non-active players
            || $card['age'] === null // Flags, fountains, and special achievements only involve one player
            || ($owner_from == 0 && $owner_to == $active_player_id)
            || ($owner_to == 0 && $owner_from == $active_player_id)
            || ($owner_from == $owner_to && $owner_from == $active_player_id)
            || ($owner_from == 0 && $owner_to == 0);

        if ($no_players_involved) {
            self::notifyWithNoPlayersInvolved($card, $transferInfo, $progressInfo);
        } else if ($one_player_involved) {
            $player_id = $active_player_id;
            if ($owner_to != 0) {
                $player_id = $owner_to;
            } else if ($owner_from != 0) {
                $player_id = $owner_from;
            }
            $transferInfo['player_id'] = $player_id;
            
            if ($score_from_update) {
                $progressInfo['new_score'] = self::updatePlayerScore($owner_from);
            }
            if ($score_to_update) {
                $progressInfo['new_score'] = self::updatePlayerScore($owner_to);
            }
            if ($max_age_on_board_from_update || $max_age_on_board_to_update) {
                $max_age_on_board = self::getMaxAgeOnBoardTopCards($player_id);
                $progressInfo['new_max_age_on_board'] = $max_age_on_board;
                self::setStat($max_age_on_board, 'max_age_on_board', $player_id);
            }
            if ($location_from == 'board' || $location_to == 'board') {
                $progressInfo['new_ressource_counts'] = self::updatePlayerRessourceCounts($player_id);
            }
            // Update counters for the Monument special achievement
            // TODO(FIGURES): If there are any cards which tuck/score a card which belongs to another player, then
            // there is a bug here that we need to fix.
            if ($location_to == 'board' && $bottom_to) { // That's a tuck
                self::incrementFlagForMonument($player_id, 'number_of_tucked_cards');
            } else if ($transferInfo['score_keyword']) { // That's a score
                self::incrementFlagForMonument($player_id, 'number_of_scored_cards');
            }
            $transferInfo['monument_counters'][$player_id] = self::getFlagsForMonument($player_id);
            self::notifyWithOnePlayerInvolved($card, $transferInfo, $progressInfo);
        } else {
            $player_id = $active_player_id;
            if ($owner_from == 0) {
                $opponent_id = $owner_to;
            } else if ($owner_to == 0) {
                $opponent_id = $owner_from;
            } else if ($owner_from == $player_id) {
                $opponent_id = $owner_to;
            } else {
                $opponent_id = $owner_from;
            }
            $transferInfo['player_id'] = $player_id;
            $transferInfo['opponent_id'] = $opponent_id;
            
            if ($score_from_update) {
                $progressInfo['new_score_from'] = self::updatePlayerScore($owner_from);
            }
            if ($score_to_update) {
                $progressInfo['new_score_to'] = self::updatePlayerScore($owner_to);
            }
            
            if ($location_from == 'board') {
                $progressInfo['new_ressource_counts_from'] = self::updatePlayerRessourceCounts($owner_from);
            }
            if ($location_to == 'board') {
                $progressInfo['new_ressource_counts_to'] = self::updatePlayerRessourceCounts($owner_to);
            }
            if ($max_age_on_board_from_update) {
                $max_age_on_board_from = self::getMaxAgeOnBoardTopCards($owner_from);
                $progressInfo['new_max_age_on_board_from'] = $max_age_on_board_from;
                self::setStat($max_age_on_board_from, 'max_age_on_board', $owner_from);
            }
            if ($max_age_on_board_to_update) {
                $max_age_on_board_to = self::getMaxAgeOnBoardTopCards($owner_to);
                $progressInfo['new_max_age_on_board_to'] = $max_age_on_board_to;
                self::setStat($max_age_on_board_to, 'max_age_on_board', $owner_to);
            }
            self::notifyWithTwoPlayersInvolved($card, $transferInfo, $progressInfo);
        }
        
        $end_of_game = false;

        // A player is losing an achievement
        if ($owner_from != 0 && $location_from == 'achievements') {
            // // The number of achievements is the BGA score (not to be confused with the definition of score in an Innovation game)
            self::decrementBGAScore($owner_from);
        }
        
        // A player is gaining an achievement
        if ($owner_to != 0 && $location_to == 'achievements') {
            try {
                // The number of achievements is the BGA score (not to be confused with the definition of score in an Innovation game)
                self::incrementBGAScore($owner_to, /*is_special_achievement=*/ $card['age'] === null && $card['id'] < 1000); // Fountains and flags are not considered special achievements
            } catch(EndOfGame $e) {
                $end_of_game = true;
            }
        }

        try {
            self::checkForSpecialAchievements();
        } catch(EndOfGame $e) {
            $end_of_game = true;
        }

        if ($location_from == 'board' || $location_to == 'board') {
            try {
                self::updateFlagsAndFountains();
            } catch(EndOfGame $e) {
                $end_of_game = true;
            }
        }

        if ($end_of_game) {
            self::trace('EOG bubbled from self::updateGameSituation');
            throw $e; // Re-throw exception to higher level
        }
    }

    function revealHand($player_id) {
        $cards = self::getCardsInHand($player_id);
        if (count($cards) == 0) {
            $this->notifyPlayer($player_id, 'log', clienttranslate('${You} reveal an empty hand.'), ['You' => 'You']);
            $this->notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} reveals an empty hand.'), ['player_name' => self::getPlayerNameFromId($player_id)]);
            return;
        }
        $args = ['card_ids' => self::getCardIds($cards), 'card_list' => self::getNotificationArgsForCardList($cards)];
        $this->notifyPlayer($player_id, 'logWithCardTooltips', clienttranslate('${You} reveal your hand: ${card_list}.'),
            array_merge($args, ['You' => 'You']));
        $this->notifyAllPlayersBut($player_id, 'logWithCardTooltips', clienttranslate('${player_name} reveals his hand: ${card_list}.'),
            array_merge($args, ['player_name' => self::getPlayerNameFromId($player_id)]));
    }
    
    function revealScorePile($player_id) {
        $cards = self::getCardsInScorePile($player_id);
        if (count($cards) == 0) {
            $this->notifyPlayer($player_id, 'log', clienttranslate('${You} reveal an empty score pile.'), ['You' => 'You']);
            $this->notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} reveals an empty score pile.'), ['player_name' => self::getPlayerNameFromId($player_id)]);
            return;
        }
        $args = ['card_ids' => self::getCardIds($cards), 'card_list' => self::getNotificationArgsForCardList($cards)];
        $this->notifyPlayer($player_id, 'logWithCardTooltips', clienttranslate('${You} reveal your score pile: ${card_list}.'),
            array_merge($args, ['You' => 'You']));
        $this->notifyAllPlayersBut($player_id, 'logWithCardTooltips', clienttranslate('${player_name} reveals his score pile: ${card_list}.'),
            array_merge($args, ['player_name' => self::getPlayerNameFromId($player_id)]));
    }

    function getNotificationArgsForCardList($cards) {
        $args = array();
        $args['i18n'] = array();
        $log = "";
        for ($i = 0; $i < count($cards); $i++) {
            $card = $cards[$i];
            if ($i > 0) {
                $log = $log.', ';
            }
            if ($card['age'] != null) {
                $log = $log."<span class='square N age age_".$card['age']." type_".$card['type']."'>".$card['age']."</span> ";
            }
            $log = $log.'<span id=\''.uniqid().'\'class=\'card_name card_id_'.$card['id'].'\'>${name_'.$i.'}</span>';
            $args['name_'.$i] = self::getCardName($card['id']);
            $args['i18n'][] = 'name_'.$i;
        }
        return ['log' => $log, 'args'=> $args];
    }
    
    function getDelimiterMeanings($text, $card_id = null) {
        $delimiters = array();
        
        // Delimiters for age icon
        if (strpos($text, '{<}') > -1) {
            if ($card_id == null){
                $delimiters['<'] = "<span class='square N age'>";
            } else {
                $delimiters['<'] = "<span class='square N age type_".self::getCardInfo($card_id)['type']."'>";
            }
            $delimiters['>'] = "</span>";
        }

        // Delimiters for card name
        if (strpos($text, '{<<}') > -1) {
            // Without an ID it's not possible to add a BGA tooltip to it.
            $delimiters['<<'] = "<span id='".uniqid()."'class='card_name card_id_".$card_id."'>";
            $delimiters['>>'] = "</span>";
        }

        // Delimiters for achievement name
        if (strpos($text, '{<<<}') > -1) {
            $delimiters['<<<'] = "<span class='card_name'>";
            $delimiters['>>>'] = "</span>";
        }

        // Delimiters for ressource icon
        if (strpos($text, '{[}') > -1) {
            $delimiters['['] = "<span class='square N icon_";
            $delimiters[']'] = "'></span>";
        }
        return $delimiters;
    }

    function getCardExecutionCodeWithLetter($card_id, $current_effect_type, $current_effect_number, $step) {
        $letters = array(1 => 'A', 2 => 'B', 3 => 'C', 4 => 'D');
        // TODO(LATER): Remove this hack since it's likely just masking another problem.
        if ($step >= 1 && $step <= 4) {
            $letter = $letters[$step];
        } else {
            $letter = '?';
        }
        return self::getCardExecutionCode($card_id, $current_effect_type, $current_effect_number) . $letter;
    }

    function getCardExecutionCode($card_id, $current_effect_type, $current_effect_number) {
        $nested_card_state = self::getCurrentNestedCardState();
        $post_execution_indicator = $nested_card_state['post_execution_index'] == 0 ? '' : '+';
        // Echo effects are sometimes executed on cards other than the card being dogma'd
        if ($current_effect_type == 3) {
            $nesting_index = $nested_card_state['nesting_index'];
            $card_id = self::getUniqueValueFromDB(
                self::format("SELECT card_id FROM echo_execution WHERE nesting_index = {nesting_index} AND execution_index = {effect_number}",
                    array('nesting_index' => $nesting_index, 'effect_number' => $current_effect_number)));
            $current_effect_number = 1;
        }
        return $card_id . self::getLetterForEffectType($current_effect_type) . $current_effect_number . $post_execution_indicator;
    }

    function getLetterForEffectType($effect_type) {
        switch ($effect_type) {
            case 0:
                // I demand
                return "D";
            case 1:
                // Non-demand
                return "N";
            case 2:
                // I compel
                return "C";
            case 3:
                // Echo
                return "E";
            default:
                // This should not happen
                throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => "getLetterForEffectType()", 'code' => $effect_type)));
                break;
        }
    }

    function notifyWithNoPlayersInvolved($card, $transferInfo, $progressInfo) {
        $location_from = $transferInfo['location_from'];
        $location_to = $transferInfo['location_to'];
        $bottom_from = $transferInfo['bottom_from'];
        $bottom_to = $transferInfo['bottom_to'];
        $score_keyword = $transferInfo['score_keyword'];

        switch($location_from . '->' . $location_to) {
        case 'deck->achievements':
            $message = clienttranslate('The bottom ${<}${age}${>} card is transfered to the available achievements.');
            break;
        case 'achievements->deck':
            $message = clienttranslate('A ${<}${age}${>} achievement card is returned to its deck.');
            break;
        default:
            // This should not happen
            throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => 'notifyWithNoPlayersInvolved()', 'code' => $location_from . '->' . $location_to)));
            break;
        }
        
        self::sendNotificationWithNoPlayersInvolved($message, $card, $transferInfo, $progressInfo);
    }
    
    function notifyWithOnePlayerInvolved($card, $transferInfo, $progressInfo) {
        $location_from = $transferInfo['location_from'];
        $location_to = $transferInfo['location_to'];
        $bottom_to = $transferInfo['bottom_to'];
        $score_keyword = $transferInfo['score_keyword'];

        switch($location_from . '->' . $location_to) {
        case 'deck->display':
            $message_for_player = clienttranslate('${You} dig ${<}${age}${>} ${<<}${name}${>>} and put it on display.');
            $message_for_others = clienttranslate('${player_name} digs ${<}${age}${>} ${<<}${name}${>>} and puts it on display.');
            break;
        case 'deck->hand':
            $message_for_player = clienttranslate('${You} draw ${<}${age}${>} ${<<}${name}${>>}.');
            $message_for_others = clienttranslate('${player_name} draws a ${<}${age}${>}.');
            break;
        case 'deck->board':
            if ($bottom_to) {
                $message_for_player = clienttranslate('${You} draw and tuck ${<}${age}${>} ${<<}${name}${>>}.');
                $message_for_others = clienttranslate('${player_name} draws and tucks ${<}${age}${>} ${<<}${name}${>>}.');
            }
            else {
                $message_for_player = clienttranslate('${You} draw and meld ${<}${age}${>} ${<<}${name}${>>}.');
                $message_for_others = clienttranslate('${player_name} draws and melds ${<}${age}${>} ${<<}${name}${>>}.');
            }
            break;
        case 'deck->forecast':
            $message_for_player = clienttranslate('${You} draw and foreshadow ${<}${age}${>} ${<<}${name}${>>}.');
            $message_for_others = clienttranslate('${player_name} draws and foreshadows a ${<}${age}${>}.');
            break;
        case 'deck->score':
            $message_for_player = clienttranslate('${You} draw and score ${<}${age}${>} ${<<}${name}${>>}.');
            $message_for_others = clienttranslate('${player_name} draws and scores a ${<}${age}${>}.');
            break;
        case 'deck->revealed':
            $message_for_player = clienttranslate('${You} draw and reveal ${<}${age}${>} ${<<}${name}${>>}.');
            $message_for_others = clienttranslate('${player_name} draws and reveals ${<}${age}${>} ${<<}${name}${>>}.');
            break;
        case 'deck->achievements':
            $message_for_player = clienttranslate('${You} draw and achieve a ${<}${age}${>}.');
            $message_for_others = clienttranslate('${player_name} draws and achieves a ${<}${age}${>}.');
            break;
        case 'display->board':
            $message_for_player = clienttranslate('${You} meld ${<}${age}${>} ${<<}${name}${>>} from your display.');
            $message_for_others = clienttranslate('${player_name} melds ${<}${age}${>} ${<<}${name}${>>} from his display.');
            break;
        case 'display->deck':
        case 'display->relics': // Shouldn't be possible, but just in case.
            $message_for_player = clienttranslate('${You} return ${<}${age}${>} ${<<}${name}${>>} from your display.');
            $message_for_others = clienttranslate('${player_name} returns ${<}${age}${>} ${<<}${name}${>>} from his display.');
            break;
        case 'forecast->board':
            if ($this->gamestate->state()['name'] == 'promoteCardPlayerTurn') {
                $message_for_player = clienttranslate('${You} promote ${<}${age}${>} ${<<}${name}${>>} from your forecast.');
                $message_for_others = clienttranslate('${player_name} promotes ${<}${age}${>} ${<<}${name}${>>} from his forecast.');
            } else {
                $message_for_player = clienttranslate('${You} meld ${<}${age}${>} ${<<}${name}${>>} from your forecast.');
                $message_for_others = clienttranslate('${player_name} melds ${<}${age}${>} ${<<}${name}${>>} from his forecast.');
            }
            break;
        case 'hand->deck':
            if ($bottom_to) {
                $message_for_player = clienttranslate('${You} return ${<}${age}${>} ${<<}${name}${>>} from your hand.');
                $message_for_others = clienttranslate('${player_name} returns a ${<}${age}${>} from his hand.');
            } else {
                $message_for_player = clienttranslate('${You} place ${<}${age}${>} ${<<}${name}${>>} from your hand on top of its deck.');
                $message_for_others = clienttranslate('${player_name} places a ${<}${age}${>} from his hand on top of its deck.');
            }
            break;
        case 'hand->relics':
            $message_for_player = clienttranslate('${You} return ${<}${age}${>} ${<<}${name}${>>} from your hand.');
            $message_for_others = clienttranslate('${player_name} returns ${<}${age}${>} ${<<}${name}${>>} from his hand.');
            break;
        case 'hand->board':
            if ($bottom_to) {
                $message_for_player = clienttranslate('${You} tuck ${<}${age}${>} ${<<}${name}${>>} from your hand.');
                $message_for_others = clienttranslate('${player_name} tucks ${<}${age}${>} ${<<}${name}${>>} from his hand.');
            }
            else {
                $message_for_player = clienttranslate('${You} meld ${<}${age}${>} ${<<}${name}${>>} from your hand.');
                $message_for_others = clienttranslate('${player_name} melds ${<}${age}${>} ${<<}${name}${>>} from his hand.');
            }
            break;
        case 'hand->score':
            if ($score_keyword) {
                $message_for_player = clienttranslate('${You} score ${<}${age}${>} ${<<}${name}${>>} from your hand.');
                $message_for_others = clienttranslate('${player_name} scores a ${<}${age}${>} from his hand.');
            }
            else {
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your hand to your score pile.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from his hand to his score pile.');
            }
            break;
        case 'hand->revealed':
            $message_for_player = clienttranslate('${You} reveal ${<}${age}${>} ${<<}${name}${>>} from your hand.');
            $message_for_others = clienttranslate('${player_name} reveals ${<}${age}${>} ${<<}${name}${>>} from his hand.');
            break;
        case 'hand->achievements':
            $message_for_player = clienttranslate('${You} achieve ${<}${age}${>} ${<<}${name}${>>} from your hand.');
            $message_for_others = clienttranslate('${player_name} achieves a ${<}${age}${>} from his hand.');
            break;
        case 'hand->forecast':
            $message_for_player = clienttranslate('${You} foreshadow ${<}${age}${>} ${<<}${name}${>>} from your hand.');
            $message_for_others = clienttranslate('${player_name} foreshadows a ${<}${age}${>} from his hand.');
            break;
        case 'board->deck':
        case 'board->relics':
        case 'pile->deck': // Skyscrapers
        case 'pile->relics': // Skyscrapers
            $message_for_player = clienttranslate('${You} return ${<}${age}${>} ${<<}${name}${>>} from your board.');
            $message_for_others = clienttranslate('${player_name} returns ${<}${age}${>} ${<<}${name}${>>} from his board.');
            break;
        case 'achievements->relics':
            $message_for_player = clienttranslate('${You} return ${<}${age}${>} ${<<}${name}${>>} from your achievements.');
            $message_for_others = clienttranslate('${player_name} returns ${<}${age}${>} ${<<}${name}${>>} from his achievements.');
            break;
        case 'board->hand':
            $message_for_player = clienttranslate('${You} take back ${<}${age}${>} ${<<}${name}${>>} from your board to your hand.');
            $message_for_others = clienttranslate('${player_name} takes back ${<}${age}${>} ${<<}${name}${>>} from his board to his hand.');
            break;
        case 'board->revealed':
            $message_for_player = clienttranslate('${You} reveal ${<}${age}${>} ${<<}${name}${>>} from your board.');
            $message_for_others = clienttranslate('${player_name} reveals ${<}${age}${>} ${<<}${name}${>>} from his board.');
            break;
        case 'board->board':
            if ($bottom_to) {
                $message_for_player = clienttranslate('${You} tuck ${<}${age}${>} ${<<}${name}${>>}.');
                $message_for_others = clienttranslate('${player_name} tucks ${<}${age}${>} ${<<}${name}${>>}.');
            }
            else {
                $message_for_player = clienttranslate('${You} meld ${<}${age}${>} ${<<}${name}${>>}.');
                $message_for_others = clienttranslate('${player_name} melds ${<}${age}${>} ${<<}${name}${>>}.');
            }
            break;
        case 'board->score':
            if ($score_keyword) {
                $message_for_player = clienttranslate('${You} score ${<}${age}${>} ${<<}${name}${>>} from your board.');
                $message_for_others = clienttranslate('${player_name} scores ${<}${age}${>} ${<<}${name}${>>} from his board.');
            }
            else {
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your board to your score pile.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his board to his score pile.');
            }
            break;
        case 'board->achievements':
            $message_for_player = clienttranslate('${You} achieve ${<}${age}${>} ${<<}${name}${>>} from your board.');
            $message_for_others = clienttranslate('${player_name} achieves ${<}${age}${>} ${<<}${name}${>>} from his board.');
            break;
        case 'score->deck':
            $message_for_player = clienttranslate('${You} return ${<}${age}${>} ${<<}${name}${>>} from your score pile.');
            $message_for_others = clienttranslate('${player_name} returns a ${<}${age}${>} from his score pile.');
            break;
        case 'score->relics':
            $message_for_player = clienttranslate('${You} return ${<}${age}${>} ${<<}${name}${>>} from your score pile.');
            $message_for_others = clienttranslate('${player_name} returns ${<}${age}${>} ${<<}${name}${>>} from his score pile.');
            break;
        case 'score->hand':
            $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your score pile to your hand.');
            $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from his score pile to his hand.');
            break;
        case 'score->board':
            if ($bottom_to) {
                $message_for_player = clienttranslate('${You} tuck ${<}${age}${>} ${<<}${name}${>>} from your score pile.');
                $message_for_others = clienttranslate('${player_name} tucks ${<}${age}${>} ${<<}${name}${>>} from his score pile.');
            }
            else {
                $message_for_player = clienttranslate('${You} meld ${<}${age}${>} ${<<}${name}${>>} from your score pile.');
                $message_for_others = clienttranslate('${player_name} melds ${<}${age}${>} ${<<}${name}${>>} from his score pile.');
            }
            break;
        case 'score->revealed':
            $message_for_player = clienttranslate('${You} reveal ${<}${age}${>} ${<<}${name}${>>} from your score pile.');
            $message_for_others = clienttranslate('${player_name} reveals ${<}${age}${>} ${<<}${name}${>>} from his score pile.');
            break;
        case 'score->achievements':
            $message_for_player = clienttranslate('${You} achieve ${<}${age}${>} ${<<}${name}${>>} from your score pile.');
            $message_for_others = clienttranslate('${player_name} achieves a ${<}${age}${>} from his score pile.');
            break;
        case 'revealed->deck':
        case 'revealed->relics':
            $message_for_player = clienttranslate('${You} return ${<}${age}${>} ${<<}${name}${>>}.');
            $message_for_others = clienttranslate('${player_name} returns ${<}${age}${>} ${<<}${name}${>>}.');
            break;
        case 'revealed->forecast':
            $message_for_player = clienttranslate('${You} foreshadow ${<}${age}${>} ${<<}${name}${>>}.');
            $message_for_others = clienttranslate('${player_name} foreshadows ${<}${age}${>} ${<<}${name}${>>}.');
            break;        
        case 'revealed->hand':
            $message_for_player = clienttranslate('${You} place ${<}${age}${>} ${<<}${name}${>>} in your hand.');
            $message_for_others = clienttranslate('${player_name} places ${<}${age}${>} ${<<}${name}${>>} in his hand.');
            break;
        case 'revealed->board':
            if ($bottom_to) {
                $message_for_player = clienttranslate('${You} tuck ${<}${age}${>} ${<<}${name}${>>}.');
                $message_for_others = clienttranslate('${player_name} tucks ${<}${age}${>} ${<<}${name}${>>}.');
            } else {
                $message_for_player = clienttranslate('${You} meld ${<}${age}${>} ${<<}${name}${>>}.');
                $message_for_others = clienttranslate('${player_name} melds ${<}${age}${>} ${<<}${name}${>>}.');
            }
            break;
        case 'revealed->score':
            $message_for_player = clienttranslate('${You} score ${<}${age}${>} ${<<}${name}${>>}.');
            $message_for_others = clienttranslate('${player_name} scores ${<}${age}${>} ${<<}${name}${>>}.');
            break;
        case 'revealed->achievements':
            $message_for_player = clienttranslate('${You} achieve ${<}${age}${>} ${<<}${name}${>>}.');
            $message_for_others = clienttranslate('${player_name} achieves ${<}${age}${>} ${<<}${name}${>>}.');
            break;
        case 'revealed->removed':
            $message_for_player = clienttranslate('${<}${age}${>} ${<<}${name}${>>} is removed from the game.');
            $message_for_others = clienttranslate('${<}${age}${>} ${<<}${name}${>>} is removed from the game.');
            break;
        case 'relics->achievements':
            $message_for_player = clienttranslate('${You} seize the ${<}${age}${>} relic to your achievements.');
            $message_for_others = clienttranslate('${player_name} seizes the ${<}${age}${>} relic to his achievements.');
            break;
        case 'relics->hand':
            $message_for_player = clienttranslate('${You} seize ${<}${age}${>} ${<<}${name}${>>} to your hand.');
            $message_for_others = clienttranslate('${player_name} seizes the ${<}${age}${>} relic to his hand.');
            break;
        case 'achievements->hand':
            // TODO(FIGURES): Update this if any cards transfer non-relic cards from a player's achievement pile to their hand.
            $message_for_player = clienttranslate('${You} seize ${<}${age}${>} ${<<}${name}${>>} from your achievements to your hand.');
            $message_for_others = clienttranslate('${player_name} seizes the ${<}${age}${>} relic from his achievements to his hand.');
            break;
        case 'achievements->deck':
            $message_for_player = clienttranslate('${You} return ${<}${age}${>} ${<<}${name}${>>} from your achievements.');
            $message_for_others = clienttranslate('${player_name} returns a ${<}${age}${>} from his achievements.');
            break;
        case 'achievements->achievements': // That is: unclaimed achievement to achievement claimed by player
            if ($card['age'] === null) { // Special achievement
                $message_for_player = clienttranslate('${You} achieve ${<<<}${name}${>>>}.');
                $message_for_others = clienttranslate('${player_name} achieves ${<<<}${name}${>>>}.');
            } else { // Age achievement
                $message_for_player = clienttranslate('${You} achieve a ${<}${age}${>}.');
                $message_for_others = clienttranslate('${player_name} achieves a ${<}${age}${>}.');
            }
            break;
        case 'achievements->junk':
            $message_for_player = clienttranslate('${You} junk a ${<}${age}${>} from the available achievements.');
            $message_for_others = clienttranslate('${player_name} junks a ${<}${age}${>} from the available achievements.');
            break;
        case 'fountains->achievements':
            $message_for_player = clienttranslate('A fountain became visible on ${your} board so it now counts as an achievement.');
            $message_for_others = clienttranslate('A fountain became visible on ${player_name}\'s board so it now counts as an achievement.');
            break;
        case 'achievements->fountains':
            $message_for_player = clienttranslate('A fountain which was visible on ${your} board no longer counts as an achievement.');
            $message_for_others = clienttranslate('A fountain which was visible on ${player_name}\'s board no longer counts as an achievement.');
            break;
        case 'flags->achievements':
            $message_for_player = clienttranslate('A flag on ${your} board now counts as an achievement since no opponent has more cards of that color visible on their board.');
            $message_for_others = clienttranslate('A flag on ${player_name}\'s board now counts as an achievement since none of their opponents has more cards of that color visible on their board.');
            break;
        case 'achievements->flags':
            $message_for_player = clienttranslate('A flag which was visible on ${your} board no longer counts as an achievement.');
            $message_for_others = clienttranslate('A flag which was visible on ${player_name}\'s board no longer counts as an achievement.');
            break;
        case 'forecast->deck':
            if ($bottom_to) {
                $message_for_player = clienttranslate('${You} return ${<}${age}${>} ${<<}${name}${>>} from your forecast.');
                $message_for_others = clienttranslate('${player_name} returns a ${<}${age}${>} from his forecast.');
            } else {
                $message_for_player = clienttranslate('${You} place ${<}${age}${>} ${<<}${name}${>>} from your forecast on top of its deck.');
                $message_for_others = clienttranslate('${player_name} places a ${<}${age}${>} from his forecast on top of its deck.');
            }
            break;
        case 'forecast->achievements':
            $message_for_player = clienttranslate('${You} achieve ${<}${age}${>} ${<<}${name}${>>} from your forecast.');
            $message_for_others = clienttranslate('${player_name} achieves a ${<}${age}${>} from his forecast.');
            break;
        case 'forecast->revealed':
            $message_for_player = clienttranslate('${You} reveal ${<}${age}${>} ${<<}${name}${>>}.');
            $message_for_others = clienttranslate('${player_name} reveals ${<}${age}${>} ${<<}${name}${>>}.');
            break;
        case 'forecast->hand':
            $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your forecast to your hand.');
            $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from his forecast to his hand.');
            break;
            
        default:
            // This should not happen
            throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => 'notifyWithOnePlayerInvolved()', 'code' => $location_from . '->' . $location_to)));
            break;
        }
        
        self::sendNotificationWithOnePlayerInvolved($message_for_player, $message_for_others, $card, $transferInfo, $progressInfo);
    }
    
    function getTransferInfoWithOnePlayerInvolved($location_from, $location_to, $player_id_is_owner_from, $bottom_from, $bottom_to, $you_must, $player_must, $player_name, $number, $cards, $targetable_players, $code) {
        // Creation of the message
        if ($location_from == $location_to && $location_from == 'board') { // Used only for Self service
            // TODO(LATER): We can simplify Self Service to use "board->none", guarded by release_version.
            $message_for_player = clienttranslate('${You_must} choose ${number} other top ${card} from your board');
            $message_for_others = clienttranslate('${player_must} choose ${number} other top ${card} from his board');            
        } else if ($targetable_players !== null) { // Used when several players can be targeted
            switch($location_from . '->' . $location_to) {
            case 'score->deck':
                $message_for_player = clienttranslate('${You_must} return ${number} ${card} from the score pile of ${targetable_players}');
                $message_for_others = clienttranslate('${player_must} return ${number} ${card} from the score pile of ${targetable_players}');
                break;
            case 'board->deck':
                $message_for_player = clienttranslate('${You_must} return ${number} top ${card} from the board of ${targetable_players}');
                $message_for_others = clienttranslate('${player_must} return ${number} top ${card} from the board of ${targetable_players}');
                break;
            case 'board->score':
                $message_for_player = clienttranslate('${You_must} transfer ${number} top ${card} from the board of ${targetable_players} to your score pile');
                $message_for_others = clienttranslate('${player_must} transfer ${number} top ${card} from the board of ${targetable_players} to his score pile');
                break;
            case 'board->achievements':
                $message_for_player = clienttranslate('${You_must} transfer ${number} top ${card} from the board of ${targetable_players} to your achievements');
                $message_for_others = clienttranslate('${player_must} transfer ${number} top ${card} from the board of ${targetable_players} to his achievements');
                break;
            case 'board->none':
                if ($code === '134N1A') {
                    $message_for_player = clienttranslate('${You_must} choose ${number} other top ${card} from the board of ${targetable_players}');
                    $message_for_others = clienttranslate('${player_must} choose ${number} other top ${card} from the board of ${targetable_players}');
                } else if ($code === '134N1+A' || $code === '134N1B' || $code === '367E1A') {
                    $message_for_player = clienttranslate('${You_must} choose a pile to splay left from the board of ${targetable_players}');
                    $message_for_others = clienttranslate('${player_must} choose a pile to splay left from the board of ${targetable_players}');
                } else if ($code === '136N1B' || $code === '161N1A') {
                    $message_for_player = clienttranslate('${You_must} choose a top card to execute from the board of ${targetable_players}');
                    $message_for_others = clienttranslate('${player_must} choose a top card to execute from the board of ${targetable_players}');
                } else if ($code === '417N1A') {
                    $message_for_player = clienttranslate('${You_must} choose a top card to transfer from the board of ${targetable_players} to his score pile');
                    $message_for_others = clienttranslate('${player_must} choose a top card to transfer from the board of ${targetable_players} to his score pile');
                } else {
                    // This should not happen
                    throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => 'getTransferInfoWithOnePlayerInvolved()', 'code' => $location_from . '->' . $location_to)));
                }
                break;
            case 'hand->none':
                if ($code === '350N1B' || $code === '350N1D') {
                    $message_for_player = clienttranslate('${You_must} choose ${number} ${card} from your hand to meld or score');
                    $message_for_others = clienttranslate('${player_must} choose ${number} ${card} from his hand to meld or score');
                } else {
                    // This should not happen
                    throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => 'getTransferInfoWithOnePlayerInvolved()', 'code' => $location_from . '->' . $location_to)));
                }
                break;
            default:
                // This should not happen
                throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => 'getTransferInfoWithOnePlayerInvolved()', 'code' => $location_from . '->' . $location_to)));
                break;
            }
        } else {
            switch($location_from . '->' . $location_to) { 
            case 'achievements->achievements':
                if ($player_id_is_owner_from) {
                    $message_for_player = clienttranslate('${You_must} return ${number} ${card} to the available achievements');
                    $message_for_others = clienttranslate('${player_must} return ${number} ${card} to the available achievements');
                } else {
                    $message_for_player = clienttranslate('${You_must} claim ${number} ${card} from the available achievements');
                    $message_for_others = clienttranslate('${player_must} claim ${number} ${card} from the available achievements');
                }
                break;
            case 'achievements->deck':
                $message_for_player = clienttranslate('${You_must} return ${number} ${card} from your achievements');
                $message_for_others = clienttranslate('${player_must} return ${number} ${card} from his achievements');
                break;
            case 'achievements->junk':
                $message_for_player = clienttranslate('${You_must} junk ${number} ${card} from the available achievements');
                $message_for_others = clienttranslate('${player_must} junk ${number} ${card} from the available achievements');
                break;
            case 'hand->deck':
                if ($bottom_to) {
                    $message_for_player = clienttranslate('${You_must} return ${number} ${card} from your hand');
                    $message_for_others = clienttranslate('${player_must} return ${number} ${card} from his hand');
                } else {
                    $message_for_player = clienttranslate('${You_must} place ${number} ${card} from your hand on top of its deck');
                    $message_for_others = clienttranslate('${player_must} places ${number} ${card} from his hand on top of its deck');
                }
                break;
            case 'hand,score->deck':
                $message_for_player = clienttranslate('${You_must} return ${number} ${card} from your hand and score pile');
                $message_for_others = clienttranslate('${player_must} return ${number} ${card} from his hand and score pile');
                break;
            case 'hand->board':
                if ($bottom_to) {
                    $message_for_player = clienttranslate('${You_must} tuck ${number} ${card} from your hand');
                    $message_for_others = clienttranslate('${player_must} tuck ${number} ${card} from his hand');
                }
                else {
                    $message_for_player = clienttranslate('${You_must} meld ${number} ${card} from your hand');
                    $message_for_others = clienttranslate('${player_must} meld ${number} ${card} from his hand');
                }
                break;
            case 'hand->score':
                $message_for_player = clienttranslate('${You_must} score ${number} ${card} from your hand');
                $message_for_others = clienttranslate('${player_must} score ${number} ${card} from his hand');
                break;
            case 'hand->revealed':
                $message_for_player = clienttranslate('${You_must} reveal ${number} ${card} from your hand');
                $message_for_others = clienttranslate('${player_must} reveal ${number} ${card} from his hand');
                break;
            case 'hand->revealed,score':
                $message_for_player = clienttranslate('${You_must} reveal and score ${number} ${card} from your hand');
                $message_for_others = clienttranslate('${player_must} reveal and score ${number} ${card} from his hand');
                break;
            case 'hand->achievements':
                $message_for_player = clienttranslate('${You_must} achieve ${number} ${card} from your hand');
                $message_for_others = clienttranslate('${player_must} achieve ${number} ${card} from his hand');
                break;
            case 'hand->forecast':
                $message_for_player = clienttranslate('${You_must} foreshadow ${number} ${card} from your hand');
                $message_for_others = clienttranslate('${player_must} foreshadow ${number} ${card} from his hand');
                break;
            case 'hand->none':
                $message_for_player = clienttranslate('${You_must} choose ${number} ${card} from your hand');
                $message_for_others = clienttranslate('${player_must} choose ${number} ${card} from his hand');
                break;
            case 'board->deck':
                $message_for_player = clienttranslate('${You_must} return ${number} top ${card} from your board');
                $message_for_others = clienttranslate('${player_must} return ${number} top ${card} from his board');
                break;
            case 'board->hand':
                if ($bottom_from == 1) {
                    $message_for_player = clienttranslate('${You_must} take ${number} bottom ${card} from your board into your hand');
                    $message_for_others = clienttranslate('${player_must} take ${number} bottom ${card} from his board into his hand');
                } else {
                    $message_for_player = clienttranslate('${You_must} take ${number} top ${card} from your board into your hand');
                    $message_for_others = clienttranslate('${player_must} take ${number} top ${card} from his board into his hand');
                }
                break;
            case 'board->score':
                if ($bottom_from == 1) {
                    $message_for_player = clienttranslate('${You_must} score ${number} bottom ${card} from your board');
                    $message_for_others = clienttranslate('${player_must} score ${number} bottom ${card} from his board');
                } else {
                    $message_for_player = clienttranslate('${You_must} score ${number} top ${card} from your board');
                    $message_for_others = clienttranslate('${player_must} score ${number} top ${card} from his board');
                }
                break;
            case 'board->none':
                $message_for_player = clienttranslate('${You_must} choose ${number} top ${card} from your board');
                $message_for_others = clienttranslate('${player_must} choose ${number} top ${card} from his board');
                break;
            case 'board->achievements':
                $message_for_player = clienttranslate('${You_must} achieve ${number} top ${card} from your board');
                $message_for_others = clienttranslate('${player_must} achieve ${number} top ${card} from his board');
                break;
            case 'score->deck':
                $message_for_player = clienttranslate('${You_must} return ${number} ${card} from your score pile');
                $message_for_others = clienttranslate('${player_must} return ${number} ${card} from his score pile');
                break;
            case 'score->revealed,deck':
                $message_for_player = clienttranslate('${You_must} reveal and return ${number} ${card} from your score pile');
                $message_for_others = clienttranslate('${player_must} reveal and return ${number} ${card} from his score pile');
                break;
            case 'score->hand':
                $message_for_player = clienttranslate('${You_must} transfer ${number} ${card} from your score pile to your hand');
                $message_for_others = clienttranslate('${player_must} transfer ${number} ${card} from his score pile to his hand');
                break;
            case 'score->board':
                if ($bottom_to) {
                    $message_for_player = clienttranslate('${You_must} tuck ${number} ${card} from your score pile');
                    $message_for_others = clienttranslate('${player_must} tucks ${number} ${card} from his score pile');
                }
                else {
                    $message_for_player = clienttranslate('${You_must} meld ${number} ${card} from your score pile');
                    $message_for_others = clienttranslate('${player_must} meld ${number} ${card} from his score pile');
                }
                break;
            case 'score->revealed':
                $message_for_player = clienttranslate('${You_must} reveal ${number} ${card} from your score pile');
                $message_for_others = clienttranslate('${player_must} reveal ${number} ${card} from his score pile');
                break;
            case 'score->achievements':
                $message_for_player = clienttranslate('${You_must} achieve ${number} ${card} from your score pile');
                $message_for_others = clienttranslate('${player_must} achieve ${number} ${card} from his score pile');
                break;
            case 'revealed->deck':
                $message_for_player = clienttranslate('${You_must} return ${number} ${card} you revealed');
                $message_for_others = clienttranslate('${player_must} return ${number} ${card} he revealed');
                break;
            case 'revealed->board':
                $message_for_player = clienttranslate('${You_must} meld ${number} ${card} you revealed');
                $message_for_others = clienttranslate('${player_must} meld ${number} ${card} he revealed');
                break;
            case 'revealed->score':
                $message_for_player = clienttranslate('${You_must} score ${number} ${card} you revealed');
                $message_for_others = clienttranslate('${player_must} score ${number} ${card} he revealed');
                break;
            case 'revealed,hand->deck': // Alchemy, Physics
                $message_for_player = clienttranslate('${You_must} return ${number} ${card} you revealed and ${number} ${card} in your hand');
                $message_for_others = clienttranslate('${player_must} return ${number} ${card} he revealed and ${number} ${card} in his hand');
                break;
            case 'revealed,score->deck':
                $message_for_player = clienttranslate('${You_must} return ${number} ${card} you revealed and ${number} ${card} from your score pile');
                $message_for_others = clienttranslate('${player_must} return ${number} ${card} he revealed and ${number} ${card} from his score pile');
                break;
            case 'hand->revealed,deck': // Measurement
                $message_for_player = clienttranslate('${You_must} reveal and return ${number} ${card} from your hand');
                $message_for_others = clienttranslate('${player_must} reveal and return ${number} ${card} from his hand');
                break;
            case 'pile->deck': // Skyscrapers
                $message_for_player = clienttranslate('${You_must} return ${number} ${card} from your board');
                $message_for_others = clienttranslate('${player_must} return ${number} ${card} from his board');
                break;
            case 'forecast->deck':
                if ($bottom_to) {
                    $message_for_player = clienttranslate('${You_must} return ${number} ${card} from your forecast');
                    $message_for_others = clienttranslate('${player_must} returns ${number} ${card} from his forecast');
                }
                else {
                    $message_for_player = clienttranslate('${You_must} place ${number} ${card} from your forecast on top of its deck');
                    $message_for_others = clienttranslate('${player_must} places ${number} ${card} from his forecast on top of its deck');
                }
                break;
            case 'forecast->revealed,deck':
                $message_for_player = clienttranslate('${You_must} reveal and return ${number} ${card} from your forecast');
                $message_for_others = clienttranslate('${player_must} reveal and return ${number} ${card} from his forecast');
                break;
            case 'forecast->board':
                $message_for_player = clienttranslate('${You_must} meld ${number} ${card} from your forecast to your board');
                $message_for_others = clienttranslate('${player_must} meld ${number} ${card} from his forecast to his board');
                break;
            case 'forecast->hand':
                $message_for_player = clienttranslate('${You_must} transfer ${number} ${card} from your forecast to your hand');
                $message_for_others = clienttranslate('${player_must} transfer ${number} ${card} from his forecast to his hand');
                break;
            case 'forecast->achievements':
                $message_for_player = clienttranslate('${You_must} transfer ${number} ${card} from your forecast to your achievements');
                $message_for_others = clienttranslate('${player_must} transfer ${number} ${card} from his forecast to his achievements');
                break;
            case 'deck->hand':
                $message_for_player = clienttranslate('${You_must} look at ${number} top ${card} of any deck');
                $message_for_others = clienttranslate('${player_must} transfer ${number} top ${card} of any deck');
                break;
            default:
                // This should not happen
                throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => 'getTransferInfoWithOnePlayerInvolved()', 'code' => $location_from . '->' . $location_to)));
                break;
            }
        }

        return [
            'message_for_player' => [
                'i18n' => ['log'],
                'log' => $message_for_player,
                'args' => [
                    'i18n' => ['targetable_players'],
                    'You_must' => [
                        'i18n' => ['log'],
                        'log' => $you_must,
                        'args' => [
                            'You' => 'You',
                        ],
                    ],
                    'number' => $number,
                    'card' => $cards,
                    'targetable_players' => $targetable_players,
                ],
            ],
            'message_for_others' => [
                'i18n' => ['log'],
                'log' => $message_for_others,
                'args' => [
                    'i18n' => ['targetable_players'],
                    'player_must' => [
                        'i18n' => ['log'],
                        'log' => $player_must,
                        'args' => [
                            'player_name' => $player_name,
                        ],
                    ],
                    'number' => $number,
                    'card' => $cards,
                    'targetable_players' => $targetable_players,
                ],
            ],
        ];
    }
    
    function notifyWithTwoPlayersInvolved($card, $transferInfo, $progressInfo) {
        // [*] ATTENTION: when modifiing, modify getTransferInfoWithTwoPlayersInvolved at the same time 
        $owner_from = $transferInfo['owner_from'];
        $owner_to = $transferInfo['owner_to'];
        
        $location_from = $transferInfo['location_from'];
        $location_to = $transferInfo['location_to'];
        
        $player_id = $transferInfo['player_id'];
        
        if ($owner_from == 0 || $owner_to == 0) { // Used only for Rocketry or Fission or Mass media
            switch($location_from . '->' . $location_to) {
            case 'score->deck':
                $message_for_player = clienttranslate('${You} return a ${<}${age}${>} from ${opponent_name}\'s score pile.');
                $message_for_opponent = clienttranslate('${player_name} returns ${<}${age}${>} ${<<}${name}${>>} from ${your} score pile.');
                $message_for_others = clienttranslate('${player_name} returns a ${<}${age}${>} from ${opponent_name}\'s score pile.');
                break;
            case 'score->relics':
                $message_for_player = clienttranslate('${You} return ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s score pile.');
                $message_for_opponent = clienttranslate('${player_name} returns ${<}${age}${>} ${<<}${name}${>>} from ${your} score pile.');
                $message_for_others = clienttranslate('${player_name} returns ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s score pile.');
                break;

            case 'board->deck':
            case 'board->relics':
                $message_for_player = clienttranslate('${You} return ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s board.');
                $message_for_opponent = clienttranslate('${player_name} returns ${<}${age}${>} ${<<}${name}${>>} from ${your} board.');
                $message_for_others = clienttranslate('${player_name} returns ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s board.');
                break;

            default:
                // This should not happen
                throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => 'notifyWithTwoPlayersInvolved()', 'code' => $location_from . '->' . $location_to)));
                break;
            }
        }        
        else if ($player_id == $owner_from) {
            switch($location_from . '->' . $location_to) {
            case 'hand->hand':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your hand to ${opponent_name}\'s hand.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his hand to ${your} hand.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from his hand to ${opponent_name}\'s hand.');
                break;
                
            case 'hand->score':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your hand to ${opponent_name}\'s score pile.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his hand to ${your} score pile.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from his hand to ${opponent_name}\'s score pile.');
                break;
            
            case 'hand->board':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your hand to ${opponent_name}\'s board.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his hand to ${your} board.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his hand to ${opponent_name}\'s board.');
                break;
                
            case 'hand->achievements':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your hand to ${opponent_name}\'s achievements.');
                $message_for_opponent = clienttranslate('${player_name} transfers a ${<}${age}${>} from his hand to ${your} achievements.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from his hand to ${opponent_name}\'s achievements.');
                break;

            case 'hand->forecast':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your hand to ${opponent_name}\'s forecast.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his hand to ${your} forecast.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from his hand to ${opponent_name}\'s forecast.');
                break;
                
            case 'board->board':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your board to ${opponent_name}\'s board.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his board to ${your} board.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his board to ${opponent_name}\'s board.');
                break;
                
            case 'board->hand':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your board to ${opponent_name}\'s hand.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his board to ${your} hand.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his board to ${opponent_name}\'s hand.');
                break;
        
            case 'board->score':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your board to ${opponent_name}\'s score pile.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his board to ${your} score pile.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his board to ${opponent_name}\'s score pile.');
                break;
            
            case 'board->achievements':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your board to ${opponent_name}\'s achievements.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his board to ${your} achievements.');
                $message_for_others = clienttranslate('${player_name} transfers a${<}${age}${>} ${<<}${name}${>>} from his board to ${opponent_name}\'s achievements.');
                break;

            case 'score->hand':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your score pile to ${opponent_name}\'s hand.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his score pile to ${your} hand.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from his score pile to ${opponent_name}\'s hand.');
                break;
                
            case 'score->score':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your score pile to ${opponent_name}\'s score pile.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from his score pile to ${your} score pile.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from his score pile to ${opponent_name}\'s score pile.');
                break;

            case 'score->achievements':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from your score pile to ${opponent_name}\'s achievements.');
                $message_for_opponent = clienttranslate('${player_name} transfers a ${<}${age}${>} from his score pile to ${your} achievements.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from his score pile to ${opponent_name}\'s achievements.');
                break;     

            case 'revealed->achievements':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} to ${opponent_name}\'s achievements.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} to ${your} achievements.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} to ${opponent_name}\'s achievements.');
                break;

            case 'revealed->forecast':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} to ${opponent_name}\'s forecast.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} to ${your} forecast.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} to ${opponent_name}\'s forecast.');
                break;
                
            case 'achievements->achievements':
                $message_for_player = clienttranslate('${You} transfer a ${<}${age}${>} from your achievements to ${opponent_name}\'s achievements.');
                $message_for_opponent = clienttranslate('${player_name} transfers a ${<}${age}${>} from his achievements to ${your} achievements.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from his achievements to ${opponent_name}\'s achievements.');
                break;
                
            case 'revealed->board':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} to ${opponent_name}\'s board.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} to ${your} board.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} to ${opponent_name}\'s board.');
                break;

            case 'revealed->hand':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} to ${opponent_name}\'s hand.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} to ${your} hand.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} to ${opponent_name}\'s hand.');
                break;
                
            default:
                // This should not happen
                throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => 'notifyWithTwoPlayersInvolved()', 'code' => $location_from . '->' . $location_to)));
                break;
            }
        }
        else { // $transferInfo['player_id'] == $transferInfo['owner_to']
            switch($location_from . '->' . $location_to) {
            case 'hand->hand':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s hand to your hand.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} hand to his hand.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from ${opponent_name}\'s hand to his hand.');
                break;

            case 'hand->achievements':
                $message_for_player = clienttranslate('${You} transfer a ${<}${age}${>} from ${opponent_name}\'s hand to your achievements.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} hand to his achievements.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from ${opponent_name}\'s hand to his achievements.');
                break;  

            case 'hand->forecast':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s hand to your forecast.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} hand to his forecast.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from ${opponent_name}\'s hand to his forecast.');
                break;  
                
            case 'board->board':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s board to your board.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} board to his board.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s board to his board.');
                break;
                
            case 'board->hand':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s board to your hand.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} board to his hand.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s board to his hand.');
                break;    

            case 'board->achievements':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s board to your achievements.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} board to his achievements.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s board to his achievements.');
                break;  

            case 'board->score':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s board to your score pile.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} board to his score pile.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s board to his score pile.');
                break;

            case 'display->board':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s display to your board.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} display to his board.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s display to his board.');
                break;
                
            case 'revealed->board': // Collaboration
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} to your board');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} to his board');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} to his board');
                break;
                
            case 'revealed->achievements':
                $message_for_player = clienttranslate('${You} achieve ${<}${age}${>} ${<<}${name}${>>}.');
                $message_for_others = clienttranslate('${player_name} achieves ${<}${age}${>} ${<<}${name}${>>}.');
                break;

            case 'revealed->forecast':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} to your forecast.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} to his forecast.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} to his forecast.');
                break;

            case 'achievements->achievements':
                $message_for_player = clienttranslate('${You} seize the ${<}${age}${>} relic from ${opponent_name}\'s achievements to your achievements.');
                $message_for_opponent = clienttranslate('${player_name} seizes the ${<}${age}${>} relic from ${your} achievements to his achievements.');
                $message_for_others = clienttranslate('${player_name} seizes the ${<}${age}${>} relic from ${opponent_name}\'s achievements to his achievements.');
                break;

            case 'achievements->hand':
                $message_for_player = clienttranslate('${You} seize ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s achievements to your hand.');
                $message_for_opponent = clienttranslate('${player_name} seizes the ${<}${age}${>} relic from ${your} achievements to his hand.');
                $message_for_others = clienttranslate('${player_name} seizes the ${<}${age}${>} relic from ${opponent_name}\'s achievements to his hand.');
                break;

            case 'score->score':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s score pile to your score pile.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} score pile to his score pile.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from ${opponent_name}\'s score pile to his score pile.');
                break;

            case 'score->hand':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s score pile to your hand.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} score pile to his hand.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from ${opponent_name}\'s score pile to his hand.');
                break;

            case 'score->achievements':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s score pile to your achievements.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} score pile to his achievements.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from ${opponent_name}\'s score pile to his achievements.');
                break;

            case 'score->board':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s score pile to ${opponent_name}\'s board.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} score pile to ${your} board.');
                $message_for_others = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s score pile to ${opponent_name}\'s board.');
                break;

            case 'hand->score':
                $message_for_player = clienttranslate('${You} transfer ${<}${age}${>} ${<<}${name}${>>} from ${opponent_name}\'s hand to your score pile.');
                $message_for_opponent = clienttranslate('${player_name} transfers ${<}${age}${>} ${<<}${name}${>>} from ${your} hand to his score pile.');
                $message_for_others = clienttranslate('${player_name} transfers a ${<}${age}${>} from ${opponent_name}\'s hand to his score pile.');
                break;
                
            default:
                // This should not happen
                throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => 'notifyWithTwoPlayersInvolved()', 'code' => $location_from . '->' . $location_to)));
                break;
            }
        }
        
        self::sendNotificationWithTwoPlayersInvolved($message_for_player, $message_for_opponent, $message_for_others, $card, $transferInfo, $progressInfo);
    }
        
    function getTransferInfoWithTwoPlayersInvolved($location_from, $location_to, $player_id_is_owner_from, $player_id_is_owner_to, $you_must, $player_must, $your, $player_name, $opponent_name, $number, $cards) {
        // [*] ATTENTION: when modifying, modify notifyWithTwoPlayersInvolved at the same time
        if ($player_id_is_owner_from) {
            switch($location_from . '->' . $location_to) {
            case 'hand->hand':
                $message_for_player = clienttranslate('${You_must} transfer ${number} ${card} from your hand to ${opponent_name}\'s hand');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} ${card} from his hand to ${your} hand');
                $message_for_others = clienttranslate('${player_must} transfer ${number} ${card} from his hand to ${opponent_name}\'s hand');
                break;
                
            case 'hand->score':
                $message_for_player = clienttranslate('${You_must} transfer ${number} ${card} from your hand to ${opponent_name}\'s score pile');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} ${card} from his hand to ${your} score pile');
                $message_for_others = clienttranslate('${player_must} transfer ${number} ${card} from his hand to ${opponent_name}\'s score pile');
                break;
            
            case 'hand->board':
                $message_for_player = clienttranslate('${You_must} transfer ${number} ${card} from your hand to ${opponent_name}\'s board');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} ${card} from his hand to ${your} board');
                $message_for_others = clienttranslate('${player_must} transfer ${number} ${card} from his hand to ${opponent_name}\'s board');
                break;
                
            case 'hand->achievements':
                $message_for_player = clienttranslate('${You_must} transfer ${number} ${card} from your hand to ${opponent_name}\'s achievements');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} ${card} from his hand to ${your} achievements');
                $message_for_others = clienttranslate('${player_must} transfer ${number} ${card} from his hand to ${opponent_name}\'s achievements');
                break;              
                
            case 'board->board':
                $message_for_player = clienttranslate('${You_must} transfer ${number} top ${card} from your board to ${opponent_name}\'s board');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} top ${card} from his board to ${your} board');
                $message_for_others = clienttranslate('${player_must} transfer ${number} top ${card} from his board to ${opponent_name}\'s board');
                break;
            
            case 'board->hand':
                $message_for_player = clienttranslate('${You_must} transfer ${number} top ${card} from your board to ${opponent_name}\'s hand');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} top ${card} from his board to ${your} hand');
                $message_for_others = clienttranslate('${player_must} transfer ${number} top ${card} from his board to ${opponent_name}\'s hand');
                break;
                
            case 'board->score':
                $message_for_player = clienttranslate('${You_must} transfer ${number} top ${card} from your board to ${opponent_name}\'s score pile');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} top ${card} from his board to ${your} score pile');
                $message_for_others = clienttranslate('${player_must} transfer ${number} top ${card} from his board to ${opponent_name}\'s score pile');
                break;

            case 'board->achievements':
                $message_for_player = clienttranslate('${You_must} transfer ${number} top ${card} from your board to ${opponent_name}\'s achievements');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} top ${card} from his board to ${your} achievements');
                $message_for_others = clienttranslate('${player_must} transfer ${number} top ${card} from his board to ${opponent_name}\'s achievements');
                break;
                
            case 'score->score':
                $message_for_player = clienttranslate('${You_must} transfer ${number} ${card} from your score pile to ${opponent_name}\'s score pile');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} ${card} from his score pile to ${your} score pile');
                $message_for_others = clienttranslate('${player_must} transfer ${number} ${card} from his score pile to ${opponent_name}\'s score pile');
                break;
            
            case 'achievements->achievements':
                $message_for_player = clienttranslate('${You_must} transfer ${number} ${card} from your achievements to ${opponent_name}\'s achievements');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} ${card} from his achievements to ${your} achievements');
                $message_for_others = clienttranslate('${player_must} transfer ${number} ${card} from his achievements to ${opponent_name}\'s achievements');
                break;

            case 'revealed->board':
                $message_for_player = clienttranslate('${You_must} transfer ${number} ${card} to ${opponent_name}\'s board');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} ${card} to ${your} board');
                $message_for_others = clienttranslate('${player_must} transfer ${number} ${card} to ${opponent_name}\'s board');
                break;

            default:
                // This should not happen
                throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => 'getTransferInfoWithTwoPlayersInvolved()', 'code' => $location_from . '->' . $location_to)));
                break;
            }
        } else if ($player_id_is_owner_to) {
            switch($location_from . '->' . $location_to) {
            case 'board->board':
                $message_for_player = clienttranslate('${You_must} transfer ${number} top ${card} from ${opponent_name}\'s board to your board');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} top ${card} from ${your} board to his board');
                $message_for_others = clienttranslate('${player_must} transfer ${number} top ${card} from ${opponent_name}\'s board to his board');
                break;
                
            case 'board->hand':
                $message_for_player = clienttranslate('${You_must} transfer ${number} top ${card} from ${opponent_name}\'s board to your hand');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} top ${card} from ${your} board to his hand');
                $message_for_others = clienttranslate('${player_must} transfer ${number} top ${card} from ${opponent_name}\'s board to his hand');
                break;
            
            case 'revealed->board': // Collaboration
                $message_for_player = clienttranslate('${You_must} transfer ${number} revealed ${card} to your board.');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} revealed ${card} to his board.');
                $message_for_others = clienttranslate('${player_must} transfer ${number} revealed ${card} to his board.');
                break;

            case 'score->achievements':
                $message_for_player = clienttranslate('${You_must} transfer ${number} ${card} from ${opponent_name}\'s score pile to your achievements');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} ${card} from ${your} score pile to ${your} achievements');
                $message_for_others = clienttranslate('${player_must} transfer ${number} ${card} from ${opponent_name}\'s score pile to ${opponent_name}\'s achievements');
                break;
            
            default:
                // This should not happen
                throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => 'getTransferInfoWithTwoPlayersInvolved()', 'code' => $location_from . '->' . $location_to)));
                break;
            }
        } else {
            switch($location_from . '->' . $location_to) {
            case 'score->board':
                $message_for_player = clienttranslate('${You_must} transfer ${number} ${card} from ${opponent_name}\'s score pile to ${opponent_name}\'s board');
                $message_for_opponent = clienttranslate('${player_must} transfer ${number} ${card} from ${your} score pile to ${your} board');
                $message_for_others = clienttranslate('${player_must} transfer ${number} ${card} from ${opponent_name}\'s score pile to ${opponent_name}\'s board');
                break;

            default:
                // This should not happen
                throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => 'getTransferInfoWithTwoPlayersInvolved()', 'code' => $location_from . '->' . $location_to)));
                break;
            }
        }

        return [
            'message_for_player' => [
                'i18n' => ['log'],
                'log' => $message_for_player,
                'args' => [
                    'You_must' => [
                        'i18n' => ['log'],
                        'log' => $you_must,
                        'args' => [
                            'You' => 'You',
                        ],
                    ],
                    'number' => $number,
                    'card' => $cards,
                    'opponent_name' => $opponent_name,
                ],
            ],
            'message_for_opponent' => [
                'i18n' => ['log'],
                'log' => $message_for_opponent,
                'args' => [
                    'player_must' => [
                        'i18n' => ['log'],
                        'log' => $player_must,
                        'args' => [
                            'player_name' => $player_name,
                        ],
                    ],
                    'number' => $number,
                    'card' => $cards,
                    'your' => $your,
                ],
            ],
            'message_for_others' => [
                'i18n' => ['log'],
                'log' => $message_for_others,
                'args' => [
                    'player_must' => [
                        'i18n' => ['log'],
                        'log' => $player_must,
                        'args' => [
                            'player_name' => $player_name,
                        ],
                    ],
                    'number' => $number,
                    'card' => $cards,
                    'opponent_name' => $opponent_name,
                ],
            ],
        ];
    }

    function sendNotificationWithNoPlayersInvolved($message, $card, $transferInfo, $progressInfo) {     
        $info = array_merge($transferInfo, $progressInfo);
        
        $delimiters = self::getDelimiterMeanings($message, $card['id']);
        $notif_args = array_merge($info, $delimiters);
        $notif_args['age'] = $card['age'];
        $notif_args['type'] = $card['type'];
        $notif_args['is_relic'] = $card['is_relic'];
        
        self::notifyAllPlayers("transferedCard", $message, $notif_args);
    }
    
    function sendNotificationWithOnePlayerInvolved($message_for_player, $message_for_others, $card, $transferInfo, $progressInfo) {     
        $player_id = $transferInfo['player_id'];
        $player_name = self::getPlayerNameFromId($player_id);
        
        $info = array_merge($transferInfo, $progressInfo);
        
        // Information to attach to the involved player
        $delimiters_for_player = self::getDelimiterMeanings($message_for_player, $card['id']);
        $notif_args_for_player = array_merge($info, $delimiters_for_player);
        $notif_args_for_player['You'] = 'You';
        $notif_args_for_player['your'] = 'your';
        // Visibility for involved player
        if (array_key_exists('<<', $delimiters_for_player) || $card['id'] >= 1000) {
            // The player can see the front of the card
            $notif_args_for_player['i18n'] = array('name');
            $notif_args_for_player['name'] = self::getCardName($card['id']);
            // TODO(LATER): We should stop sending the card's properties which aren't actually used.
            $notif_args_for_player = array_merge($notif_args_for_player, $card);
        } else if (array_key_exists('<<<', $delimiters_for_player)) {
            $notif_args_for_player['i18n'] = array('name');
            $notif_args_for_player['age'] = $card['age'];
            $notif_args_for_player['type'] = $card['type'];
            $notif_args_for_player['is_relic'] = $card['is_relic'];
            // The player can see the front of the card because it is a special achievement
            if ($card['age'] === null) {
                $notif_args_for_player['id'] = $card['id'];
                $notif_args_for_player['name'] = self::getCardName($card['id']);
            }
        } else {
            // The player can't see the front of the card
            $notif_args_for_player['age'] = $card['age'];
            $notif_args_for_player['type'] = $card['type'];
            $notif_args_for_player['is_relic'] = $card['is_relic'];
        }
        
        // Information to attach to others (other players and spectators)
        $delimiters_for_others = self::getDelimiterMeanings($message_for_others, $card['id']);
        $notif_args_for_others = array_merge($info, $delimiters_for_others);
        $notif_args_for_others['player_name'] =  $player_name; // The color in the log will be defined automatically by the system
        
        // Visibility for others
        if (array_key_exists('<<', $delimiters_for_others) || $card['id'] >= 1000) {
            // Other players can see the front of the card
            $notif_args_for_others['i18n'] = array('name');
            $notif_args_for_others['name'] = self::getCardName($card['id']);
            // TODO(LATER): We should stop sending the card's properties which aren't actually used.
            $notif_args_for_others = array_merge($notif_args_for_others, $card);
        } else if (array_key_exists('<<<', $delimiters_for_others)) {
            $notif_args_for_others['i18n'] = array('name');
            $notif_args_for_others['age'] = $card['age'];
            $notif_args_for_others['type'] = $card['type'];
            $notif_args_for_others['is_relic'] = $card['is_relic'];
            // Other players can see the front of the card because it is a special achievement
            if ($card['age'] === null) {
                $notif_args_for_others['id'] = $card['id'];
                $notif_args_for_others['name'] = self::getCardName($card['id']);
            }
        } else {
            // Other players can't see the front of the card
            $notif_args_for_others['age'] = $card['age'];
            $notif_args_for_others['type'] = $card['type'];
            $notif_args_for_others['is_relic'] = $card['is_relic'];
        }
        
        self::notifyPlayer($player_id, "transferedCard", $message_for_player, $notif_args_for_player);
        self::notifyAllPlayersBut($player_id, "transferedCard", $message_for_others, $notif_args_for_others);
    }
    
    function sendNotificationWithTwoPlayersInvolved($message_for_player, $message_for_opponent, $message_for_others, $card, $transferInfo, $progressInfo) {
        $player_id = $transferInfo['player_id'];
        $player_name = self::getPlayerNameFromId($player_id);
        $opponent_id = $transferInfo['opponent_id'];
        $opponent_name = self::getPlayerNameFromId($opponent_id);
        
        $info = array_merge($transferInfo, $progressInfo);
        
        // Information to attach to the player
        $delimiters_for_player = self::getDelimiterMeanings($message_for_player, $card['id']);
        // TODO(LATER): We should stop sending the card's properties which aren't actually used.
        $notif_args_for_player = array_merge($info, $delimiters_for_player, $card); // The player can always see the card
        $notif_args_for_player['i18n'] = array('name');
        $notif_args_for_player['name'] = self::getCardName($card['id']);
        $notif_args_for_player['You'] =  'You';
        $notif_args_for_player['your'] = 'your';
        $notif_args_for_player['opponent_name'] =  self::getColoredText($opponent_name, $opponent_id);
        
        // Information to attach to the opponent
        $delimiters_for_opponent = self::getDelimiterMeanings($message_for_opponent, $card['id']);
        // TODO(LATER): We should stop sending the card's properties which aren't actually used.
        $notif_args_for_opponent = array_merge($info, $delimiters_for_opponent, $card); // The opponent can always see the card
        $notif_args_for_opponent['i18n'] = array('name');
        $notif_args_for_opponent['name'] = self::getCardName($card['id']);
        $notif_args_for_opponent['You'] = 'You';
        $notif_args_for_opponent['your'] = 'your';
        $notif_args_for_opponent['player_name'] =  $player_name;  // The color in the log will be defined automatically by the system
        
        // Information to attach to others (other players and spectators)
        $delimiters_for_others = self::getDelimiterMeanings($message_for_others, $card['id']);
        $notif_args_for_others = array_merge($info, $delimiters_for_others);
        $notif_args_for_others['player_name'] =  $player_name; // The color in the log will be defined automatically by the system
        $notif_args_for_others['opponent_name'] =  self::getColoredText($opponent_name, $opponent_id);
        
        // Visibility for others
        if (array_key_exists('<<', $delimiters_for_others)) {
            // Other players can see the front of the card
            $notif_args_for_others['i18n'] = array('name');
            $notif_args_for_others['name'] = self::getCardName($card['id']);
            // TODO(LATER): We should stop sending the card's properties which aren't actually used.
            $notif_args_for_others = array_merge($notif_args_for_others, $card);
        } else {
            // Other players can't see the front of the card
            $notif_args_for_others['age'] = $card['age'];
            $notif_args_for_others['type'] = $card['type'];
            $notif_args_for_others['is_relic'] = $card['is_relic'];
        }
        
        self::notifyPlayer($player_id, "transferedCard", $message_for_player, $notif_args_for_player);
        self::notifyPlayer($opponent_id, "transferedCard", $message_for_opponent, $notif_args_for_opponent);
        self::notifyAllPlayersBut(array($player_id, $opponent_id), "transferedCard", $message_for_others, $notif_args_for_others);
    }

    /** Returns the list of player IDs which are not adjacent to the current player (i.e. the players used for the 4th edition distance rule) */
    function getPlayerIdsAffectedByDistanceRule() {
        if (!$this->innovationGameState->usingFourthEditionRules()) {
            return [];
        }
        if (self::decodeGameType($this->innovationGameState->get('game_type')) == 'team') {
            return [];
        }
        $player_ids = self::getActivePlayerIdsInTurnOrderStartingWithCurrentPlayer();
        if (count($player_ids) <= 3) {
            return [];
        }
        return array_slice($player_ids, 2, count($player_ids) - 3);
    }

    function getActivePlayerIdsInTurnOrderStartingWithCurrentPlayer() {
        $current_player_id = self::getCurrentPlayerUnderDogmaEffect();
        if ($current_player_id < 0) {
            // Pick an arbitrary player if it's not anyone's turn (e.g. initial meld)
            $current_player_no = 1;
        } else {
            $current_player_no = self::getUniqueValueFromDB(self::format("SELECT player_no FROM player WHERE player_id={current_player_id}", array('current_player_id' => $current_player_id)));
        }

        $players = self::getCollectionFromDB("SELECT player_no, player_id, player_eliminated FROM player");
        $num_players = count($players);

        $player_ids = [];
        for ($i = 0; $i < $num_players; $i++) {
            $current_no = (($current_player_no + $i - 1) % $num_players) + 1;
            if ($players[$current_no]['player_eliminated'] == 0) {
                $player_ids[] = $players[$current_no]['player_id'];
            }
        }
        return $player_ids;
    }

    /** Checks to see if any players are eligible for special achievements. **/
    function checkForSpecialAchievements() {
        // "In the rare case that two players simultaneously become eligible to claim a special achievement,
        // the tie is broken in turn order going clockwise, with the current player winning ties."
        // https://boardgamegeek.com/thread/2710666/simultaneous-special-achievements-tiebreaker
        foreach (self::getActivePlayerIdsInTurnOrderStartingWithCurrentPlayer() as $player_id) {
            self::checkForSpecialAchievementsForPlayer($player_id);
        }
    }
    
    /** Checks if the player meets the conditions to get a special achievement. Do the transfer if he does. **/
    function checkForSpecialAchievementsForPlayer($player_id) {
        // TODO(FIGURES): Update this once there are other special achievements to test for.
        $achievements_to_test = array(105, 106, 107, 108, 109);
        if ($this->innovationGameState->echoesExpansionEnabled()) {
            $achievements_to_test = array_merge($achievements_to_test, [435, 436, 437, 438, 439]);
        }
        $end_of_game = false;
        
        foreach ($achievements_to_test as $achievement_id) {
            $achievement = self::getCardInfo($achievement_id);

            // Check if it's already been claimed or if it's removed from the game.
            if ($achievement['owner'] != 0 || $achievement['location'] == 'removed') {
                continue;
            }
            
            switch ($achievement_id) {
            case 105: // Empire: three or more icons of all six types
                $eligible = true;
                $ressource_counts = self::getPlayerResourceCounts($player_id);
                foreach ($ressource_counts as $icon => $count) {
                    if ($count < 3) { // There are less than 3 icons
                        $eligible = false;
                        break;
                    }
                }
                break;
            case 106: // Monument: tuck 6 cards or score 6 cards
                $flags = self::getFlagsForMonument($player_id);
                $eligible = $flags['number_of_tucked_cards'] >= 6 || $flags['number_of_scored_cards'] >= 6;
                break;
            case 107: // Wonder: 5 colors, each being splayed right or up
                $eligible = true;
                for($color = 0; $color < 5 ; $color++) {
                    // TODO(4E#978): Possibly update this.
                    if (self::getCurrentSplayDirection($player_id, $color) < 2) { // This color is missing, unsplayed or splayed left
                        $eligible = false;
                        break;
                    };
                }
                break;
            case 108: // World: 12 or more visible clocks (icon 6) on the board 
                $eligible = self::getPlayerSingleRessourceCount($player_id, 6) >= 12;
                break;
            case 109: // Universe: Five top cards, each being of value 8 or more
                $eligible = true;
                for($color = 0; $color < 5 ; $color++) {
                    $top_card = self::getTopCardOnBoard($player_id, $color);
                    if ($top_card === null || $top_card['age'] < 8) { // This color is missing or its top card has value less than 8
                        $eligible = false;
                        break;
                    }
                }
                break;
                                
            case 435: // Wealth: A total of 8 or more visible bonus icons
                $eligible = count(self::getVisibleBonusesOnBoard($player_id)) >= 8;
                break;
            case 436: // Destiny: A total of 7 or more cards in forecast
                $eligible = self::countCardsInLocation($player_id, 'forecast') >= 7;
                break;
            case 437: // Heritage: 8 or more visible hexagons in a pile
                $eligible = false;
                for ($color = 0; $color < 5 ; $color++) {
                    if (self::countVisibleIconsInPile($player_id, 0 /* empty hex */, $color) >= 8) {
                        $eligible = true;
                        break;
                    }
                }
                break;
            case 438: // History: A total of 4 or more visible echo effects in a pile
                $eligible = false;
                for ($color = 0; $color < 5 ; $color++) {
                    if (self::countVisibleIconsInPile($player_id, 10 /* echo effect */, $color) >= 4) {
                        $eligible = true;
                        break;
                    }
                }
                break;
            case 439: // Supremacy: 4 different piles have at least 3 of the same icon
                $eligible = false;
                for ($icon = 1; $icon <= 7 && !$eligible; $icon++) {
                    $num_piles = 0;
                    for ($color = 0; $color < 5; $color++) {
                        if (self::countVisibleIconsInPile($player_id, $icon, $color) >= 3) {
                            $num_piles = $num_piles + 1;
                            if ($num_piles >= 4) {
                                $eligible = true; // 4 piles found
                                break;
                            }
                        }
                    }
                }
                break;
                
            default:
                break;
            }
            
            if ($eligible) { // The player meet the conditions to achieve
                try {
                    self::transferCardFromTo($achievement, $player_id, 'achievements');
                }
                catch (EndOfGame $e) { // End of game has been detected
                    self::trace('EOG bubbled but suspended from self::checkForSpecialAchievementsForPlayer');
                    $end_of_game = true;
                    continue; // But the other achievements must be checked as well before ending
                }
            }
        }
        // All special achievements have been checked
        if ($end_of_game) { // End of game has been detected
            self::trace('EOG bubbled from self::checkForSpecialAchievementsForPlayer');
            throw $e; // Re-throw the flag
        }
    }

    /** Checks to see if any players gain or lose any flag/fountain achievements. **/
    function updateFlagsAndFountains() {
        if (!$this->innovationGameState->citiesExpansionEnabled()) {
            return;
        }

        $end_of_game = false;

        foreach (self::getActivePlayerIdsInTurnOrderStartingWithCurrentPlayer() as $player_id) {
            $opponent_ids = self::getActiveOpponentIds($player_id);
            for ($color = 0; $color < 5 ; $color++) {
                // Flags
                $num_visible_flags = self::countVisibleIconsInPile($player_id, 8 /* flag */, $color);
                $num_visible_cards = self::countVisibleCards($player_id, $color);
                $opponent_has_more_visible_cards = false;
                foreach ($opponent_ids as $opponent_id) {
                    if (self::countVisibleCards($opponent_id, $color) > $num_visible_cards) {
                        $opponent_has_more_visible_cards = true;
                    }
                }
                $desired_flag_achievements = $opponent_has_more_visible_cards ? 0 : $num_visible_flags;
                $current_flag_achievements = self::getUniqueValueFromDB(self::format("
                    SELECT COUNT(*) FROM card WHERE owner = {owner} AND location = 'achievements' AND color = {color} AND 1000 <= id AND id <= 1099",
                    array('owner' => $player_id, 'color' => $color)
                ));
                for ($i = $current_flag_achievements; $i < $desired_flag_achievements; $i++) {
                    $flag_id = self::getUniqueValueFromDB(self::format("
                        SELECT MIN(id) FROM card WHERE owner = 0 AND location = 'flags' AND color = {color} AND 1000 <= id AND id <= 1099",
                        array('color' => $color)
                    ));
                    try {
                        self::transferCardFromTo(self::getCardInfo($flag_id), $player_id, 'achievements');
                    } catch (EndOfGame $e) {
                        $end_of_game = true;
                    }
                }
                for ($i = $desired_flag_achievements; $i < $current_flag_achievements; $i++) {
                    $flag_id = self::getUniqueValueFromDB(self::format("
                        SELECT MIN(id) FROM card WHERE owner = {owner} AND location = 'achievements' AND color = {color} AND 1000 <= id AND id <= 1099",
                        array('owner' => $player_id, 'color' => $color)
                    ));
                    self::transferCardFromTo(self::getCardInfo($flag_id), 0, 'flags');
                }

                // Fountains
                $desired_fountain_achievements = self::countVisibleIconsInPile($player_id, 9 /* fountain */, $color);
                $current_fountain_achievements = self::getUniqueValueFromDB(self::format("
                    SELECT COUNT(*) FROM card WHERE owner = {owner} AND location = 'achievements' AND color = {color} AND id >= 1100",
                    array('owner' => $player_id, 'color' => $color)
                ));
                for ($i = $current_fountain_achievements; $i < $desired_fountain_achievements; $i++) {
                    $fountain_id = self::getUniqueValueFromDB(self::format("
                        SELECT MIN(id) FROM card WHERE owner = 0 AND location = 'fountains' AND color = {color} AND id >= 1100",
                        array('color' => $color)
                    ));
                    try {
                        self::transferCardFromTo(self::getCardInfo($fountain_id), $player_id, 'achievements');
                    } catch (EndOfGame $e) {
                        $end_of_game = true;
                    }
                }
                for ($i = $desired_fountain_achievements; $i < $current_fountain_achievements; $i++) {
                    $fountain_id = self::getUniqueValueFromDB(self::format("
                        SELECT MIN(id) FROM card WHERE owner = {owner} AND location = 'achievements' AND color = {color} AND id >= 1100",
                        array('owner' => $player_id, 'color' => $color)
                    ));
                    self::transferCardFromTo(self::getCardInfo($fountain_id), 0, 'fountains');
                }
            }
        }

        if ($end_of_game) { // End of game has been detected
            self::trace('EOG bubbled from self::updateFlagsAndFountains');
            throw $e; // Re-throw the flag
        }
    }
    
    /** Database management for Monument special achievement **/
    function incrementFlagForMonument($player_id, $column_name) { // The player tucked or scored a card. Update database accordingly
        self::DbQuery(self::format("
            UPDATE
                player
            SET
                {column_name} = {column_name} + 1
            WHERE
                player_id = {player_id}
        ",
            array('player_id' => $player_id, 'column_name' => $column_name)
        ));
    }
    
    function resetFlagsForMonument() { // The turn of the current player has ended. Set the numbers of tuck cards and scored cards back to zero for all players 
        self::notifyAll('resetMonumentCounters', '', array());
        self::DbQuery("
            UPDATE
                player
            SET
                number_of_tucked_cards = 0,
                number_of_scored_cards = 0
        ");
    }
    
    function getFlagsForMonument($player_id) { // Query the number of cards the player tucked or scored so far during the turn of the current player
        return self::getObjectFromDB(self::format("
            SELECT
                number_of_tucked_cards, number_of_scored_cards
            FROM
                player
            WHERE
                player_id = {player_id}
        ",
            array('player_id' => $player_id)
        ));
    }
    
    function notifyForSplay($player_id, $target_player_id, $color, $splay_direction, $force_unsplay) {

        $new_score = self::updatePlayerScore($target_player_id);

        if ($splay_direction == 0 && !$force_unsplay) { // Unsplay event
            $color_in_clear = self::getColorInClear($color);

            if ($player_id != $target_player_id) {
                throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => "notifyForSplay()", 'code' => 'player_id != target_player_id in unsplay event')));
            }

            self::notifyPlayer($target_player_id, 'splayedPile', clienttranslate('${Your} ${colored} stack is reduced to one card so it loses its splay.'), array(
                'i18n' => array('colored'),
                'Your' => 'Your',
                'colored' => $color_in_clear,
                'player_id' => $target_player_id,
                'color' => $color,
                'splay_direction' => $splay_direction,
                'new_score' => $new_score,
            ));
            
            self::notifyAllPlayersBut($target_player_id, 'splayedPile', clienttranslate('${player_name}\'s ${colored} stack is reduced to one card so it loses its splay.'), array(
                'i18n' => array('colored'),
                'player_name' => self::getPlayerNameFromId($target_player_id),
                'colored' => $color_in_clear,
                'player_id' => $target_player_id,
                'color' => $color,
                'splay_direction' => $splay_direction,
                'new_score' => $new_score,
            ));
            return;
        }
        
        // $splay_direction > 0: actual splay or forced unsplay
        $splay_direction_in_clear = self::getSplayDirectionInClear($splay_direction);
        $colored_cards = self::getColorInClearWithCards($color);
        
        // Update player ressources
        $new_ressource_counts = self::updatePlayerRessourceCounts($target_player_id);
        
        if ($player_id == $target_player_id) {

            self::notifyPlayer($player_id, 'splayedPile', $force_unsplay ? clienttranslate('${You} unsplay your ${colored_cards}.') : clienttranslate('${You} splay your ${colored_cards} ${splay_direction_in_clear}.'), array(
                'i18n' => array('colored_cards', 'splay_direction_in_clear'),
                'player_id' => $player_id,
                'You' => 'You',
                'color' => $color,
                'colored_cards' => $colored_cards,
                'splay_direction' => $splay_direction,
                'splay_direction_in_clear' => $splay_direction_in_clear,
                'new_ressource_counts' => $new_ressource_counts,
                'forced_unsplay' => $force_unsplay,
                'new_score' => $new_score,
            ));
            
            self::notifyAllPlayersBut($player_id, 'splayedPile', $force_unsplay ? clienttranslate('${player_name} unsplays his ${colored_cards}.') : clienttranslate('${player_name} splays his ${colored_cards} ${splay_direction_in_clear}.'), array(
                'i18n' => array('colored_cards', 'splay_direction_in_clear'),
                'player_id' => $player_id,
                'player_name' => self::getPlayerNameFromId($player_id),
                'color' => $color,
                'colored_cards' => $colored_cards,
                'splay_direction' => $splay_direction,
                'splay_direction_in_clear' => $splay_direction_in_clear,
                'new_ressource_counts' => $new_ressource_counts,
                'forced_unsplay' => $force_unsplay,
                'new_score' => $new_score,
            ));

        } else {

            self::notifyPlayer($player_id, 'splayedPile', $force_unsplay ? clienttranslate('${You} unsplay ${target_player_name}\'s ${colored_cards}.') : clienttranslate('${You} splay ${target_player_name}\'s ${colored_cards} ${splay_direction_in_clear}.'), array(
                'i18n' => array('colored_cards', 'splay_direction_in_clear'),
                'player_id' => $target_player_id,
                'You' => 'You',
                'target_player_name' => self::getPlayerNameFromId($target_player_id),
                'color' => $color,
                'colored_cards' => $colored_cards,
                'splay_direction' => $splay_direction,
                'splay_direction_in_clear' => $splay_direction_in_clear,
                'new_ressource_counts' => $new_ressource_counts,
                'forced_unsplay' => $force_unsplay,
                'new_score' => $new_score,
            ));

            self::notifyPlayer($target_player_id, 'splayedPile', $force_unsplay ? clienttranslate('${player_name} unsplays your ${colored_cards}.') : clienttranslate('${player_name} splays your ${colored_cards} ${splay_direction_in_clear}.'), array(
                'i18n' => array('colored_cards', 'splay_direction_in_clear'),
                'player_id' => $target_player_id,
                'player_name' => self::getPlayerNameFromId($player_id),
                'color' => $color,
                'colored_cards' => $colored_cards,
                'splay_direction' => $splay_direction,
                'splay_direction_in_clear' => $splay_direction_in_clear,
                'new_ressource_counts' => $new_ressource_counts,
                'forced_unsplay' => $force_unsplay,
                'new_score' => $new_score,
            ));
            
            self::notifyAllPlayersBut(array($player_id, $target_player_id), 'splayedPile', $force_unsplay ? clienttranslate('${player_name} unsplays ${target_player_name}\'s ${colored_cards}.') : clienttranslate('${player_name} splays ${target_player_name}\'s ${colored_cards} ${splay_direction_in_clear}.'), array(
                'i18n' => array('colored_cards', 'splay_direction_in_clear'),
                'player_id' => $target_player_id,
                'player_name' => self::getPlayerNameFromId($player_id),
                'target_player_name' => self::getPlayerNameFromId($target_player_id),
                'color' => $color,
                'colored_cards' => $colored_cards,
                'splay_direction' => $splay_direction,
                'splay_direction_in_clear' => $splay_direction_in_clear,
                'new_ressource_counts' => $new_ressource_counts,
                'forced_unsplay' => $force_unsplay,
                'new_score' => $new_score,
            ));

        }
    }
    
    /** Notify end of game **/
    function notifyEndOfGameByAchievements() {
        // Display who won and with how many achievements
        // (There can be weird cases when two players tie or one player get more achievements than needed if two or more special achievements are claimed at the same time)
        $players = self::getCollectionFromDb("SELECT player_id, player_score FROM player");
        $number_of_achievements_needed_to_win = $this->innovationGameState->get('number_of_achievements_needed_to_win');
        $number_of_achievements_winner = $number_of_achievements_needed_to_win;
        $winners = array();
        
        foreach($players as $player_id => $player) {
            if ($player['player_score'] == $number_of_achievements_winner) {
                $winners[] = $player_id;
            } else if ($player['player_score'] > $number_of_achievements_winner) {
                $number_of_achievements_winner = $player['player_score'];
                $winners = array($player_id);
            }
        }
        
        foreach ($winners as $player_id) {
            if (self::decodeGameType($this->innovationGameState->get('game_type')) == 'individual') {
                self::notifyAllPlayersBut($player_id, "log", clienttranslate('END OF GAME BY ACHIEVEMENTS: ${player_name} has got ${n} achievements. He wins!'), array(
                    'n' => $number_of_achievements_winner,
                    'player_name' => self::getPlayerNameFromId($player_id)
                ));
                
                self::notifyPlayer($player_id, "log", clienttranslate('END OF GAME BY ACHIEVEMENTS: ${You} have got ${n} achievements. You win!'), array(
                    'n' => $number_of_achievements_winner,
                    'You' => 'You'
                ));
            } else { // Team game
                $teammate_id = self::getPlayerTeammate($player_id);
                $winning_team = array($player_id, $teammate_id);
                self::notifyAllPlayersBut($winning_team, "log", clienttranslate('END OF GAME BY ACHIEVEMENTS: The other team has got ${n} achievements. They win!'), array(
                    'n' => $number_of_achievements_winner
                ));
                
                foreach($winning_team as $player_id) {
                    self::notifyPlayer($player_id, "log", clienttranslate('END OF GAME BY ACHIEVEMENTS: Your team has got ${n} achievements. You win!'), array(
                        'n' => $number_of_achievements_winner
                    ));
                }
            }
        }
    }
    
    function notifyEndOfGameByScore() {
        $player_id = $this->innovationGameState->get('player_who_could_not_draw');
        $max_age = self::getMaxAge();
        if (self::decodeGameType($this->innovationGameState->get('game_type')) == 'individual') {
            self::notifyAllPlayersBut($player_id, "log", clienttranslate('END OF GAME BY SCORE: ${player_name} attempts to draw a card above ${age_10}. The player with the greatest score win.'), array(
                'player_name' => self::getPlayerNameFromId($player_id),
                'age_10' => $max_age
            ));
            
            self::notifyPlayer($player_id, "log", clienttranslate('END OF GAME BY SCORE: ${You} attempt to draw a card above ${age_10}. The player with the greatest score win.'), array(
                'You' => 'You',
                'age_10' => $max_age
            ));
        } else { // Team play
            self::notifyAllPlayersBut($player_id, "log", clienttranslate('END OF GAME BY SCORE: ${player_name} attempts to draw a card above ${age_10}. The team with the greatest combined score win.'), array(
                'player_name' => self::getPlayerNameFromId($player_id),
                'age_10' => $max_age
            ));
            
            self::notifyPlayer($player_id, "log", clienttranslate('END OF GAME BY SCORE: ${You} attempt to draw a card above ${age_10}. The team with the greatest combined score win.'), array(
                'You' => 'You',
                'age_10' => $max_age
            ));
        }
    }
    
    function notifyEndOfGameByDogma() {
        $player_id = $this->innovationGameState->get('winner_by_dogma');
        $dogma_card_id = self::getCurrentNestedCardState()['card_id'];

        if (self::decodeGameType($this->innovationGameState->get('game_type')) == 'individual') {
            if ($dogma_card_id == 207 /* Exxon Valdez */ || $dogma_card_id == 445 /* Space Traffic */) {
                self::notifyAllPlayersBut($player_id, "log", clienttranslate('END OF GAME BY DOGMA: ${player_name} is the only remaining player. He wins!'), array(
                    'player_name' => self::getPlayerNameFromId($player_id)
                ));
                self::notifyPlayer($player_id, "log", clienttranslate('END OF GAME BY DOGMA: You are the only remaining player. You win!'), array());
            } else {
                self::notifyAllPlayersBut($player_id, "log", clienttranslate('END OF GAME BY DOGMA: ${player_name} meets the victory condition. He wins!'), array(
                    'player_name' => self::getPlayerNameFromId($player_id)
                ));
                self::notifyPlayer($player_id, "log", clienttranslate('END OF GAME BY DOGMA: You meet the victory condition. You win!'), array());
            }
        } else { // Team play
            $teammate_id = self::getPlayerTeammate($player_id);
            $winning_team = array($player_id, $teammate_id);
            
            if ($dogma_card_id == 207 /* Exxon Valdez */ || $dogma_card_id == 445 /* Space Traffic */) {
                self::notifyAllPlayersBut($winning_team, "log", clienttranslate('END OF GAME BY DOGMA: The other team is the only remaining team. They win!'), array());
                self::notifyPlayer($player_id, "log", clienttranslate('END OF GAME BY DOGMA: You are the only remaining team. You win!'), array());
                self::notifyPlayer($teammate_id, "log", clienttranslate('END OF GAME BY DOGMA: You are the only remaining team. You win!'), array());
            } else if ($dogma_card_id == 100 /* Self service*/ || $dogma_card_id == 101 /* Globalization */) {
                self::notifyAllPlayersBut($winning_team, "log", clienttranslate('END OF GAME BY DOGMA: The other team meets the victory condition. They win!'), array());
                self::notifyPlayer($player_id, "log", clienttranslate('END OF GAME BY DOGMA: Your team meets the victory condition. You win!'), array());
                self::notifyPlayer($teammate_id, "log", clienttranslate('END OF GAME BY DOGMA: Your team meets the victory condition. You win!'), array());
            } else {
                self::notifyAllPlayersBut($winning_team, "log", clienttranslate('END OF GAME BY DOGMA: ${player_name} meets the victory condition. The other team wins!'), array(
                    'player_name' => self::getPlayerNameFromId($player_id)
                ));
                self::notifyPlayer($player_id, "log", clienttranslate('END OF GAME BY DOGMA: You meet the victory condition. Your team wins!'), array());
                self::notifyPlayer($teammate_id, "log", clienttranslate('END OF GAME BY DOGMA: ${player_name} meets the victory condition. Your team wins!'), array(
                    'player_name' => self::getPlayerNameFromId($player_id)
                ));
            }
        }
    }
    
    /** Notify general info **/
    function notifyGeneralInfo($message, $args = array()) {
        $delimiters = self::getDelimiterMeanings($message);
        self::notifyAll('log', $message, array_merge($args, $delimiters));
    }
    
    /** This function should be called whenever something changes in the game **/
    function recordThatChangeOccurred() {
        
        $nested_card_state = self::getCurrentNestedCardState();
        if ($nested_card_state == null) {
            return;
        }
        $current_effect_type = $nested_card_state['current_effect_type'];
        $current_player_under_dogma_effect = $nested_card_state['current_player_id'];

        // Tell all currently executing "The Big Bang" cards that the game state has changed.
        self::DbQuery("UPDATE nested_card_execution SET auxiliary_value = 1 WHERE card_id = 203");
        
        // Mark that the player under effect made a change in the game
        self::markExecutingPlayer($current_player_under_dogma_effect);
        
        if ($this->innovationGameState->get('sharing_bonus') != 0) { // The sharing bonus is already on
            return;
        }
        
        // A sharing bonus is triggered if an opponent was affected by a non-demand or echo effect
        $player_who_launched_the_dogma = $this->innovationGameState->get('active_player');
        if (($current_effect_type == 1 || $current_effect_type == 3) && $current_player_under_dogma_effect <> $player_who_launched_the_dogma && self::getPlayerTeammate($current_player_under_dogma_effect) <> $player_who_launched_the_dogma) {
            $this->innovationGameState->set('sharing_bonus', 1);
        }
    }
    
    // This function is used to mark a player when he executed a dogma card effect with true consequences
    function markExecutingPlayer($player_id) {
        self::DbQuery(self::format("
            UPDATE
                player
            SET
                effects_had_impact = TRUE
            WHERE
                player_id = {player_id}
        ", 
            array('player_id' => $player_id)
        ));
    }
    
    function resetPlayerTable() {
        self::DbQuery("
            UPDATE
                player
            SET
                featured_icon_count = NULL,
                effects_had_impact = FALSE
        ");
    }
    
    /** Notification system for dogma **/
    function getIconSquare($icon) {
        switch ($icon) {
        case 0:
            $title='';
            break;
        case 1:
            $title=clienttranslate('crown');
            break;
        case 2:
            $title=clienttranslate('leaf');
            break;
        case 3:
            $title=clienttranslate('light bulb');
            break;
        case 4:
            $title=clienttranslate('tower');
            break;
        case 5:
            $title=clienttranslate('factory');
            break;
        case 6:
            $title=clienttranslate('clock');
            break;
        case 7:
            $title=clienttranslate('avatar');
            break;
        }
        
        return self::format("<span title='{title}' class='square N icon_{icon}'></span>", array('icon' => $icon, 'title' => $title));
    }
    
    function getAgeSquare($age) {
        return self::format("<span title='{age}' class='square N age age_{age}'>{age}</span>", array('age' => $age));
    }

    function getAgeSquareWithType($age, $type) {
        return self::format("<span title='{age}' class='square N age age_{age} type_{type}'>{age}</span>", array('age' => $age, 'type' => $type));
    }

    function getMusicNoteIcon() {
        return "<span title='music note' class='square N music_note'></span>";
    }

    function notifyDogma($card) {
        $player_id = self::getActivePlayerId();
        $card_id = $card['id'];
        
        if ($this->innovationGameState->get('current_nesting_index') == -1 && $this->innovationGameState->get('endorse_action_state') == 2) {
            $message_for_player = clienttranslate('${You} endorse the dogma of ${card} with ${[}${icon}${]} as the featured icon.');
            $message_for_others = clienttranslate('${player_name} endorses the dogma of ${card} with ${[}${icon}${]} as the featured icon.');
            self::incStat(1, 'endorse_actions_number', $player_id);
        } else {
            $message_for_player = clienttranslate('${You} activate the dogma of ${card} with ${[}${icon}${]} as the featured icon.');
            $message_for_others = clienttranslate('${player_name} activates the dogma of ${card} with ${[}${icon}${]} as the featured icon.');
        }

        $delimiters_for_player = self::getDelimiterMeanings($message_for_player, $card_id);
        $delimiters_for_others = self::getDelimiterMeanings($message_for_others, $card_id);
        
        $card_arg = ['card_ids' => [$card_id], 'card' => self::getNotificationArgsForCardList(array($card))];
        self::notifyPlayer($player_id, 'logWithCardTooltips', $message_for_player, array_merge($card_arg, $delimiters_for_player, array(
            'You' => 'You',
            'icon' => $card['dogma_icon'],
        )));
        self::notifyAllPlayersBut($player_id, 'logWithCardTooltips', $message_for_others, array_merge($card_arg, $delimiters_for_others, array(
            'player_name' => self::getPlayerNameFromId($player_id),
            'icon' => $card['dogma_icon'],
        ))); 
    }
    
    function notifyEffectOnPlayer($qualified_effect, $player_id, $launcher_id) {
        if (self::isExecutingAgainDueToEndorsedAction()) {
            self::notifyPlayer($player_id, 'log', clienttranslate('<span class="minor_information">${You} have to execute the ${qualified_effect} again because it was endorsed.</span>'), array(
                'i18n' => array('qualified_effect'),
                'You' => 'You',
                'qualified_effect' => $qualified_effect
            ));
            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('<span class="minor_information">${player_name} has to execute the ${qualified_effect} again because it was endorsed.</span>'), array(
                'i18n' => array('qualified_effect'),
                'player_name' => self::getPlayerNameFromId($player_id),
                'qualified_effect' => $qualified_effect
            ));
        } else {
            self::notifyPlayer($player_id, 'log', clienttranslate('<span class="minor_information">${You} have to execute the ${qualified_effect}.</span>'), array(
                'i18n' => array('qualified_effect'),
                'You' => 'You',
                'qualified_effect' => $qualified_effect
            ));
            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('<span class="minor_information">${player_name} has to execute the ${qualified_effect}.</span>'), array(
                'i18n' => array('qualified_effect'),
                'player_name' => self::getPlayerNameFromId($player_id),
                'qualified_effect' => $qualified_effect
            ));
        }
    }
    
    function notifyPass($player_id) {
        self::notifyPlayer($player_id, 'log', clienttranslate('${You} pass.'), array(
            'You' => 'You'            
        ));
        
        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} passes.'), array(
            'player_name' => self::getPlayerNameFromId($player_id)
        ));
    }
    
    function notifyNoSelectableCards() {
        if ($this->innovationGameState->get('splay_direction') == -1) {
            if ($this->innovationGameState->get('n') == 0) {
                $message = clienttranslate("No card matches the criteria of the effect.");
            }
            else {
                $message = clienttranslate("No more card matches the criteria of the effect.");
            }
        } else {
            $message = clienttranslate("No stack matches the criteria of the effect for splaying.");
        }
        self::notifyGeneralInfo($message);
    }
    
    function notifyPlayerRessourceCount($player_id, $dogma_icon, $ressource_count) {
        $icon = "<span class='square N icon_" . $dogma_icon . "'></span>";

        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${ressource_count} ${icon}.'), array(
            'You' => 'You',
            'ressource_count' => $ressource_count,
            'icon' => $icon
        ));
        
        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${ressource_count} ${icon}.'), array(
            'player_name' => self::getPlayerNameFromId($player_id),
            'ressource_count' => $ressource_count,
            'icon' => $icon
        )); 
    }
    
    function notifyDogmaWithNoEffect($player_id, $dogma_icon) {
        $icon = "<span class='square N icon_" . $dogma_icon . "'></span>";
        
        self::notifyPlayer($player_id, 'log', clienttranslate('This card has only an I demand effect but nobody has fewer ${icon} than ${you}. Nothing happens.'), array(
            'you' => 'you',
            'icon' => $icon
        ));
        
        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('This card has only an I demand effect but nobody has fewer ${icon} than ${player_name}. Nothing happens.'), array(
            'player_name' => self::getPlayerNameFromId($player_id),
            'icon' => $icon
        )); 
    }
    
    /** Information about cards **/
    function getCardInfo($id) {
        /**
            Get all information from the database about the card indicated by its id, which includes:
                -intrisic properties,
                -owner, location and position
        **/
        if ($id < 0) {
            return null;
        }
        return self::getNonEmptyObjectFromDB(self::format("SELECT * FROM card WHERE id = {id}", array('id' => $id)));
    }

    function getStaticInfoOfAllCards() {
        /**
            Get all static information about all cards in the database.
        **/
        $cards = self::getObjectListFromDB("SELECT id, type, age, faceup_age, color, spot_1, spot_2, spot_3, spot_4, spot_5, spot_6, dogma_icon, is_relic FROM card");
        return self::attachTextualInfoToList($cards);
    }
    
    function getCardInfoFromPosition($owner, $location, $age, $type, $is_relic, $position) {
        /**
            Get all information from the database about the card indicated by its position
        **/
        return self::getObjectFromDB(self::format("
                SELECT * FROM card WHERE
                    owner = {owner}
                    AND location = '{location}'
                    AND age = {age}
                    AND type = {type}
                    AND is_relic = {is_relic}
                    AND position = {position}
            ",
                array('owner' => $owner, 'location' => $location, 'age' => $age, 'type' => $type, 'is_relic' => $is_relic, 'position' => $position)
        ));
    }

    function getCardIds($cards) {
        $card_ids = array();
        foreach ($cards as $card) {
            $card_ids[] = $card['id'];
        }
        return $card_ids;
    }

    function getCardName($id) {
        if ($id >= 1000) { // Flags and fountains
            return null;
        }
        return $this->textual_card_infos[$id]['name'];
    }

    function getNonDemandEffect($id, $effect_number) {
        return self::getCurrentVersionOfEffect('non_demand_effect_'.$effect_number, $id);
    }

    function getDemandEffect($id) {
        return self::getCurrentVersionOfEffect('i_demand_effect_1', $id);
    }

    function isCompelEffect($id) {
        return array_key_exists('i_demand_effect_1_is_compel', $this->textual_card_infos[$id]);
    }

    function getEchoEffect($id) {
        if (array_key_exists('echo_effect_1', $this->textual_card_infos[$id])) {
            return $this->textual_card_infos[$id]['echo_effect_1'];
        }
        return null;
    }

    function getCurrentVersionOfEffect($prefix, $id) {
        $card_info = $this->textual_card_infos[$id];
        $edition = $this->innovationGameState->getEdition();
        if (array_key_exists($prefix, $card_info)) {
            return $card_info[$prefix];
        }
        if ($edition == 1 && array_key_exists($prefix . '_first', $card_info)) {
            return $card_info[$prefix . '_first'];
        }
        if ($edition <= 3 && array_key_exists($prefix . '_first_and_third', $card_info)) {
            return $card_info[$prefix . '_first_and_third'];
        }
        if ($edition == 3 && array_key_exists($prefix . '_third', $card_info)) {
            return $card_info[$prefix . '_third'];
        }
        if ($edition >= 3 && array_key_exists($prefix . '_third_and_fourth', $card_info)) {
            return $card_info[$prefix . '_third_and_fourth'];
        }
        if ($edition == 4 && array_key_exists($prefix . '_fourth', $card_info)) {
            return $card_info[$prefix . '_fourth'];
        }
        return null;
    }
    
    function attachTextualInfo($card) {
        if ($card === null) {
            return null;
        }

        if (!array_key_exists($card['id'], $this->textual_card_infos)) {
            return $card;
        }
        
        $id = $card['id'];
        $textual_infos = $this->textual_card_infos[$id];

        // Make sure the demand effect reflects the current edition
        $textual_infos['i_demand_effect_1'] = self::getDemandEffect($id);
        if ($textual_infos['i_demand_effect_1'] === null) {
            unset($textual_infos['i_demand_effect_1']);
        }
        unset($textual_infos['i_demand_effect_1_first']);
        unset($textual_infos['i_demand_effect_1_first_and_third']);
        unset($textual_infos['i_demand_effect_1_third']);
        unset($textual_infos['i_demand_effect_1_third_and_fourth']);
        unset($textual_infos['i_demand_effect_1_fourth']);

        // Make sure the non-demand effects reflects the current edition
        for ($i = 1; $i <= 3; $i++) {
            $non_demand = 'non_demand_effect_' . $i;
            $textual_infos[$non_demand] = self::getNonDemandEffect($id, $i);
            if ($textual_infos[$non_demand] === null) {
                unset($textual_infos[$non_demand]);
            }
            unset($textual_infos[$non_demand . '_first']);
            unset($textual_infos[$non_demand . '_first_and_third']);
            unset($textual_infos[$non_demand . '_third']);
            unset($textual_infos[$non_demand . '_third_and_fourth']);
            unset($textual_infos[$non_demand . '_fourth']);
        }
        return array_merge($card, $textual_infos);
    }
    
    function attachTextualInfoToList($card_list) {
        foreach($card_list as &$card) {
            $card = self::attachTextualInfo($card);
        }
        return $card_list;
    }

    /**
     * Returns true if card_1 comes before card_2 in English alphabetical order.
     *
     * @param array $card1
     * @param array $card2
     * @return bool
     */
    public function comesAlphabeticallyBefore($card1, $card2) : bool
    {
        $name1 = $this->getCardName($card1['id']);
        $name2 = $this->getCardName($card2['id']);
        return Strings::doesStringComeBefore($name1, $name2);
    }
    
    function getColorsOfRepeatedValueOfTopCardsOnBoard($player_id) {
        /**
            Returns an array of all colors whose top card's value matches the value of another top card on that player's board .
        **/

        $colors = array();
        $top_cards = self::getTopCardsOnBoard($player_id);
            
        foreach ($top_cards as $card_1) {
            $top_age = $card_1['faceup_age'];
            foreach ($top_cards as $card_2) {
                if ($card_1['id'] != $card_2['id'] && $card_2['faceup_age'] == $top_age) {
                    $colors[] = $card_1['color'];
                    continue 2;
                }
            }
        }
        
        return $colors;
    }

    function getDeckTopCard($age, $type) {
        /**
            Get all information of the card to be drawn from the deck of the type and age indicated, which includes:
                -intrisic properties,
                -owner, location and position
        **/
        
        return self::getObjectFromDB(self::format("
            SELECT
                *
            FROM
                card
            WHERE
                location = 'deck' AND
                type = {type} AND
                age = {age} AND
                position = (SELECT MAX(position) FROM card WHERE location = 'deck' AND type = {type} AND age = {age})
        ",
            array('type' => $type, 'age' => $age)
        ));
    }

    function getDeckBottomCard($age, $type) {
        /**
            Get all information of the card to be taken from the bottom of the deck of the type and age indicated, which includes:
                -intrisic properties,
                -owner, location and position
        **/
        
        return self::getObjectFromDB(self::format("
            SELECT
                *
            FROM
                card
            WHERE
                location = 'deck' AND
                type = {type} AND
                age = {age} AND
                position = 0
        ",
            array('type' => $type, 'age' => $age)
        ));
    }
    
    function getAgeToDrawIn($player_id, $age_min=null) {
        if($age_min === null){
            // $age_min is the maximum age on player board
            $age_min = self::getMaxAgeOnBoardTopCards($player_id);
        }
        if ($age_min < 1) {
            $age_min = 1;
        }
    
        $deck_count = self::countCardsInLocationKeyedByAge(0, 'deck', /*type=*/ 0);
        $age_to_draw = $age_min;
        $max_age = self::getMaxAge();
        while ($age_to_draw <= $max_age && $deck_count[$age_to_draw] == 0) {
            $age_to_draw++;
        }
        return $age_to_draw;
    }
    
    function getCurrentSplayDirection($player_id, $color) {
        $splay_direction = self::getUniqueValueFromDB(self::format("
            SELECT
                splay_direction
            FROM
                card
            WHERE
                owner = {owner} AND
                location = 'board' AND
                color = {color} AND
                position = 0
        ",
            array('owner' => $player_id, 'color' => $color)
       ));
        
        return $splay_direction !== null ? $splay_direction : 0 /* No card => unsplayed */;
    }
    
    function getIdsOfCardsInLocation($owner, $location) {
        /**
            Get all cards in a particular location, sorted by position
        **/
        
        return self::getObjectListFromDB(self::format("
                SELECT
                    id
                FROM
                    card
                WHERE
                    owner = {owner} AND
                    location = '{location}'
                ORDER BY
                    position
            ",
                array('owner' => $owner, 'location' => $location)
        ), true);
    }
    
    function getIdsOfHighestOrLowestCardsInLocation($owner, $location, $highest) {
        /**
            Get all highest or lowest cards in a particular location, sorted by position
        **/
        
        return self::getObjectListFromDB(self::format("
                SELECT
                    id
                FROM
                    card
                WHERE
                    owner = {owner} AND
                    location = '{location}' AND
                    age = (
                        SELECT
                            {min_or_max}(age)
                        FROM
                            card
                        WHERE
                            owner = {owner} AND
                            location = '{location}'
                    )
                ORDER BY
                    position
            ",
                array('owner' => $owner, 'location' => $location, 'min_or_max' => $highest ? 'MAX' : 'MIN')
        ), true);
    }
    
    function getIdsOfHighestCardsInLocation($owner, $location) {
        /**
            Get all highest cards in a particular location, sorted by position
        **/
        return self::getIdsOfHighestOrLowestCardsInLocation($owner, $location, true);
    }
    
    function getIdsOfLowestCardsInLocation($owner, $location) {
        /**
            Get all highest cards in a particular location, sorted by position
        **/
        return self::getIdsOfHighestOrLowestCardsInLocation($owner, $location, false);
    }

    function getSizeOfMaxVisiblePileOnBoard($owner) {
        /**
            Return the size of the stack(s) which have maximum number of visible cards on a specific player's board 
        **/
        return self::getUniqueValueFromDB(self::format("
            SELECT
                COALESCE(MAX(CASE WHEN splay_direction = 0 THEN 1 ELSE position + 1 END), 0)
            FROM
                card
            WHERE
                owner = {owner} AND
                location = 'board'
        ",
            array('owner' => $owner)
       ));
    }

    
    
    function getOrCountCardsInLocation($count, $owner, $location, $key = null, $type = null, $is_relic = null) {
        /**
            Get ($count is false) or count ($count is true) all the cards in a particular location, sorted by position. The result can be first keyed by age (for deck or hand) or color (for board) if needed
        **/
        
        $type_of_result = $count ? "COUNT(*)" : "*";
        $opt_order_by = $count ? "" : "ORDER BY position";
        $getFromDB = $count ? 'getUniqueValueFromDB' : 'getObjectListFromDB'; // If we count, we want to get an unique value, else, we want to get a list of cards
        $type_condition = $type === null ? "" : self::format("type = {type} AND", array('type' => $type));
        $is_relic_condition = $is_relic === null ? "" : self::format("is_relic = {is_relic} AND", array('is_relic' => ($is_relic ? 'TRUE' : 'FALSE')));

        if ($owner == -2) { // any player
            $owner_condition = "owner != 0 AND";
        } else if ($owner == -3) { // any opponent
            $opponent_ids = self::getActiveOpponentIds(self::getActivePlayerId());
            $owner_condition = self::format("owner IN ({owners}) AND", array('owners' => join($opponent_ids, ',')));
        } else if ($owner == -4) { // any other player
            $owner_condition = self::format("owner != 0 AND owner != {player_id} AND", array('player_id' => self::getActivePlayerId()));
        } else {
            $owner_condition = self::format("owner = {owner} AND", array('owner' => $owner));
        }

        if ($key == 'age') {
            $num_min = 1;
            $num_max = 11;
        } else if ($key == 'color') {
            $num_min = 0;
            $num_max = 4;
        } else {
            return self::$getFromDB(self::format("
                SELECT
                    {type_of_result}
                FROM
                    card
                WHERE
                    {type_condition}
                    {is_relic_condition}
                    {owner_condition}
                    location = '{location}'
                {opt_order_by}
            ",
                array('type_of_result' => $type_of_result, 'type_condition' => $type_condition, 'is_relic_condition' => $is_relic_condition, 'owner_condition' => $owner_condition, 'location' => $location, 'opt_order_by' => $opt_order_by)
            ));
        }
        
        $result = array();
        
        for ($value = $num_min; $value <= $num_max; $value++) {
            $result[$value] = self::$getFromDB(self::format("
                SELECT
                    {type_of_result}
                FROM
                    card
                WHERE
                    {type_condition}
                    {is_relic_condition}
                    {owner_condition}
                    location = '{location}' AND
                    {key} = {value}
                {opt_order_by}
            ",
                array('type_of_result' => $type_of_result, 'type_condition' => $type_condition, 'is_relic_condition' => $is_relic_condition, 'owner_condition' => $owner_condition, 'location' => $location, 'key' => $key, 'value' => $value, 'opt_order_by' => $opt_order_by)
           ));
        }
        return $result;
    }

    function getArtifactsOnDisplay($players) {
        $result = array();
        foreach($players as $player_id => $player) {
            $result[$player_id] = self::getArtifactOnDisplay($player_id);
        }
        return $result;
    }

    function getArtifactOnDisplay($player_id) {
        $cards = self::getCardsInLocation($player_id, 'display');
        if (empty($cards)) {
            return null;
        }
        return $cards[0];
    }
    
    function getBoards($player_ids) {
        $result = array();
        foreach ($player_ids as $player_id) {
            $result[$player_id] = self::getCardsInLocationKeyedByColor($player_id, 'board');
        }
        return $result;
    }

    function isTopBoardCard($card) {
        if ($card['position'] == null || $card['location'] != 'board') {
            return false;
        }
        $number_of_cards_above = self::getUniqueValueFromDB(self::format("
                SELECT
                    COUNT(*)
                FROM
                    card
                WHERE
                    owner = {owner} AND
                    location = 'board' AND
                    color = {color} AND
                    position > {position}",
                array('owner' => $card['owner'], 'color' => $card['color'], 'position' => $card['position'])
        ));
        return $number_of_cards_above == 0;
    }
    
    function hasThisColorOnBoard($player_id, $color) {
        $number_of_cards = self::getUniqueValueFromDB(self::format("
                SELECT
                    COUNT(*)
                FROM
                    card
                WHERE
                    owner = {owner} AND
                    location = 'board' AND
                    color = {color}",
                array('owner' => $player_id, 'color' => $color)
        ));
        return $number_of_cards > 0;
    }

    function getCardsInLocationKeyedByAge($owner, $location) {
        /**
            Get all the cards in a particular location, keyed by age, then sorted by position.
        **/
        return self::getOrCountCardsInLocation(/*count=*/ false, $owner, $location, 'age');
    }

    function getCardsInLocationKeyedByColor($owner, $location) {
        /**
            Get all the cards in a particular location, keyed by color, then sorted by position.
        **/
        return self::getOrCountCardsInLocation(/*count=*/ false, $owner, $location, 'color');
    }
    
    function getCardsInLocation($owner, $location) {
        /**
            Get all the cards in a particular location, sorted by position.
        **/
        return self::getOrCountCardsInLocation(/*count=*/ false, $owner, $location);
    }

    function getCardsInHand($player_id) {
        return self::getCardsInLocation($player_id, 'hand');
    }

    function countCardsInHand($player_id) {
        return self::countCardsInLocation($player_id, 'hand');
    }

    function getCardsInScorePile($player_id) {
        return self::getCardsInLocation($player_id, 'score');
    }

    function countCardsInLocationKeyedByAge($owner, $location, $type=null, $is_relic=null) {
        /**
            Count all the cards in a particular location, keyed by age.
        **/
        return self::getOrCountCardsInLocation(/*count=*/ true, $owner, $location, 'age', $type, $is_relic);
    }

    function countCardsInLocationKeyedByColor($owner, $location) {
        /**
            Count all the cards in a particular location, keyed by color.
        **/
        return self::getOrCountCardsInLocation(/*count=*/ true, $owner, $location, 'color');
    }
    
    function countCardsInLocation($owner, $location, $type=null) {
        /**
            Count all the cards in a particular location.
        **/
        return self::getOrCountCardsInLocation(/*count=*/ true, $owner, $location, /*key=*/ null, $type);
    }
    
    function getTopCardOnBoard($player_id, $color) {
        /**
        Get the top card of specified color
        (null if the player have no card on his board)
        **/
        return self::getObjectFromDB(self::format("
                SELECT
                    *
                FROM
                    card
                WHERE
                    card.owner = {player_id} AND
                    card.location = 'board' AND
                    card.color = {color} AND
                    card.position = (
                        SELECT
                            MAX(position) AS position
                        FROM
                            card
                        WHERE
                            owner = {player_id} AND
                            location = 'board' AND
                            color = {color}
                    )
        ",
            array('player_id' => $player_id, 'color' => $color)
        ));
    }


function getOwnersOfTopCardWithColorAndAge($color, $age) {
    /**
    Returns the IDs of all players with a top card of the specified color and age
    **/
    return self::getObjectListFromDB(self::format("
            SELECT
                a.owner
            FROM
                card AS a
            LEFT JOIN
                (SELECT
                    owner, MAX(position) AS position
                FROM
                    card
                WHERE
                    color = {color} AND
                    location = 'board'
                GROUP BY
                    owner) AS b ON a.owner = b.owner
            WHERE
                a.owner != 0 AND
                a.location = 'board' AND
                a.color = {color} AND
                a.age = {age} AND
                a.position = b.position
        ",
        array('color' => $color, 'age' => $age)
    ), true);
}

    // TODO(ARTIACTS): Most call sites assume the player has at least one top card on their board. I think this is a
    // safe assumption (since you can't execute a non-demand unless you have at least 1 icon on your board) but it
    // would be better to handle the null case explicitly, especially if this is added to a demand effect sometime.
    function getTopCardsOnBoard($player_id) {
        /**
        Get all of the top cards on a player board, or null if the player has no cards on his board
        **/
        return self::getCollectionFromDb(self::format("
                SELECT
                    *
                FROM
                    card AS a
                LEFT JOIN
                    (SELECT
                        color, MAX(position) AS position
                    FROM
                        card
                    WHERE
                        owner = {player_id} AND
                        location = 'board'
                    GROUP BY
                        color) AS b ON a.color = b.color
                WHERE
                    a.owner = {player_id} AND
                    a.location = 'board' AND
                    a.position = b.position
        ",
            array('player_id' => $player_id)
        ));
    }
    
    function getIfTopCardOnBoard($id) {
        /**
        Returns the card if card is a top card on a board, or null if it isn't present as a top card
        **/
        return self::getObjectFromDB(self::format("
            SELECT
                *
            FROM
                card AS a
            LEFT JOIN
                (SELECT
                    owner, color, MAX(position) AS position
                FROM
                    card
                WHERE
                    location = 'board'
                GROUP BY
                    owner, color) AS b ON a.owner = b.owner AND a.color = b.color
            WHERE
                a.id = {id} AND
                a.location = 'board' AND
                a.position = b.position
            ",
            array('id' => $id)
        ));
    }
    
    function getBottomCardOnBoard($player_id, $color) {
        /**
        Get the bottom card of specified color
        (null if the player have no card on his board)
        **/
        return self::getObjectFromDB(self::format("
                SELECT
                    *
                FROM
                    card
                WHERE
                    card.owner = {player_id} AND
                    card.location = 'board' AND
                    card.color = {color} AND
                    card.position = 0
        ",
            array('player_id' => $player_id, 'color' => $color)
        ));
    }

    function getSplayableColorsOnBoard($player_id, $splay_direction) {
        /**
        Returns the splayable colors in the specified direction on a player's board, in ascending order
        **/
        return self::getObjectListFromDB(self::format("
            SELECT
                color
            FROM
                card
            WHERE
                owner = {player_id} AND
                location = 'board' AND
                position = 1 AND
                splay_direction != {splay_direction}
            ORDER BY
                color
            ",
            array('player_id' => $player_id, 'splay_direction' => $splay_direction)
        ), true);
    }

    function getMinAgeOnBoardTopCards($player_id) {
        /**
        Get the age the player is in, that is to say, the minimum age that can be found on his board top cards
        (0 if the player have no card on his board)
        **/
        
        // Get the min of the age matching the position defined in the sub-request
        return self::getUniqueValueFromDB(self::format("
            SELECT
                COALESCE(MIN(a.faceup_age), 0)
            FROM
                card AS a
            LEFT JOIN
                (SELECT
                    color, MAX(position) AS position
                FROM
                    card
                WHERE
                    owner = {player_id} AND
                    location = 'board'
                GROUP BY
                    color) AS b ON a.color = b.color
            WHERE
                a.owner = {player_id} AND
                a.location = 'board' AND
                a.position = b.position
        ",
            array('player_id' => $player_id)
       ));
    }

    function getMaxAgeOnBoardTopCards($player_id) {
        /**
        Get the age the player is in, that is to say, the maximum age that can be found on his board top cards
        (0 if the player have no card on his board)
        **/
        
        // Get the max of the age matching the position defined in the sub-request
        return self::getUniqueValueFromDB(self::format("
            SELECT
                COALESCE(MAX(a.faceup_age), 0)
            FROM
                card AS a
            LEFT JOIN
                (SELECT
                    color, MAX(position) AS position
                FROM
                    card
                WHERE
                    owner = {player_id} AND
                    location = 'board'
                GROUP BY
                    color) AS b ON a.color = b.color
            WHERE
                a.owner = {player_id} AND
                a.location = 'board' AND
                a.position = b.position
        ",
            array('player_id' => $player_id)
       ));
    }
    
    function getMaxAgeOfTopCardOfColor($color) {
        /**
        Get the maximum age that can be found on top of any player's pile of a specific color
        (0 if no players have that color on their board)
        **/
        
        // Get the max of the age matching the position defined in the sub-request
        return self::getUniqueValueFromDB(self::format("
            SELECT
                COALESCE(MAX(a.faceup_age), 0)
            FROM
                card AS a
            LEFT JOIN
                (SELECT
                    owner, MAX(position) AS position
                FROM
                    card
                WHERE
                    color = {color} AND
                    location = 'board'
                GROUP BY
                    owner) AS b ON a.owner = b.owner
            WHERE
                a.owner != 0 AND
                a.location = 'board' AND
                a.color = {color} AND
                a.position = b.position
        ",
            array('color' => $color)
       ));
    }
    
    function getMinAgeOnBoardTopCardsWithIcon($player_id, $icon) {
        /**
        Get the minimum age of the top cards with a particular icon
        (0 if the player have no card on his board)
        **/
        
        
        // Get the max of the age matching the position defined in the sub-request
        return self::getUniqueValueFromDB(self::format("
            SELECT
                COALESCE(MIN(a.faceup_age), 0)
            FROM
                card AS a
            LEFT JOIN
                (SELECT
                    color, MAX(position) AS position
                FROM
                    card
                WHERE
                    owner = {player_id} AND
                    location = 'board'
                GROUP BY
                    color) AS b ON a.color = b.color
            WHERE
                a.owner = {player_id} AND
                a.location = 'board' AND
                a.position = b.position AND
                (a.spot_1 = {icon} OR a.spot_2 = {icon} OR a.spot_3 = {icon} OR a.spot_4 = {icon})
        ",
            array('player_id' => $player_id, 'icon' => $icon)
        ));
    }

    function getMaxAgeOnBoardTopCardsWithIcon($player_id, $icon) {
        /**
        Get the maximum age of the top cards with a particular icon
        (0 if the player have no card on his board)
        **/
        
        
        // Get the max of the age matching the position defined in the sub-request
        return self::getUniqueValueFromDB(self::format("
            SELECT
                COALESCE(MAX(a.faceup_age), 0)
            FROM
                card AS a
            LEFT JOIN
                (SELECT
                    color, MAX(position) AS position
                FROM
                    card
                WHERE
                    owner = {player_id} AND
                    location = 'board'
                GROUP BY
                    color) AS b ON a.color = b.color
            WHERE
                a.owner = {player_id} AND
                a.location = 'board' AND
                a.position = b.position AND
                (a.spot_1 = {icon} OR a.spot_2 = {icon} OR a.spot_3 = {icon} OR a.spot_4 = {icon})
        ",
            array('player_id' => $player_id, 'icon' => $icon)
        ));
    }
    
    function getMaxAgeOnBoardOfColorsWithoutIcon($player_id, $colors, $icon) {
        /**
        Get the maximum age of the top cards without a particular icon
        (0 if the player have no card on his board)
        **/
        
        // Get the max of the age matching the position defined in the sub-request
        return self::getUniqueValueFromDB(self::format("
            SELECT
                COALESCE(MAX(a.faceup_age), 0)
            FROM
                card AS a
            LEFT JOIN
                (SELECT
                    color, MAX(position) AS position
                FROM
                    card
                WHERE
                    owner = {player_id} AND
                    location = 'board'
                GROUP BY
                    color) AS b ON a.color = b.color
            WHERE
                a.owner = {player_id} AND
                a.location = 'board' AND
                a.position = b.position AND
                a.color IN ({colors}) AND
                a.spot_1 <> {icon} AND a.spot_2 <> {icon} AND a.spot_3 <> {icon} AND a.spot_4 <> {icon}
        ",
            array('player_id' => $player_id, 'colors' => join($colors, ','), 'icon' => $icon)
        ));
    }
    
    function getMinOrMaxAgeInLocation($player_id, $location, $min_or_max) {
        /**
        Get the minimum or maximum age that can be found in a player particular location
        (0 if the player have no card in this location)
        **/
        
        return self::getUniqueValueFromDB(self::format("
            SELECT
                COALESCE({min_or_max}(age), 0)
            FROM
                card AS a
            WHERE
                owner = {player_id} AND
                location = '{location}'
        ",
            array('min_or_max' => $min_or_max, 'player_id' => $player_id, 'location' => $location)
        ));
    }
    
    function getMinAgeInHand($player_id) {
        /**
        Get the minimum age that can be found in a player hand
        (0 if the player have no card in his hand)
        **/
        return self::getMinOrMaxAgeInLocation($player_id, 'hand', 'MIN');
    }
    
    function getMaxAgeInHand($player_id) {
        /**
        Get the maximum age that can be found in a player hand
        (0 if the player have no card in his hand)
        **/
        return self::getMinOrMaxAgeInLocation($player_id, 'hand', 'MAX');
    }
    
    function getMinAgeInScore($player_id) {
        /**
        Get the minimum age that can be found in a player score
        (0 if the player have no card in his score pile)
        **/
        return self::getMinOrMaxAgeInLocation($player_id, 'score', 'MIN');
    }
    
    function getMaxAgeInScore($player_id) {
        /**
        Get the maximum age that can be found in a player score
        (0 if the player have no card in his score pile)
        **/
        return self::getMinOrMaxAgeInLocation($player_id, 'score', 'MAX');
    }
    
    function getMaxBonusIconOnBoard($player_id) {
        /**
        Get the maximum visible bonus
        **/
        $visible_bonus_icons = self::getVisibleBonusesOnBoard($player_id);
        return count($visible_bonus_icons) == 0 ? 0 : max($visible_bonus_icons);
    }

    function getCardsWithVisibleEchoEffects($dogma_card) {
        /**
        Gets the list of cards with visible echo effects given a specific card being executed (from top to bottom)
        **/

        $color = $dogma_card['color'];
        $pile = self::getCardsInLocationKeyedByColor($dogma_card['owner'], 'board')[$color];

        $visible_echo_effects = array();

        // Handle the case when the card being executed isn't even in the pile (e.g. Artifact on display)
        if ($dogma_card['location'] != 'board') {
            if (self::countIconsOnCard($dogma_card, 10 /* echo effect */) > 0) {
                $visible_echo_effects[] = $dogma_card['id'];
            }
        }

        for ($i = count($pile) - 1; $i >= 0; $i--) {
            $card = $pile[$i];
            $splay_direction = $card['splay_direction'];

            $has_visible_echo_efffect = false;
            if ($i == count($pile) - 1 && self::countIconsOnCard($card, 10 /* echo effect */) > 0) {
                $has_visible_echo_efffect = true;
            } else if ($splay_direction == 1) { // left
                $has_visible_echo_efffect = $card['spot_4'] == 10 || $card['spot_5'] == 10;
            } else if ($splay_direction == 2) { // right
                $has_visible_echo_efffect = $card['spot_1'] == 10 || $card['spot_2'] == 10;
            } else if ($splay_direction == 3) { // up
                $has_visible_echo_efffect = $card['spot_2'] == 10 || $card['spot_3'] == 10 || $card['spot_4'] == 10;
            } else if ($splay_direction == 4) { // aslant
                $has_visible_echo_efffect = $card['spot_1'] == 10 || $card['spot_2'] == 10 || $card['spot_3'] == 10 || $card['spot_4'] == 10;
            }

            if ($has_visible_echo_efffect) {
                $visible_echo_effects[] = $card['id'];
            }

            // Skip covered up cards
            if ($card['location'] == 'board' && $splay_direction == 0) {
                break;
            }    
        }

        return $visible_echo_effects;
    }
    
    function getVisibleBonusesOnPile($player_id, $color) {
        /**
        Gets the list of bonus icons visible on a specific pile
        **/
        $visible_bonus_icons = array();
        
        $board = self::getCardsInLocationKeyedByColor($player_id, 'board');
        $pile = $board[$color];
        if (count($pile) == 0) { // No card of that color
            return $visible_bonus_icons;
        }
        $top_card = $pile[count($pile)-1];
        $visible_bonus_icons = self::getBonusIcons($top_card);
        
        $splay_direction = $top_card['splay_direction'];
        if ($splay_direction == 0) { // Unsplayed
            return $visible_bonus_icons;
        }
        // Since the stack is not unsplayed, it has at least two cards
        for($i=0; $i<count($pile)-1; $i++) {
            $card = $pile[$i];
            if($splay_direction == 1) { // left
                if ($card['spot_4'] >= 101 && $card['spot_4'] <= 111)
                {
                    $visible_bonus_icons[] = $card['spot_4'] - 100;
                }
                if ($card['spot_5'] >= 101 && $card['spot_5'] <= 111) {
                    $visible_bonus_icons[] = $card['spot_5'] - 100;
                }
            }
            elseif ($splay_direction == 2) { // right
                if ($card['spot_1'] >= 101 && $card['spot_1'] <= 111) {
                    $visible_bonus_icons[] = $card['spot_1'] - 100;
                }
                if ($card['spot_2'] >= 101 && $card['spot_2'] <= 111) {
                    $visible_bonus_icons[] = $card['spot_2'] - 100;
                }
            }
            elseif ($splay_direction == 3) { // up
                if ($card['spot_2'] >= 101 && $card['spot_2'] <= 111) {
                    $visible_bonus_icons[] = $card['spot_2'] - 100;
                }
                if ($card['spot_3'] >= 101 && $card['spot_3'] <= 111) {
                    $visible_bonus_icons[] = $card['spot_3'] - 100;
                }
                if ($card['spot_4'] >= 101 && $card['spot_4'] <= 111) {
                    $visible_bonus_icons[] = $card['spot_4'] - 100;
                }
            }
            elseif ($splay_direction == 4) { // aslant
                if ($card['spot_1'] >= 101 && $card['spot_1'] <= 111) {
                    $visible_bonus_icons[] = $card['spot_1'] - 100;
                }
                if ($card['spot_2'] >= 101 && $card['spot_2'] <= 111) {
                    $visible_bonus_icons[] = $card['spot_2'] - 100;
                }
                if ($card['spot_3'] >= 101 && $card['spot_3'] <= 111) {
                    $visible_bonus_icons[] = $card['spot_3'] - 100;
                }
                if ($card['spot_4'] >= 101 && $card['spot_4'] <= 111) {
                    $visible_bonus_icons[] = $card['spot_4'] - 100;
                }
            }
        }
        return $visible_bonus_icons;
    }

    
    function getVisibleBonusesOnBoard($player_id) {
        $visible_bonus_icons = array();
        
        for ($color = 0; $color < 5; $color++) {
            $visible_bonus_icons = array_merge($visible_bonus_icons, self::getVisibleBonusesOnPile($player_id, $color));
        }
        return $visible_bonus_icons;
    }

    function getBonusIcons($card) {
        $bonus_icons = array();
        if ($card !== null) {
            if ($card['spot_1'] >= 101 && $card['spot_1'] <= 111) {
                $bonus_icons[] = $card['spot_1'] - 100;
            }
            if ($card['spot_2'] >= 101 && $card['spot_2'] <= 111) {
                $bonus_icons[] = $card['spot_2'] - 100;
            }
            if ($card['spot_3'] >= 101 && $card['spot_3'] <= 111) {
                $bonus_icons[] = $card['spot_3'] - 100;
            }
            if ($card['spot_4'] >= 101 && $card['spot_4'] <= 111) {
                $bonus_icons[] = $card['spot_4'] - 100;
            }            
            if ($card['spot_5'] >= 101 && $card['spot_5'] <= 111) {
                $bonus_icons[] = $card['spot_5'] - 100;
            }
            if ($card['spot_6'] >= 101 && $card['spot_6'] <= 111) {
                $bonus_icons[] = $card['spot_6'] - 100;
            }
        }
        return $bonus_icons;
    }
    
    /** Information about card resources **/
    function hasRessource($card, $icon) {
        return $card !== null && ($card['spot_1'] == $icon || $card['spot_2'] == $icon || $card['spot_3'] == $icon || $card['spot_4'] == $icon || $card['spot_5'] == $icon || $card['spot_6'] == $icon);
    }
    
    /* Count the number of a particular icon on the specified card */
    function countIconsOnCard($card, $icon) {
        $icon_count = 0;
        if ($card['spot_1'] !== null && $card['spot_1'] == $icon) {
            $icon_count++;
        }
        if ($card['spot_2'] !== null && $card['spot_2'] == $icon) {
            $icon_count++;
        }
        if ($card['spot_3'] !== null && $card['spot_3'] == $icon) {
            $icon_count++;
        }
        if ($card['spot_4'] !== null && $card['spot_4'] == $icon) {
            $icon_count++;
        }
        if ($card['spot_5'] !== null && $card['spot_5'] == $icon) {
            $icon_count++;
        }
        if ($card['spot_6'] !== null && $card['spot_6'] == $icon) {
            $icon_count++;
        }
        return $icon_count;
    }

    function boardPileHasRessource($player_id, $color, $icon) {
        $board = self::getCardsInLocationKeyedByColor($player_id, 'board');
        $pile = $board[$color];
        if (count($pile) == 0) { // No card of that color
            return false;
        }
        $top_card = $pile[count($pile)-1];
        if (self::hasRessource($top_card, $icon)) { // The top card of that stack has that icon
            return true;
        }
        $splay_direction = $top_card['splay_direction'];
        if ($splay_direction == 0) { // Unsplayed
            return false;
        }
        // Since the stack is not unsplayed, it has at least two cards
        for($i=0; $i<count($pile)-1; $i++) {
            $card = $pile[$i];
            if($splay_direction == 1 && ($card['spot_4'] == $icon || $card['spot_5'] == $icon) || 
                    $splay_direction == 2 && ($card['spot_1'] == $icon || $card['spot_2'] == $icon) || 
                    $splay_direction == 3 && ($card['spot_2'] == $icon || $card['spot_3'] == $icon || $card['spot_4'] == $icon) ||
                    $splay_direction == 4 && ($card['spot_1'] == $icon || $card['spot_2'] == $icon || $card['spot_3'] == $icon || $card['spot_4'] == $icon)) {
                return true;
            }
        }
        return false;
    }
    
    /** Counts the number of visible cards based on the splay **/
    function countVisibleCards($player_id, $color) {
        $board = self::getCardsInLocationKeyedByColor($player_id, 'board');
        $pile = $board[$color];
        $pile_size = count($pile);
        if ($pile_size == 0) { // No card of that color
            return 0;
        }
        $top_card = $pile[$pile_size - 1];
        if ($top_card['splay_direction'] == 0) { // Unsplayed
            return 1;
        }
        return $pile_size; // All other splays result in the current stack size
    }
    
    /** Get and update game situation **/
    function incrementBGAScore($player_id, $is_special_achievement) { // Increment the BGA score of the team (single player or to player in 2 vs 2 game) (number of achievements) then check if he got enough to win
        $player = self::getObjectFromDB(self::format(
            "SELECT
                player_score, player_team
            FROM
                player
            WHERE
                player_id={player_id}"
            ,
                array('player_id' => $player_id)));
        
        $player['player_score']++;
        
        self::DbQuery(self::format(
            "UPDATE
                player
            SET
                player_score = {player_score}
            WHERE
                player_team={player_team}"
            ,
                $player));
                
        // Stats
        self::incStat(1, 'achievements_number', $player_id);
        if ($is_special_achievement) {
            self::incStat(1, 'special_achievements_number', $player_id);
        }
        
        // Was it the last achievement needed for the player for winning?      
        if ($player['player_score'] >= $this->innovationGameState->get('number_of_achievements_needed_to_win')) {
            $this->innovationGameState->set('game_end_type', 0);
            self::trace('EOG bubbled from self::incrementBGAScore');
            throw new EndOfGame();
        }
    }
    
    /** Get and update game situation **/
    function decrementBGAScore($player_id) {
        $player = self::getObjectFromDB(self::format(
            "SELECT
                player_score, player_team
            FROM
                player
            WHERE
                player_id={player_id}"
            ,
                array('player_id' => $player_id)));
        
        $player['player_score']--;
        
        self::DbQuery(self::format(
            "UPDATE
                player
            SET
                player_score = {player_score}
            WHERE
                player_team={player_team}"
            ,
                $player));
                
        // Stats
        self::incStat(-1, 'achievements_number', $player_id);
    }

    function getPlayerScore($player_id) { // Player Innovation score is different from the BGA score (number of achievements)
        return self::getUniqueValueFromDB(self::format("
        SELECT
            player_innovation_score
        FROM
            player
        WHERE
            player_id = {player_id}
        ",
            array('player_id' => $player_id)
       ));
    }
    
    function getPlayerNumberOfAchievements($player_id) { // Player Innovation score is different from the BGA score (number of achievements)
        return self::getUniqueValueFromDB(self::format("
        SELECT
            player_score
        FROM
            player
        WHERE
            player_id = {player_id}
        ",
            array('player_id' => $player_id)
       ));
    }
    
    function updatePlayerScore($player_id) {
        $score = 0;
        foreach (self::getCardsInLocation($player_id, 'score') as $card) {
            $score += $card['age'];
        }
        $num_visible_bonus_icons = count(self::getVisibleBonusesOnBoard($player_id));
        if ($num_visible_bonus_icons > 0) {
            $score += self::getMaxBonusIconOnBoard($player_id) + $num_visible_bonus_icons - 1;
        }
        self::DBQuery(self::format("
            UPDATE
                player
            SET
                player_innovation_score = {score}
            WHERE
                player_id = {player_id}
        ",
            array('player_id' => $player_id, 'score' => $score)
        ));
        self::setStat($score, 'score', $player_id);
        return $score;
    }
    
    // Returns the icon count for a particular color on a player's board (also works for hexagon icons if icon=0)
    function countVisibleIconsInPile($player_id, $icon, $color) {
        $board = self::getCardsInLocationKeyedByColor($player_id, 'board');
        $pile = $board[$color];
        $pile_size = count($pile);

        // No card of the specified color
        if ($pile_size == 0) {
            return 0;
        }

        // Always count the icons on the top card
        $top_card = $pile[$pile_size - 1];
        $count = self::countIconsOnCard($top_card, $icon);

        // Determine splay direction
        $unsplayed = $top_card['splay_direction'] == 0;
        $splayed_left = $top_card['splay_direction'] == 1;
        $splayed_right = $top_card['splay_direction'] == 2;
        $splayed_up = $top_card['splay_direction'] == 3;
        $splayed_aslant = $top_card['splay_direction'] == 4;

        // If unsplayed, only return the count of the icons on the top card
        if ($unsplayed == 1) {
            return $count;
        }
        
        // Add icons of the other cards.
        for ($i = 0; $i < $pile_size - 1; $i++) {
            $card = $pile[$i];
            
            if ($splayed_right || $splayed_aslant) {
                if ($card['spot_1'] !== null && $card['spot_1'] == $icon) {
                    $count += 1;
                }
            }
            if ($splayed_right || $splayed_up) {
                if ($card['spot_2'] !== null && $card['spot_2'] == $icon) {
                    $count += 1;
                }
            }
            if ($splayed_up) {
                if ($card['spot_3'] !== null && $card['spot_3'] == $icon) {
                    $count += 1;
                }
            }
            if ($splayed_left || $splayed_up) {
                if ($card['spot_4'] !== null && $card['spot_4'] == $icon) {
                    $count += 1;
                }
            }
            if ($splayed_left) {
                if ($card['spot_5'] !== null && $card['spot_5'] == $icon) {
                    $count += 1;
                }
            }
        }
        return $count;
    }
    
    function getPlayerSingleRessourceCount($player_id, $icon) {
        return self::getUniqueValueFromDB(self::format("
            SELECT
                player_icon_count_{icon}
            FROM
                player
            WHERE
                player_id = {player_id}
        ",
            array('player_id' => $player_id, 'icon' => $icon)
        ));
    }
    
    function getPlayerResourceCounts($player_id) {
        $table = self::getNonEmptyObjectFromDB(self::format("
        SELECT
            player_icon_count_1, player_icon_count_2, player_icon_count_3, player_icon_count_4, player_icon_count_5, player_icon_count_6, player_icon_count_7
        FROM
            player
        WHERE
            player_id = {player_id}
        ",
            array('player_id' => $player_id)
        ));
        
        // Convert to a numeric associative array
        $result = array();
        for ($icon = 1; $icon <= 7; $icon++) {
            $result[$icon] = $table["player_icon_count_".$icon];
        }
        return $result;
    }
    
    function getPlayerWishForSplay($player_id) {
        return self::getUniqueValueFromDB(self::format("
        SELECT
            pile_display_mode
        FROM
            player
        WHERE
            player_id = {player_id}
        ",
            array('player_id' => $player_id)
       )) == 1;
    }
    
    function getPlayerWishForViewFull($player_id) {
        return self::getUniqueValueFromDB(self::format("
        SELECT
            pile_view_full
        FROM
            player
        WHERE
            player_id = {player_id}
        ",
            array('player_id' => $player_id)
       )) == 1;
    }
    
    function setPlayerWishForSplay($player_id, $pile_display_mode) {
        self::DbQuery(self::format("
        UPDATE
            player
        SET
            pile_display_mode = {pile_display_mode}
        WHERE
            player_id = {player_id}
        ",
            array('player_id' => $player_id, 'pile_display_mode' => $pile_display_mode ? "TRUE" : "FALSE")
        ));
    }
    
    function setPlayerWishForViewFull($player_id, $pile_view_full) {
        self::DbQuery(self::format("
        UPDATE
            player
        SET
            pile_view_full = {pile_view_full}
        WHERE
            player_id = {player_id}
        ",
            array('player_id' => $player_id, 'pile_view_full' => $pile_view_full ? "TRUE" : "FALSE")
        ));
    }
    
    function updatePlayerRessourceCounts($player_id) {     
        self::DbQuery("
            INSERT INTO
                base (icon)
            VALUES
                (1), (2), (3), (4), (5), (6), (7)
        ");
        
        self::DbQuery(self::format("
            INSERT INTO card_with_top_card_indication (id, type, age, color, spot_1, spot_2, spot_3, spot_4, spot_5, spot_6, dogma_icon, owner, location, position, splay_direction, selected, is_top_card)
                SELECT
                a.id, a.type, a.age, a.color, a.spot_1, a.spot_2, a.spot_3, a.spot_4, a.spot_5, a.spot_6, a.dogma_icon, a.owner, a.location, a.position, a.splay_direction, a.selected,
                    (a.position = b.position_of_top_card) AS is_top_card
                FROM
                    card AS a
                    LEFT JOIN (
                        SELECT 
                            color, MAX(position) AS position_of_top_card
                        FROM
                            card
                        WHERE
                            owner = {player_id} AND
                            location = 'board'
                        GROUP BY
                            color
                   ) AS b ON a.color = b.color
                WHERE
                    a.owner = {player_id} AND
                    a.location = 'board'
        ",
            array('player_id' => $player_id)
       ));
        
        self::DbQuery("
            INSERT INTO icon_count
                SELECT
                    a.icon,
                    COALESCE(s1.count, 0) + COALESCE(s2.count, 0) + COALESCE(s3.count, 0) + COALESCE(s4.count, 0) + COALESCE(s5.count, 0) + COALESCE(s6.count, 0) AS count
                FROM
                    base AS a
                    LEFT JOIN (SELECT spot_1, COUNT(spot_1) AS count FROM card_with_top_card_indication WHERE is_top_card IS TRUE OR splay_direction = 2 OR splay_direction = 4 GROUP BY spot_1) AS s1 ON a.icon = s1.spot_1
                    LEFT JOIN (SELECT spot_2, COUNT(spot_2) AS count FROM card_with_top_card_indication WHERE is_top_card IS TRUE OR splay_direction = 2 OR splay_direction = 3 OR splay_direction = 4 GROUP BY spot_2) AS s2 ON a.icon = s2.spot_2
                    LEFT JOIN (SELECT spot_3, COUNT(spot_3) AS count FROM card_with_top_card_indication WHERE is_top_card IS TRUE OR splay_direction = 3 OR splay_direction = 4 GROUP BY spot_3) AS s3 ON a.icon = s3.spot_3
                    LEFT JOIN (SELECT spot_4, COUNT(spot_4) AS count FROM card_with_top_card_indication WHERE is_top_card IS TRUE OR splay_direction = 1 OR splay_direction = 3 OR splay_direction = 4 GROUP BY spot_4) AS s4 ON a.icon = s4.spot_4
                    LEFT JOIN (SELECT spot_5, COUNT(spot_5) AS count FROM card_with_top_card_indication WHERE is_top_card IS TRUE OR splay_direction = 1 OR splay_direction = 3 GROUP BY spot_5) AS s5 ON a.icon = s5.spot_5
                    LEFT JOIN (SELECT spot_6, COUNT(spot_6) AS count FROM card_with_top_card_indication WHERE is_top_card IS TRUE GROUP BY spot_6) AS s6 ON a.icon = s6.spot_6
        ");
        
        self::DbQuery(self::format("
            UPDATE
                player AS a
                LEFT JOIN icon_count AS i1 ON TRUE
                LEFT JOIN icon_count AS i2 ON TRUE
                LEFT JOIN icon_count AS i3 ON TRUE
                LEFT JOIN icon_count AS i4 ON TRUE
                LEFT JOIN icon_count AS i5 ON TRUE
                LEFT JOIN icon_count AS i6 ON TRUE
                LEFT JOIN icon_count AS i7 ON TRUE
            SET
                a.player_icon_count_1 = i1.count,
                a.player_icon_count_2 = i2.count,
                a.player_icon_count_3 = i3.count,
                a.player_icon_count_4 = i4.count,
                a.player_icon_count_5 = i5.count,
                a.player_icon_count_6 = i6.count,
                a.player_icon_count_7 = i7.count
            WHERE
                a.player_id = {player_id} AND
                i1.icon = 1 AND
                i2.icon = 2 AND
                i3.icon = 3 AND
                i4.icon = 4 AND
                i5.icon = 5 AND
                i6.icon = 6 AND
                i7.icon = 7
        ",
            array('player_id' => $player_id)
        ));
        
        // Delete all values of the auxiliary tables
        self::DbQuery("DELETE FROM card_with_top_card_indication");
        self::DbQuery("DELETE FROM base");
        self::DbQuery("DELETE FROM icon_count");
        
        return self::getPlayerResourceCounts($player_id);
    }
    
    function promoteScoreToBGAScore() {
        // Called if the game ends by drawing. The innovation score is the main value to check to determine the winner and the number of achievements is used as a tie-breaker.
        
        // If team game, add the score of the teammate first
        if (self::decodeGameType($this->innovationGameState->get('game_type')) == 'team') {
            self::DbQuery("
            UPDATE
                player AS a
                LEFT JOIN (
                    SELECT
                        player_team, SUM(player_innovation_score) AS team_score
                    FROM
                        player
                    GROUP BY
                        player_team
                
                ) AS b ON a.player_team = b.player_team
            SET
                a.player_innovation_score = b.team_score
            ");
        }
        
        self::DbQuery("
        UPDATE
            player
        SET
            player_score_aux = player_score,
            player_score = player_innovation_score
        ");
    }
    
    function binarizeBGAScore() {
        // Called if the game ends by dogma. The innovation score is 1 for winners, 0 for losers. There is no tie-breaker.
        self::DbQuery(self::format("
        UPDATE
            player
        SET
            player_score_aux = 0,
            player_score = (CASE WHEN player_id = {winner} THEN 1 ELSE 0 END)
        ",
            array('winner' => $this->innovationGameState->get('winner_by_dogma'))        
        ));
        
        if (self::decodeGameType($this->innovationGameState->get('game_type')) == 'team') {
            // Add the score of the teammate 0 + 0 for losers, 0 + 1 for winners
            self::DbQuery("
            UPDATE
                player AS a
                LEFT JOIN (
                    SELECT
                        player_team, SUM(player_score) AS team_score
                    FROM
                        player
                    GROUP BY
                        player_team
                
                ) AS b ON a.player_team = b.player_team
            SET
                a.player_score = b.team_score
            ");
        }
    }
    
    /** Information about players **/
    function getPlayerNameFromId($player_id) {
        // TODO(LATER): Identify and fix the nested execution bug which makes this hack necessary.
        if ($player_id == -1 || $player_id == null) {
            return "unknown";
        }
        $players = self::loadPlayersBasicInfos();
        return $players[$player_id]['player_name'];
    }
    
    function getPlayerColorFromId($player_id) {
        // TODO(LATER): Identify and fix the nested execution bug which makes this hack necessary.
        if ($player_id == -1 || $player_id == null) {
            return "unknown";
        }
        $players = self::loadPlayersBasicInfos();
        return $players[$player_id]['player_color'];
    }
    
    function getPlayerTeam($player_id) {
        return self::getUniqueValueFromDB(self::format("
            SELECT
                player_id
            FROM
                player
            WHERE
                player_id={player_id}
        ",
            array('player_id' => $player_id)
        ));
    }

    function countNonEliminatedPlayers() {
        return self::getUniqueValueFromDB("
            SELECT
                COUNT(*)
            FROM
                player
            WHERE
                player_eliminated=0
        ");
    }
    
    function getPlayerTeammate($player_id) {
        /** Return the teammate in a team game or null if there is None **/
        return self::getUniqueValueFromDB(self::format("
            SELECT
                player_id
            FROM
                player
            WHERE
                player_id <> {player_id} AND
                player_team = (
                    SELECT
                        player_team
                    FROM
                        player
                    WHERE
                        player_id = {player_id}
                )
        ",
            array('player_id' => $player_id)
        ));
    }
    
    /** Information when in dogma **/
    function qualifyEffect($current_effect_type, $current_effect_number, $card) {
        $unique_non_demand_effect = self::getNonDemandEffect($card['id'], 2) === null;
        
        return $current_effect_type == 0 ? clienttranslate('I demand effect') :
               ($current_effect_type == 2 ? clienttranslate('I compel effect') :
               ($current_effect_type == 3 ? clienttranslate('echo effect') :
               ($unique_non_demand_effect ? clienttranslate('non-demand effect') :
               ($current_effect_number == 1 ? clienttranslate('1<sup>st</sup> non-demand effect') :
               ($current_effect_number == 2 ? clienttranslate('2<sup>nd</sup> non-demand effect') : clienttranslate('3<sup>rd</sup> non-demand effect'))))));
    }
                                  
    function getFirstPlayerUnderEffect($dogma_effect_type, $launcher_id) {
        return self::getNextPlayerUnderEffect($dogma_effect_type, -1, $launcher_id);
    }
       
    /* Returns the ID of the next player under effect, or null */
    function getNextPlayerUnderEffect($dogma_effect_type, $player_id, $launcher_id) {
        // I demand
        $launcher_icon_count = self::getUniqueValueFromDB(self::format("
            SELECT
                featured_icon_count
            FROM
                player
            WHERE
                player_id = {launcher_id}
        ",
            array('launcher_id' => $launcher_id)
        ));
        // I demand
        if ($dogma_effect_type == 0) {
            $player_query = self::format(
                "featured_icon_count < {launcher_icon_count} AND player_id != {launcher_id} AND player_team <> (SELECT player_team FROM player WHERE player_id = {launcher_id})",
                array('launcher_id' => $launcher_id, 'launcher_icon_count' => $launcher_icon_count)
            );
        // I compel
        } else if ($dogma_effect_type == 2) {
            $player_query = self::format(
                "featured_icon_count >= {launcher_icon_count} AND player_id != {launcher_id} AND player_team <> (SELECT player_team FROM player WHERE player_id = {launcher_id})",
                array('launcher_id' => $launcher_id, 'launcher_icon_count' => $launcher_icon_count)
            );
        // Non-demand
        } else {
            $player_query = self::format(
                "featured_icon_count >= {launcher_icon_count}",
                array('launcher_icon_count' => $launcher_icon_count)
            );
        }

        // NOTE: The constant '100' is mostly arbitrary. It just needed to be at least as large as the maximum number of players in the game.
        self::DbQuery(self::format("
            UPDATE
                player
            SET
                turn_order_ending_with_launcher = (CASE WHEN player_no <= {launcher_player_no} THEN player_no + 100 ELSE player_no END)
        ", array('launcher_player_no' => self::playerIdToPlayerNo($launcher_id))));
        $current_turn = $player_id == -1 ? -1 : self::getUniqueValueFromDB(self::format("SELECT turn_order_ending_with_launcher FROM player WHERE player_id = {player_id}", array('player_id' => $player_id)));
        return self::getUniqueValueFromDB(self::format("
            SELECT
                player_id
            FROM
                player
            WHERE
                turn_order_ending_with_launcher = (
                    SELECT
                        MIN(turn_order_ending_with_launcher)
                    FROM
                        player
                    WHERE
                        player_eliminated = 0
                        AND turn_order_ending_with_launcher > {current_turn}
                        AND {player_query}
                )
        ",
            array('player_query' => $player_query, 'current_turn' => $current_turn)
        ));
    }
    
    /** Representation in log and in main title text **/
    function getColorInClear($color) {
        switch($color) {
        case 0:
            return clienttranslate('blue');
        case 1:
            return clienttranslate('red');
        case 2:
            return clienttranslate('green');
        case 3:
            return clienttranslate('yellow');
        case 4:
            return clienttranslate('purple');
        }
    }
    
    function getColorInClearWithCards($color) {
        switch($color) {
        case 0:
            return clienttranslate('blue cards');
        case 1:
            return clienttranslate('red cards');
        case 2:
            return clienttranslate('green cards');
        case 3:
            return clienttranslate('yellow cards');
        case 4:
            return clienttranslate('purple cards');
        }
    }
    
    function getSplayDirectionInClear($splay_direction) {
        switch($splay_direction) {
        case 0:
            return clienttranslate('none');
        case 1:
            return clienttranslate('left');
        case 2:
            return clienttranslate('right');
        case 3:
            return clienttranslate('up');
        case 4:
            return clienttranslate('aslant');
        }
    }
    
    function getTranslatedNumber($number) {
        switch($number) {
        case 0:
            return clienttranslate('zero');
        case 1:
            return clienttranslate('one');
        case 2:
            return clienttranslate('two');
        case 3:
            return clienttranslate('three');
        case 4:
            return clienttranslate('four');
        case 5:
            return clienttranslate('five');
        case 6:
            return clienttranslate('six');
        case 7:
            return clienttranslate('seven');
        case 8:
            return clienttranslate('eight');
        case 9:
            return clienttranslate('nine');
        case 10:
            return clienttranslate('ten');
        default:
            return $number;
        }
    }
    
    function getPrintableStringForCardType($type) {
        switch($type) {
            case 0:
                return clienttranslate('Base');
            case 1:
                return clienttranslate('Artifacts');
            case 2:
                return clienttranslate('Cities');
            case 3:
                return clienttranslate('Echoes');
        }
    }
    
    function getColoredText($text, $player_id) {
        $color = self::getPlayerColorFromId($player_id);
        return "<span style='font-weight: bold; color:#".$color.";'>".$text."</span>";
    }

    function getColoredPlayerName($player_id) {
        return self::getColoredText(self::getPlayerNameFromId($player_id), $player_id);
    }
    
    /** Execution of actions authorized by server **/

    function executeDrawAndScore($player_id, $age_min = null) {
        return self::executeDraw($player_id, $age_min, 'score');
    }

    function executeDrawAndForeshadow($player_id, $age_min = null) {
        return self::executeDraw($player_id, $age_min, 'forecast');
    }

    function executeDrawAndReveal($player_id, $age_min = null) {
        return self::executeDraw($player_id, $age_min, 'revealed');
    }

    function executeDrawAndMeld($player_id, $age_min = null, $type = null) {
        return self::executeDraw($player_id, $age_min, 'board', /*bottom_to=*/ false, $type);
    }

    function executeDrawAndTuck($player_id, $age_min = null, $type = null) {
        return self::executeDraw($player_id, $age_min, 'board', /*bottom_to=*/ true, $type);
    }

    /* Execute a draw. If $age_min is null, draw in the deck according to the board of the player, else, draw a card of the specified value or more, according to the rules */
    function executeDraw($player_id, $age_min = null, $location_to = 'hand', $bottom_to = false, $type = null, $bottom_from = false) {
        $age_to_draw = self::getAgeToDrawIn($player_id, $age_min);
        
        $max_age = self::getMaxAge();
        if ($age_to_draw > $max_age) {
            // Attempt to draw a card above the max age : end of the game by score
            $this->innovationGameState->set('game_end_type', 1);
            $this->innovationGameState->setInitial('player_who_could_not_draw', $player_id);
            self::trace('EOG bubbled from self::executeDraw (age higher than highest deck age');
            throw new EndOfGame();
        }

        // "If an expansion’s supply pile has no cards in it, and you try to draw from it (after skipping empty ages),
        // draw a base card of that value instead."
        if ($type != null && self::countCardsInLocationKeyedByAge(0, 'deck', /*type=*/ $type)[$age_to_draw] == 0) {
            $type = null;
        }

        // If the type isn't specified, then we are either drawing a Base or Echoes card.
        if ($type === null) {
            $type = self::getCardTypeToDraw($age_to_draw, $player_id);
        }
        
        if ($bottom_from) {
            $card = self::getDeckBottomCard($age_to_draw, $type);
        } else {
            $card = self::getDeckTopCard($age_to_draw, $type);
        }

        try {
            $card = self::transferCardFromTo($card, $player_id, $location_to, $bottom_to, $location_to == 'score', $bottom_from);
        }
        catch (EndOfGame $e) {
            self::trace('EOG bubbled from self::executeDraw');
            throw $e; // Re-throw exception to higher level
        }

        if ($type == 2) {
            self::incStat(1, 'city_cards_drawn_number', $player_id);
        }

        return $card;
    }

    function getCardTypeToDraw($age_to_draw, $player_id) {
        $card_type = 0;
        // Draw an Echoes card if none is currently in hand and at least one other card is in hand (drawn and revealed counts as being in hand)
        if ($this->innovationGameState->echoesExpansionEnabled() &&
                (self::countCardsInLocation($player_id, 'hand') + self::countCardsInLocation($player_id, 'revealed')) > 0 &&
                self::countCardsInLocation($player_id, 'hand', /*type=*/ 3) == 0 && 
                self::countCardsInLocation($player_id, 'revealed', /*type=*/ 3) == 0) {
            $card_type = 3;
        }
        // If an expansion’s supply pile has no cards in it, and you try to draw from it (after skipping empty ages),
        // draw a base card of that value instead.
        if (self::getDeckTopCard($age_to_draw, $card_type) === null) {
            $card_type = 0;
        }
        return $card_type;
    }

    function getMaxAge() {
        return $this->innovationGameState->usingFourthEditionRules() ? 11 : 10;
    }

    function removeBaseDeck($age) {
        self::DbQuery(self::format("
            UPDATE
                card
            SET
                location = 'junk',
                position = NULL
            WHERE
                owner = 0
                AND location = 'deck'
                AND age = {age}
                AND type = 0
        ", ["age" => $age]));
        if (self::DbAffectedRow() > 0) {
            self::recordThatChangeOccurred();
        }
        self::notifyAll('removedBaseDeck', clienttranslate('All cards in the ${age} deck were junked.'),  array('age' => self::getAgeSquareWithType($age, /*type=*/ 0), 'age_to_junk' => $age));
    }
    
    function removeAllHandsBoardsAndScores() {
        self::DbQuery("
            UPDATE
                card
            SET
                owner = 0,
                location = 'removed',
                position = NULL
            WHERE
                location IN ('hand', 'board', 'score', 'revealed')
        ");
        
        // Set statistics back to zero
        self::DbQuery("
            UPDATE
                player
            SET
                player_innovation_score = 0,
                player_icon_count_1 = 0,
                player_icon_count_2 = 0,
                player_icon_count_3 = 0,
                player_icon_count_4 = 0,
                player_icon_count_5 = 0,
                player_icon_count_6 = 0
                player_icon_count_7 = 0
        ");
        
        // Stats
        $players = self::loadPlayersBasicInfos();
        foreach($players as $player_id => $player) {
            self::setStat(0, 'score', $player_id);
            self::setStat(0, 'max_age_on_board', $player_id);
        }

        try {
            self::updateFlagsAndFountains();
        } catch(EndOfGame $e) {
            self::trace('EOG bubbled from self::removeAllHandsBoardsAndScores');
            throw $e; // Re-throw exception to higher level
        }
    }

    function removeAllCardsFromPlayer($player_id) {
        // Even if no cards are removed we will still mark that change has occurred because a player has been eliminated.
        self::recordThatChangeOccurred();

        self::DbQuery(self::format("
            UPDATE
                card
            SET
                owner = 0,
                location = 'removed',
                position = NULL
            WHERE
                owner = {player_id}
        ", array('player_id' => $player_id)));

        self::DbQuery(self::format("
            UPDATE
                player
            SET
                player_score = 0,
                player_innovation_score = 0,
                player_icon_count_1 = 0,
                player_icon_count_2 = 0,
                player_icon_count_3 = 0,
                player_icon_count_4 = 0,
                player_icon_count_5 = 0,
                player_icon_count_6 = 0,
                player_icon_count_7 = 0
            WHERE
                player_id = {player_id}
        ", array('player_id' => $player_id)));

        self::setStat(0, 'achievements_number', $player_id);
        self::setStat(0, 'special_achievements_number', $player_id);
        self::setStat(0, 'score', $player_id);
        self::setStat(0, 'max_age_on_board', $player_id);

        self::notifyPlayer($player_id, 'removedPlayer', clienttranslate('All ${your} cards were removed from the game.'), array(
            'your' => 'your',
            'player_to_remove' => $player_id,
        ));
        self::notifyAllPlayersBut($player_id, 'removedPlayer', clienttranslate('All ${player_name}\'s cards were removed from the game.'), array(
            'player_name' => self::getColoredPlayerName($player_id),
            'player_to_remove' => $player_id,
        ));
    }

    function removeAllTopCardsAndHands() {
        // Remove cards from all players' hands.
        self::DbQuery("
            UPDATE
                card
            SET
                owner = 0,
                location = 'removed',
                position = NULL
            WHERE
                location = 'hand'
        ");
        if (self::DbAffectedRow() > 0) {
            self::recordThatChangeOccurred();
        }
        
        // Get list of the all top cards on the board.
        $top_cards_to_remove = array();
        $player_ids = self::getAllActivePlayerIds();
        foreach ($player_ids as $player_id) {
            $top_cards_to_remove = array_merge($top_cards_to_remove, self::getTopCardsOnBoard($player_id));
        }

        // Remove top cards from boards.
        self::DbQuery("
            UPDATE
                card
            LEFT JOIN
                (SELECT
                    owner, color, MAX(position) AS position
                FROM
                    card
                WHERE
                    location = 'board'
                GROUP BY
                    owner, color) AS b ON card.owner = b.owner AND card.color = b.color
            SET
                card.owner = 0,
                card.location = 'removed',
                card.position = NULL
            WHERE
                card.location = 'board' AND
                card.owner = b.owner AND
                card.color = b.color AND
                card.position = b.position
        ");
        if (self::DbAffectedRow() > 0) {
            self::recordThatChangeOccurred();
        }

        $new_resource_counts_by_player = array();
        $new_max_age_on_board_by_player = array();
        foreach ($player_ids as $player_id) {
            $new_resource_counts_by_player[$player_id] = self::updatePlayerRessourceCounts($player_id);
            $new_max_age_on_board = self::getMaxAgeOnBoardTopCards($player_id);
            $new_max_age_on_board_by_player[$player_id] = $new_max_age_on_board;
            self::setStat($new_max_age_on_board, 'max_age_on_board', $player_id);
        }
        self::notifyAll('removedTopCardsAndHands', clienttranslate('All top cards on all boards and all cards in all hands are removed from the game.'), array(
            'new_resource_counts_by_player' => $new_resource_counts_by_player,
            'new_max_age_on_board_by_player' => $new_max_age_on_board_by_player,
            'top_cards_to_remove' => $top_cards_to_remove,
        ));

        // Unsplay all stacks which only have one card left in them.
        foreach (self::getActivePlayerIdsInTurnOrderStartingWithCurrentPlayer() as $player_id) {
            $number_of_cards_per_pile = self::countCardsInLocationKeyedByColor($player_id, 'board');
            for ($color = 0; $color < 5; $color++) {
                if ($number_of_cards_per_pile[$color] == 1) {
                    self::splay($player_id, $player_id, $color, /*splay_direction=*/ 0);
                }
            }
        }

        $end_of_game = false;

        try {
            self::updateFlagsAndFountains();
        } catch(EndOfGame $e) {
            $end_of_game = true;
        }

        try {
            self::checkForSpecialAchievements();
        } catch(EndOfGame $e) {
            $end_of_game = true;
        }

        if ($end_of_game) {
            self::trace('EOG bubbled from self::removeAllTopCardsAndHands');
            throw $e; // Re-throw exception to higher level
        }
    }
    
    function setSelectionRange($options) {

        $rewritten_options = array();
        foreach ($options as $key => $value) {
            switch ($key) {
            case 'player_id':
                $player_id = $value;
                break;
            case 'owner_from':
                if ($value === 'any player') {
                    $value = -2;
                } else if ($value === 'any opponent') {
                    $value = -3;
                } else if ($value === 'any other player') {
                    $value = -4;
                }
                $rewritten_options['owner_from'] = $value;
                break;
            case 'n':
                $rewritten_options['n_min'] = $value;
                $rewritten_options['n_max'] = $value;
                break;
            case 'age':
                // TODO(LATER): Stop overloading the 'age' option and add a separate option for when we are passing an array.
                if (array_key_exists('choose_value', $options)) {
                    $rewritten_options[$key] = $value;
                } else {
                    $rewritten_options['age_min'] = $value;
                    $rewritten_options['age_max'] = $value;
                }
                break;
            default:
                $rewritten_options[$key] = $value;
                break;
            }
        }
        if (!array_key_exists('can_pass', $rewritten_options)) {
            $rewritten_options['can_pass'] = false;
        }
        if (!array_key_exists('color', $rewritten_options)) {
            $rewritten_options['color'] = array(0, 1, 2, 3, 4);
        }
        if (!array_key_exists('type', $rewritten_options)) {
            $rewritten_options['type'] = self::getActiveCardTypes();
        }
        if (!array_key_exists('icon', $rewritten_options)) {
            $rewritten_options['icon'] = $this->innovationGameState->usingFourthEditionRules() ? array(1, 2, 3, 4, 5, 6, 7) : array(1, 2, 3, 4, 5, 6);
        }
        if (!array_key_exists('age', $rewritten_options)) {
            $rewritten_options['age'] = array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11);
        }
        if (!array_key_exists('players', $rewritten_options)) {
            $rewritten_options['players'] = self::getAllActivePlayers();
        }

        if (self::getActivePlayerId() != $player_id) {
            $this->gamestate->changeActivePlayer($player_id);
        }

        $possible_special_types_of_choice = [
            'choose_value',
            'choose_color',
            'choose_two_colors',
            'choose_three_colors',
            'choose_player',
            'choose_rearrange',
            'choose_yes_or_no',
            'choose_type',
            'choose_non_negative_integer',
            'choose_icon_type',
        ];
        foreach($possible_special_types_of_choice as $special_type_of_choice) {
            if (array_key_exists($special_type_of_choice, $options)) {
                $this->innovationGameState->set('special_type_of_choice', self::encodeSpecialTypeOfChoice($special_type_of_choice));
                $this->innovationGameState->set('can_pass', $rewritten_options['can_pass'] ? 1 : 0); 

                // NOTE: It is the responsibility of the card's implementation to ensure that the array in use has at least one element in it.
                $this->innovationGameState->setFromArray('age_array', $rewritten_options['age']); // used by 'choose_value'
                $this->innovationGameState->setFromArray('color_array', $rewritten_options['color']); // used by 'choose_color', 'choose_two_colors', and 'choose_three_colors'
                $this->innovationGameState->setFromArray('type_array', $rewritten_options['type']); // used by 'choose_type'
                $this->innovationGameState->setFromArray('icon_array', $rewritten_options['icon']); // used by 'choose_icon_type'
                $this->innovationGameState->setFromArray('player_array', $rewritten_options['players']); // used by 'choose_player'
                return;
            }
        }

        $this->innovationGameState->set('special_type_of_choice', 0);
        if (!array_key_exists('n_min', $rewritten_options)) {
            $rewritten_options['n_min'] = 999;
        }
        if (!array_key_exists('n_max', $rewritten_options)) {
            $rewritten_options['n_max'] = 999;
        }
        if (!array_key_exists('solid_constraint', $rewritten_options)) {
            $rewritten_options['solid_constraint'] = false;
        }
        if (!array_key_exists('age_min', $rewritten_options)) {
            $rewritten_options['age_min'] = 1;
        }
        if (!array_key_exists('age_max', $rewritten_options)) {
            $rewritten_options['age_max'] = 11;
        }
        if (!array_key_exists('with_icon', $rewritten_options)) {
            $rewritten_options['with_icon'] = 0;
        }
        if (!array_key_exists('without_icon', $rewritten_options)) {
            $rewritten_options['without_icon'] = 0;
        }
        if (!array_key_exists('not_id', $rewritten_options)) {
            $rewritten_options['not_id'] = -2;
        }
        if (!array_key_exists('card_id_1', $rewritten_options)) {
            $rewritten_options['card_id_1'] = -2;
        }
        if (!array_key_exists('card_id_2', $rewritten_options)) {
            $rewritten_options['card_id_2'] = -2;
        }
        if (!array_key_exists('card_id_3', $rewritten_options)) {
            $rewritten_options['card_id_3'] = -2;
        }
        if (!array_key_exists('icon_hash_1', $rewritten_options)) {
            $rewritten_options['icon_hash_1'] = -1;
        }
        if (!array_key_exists('icon_hash_2', $rewritten_options)) {
            $rewritten_options['icon_hash_2'] = -1;
        }
        if (!array_key_exists('icon_hash_3', $rewritten_options)) {
            $rewritten_options['icon_hash_3'] = -1;
        }
        if (!array_key_exists('icon_hash_4', $rewritten_options)) {
            $rewritten_options['icon_hash_4'] = -1;
        }
        if (!array_key_exists('icon_hash_5', $rewritten_options)) {
            $rewritten_options['icon_hash_5'] = -1;
        }
        if (!array_key_exists('enable_autoselection', $rewritten_options)) {
            $rewritten_options['enable_autoselection'] = 1;
        }
        if (!array_key_exists('include_relics', $rewritten_options)) {
            $rewritten_options['include_relics'] = 1;
        }
        if (!array_key_exists('with_bonus', $rewritten_options)) {
            $rewritten_options['with_bonus'] = false;
        }
        if (!array_key_exists('without_bonus', $rewritten_options)) {
            $rewritten_options['without_bonus'] = false;
        }
        if (!array_key_exists('card_ids_are_in_auxiliary_array', $rewritten_options)) {
            $rewritten_options['card_ids_are_in_auxiliary_array'] = false;
        }
        if (!array_key_exists('bottom_from', $rewritten_options)) {
            $rewritten_options['bottom_from'] = false;
        }
        if (!array_key_exists('bottom_to', $rewritten_options)) {
            $rewritten_options['bottom_to'] = (array_key_exists('location_to', $rewritten_options) && $rewritten_options['location_to'] == 'deck');
        }
        if (!array_key_exists('score_keyword', $rewritten_options)) {
            $rewritten_options['score_keyword'] = false;
        }
        if (!array_key_exists('require_achievement_eligibility', $rewritten_options)) {
            $rewritten_options['require_achievement_eligibility'] = false;
        }
        if (!array_key_exists('has_demand_effect', $rewritten_options)) {
            $rewritten_options['has_demand_effect'] = false;
        }
        if (!array_key_exists('has_splay_direction', $rewritten_options)) {
            $rewritten_options['has_splay_direction'] = array(0, 1, 2, 3, 4); // Unsplayed, left, right, up, or aslant
        }
        if (!array_key_exists('splay_direction', $rewritten_options)) {
             $rewritten_options['splay_direction'] = -1;
        } else { // This is a choice for splay
            $rewritten_options['owner_from'] = $player_id;
            $rewritten_options['location_from'] = 'board'; // Splaying is equivalent as selecting a board card, by design
            $rewritten_options['location_to'] = 'board';
            $number_of_cards_on_board = self::countCardsInLocationKeyedByColor($player_id, 'board');
            $splay_direction = $rewritten_options['splay_direction'];
            $colors = array();
            
            foreach ($rewritten_options['color'] as $color) {
                // Check if the stacks have at least 2 cards
                if ($number_of_cards_on_board[$color] < 2) {
                    // This color can't be chosen for splay since the stack is one card or less
                    continue;
                }
                
                // Check if the stack is not already splayed in the same direction
                if (self::getCurrentSplayDirection($player_id, $color) == $splay_direction) {
                    // This color can't be chosen for splay since the stack is already splayed in the same direction
                    continue;
                }
                // This color is still eligible for splaying
                $colors[] = $color;
            }
            $rewritten_options['color'] = $colors;
        }
        
        foreach($rewritten_options as $key => $value) {
            switch($key) {
            case 'can_pass':
            case 'score_keyword':
            case 'solid_constraint':
            case 'require_achievement_eligibility':
            case 'has_demand_effect':
            case 'bottom_from':
            case 'bottom_to':
            case 'enable_autoselection':
            case 'include_relics':
            case 'with_bonus':
            case 'without_bonus':
            case 'card_ids_are_in_auxiliary_array':
                $value = $value ? 1 : 0;
                break;
            case 'location_from':
            case 'location_to':
                $value = self::encodeLocation($value);
                break;
            case 'age':
                $this->innovationGameState->setFromArray('age_array', $value);
                break;
            case 'color':
                $this->innovationGameState->setFromArray('color_array', $value);
                break;
            case 'type':
                $this->innovationGameState->setFromArray('type_array', $value);
                break;
            case 'icon':
                $this->innovationGameState->setFromArray('icon_array', $value);
                break;
            case 'players':
                $this->innovationGameState->setFromArray('player_array', $value);
                break;
            case 'has_splay_direction':
                $this->innovationGameState->setFromArray('has_splay_direction', $value);
                break;
            }
            if ($key <> 'age' && $key <> 'color' && $key <> 'type' && $key <> 'icon' && $key <> 'players' && $key <> 'has_splay_direction') {
                $this->innovationGameState->set($key, $value);
            }
        }
        
        // Set the selection on DB side
        self::selectEligibleCards();
        
        $this->innovationGameState->set('n', 0);
    }
    
    function selectEligibleCards() {
        // Select in database the eligible cards for the current selection to be made.
        // Return the number of selected cards that way

        $player_id = self::getActivePlayerId();
        
        // Condition for owner
        $owner_from = $this->innovationGameState->get('owner_from');
        if ($owner_from == -2) { // Any player
            $condition_for_owner = "owner <> 0";
        } else if ($owner_from == -3) { // Any opponent
            $opponents = self::getObjectListFromDB(self::format("
                SELECT
                    player_id
                FROM
                    player
                WHERE
                    player_team <> (
                        SELECT
                            player_team
                        FROM
                            player
                        WHERE
                            player_id = {player_id}
                    )
            ",
                array('player_id' => $player_id)), true
            );
            $condition_for_owner = self::format("owner IN ({opponents})", array('opponents' => join($opponents, ',')));
        } else if ($owner_from == -4) { // Any other player
            $other_players = self::getObjectListFromDB(self::format("
                SELECT
                    player_id
                FROM
                    player
                WHERE
                    player_id <> {player_id}
            ",
                array('player_id' => $player_id)), true
            );
            $condition_for_owner = self::format("owner IN ({other_players})", array('other_players' => join($other_players, ',')));
        } else {
            $condition_for_owner = self::format("owner = {owner_from}", array('owner_from' => $owner_from));
        }
        
        // Condition for location
        $location_from = self::decodeLocation($this->innovationGameState->get('location_from'));
        if ($location_from == 'revealed,hand') {
            $condition_for_location = "location IN ('revealed', 'hand')";
        } else if ($location_from == 'revealed,score') {
            $condition_for_location = "location IN ('revealed', 'score')";
        } else if ($location_from == 'hand,score') {
            $condition_for_location = "location IN ('hand', 'score')";
        } else if ($location_from == 'pile') {
            $condition_for_location = "location = 'board'";
        } else {
            $condition_for_location = self::format("location = '{location_from}'", array('location_from' => $location_from));
        }
        
        // Condition for age
        $age_min = $this->innovationGameState->get('age_min');
        $age_max = $this->innovationGameState->get('age_max');
        $condition_for_age = self::format("age BETWEEN {age_min} AND {age_max}", array('age_min' => $age_min, 'age_max' => $age_max));
        // TODO(LATER): Take 'age_array' into account if there are any cards which need to rely on this mechanism.

        // Condition for age because of achievement eligibility
        $claimable_ages = array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11);
        if ($this->innovationGameState->get('require_achievement_eligibility') == 1) {
            $claimable_ages = self::getClaimableAgesIgnoringAvailability($player_id);
            if (count($claimable_ages) == 0) {
                // Avoid calling a SQL query with 'age IN ()' in it since it isn't correct syntax.
                $claimable_ages[] = -1;
            }
        }
        $condition_for_claimable_ages = self::format("age IN ({claimable_ages})", array('claimable_ages' => join($claimable_ages, ',')));

        // Condition for whether it has a demand effect
        $condition_for_demand_effect = "TRUE";
        if ($this->innovationGameState->get('has_demand_effect') == 1) {
            $condition_for_demand_effect = "has_demand = TRUE";
        }
        
        // Condition for color
        $color_array = $this->innovationGameState->getAsArray('color_array');
        $condition_for_color = count($color_array) == 0 ? "FALSE" : "color IN (".join($color_array, ',').")";

        // Condition for type
        $type_array = $this->innovationGameState->getAsArray('type_array');
        $condition_for_type = count($type_array) == 0 ? "AND FALSE" : "AND type IN (".join($type_array, ',').")";
        
        // Condition for icon
        $with_icon = $this->innovationGameState->get('with_icon');
        $without_icon = $this->innovationGameState->get('without_icon');
        if ($with_icon > 0) {
            $condition_for_icon = self::format("AND (spot_1 = {icon} OR spot_2 = {icon} OR spot_3 = {icon} OR spot_4 = {icon} OR spot_5 = {icon} OR spot_6 = {icon})", array('icon' => $with_icon));
        }
        else if ($without_icon > 0) {
            $condition_for_icon = self::format("AND (spot_1 IS NULL OR spot_1 <> {icon}) AND (spot_2 IS NULL OR spot_2 <> {icon}) AND (spot_3 IS NULL OR spot_3 <> {icon}) AND (spot_4 IS NULL OR spot_4 <> {icon}) AND (spot_5 IS NULL OR spot_5 <> {icon}) AND (spot_6 IS NULL OR spot_6 <> {icon})", array('icon' => $without_icon));
        }
        else {
            $condition_for_icon = "";
        }

        // Condition for icon hash
        $icon_hash_1 = $this->innovationGameState->get('icon_hash_1');
        $icon_hash_2 = $this->innovationGameState->get('icon_hash_2');
        $icon_hash_3 = $this->innovationGameState->get('icon_hash_3');
        $icon_hash_4 = $this->innovationGameState->get('icon_hash_4');
        $icon_hash_5 = $this->innovationGameState->get('icon_hash_5');
        if ($icon_hash_1 >= 0 || $icon_hash_2 >= 0 || $icon_hash_3 >= 0 || $icon_hash_4 >= 0 || $icon_hash_5 >= 0) {
            $condition_for_icon_hash = self::format("
                AND (
                    icon_hash = {icon_hash_1} OR
                    icon_hash = {icon_hash_2} OR
                    icon_hash = {icon_hash_3} OR
                    icon_hash = {icon_hash_4} OR
                    icon_hash = {icon_hash_5}
                )", array(
                    'icon_hash_1' => $icon_hash_1,
                    'icon_hash_2' => $icon_hash_2,
                    'icon_hash_3' => $icon_hash_3,
                    'icon_hash_4' => $icon_hash_4,
                    'icon_hash_5' => $icon_hash_5
                )
            );
        } else {
            $condition_for_icon_hash = "";
        }

        // Condition for whether the stack is splayed
        $splay_directions = $this->innovationGameState->getAsArray('has_splay_direction');
        $condition_for_splay = "";
        if (count($splay_directions) == 0) {
            $condition_for_splay = "AND FALSE";
        } else if ($this->innovationGameState->get('release_version') <= 3 && count($splay_directions) < 4 || $this->innovationGameState->get('release_version') >= 4 && count($splay_directions) < 5) {
            $condition_for_splay = "AND splay_direction IN (".join($splay_directions, ',').")";
        }

        // Condition for requiring ID
        $condition_for_requiring_id = "";
        $card_ids_are_in_auxiliary_array = $this->innovationGameState->get('card_ids_are_in_auxiliary_array');
        if ($card_ids_are_in_auxiliary_array == 1) {
            $card_ids = self::getAuxiliaryArray();
            if (empty($card_ids)) {
                $condition_for_requiring_id = "AND FALSE";
            } else {
                $condition_for_requiring_id = "AND id IN (";
                $first_id = true;
                foreach ($card_ids as $card_id) {
                    if ($first_id) {
                        $first_id = false;
                    } else {
                        $condition_for_requiring_id .= ", ";
                    }
                    $condition_for_requiring_id .= "$card_id";
                }
                $condition_for_requiring_id .= ")";
            }
        } else {
            $card_id_1 = $this->innovationGameState->get('card_id_1');
            $card_id_2 = $this->innovationGameState->get('card_id_2');
            $card_id_3 = $this->innovationGameState->get('card_id_3');
            if ($card_id_3 != -2) {
                $condition_for_requiring_id = self::format("AND id IN ({card_id_1}, {card_id_2}, {card_id_3})", array('card_id_1' => $card_id_1, 'card_id_2' => $card_id_2, 'card_id_3' => $card_id_3));
            } else if ($card_id_2 != -2) {
                $condition_for_requiring_id = self::format("AND id IN ({card_id_1}, {card_id_2})", array('card_id_1' => $card_id_1, 'card_id_2' => $card_id_2));
            } else if ($card_id_1 != -2) {
                $condition_for_requiring_id = self::format("AND id IN ({card_id_1})", array('card_id_1' => $card_id_1));
            }
        }

        // Condition for excluding ID
        $condition_for_excluding_id = "";
        $not_id = $this->innovationGameState->get('not_id');
        if ($not_id != -2) { // Used by cards like Fission and Self service
            $condition_for_excluding_id = self::format("AND id <> {not_id}", array('not_id' => $not_id));
        }

        // Condition for including relic
        $condition_for_including_relic = "";
        $include_relics = $this->innovationGameState->get('include_relics');
        if ($include_relics == 0) {
            $condition_for_including_relic = "AND is_relic = FALSE";
        }

        // Condition for including cards with at least one bonus icon
        $condition_for_including_bonus = "";
        $with_bonus = $this->innovationGameState->get('with_bonus');
        if ($with_bonus == 1) {
            $condition_for_including_bonus = "AND (spot_1 >= 101 OR spot_2 >= 101 OR spot_3 >= 101 OR spot_4 >= 101 OR spot_5 >= 101 OR spot_6 >= 101)";
        }

        // Condition for excluding cards with at least one bonus icon
        $condition_for_excluding_bonus = "";
        $without_bonus = $this->innovationGameState->get('without_bonus');
        if ($without_bonus == 1) {
            $condition_for_excluding_bonus = "AND (spot_1 IS NULL OR spot_1 < 101) AND (spot_2 IS NULL OR spot_2 < 101) AND (spot_3 IS NULL OR spot_3 < 101) AND (spot_4 IS NULL OR spot_4 < 101) AND (spot_5 IS NULL OR spot_5 < 101) AND (spot_6 IS NULL OR spot_6 < 101)";
        }
        
        if ($this->innovationGameState->get('splay_direction') == -1 && $location_from == 'board') {
            self::DbQuery(self::format("
                UPDATE
                    card
                LEFT JOIN
                    (SELECT owner AS joined_owner, color AS joined_color, {position} AS position_to_select FROM card WHERE location = 'board' GROUP BY owner, color) AS joined
                    ON
                        owner = joined_owner AND
                        color = joined_color
                SET
                    selected = TRUE
                WHERE
                    {condition_for_owner} AND
                    {condition_for_location} AND
                    {condition_for_age} AND
                    {condition_for_claimable_ages} AND
                    {condition_for_demand_effect} AND
                    position = position_to_select AND
                    {condition_for_color}
                    {condition_for_type}
                    {condition_for_icon}
                    {condition_for_icon_hash}
                    {condition_for_splay}
                    {condition_for_requiring_id}
                    {condition_for_excluding_id}
                    {condition_for_including_relic}
                    {condition_for_including_bonus}
                    {condition_for_excluding_bonus}
            ",
                array(
                    'position' => $this->innovationGameState->get('bottom_from') == 1 ? '0' : 'MAX(position)',
                    'condition_for_owner' => $condition_for_owner,
                    'condition_for_location' => $condition_for_location,
                    'condition_for_age' => $condition_for_age,
                    'condition_for_claimable_ages' => $condition_for_claimable_ages,
                    'condition_for_demand_effect' => $condition_for_demand_effect,
                    'condition_for_color' => $condition_for_color,
                    'condition_for_type' => $condition_for_type,
                    'condition_for_icon' => $condition_for_icon,
                    'condition_for_icon_hash' => $condition_for_icon_hash,
                    'condition_for_splay' => $condition_for_splay,
                    'condition_for_requiring_id' => $condition_for_requiring_id,
                    'condition_for_excluding_id' => $condition_for_excluding_id,
                    'condition_for_including_relic' => $condition_for_including_relic,
                    'condition_for_including_bonus' => $condition_for_including_bonus,
                    'condition_for_excluding_bonus' => $condition_for_excluding_bonus
                )
            ));
        }
        else {
            self::DbQuery(self::format("
                UPDATE
                    card
                SET
                    selected = TRUE
                WHERE
                    {condition_for_owner} AND
                    {condition_for_location} AND
                    {condition_for_age} AND
                    {condition_for_claimable_ages} AND
                    {condition_for_demand_effect} AND
                    {condition_for_color}
                    {condition_for_type}
                    {condition_for_icon}
                    {condition_for_icon_hash}
                    {condition_for_splay}
                    {condition_for_requiring_id}
                    {condition_for_excluding_id}
                    {condition_for_including_relic}
                    {condition_for_including_bonus}
                    {condition_for_excluding_bonus}
            ",
                array(
                    'condition_for_owner' => $condition_for_owner,
                    'condition_for_location' => $condition_for_location,
                    'condition_for_age' => $condition_for_age,
                    'condition_for_claimable_ages' => $condition_for_claimable_ages,
                    'condition_for_demand_effect' => $condition_for_demand_effect,
                    'condition_for_color' => $condition_for_color,
                    'condition_for_type' => $condition_for_type,
                    'condition_for_icon' => $condition_for_icon,
                    'condition_for_icon_hash' => $condition_for_icon_hash,
                    'condition_for_splay' => $condition_for_splay,
                    'condition_for_requiring_id' => $condition_for_requiring_id,
                    'condition_for_excluding_id' => $condition_for_excluding_id,
                    'condition_for_including_relic' => $condition_for_including_relic,
                    'condition_for_including_bonus' => $condition_for_including_bonus,
                    'condition_for_excluding_bonus' => $condition_for_excluding_bonus
                )
            ));
        }
        
        return self::getUniqueValueFromDB("SELECT COUNT(*) FROM card WHERE selected IS TRUE");
    }
    
    function encodeLocation($location) {
        switch($location) {
        case 'deck':
            return 0;
        case 'hand':
            return 1;
        case 'board':
            return 2;
        case 'score':
            return 3;
        case 'revealed':
            return 4;
        case 'revealed,hand':
            return 5;
        case 'revealed,deck':
            return 6;
        case 'pile':
            return 7;
        case 'revealed,score':
            return 8;
        case 'achievements':
            return 9;
        case 'none':
            return 10;
        case 'display':
            return 11;
        case 'relics':
            return 12;
        case 'removed':
            return 13;
        case 'forecast':
            return 14;
        case 'hand,score':
            return 15;
        case 'junk':
            return 16;
        default:
            // This should not happen
            throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => "encodeLocation()", 'code' => $location)));
            break;
        }
    }
    
    function decodeLocation($location_code) {
        switch($location_code) {
        case 0:
            return 'deck';
        case 1:
            return 'hand';
        case 2:
            return 'board';
        case 3:
            return 'score';
        case 4:
            return 'revealed';
        case 5:
            return 'revealed,hand';
        case 6:
            return 'revealed,deck';
        case 7:
            return 'pile';
        case 8:
            return 'revealed,score';
        case 9:
            return 'achievements';
        case 10:
            return 'none';
        case 11:
            return 'display';
        case 12:
            return 'relics';
        case 13:
            return 'removed';
        case 14:
            return 'forecast';
        case 15:
            return 'hand,score';
        case 16:
            return 'junk';
        default:
            // This should not happen
            throw new BgaVisibleSystemException(self::format(self::_("Unhandled case in {function}: '{code}'"), array('function' => "decodeLocation()", 'code' => $location_code)));
            break;
        }
    }
    
    function encodeSpecialTypeOfChoice($special_type_of_choice) {
        // NOTE: The following values are unused and safe to re-use: 1, 2
        switch($special_type_of_choice) {
        case 'choose_value':
            return 3;
        case 'choose_color':
            return 4;
        case 'choose_two_colors':
            return 5;
        case 'choose_rearrange':
            return 6;
        case 'choose_yes_or_no':
            return 7;
        case 'choose_type':
            return 8;
        case 'choose_three_colors':
            return 9;
        case 'choose_player':
            return 10;
        case 'choose_non_negative_integer':
            return 11;
        case 'choose_icon_type':
            return 12;
        }
    }
    
    function decodeSpecialTypeOfChoice($special_type_of_choice_code) {
        // NOTE: The following values are unused and safe to re-use: 1, 2
        switch($special_type_of_choice_code) {
        case 3:
            return 'choose_value';
        case 4:
            return 'choose_color';
        case 5:
            return 'choose_two_colors';
        case 6:
            return 'choose_rearrange';
        case 7:
            return 'choose_yes_or_no';
        case 8:
            return 'choose_type';
        case 9:
            return 'choose_three_colors';
        case 10:
            return 'choose_player';
        case 11:
            return 'choose_non_negative_integer';
        case 12:
            return 'choose_icon_type';
        }
    }
    
    function decodeGameType($game_type_code) {
        switch($game_type_code) {
        case 1:
            return 'individual';
        default:
            return 'team';
        }
    }
    
    /** Functions used for returning args to clients (Several states send these same things) **/
    function getArgForDogmaEffect() {
        $nested_card_state = self::getCurrentNestedCardState();

        // There won't be any nested card state if a player is returning cards after the Search icon was triggered.
        if ($nested_card_state == null) {
            return array_merge([
                'qualified_effect' => clienttranslate('search icon'),
                'card_name' => 'card_name',
                'i18n' => ['qualified_effect', 'card_name'],
            ], self::getDogmaCardNames());
        }

        $card_id = $nested_card_state['card_id'];
        $current_effect_type = $nested_card_state['current_effect_type'];
        $current_effect_number = $nested_card_state['current_effect_number'];
        // Echo effects are sometimes executed on cards other than the card being dogma'd
        if ($current_effect_type == 3) {
            $nesting_index = $nested_card_state['nesting_index'];
            $card_id = self::getUniqueValueFromDB(
                self::format("SELECT card_id FROM echo_execution WHERE nesting_index = {nesting_index} AND execution_index = {effect_number}",
                    array('nesting_index' => $nesting_index, 'effect_number' => $current_effect_number)));
        }
        $card = self::getCardInfo($card_id);
        
        $card_names = self::getDogmaCardNames();
        
        $args = array_merge(array(
            'qualified_effect' => self::qualifyEffect($current_effect_type, $current_effect_number, $card),
            'card_name' => 'card_name',
            'JSCardEffectQuery' => self::getJSCardEffectQuery($card, $current_effect_type, $current_effect_number)
        ), $card_names);
        
        $args['i18n'][] = 'qualified_effect';
        $args['i18n'][] = 'card_name';
        
        return $args;
    }
    
    function getArgForPlayerUnderDogmaEffect() {
        $player_id = self::getCurrentPlayerUnderDogmaEffect();
        return array_merge(
            self::getArgForDogmaEffect(),
            array(
                'player' => '${player}',
                'player_id' => $player_id,
                'player_name' => self::getColoredPlayerName($player_id),
                'player_name_as_you' => 'You'
            )
        );
    }
    
    function getDogmaCardNames() { // Returns the name of the current dogma card or all the names where there are nested dogma effects
        $nesting_index = $this->innovationGameState->get('current_nesting_index');
        $player_id = self::getCurrentPlayerUnderDogmaEffect();

        // There won't be any nested card state if a player is returning cards after the Search icon was triggered.
        if ($nesting_index < 0) {
            return [
                'card_0' => self::getCardName($this->innovationGameState->get('melded_card_id')),
                'ref_player_0' => $player_id,
                'i18n' => ['card_0'],
            ];
        }

        $card_names = array();
        $i18n = array();
        for ($i = 0; $i <= $nesting_index; $i++) {
            $nested_card_state = self::getNestedCardState($i);
            $current_effect_type = $nested_card_state['current_effect_type'];
            $current_effect_number = $nested_card_state['current_effect_number'];
            $card_id = $nested_card_state['card_id'];
            // Echo effects are sometimes executed on cards other than the card being dogma'd
            if ($current_effect_type == 3) {
                $nesting_index = $nested_card_state['nesting_index'];
                $card_id = self::getUniqueValueFromDB(
                    self::format("SELECT card_id FROM echo_execution WHERE nesting_index = {nesting_index} AND execution_index = {effect_number}",
                        array('nesting_index' => $nesting_index, 'effect_number' => $current_effect_number)));
            }
            $card_names['card_'.$i] = self::getCardName($card_id);
            $card_names['ref_player_'.$i] = $player_id;
            $i18n[] = 'card_'.$i;
        }

        $card_names['i18n'] = $i18n;
        return $card_names;
    }
    
    function getJSCardId($card) {
        return "#item_" . $card['id'] . "__age_" . $card['age'] . "__type_" . $card['type'] . "__is_relic_" . $card['is_relic'] . "__M__card";
    }
    
    function getJSCardEffectQuery($card, $effect_type, $effect_number) {
        if ($effect_type == 3) {
            return self::getJSCardId($card) . " .echo_effect";
        }
        return self::getJSCardId($card) . " ." . ($effect_type == 1 ? "non_demand" : "i_demand") . "_effect_" . $effect_number;
    }

    function setLauncherId($launcher_id) {
        self::updateCurrentNestedCardState('launcher_id', $launcher_id);
    }

    function getLauncherId() {
        if ($this->innovationGameState->get('current_nesting_index') < 0) {
            return $this->innovationGameState->get('active_player');
        }
        return self::getCurrentNestedCardState()['launcher_id'];
    }

    function incrementStep($delta) {
        self::setStep(self::getStep() + $delta);
    }

    function setStep($step) {
        self::updateCurrentNestedCardState('step', $step);
    }

    function getStep() {
        return self::getCurrentNestedCardState()['step'];
    }

    function incrementStepMax($delta) {
        self::setStepMax(self::getStepMax() + $delta);
    }

    function setStepMax($step_max) {
        self::updateCurrentNestedCardState('step_max', $step_max);
    }

    function getStepMax() {
        return self::getCurrentNestedCardState()['step_max'];
    }

    function setAuxiliaryValue($auxiliary_value) {
        self::updateCurrentNestedCardState('auxiliary_value', $auxiliary_value);
    }

    function setAuxiliaryValueFromArray($array) {
        self::setAuxiliaryValue(Arrays::getArrayAsValue($array));
    }

    function getAuxiliaryValue() {
        return self::getCurrentNestedCardState()['auxiliary_value'];
    }

    function getAuxiliaryValueAsArray() {
        return Arrays::getValueAsArray(self::getAuxiliaryValue());
    }

    function setAuxiliaryValue2($auxiliary_value_2) {
        self::updateCurrentNestedCardState('auxiliary_value_2', $auxiliary_value_2);
    }

    function setAuxiliaryValue2FromArray($array) {
        self::setAuxiliaryValue2(Arrays::getArrayAsValue($array));
    }

    function getAuxiliaryValue2() {
        return self::getCurrentNestedCardState()['auxiliary_value_2'];
    }

    function getAuxiliaryValue2AsArray() {
        return Arrays::getValueAsArray(self::getAuxiliaryValue2());
    }

    function setAuxiliaryArray($array) {
        $nesting_index = $this->innovationGameState->get('current_nesting_index');
        $array_vals = array_values($array);
        
        // Remove the old array (if it exists)
        self::DbQuery(self::format("DELETE FROM auxiliary_value_table WHERE nesting_index = {nesting_index}", array('nesting_index' => $nesting_index)));

        // Write array size
        self::DbQuery(self::format("
                INSERT INTO auxiliary_value_table
                    (nesting_index, array_index, value)
                VALUES
                    ({nesting_index}, 0, {array_size})
            ", array('nesting_index' => $nesting_index, 'array_size' => count($array_vals))));

        // Write array values
        for ($i = 1; $i <= count($array_vals); $i++) {
            self::DbQuery(self::format("
                INSERT INTO auxiliary_value_table
                    (nesting_index, array_index, value)
                VALUES
                    ({nesting_index}, {array_index}, {value})
            ", array('nesting_index' => $nesting_index, 'array_index' => $i, 'value' => $array_vals[$i - 1])));
        }
    }

    function getAuxiliaryArray() {
        $nesting_index = $this->innovationGameState->get('current_nesting_index');
        
        // Get array size
        $array_size = self::getUniqueValueFromDB(self::format("
            SELECT
                value
            FROM
                auxiliary_value_table
            WHERE
                nesting_index = {nesting_index} AND
                array_index = 0
        ",
            array('nesting_index' => $nesting_index)
       ));
            
        // Get array values
        $array = array();
        for ($i = 1; $i <= $array_size; $i++) {
            $array[] = self::getUniqueValueFromDB(self::format("
                SELECT
                    value
                FROM
                    auxiliary_value_table
                WHERE
                    nesting_index = {nesting_index} AND
                    array_index = {array_index}
            ",
                array('nesting_index' => $nesting_index, 'array_index' => $i)
            ));
        }

        return $array;
    }

    function setIndexedAuxiliaryValue($index_id, $value) {
        $nesting_index = $this->innovationGameState->get('current_nesting_index');

        // Check to see if a value already exists
        $result = self::getUniqueValueFromDB(self::format("
            SELECT
                value
            FROM
                indexed_auxiliary_value
            WHERE
                nesting_index = {nesting_index} AND
                index_id = {index_id}
        ",
            array('nesting_index' => $nesting_index, 'index_id' => $index_id)
        ));

        // If it doesn't already exist, insert it
        if ($result == null) {
            self::DbQuery(self::format("
                INSERT INTO indexed_auxiliary_value
                    (nesting_index, index_id, value)
                VALUES
                    ({nesting_index}, {index_id}, {value})
            ", array('nesting_index' => $nesting_index, 'index_id' => $index_id, 'value' => $value)));
        
        // If it does, update it
        } else {
            self::DbQuery(self::format("
                UPDATE
                    indexed_auxiliary_value
                SET
                    value = {value}
                WHERE
                    nesting_index = {nesting_index} AND index_id = {index_id}
            ", array('nesting_index' => $nesting_index, 'index_id' => $index_id, 'value' => $value)));
        }
    }

    function getIndexedAuxiliaryValue($index_id) {
        $nesting_index = $this->innovationGameState->get('current_nesting_index');
        $result = self::getUniqueValueFromDB(self::format("
            SELECT
                value
            FROM
                indexed_auxiliary_value
            WHERE
                nesting_index = {nesting_index} AND
                index_id = {index_id}
        ",
            array('nesting_index' => $nesting_index, 'index_id' => $index_id)
       ));
       if ($result == null) {
        $result = -1;
       }
       return $result;
    }

    /** Returns true if the ongoing effect is currently executing a second time due to an Endorse action */
    function isExecutingAgainDueToEndorsedAction() {
        return $this->innovationGameState->get('current_nesting_index') == 0 && $this->innovationGameState->get('endorse_action_state') == 3;
    }
    
    /** Nested dogma excution management system: FIFO stack **/
    function executeNonDemandEffects($card) {
        $player_id = self::getCurrentPlayerUnderDogmaEffect();
        $card_args = self::getNotificationArgsForCardList([$card]);
        if (self::getNonDemandEffect($card['id'], 1) === null && self::getEchoEffect($card['id']) === null) {
            self::notifyAll('logWithCardTooltips', clienttranslate('There are no non-demand effects on ${card} to execute.'), ['card' => $card_args, 'card_ids' => [$card['id']]]);
            return;
        }
        self::notifyPlayer($player_id, 'logWithCardTooltips', clienttranslate('${You} execute the non-demand effect(s) of ${card}.'),
            ['You' => 'You', 'card' => $card_args, 'card_ids' => [$card['id']]]);
        self::notifyAllPlayersBut($player_id, 'logWithCardTooltips', clienttranslate('${player_name} executes the non-demand effect(s) of ${card}.'),
            ['player_name' => self::getColoredPlayerName($player_id), 'card' => $card_args, 'card_ids' => [$card['id']]]);
        self::pushCardIntoNestedDogmaStack($card, /*execute_demand_effects=*/ false);
    }

    function executeAllEffects($card) {
        $current_nested_state = self::getCurrentNestedCardState();
        $current_card = self::getCardInfo($current_nested_state['card_id']);
        $card_1_args = self::getNotificationArgsForCardList([$current_card]);
        $card_2_args = self::getNotificationArgsForCardList([$card]);
        $player_id = self::getCurrentPlayerUnderDogmaEffect();
        $initially_executed_card = self::getCardInfo($current_nested_state['executing_as_if_on_card_id']);
        $icon = self::getIconSquare($initially_executed_card['dogma_icon']);
        self::notifyPlayer($player_id, 'logWithCardTooltips', clienttranslate('${You} execute the effects of ${card_2} as if it were on ${card_1}, using ${icon} as the featured icon.'),
            ['You' => 'You', 'card_1' => $card_1_args, 'card_2' => $card_2_args, 'card_ids' => [$current_card['id'], $card['id']], 'icon' => $icon]);
        self::notifyAllPlayersBut($player_id, 'logWithCardTooltips', clienttranslate('${player_name} executes the effects of ${card_2} as if it were on ${card_1}, using ${icon} as the featured icon.'),
            ['player_name' => self::getColoredPlayerName($player_id), 'card_1' => $card_1_args, 'card_2' => $card_2_args, 'card_ids' => [$current_card['id'], $card['id']], 'icon' => $icon]);
        self::pushCardIntoNestedDogmaStack($card, /*execute_demand_effects=*/ true);
    }
    
    function pushCardIntoNestedDogmaStack($card, $execute_demand_effects) {
        self::trace('nesting++');
        $current_player_id = self::getCurrentPlayerUnderDogmaEffect();
        $nested_card_state = self::getCurrentNestedCardState();
        // Every card that says "execute the effects" also says "as if they were on this card"
        if ($execute_demand_effects) {
            $as_if_on = $nested_card_state['executing_as_if_on_card_id'];
        } else {
            $as_if_on = $card['id'];
        }
        $next_nesting_index = $this->innovationGameState->get('current_nesting_index') + 1;
        $has_i_demand = self::getDemandEffect($card['id']) !== null && !self::isCompelEffect($card['id']);
        $has_i_compel = self::getDemandEffect($card['id']) !== null && self::isCompelEffect($card['id']);
        $has_echo_effect = self::getEchoEffect($card['id']) !== null;
        $effect_type = $execute_demand_effects ? ($has_echo_effect ? 3 : ($has_i_demand ? 0 : ($has_i_compel ? 2 : 1))) : 1;
        if ($effect_type == 3) {
            self::DbQuery(self::format("
                    INSERT INTO echo_execution
                        (nesting_index, execution_index, card_id)
                    VALUES
                        ({nesting_index}, 1, {card_id})
                ", array('nesting_index' => $next_nesting_index, 'card_id' => $card['id'])));
        }
        self::DbQuery(self::format("
            INSERT INTO nested_card_execution
                (nesting_index, card_id, executing_as_if_on_card_id, launcher_id, current_effect_type, current_effect_number, step, step_max)
            VALUES
                ({nesting_index}, {card_id}, {as_if_on}, {launcher_id}, {effect_type}, 1, -1, -1)
        ", array('nesting_index' => $next_nesting_index, 'card_id' => $card['id'], 'as_if_on' => $as_if_on, 'launcher_id' => $current_player_id, 'effect_type' => $effect_type)));
    }
    
    function popCardFromNestedDogmaStack() {
        self::trace('nesting--');
        if ($this->innovationGameState->get('release_version') >= 2) {
            self::DbQuery(self::format("DELETE FROM indexed_auxiliary_value WHERE nesting_index = {nesting_index}", array('nesting_index' => $this->innovationGameState->get('current_nesting_index'))));
        }
        self::DbQuery(self::format("DELETE FROM nested_card_execution WHERE nesting_index = {nesting_index}", array('nesting_index' => $this->innovationGameState->get('current_nesting_index'))));
        $this->innovationGameState->increment('current_nesting_index', -1);
        self::updateCurrentNestedCardState('post_execution_index', 'post_execution_index + 1');
    }

    function getNestedCardState($nesting_index) {
        return self::getObjectFromDB(
            self::format("
                SELECT
                    nesting_index,
                    card_id,
                    executing_as_if_on_card_id,
                    card_location,
                    launcher_id,
                    current_player_id,
                    current_effect_type,
                    current_effect_number,
                    step,
                    step_max,
                    post_execution_index,
                    auxiliary_value,
                    auxiliary_value_2
                FROM
                    nested_card_execution
                WHERE
                    nesting_index = {nesting_index}",
                array('nesting_index' => $nesting_index)
        ));
    }

    function getCurrentNestedCardState() {
        return self::getNestedCardState($this->innovationGameState->get('current_nesting_index'));
    }

    function updateCurrentNestedCardState($column, $value) {
        self::DbQuery(
            self::format("
                UPDATE
                    nested_card_execution
                SET
                    {column} = {value}
                WHERE
                    nesting_index = {nesting_index}",
                array('column' => $column, 'value' => $value, 'nesting_index' => $this->innovationGameState->get('current_nesting_index')))
        );
    }

    function getCurrentPlayerUnderDogmaEffect() {
        // There won't be any nested card state if a player is returning cards after the Search icon was triggered.
        $current_nested_state = self::getCurrentNestedCardState();
        if ($current_nested_state == null) {
            return $this->innovationGameState->get('active_player');
        }

        $player_id = $current_nested_state['current_player_id'];
        // TODO(LATER): Figure out why this workaround is necessary.
        if ($player_id == -1) {
            return $this->innovationGameState->get('active_player');
        }
        return $player_id;
    }
    
//////////// Player actions
//////////// 

    /*
        Each time a player is doing some game action, one of the methods below is called.
        (note: each method below must match an input method in innovation.action.php)
    */
    
    function initialMeld($card_id) {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('initialMeld');
        $player_id = self::getCurrentPlayerId();

        // Check if the player really has this card
        $card = self::getCardInfo($card_id);
        
        if ($card['owner'] != $player_id || $card['location'] != "hand") {
            self::throwInvalidChoiceException();
        }
        
        // Stats
        self::setStat(1, 'turns_number', $player_id); // First turn for this player
        if (self::getStat('turns_number') == 0) {
            self::setStat(1, 'turns_number'); // First turn for the table
        }
        
        // Mark it as selected
        self::markAsSelected($card_id, $player_id);
        
        // Notify
        self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose a card.'), array(
            'You' => 'You'            
        ));
            
        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses a card.'), array(
            'player_name' => self::getPlayerNameFromId($player_id)
        ));
        
        // If that was the last player to choose his card, go on for the next state (whoBegins?), else, wait for remaining players
        $this->gamestate->setPlayerNonMultiactive($player_id, '');
    }

    function updateInitialMeld($card_id) {
        $this->gamestate->checkPossibleAction('updateInitialMeld');
        $this->gamestate->setPlayersMultiactive(array ($this->getCurrentPlayerId() ), 'error', false);

        // Check if the player really has this card
        $card = self::getCardInfo($card_id);
        $player_id = self::getCurrentPlayerId();
        if ($card['owner'] != $player_id || $card['location'] != "hand") {
            self::throwInvalidChoiceException();
        }
        
        // Update card selection
        $cards = self::getCardsInHand($player_id);
        foreach($cards as $card_in_hand) {
            if ($card_in_hand['id'] == $card_id) {
                self::markAsSelected($card_in_hand['id'], $player_id);
            } else {
                self::unmarkAsSelected($card_in_hand['id'], $player_id);
            }
        }
        
        // Notify
        self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose a card.'), array(
            'You' => 'You'            
        ));
            
        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses a card.'), array(
            'player_name' => self::getPlayerNameFromId($player_id)
        ));
        
        // If that was the last player to choose his card, go on for the next state (whoBegins?), else, wait for remaining players
        $this->gamestate->setPlayerNonMultiactive($player_id, '');
    }

    function passSeizeRelic() {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('passSeizeRelic');

        $player_id = self::getCurrentPlayerId();
        self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose not to seize the relic.'), array('You' => 'You'));    
        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses not to seize the relic.'), array('player_name' => self::getPlayerNameFromId($player_id)));
        $this->innovationGameState->set('relic_id', -1);

        self::trace('relicPlayerTurn->promoteCard (passSeizeRelic)');
        $this->gamestate->nextState('promoteCard');
    }

    function seizeRelicToHand() {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('seizeRelicToHand');

        $player_id = self::getCurrentPlayerId();
        $card = self::getCardInfo($this->innovationGameState->get('relic_id'));

        if ($card['owner'] != 0 && $card['owner'] != $player_id) {
            self::incStat(1, 'relics_stolen_number', $card['owner']);
        }
        self::incStat(1, 'relics_seized_number', $player_id);

        self::transferCardFromTo($card, $player_id, 'hand');
        $this->innovationGameState->set('relic_id', -1);
       
        self::trace('relicPlayerTurn->promoteCard (seizeRelicToHand)');
        $this->gamestate->nextState('promoteCard');
    }

    function seizeRelicToAchievements() {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('seizeRelicToAchievements');

        $player_id = self::getCurrentPlayerId();
        $card = self::getCardInfo($this->innovationGameState->get('relic_id'));

        if ($card['owner'] != 0 && $card['owner'] != $player_id) {
            self::incStat(1, 'relics_stolen_number', $card['owner']);
        }
        self::incStat(1, 'relics_seized_number', $player_id);

        try {
            self::transferCardFromTo($card, $player_id, "achievements");
        } catch (EndOfGame $e) {
            // End of the game: the exception has reached the highest level of code
            self::trace('EOG bubbled from self::promoteCard');
            self::trace('promoteCard->justBeforeGameEnd');
            $this->gamestate->nextState('justBeforeGameEnd');
            return;
        }
       
        $this->innovationGameState->set('relic_id', -1);

        self::trace('relicPlayerTurn->promoteCard (seizeRelicToAchievements)');
        $this->gamestate->nextState('promoteCard');
    }

    function dogmaArtifactOnDisplay() {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('dogmaArtifactOnDisplay');

        $player_id = self::getCurrentPlayerId();
        $card = self::getArtifactOnDisplay($player_id);

        // Battleship Yamato does not have any icons on it so it cannot be executed
        if ($card['dogma_icon'] == null) {
            self::throwInvalidChoiceException();
        }

        self::decreaseResourcesForArtifactOnDisplay($player_id, $card);

        self::setUpDogma($player_id, $card, self::countIconsOnCard($card, $card['dogma_icon']));        
        self::incStat(1, 'free_action_dogma_number', $player_id);
        
        // Resolve the first dogma effect of the card
        self::trace('artifactPlayerTurn->dogmaEffect (dogmaArtifactOnDisplay)');
        $this->gamestate->nextState('dogmaEffect');
    }

    function returnArtifactOnDisplay() {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('returnArtifactOnDisplay');

        $player_id = self::getCurrentPlayerId();
        $card = self::getArtifactOnDisplay($player_id);
        self::decreaseResourcesForArtifactOnDisplay($player_id, $card);
        self::returnCard($card);

        self::giveExtraTime($player_id);
        self::trace('artifactPlayerTurn->playerTurn (returnArtifactOnDisplay)');
        $this->gamestate->nextState('playerTurn');
        $this->innovationGameState->set('current_action_number', 1);
        
        self::incStat(1, 'free_action_return_number', $player_id);
    }

    function passArtifactOnDisplay() {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('passArtifactOnDisplay');

        $player_id = self::getCurrentPlayerId();
        self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose not to return or dogma your Artifact on display.'), array('You' => 'You'));    
        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses not to return or dogma his Artifact on display.'), array('player_name' => self::getPlayerNameFromId($player_id)));
        $card = self::getArtifactOnDisplay($player_id);
        self::decreaseResourcesForArtifactOnDisplay($player_id, $card);

        self::giveExtraTime($player_id);
        self::trace('artifactPlayerTurn->playerTurn (passArtifactOnDisplay)');
        $this->gamestate->nextState('playerTurn');
        $this->innovationGameState->set('current_action_number', 1);
        
        self::incStat(1, 'free_action_pass_number', $player_id);
    }

    function passPromoteCard() {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('passPromoteCard');

        $player_id = self::getCurrentPlayerId();
        self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose not to promote a card from your forecast.'), array('You' => 'You'));    
        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses not to promote a card from his forecast.'), array('player_name' => self::getPlayerNameFromId($player_id)));

        self::trace('promoteCardPlayerTurn->interPlayerTurn (passPromoteCard)');
        $this->gamestate->nextState('interPlayerTurn');
    }

    function promoteCard($card_id) {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('promoteCard');

        $originally_melded_card = self::getCardInfo($this->innovationGameState->get('melded_card_id'));
        $promoted_card = self::getCardInfo($card_id);
        $player_id = self::getCurrentPlayerId();

        if ($promoted_card === null || $promoted_card['owner'] != $player_id || $promoted_card['location'] != 'forecast') {
            self::throwInvalidChoiceException();
        }
        if ($promoted_card['age'] > $originally_melded_card['age']) {
            self::throwInvalidChoiceException();
        }

        try {
            self::transferCardFromTo($promoted_card, $player_id, "board");
        } catch (EndOfGame $e) {
            // End of the game: the exception has reached the highest level of code
            self::trace('EOG bubbled from self::promoteCard');
            self::trace('promoteCard->justBeforeGameEnd');
            $this->gamestate->nextState('justBeforeGameEnd');
            return;
        }
        $this->innovationGameState->set('melded_card_id', $card_id);

        self::incStat(1, 'promoted_number', $player_id);

        self::trace('promoteCardPlayerTurn->promoteDogmaPlayerTurn (promoteCard)');
        $this->gamestate->nextState('promoteDogmaPlayerTurn');
    }

    function promoteCardBack($owner, $location, $age, $type, $is_relic, $position) {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('promoteCard');

        $card = self::getCardInfoFromPosition($owner, $location, $age, $type, $is_relic, $position);
        if ($card === null) {
            self::throwInvalidChoiceException();
        }
        self::promoteCard($card['id']);
    }


    function passDogmaPromotedCard() {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('passDogmaPromotedCard');

        $player_id = self::getCurrentPlayerId();
        self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose not to dogma your promoted card.'), array('You' => 'You'));    
        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses not to dogma his promoted card.'), array('player_name' => self::getPlayerNameFromId($player_id)));

        self::trace('promoteDogmaPlayerTurn->interPlayerTurn (passDogmaPromotedCard)');
        $this->gamestate->nextState('interPlayerTurn');
    }

    function dogmaPromotedCard() {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('dogmaPromotedCard');

        $player_id = self::getCurrentPlayerId();
        self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to dogma your promoted card.'), array('You' => 'You'));    
        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to dogma his promoted card.'), array('player_name' => self::getPlayerNameFromId($player_id)));

        self::setUpDogma($player_id, self::getCardInfo($this->innovationGameState->get('melded_card_id')));

        self::trace('promoteDogmaPlayerTurn->dogmaEffect (dogmaPromotedCard)');
        $this->gamestate->nextState('dogmaEffect');
    }
    
    function achieve($age) {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('achieve');
        $player_id = self::getActivePlayerId();
        
        // Check if the player really meet the conditions to achieve that card
        $card = self::getObjectFromDB(self::format("SELECT * FROM card WHERE location = 'achievements' AND age = {age} AND owner = 0 LIMIT 1", array('age' => $age)));
        if ($card['owner'] != 0) {
            self::throwInvalidChoiceException();
        }
        
        $age_max = self::getMaxAgeOnBoardTopCards($player_id);
        $player_score = self::getPlayerScore($player_id);
        
        // Rule: to achieve the age X, the player has to have a top card of his board of age >= X and 5*X points in his score pile
        if ($age > $age_max || $player_score < 5*$age) {
            self::throwInvalidChoiceException();
        }
        
        // Stats
        self::updateActionAndTurnStats($player_id);
        self::incStat(1, 'achieve_actions_number', $player_id);
        
        // Execute the transfer
        try {
            self::transferCardFromTo($card, $player_id, "achievements");
        }
        catch (EndOfGame $e) {
            // End of the game: the exception has reached the highest level of code
            self::trace('EOG bubbled from self::achieve');
            self::trace('playerTurn->justBeforeGameEnd');
            $this->gamestate->nextState('justBeforeGameEnd');
            return;
        }
        
        // End of player action
        self::trace('playerTurn->interPlayerTurn (achieve)');
        $this->gamestate->nextState('interPlayerTurn');
    }
    
    function draw() {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('draw');
        $player_id = self::getActivePlayerId();
        
        // Stats
        self::updateActionAndTurnStats($player_id);
        self::incStat(1, 'draw_actions_number', $player_id);
        
        // Execute the draw
        try {
            self::executeDraw($player_id); // Draw a card with age consistent with player board
        }
        catch (EndOfGame $e) {
            // End of the game: the exception has reached the highest level of code
            self::trace('EOG bubbled from self::draw');
            self::trace('playerTurn->justBeforeGameEnd');
            $this->gamestate->nextState('justBeforeGameEnd');
            return;
        }
        // End of player action
        self::trace('playerTurn->interPlayerTurn (draw)');
        $this->gamestate->nextState('interPlayerTurn');
    }
    
    function meld($card_id) {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('meld');
        $player_id = self::getActivePlayerId();

        // Check if the player really has this card in their hand or on display
        $card = self::getCardInfo($card_id);
        if ($card['owner'] != $player_id || ($card['location'] != "hand" && $card['location'] != "display")) {
            self::throwInvalidChoiceException();
        }
        
        // Stats
        self::updateActionAndTurnStats($player_id);
        self::incStat(1, 'meld_actions_number', $player_id);
        
        // Execute the meld
        try {
            self::transferCardFromTo($card, $card['owner'], 'board');
        } catch (EndOfGame $e) {
            // End of the game: the exception has reached the highest level of code
            self::trace('EOG bubbled from self::meld');
            self::trace('playerTurn->justBeforeGameEnd');
            $this->gamestate->nextState('justBeforeGameEnd');
            return;
        }

        $this->innovationGameState->set('melded_card_id', $card['id']);
        
        // Execute city's icon effect
        if ($card['type'] == 2) {
            try {
            
                $top_middle_icon = $card['spot_6'];
                $bottom_middle_icon = $card['spot_3'];

                // NOTE: This logic relies on the (correct) assumption that the Plus/Arrow icons only appear in the top-middle or bottom-middle of cards.
                $icons_to_check = array($top_middle_icon, $bottom_middle_icon);
                for ($i = 0; $i < count($icons_to_check); $i++) {
                    switch ($icons_to_check[$i]) {
                        case 11: // Left Arrow: Splay the city's color left
                            self::splayLeft($player_id, $player_id, $card['color']);
                            break;
                        case 12: // Right Arrow: Splay the city's color right
                            self::splayRight($player_id, $player_id, $card['color']);
                            break;
                        case 13: // Up Arrow: Splay the city's color up
                            self::splayUp($player_id, $player_id, $card['color']);
                            break;
                        case 14: // Plus: Draw a card of value one higher than the city's age
                            self::executeDraw($player_id, $card['age'] + 1);
                            break;
                    }
                }

                // NOTE: This logic relies on the (correct) assumption that whenever there is a resource icon in the
                // top-midddle of the card, that means that it is a Search icon.
                if ($top_middle_icon >= 1 && $top_middle_icon <= 6) {
                    // Determine how many cards can be drawn.
                    $deck_count = self::countCardsInLocationKeyedByAge(0, 'deck', /*type=*/ 0);
                    $age_of_melded_card = $card['age'];
                    $num_cards_to_reveal = min($age_of_melded_card, $deck_count[$card['age']]);

                    if ($num_cards_to_reveal > 0) {
                        for ($i = 0; $i < $num_cards_to_reveal; $i++) {
                            self::executeDraw($player_id, $card['age'], 'revealed', /*bottom_to=*/ false, /*type=*/ 0);
                        }
                        if ($num_cards_to_reveal < $age_of_melded_card) {
                            self::notifyGeneralInfo(clienttranslate('The ${age} supply pile ran out of cards, so no more cards will be drawn.'), array('age' => self::getAgeSquareWithType($age_of_melded_card, /*type=*/ 0)));
                        }
                        self::notifyGeneralInfo(clienttranslate('The revealed cards with a ${icon} will be put in hand and the others will be returned.'), array('icon' => self::getIconSquare($top_middle_icon)));
                        $cards = self::getCardsInLocation($player_id, 'revealed');
                        foreach ($cards as $card) {
                            // Put matches in hand
                            if (self::hasRessource($card, $top_middle_icon)) {
                                self::transferCardFromTo($card, $player_id, 'hand');
                            }
                        }
                        // Return the ones which don't have a matching icon
                        $num_remaining_cards = self::countCardsInLocation($player_id, 'revealed');
                        if ($num_remaining_cards > 0) {
                            $options = array(
                                'player_id' => $player_id,
                                'n' => $num_remaining_cards,
                                'owner_from' => $player_id,
                                'location_from' => 'revealed',
                                'owner_to' => 0,
                                'location_to' => 'deck',
                            );
                            self::setSelectionRange($options);
                            self::trace('playerTurn->preSelectionMove');
                            $this->gamestate->nextState('preSelectionMove');
                            return;
                        }
                    } else {
                        self::notifyGeneralInfo(clienttranslate('The ${age} supply pile was empty, so no cards could be drawn.'), array('age' => self::getAgeSquareWithType($age_of_melded_card, /*type=*/ 0)));
                    }
                }
            } catch (EndOfGame $e) {
                // End of the game: the exception has reached the highest level of code
                self::trace('EOG bubbled from self::meld');
                self::trace('playerTurn->justBeforeGameEnd');
                $this->gamestate->nextState('justBeforeGameEnd');
                return;
            }
        }

        self::trace('playerTurn->digArtifact');
        $this->gamestate->nextState('digArtifact');
    }

    function stDigArtifact() {
        $player_id = self::getActivePlayerId();
        $melded_card = self::getCardInfo($this->innovationGameState->get('melded_card_id'));

        if ($this->innovationGameState->citiesExpansionEnabled()) {
            // "When you take a Meld action to meld a card that adds a new color to your board, draw a City" (unless you already have a Cities card in hand)
            if ($melded_card['position'] == 0 && self::countCardsInLocation($player_id, 'hand', /*type=*/ 2) == 0) {
                self::executeDraw($player_id, self::getAgeToDrawIn($player_id), 'hand', /*bottom_to=*/ false, /*type=*/ 2);
            }
        }

        if (self::tryToDigArtifactAndSeizeRelic($melded_card)) {
            self::trace('digArtifact->relicPlayerTurn');
            $this->gamestate->nextState('relicPlayerTurn');
            return;
        }
        self::trace('digArtifact->promoteCard');
        $this->gamestate->nextState('promoteCard');
    }

    function stPromoteCard() {
        if ($this->innovationGameState->echoesExpansionEnabled()) {
            $melded_card = self::getCardInfo($this->innovationGameState->get('melded_card_id'));
            $card_counts = self::countCardsInLocationKeyedByAge($melded_card['owner'], 'forecast');
            for ($age = 1; $age <= $melded_card['age']; $age++) {
                if ($card_counts[$age] > 0) {
                    self::trace('promoteCard->promoteCardPlayerTurn');
                    // Give the player extra time to decide which card to promote
                    self::giveExtraTime($melded_card['owner']);
                    $this->gamestate->nextState('promoteCardPlayerTurn');
                    return;
                }
            }
        }

        self::trace('promoteCard->interPlayerTurn');
        $this->gamestate->nextState('interPlayerTurn');
    }

    function claimSpecialAchievement($player_id, $achievement_id) {
        $achievement = self::getCardInfo($achievement_id);
        if ($achievement['owner'] == 0 && $achievement['location'] != 'removed') {
            self::transferCardFromTo($achievement, $player_id, 'achievements');
        } else {
            $card_args = self::getNotificationArgsForCardList([$achievement]);
            self::notifyAll('logWithCardTooltips', clienttranslate('${card} has already been claimed.'), ['card' => $card_args, 'card_ids' => [$achievement_id]]);
        }
    }
    
    /* Returns true if a relic is being seized */
    function tryToDigArtifactAndSeizeRelic($melded_card) {
        // The Artifacts expansion is not enabled.
        if (!$this->innovationGameState->artifactsExpansionEnabled()) {
            return false;
        }

        $player_id = $melded_card['owner'];
        $pile = self::getCardsInLocationKeyedByColor($player_id, 'board')[$melded_card['color']];
        if (count($pile) >= 2) {
            $previous_top_card = $pile[count($pile) - 2];
        } else {
            $previous_top_card = null;
        }

        // An Artifact is already on display.
        if (self::getArtifactOnDisplay($player_id) !== null) {
            return false;
        }
                
        // A dig happens when a card is covered with a card of lower or equal value, or both cards have their hexagonal icons in the same location.
        $new_card_has_lower_or_equal_value = $previous_top_card !== null && $previous_top_card['faceup_age'] >= $melded_card['faceup_age'];
        $overlapping_icons = $previous_top_card !== null && self::haveOverlappingHexagonIcons($previous_top_card, $melded_card);
        if ($new_card_has_lower_or_equal_value || $overlapping_icons) {
            
            // You first draw up through any empty ages (base cards) before looking at the relevant artifact pile.
            $age_draw = self::getAgeToDrawIn($player_id, $previous_top_card['faceup_age']);
            $top_artifact_card = self::getDeckTopCard($age_draw, /*type=*/ 1);
            
            if ($top_artifact_card == null) {
                self::notifyPlayer($player_id, "log", clienttranslate('There are no Artifact cards in the ${age} deck, so the dig event is ignored.'), array('age' => self::getAgeSquare($age_draw)));
            } else {
                self::transferCardFromTo($top_artifact_card, $player_id, 'display');
                self::incStat(1, 'dig_events_number', $player_id);
                
                // "After you dig an artifact, you may seize a Relic of the same value as the Artifact card drawn."
                if ($this->innovationGameState->artifactsExpansionEnabledWithRelics()) {
                    $relic = self::getRelicForAge($top_artifact_card['faceup_age']);
                    // "You may only do this if the Relic is next to its supply pile, or in any achievements pile (even your own!)."
                    if ($relic != null && (self::canSeizeRelicToHand($relic, $player_id) || self::canSeizeRelicToAchievements($relic, $player_id))) {
                        $this->innovationGameState->set('relic_id', $relic['id']);
                        return true;
                    }
                }
            }
        }
        return false;
    }

    function haveOverlappingHexagonIcons($card_1, $card_2) {
        return
            ($card_1['spot_1'] === '0' && $card_2['spot_1'] === '0') || 
            ($card_1['spot_2'] === '0' && $card_2['spot_2'] === '0') || 
            ($card_1['spot_3'] === '0' && $card_2['spot_3'] === '0') ||
            ($card_1['spot_4'] === '0' && $card_2['spot_4'] === '0') || 
            ($card_1['spot_5'] === '0' && $card_2['spot_5'] === '0') ||
            ($card_1['spot_6'] === '0' && $card_2['spot_6'] === '0');
    }

    /* Returns null if there is no relic of the specified age */
    function getRelicForAge($age) {
        return self::getObjectFromDB(self::format("SELECT * FROM card WHERE age = {age} AND is_relic", array('age' => $age)));
    }

    function dogma($card_id, $card_id_to_return) {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('dogma');
        $player_id = self::getActivePlayerId();
        
        $card = self::getCardInfo($card_id);

        $card_to_return = null;
        if ($card_id_to_return === null) {
            if ($card['owner'] != $player_id) {
                self::throwInvalidChoiceException();
            }
        } else {

            $card_to_return = self::getCardInfo($card_id_to_return);

            // The distance rule is only in effect when using the 4th edition
            if (!$this->innovationGameState->usingFourthEditionRules()) {
                self::throwInvalidChoiceException();
            }
            if ($card_to_return['owner'] != $player_id || $card_to_return['location'] != 'hand') {
                self::throwInvalidChoiceException();
            }
            $found_owner = false;
            foreach (self::getPlayerIdsAffectedByDistanceRule() as $opponent_id) {
                if ($card['owner'] == $opponent_id) {
                    $found_owner = true;
                    break;
                }
            }
            if (!$found_owner) {
                self::throwInvalidChoiceException();
            }
        }
        
        // Card is not at the top of a stack
        if (!self::isTopBoardCard($card)) {
            self::throwInvalidChoiceException();
        }
        // Battleship Yamato does not have any icons on it so it cannot be executed
        if ($card['dogma_icon'] == null) {
            self::throwInvalidChoiceException();
        }
        
        // Stats
        self::updateActionAndTurnStats($player_id);
        self::incStat(1, 'dogma_actions_number', $player_id);
        if ($card['type'] == 1) {
            self::incStat(1, 'dogma_actions_number_targeting_artifact_on_board', $player_id);
        }

        self::setUpDogma($player_id, $card, /*extra_icons_from_artifact_on_display=*/ 0, /*card_to_tuck=*/ null, $card_to_return);

        // Resolve the first dogma effect of the card
        self::trace('playerTurn->dogmaEffect (dogma)');
        $this->gamestate->nextState('dogmaEffect');
    }

    function endorse($card_to_endorse_id, $card_to_tuck_id) {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('endorse');

        // Ensure that the player still has an endorse action to use this turn
        if ($this->innovationGameState->get('endorse_action_state') == 0) {
            self::throwInvalidChoiceException();
        }

        $player_id = self::getActivePlayerId();
        $card_to_endorse = self::getCardInfo($card_to_endorse_id);

        // Check that the player really has this card on his board
        if ($card_to_endorse['owner'] != $player_id || $card_to_endorse['location'] != "board") {
            self::throwInvalidChoiceException();
        }
        // Card is not at the top of a stack
        if (!self::isTopBoardCard($card_to_endorse)) {
            self::throwInvalidChoiceException();
        }
        // Battleship Yamato does not have any icons on it so it cannot be executed
        if ($card_to_endorse['dogma_icon'] == null) {
            self::throwInvalidChoiceException();
        }

        // Check that the player really has a card to tuck
        $card_to_tuck = self::getCardInfo($card_to_tuck_id);
        if ($card_to_tuck['owner'] != $player_id || $card_to_tuck['location'] != "hand") {
            self::throwInvalidChoiceException();
        }

        // Make sure the endorsement is valid given this card being tucked
        $max_age_to_tuck = self::getMaxAgeToTuckForEndorse($card_to_endorse);
        if ($max_age_to_tuck == null || $card_to_tuck['age'] > $max_age_to_tuck) {
            self::throwInvalidChoiceException();
        }

        $this->innovationGameState->set('endorse_action_state', 2);

        try {
            // The tuck to pay for the Endorse action happens inside of setUpDogma
            self::setUpDogma($player_id, $card_to_endorse, /*extra_icons_from_artifact_on_display=*/ 0, $card_to_tuck);
        } catch (EndOfGame $e) {
            // End of the game: the exception has reached the highest level of code
            self::trace('EOG bubbled from self::endorse');
            self::trace('playerTurn->justBeforeGameEnd');
            $this->gamestate->nextState('justBeforeGameEnd');
            return;
        }

        // Resolve the first dogma effect of the card
        self::trace('playerTurn->dogmaEffect (dogma)');
        $this->gamestate->nextState('dogmaEffect');
    }

    function updateActionAndTurnStats($player_id) {
        if ($this->innovationGameState->get('current_action_number') == 1) {
            self::incStat(1, 'turns_number');
            self::incStat(1, 'turns_number', $player_id);
        }
        self::incStat(1, 'actions_number');
        self::incStat(1, 'actions_number', $player_id);
    }

    function increaseResourcesForArtifactOnDisplay($player_id, $card) {
        // Battleship Yamato does not have any icons on it
        if ($card['dogma_icon'] == null) {
            $resource_icon = null;
            $resource_count_delta = 0;
        } else {
            $resource_icon = $card['dogma_icon'];
            $resource_count_delta = self::countIconsOnCard($card, $resource_icon);
        }
        self::updateResourcesForArtifactOnDisplay($player_id, $resource_icon, $resource_count_delta);
    }

    function decreaseResourcesForArtifactOnDisplay($player_id, $card) {
        // Battleship Yamato does not have any icons on it
        if ($card['dogma_icon'] == null) {
            $resource_icon = null;
            $resource_count_delta = 0;
        } else {
            $resource_icon = $card['dogma_icon'];
            $resource_count_delta = -self::countIconsOnCard($card, $resource_icon);
        }
        self::updateResourcesForArtifactOnDisplay($player_id, $resource_icon, $resource_count_delta);
    }

    function updateResourcesForArtifactOnDisplay($player_id, $resource_icon, $resource_count_delta) {
        self::notifyAll('updateResourcesForArtifactOnDisplay', '', array(
            'player_id' => $player_id,
            'resource_icon' => $resource_icon,
            'resource_count_delta' => $resource_count_delta,
        ));
    }
    
    function setUpDogma($player_id, $card, $extra_icons_from_artifact_on_display = 0, $card_to_tuck = null, $card_to_return = null) {

        self::notifyDogma($card);

        if ($card_to_return != null) {
            try {
                self::returnCard($card_to_return, $player_id);
            } catch (EndOfGame $e) {
                self::trace('EOG bubbled from self::setUpDogma');
                throw $e; // Re-throw exception to higher level
            }
        }

        if ($card_to_tuck != null) {
            try {
                self::tuckCard($card_to_tuck, $player_id);
            } catch (EndOfGame $e) {
                self::trace('EOG bubbled from self::setUpDogma');
                throw $e; // Re-throw exception to higher level
            }
        }
        
        $dogma_icon = $card['dogma_icon'];
        $ressource_column = 'player_icon_count_' . $dogma_icon;
        
        $players = self::getCollectionFromDB(self::format("SELECT player_id, player_no, player_team, {ressource_column} FROM player", array('ressource_column' => $ressource_column)));
        $players_nb = count($players);
        
        // Compare players ressources on dogma icon_count;
        $dogma_player = $players[$player_id];
        $dogma_player_team = $dogma_player['player_team'];
        $dogma_player_ressource_count = $dogma_player[$ressource_column] + $extra_icons_from_artifact_on_display;
        $dogma_player_no = $dogma_player['player_no'];
        
        // Count each player ressources
        $players_ressource_count = array();
        foreach ($players as $id => $player) {
            $player_no = $player['player_no'];
            $player_ressource_count = $id == $player_id ? $dogma_player_ressource_count : $player[$ressource_column];
            $players_ressource_count[$player_no] = $player_ressource_count;
            $players_teams[$player_no] = $player['player_team'];
            
            self::notifyPlayerRessourceCount($id, $dogma_icon, $player_ressource_count);
            self::DBQuery(self::format("
                UPDATE 
                    player
                SET
                    featured_icon_count = {featured_icon_count}
                WHERE
                    player_id = {player_id}"
            ,
                array('featured_icon_count' => $player_ressource_count, 'player_id' => $id)
            ));
        }

        $visible_echo_effects = self::getCardsWithVisibleEchoEffects($card);
        if (!empty($visible_echo_effects)) {
            $current_effect_type = 3; // echo
            $current_effect_number = count($visible_echo_effects);
            for ($i = count($visible_echo_effects); $i >= 1; $i--) {
                self::DbQuery(self::format("
                    INSERT INTO echo_execution
                        (nesting_index, execution_index, card_id)
                    VALUES
                        (0, {execution_index}, {card_id})
                ", array('execution_index' => $i, 'card_id' => $visible_echo_effects[$i - 1])));
            }
        } else if (self::getDemandEffect($card['id']) == null) {
            $current_effect_type = 1; // non-demand
            $current_effect_number = 1;
        } else if (self::isCompelEffect($card['id'])) {
            $current_effect_type = 2; // I compel
            $current_effect_number = 1;
        } else {
            $current_effect_type = 0; // I demand
            $current_effect_number = 1;
        }
        
        // Write info in global variables to prepare the first effect
        if ($this->innovationGameState->get('release_version') >= 2) {
            self::DbQuery("DELETE FROM indexed_auxiliary_value"); // Empty indexed_auxiliary_value table
        }
        $this->innovationGameState->set('current_nesting_index', 0);
        self::DbQuery(
            self::format("
                UPDATE
                    nested_card_execution
                SET
                    card_id = {card_id},
                    executing_as_if_on_card_id = {card_id},
                    card_location = '{card_location}',
                    launcher_id = {launcher_id},
                    current_effect_type = {effect_type},
                    current_effect_number = {effect_number},
                    post_execution_index = 0
                WHERE
                    nesting_index = 0",
                array('card_id' => $card['id'], 'card_location' => $card['location'], 'launcher_id' => $player_id, 'effect_type' => $current_effect_type, 'effect_number' => $current_effect_number))
        );
        $this->innovationGameState->set('sharing_bonus', 0);
    }

    function choose($card_id) {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('choose');
        $player_id = self::getActivePlayerId();
        
        if ($card_id == -1) {
            // The player chooses to pass or stop
            if ($this->innovationGameState->get('can_pass') == 0 && $this->innovationGameState->get('n_min') > 0) {
                self::throwInvalidChoiceException();
            }
            if ($this->innovationGameState->get('special_type_of_choice') == 0) {
                $this->innovationGameState->set('id_last_selected', -1);
            } else {
                $this->innovationGameState->set('choice', -2);
            }
        } else if ($this->innovationGameState->get('special_type_of_choice') != 0) {
            self::throwInvalidChoiceException();
        } else {
            // Check if the card is within the selection range
            $card = self::getCardInfo($card_id);
            
            if (!$card['selected']) {
                self::throwInvalidChoiceException();
            }
            
            $this->innovationGameState->set('id_last_selected', $card_id);
            self::unmarkAsSelected($card_id);
            
            // Passing is only possible at the beginning of the step
            $this->innovationGameState->set('can_pass', 0);
        }
        
        // Return to the resolution of the effect
        self::trace('selectionMove->interSelectionMove (choose)');
        $this->gamestate->nextState('interSelectionMove');
    }
    
    function chooseRecto($owner, $location, $age, $type, $is_relic, $position) {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('choose');
        $players = array_keys(self::loadPlayersBasicInfos());
        $player_id = self::getActivePlayerId();
        if ($this->innovationGameState->get('special_type_of_choice') != 0) {
            self::throwInvalidChoiceException();
        }
        if ((!in_array($owner, $players) && $owner != 0) || !in_array($location, self::getObjectListFromDB("SELECT DISTINCT location FROM card", true)) || $age < 1 || $age > 11) {
            self::throwInvalidChoiceException();
        }
        
        $card = self::getCardInfoFromPosition($owner, $location, $age, $type, $is_relic, $position);
        if ($card === null) {
            self::throwInvalidChoiceException();
        }
        if (!$card['selected']) {
            self::throwInvalidChoiceException();
        }

        $this->innovationGameState->set('id_last_selected', $card['id']);
        self::unmarkAsSelected($card['id']);
        
        // Passing is only possible at the beginning of the step
        $this->innovationGameState->set('can_pass', 0);
        
        // Return to the resolution of the effect
        self::trace('selectionMove->interSelectionMove (chooseRecto)');
        $this->gamestate->nextState('interSelectionMove');
    }
    
    function chooseSpecialOption($choice) {
        // Check that this is the player's turn and that it is a "possible action" at this game state
        self::checkAction('choose');
        $player_id = self::getActivePlayerId();
        
        $special_type_of_choice = $this->innovationGameState->get('special_type_of_choice');
        
        if ($special_type_of_choice == 0) { // This is not a special choice
            self::throwInvalidChoiceException();
        }
        
        switch(self::decodeSpecialTypeOfChoice($special_type_of_choice)) {
            case 'choose_value':
                if (!ctype_digit($choice) || !in_array($choice, $this->innovationGameState->getAsArray('age_array'))) {
                    self::throwInvalidChoiceException();
                }
                break;
            case 'choose_non_negative_integer':
                if (!ctype_digit($choice) || $choice < 0 || $choice > 1000) {
                    self::throwInvalidChoiceException();
                }
                break;
            case 'choose_color':
                if (!ctype_digit($choice) || !in_array($choice, $this->innovationGameState->getAsArray('color_array'))) {
                    self::throwInvalidChoiceException();
                }
                break;
            case 'choose_two_colors':
                if (!ctype_digit($choice) || $choice < 0) {
                    self::throwInvalidChoiceException();
                }
                $colors = Arrays::getValueAsArray($choice);
                if (count($colors) <> 2 || $colors[0] == $colors[1] || !in_array($colors[0], $this->innovationGameState->getAsArray('color_array')) || !in_array($colors[1], $this->innovationGameState->getAsArray('color_array'))) {
                    self::throwInvalidChoiceException();
                }
                break;
            case 'choose_three_colors':
                if (!ctype_digit($choice) || $choice < 0) {
                    self::throwInvalidChoiceException();
                }
                $colors = Arrays::getValueAsArray($choice);
                $allowed_color_choices = $this->innovationGameState->getAsArray('color_array');
                if (count($colors) <> 3 || count(array_unique($colors)) <> 3 || !in_array($colors[0], $allowed_color_choices) || !in_array($colors[1], $allowed_color_choices) || !in_array($colors[2], $allowed_color_choices)) {
                    self::throwInvalidChoiceException();
                }
                break;
            case 'choose_player':
                if (!ctype_digit($choice)) {
                    self::throwInvalidChoiceException();
                }
                $player_no = self::getUniqueValueFromDB(self::format("SELECT player_no FROM player WHERE player_id = {player_id}", array('player_id' => $choice)));
                if ($player_no == null || !in_array($player_no, $this->innovationGameState->getAsArray('player_array'))) {
                    self::throwInvalidChoiceException();
                }
                break;
            case 'choose_rearrange':
                // Choice contains the color and the permutations made
                if (!is_array($choice) || !array_key_exists('color', $choice)) {
                    self::throwInvalidChoiceException();
                }
                $color = $choice['color'];
                if (!ctype_digit($color) || $color < 0 || $color > 4) {
                    self::throwInvalidChoiceException();
                }
                if (!array_key_exists('permutations_done', $choice)) {
                    self::throwInvalidChoiceException();
                }
                $permutations_done = $choice['permutations_done'];
                if (!is_array($permutations_done) || count($permutations_done) == 0) {
                    self::throwInvalidChoiceException();
                }
                $n = self::countCardsInLocationKeyedByColor($player_id, 'board');
                $n = $n[$color];
                
                foreach($permutations_done as $permutation) {
                    if (!array_key_exists('position', $permutation)) {
                        self::throwInvalidChoiceException();
                    }
                    $position = $permutation['position'];
                    if (!array_key_exists('delta', $permutation)) {
                        self::throwInvalidChoiceException();
                    }
                    $delta = $permutation['delta'];
                    if ($delta <> 1 && $delta <> -1) {
                        self::throwInvalidChoiceException();
                    }
                    if (!ctype_digit($position) || $position >= $n || $position + $delta >= $n) {
                        self::throwInvalidChoiceException();
                    }
                }
                
                // Do the rearrangement now
                $actual_change = self::rearrange($player_id, $color, $permutations_done);
                
                if (!$actual_change) {
                    self::throwInvalidChoiceException();
                }

                // Update max age on board in case it changed
                $new_max_age_on_board = self::getMaxAgeOnBoardTopCards($player_id);
                self::setStat($new_max_age_on_board, 'max_age_on_board', $player_id);

                self::notifyPlayer($player_id, 'rearrangedPile', clienttranslate('${You} rearrange your ${color} stack.'), array(
                    'i18n' => array('color'),
                    'player_id' => $player_id,
                    'new_max_age_on_board' => $new_max_age_on_board,
                    'rearrangement' => $choice,
                    'You' => 'You',
                    'color' => self::getColorInClear($color)
                ));
                self::notifyAllPlayersBut($player_id, 'rearrangedPile', clienttranslate('${player_name} rearranges his ${color} stack.'), array(
                    'i18n' => array('color'),
                    'player_id' => $player_id,
                    'new_max_age_on_board' => $new_max_age_on_board,
                    'rearrangement' => $choice,
                    'player_name' => self::getColoredPlayerName($player_id),
                    'color' => self::getColorInClear($color))
                );

                $end_of_game = false;

                try {
                    self::updateFlagsAndFountains();
                } catch(EndOfGame $e) {
                    $end_of_game = true;
                }

                try {
                    self::checkForSpecialAchievements();
                } catch(EndOfGame $e) {
                    $end_of_game = true;
                }

                if ($end_of_game) {
                    self::trace('EOG bubbled from self::chooseSpecialOption');
                    self::trace('selectionMove->justBeforeGameEnd');
                    $this->gamestate->nextState('justBeforeGameEnd');
                    return;
                }

                $choice = 1;
                break;
            case 'choose_yes_or_no':
                // Yes/no choice
                if ($choice != 0 && $choice != 1) {
                    self::throwInvalidChoiceException();
                }
                break;
            case 'choose_type':
                if (!ctype_digit($choice) || !in_array($choice, $this->innovationGameState->getAsArray('type_array'))) {
                    self::throwInvalidChoiceException();
                }
                break;
            case 'choose_icon_type':
                if (!ctype_digit($choice) || !in_array($choice, $this->innovationGameState->getAsArray('icon_array'))) {
                    self::throwInvalidChoiceException();
                }
                break;
            default:
                break;
        }
        $this->innovationGameState->set('choice', $choice);
        
        // Return to the resolution of the effect
        self::trace('selectionMove->interSelectionMove (chooseSpecialOption)');
        $this->gamestate->nextState('interSelectionMove');
    }
    
    function updateDisplayMode($display_mode) {
        $player_id = self::getCurrentPlayerId();
        self::setPlayerWishForSplay($player_id, $display_mode);
        self::notifyPlayer($player_id, 'log', '', array());
    }
    
    function updateViewFull($view_full) {
        $player_id = self::getCurrentPlayerId();
        self::setPlayerWishForViewFull($player_id, $view_full);
        self::notifyPlayer($player_id, 'log', '', array());
    }

    function throwInvalidChoiceException() {
        throw new BgaUserException(self::_("Your choice was invalid (try refreshing the page)"));
    }
    
//////////////////////////////////////////////////////////////////////////////
//////////// Game state arguments
////////////

    /*
        Here, you can create methods defined as "game state arguments" (see "args" property in states.inc.php).
        These methods function is to return some additional information that is specific to the current
        game state.
    */

    /*
    
    Example for game state "MyGameState":
    
    function argMyGameState()
    {
        // Get some values from the current game situation in database...
    
        // return values:
        return array(
            'variable1' => $value1,
            'variable2' => $value2,
            ...
       );
    } 
    */
    function argTurn0() {
        if (self::decodeGameType($this->innovationGameState->get('game_type')) == 'team') {
            // Indicate what the teams are
            $messages = array();
            foreach(self::loadPlayersBasicInfos() as $player_id => $player) {
                $teammate_id = self::getPlayerTeammate($player_id);
                $teammate_name = self::getPlayerNameFromId($teammate_id);
                $message = self::format(clienttranslate('{You} are in team with {player_name}.'), array('You' => 'You', 'player_name' => self::getColoredText($teammate_name, $teammate_id)));
                $messages[$player_id] = $message;
            }
            return array('team_game' => true, 'messages' => $messages);
        }
        return array('team_game' => false);
    }

    function argRelicPlayerTurn() {
        $player_id = $this->innovationGameState->get('active_player');
        $relic = self::getCardInfo($this->innovationGameState->get('relic_id'));
        return array(
            'can_seize_to_hand' => self::canSeizeRelicToHand($relic, $player_id),
            'can_seize_to_achievements' => self::canSeizeRelicToAchievements($relic, $player_id),
            'relic_id' => $relic['id'],
            'relic_name' => self::getNotificationArgsForCardList(array($relic)),
        );
    }

    function canSeizeRelicToHand($relic, $player_id) {
        return self::relicSetIsInUse($relic) && ($relic['location'] == 'achievements' || $relic['location'] == 'relics');
    }

    function canSeizeRelicToAchievements($relic, $player_id) {
        return $relic['location'] == 'relics' || ($relic['location'] == 'achievements' && $relic['owner'] != $player_id);
    }

    /* Returns whether the relic's set is being used for this game. */
    function relicSetIsInUse($relic) {
        switch ($relic['type']) {
            // Base set
            case 0:
                return true;
            case 1:
                return $this->innovationGameState->artifactsExpansionEnabled();
            case 2:
                return $this->innovationGameState->citiesExpansionEnabled();
            case 3:
                return $this->innovationGameState->echoesExpansionEnabled();
            // TODO(FIGURES): Add another case when we implement this expansion.
            default:
                return false;
        }
    }

    function argPlayerArtifactTurn() {
        $player_id = $this->innovationGameState->get('active_player');
        $card = self::getArtifactOnDisplay($player_id);
        return array(
            '_private' => array(
                'active' => array( // "Active" player only
                    "dogma_effect_info" => array($card['id'] => self::getDogmaEffectInfo($card, $player_id, /*is_on_display=*/ true)),
                )
            )
        );
    }

    function argPromoteCardPlayerTurn() {
        return [
            "max_age_to_promote" => self::getCardInfo($this->innovationGameState->get('melded_card_id'))['age'],
        ];
    }

    function argDogmaPromotedCardPlayerTurn() {
        return [
            "promoted_card_id" => $this->innovationGameState->get('melded_card_id'),
        ];
    }

    function argPlayerTurn() {
        $player_id = $this->innovationGameState->get('active_player');
        // In the 4th edition, a card can be returned in order to dogma a top card on a non-adjacent player's board
        $non_adjacent_player_ids = self::countCardsInHand($player_id) > 0 ? self::getPlayerIdsAffectedByDistanceRule() : [];
        $age_to_draw = self::getAgeToDrawIn($player_id);
        return array(
            'i18n' => array('qualified_action'),
            'action_number' => $this->innovationGameState->get('first_player_with_only_one_action') || $this->innovationGameState->get('second_player_with_only_one_action') || $this->innovationGameState->get('has_second_action') ? 1 : 2,

            'qualified_action' => $this->innovationGameState->get('first_player_with_only_one_action') || $this->innovationGameState->get('second_player_with_only_one_action') ? clienttranslate('a single action') :
                                  ($this->innovationGameState->get('has_second_action') ? clienttranslate('a first action') : clienttranslate('a second action')),
            'age_to_draw' => $age_to_draw,
            'type_to_draw' => self::getCardTypeToDraw($age_to_draw, $player_id),
            'claimable_ages' => self::getClaimableAges($player_id),
            'city_draw_falls_back_to_other_type' => $age_to_draw > 11 ? false : self::countCardsInLocationKeyedByAge(0, 'deck', /*type=*/ 2)[$age_to_draw] == 0,
            '_private' => array(
                'active' => array( // "Active" player only
                    "non_adjacent_player_ids" => $non_adjacent_player_ids,
                    "dogma_effect_info" => self::getDogmaEffectInfoOfTopCards($player_id, $non_adjacent_player_ids),
                    "meld_info" => self::getMeldInfo($player_id),
                )
            )
        );
    }

    function getMeldInfo($player_id) {
        $info_by_card_id = array();
        
        // Get list iof cards which can be melded right now
        $cards_which_can_be_melded = self::getCardsInLocation($player_id, 'hand');
        $artifact = self::getArtifactOnDisplay($player_id);
        if ($artifact !== null) {
            $cards_which_can_be_melded[] = $artifact; 
        }

        // Identify which cards will trigger a City draw when melded
        $cities_expansion_enabled = $this->innovationGameState->citiesExpansionEnabled();
        $pile_size_counts = self::countCardsInLocationKeyedByColor($player_id, 'board');
        $num_cities_in_hand = self::countCardsInLocation($player_id, 'hand', /*type=*/ 2);
        foreach ($cards_which_can_be_melded as $card) {
            $no_cities_in_hand_after_meld = $num_cities_in_hand == 0 || ($num_cities_in_hand == 1 && $card['type'] == 2);
            $info_by_card_id[$card['id']] = [
                'triggers_city_draw' => $cities_expansion_enabled && $pile_size_counts[$card['color']] == 0 && $no_cities_in_hand_after_meld,
            ];
        }

        return $info_by_card_id;
    }

    /** Returns the ages that are currently claimable from the standard achievements pile */
    function getClaimableAges($player_id) {
        $claimable_ages = array();
        $unclaimed_achievement_count = self::countCardsInLocationKeyedByAge(0, 'achievements');
        foreach (self::getClaimableAgesIgnoringAvailability($player_id) as $age) {
            if ($unclaimed_achievement_count[$age] > 0) {
                $claimable_ages[] = $age;
            }
        }
        return $claimable_ages;
    }

    /** Returns the ages that would be claimable (ignoring whether they actually exist in the standard achievements pile) */
    function getClaimableAgesIgnoringAvailability($player_id) {
        $age_max = self::getMaxAgeOnBoardTopCards($player_id);
        $player_score = self::getPlayerScore($player_id);
        $claimed_achievement_count = self::countCardsInLocationKeyedByAge($player_id, 'achievements', $type=null, $is_relic=false);
        
        $claimable_ages = array();
        for ($age = 1; $age <= 11; $age++) {
            // Rule: to achieve the age X, the player has to have a top card of his board of age >= X and 5*X points in his score pile
            if ($age <= $age_max && $player_score >= 5 * $age * ($claimed_achievement_count[$age] + 1)) {
                $claimable_ages[] = $age;
            }
        }
        return $claimable_ages;
    }

    /** Returns dogma effect information about the top cards belonging to the specified player or non-adjacent players. */
    function getDogmaEffectInfoOfTopCards($launcher_id, $non_adjacent_player_ids=[]) {
        $dogma_effect_info = array();
        foreach (self::getTopCardsOnBoard($launcher_id) as $top_card) {
            $dogma_effect_info[$top_card['id']] = self::getDogmaEffectInfo($top_card, $launcher_id);
        }
        foreach ($non_adjacent_player_ids as $player_id) {
            foreach (self::getTopCardsOnBoard($player_id) as $top_card) {
                $dogma_effect_info[$top_card['id']] = self::getDogmaEffectInfo($top_card, $launcher_id);
            }
        }
        return $dogma_effect_info;
    }

    /** Returns dogma effect information of the specified card. */
    function getDogmaEffectInfo($card, $launcher_id, $is_on_display = false) {
        $dogma_effect_info = array();

        // Battleship Yamato does not have any icons on it so it cannot be executed
        if ($card['dogma_icon'] == null) {
            return $dogma_effect_info;
        }

        $dogma_icon = $card['dogma_icon'];
        $resource_column = 'player_icon_count_' . $dogma_icon;
        $extra_icons = $is_on_display ? self::countIconsOnCard($card, $dogma_icon) : 0;

        $players_executing_i_compel_effects = [];
        $players_executing_i_demand_effects = [];
        $players_executing_non_demand_effects = [];
        $players_executing_echo_effects = [];

        if (self::isCompelEffect($card['id']) === true) {
            $players_executing_i_compel_effects =
                self::getObjectListFromDB(self::format("
                    SELECT
                        player_id
                    FROM
                        player
                    WHERE
                        {col} >= {extra_icons} + (SELECT {col} FROM player WHERE player_id = {launcher_id})
                        AND player_team <> (SELECT player_team FROM player WHERE player_id = {launcher_id})
                        AND player_eliminated = 0
                ", array('col' => $resource_column, 'launcher_id' => $launcher_id, 'extra_icons' => $extra_icons)), true);
        } else if (self::getDemandEffect($card['id']) !== null) { 
            $players_executing_i_demand_effects =
                self::getObjectListFromDB(self::format("
                        SELECT
                            player_id
                        FROM
                            player
                        WHERE
                            {col} < {extra_icons} + (SELECT {col} FROM player WHERE player_id = {launcher_id})
                            AND player_team <> (SELECT player_team FROM player WHERE player_id = {launcher_id})
                            AND player_eliminated = 0
                    ", array('col' => $resource_column, 'launcher_id' => $launcher_id, 'extra_icons' => $extra_icons)), true);
        }

        // NOTE: We slightly abuse the term "sharing" here since the following can include a player's teammate (even though
        // that wouldn't trigger a sharing bonus)
        $sharing_players =
            self::getObjectListFromDB(self::format("
                    SELECT
                        player_id
                    FROM
                        player
                    WHERE
                        player_id = {launcher_id} OR {col} >= {extra_icons} + (SELECT {col} FROM player WHERE player_id = {launcher_id})
                        AND player_eliminated = 0
                ", array('col' => $resource_column, 'launcher_id' => $launcher_id, 'extra_icons' => $extra_icons)), true);
        $card_ids_with_visible_echo_effects = self::getCardsWithVisibleEchoEffects($card);
        $dogma_effect_info['num_echo_effects'] = count($card_ids_with_visible_echo_effects);
        if (self::getNonDemandEffect($card['id'], 1) !== null) {
            $players_executing_non_demand_effects = $sharing_players;
        }
        if ($dogma_effect_info['num_echo_effects'] > 0) {
            $players_executing_echo_effects = $sharing_players;
        }

        // NOTE: No-op detection is best effort. If in doubt, we assume it will have an effect.
        $players_with_no_effect = [];
        $effective_sharing_players = [];
        $active_players = self::getAllActivePlayerIds();
        foreach ($active_players as $player_id) {
            $no_effect = true;
            if (in_array($player_id, $players_executing_non_demand_effects) || in_array($player_id, $players_executing_echo_effects)) {
                $no_effect = $no_effect && self::sharingHasNoEffect($card, $launcher_id, $player_id, $card_ids_with_visible_echo_effects);
                if (!$no_effect) {
                    $effective_sharing_players[] = $player_id;
                }
            }
            if (in_array($player_id, $players_executing_i_compel_effects)) {
                $no_effect = $no_effect && self::compelHasNoEffect($card, $launcher_id, $player_id);
            }
            if (in_array($player_id, $players_executing_i_demand_effects)) {
                $no_effect = $no_effect && self::demandHasNoEffect($card, $launcher_id, $player_id);
            }
            if ($no_effect) {
                $players_with_no_effect[] = $player_id;
            }
        }

        $dogma_effect_info['players_executing_i_demand_effects'] = $players_executing_i_demand_effects;
        $dogma_effect_info['players_executing_i_compel_effects'] = $players_executing_i_compel_effects;
        $dogma_effect_info['players_executing_non_demand_effects'] = $players_executing_non_demand_effects;
        $dogma_effect_info['players_executing_echo_effects'] = $players_executing_echo_effects;
        $dogma_effect_info['sharing_players'] = $effective_sharing_players;
        $dogma_effect_info['no_effect'] = count($players_with_no_effect) == count($active_players);
        $dogma_effect_info['on_non_adjacent_board'] = $card['owner'] != $launcher_id;

        if ($this->innovationGameState->get('endorse_action_state') == 1 && !$is_on_display) {
            $max_age_to_tuck_for_endorse = self::getMaxAgeToTuckForEndorse($card);
            $can_endorse = false;
            if ($max_age_to_tuck_for_endorse != null) {
                foreach (self::getCardsInHand($launcher_id) as $card_in_hand) {
                    if ($card_in_hand['age'] <= $max_age_to_tuck_for_endorse) {
                        $can_endorse = true;
                        break;
                    }
                }
            }
            if ($can_endorse) {
                $dogma_effect_info['max_age_to_tuck_for_endorse'] = $max_age_to_tuck_for_endorse;
            }
        }

        return $dogma_effect_info;
    }

    /** Returns the maximum age card that can be tucked in order to endorse the card, or null if there are no City cards matching the featured icon. */
    function getMaxAgeToTuckForEndorse($card) {
        // Battleship Yamato does not have any icons on it so it cannot be executed
        $dogma_icon = $card['dogma_icon'];
        if ($dogma_icon == null) {
            return null;
        }
        // To take an Endorse action, perform the following steps:
        // 1) Choose the top card on your board that you want to Endorse, and note its featured icon.
        // 2) Choose a top city on your board. It must have the featured icon on it.
        // 3) Pay for the Endorse action by tucking a card from your hand of equal or lower value to
        //    the city you chose. The tucked card’s color and icons are irrelevant.
        $highest_city_with_featured_icon = null;
        foreach (self::getTopCardsOnBoard($card['owner']) as $top_card) {
            if ($top_card['type'] == 2 && self::hasRessource($top_card, $dogma_icon)) {
                if ($highest_city_with_featured_icon == null || $top_card['age'] > $highest_city_with_featured_icon) {
                    $highest_city_with_featured_icon = $top_card['age'];
                }
            }
        }
        return $highest_city_with_featured_icon;
    }

    /** Returns true if the dogma is guaranteed to have no effect when the specified player executes the non-demand and echo effects (without revealing hidden info to the launching player). */    
    function sharingHasNoEffect($card, $launcher_id, $executing_player_id, $card_ids_with_visible_echo_effects) {

        // Check all echo effects that will be executed
        foreach ($card_ids_with_visible_echo_effects as $card_id) {
            // NOTE: All cards with echo effects must be included in this switch statement, otherwise it breaks the logic
            // farther down in this method. Also, we can't return true anywhere here, since an echo effect is not the only
            // thing being executed.
            switch ($card_id) {
                case 219: // Safety Pin
                case 331: // Perfume
                case 332: // Ruler
                case 339: // Chopsticks
                case 345: // Lever
                case 346: // Linguistics
                case 348: // Horseshoes
                case 355: // Almanac
                case 356: // Magnifying Glass
                case 359: // Charitable Trust
                case 361: // Deoderant
                case 363: // Novel
                case 366: // Telescope
                case 372: // Pencil
                case 374: // Toilet
                case 375: // Lightning Rod
                case 377: // Coke
                case 385: // Bifocals
                case 389: // Hot Air Balloon
                case 391: // Dentures
                case 398: // Rubber
                case 399: // Jeans
                case 410: // Sliced Bread
                case 406: // X-Ray
                case 412: // Tractor
                case 414: // Television
                case 419: // Credit Card
                case 420: // Email
                case 421: // ATM
                case 423: // Karaoke
                    // These cards always have an effect.
                    return false;

                case 334: // Candles
                case 335: // Plumbing
                case 343: // Flute
                case 350: // Scissors
                case 367: // Kobukson
                case 371: // Barometer
                case 373: // Clock
                case 376: // Thermometer
                case 382: // Stove
                case 384: // Tuning Fork
                case 387: // Loom
                case 395: // Photography
                case 397: // Machine Gun
                case 401: // Elevator
                case 403: // Ice Cream
                case 422: // Wristwatch
                    // These cards sometimes have an effect. Until we add more granular logic for these cards, we will
                    // assume the cards have an effect.
                    return false;

                case 383: // Piano
                    // This card has no effect if all players have empty hands.
                    foreach (self::getAllActivePlayerIds() as $player_id) {
                        if (self::countCardsInLocation($player_id, 'hand') > 0) {
                            return false;
                        }
                    }
                    break;

                case 333: // Bangle
                case 338: // Umbrella
                case 342: // Bell
                case 349: // Glassblowing
                case 351: // Toothbrush
                case 364: // Sunglasses
                case 386: // Stethoscope
                case 392: // Morphine
                case 407: // Bandage
                case 411: // Air Conditioner
                case 418: // Jet
                    // These echo effects have no effect if the player has an empty hand.
                    if (self::countCardsInLocation($executing_player_id, 'hand') > 0) {
                        return false;
                    }
                    break;
            }
        }

        // Many cards do not have a non-demand effect on them
        if (self::getNonDemandEffect($card['id'], 1) == null) {
            return true;
        }

        // Check the card's non-demand effects
        // NOTE: There is no point in adding any cases for cards which have an echo effect which ALWAYS has an effect (e.g. "Draw a 2"),
        // but for the sake of completeness, it also doesn't hurt to add them below (even though they will never get executed).
        switch ($card['id']) {

            // TODO(FIGURES): Add cases.

            /*** Non-demand effects which read "No effect." ***/

            case 332: // Ruler
            case 335: // Plumbing
            case 344: // Puppet
                return true;

            /*** Cases where the execution of the non-demand depends on an earlier demand ***/

            case 20: // Mapmaking
            case 38: // Gunpowder
            case 48: // The Pirate Code
            case 62: // Vaccination
                // We can ignore these non-demand effect, because if the demand has no effect, then this won't either.
                return false;

            /*** Basic cases involving empty hands and/or empty score piles ***/

            case 1: // Tools
            case 9: // Agriculture
            case 13: // Code of Laws
            case 16: // Mathematics
            case 18: // Road Building
            case 19: // Currency
            case 42: // Perspective
            case 50: // Measurement
            case 59: // Classification
            case 63: // Democracy
            case 71: // Refrigeration
            case 73: // Lighting
            case 75: // Quantum Theory
            case 81: // Antibiotics
            case 84: // Socialism
            case 91: // Ecology
            case 92: // Suburbia
            case 97: // Miniaturization
            case 102: // Stem Cells
            case 114: // Papyrus of Ani
            case 120: // Lurgan Canoe
            case 121: // Xianrendong Shards
            case 130: // Baghdad Battery
            case 131: // Holy Grail
            case 136: // Charter of Liberties
            case 139: // Philosopher's Stone
            case 144: // Shroud of Turin
            case 153: // Cross of Coronado
            case 164: // Almira, Queen of the Castle
            case 174: // Marcha Real
            case 182: // Singer Model 27
            case 216: // Complex Numbers
            case 338: // Umbrella
            case 341: // Soap
            case 347: // Crossbow
            case 352: // Watermill
            case 362: // Sandpaper
            case 370: // Globe
            case 372: // Pencil
            case 384: // Tuning Fork
                // These non-demand effects have no effect if the player has an empty hand.
                return self::countCardsInLocation($executing_player_id, 'hand') == 0;

            case 33: // Education
            case 56: // Encyclopedia
            case 146: // Delft Pocket Telescope
            case 217: // Newton‑Wickins Telescope
            case 401: // Elevator
            case 430: // Flash Drive
                // These non-demand effects have no effect if the player has an empty score pile.
                return self::countCardsInLocation($executing_player_id, 'score') == 0;

            case 76: // Rocketry
                // These non-demand effects have no effect if all players have empty score piles.
                foreach (self::getAllActivePlayerIds() as $player_id) {
                    if (self::countCardsInLocation($player_id, 'score') > 0) {
                        return false;
                    }
                }
                return true;

            case 21: // Canal Building
            case 69: // Bicycle
                // These non-demand effects have no effect if the player has an empty score pile and an empty hand.
                return self::countCardsInLocation($executing_player_id, 'hand') == 0 && self::countCardsInLocation($executing_player_id, 'score') == 0;
            
            case 393: // Indian Clubs
                // These non-demands have no effect if the player has an empty hand or empty score pile.
                return self::countCardsInLocation($executing_player_id, 'hand') == 0 || self::countCardsInLocation($executing_player_id, 'score') == 0;

            /*** Other cases (sorted by card ID) **/

            case 15: // Calendar
                // The non-demand effect has no effect unless the player has more cards in their score pile than their hand.
                return self::countCardsInLocation($executing_player_id, 'score') <= self::countCardsInLocation($executing_player_id, 'hand');

            case 17: // Construction
                // The non-demand effect has no effect if the Empire achievement was already awarded.
                if (self::getCardInfo(105)['owner'] != 0) {
                    return true;
                }

                // The non-demand effect has no effect unless they are the only player with 5 top cards.
                $boards = self::getBoards(self::getAllActivePlayerIds());
                $num_players_with_five_top_cards = 0;
                $executing_player_has_five_top_cards = false;
                foreach ($boards as $player_id => $board) {
                    $number_of_top_cards = 0;
                    for ($color = 0; $color < 5; $color++) {
                        if (count($board[$color]) > 0) {
                            $number_of_top_cards++;
                        }
                    }
                    if ($number_of_top_cards == 5) {
                        $num_players_with_five_top_cards += 1;
                        if ($player_id == $executing_player_id) {
                            $executing_player_has_five_top_cards = true;
                        }
                    }
                }
                if ($num_players_with_five_top_cards != 1 || !$executing_player_has_five_top_cards) {
                    return true;
                }
                break;

            case 175: // Periodic Table
                // The non-demand effect has no effect if the player has top cards with unique values.
                return count(self::getColorsOfRepeatedValueOfTopCardsOnBoard($executing_player_id)) == 0;
            
            // All other cards with non-demand effects are assumed to have an effect.
            default:
                return false;
        }
    }

    /** Returns true if the dogma is guaranteed to have no effect when the specified player executes the demand effect (without revealing hidden info to the launching player). */
    function demandHasNoEffect($card, $launcher_id, $executing_player_id) {

        // Many cards do not have a demand effect on them
        if (self::getDemandEffect($card['id']) == null) {
            return true;
        }

        // Check the card's demand effect (excludes compel effects even they are technically a type of demand)
        switch ($card['id']) {

            /*** Basic cases involving empty hands and/or empty score piles ***/

            case 68: // Explosives
            case 71: // Refrigeration
            case 334: // Candles
            case 347: // Crossbow
            case 408: // Parachute
                // This demand has no effect if the player has an empty hand.
                return self::countCardsInLocation($executing_player_id, 'hand') == 0;

            case 72: // Sanitation
                // This demand has no effect if both the launcher or executer have empty hands.
                return self::countCardsInLocation($launcher_id, 'hand') == 0 && self::countCardsInLocation($executing_player_id, 'hand') == 0;
        
            case 41: // Anatomy
            case 62: // Vaccination
            case 99: // Databases
            case 393: // Indian Clubs
            case 411: // Air Conditioner
            case 430: // Flash Drive
                // This demand has no effect if the player has an empty score pile.
                return self::countCardsInLocation($executing_player_id, 'score') == 0;

            case 32: // Medicine
                // This demand has no effect if both the launcher or executer have empty score piles.
                return self::countCardsInLocation($launcher_id, 'score') == 0 && self::countCardsInLocation($executing_player_id, 'score') == 0;

            /*** Other cases (sorted by card ID) ***/

            case 12: // City States
                // This demand has no effect if the player has less than 4 towers on their board.
                return self::getPlayerResourceCounts($executing_player_id)[4] < 4;

            case 20: // Mapmaking
                // This demand has no effect if the player has no 1s in their score pile.
                return self::countCardsInLocationKeyedByAge($executing_player_id, 'score')[1] == 0;

            case 40: // Navigation
                // This demand has no effect if the player has no 2s or 3s in their score pile.
                $age_counts = self::countCardsInLocationKeyedByAge($executing_player_id, 'score');
                return $age_counts[2] == 0 && $age_counts[3] == 0;

            case 48: // The Pirate Code
                // This demand has no effect if the player has no 1s, 2s, 3s, or 4s in their score pile.
                $age_counts = self::countCardsInLocationKeyedByAge($executing_player_id, 'score');
                return $age_counts[1] == 0 && $age_counts[2] == 0 && $age_counts[3] == 0 && $age_counts[4] == 0;

            case 54: // Societies
                if ($this->innovationGameState->usingFirstEditionRules()) {
                    // This demand has no effect unless the player has a top non-purple card with a lightbulb.
                    for ($color = 0; $color < 4; $color++) {
                        $top_card = self::getTopCardOnBoard($executing_player_id, $color);
                        if (self::hasRessource($top_card, 3 /* lightbulb */)) {
                            return false;
                        }
                    }
                    return true;
                } else {
                    // This demand has no effect unless the player has a top card with a lightbulb higher than the
                    // launcher's top card of the same color.
                    for ($color = 0; $color < 5; $color++) {
                        $launcher_top_card = self::getTopCardOnBoard($launcher_id, $color);
                        $player_top_card = self::getTopCardOnBoard($executing_player_id, $color);
                        if (!self::hasRessource($player_top_card, 3 /* lightbulb */)) {
                            continue;
                        }
                        if ($launcher_top_card === null || $player_top_card['faceup_age'] > $launcher_top_card['faceup_age']) {
                            return false;
                        }
                    }
                    return true;
                }
                break;
        
            // All other cards with demand effects are assumed to have an effect.
            default:
                return false;
        }
    }

    /** Returns true if the dogma is guaranteed to have no effect when the specified player executes the compel effect (without revealing hidden info to the launching player). */
    function compelHasNoEffect($card, $launcher_id, $executing_player_id) {

        // Many cards do not have a compel effect on them
        if (!self::isCompelEffect($card['id'])) {
            return true;
        }

        // Check the card's compel effect
        switch ($card['id']) {

            /*** Basic cases involving empty hands and/or empty score piles ***/

            case 141: // Moylough Belt Shrine
                // This demand has no effect if the player has an empty hand.
                return self::countCardsInLocation($executing_player_id, 'hand') == 0;

            case 118: // Jiskairumoko Necklace
            case 145: // Petition of Right
            case 148: // Tortugas Galleon
            case 167: // Frigate Constitution
                // This demand has no effect if the player has an empty score pile.
                return self::countCardsInLocation($executing_player_id, 'score') == 0;
                
            default:
                // All other cards with compel effects are assumed to have an effect.
                return false;

        }
    }
    
    function argDogmaEffect() {
        return self::getArgForDogmaEffect();
    }
    
    function argInterDogmaEffect() {
        return self::getArgForDogmaEffect();
    }
    
    function argPlayerInvolvedTurn() {
        return self::getArgForPlayerUnderDogmaEffect();
    }
    
    function argInterPlayerInvolvedTurn() {
        return self::getArgForPlayerUnderDogmaEffect();
    }
    
    function argInteractionStep() {
        return self::getArgForPlayerUnderDogmaEffect();
    }
    
    function argInterInteractionStep() {
        return self::getArgForPlayerUnderDogmaEffect();
    }
 
    function argPreSelectionMove() {
        return self::getArgForPlayerUnderDogmaEffect();
    }
    
    function argInterSelectionMove() {
        return self::getArgForPlayerUnderDogmaEffect();
    }
 
    function argSelectionMove() {
        $player_id = self::getActivePlayerId();
        $player_name = self::getColoredPlayerName($player_id);
        $You = 'You';
        $you = 'you'; 
        $special_type_of_choice = $this->innovationGameState->get('special_type_of_choice');
        
        $nested_card_state = self::getCurrentNestedCardState();

        // There won't be any nested card state if a player is returning cards after the Search icon was triggered.
        if ($nested_card_state == null) {
            $card_id = $this->innovationGameState->get('melded_card_id');
            $code = null;
        } else {
            $card_id = $nested_card_state['card_id'];
            $current_effect_type = $nested_card_state['current_effect_type'];
            $current_effect_number = $nested_card_state['current_effect_number'];
            $step = self::getStep();
            $code = self::getCardExecutionCodeWithLetter($card_id, $current_effect_type, $current_effect_number, $step);
        }

        $card = self::getCardInfo($card_id);
        $card_name = self::getCardName($card['id']);
        
        $can_pass = $this->innovationGameState->get('can_pass') == 1;
        $can_stop = $this->innovationGameState->get('n_min') <= 0;
        
        if ($special_type_of_choice > 0) {
            switch(self::decodeSpecialTypeOfChoice($special_type_of_choice)) {
            case 'choose_value':
                $options = array();
                foreach ($this->innovationGameState->getAsArray('age_array') as $age) {
                    $options[] = array('value' => $age, 'text' => self::getAgeSquare($age));
                }
                break;
            case 'choose_non_negative_integer':
                // Nothing
                $options = null;
                break;
            case 'choose_color':
            case 'choose_two_colors':
            case 'choose_three_colors':
                $options = array();
                foreach ($this->innovationGameState->getAsArray('color_array') as $color) {
                    $options[] = array('value' => $color, 'text' => self::getColorInClear($color));
                }                
                break;
            case 'choose_player':
                $options = self::getObjectListFromDB(self::format("
                    SELECT
                        player_id AS value,
                        player_name AS text
                    FROM
                        player
                    WHERE
                        player_no IN ({player_nos})
                ",
                    array('player_nos' => join($this->innovationGameState->getAsArray('player_array'), ','))
                ));
                break;
            case 'choose_rearrange':
                // Nothing
                $options = null;
                break;
            case 'choose_yes_or_no':
                // See the card
                break;
            case 'choose_type':
                $options = array();
                foreach ($this->innovationGameState->getAsArray('type_array') as $type) {
                    $options[] = array('value' => $type, 'text' => self::getPrintableStringForCardType($type));
                }
                break;
            case 'choose_icon_type':
                $options = array();
                foreach ($this->innovationGameState->getAsArray('icon_array') as $icon) {
                    $options[] = array('value' => $icon, 'text' => self::getIconSquare($icon));
                }
                break;
            default:
                break;
            }

            // The message to display is specific of the card
            $message_args_for_player = array('You' => 'You', 'you' => 'you');
            $message_args_for_others = array('player_name' => $player_name);
            
            switch($code) {
            // id 18, age 2: Road building
            case "18N1B":
                $message_for_player = clienttranslate('${You} may choose another player to transfer your top red card to his board, then transfer his top green card to your board:');
                $message_for_others = clienttranslate('${player_name} may choose another player to transfer his own red card to that player\'s board, then transfer that player\'s top green card to his own board');
                break;
            
            // id 21, age 2: Canal building  
            case "21N1A":
                $message_for_player = clienttranslate('Do ${you} want to exchange all the highest cards in your hand with all the highest cards in your score pile?');
                $message_for_others = clienttranslate('${player_name} may exchange all his highest cards in his hand with all the highest cards in his score pile');
                $options = array(array('value' => 1, 'text' => clienttranslate("Yes")), array('value' => 0, 'text' => clienttranslate("No")));
                break;
                
            // id 28, age 3: Optics        
            case "28N1A":
                $message_for_player = clienttranslate('${You} must choose an opponent with fewer points than you to transfer a card from your score pile to his score pile');
                $message_for_others = clienttranslate('${player_name} must choose an opponent with fewer points than him to transfer a card from his own score pile to that opponent score pile');
                break;
                
            // id 50, age 5: Measurement
            case "50N1B":
                $message_for_player = clienttranslate('${You} must choose a color');
                $message_for_others = clienttranslate('${player_name} must choose a color');
                break;
            
            // id 61, age 6: Canning
            case "61N1A":
                $age_to_draw = self::getAgeToDrawIn($player_id, 6);
                $age_6 = self::getAgeSquare($age_to_draw);
                $max_age = self::getMaxAge();
                $age_10 = self::getAgeSquare($max_age);
                $icon_5 = self::getIconSquare(5);
                $message_args_for_player['age_6'] = $age_6;
                $message_args_for_player['age_10'] = $age_10;
                $message_args_for_player['icon_5'] =$icon_5;
                $message_args_for_others['age_6'] = $age_6;
                $message_args_for_others['age_10'] = $age_10;
                $message_args_for_others['icon_5'] =$icon_5;
                $message_for_player = $age_to_draw <= $max_age ? clienttranslate('Do ${you} want to draw and tuck a ${age_6}, then score all your top cards without a ${icon_5}?')
                                                        : clienttranslate('Finish the game (attempt to draw above ${age_10})');
                $message_for_others = $age_to_draw <= $max_age ? clienttranslate('${player_name} may draw and tuck a ${age_6}, then score all his top cards without a ${icon_5}')
                                                        : clienttranslate('${player_name} may finish the game (attempting to draw above ${age_10})');
                $options = array(array('value' => 1, 'text' => clienttranslate("Yes")), array('value' => 0, 'text' => clienttranslate("No")));
                break;
                
            // id 65, age 7: Evolution
            case "65N1A":
                $message_for_player = clienttranslate('${You} may make a choice');
                $message_for_others = clienttranslate('${player_name} may make a choice among the two possibilities offered by the card');
                $age_to_score = self::getAgeToDrawIn($player_id, 8);
                $age_to_draw = self::getAgeToDrawIn($player_id, self::getMaxAgeInScore($player_id) + 1);
                $max_age = self::getMaxAge();
                $options = [
                    ['value' => 1, 'text' => $age_to_score <= $max_age ? clienttranslate('Draw and score a ${age}, then return a card from your score pile') : clienttranslate('Finish the game (attempt to draw above ${age})'), 'age' => self::getAgeSquare($age_to_score)],
                    ['value' => 0, 'text' => $age_to_draw <= $max_age ? clienttranslate('Draw a ${age}') : clienttranslate('Finish the game (attempt to draw above ${age})'), 'age' => self::getAgeSquare($age_to_draw)],
                ];
                break;
            
            // id 66, age 7: Publications
            case "66N1A":
                $message_for_player = clienttranslate('${You} may rearrange one color of your cards. Click on a card then use arrows to move it within the pile');
                $message_for_others = clienttranslate('${player_name} may rearrange one color of his cards');
                break;
                
            // id 69, age 7: Bicycle 
            case "69N1A":
                $message_for_player = clienttranslate('Do ${you} want to exchange all the cards in your hand with all the cards in your score pile?');
                $message_for_others = clienttranslate('${player_name} may exchange all his cards in his hand with all the cards in his score pile');
                $options = array(array('value' => 1, 'text' => clienttranslate("Yes")), array('value' => 0, 'text' => clienttranslate("No")));
                break;
            
            // id 80, age 8: Mass media
            case "80N1B":
                $message_for_player = clienttranslate('Choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;
                
            // id 83, age 8: Empiricism
            case "83N1A":
                $message_for_player = clienttranslate('${You} must choose two colors');
                $message_for_others = clienttranslate('${player_name} must choose two colors');
                break;
            
            // id 102, age 10: Stem cells 
            case "102N1A":
                $message_for_player = clienttranslate('Do ${you} want to score all the cards from your hand?');
                $message_for_others = clienttranslate('${player_name} may score all the cards from his hand');
                $options = array(array('value' => 1, 'text' => clienttranslate("Yes")), array('value' => 0, 'text' => clienttranslate("No")));
                break;

            // id 114, Artifacts age 1: Papyrus of Ani
            case "114N1B":
                $message_for_player = clienttranslate('${You} must choose a type');
                $message_for_others = clienttranslate('${player_name} must choose a type');
                break;

            // id 122, Artifacts age 1: Mask of Warka
            case "122N1A":
                $message_for_player = clienttranslate('${You} must choose a color');
                $message_for_others = clienttranslate('${player_name} must choose a color');
                break;

            // id 124, Artifacts age 1: Tale of the Shipwrecked Sailor
            case "124N1A":
                $message_for_player = clienttranslate('${You} must choose a color');
                $message_for_others = clienttranslate('${player_name} must choose a color');
                break;
            
            // id 126, Artifacts age 2: Rosetta Stone
            case "126N1A":
                $message_for_player = clienttranslate('${You} must choose a type');
                $message_for_others = clienttranslate('${player_name} must choose a type');
                break;

            case "126N1C":
                $message_for_player = clienttranslate('${You} must choose an opponent');
                $message_for_others = clienttranslate('${player_name} must choose an opponent');
                break;

            // id 147, Artifacts age 4: East India Company Charter
            case "147N1A":
                $message_for_player = clienttranslate('Choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;
 
            // id 152, Artifacts age 5: Mona Lisa
            case "152N1A":
                $message_for_player = clienttranslate('Choose a color');
                $message_for_others = clienttranslate('${player_name} must choose a color');
                break;
                
            case "152N1B":
                $message_for_player = clienttranslate('Choose a number');
                $message_for_others = clienttranslate('${player_name} must choose a number');
                break;

            // id 157, Artifacts age 5: Bill of Rights
            case "157C1A":
                $message_for_player = clienttranslate('${You} must choose a color');
                $message_for_others = clienttranslate('${player_name} must choose a color');
                break;

            // id 158, Artifacts age 5: Ship of the Line Sussex
            case "158N1B":
                $message_for_player = clienttranslate('${You} must choose a color');
                $message_for_others = clienttranslate('${player_name} must choose a color');
                break;

            // id 162, Artifacts age 5: The Daily Courant
            case "162N1A":
                $message_for_player = clienttranslate('Choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;
                
            // id 170, Artifacts age 6: Buttonwood Agreement
            case "170N1A":
                $message_for_player = clienttranslate('${You} must choose three colors');
                $message_for_others = clienttranslate('${player_name} must choose three colors');
                break;

            // id 173, Artifacts age 6: Moonlight Sonata
            case "173N1A":
                $message_for_player = clienttranslate('${You} must choose a color');
                $message_for_others = clienttranslate('${player_name} must choose a color');
                break;
                
            // id 179, Artifacts age 7: International Prototype Metre Bar
            case "179N1A":
                $message_for_player = clienttranslate('Choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;

            // id 184, Artifacts age 7: The Communist Manifesto
            case "184N1A":
                $message_for_player = clienttranslate('Choose a player to transfer a card to');
                $message_for_others = clienttranslate('${player_name} must choose a player to transfer a card to');
                break;

            // id 191, Artifacts age 8: Plush Beweglich Rod Bear
            case "191N1A":
                $message_for_player = clienttranslate('Choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;

            // id 211, Artifacts age 10: Dolly the Sheep
            case "211N1A":
                $message_for_player = clienttranslate('Do ${you} want to score your bottom yellow card?');
                $message_for_others = clienttranslate('${player_name} must choose whether to score his bottom yellow card');
                $options = array(array('value' => 1, 'text' => clienttranslate("Yes")), array('value' => 0, 'text' => clienttranslate("No")));
                break;

            case "211N1B":
                $age_to_draw = self::getAgeToDrawIn($player_id, 1);
                $age_1 = self::getAgeSquare($age_to_draw);
                $max_age = self::getMaxAge();
                $age_10 = self::getAgeSquare($max_age);
                $message_args_for_player['age_1'] = $age_1;
                $message_args_for_player['age_10'] = $age_10;
                $message_args_for_others['age_1'] = $age_1;
                $message_args_for_others['age_10'] = $age_10;
                $message_for_player = $age_to_draw <= $max_age ? clienttranslate('Do ${you} want to draw and tuck a ${age_1}?')
                                                        : clienttranslate('Finish the game (attempt to draw above ${age_10})');
                $message_for_others = $age_to_draw <= $max_age ? clienttranslate('${player_name} may draw and tuck a ${age_1}')
                                                        : clienttranslate('${player_name} may finish the game (attempting to draw above ${age_10})');
                $options = array(array('value' => 1, 'text' => clienttranslate("Yes")), array('value' => 0, 'text' => clienttranslate("No")));
                break;
                
            // id 336, Echoes age 1: Comb
            case "336N1A":
                $message_for_player = clienttranslate('${You} must choose a color');
                $message_for_others = clienttranslate('${player_name} must choose a color');
                break;

            // id 337, Echoes age 1: Ice skates
            case "337N1B":
                $message_for_player = clienttranslate('${You} must make a choice');
                $message_for_others = clienttranslate('${player_name} must make a choice among the two possibilities offered by the card');
                // TODO(LATER): Use getAgeToDrawIn to alter the messages when supply piles are empty.
                $options = array(
                                array('value' => 1, 'text' => clienttranslate('Draw and meld a ${age}'), 'age' => self::getAgeSquare(2)),
                                array('value' => 0, 'text' => clienttranslate('Draw and foreshadow a ${age}'), 'age' => self::getAgeSquare(3)),
                );
                break;

            // id 339, Echoes age 1: Chopsticks
            case "339N1A":
                $message_args_for_player['age'] = self::getAgeSquare(1);
                $message_args_for_others['age'] = self::getAgeSquare(1);        
                $message_for_player = clienttranslate('Do ${you} want to transfer the bottom ${age} to the available achievements?');
                $message_for_others = clienttranslate('${player_name} must decide whether to transfer the bottom ${age} to the available achievements');
                $options = array(array('value' => 1, 'text' => clienttranslate("Yes")), array('value' => 0, 'text' => clienttranslate("No")));
                break;
                
            // id 341, Echoes age 1: Soap
            case "341N1A":
                $message_for_player = clienttranslate('${You} must choose a color');
                $message_for_others = clienttranslate('${player_name} must choose a color');
                break;

            // id 345, Echoes age 2: Lever
            case "345N1B":
                $message_for_player = clienttranslate('Choose a value to draw');
                $message_for_others = clienttranslate('${player_name} must choose a value to draw');
                break;

            // id 346, Echoes age 2: Linguistics
            case "346N1A":
                $message_for_player = clienttranslate('Choose a value of a bonus icon on your board');
                $message_for_others = clienttranslate('${player_name} must choose a value of a bonus icon on your board');
                break;

            case "346E1A":
                $message_for_player = clienttranslate('${You} may make a choice');
                $message_for_others = clienttranslate('${player_name} may make a choice among the two possibilities offered by the card');
                // TODO(LATER): Use getAgeToDrawIn to alter the messages when supply piles are empty.
                $options = array(
                                array('value' => 1, 'text' => clienttranslate('Draw a ${age}'), 'age' => self::getAgeSquare(3)),
                                array('value' => 0, 'text' => clienttranslate('Draw and foreshadow a ${age}'), 'age' => self::getAgeSquare(4)),
                );
                break;
            
            // id 347, Echoes age 2: Crossbow
            case "347N1A":
                $message_for_player = clienttranslate('${You} must choose another player to transfer a card from your hand to his board');
                $message_for_others = clienttranslate('${player_name} must choose another player to transfer a card from his hand to that player\'s board');
                break;

            // id 350, Echoes age 2: Scissors
            case "350N1B":
            case "350N1D":
                $selected_card = self::getCardInfo(self::getAuxiliaryValue2());
                $card_args = self::getNotificationArgsForCardList([$selected_card]);
                $message_args_for_player['selected_card'] = $card_args;
                $message_args_for_others['selected_card'] = $card_args;
                $message_for_player = clienttranslate('${You} must meld or score ${selected_card}');
                $message_for_others = clienttranslate('${player_name} must meld or score ${selected_card}');
                $options = array(
                                array('value' => 1, 'text' => clienttranslate("Meld")),
                                array('value' => 0, 'text' => clienttranslate("Score"))
                );
                break;
                
            // id 351, Echoes age 2: Toothbrush
            case "351E1A":
                $message_for_player = clienttranslate('Choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;
                
            case "351N2A":
                $message_args_for_player['age'] = self::getAgeSquare(2);
                $message_args_for_others['age'] = self::getAgeSquare(2);        
                $message_for_player = clienttranslate('Do ${you} want to transfer the bottom ${age} to the available achievements?');
                $message_for_others = clienttranslate('${player_name} must decide whether to transfer the bottom ${age} to the available achievements');
                $options = array(array('value' => 1, 'text' => clienttranslate("Yes")), array('value' => 0, 'text' => clienttranslate("No")));
                break;

            // id 356, Echoes age 3: Magnifying Glass
            case "356N1A":
                $message_for_player = clienttranslate('Choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;

            // id 359, Echoes age 3: Charitable Trust
            case "359E1A":
                $message_for_player = clienttranslate('${You} must make a choice');
                $message_for_others = clienttranslate('${player_name} must make a choice among the two possibilities offered by the card');
                // TODO(LATER): Use getAgeToDrawIn to alter the messages when supply piles are empty.
                $options = array(
                                array('value' => 1, 'text' => clienttranslate('Draw a ${age}'), 'age' => self::getAgeSquare(3)),
                                array('value' => 0, 'text' => clienttranslate('Draw a ${age}'), 'age' => self::getAgeSquare(4)),
                );
                break;

            case "359N1B":
                $message_for_player = clienttranslate('${You} must choose what to do with your top green card');
                $message_for_others = clienttranslate('${player_name} must choose what to do with his top green card');
                $options = array(
                                array('value' => 1, 'text' => clienttranslate("Return")),
                                array('value' => 0, 'text' => clienttranslate("Achieve")),
                );
                break;


            // id 364, Echoes age 3: Sunglasses
            case "364N1A":
                $message_for_player = clienttranslate('${You} may choose what to do with your splayed piles');
                $message_for_others = clienttranslate('${player_name} may choose what to do with his splayed piles');
                
                $splay_direction = self::getCurrentSplayDirection($player_id, 4);
                if ($splay_direction > 0) {
                    $splayable_colors = self::getAuxiliaryValue2AsArray();
                    
                    if (count($splayable_colors) > 0) {
                        $options = array(
                                        array('value' => 1, 'text' => clienttranslate("Splay your purple cards in the direction one of your other piles is splayed")),
                                        array('value' => 0, 'text' => clienttranslate('Splay one of your non-purple piles ${splay_direction}'), 'splay_direction' => self::getSplayDirectionInClear($splay_direction), 'i18n' => ['splay_direction']),
                        );
                    } else {
                        $options = array(
                                        array('value' => 1, 'text' => clienttranslate("Unsplay your purple pile")),
                        );                        
                    }
                } else {
                    $options = array(
                                    array('value' => 1, 'text' => clienttranslate("Splay your purple cards in the direction one of your other piles is splayed")),
                                    array('value' => 0, 'text' => clienttranslate("Unsplay one of your non-purple piles")),
                    );
                }
                break;
                
            case "364N1B":
                $message_for_player = clienttranslate('${You} must choose a color and splay your purple cards in the same direction');
                $message_for_others = clienttranslate('${player_name} must choose a color and splay his purple cards in the same direction');
                break;
                
            // id 370, Echoes age 4: Globe
            case "370N1A":
                $message_for_player = clienttranslate('${You} must choose a color');
                $message_for_others = clienttranslate('${player_name} must choose a color');
                break;
                
            // id 371, Echoes age 4: Barometer
            case "371N1A":
                $message_for_player = clienttranslate('Choose a value to draw and foreshadow');
                $message_for_others = clienttranslate('${player_name} must choose a draw and foreshadow');
                break;
                
            // id 379, Echoes age 5: Palampore
            case "379N1A":
                $message_for_player = clienttranslate('Choose a value to draw and score');
                $message_for_others = clienttranslate('${player_name} must choose a value to draw and score');
                break;

            // id 380, Echoes age 5: Seed Drill
            case "380N1A":
                $message_for_player = clienttranslate('Choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;
                
            case "380N1B":
                $age_value = self::getAuxiliaryValue2();
                $message_args_for_player['age'] = self::getAgeSquare($age_value);
                $message_args_for_others['age'] = self::getAgeSquare($age_value);        
                $message_for_player = clienttranslate('Do ${you} want to transfer the bottom ${age} to the available achievements?');
                $message_for_others = clienttranslate('${player_name} must decide whether to transfer the bottom ${age} to the available achievements');
                $options = array(array('value' => 1, 'text' => clienttranslate("Yes")), array('value' => 0, 'text' => clienttranslate("No")));
                break;

            // id 381, Echoes age 5: Pressure Cooker
            case "381N1B":
                $message_for_player = clienttranslate('Choose a value to draw');
                $message_for_others = clienttranslate('${player_name} must choose a draw');
                break;

            // id 383, Echoes age 5: Piano
            case "383E1A":
                $message_for_player = clienttranslate('Choose a value to draw');
                $message_for_others = clienttranslate('${player_name} must choose a value to draw');
                break;

            // id 385, Echoes age 6: Bifocals
            case "385E1A":
                $message_for_player = clienttranslate('Choose a value to foreshadow');
                $message_for_others = clienttranslate('${player_name} must choose a value to foreshadow');
                break;

            // id 399, Echoes age 7: Jeans
            case "399N1A":
                $message_for_player = clienttranslate('Choose the first value to draw');
                $message_for_others = clienttranslate('${player_name} must choose a value to draw');
                break;

            case "399N1B":
                $message_for_player = clienttranslate('Choose the second value to draw');
                $message_for_others = clienttranslate('${player_name} must choose a value to draw');
                break;

            // id 400, Echoes age 7: Telegraph
            case "400N1A":
                $message_for_player = clienttranslate('${You} may choose another player to match a splayed pile on his board:');
                $message_for_others = clienttranslate('${player_name} may choose another player to match a splayed pile on his board');
                break;

            case "400N1B":
                $message_for_player = clienttranslate('${You} must choose a color');
                $message_for_others = clienttranslate('${player_name} must choose a color');
                break;

            // id 401, Echoes age 7: Elevator
            case "401E1A":
                $message_for_player = clienttranslate('${You} must choose which green card to score');
                $message_for_others = clienttranslate('${player_name} must choose which green card to score');
                $options = array(
                                array('value' => 1, 'text' => clienttranslate("Top")),
                                array('value' => 0, 'text' => clienttranslate("Bottom")),
                );
                break;

            case "401N1A":
                $message_for_player = clienttranslate('Choose a value present in your score pile');
                $message_for_others = clienttranslate('${player_name} must choose a value present in his score pile');
                break;
                
            case "401N1B":
                $message_for_player = clienttranslate('${You} must choose where to transfer cards from');
                $message_for_others = clienttranslate('${player_name} must choose where to transfer cards from');
                $options = array(
                                array('value' => 1, 'text' => clienttranslate("Hands")),
                                array('value' => 0, 'text' => clienttranslate("Score piles")),
                );
                break;

            // id 402, Echoes age 7: Fertilizer
            case "402N2A":
                $message_for_player = clienttranslate('Choose a value to draw and foreshadow');
                $message_for_others = clienttranslate('${player_name} must choose a value to draw and foreshadow');
                break;

            // id 403, Echoes age 7: Ice Cream
            case "403N1A":
                $message_for_player = clienttranslate('Choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;
                
            case "403N1B":
                $age_value = self::getAuxiliaryValue2();
                $message_args_for_player['age'] = self::getAgeSquare($age_value);
                $message_args_for_others['age'] = self::getAgeSquare($age_value);        
                $message_for_player = clienttranslate('Do ${you} want to transfer the bottom ${age} to the available achievements?');
                $message_for_others = clienttranslate('${player_name} must decide whether to transfer the bottom ${age} to the available achievements');
                $options = array(array('value' => 1, 'text' => clienttranslate("Yes")), array('value' => 0, 'text' => clienttranslate("No")));
                break;

            // id 406, Echoes age 8: X-ray
            case "406N1A":
                $message_for_player = clienttranslate('Choose a value to foreshadow');
                $message_for_others = clienttranslate('${player_name} must choose a value to foreshadow');
                break;

            // id 413, Echoes age 8: Crossword
            case "413N1A":
                $message_for_player = clienttranslate('Choose a value to draw');
                $message_for_others = clienttranslate('${player_name} must choose a value to draw');
                break;
                
            // id 414, Echoes age 8: Television
            case "414N1A":
                $message_for_player = clienttranslate('${You} must choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;

            case "414N1B":
                $message_for_player = clienttranslate('${You} must choose an opponent');
                $message_for_others = clienttranslate('${player_name} must choose an opponent');
                break;

            // id 421, Echoes age 9: ATM
            case "421E1A":
                $message_for_player = clienttranslate('Choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;

            // id 423, Echoes age 9: Karaoke
            case "423E1A":
                $message_for_player = clienttranslate('Choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;

            case "423N1A":
                $message_for_player = clienttranslate('Choose which card\'s non-demand dogma effects you want to execute');
                $message_for_others = clienttranslate('${player_name} must choose which card\'s non-demand dogma effects he wants to execute');

                $encoded_card_ids = self::getIndexedAuxiliaryValue($player_id);
                $card_id_1 = $encoded_card_ids % 1000;
                $card_id_2 = (($encoded_card_ids - $card_id_1) / 1000) - 1;

                $card_1 = self::getCardInfo($card_id_1);
                $card_2 = self::getCardInfo($card_id_2);

                $options = [
                    ['value' => 1, 'text' => clienttranslate('${age} ${name}'), 'age' => self::getAgeSquareWithType($card_1['age'], $card_1['type']), 'name' => self::getCardName($card_id_1), 'i18n' => array('name')],
                    ['value' => 0, 'text' => clienttranslate('${age} ${name}'), 'age' => self::getAgeSquareWithType($card_2['age'], $card_2['type']), 'name' => self::getCardName($card_id_2), 'i18n' => array('name')],
                ];
                break;

            // id 426, Echoes age 10: Human Genome
            case "426N1A":
                $message_for_player = clienttranslate('You may choose a value to draw and score');
                $message_for_others = clienttranslate('${player_name} may choose a value to draw and score');
                break;
                
            // id 428, Echoes age 10: Social Networking
            case "428D1A":
                $message_for_player = clienttranslate('Choose an icon');
                $message_for_others = clienttranslate('${player_name} must choose an icon');
                break;

            // id 432, Echoes age 10: MP3
            case "432N2A":
                $message_for_player = clienttranslate('Choose a value to draw and score');
                $message_for_others = clienttranslate('${player_name} must choose a value to draw and score');
                break;
                
            // id 434, Echoes age 10: Sudoku
            case "434N1A":
                $message_for_player = clienttranslate('Choose a value');
                $message_for_others = clienttranslate('${player_name} must choose a value');
                break;

            // id 440, age 11: Climatology
            case "440D1A":
                $message_for_player = clienttranslate('Choose an icon');
                $message_for_others = clienttranslate('${player_name} must choose an icon');
                break;

            default:
                // This should not happen
                throw new BgaVisibleSystemException(self::format(self::_("Unreferenced card effect code in section S: '{code}'"), array('code' => $code)));
            }
            
            $card_names = self::getDogmaCardNames();

            $args = array_merge(array(
                // Public info
                'card_name' => 'card_name',
                'special_type_of_choice' => $special_type_of_choice,
                'options' => $options,
                'can_pass' => $can_pass,
                'can_stop' => false,
                'opponent_id' => null,
                'splay_direction' => null,
                'color_pile' => null,
                'message_for_player' => array('i18n' => array('log'), 'log' => $message_for_player, 'args' => $message_args_for_player),
                'message_for_others' => array('i18n' => array('log'), 'log' => $message_for_others, 'args' => $message_args_for_others),
                'player_name' => $player_name
            ), $card_names);

            if ($special_type_of_choice == 11 /* choose_non_negative_integer */) {
                $args['default_integer'] = self::getAuxiliaryValue(); 
            }
            
            return $args;
        }
        
        $splay_direction = $this->innovationGameState->get('splay_direction');
        $n_min = $this->innovationGameState->get("n_min");
        $n_max = $this->innovationGameState->get("n_max");
        $n = $this->innovationGameState->get("n");
        $owner_from = $this->innovationGameState->get("owner_from");
        if ($splay_direction == -1) {
            $location_from = self::decodeLocation($this->innovationGameState->get("location_from"));
            $bottom_from = $this->innovationGameState->get("bottom_from");
            $owner_to = $this->innovationGameState->get("owner_to");
            $location_to = self::decodeLocation($this->innovationGameState->get("location_to"));
            $bottom_to = $this->innovationGameState->get("bottom_to");
            $age_min = $this->innovationGameState->get("age_min");
            $age_max = $this->innovationGameState->get("age_max");
            $with_icon = $this->innovationGameState->get("with_icon");
            $without_icon = $this->innovationGameState->get("without_icon");
            $with_demand_effect = $this->innovationGameState->get("has_demand_effect");
        }
        
        // Number of cards
        if ($n_min <= 0) {
            $n_min = 1;
        }

        if ($splay_direction == -1) {
            $player_id_is_owner_from = $owner_from == $player_id;
            $player_id_is_owner_to = $owner_to == $player_id;
        }
        
        // Identification of the potential opponent(s)
        if ($splay_direction == -1 && ($owner_from == -2 || $owner_from == -3 || $owner_from == -4)) {
            $opponent_id = $owner_from;
        } else if ($splay_direction == -1 && ($owner_to == -2 || $owner_to == -3 || $owner_to == -4)) {
            $opponent_id = $owner_to;
        } else if ($splay_direction == -1 && $owner_from > 0 && $owner_from <> $player_id) {
            $opponent_id = $owner_from;
        } else if ($splay_direction == -1 && $owner_to > 0 && $owner_to <> $player_id) {
            $opponent_id = $owner_to;
        } else {
            $opponent_id = null;
        }
        
        if ($opponent_id === null) {
            $your = null;
            $opponent_name = null;
        } else if ($opponent_id > 0) {
            $your = 'your';
            $opponent_name = self::getColoredPlayerName($opponent_id);
        } else if ($opponent_id == -2) {
            $your = null;
            if ($n_min > 800) {
                $opponent_name = clienttranslate("all players");
            } else {
                $opponent_name = clienttranslate("any player");
            }
        } else if ($opponent_id == -3) {
            $your = null;
            if ($n_min > 800) {
                $opponent_name = clienttranslate("all opponents");
            } else {
                $opponent_name = clienttranslate("any opponent");
            }
        } else { // opponent_id == -4
            $your = null;
            if ($n_min > 800) {
                $opponent_name = clienttranslate("all other players");
            } else {
                $opponent_name = clienttranslate("any other player");
            }
        }
        
        // Action to be done
        if ($n == 0) {
            if ($can_pass || $can_stop) {
                $you_must = clienttranslate('${You} may');
                $player_must = clienttranslate('${player_name} may');
            } else {
                $you_must = clienttranslate('${You} must');
                $player_must = clienttranslate('${player_name} must');
            }
        } else {
            if ($can_pass || $can_stop) {
                $you_must = clienttranslate('${You} still may');
                $player_must = clienttranslate('${player_name} still may');
            } else {
                $you_must = clienttranslate('${You} still must');
                $player_must = clienttranslate('${player_name} still must');
            }
        }
        
        // Number of cards
        $number = self::getRecursivelyTranslatedNumberRange($n_min, $n_max);
        
        if ($splay_direction == -1) {
            $cards = self::getRecursivelyTranslatedCardSelection($age_min, $age_max, $with_icon, $without_icon, $with_demand_effect);
        } else { // splay_direction <> -1
            $splayable_colors = $this->innovationGameState->getAsArray('color_array');
            $splayable_colors_in_clear = array();
            foreach ($splayable_colors as $color) {
                $splayable_colors_in_clear[] = self::getColorInClearWithCards($color);
            }
        }
        
        // Creation of the message
        if ($opponent_name === null || $opponent_id == -2 || $opponent_id == -3 || $opponent_id == -4 || $location_to == 'none') {
            if ($splay_direction == -1) {
                $messages = self::getTransferInfoWithOnePlayerInvolved($location_from, $location_to, $player_id_is_owner_from, $bottom_from, $bottom_to, $you_must, $player_must, $player_name, $number, $cards, $opponent_name, $code);
                $splay_direction = null;
                $splay_direction_in_clear = null;
            } else {
                $messages = [
                    'message_for_player' => ['i18n' => ['log'], 'log' => $you_must, 'args' => ['You' => 'You']],
                    'message_for_others' => ['i18n' => ['log'], 'log' => $player_must, 'args' => ['player_name' => $player_name]],
                    'splayable_colors' => $splayable_colors,
                    'splayable_colors_in_clear' => $splayable_colors_in_clear,
                ];
                $splay_direction_in_clear = self::getSplayDirectionInClear($splay_direction);
            }
        } else {
            $messages = self::getTransferInfoWithTwoPlayersInvolved($location_from, $location_to, $player_id_is_owner_from, $player_id_is_owner_to, $you_must, $player_must, $your, $player_name, $opponent_name, $number, $cards);
            $splay_direction = null;
            $splay_direction_in_clear = null;
        }
        
        $must_show_score = false;
        if ($special_type_of_choice == 0 && $splay_direction == null && $location_from == 'score') {
            if ($owner_from == $player_id) {
                $must_show_score = true;
            } else if ($owner_from == -2) {
                $visible_cards = self::getVisibleSelectedCards($player_id);
                foreach ($visible_cards as $card) {
                    if ($card['owner'] == $player_id && $card['location'] == 'score') {
                        $must_show_score = true;
                        break;
                    }
                }
            }
        }

        $must_show_forecast = false;
        if ($special_type_of_choice == 0 && $splay_direction == null && $location_from == 'forecast') {
            if ($owner_from == $player_id) {
                $must_show_forecast = true;
            } else if ($owner_from == -2) {
                $visible_cards = self::getVisibleSelectedCards($player_id);
                foreach ($visible_cards as $card) {
                    if ($card['owner'] == $player_id && $card['location'] == 'forecast') {
                        $must_show_forecast = true;
                        break;
                    }
                }
            }
        }
        
        $card_names = self::getDogmaCardNames();
        
        $args = array_merge($messages, $card_names, array(
            // Public info
            'card_name' => 'card_name',
            'special_type_of_choice' => $special_type_of_choice,
            'can_pass' => $can_pass,
            'can_stop' => $can_stop,
            'opponent_id' => $opponent_id,
            'splay_direction' => $splay_direction,
            'splay_direction_in_clear' => $splay_direction_in_clear,
            'color_pile' => $splay_direction === null && $location_from == 'pile' ? $this->innovationGameState->getAsArray('color_array')[0] : null,
            'card_interaction' => $code,
            'num_cards_already_chosen' => $n,
            
            // Private info
            '_private' => array(
                'active' => array( // "Active" player only
                    "visible_selectable_cards" => self::getVisibleSelectedCards($player_id),
                    "selectable_rectos" => self::getSelectableRectos($player_id), // Most of the time, the player choose among versos he can see this array is empty so this array is empty except for few dogma effects
                    "must_show_score" => $must_show_score,
                    "must_show_forecast" => $must_show_forecast,
                    "show_all_cards_on_board" => $special_type_of_choice == 0 && $splay_direction == null && $location_from == 'board' && $bottom_from == 1,
                )
            ))
        );
        
        $args['i18n'][] = 'card_name';
        $args['i18n'][] = 'splay_direction_in_clear';
        $args['i18n'][] = 'splayable_colors_in_clear';
        
        return $args;
    }

    function getRecursivelyTranslatedNumberRange($n_min, $n_max) {
        if ($n_min > 800) {
            $number_log = clienttranslate("all the");
        } else if ($n_max > 800) {
            $number_log = clienttranslate("any number of");
        } else if ($n_min == $n_max) {
            $number_log = '${n_min}';
        } else if ($n_min + 1 == $n_max) {
            $number_log = clienttranslate('${n_min} or ${n_max}');
        } else {
            $number_log = clienttranslate('${n_min} to ${n_max}');
        }
        return [
            'i18n' => ['log'],
            'log' => $number_log,
            'args' => [
                'i18n' => ['n_min', 'n_max'],
                'n_min' => self::getTranslatedNumber($n_min),
                'n_max' => self::getTranslatedNumber($n_max),
            ],
        ];
    }

    function getRecursivelyTranslatedCardSelection($age_min, $age_max, $with_icon, $without_icon, $with_demand_effect) {
        $card_args = array();

        $selectable_colors = $this->innovationGameState->getAsArray('color_array');
        if (count($selectable_colors) < 5) {
            $colors = self::getRecursivelyTranslatedColorList($selectable_colors);
            $card_log = clienttranslate('${color} ${cards}${of_age}${with_icon}${with_demand}');
            $card_args['color'] = $colors;
            $card_args['i18n'] = ['color', 'cards', 'of_age', 'with_icon', 'with_demand'];
        } else {
            $card_log = clienttranslate('${cards}${of_age}${with_icon}${with_demand}');
            $card_args['i18n'] = ['cards', 'of_age', 'with_icon', 'with_demand'];
        }
        $card_args['cards'] = clienttranslate('card(s)');
        $card_args['of_age'] = '';
        $card_args['with_icon'] = '';
        $card_args['with_demand'] = '';

        if ($age_min != 1 || $age_max != 11) {
            if ($age_min == $age_max) {
                $of_age_log = clienttranslate(' of value ${<}${age_min}${>}');
            } else if ($age_min + 1 == $age_max) {
                $of_age_log = clienttranslate(' of value ${<}${age_min}${>} or ${<}${age_max}${>}');
            } else {
                $of_age_log = clienttranslate(' of value ${<}${age_min}${>} to ${<}${age_max}${>}');
            }
            $card_args['of_age'] = [
                'i18n' => ['log'],
                'log' => $of_age_log,
                'args' => array_merge(self::getDelimiterMeanings($of_age_log), ['age_min' => $age_min, 'age_max' => $age_max]),
            ];
        }

        if ($with_icon > 0) {
            $with_icon_log = clienttranslate(' with a ${[}${icon}${]}');
            $card_args['with_icon'] = [
                'i18n' => ['log'],
                'log' => $with_icon_log,
                'args' => array_merge(self::getDelimiterMeanings($with_icon_log), ['icon' => $with_icon]),
            ];
        } else if ($without_icon > 0) {
            $without_icon_log = clienttranslate(' without a ${[}${icon}${]}');
            $card_args['with_icon'] = [
                'i18n' => ['log'],
                'log' => $without_icon_log,
                'args' => array_merge(self::getDelimiterMeanings($without_icon_log), ['icon' => $without_icon]),
            ];
        }

        if ($with_demand_effect == 1) {
            $card_args['with_demand'] = clienttranslate(' with a demand effect');
        }
    
        return ['i18n' => ['log'], 'log' => $card_log, 'args' => $card_args];
    }

    function getRecursivelyTranslatedColorList($colors) {
        $color_log = "";
        $color_args = array();
        
        for ($i = 0; $i < count($colors); $i++) {
            $colors_in_clear[$i] = self::getColorInClear($colors[$i]);
        }
        switch (count($colors)) {
            case 1: 
                $color_log = '${color}';
                $color_args['color'] = self::getColorInClear($colors[0]);
                $color_args['i18n'] = ['color'];
                break;

            case 2:
                $color_log = clienttranslate('${color_1} or ${color_2}');
                $color_args['color_1'] = self::getColorInClear($colors[0]);
                $color_args['color_2'] = self::getColorInClear($colors[1]);
                $color_args['i18n'] = ['color_1', 'color_2'];
                break;

            case 3:
                $color_log = clienttranslate('${color_1}, ${color_2} or ${color_3}');
                $color_args['color_1'] = self::getColorInClear($colors[0]);
                $color_args['color_2'] = self::getColorInClear($colors[1]);
                $color_args['color_3'] = self::getColorInClear($colors[2]);
                $color_args['i18n'] = ['color_1', 'color_2', 'color_3'];
                break;

            case 4:
                $color_log = clienttranslate('non-${color}');
                for ($color = 0; $color < 5; $color++) {
                    if (!in_array($color, $colors)) {
                        $color_args['color'] = self::getColorInClear($color);
                        break;
                    }
                }
                $color_args['i18n'] = ['color'];
                break;
        }
        return ['i18n' => ['log'], 'log' => $color_log, 'args' => $color_args];
    }

//////////////////////////////////////////////////////////////////////////////
//////////// Game state actions
////////////

    /*
        Here, you can create methods defined as "game state actions" (see "action" property in states.inc.php).
        The action method of state X is called everytime the current game state is set to X.
    */

    /*
    
    Example for game state "MyGameState":

    function stMyGameState()
    {
        // Do some stuff ...
        
        // (very often) go to another gamestate
        $this->gamestate->nextState('some_gamestate_transition');
    }    
    */
    
    function stTurn0() {
        // All players must choose a card for initial meld
        $this->gamestate->setAllPlayersMultiactive();

        // If in debug mode, automatically choose arbitrary initial cards for other players (speeds up manual testing).
        if ($this->innovationGameState->get('debug_mode') == 1) {
            $other_player_ids = self::getObjectListFromDB("SELECT player_id FROM player WHERE player_id != (SELECT MIN(player_id) FROM player)", true);
            foreach ($other_player_ids as $player_id) {
                $card_1 = self::getCardsInHand($player_id)[0];
                $card_2 = self::getCardsInHand($player_id)[1];
                $card_id = self::comesAlphabeticallyBefore($card_1, $card_2) ? $card_2['id'] : $card_1['id'];
                self::markAsSelected($card_id, $player_id);
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose a card.'), array('You' => 'You'));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses a card.'), array('player_name' => self::getPlayerNameFromId($player_id)));
                $this->gamestate->setPlayerNonMultiactive($player_id, '');
            }
        }
    }
    
    function stWhoBegins() {
        $this->innovationGameState->set('turn0', 0); // End of turn 0
        
        $cards = self::getSelectedCards();
        // Deselect the cards
        self::deselectAllCards();
        
        // Execute the melds planned by players
        foreach($cards as $card) {
            $this->gamestate->changeActivePlayer($card['owner']);
            self::transferCardFromTo($card, $card['owner'], 'board');
        }
        
        // The first active player is the one who chose for meld the first card in (English) alphabetical order
        $earliest_card = null;
        foreach($cards as $card) {
            if ($earliest_card === null || self::comesAlphabeticallyBefore($card, $earliest_card)) {
                $earliest_card = $card;
            }
        }
        $player_id = $earliest_card['owner'];
        
        $english_card_name = self::getCardName($earliest_card['id']);
        self::notifyPlayer($player_id, 'initialCardChosen', clienttranslate('${You} melded the first card in English alphabetical order (${english_name}): You play first.'), array(
            'You' => 'You',
            'english_name' => $english_card_name,
        ));
        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} melded the first card in English alphabetical order (${english_name}): he plays first.'), array(
            'player_name' => self::getPlayerNameFromId($player_id),
            'english_name' => $english_card_name,
        ));
        
        // Enter normal play loop
        $this->innovationGameState->set('active_player', $player_id);
        self::setLauncherId($player_id);
        $this->gamestate->changeActivePlayer($player_id);
        $this->innovationGameState->set('current_action_number', 1);
        self::notifyGeneralInfo('<!--empty-->');
        self::trace('turn0->playerTurn');
        $this->gamestate->nextState();
    }
    
    function stInterPlayerTurn() {
        // An action of the player has been fully resolved.

        // Reset the counter used to track the cards returned by each player via Democracy during the action.
        if ($this->innovationGameState->get('release_version') >= 3) {
            self::DbQuery("UPDATE player SET democracy_counter = 0");
        }

        // Give him extra time for his actions to come
        self::giveExtraTime(self::getActivePlayerId());
        
        // Does he play again?
        if ($this->innovationGameState->get('current_action_number') == 0) {
            $next_player = false;
        } else if ($this->innovationGameState->get('first_player_with_only_one_action')) {
            // First turn: the player had only one action to make
            $next_player = true;
            $this->innovationGameState->set('first_player_with_only_one_action', 0);
        } else if ($this->innovationGameState->get('second_player_with_only_one_action')) {
            // 4 players at least and this is the second turn: the player had only one action to make
            $next_player = true;
            $this->innovationGameState->set('second_player_with_only_one_action', 0);
        } else if ($this->innovationGameState->get('has_second_action')) {
            // The player took his first action and has another one
            $next_player = false;
            $this->innovationGameState->set('has_second_action', 0);
            if ($this->innovationGameState->get('endorse_action_state') >= 2) {
                $this->innovationGameState->set('endorse_action_state', 0);
            }
        } else {
            // The player took his second action
            $next_player = true;
            $this->innovationGameState->set('has_second_action', 1);
        }
        if ($next_player) { // The turn for the current player is over
            self::resetFlagsForMonument();

            if ($this->innovationGameState->citiesExpansionEnabled()) {
                $this->innovationGameState->set('endorse_action_state', 1);
            }
            
            // Activate the next non-eliminated player in turn order
            do {
                $this->activeNextPlayer();
            } while (self::isEliminated($this->getActivePlayerId()));
            $player_id = self::getActivePlayerId();
            $this->innovationGameState->set('active_player', $player_id);
            self::setLauncherId($player_id);

            // Get next player to decide what to do with their Artifact
            $card = self::getArtifactOnDisplay($player_id);
            if ($card !== null) {
                $this->innovationGameState->set('current_action_number', 0);
                self::notifyGeneralInfo('<!--empty-->');
                self::increaseResourcesForArtifactOnDisplay($player_id, $card);
                self::trace('interPlayerTurn->artifactPlayerTurn');
                $this->gamestate->nextState('artifactPlayerTurn');
                return;
            }
            $this->innovationGameState->set('current_action_number', 1);
        } else {
            $this->innovationGameState->increment('current_action_number');
        }
        self::notifyGeneralInfo('<!--empty-->');
        self::trace('interPlayerTurn->playerTurn');
        $this->gamestate->nextState('playerTurn');
    }
    
    function stDogmaEffect() {
        // An effect of a dogma has to be resolved
        $nested_card_state = self::getCurrentNestedCardState();
        $card_id = $nested_card_state['card_id'];
        $current_effect_type = $nested_card_state['current_effect_type'];
        $current_effect_number = $nested_card_state['current_effect_number'];
        $card = self::getCardInfo($card_id);
        $qualified_effect = self::qualifyEffect($current_effect_type, $current_effect_number, $card);
        
        // Search for the first player who will undergo/share the effects, if any
        $launcher_id = self::getLauncherId();
        // During nested execution echo/non-demand effects are not shared with other players.
        $first_player = $nested_card_state['nesting_index'] > 0 && ($current_effect_type == 1 || $current_effect_type == 3) ? $launcher_id : self::getFirstPlayerUnderEffect($current_effect_type, $launcher_id);
        if ($first_player === null) {
            // There is no player affected by the effect
            self::notifyGeneralInfo("<span class='minor_information'>" . clienttranslate('Nobody is affected by the ${qualified_effect} of the card.') . "</span>", array(
                'i18n' => array('qualified_effect'),
                'qualified_effect' => $qualified_effect
            ));
            
            // End of the effect
            self::trace('dogmaEffect->interDogmaEffect');
            $this->gamestate->nextState('interDogmaEffect');
            return;
        }
        
        self::updateCurrentNestedCardState('current_player_id', $first_player);
        $this->gamestate->changeActivePlayer($first_player);
        
        // Begin the loop with this player
        self::trace('dogmaEffect->playerInvolvedTurn');
        $this->gamestate->nextState('playerInvolvedTurn');
    }
    
    function stInterDogmaEffect() {
        // A effect of a dogma card has been resolved. Is there another one?
        $nested_card_state = self::getCurrentNestedCardState();
        $nesting_index = $nested_card_state['nesting_index'];
        $card_id = $nested_card_state['card_id'];
        $previous_effect_type = $nested_card_state['current_effect_type'];

        $launcher_id = $this->innovationGameState->get('active_player');
        if ($previous_effect_type == 3) { // echo effect
            $previous_effect_number = $nested_card_state['current_effect_number'];

            // After executing each buried echo effect, clear the auxiliary values.
            if ($nesting_index == 0) {
                $card_id_of_previous_echo_effect = self::getUniqueValueFromDB(
                    self::format("SELECT card_id FROM echo_execution WHERE nesting_index = {nesting_index} AND execution_index = {execution_index}",
                        array('nesting_index' => $nesting_index, 'execution_index' => $previous_effect_number)));
                if ($card_id_of_previous_echo_effect != $card_id) {
                    self::DbQuery("
                        UPDATE
                            nested_card_execution
                        SET
                            auxiliary_value = -1,
                            auxiliary_value_2 = -1
                        WHERE
                            nesting_index = 0"
                    );
                }
            }

            self::DbQuery(
                self::format("DELETE FROM echo_execution WHERE nesting_index = {nesting_index} AND execution_index = {execution_index}",
                    array('nesting_index' => $nesting_index, 'execution_index' => $previous_effect_number)));
            
            if ($previous_effect_number > 1) {
                // Move to next echo effect
                $next_effect_number = $previous_effect_number - 1;
                $next_effect_type = 3;
            } else {
                // The last echo effect is complete, so move onto the next non-echo effect
                $next_effect_number = 1;
                if (self::getDemandEffect($card_id) == null) {
                    $next_effect_type = 1; // non-demand
                } else if (self::isCompelEffect($card_id)) {
                    $next_effect_type = 2; // I compel
                } else {
                    $next_effect_type = 0; // I demand
                }
            }
            
        } else if ($previous_effect_type == 0 || $previous_effect_type == 2) { // There is only ever one "I demand" or "I compel" effect per card
            $next_effect_type = 1;
            $next_effect_number = 1;

            // Update statistics about I demand and I compel execution.
            if ($nesting_index == 0) {
                $affected_players = self::getObjectListFromDB("SELECT player_id FROM player WHERE effects_had_impact IS TRUE", true);
                foreach ($affected_players as $player_id) {
                    if ($previous_effect_type == 0) {
                        self::incStat(1, 'i_demand_effects_number', $player_id);
                    } else {
                        self::incStat(1, 'i_compel_effects_number', $player_id);
                    }
                }
                if (count($affected_players) > 0) {
                    if ($previous_effect_type == 0) {
                        self::incStat(1, 'dogma_actions_number_with_i_demand', $launcher_id);
                    } else {
                        self::incStat(1, 'dogma_actions_number_with_i_compel', $launcher_id);
                    }
                }
                // Reset 'effects_had_impact' so that it can be re-used for non-demand effects.
                self::DbQuery("UPDATE player SET effects_had_impact = FALSE");
            }
        } else {
            // Next non-demand effect, if it exists
            $next_effect_type = 1;
            $next_effect_number = $nested_card_state['current_effect_number'] + 1;
        }
        
        $card = self::getCardInfo($card_id);

        // If there isn't another dogma effect on the card
        if ($next_effect_type == 1 && ($next_effect_number > 3 || self::getNonDemandEffect($card['id'], $next_effect_number) === null)) {

            // Finish executing the card which triggered this one
            if ($nesting_index >= 1) {
                $card_args = self::getNotificationArgsForCardList([$card]);
                self::notifyAll('logWithCardTooltips', clienttranslate('Execution of ${card_1} is complete.'),
                    ['card_1' => $card_args, 'card_ids' => [$card_id]]);
                
                self::popCardFromNestedDogmaStack();

                $nested_card_state = self::getCurrentNestedCardState();
                $this->gamestate->changeActivePlayer($nested_card_state['current_player_id']);
                self::trace('interDogmaEffect->playerInvolvedTurn');
                $this->gamestate->nextState('playerInvolvedTurn');
                return;
            }

            // Return the Artifact on display if the free dogma action was used
            $this->gamestate->changeActivePlayer($launcher_id);
            $nested_card_state = self::getNestedCardState(0);
            if ($nested_card_state['card_location'] == 'display') {
                $launcher_id = $nested_card_state['launcher_id'];
                self::returnCard($card);
                self::giveExtraTime($launcher_id);
            }

            // Update statistics about which opponents shared in the non-demand effects
            $affected_players = self::getObjectListFromDB("SELECT player_id FROM player WHERE effects_had_impact IS TRUE", true);
            foreach ($affected_players as $player_id) {
                if ($player_id != $launcher_id) {
                    self::incStat(1, 'sharing_effects_number', $player_id);
                }
            }

            // Indicate that no dogma effects are being executed anymore
            $this->innovationGameState->set('current_nesting_index', -1);

            // Award the sharing bonus if needed
            $sharing_bonus = $this->innovationGameState->get('sharing_bonus');
            if ($sharing_bonus == 1) {
                self::incStat(1, 'dogma_actions_number_with_sharing', $launcher_id);
                self::notifyGeneralInfo('<span class="minor_information">${text}</span>', array('i18n'=>array('text'), 'text'=>clienttranslate('Sharing bonus.')));
                $player_who_launched_the_dogma = $this->innovationGameState->get('active_player');
                try {
                    self::executeDraw($player_who_launched_the_dogma); // Draw a card with age consistent with player board
                }
                catch (EndOfGame $e) {
                    // End of the game: the exception has reached the highest level of code
                    self::trace('EOG bubbled from self::stInterDogmaEffect');
                    self::trace('interDogmaEffect->justBeforeGameEnd');
                    $this->gamestate->nextState('justBeforeGameEnd');
                    return;
                }
            }
            
            // The active player may have changed during the dogma. Reset it on the player whose turn was
            $this->gamestate->changeActivePlayer($launcher_id);
            
            // Reset player table
            self::resetPlayerTable();
            
            // [R] Disable the flags used when in dogma 
            self::DbQuery("
                UPDATE
                    nested_card_execution
                SET
                    card_id = -1,
                    executing_as_if_on_card_id = -1,
                    launcher_id = -1,
                    card_location = NULL,
                    current_player_id = -1,
                    current_effect_type = -1,
                    current_effect_number = -1,
                    auxiliary_value = -1,
                    auxiliary_value_2 = -1
                WHERE
                    nesting_index = 0"
            );
            $this->innovationGameState->set('sharing_bonus', -1);
            self::setStep(-1);
            self::setStepMax(-1);
            $this->innovationGameState->set('special_type_of_choice', -1);
            $this->innovationGameState->set('choice', -1);
            $this->innovationGameState->set('splay_direction', -1);
            $this->innovationGameState->set('n_min', -1);
            $this->innovationGameState->set('n_max', -1);
            $this->innovationGameState->set('solid_constraint', -1);
            $this->innovationGameState->set('owner_from', -1);
            $this->innovationGameState->set('location_from', -1);
            $this->innovationGameState->set('owner_to', -1);
            $this->innovationGameState->set('location_to', -1);
            $this->innovationGameState->set('bottom_to', -1);
            $this->innovationGameState->set('bottom_from', -1);
            $this->innovationGameState->set('age_min', -1);
            $this->innovationGameState->set('age_max', -1);
            $this->innovationGameState->set('age_array', -1);
            $this->innovationGameState->set('color_array', -1);
            $this->innovationGameState->set('type_array', -1);
            $this->innovationGameState->set('icon_array', -1);
            $this->innovationGameState->set('player_array', -1);
            $this->innovationGameState->set('with_icon', -1);
            $this->innovationGameState->set('without_icon', -1);
            $this->innovationGameState->set('not_id', -1);
            $this->innovationGameState->set('card_id_1', -1);
            $this->innovationGameState->set('card_id_2', -1);
            $this->innovationGameState->set('card_id_3', -1);
            $this->innovationGameState->set('icon_hash_1', -1);
            $this->innovationGameState->set('icon_hash_2', -1);
            $this->innovationGameState->set('icon_hash_3', -1);
            $this->innovationGameState->set('icon_hash_4', -1);
            $this->innovationGameState->set('icon_hash_5', -1);
            $this->innovationGameState->set('enable_autoselection', -1);
            $this->innovationGameState->set('include_relics', -1);
            $this->innovationGameState->set('can_pass', -1);
            $this->innovationGameState->set('n', -1);
            $this->innovationGameState->set('id_last_selected', -1);
            $this->innovationGameState->set('age_last_selected', -1);
            $this->innovationGameState->set('color_last_selected', -1);
            $this->innovationGameState->set('owner_last_selected', -1);
            $this->innovationGameState->set('score_keyword', -1);
            $this->innovationGameState->set('require_achievement_eligibility', -1);
            $this->innovationGameState->set('has_demand_effect', -1);
            $this->innovationGameState->set('has_splay_direction', -1);

            // End of this player action
            self::trace('interDogmaEffect->interPlayerTurn');
            $this->gamestate->nextState('interPlayerTurn');
            return;
        }
        
        // There is another effect to perform
        self::updateCurrentNestedCardState('current_effect_number', $next_effect_number);
        self::updateCurrentNestedCardState('current_effect_type', $next_effect_type);
        if (self::isExecutingAgainDueToEndorsedAction()) {
            $this->innovationGameState->set('endorse_action_state', 2);
        }
        
        // Jump to this effect
        self::trace('interDogmaEffect->dogmaEffect');
        $this->gamestate->nextState('dogmaEffect');
    }
    
    function stPlayerInvolvedTurn() {
        // A player must or can undergo/share an effect of a dogma card
        $player_id = self::getCurrentPlayerUnderDogmaEffect();
        $launcher_id = self::getLauncherId();

        $nested_card_state = self::getCurrentNestedCardState();
        $card_id = $nested_card_state['card_id'];
        $current_effect_type = $nested_card_state['current_effect_type'];
        $current_effect_number = $nested_card_state['current_effect_number'];
        // Echo effects are sometimes executed on cards other than the card being dogma'd
        if ($current_effect_type == 3) {
            $nesting_index = $nested_card_state['nesting_index'];
            $card_id = self::getUniqueValueFromDB(
                self::format("SELECT card_id FROM echo_execution WHERE nesting_index = {nesting_index} AND execution_index = {effect_number}",
                    array('nesting_index' => $nesting_index, 'effect_number' => $current_effect_number)));
        }
        $code = self::getCardExecutionCode($card_id, $current_effect_type, $current_effect_number);
        $step_max = null;
        $step = null;
        
        if ($nested_card_state['post_execution_index'] == 0) {
            $qualified_effect = self::qualifyEffect($current_effect_type, $current_effect_number, self::getCardInfo($card_id));      
            self::notifyEffectOnPlayer($qualified_effect, $player_id, $launcher_id);
        } else {
            // TODO(LATER): Consider adding something to the log which says that an effect is resuming.
        }
        
        $crown = self::getIconSquare(1);
        $leaf = self::getIconSquare(2);
        $lightbulb = self::getIconSquare(3);
        $tower = self::getIconSquare(4);
        $factory = self::getIconSquare(5);
        $clock = self::getIconSquare(6);
        
        try {
            switch($code) {
            // The first number is the id of the card
            // D1 means the first (and single) I demand effect
            // C1 means the first (and single) I compel effect
            // N1 means the first non-demand effect
            // N2 means the second non-demand effect
            // N3 means the third non-demand effect
            // E1 means the first (and single) echo effect
            
            // Setting the $step_max variable means there is interaction needed with the player
            
            // id 0, age 1: Pottery
            case "0N1":
                $step_max = 1;
                break;
            case "0N2":
                self::executeDraw($player_id, 1); // "Draw a 1"
                break;

            // id 1, age 1: Tools
            case "1N1":
                $step_max = 1;
                break;
            case "1N2":
                $step_max = 1;
                break;
                
            // id 2, age 1: Writing
            case "2N1":
                self::executeDraw($player_id, 2); // "Draw a 2"
                break;
                
            // id 3, age 1: Archery
            case "3D1":
                self::executeDraw($player_id, 1); // "Draw a 1"
                $step_max = 1;
                break;

            case "3N1":
                $step_max = 1;
                break;
                
            // id 4, age 1: Metalworking
            case "4N1":
                while(true) {
                    $card = self::executeDraw($player_id, 1, 'revealed'); // "Draw and reveal a 1"
                    if (self::hasRessource($card, 4)) { // "If it has a tower"
                        self::notifyGeneralInfo(clienttranslate('It has a ${tower}.'), array('tower' => $tower));
                        self::scoreCard($card, $player_id); // "Score it"
                        continue; // "Repeat this dogma effect"
                    }
                    break; // "Otherwise"        
                }
                self::notifyGeneralInfo(clienttranslate('It does not have a ${tower}.'), array('tower' => $tower));
                self::transferCardFromTo($card, $player_id, 'hand'); // "Keep it"
                break;
            
            // id 5, age 1: Oars
            case "5D1":
                // Skip automation entirely if Echoes is being used and there's at least two cards with
                // crowns (unless there's at least one Echoes card without a crown). We do this because
                // the selection order can often affect which cards are drawn, so automating it is not
                // possible.
                $num_cards_with_crowns = 0;
                $num_echoes_cards_without_crowns = 0;
                foreach (self::getCardsInHand($player_id) as $card) {
                    if (self::hasRessource($card, 1)) {
                        $num_cards_with_crowns++;
                    } else if ($card['type'] == 3) {
                        $num_echoes_cards_without_crowns++;
                    }
                }
                if ($this->innovationGameState->echoesExpansionEnabled() && $num_cards_with_crowns >= 2 && $num_echoes_cards_without_crowns == 0) {
                    $step_max = 1;
                } else {
                    do {
                        $card_transfered = false;
                        foreach (self::getCardsInHand($player_id) as $card) {
                            // "I demand you transfer a card with a crown from your hand to my score pile"
                            if (self::hasRessource($card, 1)) {
                                self::transferCardFromTo($card, $launcher_id, 'score');
                                self::executeDraw($player_id, 1); // "If you do, draw a 1"
                                $card_transfered = true; // "and repeat this dogma effect"
                                self::setAuxiliaryValue(1);
                                break;
                            }
                        }
                    } while ($card_transfered && !$this->innovationGameState->usingFirstEditionRules());
                    // Reveal hand to prove that they have no crowns.
                    self::revealHand($player_id);
                }
                break;
            
            case "5N1":
                if (self::getAuxiliaryValue() <= 0) { // "If no cards were transfered due to this demand"
                    self::executeDraw($player_id, 1); // "Draw a 1"
                }
                break;
            
            // id 6, age 1: Clothing
            case "6N1":
                $step_max = 1;
                break;
            case "6N2":
                // "Score a 1 for each color present on your board not present on any other player board"
                // Compute the number of specific colors
                $number_to_be_scored = 0;
                $boards = self::getBoards(self::getAllActivePlayerIds());
                for ($color = 0; $color < 5; $color++) { // Evaluate each color
                    if (count($boards[$player_id][$color]) == 0) { // The player does not have this color => no point
                        continue;
                    }
                    // The player has this color, do opponents have?
                    $color_on_opponent_board = false;
                    foreach (self::getActiveOpponentIds($player_id) as $opponent_id) {
                        if (count($boards[$opponent_id][$color]) > 0) { // This opponent has this color => no point
                            $color_on_opponent_board = true;
                            break;
                        }
                    }
                    if (!$color_on_opponent_board) { // The opponents do not have this color => point
                        $number_to_be_scored++;
                    }
                }
                // Indicate this number
                $translated_number = self::getTranslatedNumber($number_to_be_scored);
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} color(s) present on your board not present on any opponent\'s board.'), array('i18n' => array('n'), 'You' => 'You', 'n' => $translated_number));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} color(s) present on his board not present on any of his opponents\' boards.'), array('i18n' => array('n'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => $translated_number));

                // Score this number of times
                for ($i = 0; $i < $number_to_be_scored; $i++) {
                    self::executeDraw($player_id, 1, 'score');
                }
                break;
            
            // id 7, age 1: Sailing
            case "7N1":
                self::executeDrawAndMeld($player_id, 1); // "Draw and meld a 1"
                break;
                
            // id 8, age 1: The wheel
            case "8N1":
                // "Draw two 1"
                self::executeDraw($player_id, 1);
                self::executeDraw($player_id, 1);
                break;
                
            // id 9, age 1: Agriculture
            case "9N1":
                $step_max = 1;
                break;
            
            // id 10, age 1: Domestication
            case "10N1":
                $step_max = 1;
                break;
            
            // id 11, age 1: Masonry
            case "11N1":
                $step_max = 1;
                break;
                
            // id 12, age 1: City states
            case "12D1":
                if (self::getPlayerSingleRessourceCount($player_id, 4) >= 4) { // "If you have at least four towers on your board"
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have at least four ${icon} on your board.'), array('You' => 'You', 'icon' => $tower));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has at least four ${icon} on his board.'), array('player_name' => self::getColoredPlayerName($player_id), 'icon' => $tower));
                    $step_max = 1;
                }
                else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have less than four ${icon} on your board.'), array('You' => 'You', 'icon' => $tower));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has less than four ${icon} on his board.'), array('player_name' => self::getColoredPlayerName($player_id), 'icon' => $tower));
                }
                break;
                
            // id 13, age 1: Code of laws
            case "13N1":
                $step_max = 1;
                break;
                
            // id 14, age 1: Mysticism
            case "14N1":
                $card = self::executeDraw($player_id, 1, 'revealed'); // "Draw and reveal a 1
                $color = $card['color'];
                if (self::hasThisColorOnBoard($player_id, $color)) { // "If it is the same color of any card on your board"
                    self::notifyPlayer($player_id, 'log', clienttranslate('This card is ${color}; ${you} have this color on your board.'), array('i18n' => array('color'), 'you' => 'you', 'color' => self::getColorInClear($color)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('This card is ${color}; ${player_name} has this color on his board.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($color)));
                    self::transferCardFromTo($card, $player_id, 'board'); // "Meld it"
                    self::executeDraw($player_id, 1); // "Draw a 1"
                }
                else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('This card is ${color}; ${you} do not have this color on your board.'), array('i18n' => array('color'), 'you' => 'you', 'color' => self::getColorInClear($color)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('This card is ${color}; ${player_name} does not have this color on his board.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($color)));
                    self::transferCardFromTo($card, $player_id, 'hand'); // (Put the card in your hand)
                }
                break;
                
            // id 15, age 2: Calendar
            case "15N1":
                if (self::countCardsInLocation($player_id, 'score') > self::countCardsInLocation($player_id, 'hand')) { // "If you have more cards in your score pile than in your hand"
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have more cards in your score pile than in your hand.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has more cards in his score pile than in his hand.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    
                    self::executeDraw($player_id, 3); // "Draw two 3"
                    self::executeDraw($player_id, 3); // 
                }
                else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} do not have more cards in your score pile than in your hand.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} does not have more cards in his score pile than in his hand.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                break;
                
            // id 16, age 2: Mathematics
            case "16N1":
                $step_max = 1;
                break;
                
            // id 17, age 2: Construction
            case "17D1":
                $step_max = 1;
                break;
                
            case "17N1":
                $boards = self::getBoards(self::getAllActivePlayerIds());
                $eligible = true;
                foreach ($boards as $current_id => $board) {
                    if ($current_id == self::getPlayerTeammate($player_id)) { // Ignore teammate
                        continue;
                    }
                    $number_of_top_cards = 0;
                    for($color=0; $color<5; $color++) {
                        if (count($board[$color]) > 0) { // This player has a top card for this color.
                            $number_of_top_cards++;
                        }
                    }
                    if ($current_id == $player_id && $number_of_top_cards < 5 || $current_id != $player_id && $number_of_top_cards == 5) { // This player is the active player and has not 5 top cards, or he is an opponent who has 5 top cards
                        $eligible = false;
                    }
                }
                if ($eligible) { // "If you are the only player with five top cards"
                    $achievement = self::getCardInfo(105);
                    if ($achievement['owner'] == 0) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} are the only player with five top cards.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} is the only player with five top cards.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        self::transferCardFromTo($achievement, $player_id, 'achievements');  // "Claim the Empire achievement"
                    }
                    else {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} are the only player with five top cards but the Empire achievement has already been claimed.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} is the only player with five top cards but the Empire achievement has already been claimed.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    }
                }
                break;
            
            // id 18, age 2: Road building
            case "18N1":
                $step_max = 1;
                break;
                
            // id 19, age 2: Currency
            case "19N1":
                self::setAuxiliaryValueFromArray(array());
                $step_max = 1;
                break;
                
            // id 20, age 2: Mapmaking
            case "20D1":
                if (self::getAuxiliaryValue() == -1) { // If this variable has not been set before
                    self::setAuxiliaryValue(0);
                }
                $step_max = 1;
                break;
            
            case "20N1":
                if (self::getAuxiliaryValue() == 1) { // "If any card was transfered due to the demand"
                    self::executeDraw($player_id, 1, 'score'); // "Draw and score a 1"
                }
                break;
                
            // id 21, age 2: Canal building         
            case "21N1":
                if (self::countCardsInLocation($player_id, 'score') == 0 && self::countCardsInLocation($player_id, 'hand') == 0) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no cards in your hand or score pile to exchange.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no cards in their hand or score pile to exchange.'), array('player_name' => self::getColoredPlayerName($player_id)));
                } else {
                    $step_max = 1;
                }
                break;
                
            // id 22, age 2: Fermenting        
            case "22N1":
                if ($this->innovationGameState->usingFirstEditionRules()) {
                    $number_of_leaves = self::getPlayerSingleRessourceCount($player_id, 2 /* leaf */);
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} ${leaves}.'), array('You' => 'You', 'n' => $number_of_leaves, 'leaves' => $leaf));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} ${leaves}.'), array('player_name' => self::getColoredPlayerName($player_id), 'n' => $number_of_leaves, 'leaves' => $leaf));
                    $number = self::intDivision($number_of_leaves,2); // "For every two leaves on your board"
                } else {
                    $number = 0;
                    for($color=0; $color<5; $color++) {
                        if (self::boardPileHasRessource($player_id, $color, 2 /* leaf */)) { // There is at least one visible leaf in that color
                            $number++;
                        }
                    }
                    if ($number <= 1) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} color with one or more visible ${leaves}.'), array('i18n' => array('n'), 'You' => 'You', 'n' => self::getTranslatedNumber($number), 'leaves' => $leaf));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} color with one or more ${leaves}.'), array('i18n' => array('n'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => self::getTranslatedNumber($number), 'leaves' => $leaf));
                    }
                    else { // $number > 1
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} colors with one or more visible ${leaves}.'), array('i18n' => array('n'), 'You' => 'You', 'n' => self::getTranslatedNumber($number), 'leaves' => $leaf));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} colors with one or more ${leaves}.'), array('i18n' => array('n'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => self::getTranslatedNumber($number), 'leaves' => $leaf));
                    }
                    // "For each color of your board that have one leaf or more"
                }
                
                for($i=0; $i<$number; $i++) {
                    self::executeDraw($player_id, 2); // "Draw a 2"
                }
                break;
                
            // id 23, age 2: Monotheism        
            case "23D1":
                $step_max = 1;
                break;
            
            case "23N1":
                self::executeDrawAndTuck($player_id, 1); // "Draw and tuck a 1"
                break;
                
            // id 24, age 2: Philosophy        
            case "24N1":
                $step_max = 1;
                break;
            
            case "24N2":
                $step_max = 1;
                break;
                
            // id 25, age 3: Alchemy        
            case "25N1":
                $number_of_towers = self::getPlayerSingleRessourceCount($player_id, 4);
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} ${towers}.'), array('You' => 'You', 'n' => $number_of_towers, 'towers' => $tower));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} ${towers}.'), array('player_name' => self::getColoredPlayerName($player_id), 'n' => $number_of_towers, 'towers' => $tower));
                $any_card_red = false;
                $cards = array();
                for($i=0; $i<self::intDivision($number_of_towers,3); $i++) { // "For every three towers on your board"
                    $card = self::executeDraw($player_id, 4, 'revealed'); // "Draw and reveal a 4"
                    if ($card['color'] == 1) { // This card is red
                        $any_card_red = true;
                    }
                    $cards[] = $card;
                }
                
                if ($any_card_red) { // "If any of the drawn cards are red"
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} drew a red card.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} drew a red card.'), array('player_name' => self::getColoredPlayerName($player_id)));

                    $step_max = 1;
                }
                else { // "Otherwise"
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} did not draw a red card.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} did not draw a red card.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    foreach($cards as $card) {
                        self::transferCardFromTo($card, $player_id, 'hand'); // "Keep them" (ie place them in your hand)
                    }
                }
                break;
                
            case "25N2":
                $step_max = 2;
                break;
                
            // id 26, age 3: Translation        
            case "26N1":
                $step_max = 1;
                break;
                
            case "26N2":
                $eligible = true;
                for($color = 0; $color < 5 ; $color++) {
                    $top_card = self::getTopCardOnBoard($player_id, $color);
                    if ($top_card !== null && !self::hasRessource($top_card, 1)) { // This top card is present, with no crown on it
                        $eligible = false;
                    }
                }
                if ($eligible) { // "If each card on your board has a crown"
                    $achievement = self::getCardInfo(108);
                    if ($achievement['owner'] == 0) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('Each top card on ${your} board has a ${crown}.'), array('your' => 'your', 'crown' => $crown));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('Each top card on ${player_name} board has a ${crown}.'), array('player_name' => self::getColoredPlayerName($player_id), 'crown' => $crown));
                        self::transferCardFromTo($achievement, $player_id, 'achievements');  // "Claim the World achievement"
                    }
                    else {
                        self::notifyPlayer($player_id, 'log', clienttranslate('Each top card on ${your} board has a ${crown} but the Empire achievement has already been claimed.'), array('your' => 'your', 'crown' => $crown));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('Each top card on ${player_name} board has a ${crown} but the World achievement has already been claimed.'), array('player_name' => self::getColoredPlayerName($player_id), 'crown' => $crown));
                    }
                }
                break;
                
            // id 27, age 3: Engineering        
            case "27D1":
                // "I demand you transfer all top cards with a tower from your board to my score pile"
                $no_top_card_with_tower = true;
                for($color = 0; $color < 5 ; $color++) {
                    $top_card = self::getTopCardOnBoard($player_id, $color);
                    if (self::hasRessource($top_card, 4)) { // This top card has a tower on it
                        $no_top_card_with_tower = false;
                        self::transferCardFromTo($top_card, $launcher_id, 'score');
                    }
                }
                if ($no_top_card_with_tower) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no top card with a ${tower} on your board.'), array('You' => 'You', 'tower' => $tower));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no top card with a ${tower} on his board.'), array('player_name' => self::getColoredPlayerName($player_id), 'tower' => $tower));
                }
                break;
                
            case "27N1":
                $step_max = 1;
                break;
                
            // id 28, age 3: Optics        
            case "28N1":
                $card = self::executeDrawAndMeld($player_id, 3); // "Draw and meld a 3"
                if (self::hasRessource($card, 1)) { // "If it has a crown"
                    self::notifyGeneralInfo(clienttranslate('It has a ${crown}.'), array('crown' => $crown));
                    self::executeDraw($player_id, 4, 'score'); // "Draw and score a 4"
                } else { // "Otherwise"
                    self::notifyGeneralInfo(clienttranslate('It does not have a ${crown}.'), array('crown' => $crown));
                    if (empty(self::getActiveOpponentsWithFewerPoints($player_id))) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('There is no opponent who has fewer points than ${you}.'), array('you' => 'you'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('There is no opponent who has fewer points than ${player_name}.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    } else {
                        $step_max = 2;
                    }
                }
                break;
                
            // id 29, age 3: Compass
            case "29D1":
                $step_max = 2;
                break;
                
            // id 30, age 3: Paper        
            case "30N1":
                $step_max = 1;
                break;
                
            case "30N2":
                $number_of_colors_splayed_left = 0;
                for($color = 0; $color < 5 ; $color++) {
                    if (self::getCurrentSplayDirection($player_id, $color) == 1 /* left */) {
                        $number_of_colors_splayed_left++;
                    }
                }
                if ($number_of_colors_splayed_left < 2) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} color splayed left.'), array('i18n' => array('n'), 'You' => 'You', 'n' => $number_of_colors_splayed_left));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} color splayed left.'), array('i18n' => array('n'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => $number_of_colors_splayed_left));
                }
                else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} colors splayed left.'), array('i18n' => array('n'), 'You' => 'You', 'n' => $number_of_colors_splayed_left));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} colors splayed left.'), array('i18n' => array('n'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => $number_of_colors_splayed_left));
                }
                
                for($i=0;$i<$number_of_colors_splayed_left;$i++) { // For every color you have splayed left
                    self::executeDraw($player_id, 4); // Draw a 4
                }
                break;
                
            // id 31, age 3: Machinery        
            case "31D1":
                // "Exchange all the cards in your hand with all the highest cards in my hand"
                
                // Get cards in hand
                $ids_of_cards_in_player_hand = self::getIdsOfCardsInLocation($player_id, 'hand');
                $ids_of_highest_cards_in_launcher_hand = self::getIdsOfHighestCardsInLocation($launcher_id, 'hand');
                
                // Make the transfers
                foreach($ids_of_cards_in_player_hand as $id) {
                    $card = self::getCardInfo($id);
                    self::transferCardFromTo($card, $launcher_id, 'hand');
                }
                foreach($ids_of_highest_cards_in_launcher_hand as $id) {
                    $card = self::getCardInfo($id);
                    self::transferCardFromTo($card, $player_id, 'hand');
                }
                break;
                
            case "31N1":
                $has_card_with_tower = false;
                foreach (self::getCardsInLocation($player_id, 'hand') as $card) {
                    if (self::hasRessource($card, 4 /* tower */)) {
                        $has_card_with_tower = true;
                        break;
                    }
                }
                if (!$has_card_with_tower) {
                    $step = 2; // Skip first interaction
                    self::revealHand($player_id);
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no cards with a ${tower} in your hand.'), array('You' => 'You', 'tower' => $tower));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no cards with a ${tower} in his hand.'), array('player_name' => self::getColoredPlayerName($player_id), 'tower' => $tower));

                }
                $step_max = 2;
                break;
                
            // id 32, age 3: Medicine        
            case "32D1":
                $step_max = 2;
                break;
                
            // id 33, age 3: Education        
            case "33N1":
                $step_max = 1;
                break;
                
            // id 34, age 3: Feudalism        
            case "34D1":
                $has_card_with_tower = false;
                foreach (self::getCardsInLocation($player_id, 'hand') as $card) {
                    if (self::hasRessource($card, 4 /* tower */)) {
                        $has_card_with_tower = true;
                        break;
                    }
                }
                if ($has_card_with_tower) {
                    $step_max = 1;
                } else {
                    self::revealHand($player_id);
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no cards with a ${tower} in your hand.'), array('You' => 'You', 'tower' => $tower));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no cards with a ${tower} in his hand.'), array('player_name' => self::getColoredPlayerName($player_id), 'tower' => $tower));
                }
                break;
                
            case "34N1":
                $step_max = 1;
                break;
                
            // id 35, age 4: Experimentation        
            case "35N1":
                 // "Draw and meld a 5"
                self::executeDrawAndMeld($player_id, 5);
                break;
                
            // id 36, age 4: Printing press        
            case "36N1":
                $step_max = 1;
                break;
                
            case "36N2":
                $step_max = 1;
                break;
                
            // id 37, age 4: Colonialism
            case "37N1":
                do {
                    $card = self::executeDrawAndTuck($player_id, 3); // "Draw and tuck a 3"
                } while (self::hasRessource($card, 1 /* crown */)); // "If it has a crown, repeat this dogma effect"
                break;
            
            // id 38, age 4: Gunpowder
            case "38D1":
                if (self::getAuxiliaryValue() == -1) { // If this variable has not been set before
                    self::setAuxiliaryValue(0);
                }
                $step_max = 1;
                break;
                
            case "38N1":
                if (self::getAuxiliaryValue() == 1) { // "If any card was transfered due to the demand"
                    self::executeDraw($player_id, 2, 'score'); // "Draw and score a 2"
                }
                break;
                
            // id 39, age 4: Invention
            case "39N1":
                $step_max = 1;
                break;
                
            case "39N2":
                $eligible = true;
                for($color = 0; $color < 5 ; $color++) {
                    if (self::getCurrentSplayDirection($player_id, $color) == 0) { // This color is missing or unsplayed
                        $eligible = false;
                    };
                }
                if ($eligible) { // "If you have colors splayed, each in any direction"
                    $achievement = self::getCardInfo(107);
                    if ($achievement['owner'] == 0) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have all your five colors splayed.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has all his five colors splayed.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        self::transferCardFromTo($achievement, $player_id, 'achievements');  // "Claim the Wonder achievement"
                    }
                    else {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have all your five colors splayed but the Wonder achievement has already been claimed.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has all his five colors splayed but the Wonder achievement has already been claimed.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    }
                }
                break;
                
            // id 40, age 4: Navigation
            case "40D1":
                $step_max = 1;
                break;
            
            // id 41, age 4: Anatomy
            case "41D1":
                $step_max = 1;
                break;
                
            // id 42, age 4: Perspective
            case "42N1":
                $step_max = 1;
                break;
                
            // id 43, age 4: Enterprise
            case "43D1":
                $step_max = 1;
                break;
            
            case "43N1":
                $step_max = 1;
                break;
                
            // id 44, age 4: Reformation
            case "44N1":
                $step_max = 1;
                break;
            
            case "44N2":
                $step_max = 1;
                break;
                
            // id 45, age 5: Chemistry
            case "45N1":
                $step_max = 1;
                break;
            
            case "45N2":
                // "Draw and score a card of value one higher than the highest top card on your board"
                self::executeDraw($player_id, self::getMaxAgeOnBoardTopCards($player_id) + 1, 'score');
                $step_max = 1;
                break;
                
            // id 46, age 5: Physics
            case "46N1":
                $cards = array();
                $colors = array();
                $same_color = false;
                for($i=0; $i<3; $i++) { // "Three times"
                    $card = self::executeDraw($player_id, 6, 'revealed'); // "Draw and reveal a 6"
                    if (in_array($card['color'], $colors)) { // This card has the same color than one that has already been drawn
                        $same_color = true;
                    }
                    else {
                        $colors[] = $card['color'];
                    }
                    $cards[] = $card;
                }
                
                if ($same_color) { // "If two or more cards are the same color"
                    $step_max = 1;
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} drew two cards of the same color.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} drew two cards of the same color.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                else { // "Otherwise"
                    self::notifyPlayer($player_id, 'log', clienttranslate('All the cards ${you} drew have different colors.'), array('you' => 'you'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('All the cards ${player_name} drew have different colors.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    foreach($cards as $card) {
                        self::transferCardFromTo($card, $player_id, 'hand'); // "Keep them" (ie place them in your hand)
                    }
                }
                break;
            
            // id 47, age 5: Coal
            case "47N1":
                self::executeDrawAndTuck($player_id, 5); // "Draw and tuck a 5"
                break;

            case "47N2":
                $step_max = 1;
                break;
                
            case "47N3":
                $step_max = 1;
                break;
                
            // id 48, age 5: The pirate code
            case "48D1":
                if (self::getAuxiliaryValue() == -1) { // If this variable has not been set before
                    self::setAuxiliaryValue(0);
                }
                $step_max = 1;
                break;

            case "48N1":
                if (self::getAuxiliaryValue() == 1) { // "If any card was transfered due to the demand"
                    $step_max = 1;
                }
                break;
                
            // id 49, age 5: Banking
            case "49D1":
                $step_max = 1;
                break;

            case "49N1":
                $step_max = 1;
                break;
                
            // id 50, age 5: Measurement
            case "50N1":
                $step_max = 1;
                break;
            
            // id 51, age 5: Statistics
            case "51D1":
                if ($this->innovationGameState->usingFirstEditionRules()) {
                    $step_max = 1;
                } else {
                    // Get highest cards in score
                    $ids_of_highest_cards_in_score = self::getIdsOfHighestCardsInLocation($player_id, 'score');

                    // Make the transfers
                    foreach($ids_of_highest_cards_in_score as $id) {
                        $card = self::getCardInfo($id);
                        self::transferCardFromTo($card, $player_id, 'hand'); // "Transfer all the highest cards in your score pile to your hand"
                    }
                }
                break;

            case "51N1":
                $step_max = 1;
                break;
            
            // id 52, age 5: Steam engine
            case "52N1":
                self::executeDrawAndTuck($player_id, 4); // "Draw and tuck two 4s"
                self::executeDrawAndTuck($player_id, 4); //
                $card = self::getBottomCardOnBoard($player_id, 3 /* yellow */);
                if ($card !== null) {
                    self::scoreCard($card, $player_id);
                }
                break;
            
            // id 53, age 5: Astronomy
            case "53N1":
                while (true) {
                    $card = self::executeDraw($player_id, 6, 'revealed'); // "Draw and reveal a 6"
                    self::notifyGeneralInfo(clienttranslate('This card is ${color}.'), array('i18n' => array('color'), 'color' => self::getColorInClear($card['color'])));
                    if ($card['color'] != 0 /* blue */ && $card['color'] != 2 /* green */) {
                        break; // "Otherwise"
                    };
                    // "If the card is green or blue"
                    self::transferCardFromTo($card, $player_id, 'board'); // "Meld it"
                }
                self::transferCardFromTo($card, $player_id, 'hand'); // Keep it
                break;
            
            case "53N2":
                $eligible = true;
                for($color = 0; $color < 4 /* purple is not tested */ ; $color++) {
                    $top_card = self::getTopCardOnBoard($player_id, $color);
                    if ($top_card !== null && $top_card['age'] < 6) { // This top card is value 5 or fewer
                        $eligible = false;
                    }
                }
                if ($eligible) { // "If all your non-purple top cards on your board are value 6 or higher"
                    $achievement = self::getCardInfo(109);
                    if ($achievement['owner'] == 0) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('All non-purple top cards on ${your} board are value ${age_6} or higher.'), array('your' => 'your', 'age_6' => self::getAgeSquare(6)));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('All non-purple top cards on ${player_name}\'s board are value ${age_6} or higher.'), array('player_name' => self::getColoredPlayerName($player_id), 'age_6' => self::getAgeSquare(6)));
                        self::transferCardFromTo($achievement, $player_id, 'achievements');  // "Claim the Universe achievement"
                    }
                    else {
                        self::notifyPlayer($player_id, 'log', clienttranslate('All non-purple top cards on ${your} board are value ${age_6} or higher but the Universe achievement has already been claimed.'), array('your' => 'your', 'age_6' => self::getAgeSquare(6)));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('All non-purple top cards on ${player_name}\'s board are value ${age_6} or higher but the Universe achievement has already been claimed.'), array('player_name' => self::getColoredPlayerName($player_id), 'age_6' => self::getAgeSquare(6)));
                    }
                }
                break;
                
            // id 54, age 5: Societies
            case "54D1":
                if ($this->innovationGameState->usingFirstEditionRules()) {
                    $colors = array(0,1,2,3); // All but purple
                } else {
                    $colors = array();
                    // Determine colors which top cards with a lightbulb of the player have a value higher than the tops cards of the launcher
                    for ($color = 0; $color < 5; $color++) {
                        $player_top_card = self::getTopCardOnBoard($player_id, $color);
                        if (!self::hasRessource($player_top_card, 3 /* lightbulb */)) {
                            continue;
                        }
                        $launcher_top_card = self::getTopCardOnBoard($launcher_id, $color);
                        if ($launcher_top_card === null /* => Value 0, so the color is selectable */ || $player_top_card['faceup_age'] > $launcher_top_card['faceup_age']) {
                            $colors[] = $color; // This color is selectable
                        }
                    }
                }
                self::setAuxiliaryValueFromArray($colors);
                $step_max = 1;
                break;
            
            // id 55, age 6: Atomic theory
            case "55N1":
                $step_max = 1;
                break;
            
            case "55N2":
                // "Draw and meld a 7"
                self::executeDrawAndMeld($player_id, 7);
                break;
            
            // id 56, age 6: Encyclopedia
            case "56N1":
                $step_max = 1;
                break;
            
            // id 57, age 6: Industrialisation
            case "57N1":
                if ($this->innovationGameState->usingFirstEditionRules()) {
                    // "For every two factories on your board"
                    $number_of_factories = self::getPlayerSingleRessourceCount($player_id, 5 /* factory */);
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} ${factories}.'), array('You' => 'You', 'n' => $number_of_factories, 'factories' => $factory));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} ${factories}.'), array('player_name' => self::getColoredPlayerName($player_id), 'n' => $number_of_factories, 'factories' => $factory));
                    $number = self::intDivision($number_of_factories,2);
                } else {
                    // "For each color of your board that have one factory or more"
                    $number = 0;
                    for($color=0; $color<5; $color++) {
                        if (self::boardPileHasRessource($player_id, $color, 5 /* factory */)) { // There is at least one visible factory in that color
                            $number++;
                        }
                    }
                    if ($number <= 1) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} color with one or more visible ${factories}.'), array('i18n' => array('n'), 'You' => 'You', 'n' => self::getTranslatedNumber($number), 'factories' => $factory));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} color with one or more ${factories}.'), array('i18n' => array('n'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => self::getTranslatedNumber($number), 'factories' => $factory));
                    }
                    else { // $number > 1
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} colors with one or more visible ${factories}.'), array('i18n' => array('n'), 'You' => 'You', 'n' => self::getTranslatedNumber($number), 'factories' => $factory));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} colors with one or more ${factories}.'), array('i18n' => array('n'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => self::getTranslatedNumber($number), 'factories' => $factory));
                    }
                }
                
                for($i=0; $i<$number; $i++) {
                    self::executeDrawAndTuck($player_id, 6); // "Draw and tuck a 6"
                }
                break;
                
            case "57N2":
                $step_max = 1;
                break;
               
            // id 58, age 6: Machine tools
            case "58N1":
                self::executeDraw($player_id, self::getMaxAgeInScore($player_id), 'score'); // "Draw and score a card of value equal to the highest card in your score pile"
                break;
            
            // id 59, age 6: Classification
            case "59N1":
                $step_max = 1;
                break;
                
            // id 60, age 6: Metric system
            case "60N1":
                if (self::getCurrentSplayDirection($player_id, 2 /* green */) == 2 /* right */) { // "If your green cards are splayed right"
                    $step_max = 1;
                }
                break;
            
            case "60N2":
                $step_max = 1;
                break;
            
            // id 61, age 6: Canning
            case "61N1":
                $step_max = 1;
                break;
            
            case "61N2":
                $step_max = 1;
                break;
            
            // id 62, age 6: Vaccination
            case "62D1":
                if (self::getAuxiliaryValue() == -1) { // If this variable has not been set before
                    self::setAuxiliaryValue(0);
                }
                $step_max = 1;
                break;
            
            case "62N1":
                // "If any card was returned as a result of the demand, draw and meld a 7."
                if (self::getAuxiliaryValue() == 1) {
                    self::executeDrawAndMeld($player_id, 7);
                }
                break;
            
            // id 63, age 6: Democracy          
            case "63N1":
                if ($this->innovationGameState->get('release_version') <= 2) {
                    if (self::getAuxiliaryValue() == -1) { // If this variable has not been set before
                        self::setAuxiliaryValue(0);
                    }
                }
                $step_max = 1;
                break;
            
            // id 64, age 6: Emancipation
            case "64D1":
                $step_max = 1;
                break;
            
            case "64N1":
                $step_max = 1;
                break;
            
            // id 65, age 7: Evolution          
            case "65N1":
                $step_max = 1;
                break;
            
            // id 66, age 7: Publications
            case "66N1":
                // Make sure there's at least one pile which can be rearranged
                $number_of_cards_on_board = self::countCardsInLocationKeyedByColor($player_id, 'board');
                for ($color = 0; $color < 5; $color++) {
                    if ($number_of_cards_on_board[$color] > 1) {
                        $step_max = 1;
                        break;
                    }
                }
                break;
            
            case "66N2":
                $step_max = 1;
                break;

            // id 67, age 7: Combustion
            case "67D1":
                if ($this->innovationGameState->usingFirstEditionRules()) {
                    $number = 2;
                } else {
                    $number_of_crowns = self::getPlayerSingleRessourceCount($launcher_id, 1 /* crown */);
                    self::notifyPlayer($launcher_id, 'log', clienttranslate('${You} have ${n} ${crowns}.'), array('You' => 'You', 'n' => $number_of_crowns, 'crowns' => $crown));
                    self::notifyAllPlayersBut($launcher_id, 'log', clienttranslate('${player_name} has ${n} ${crowns}.'), array('player_name' => self::getColoredPlayerName($player_id), 'n' => $number_of_crowns, 'crowns' => $crown));
                    $number = self::intDivision($number_of_crowns, 4);
                    if ($number == 0) {
                        self::notifyGeneralInfo(clienttranslate('No card has to be transfered.'));
                        break;
                    }
                }
                self::setAuxiliaryValue($number);
                $step_max = 1;
                break;
                
            case "67N1":
                if (!$this->innovationGameState->usingFirstEditionRules()) {
                    $bottom_red_card = self::getBottomCardOnBoard($player_id, 1 /* red */);
                    if ($bottom_red_card !== null) {
                        self::returnCard($bottom_red_card); // "Return your bottom red card"
                    }
                }
                break;
            
            // id 68, age 7: Explosives
            case "68D1":

                // Automate taking as many highest cards as possible
                $num_cards_in_hand = self::countCardsInLocation($player_id, 'hand');
                $cards_by_age = self::getCardsInLocationKeyedByAge($player_id, 'hand');
                $num_cards_left_to_transfer = 3;
                for ($age = 11; $age >= 1; $age--) {
                    if (count($cards_by_age[$age]) <= $num_cards_left_to_transfer) {
                        foreach ($cards_by_age[$age] as $card) {
                            self::transferCardFromTo($card, $launcher_id, 'hand');
                            $num_cards_left_to_transfer--;
                            $num_cards_in_hand--;
                        }
                    } else {
                        break;
                    }
                }

                $num_cards_which_will_be_transferred = min($num_cards_left_to_transfer, $num_cards_in_hand);
                if ($num_cards_which_will_be_transferred > 0) {
                    // TODO(LATER): Remove the use of the auxilary value.
                    // Flag to indicate if the player has transfered a card or not
                    if ($num_cards_left_to_transfer == 3) {
                        self::setAuxiliaryValue(0);
                    } else {
                        self::setAuxiliaryValue(1);
                    }
                    $step = 4 - $num_cards_which_will_be_transferred;
                    $step_max = 3;
                
                // "If you transferred any, and then have no cards in hand"
                } else if ($num_cards_left_to_transfer < 3 && $num_cards_in_hand == 0) {
                    self::executeDraw($player_id, 7); // "Draw a 7"
                }
                break;
            
            // id 69, age 7: Bicycle
            case "69N1":
                if (self::countCardsInLocation($player_id, 'hand') > 0 || self::countCardsInLocation($player_id, 'score') > 0) {
                    $step_max = 1;
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no cards to exchange.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no cards to exchange.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                break;
            
            // id 70, age 7: Electricity
            case "70N1":
                $step_max = 1;
                break;
                
            // id 71, age 7: Refrigeration
            case "71D1":
                if (self::countCardsInLocation($player_id, 'hand') > 1) {
                    $step_max = 1;
                }
                break;
                
            case "71N1":
                $step_max = 1;
                break;
                
            // id 72, age 7: Sanitation        
            case "72D1":
                $step_max = 3;
                break;
                
            // id 73, age 7: Lighting        
            case "73N1":
                self::setAuxiliaryValueFromArray(array()); // Flag to indicate what ages have been tucked
                $step_max = 1;
                break;
            
            // id 74, age 7: Railroad        
            case "74N1":
                $step_max = 1;
                break;
            
            case "74N2":
                $step_max = 1;
                break;
                
            // id 75, age 8: Quantum theory        
            case "75N1":
                $step_max = 1;
                break;
                
            // id 76, age 8: Rocketry       
            case "76N1":
                $step_max = 1;
                break;
            
            // id 77, age 8: Flight
            case "77N1":
                if (self::getCurrentSplayDirection($player_id, 1 /* red */) == 3 /* up */) { // "If your red cards are splayed up"
                    $step_max = 1;
                }
                break;
            
            case "77N2":
                $step_max = 1;
                break;
                
            // id 78, age 8: Mobility        
            case "78D1":
                // "I demand you transfer the two highest non-red top cards without a factory from your board to my score pile!"
                // NOTE: This code is only here in order to add automation to the situation where there is no choice for which two
                // cards need to be transferred. Generic automation is not possible here because we must implement the card as two
                // separate interactions instead of a single interaction which returns two cards.
                $top_cards = self::getTopCardsOnBoard($player_id);
                $selectable_cards = array();
                for ($age = 11; $age >= 1; $age--) {
                    foreach ($top_cards as $top_card) {
                        if ($top_card['faceup_age'] == $age && $top_card['color'] != 1 && !self::hasRessource($top_card, 5)) {
                            $selectable_cards[] = $top_card;
                        }
                    }
                    if (count($selectable_cards) == 2) {
                        foreach ($selectable_cards as $card) {
                            self::transferCardFromTo($card, $launcher_id, 'score', /*bottom_to=*/ false, /*score_keyword=*/ false);
                        }
                        // "If you transferred any cards, draw an 8"
                        self::executeDraw($player_id, 8);
                        break 2; // Exit the for loop and the switch
                    } else if (count($selectable_cards) > 2) {
                        break;
                    }
                }

                // Proceed without automation
                self::setAuxiliaryValueFromArray(array(0,2,3,4)); // Flag to indicate the colors the player can still choose (not red at the start)
                $step_max = 2;
                break;
                
            // id 79, age 8: Corporations        
            case "79D1":
                $step_max = 1;
                break;
                
            case "79N1":
                // "Draw and meld an 8"
                self::executeDrawAndMeld($player_id, 8);
                break;
                
            // id 80, age 8: Mass media 
            case "80N1":
                $step_max = 1;
                break;
                
            case "80N2":
                $step_max = 1;
                break;

            // id 81, age 8: Antibiotics
            case "81N1":
                self::setAuxiliaryValueFromArray(array()); // Flag to indicate what ages have been tucked
                $step_max = 1;
                break;

            // id 82, age 8: Skyscrapers
            case "82D1":
                $step_max = 1;
                break;
            
            // id 83, age 8: Empiricism     
            case "83N1":
                $step_max = 1;
                break;
                
            case "83N2":
                if (self::getPlayerSingleRessourceCount($player_id, 3 /* lightbulb */) >= 20) { // "If you have twenty or more lightbulbs on your board"
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have at least twenty ${lightbulbs}.'), array('You' => 'You', 'lightbulbs' => $lightbulb));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has at least twenty ${lightbulbs}.'), array('player_name' => self::getColoredPlayerName($player_id), 'lightbulbs' => $lightbulb));
                    $this->innovationGameState->set('winner_by_dogma', $player_id); // "You win"
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn Empiricism');
                    throw new EndOfGame();                
                }
                break;
            
            // id 84, age 8: Socialism     
            case "84N1":
                self::setAuxiliaryValue(0); // Flag to indicate if one purple card has been tuckeds or not
                $step_max = 1;
                break;
                
            // id 85, age 9: Computers     
            case "85N1":
                $step_max = 1;
                break;
                
            case "85N2":
                // "Draw and meld a 10"
                $card = self::executeDrawAndMeld($player_id, 10);
                self::executeNonDemandEffects($card); // "Execute each of its non-demand dogma effects"
                break;
            
            // id 86, age 9: Genetics     
            case "86N1":
                // "Draw and meld a 10"
                $card = self::executeDrawAndMeld($player_id, 10);
                $board = self::getCardsInLocationKeyedByColor($player_id, 'board');
                $pile = $board[$card['color']];
                for($p=0; $p < count($pile)-1; $p++) { // "For each card beneath it"
                    $card = self::getCardInfo($pile[$p]['id']);
                    self::scoreCard($card, $player_id); // "Score that card"
                }
                break;
            
            // id 87, age 9: Composites     
            case "87D1":
                $step_max = 2;
                if (self::countCardsInLocation($player_id, 'hand') <= 1) {
                    $step = 2; // --> (All but one card when there is 0 or 1 card means that nothing is to be done) Jump directly to step 2
                }
                break;
            
            // id 88, age 9: Fission
            case "88D1":
                $card = self::executeDraw($player_id, 10, 'revealed'); // "Draw a 10"
                if ($card['color'] == 1 /* red */) { // "If it is red"
                    self::notifyGeneralInfo(clienttranslate('This card is ${color}.'), array('i18n' => array('color'), 'color' => self::getColorInClear($card['color'])));
                    self::removeAllHandsBoardsAndScores(); // "Remove all hands, boards and score piles from the game"
                    self::notifyAll('removedHandsBoardsAndScores', clienttranslate('All hands, boards and score piles are removed from the game. Achievements are kept.'), array());
                    
                    // Stats
                    self::setStat(true, 'fission_triggered');
                    
                    // "If this occurs, the dogma action is complete"
                    // (Set the flags as if the launcher had completed the non-demand dogma effect)
                    self::DbQuery(
                        self::format("
                            UPDATE
                                nested_card_execution
                            SET
                                current_player_id = {player_id},
                                current_effect_type = 1,
                                current_effect_number = 1
                            WHERE
                                nesting_index = {nesting_index}",
                            array('player_id' => $launcher_id, 'nesting_index' => $this->innovationGameState->get('current_nesting_index')))
                    );
                } else {
                    self::notifyGeneralInfo(clienttranslate('This card is not red.'));
                    // (Implicit) "Place it into your hand"
                    self::transferCardFromTo($card, $player_id, 'hand');
                }
                break;
                
            case "88N1":
                $step_max = 1;
                break;

            // id 89, age 9: Collaboration
            case "89D1":
                self::executeDraw($player_id, 9, 'revealed'); // "Draw two 9 and reveal them"
                self::executeDraw($player_id, 9, 'revealed'); //
                $step_max = 1;
                break;
                
            case "89N1":
                $number_of_cards_on_board = self::countCardsInLocationKeyedByColor($player_id, 'board');
                $number_of_green_cards = $number_of_cards_on_board[2];
                if ($number_of_green_cards >= 10) { // "If you have ten or more green cards on your board"
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have at least ten green cards.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has at least ten green cards.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    $this->innovationGameState->set('winner_by_dogma', $player_id); // "You win"
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn Collaboration');
                    throw new EndOfGame();                
                }
                break;
            
            // id 90, age 9: Satellites
            case "90N1":
                $step_max = 1;
                break;

            case "90N2":
                $step_max = 1;
                break;
                
            case "90N3":
                $step_max = 1;
                break;

            // id 91, age 9: Ecology
            case "91N1":
                $step_max = 1;
                break;

            // id 92, age 9: Suburbia
            case "92N1":
                $step_max = 1;
                break;
            
            // id 93, age 9: Services
            case "93D1":
                $ids_of_highest_cards_in_score = self::getIdsOfHighestCardsInLocation($player_id, 'score');
                foreach($ids_of_highest_cards_in_score as $id) {
                    $card = self::getCardInfo($id);
                    self::transferCardFromTo($card, $launcher_id, 'hand'); // "Transfer all the highest cards from your score pile to my hand"
                }
            
                if (count($ids_of_highest_cards_in_score) > 0) { // "If you transferred any cards"
                    $step_max = 1;
                }
                break;
              

            // id 94, age 9: Specialization
            case "94N1":
                $step_max = 1;
                break;
            
            case "94N2":
                $step_max = 1;
                break;
                
            // id 95, age 10: Bioengineering
            case "95N1":
                $step_max = 1;
                break;
            
            case "95N2":
                $player_ids = self::getAllActivePlayerIds();
                $max_number_of_leaves = -1;
                $any_under_three_leaves = false;
                foreach ($player_ids as $player_id) {
                    $number_of_leaves = self::getPlayerSingleRessourceCount($player_id, 2);
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} ${leaves}.'), array('You' => 'You', 'n' => $number_of_leaves, 'leaves' => $leaf));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} ${leaves}.'), array('player_name' => self::getColoredPlayerName($player_id), 'n' => $number_of_leaves, 'leaves' => $leaf));
                    if (!$any_under_three_leaves && $number_of_leaves < 3) { // Less than three
                        self::notifyGeneralInfo(clienttranslate('That is less than 3.'));
                        $any_under_three_leaves = true;
                    }
                    if ($number_of_leaves > $max_number_of_leaves) {
                        $max_number_of_leaves = $number_of_leaves;
                        $owner_of_max_number_of_leaves = $player_id;
                        $tie = false;                        
                    }
                    else if ($number_of_leaves == $max_number_of_leaves && $player_id != self::getPlayerTeammate($owner_of_max_number_of_leaves)) {
                        $tie = true;
                    }
                }
                
                if (!$any_under_three_leaves) {
                    self::notifyGeneralInfo(clienttranslate('Nobody has less than three ${leaves}.'), array('leaves' => $leaf));
                }
                else if ($tie) {
                    self::notifyGeneralInfo(clienttranslate('There is a tie for the most number of ${leaves}. The game continues.'), array('leaves' => $leaf));
                }
                else { // "If any player has less than three leaves, the single player with the most number of leaves"
                    self::notifyPlayer($owner_of_max_number_of_leaves, 'log', clienttranslate('${You} have more ${leaves} than each opponent.'), array('You' => 'You', 'leaves' => $leaf));
                    self::notifyAllPlayersBut($owner_of_max_number_of_leaves, 'log', clienttranslate('${player_name} has more ${leaves} than each opponent.'), array('player_name' => self::getColoredPlayerName($owner_of_max_number_of_leaves), 'leaves' => $leaf));
                    $this->innovationGameState->set('winner_by_dogma', $owner_of_max_number_of_leaves); // "Wins"
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn Bioengineering');
                    throw new EndOfGame();
                }
                
                break;

            // id 96, age 10: Software
            case "96N1":
                self::executeDraw($player_id, 10, 'score'); // "Draw and score a 10"
                break;
                
            case "96N2":
                // Draw and meld two 10s, then execute each of the second card's non dogma effects. Do not share them."
                self::executeDrawAndMeld($player_id, 10);
                $card = self::executeDrawAndMeld($player_id, 10);
                self::executeNonDemandEffects($card);
                break;
                
            // id 97, age 10: Miniaturization
            case "97N1":
                $step_max = 1;
                break;
            
            // id 98, age 10: Robotics
            case "98N1":
                $top_green_card = self::getTopCardOnBoard($player_id, 2 /* green */);
                if ($top_green_card !== null) {
                    self::scoreCard($top_green_card, $player_id); // "Score your top green card"
                }
                $card = self::executeDrawAndMeld($player_id, 10); // "Draw and meld a 10
                self::executeNonDemandEffects($card); // "Execute each its non-demand dogma effects"
                break;
            
            // id 99, age 10: Databases
            case "99D1":
                if (self::countCardsInLocation($player_id, 'score') > 0) { // (Nothing to do if the player has nothing in his score pile)
                    $step_max = 1;
                }
                break;
            
            // id 100, age 10: Self service
            case "100N1":
                $step_max = 1;
                break;
                
            case "100N2":
                $number_of_achievements = self::getPlayerNumberOfAchievements($player_id);
                $most_achievements = true;
                foreach (self::getActiveOpponentIds($player_id) as $opponent_id) {
                    if (self::getPlayerNumberOfAchievements($opponent_id) >= $number_of_achievements) {
                        $most_achievements = false;
                    }
                }
                if ($most_achievements) { // "If you have more achievements than each other player"
                    if (self::decodeGameType($this->innovationGameState->get('game_type')) == 'individual') {
                        self::notifyAllPlayersBut($player_id, "log", clienttranslate('${player_name} has more achievements than each other player.'), array(
                            'player_name' => self::getPlayerNameFromId($player_id)
                        ));
                        
                        self::notifyPlayer($player_id, "log", clienttranslate('${You} have more achievements than each other player.'), array(
                            'You' => 'You'
                        ));
                    }
                    else { // $this->innovationGameState->get('game_type')) == 'team'
                        $teammate_id = self::getPlayerTeammate($player_id);
                        $winning_team = array($player_id, $teammate_id);
                        self::notifyAllPlayersBut($winning_team, "log", clienttranslate('The other team has more achievements than yours.'), array());
                        
                        self::notifyPlayer($player_id, "log", clienttranslate('Your team has more achievements than the other.'), array());
                        
                        self::notifyPlayer($teammate_id, "log", clienttranslate('Your team has more achievements than the other.'), array());
                    }
                    $this->innovationGameState->set('winner_by_dogma', $player_id); // "You win"
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn Self service');
                    throw new EndOfGame();
                }
                break;
                
            // id 101, age 10: Globalization
            case "101D1":
                $step_max = 1;
                break;

            case "101N1":
                self::executeDraw($player_id, 6, 'score'); // "Draw and score a 6"
                
                $player_ids = self::getAllActivePlayerIds();
                $nobody_more_leaves_than_factories = true;
                foreach ($player_ids as $player_id) {
                    $number_of_leaves = self::getPlayerSingleRessourceCount($player_id, 2);
                    $number_of_factories = self::getPlayerSingleRessourceCount($player_id, 5);
                    
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${m} ${leaves} and ${n} ${factories}.'), array('You' => 'You', 'm' => $number_of_leaves, 'leaves' => $leaf, 'n' => $number_of_factories, 'factories' => $factory));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${m} ${leaves} and ${n} ${factories}.'), array('player_name' => self::getColoredPlayerName($player_id), 'm' => $number_of_leaves, 'leaves' => $leaf, 'n' => $number_of_factories, 'factories' => $factory));
                    
                    if ($nobody_more_leaves_than_factories && $number_of_leaves > $number_of_factories) {
                        self::notifyGeneralInfo(clienttranslate('That is more ${leaves} than ${factories}'), array('leaves' => $leaf, 'factories' => $factory));
                        $nobody_more_leaves_than_factories = false;
                    }
                }
                
                if ($nobody_more_leaves_than_factories) { // "If no player has more leaves than factories on their board"
                    $teams = array();
                    $scores = array();
                    foreach ($player_ids as $player_id) {
                        $team = self::getPlayerTeam($player_id);
                        $score = self::getPlayerScore($player_id);
                        if (!array_key_exists($team, $teams)) {
                            $teams[$team] = array($player_id);
                            $scores[$team] = $score;
                        }
                        else {
                            $teams[$team][] = $player_id;
                            $scores[$team] += $score;
                        }
                    }
                    
                    $max_score = -1;
                    foreach($scores as $team => $score) {
                        if ($score > $max_score) {
                            $max_score = $score;
                            $team_max = $team;
                            $tie = false;
                        }
                        else if ($score == $max_score) {
                            $tie = true;
                        }
                        
                        // Display the score (or the combined score for the team)
                        if (self::decodeGameType($this->innovationGameState->get('game_type')) == 'individual') {
                            $player_id = $teams[$team][0];
                            if ($score < 2) {
                                $message_for_others = clienttranslate('${player_name} has ${n} point.');
                                $message_for_player = clienttranslate('${You} have ${n} point.');
                            }
                            else {
                                $message_for_others = clienttranslate('${player_name} has ${n} points.');
                                $message_for_player = clienttranslate('${You} have ${n} points.');                                
                            }
                            self::notifyAllPlayersBut($player_id, "log", $message_for_others, array(
                                'player_name' => self::getPlayerNameFromId($player_id),
                                'n' => $score
                            ));
                            
                            self::notifyPlayer($player_id, "log", $message_for_player, array(
                                'You' => 'You',
                                'n' => $score
                            ));
                        }                        
                        else { // $this->innovationGameState->get('game_type') == 'team'
                            $current_team = $teams[$team];
                            $player_id = $current_team[0];
                            $teammate_id = $current_team[1];
                            if ($score < 2) {
                                $message_for_team = clienttranslate('Your team has ${n} point.');
                                $message_for_others = clienttranslate('The other team has ${n} point.');
                            }
                            else {
                                $message_for_team = clienttranslate('Your team has ${n} points.');
                                $message_for_others = clienttranslate('The other team has ${n} points.');                            
                            }
                            self::notifyAllPlayersBut($current_team, "log", $message_for_others, array('n' => $score));
                            
                            self::notifyPlayer($player_id, "log", $message_for_team, array('n' => $score));
                            
                            self::notifyPlayer($teammate_id, "log",$message_for_team, array('n' => $score));    
                        }
                    }
                    
                    if ($tie) {
                        self::notifyGeneralInfo(clienttranslate('There is a tie for the greatest score. The game continues.'));
                    }
                    else {
                        $winning_team = $teams[$team_max];
                        if (self::decodeGameType($this->innovationGameState->get('game_type')) == 'individual') {
                            $player_id = $winning_team[0];
                            self::notifyAllPlayersBut($player_id, "log", clienttranslate('${player_name} has a greater score than each other player.'), array(
                                'player_name' => self::getPlayerNameFromId($player_id)
                            ));
                            
                            self::notifyPlayer($player_id, "log", clienttranslate('${You} have a greater score than each other player.'), array(
                                'You' => 'You'
                            ));
                        }
                        else { // $this->innovationGameState->get('game_type')) == 'team'
                            $player_id = $winning_team[0];
                            $teammate_id = $winning_team[1];
                            self::notifyAllPlayersBut($winning_team, "log", clienttranslate('The other team has a greater score than yours.'), array());
                            
                            self::notifyPlayer($player_id, "log", clienttranslate('Your team has a greater score than the other one.'), array());
                            
                            self::notifyPlayer($teammate_id, "log", clienttranslate('Your team has a greater score than the other one.'), array());
                        }
                        $this->innovationGameState->set('winner_by_dogma', $player_id); // "The single player with the most points wins" (or combined scores for team)
                        self::trace('EOG bubbled from self::stPlayerInvolvedTurn Globalization');
                        throw new EndOfGame();
                    }
                }
                break;
                
            // id 102, age 10: Stem cells
            case "102N1":
                if (self::countCardsInLocation($player_id, 'hand') == 0) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no cards in your hand to score.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no cards in their hand to score.'), array('player_name' => self::getColoredPlayerName($player_id)));
                } else {
                    $step_max = 1;
                }
                break;
            
        
            // id 103, age 10: A. I.
            case "103N1":
                self::executeDraw($player_id, 10, 'score'); // "Draw and score a 10"
                break;

            case "103N2":
                if (self::isTopBoardCard(self::getCardInfo(96)) && self::isTopBoardCard(self::getCardInfo(98))) { // "If Robotics and Software are top cards on any board"
                    self::notifyGeneralInfo(clienttranslate('Robotics and Software are both visible as top cards.'));
                    
                    $min_score = 9999;
                    foreach(self::getAllActivePlayerIds() as $any_player_id) {
                        $score = self::getPlayerScore($any_player_id);
                        if ($score < $min_score) {
                            $min_score = $score;
                            $player_with_min_score = $any_player_id;
                            $tie = false;
                        }
                        else if ($score == $min_score) {
                            $tie = true;
                        }
                        
                        // Display the score (or the combined score for the team)
                        if ($score < 2) {
                            $message_for_others = clienttranslate('${player_name} has ${n} point.');
                            $message_for_player = clienttranslate('${You} have ${n} point.');
                        }
                        else {
                            $message_for_others = clienttranslate('${player_name} has ${n} points.');
                            $message_for_player = clienttranslate('${You} have ${n} points.');
                        }
                        self::notifyAllPlayersBut($any_player_id, "log", $message_for_others, array(
                            'player_name' => self::getPlayerNameFromId($any_player_id),
                            'n' => $score
                        ));
                        
                        self::notifyPlayer($any_player_id, "log", $message_for_player, array(
                            'You' => 'You',
                            'n' => $score
                        ));
                    }
                    if ($tie) {
                        self::notifyGeneralInfo(clienttranslate('There is a tie for the lowest score. The game continues.'));
                    }
                    else {
                        self::notifyAllPlayersBut($player_with_min_score, "log", clienttranslate('${player_name} has the lowest score.'), array(
                            'player_name' => self::getPlayerNameFromId($player_with_min_score)
                        ));
                        
                        self::notifyPlayer($player_with_min_score, "log", clienttranslate('${You} have the lowest score.'), array(
                            'You' => 'You'
                        ));
                        $this->innovationGameState->set('winner_by_dogma', $player_with_min_score); // "The single player with the most points wins" (scores are not combined for teams)
                        self::trace('EOG bubbled from self::stPlayerInvolvedTurn A. I.');
                        throw new EndOfGame();
                    }
                }
                break;

            // id 104, age 10: The internet.
            case "104N1":
                $step_max = 1;
                break;

            case "104N2":
                self::executeDraw($player_id, 10, 'score'); // "Draw and score a 10"
                break;

            case "104N3":
                $number_of_clocks = self::getPlayerSingleRessourceCount($player_id, 6 /* clock */);
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} ${clocks}.'), array('You' => 'You', 'n' => $number_of_clocks, 'clocks' => $clock));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} ${clocks}.'), array('player_name' => self::getColoredPlayerName($player_id), 'n' => $number_of_clocks, 'clocks' => $clock));
                for($i=0; $i<self::intDivision($number_of_clocks,2); $i++) { // "For every two clocks on your board"
                    self::executeDrawAndMeld($player_id, 10); // "Draw and meld a 10"
                }
                break;

            // id 110, Artifacts age 1: Treaty of Kadesh
            case "110C1":
                $step_max = 1;
                break;

            case "110N1":
                $step_max = 1;
                break;

            // id 111, Artifacts age 1: Sibidu Needle
            case "111N1":
                while (true) {
                    $card = self::executeDraw($player_id, 1, 'revealed'); // "Draw and reveal a 1"
                    $top_card = self::getTopCardOnBoard($player_id, $card['color']);
                    if ($top_card !== null && $card['faceup_age'] == $top_card['faceup_age']) { // "If you have a top card of matching color and value"
                        self::scoreCard($card, $player_id); // "Score the drawn card"
                        continue; // "Repeat this effect"
                    }
                    self::notifyGeneralInfo(clienttranslate('There was not a top card of matching color and value.'));
                    break;        
                }
                self::transferCardFromTo($card, $player_id, 'hand'); // Keep it
                break;
            
            // id 112, Artifacts age 1: Basur Hoyuk Tokens
            case "112N1":
                $card = self::executeDraw($player_id, 4, 'revealed'); // "Draw and reveal a 4"
                $top_card = self::getTopCardOnBoard($player_id, $card['color']);
                if ($top_card === null) {
                    self::transferCardFromTo($card, $player_id, 'hand'); // Keep it
                } else if ($top_card !== null && self::comesAlphabeticallyBefore($top_card, $card)) { // "If you have a top card of the drawn card's color that comes before it in the alphabet"
                    self::notifyGeneralInfo(clienttranslate('In English alphabetical order, ${english_name_1} comes before ${english_name_2}.'), array(
                        'english_name_1' => self::getCardName($top_card['id']),
                        'english_name_2' => self::getCardName($card['id']),
                    ));
                    $step_max = 1;
                } else {
                    self::notifyGeneralInfo(clienttranslate('In English alphabetical order, ${english_name_1} does not come before ${english_name_2}.'), array(
                        'english_name_1' => self::getCardName($top_card['id']),
                        'english_name_2' => self::getCardName($card['id']),
                    ));
                    self::transferCardFromTo($card, $player_id, 'hand'); // Keep it
                }
                break;
            
            // id 113, Artifacts age 1: Holmegaard Bows
            case "113C1":
                $step_max = 1;
                break;
            
            case "113N1":
                // "Draw a 2"
                self::executeDraw($player_id, 2);
                break;

            // id 114, Artifacts age 1: Papyrus of Ani
            case "114N1":
                $number_of_purple_cards = self::countCardsInLocationKeyedByColor($player_id, 'hand')[4];
                if ($number_of_purple_cards == 0) {
                    self::revealHand($player_id);
                    $color_in_clear = self::getColorInClear(4);
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no ${colored} cards in your hand.'), array('i18n' => array('colored'), 'You' => 'You', 'colored' => $color_in_clear));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no ${colored} cards in his hand.'), array('i18n' => array('colored'), 'player_name' => self::getColoredPlayerName($player_id), 'colored' => $color_in_clear));
                } else {
                    $step_max = 1;
                }
                break;

            // id 115, Artifacts age 1: Pavlovian Tusk
            case "115N1":
                // "Draw three cards of value equal to your top green card"
                $top_green_card = self::getTopCardOnBoard($player_id, 2 /* green */);
                $top_green_card_age = 0;
                if ($top_green_card !== null) {
                    $top_green_card_age = $top_green_card["age"];
                }
                $this->innovationGameState->set('card_id_1', self::executeDraw($player_id, $top_green_card_age)['id']);
                $this->innovationGameState->set('card_id_2', self::executeDraw($player_id, $top_green_card_age)['id']);
                $this->innovationGameState->set('card_id_3', self::executeDraw($player_id, $top_green_card_age)['id']);
                $step_max = 2;
                break;
            
            // id 116, Artifacts age 1: Priest-King
            case "116N1":
                $step_max = 1;
                break;
            
            case "116N2":
                $step_max = 1;
                break;
            
            // id 117, Artifacts age 1: Electrum Stater of Efesos
            case "117N1":
                while (true) {
                    $card = self::executeDraw($player_id, 3, 'revealed'); // "Draw and reveal a 3"
                    $top_card = self::getTopCardOnBoard($player_id, $card['color']);
                    if ($top_card == null) { // "If you do not have a top card of the drawn card's color"
                        self::transferCardFromTo($card, $player_id, 'board'); // "Meld it"
                        continue; // "Repeat this effect"
                    }
                    break;
                }
                self::transferCardFromTo($card, $player_id, 'hand'); // Keep it
                break;
                
            // id 118, Artifacts age 1: Jiskairumoko Necklace
            case "118C1":
                $step_max = 1;
                break;
            
             // id 119, Artifacts age 1: Dancing Girl
             case "119C1":
                $card = self::getCardInfo(119); // Dancing Girl
                if ($card['owner'] != $player_id) {
                    self::transferCardFromTo($card, $player_id, 'board');
                }
                if ($this->innovationGameState->get('release_version') >= 3)  {
                    if (self::getAuxiliaryValue() == -1) {
                        $visited_boards = array();
                    } else {
                        $visited_boards = self::getAuxiliaryValueAsArray();
                    }
                    $visited_boards[] = self::playerIdToPlayerNo($player_id);
                    self::setAuxiliaryValueFromArray(array_unique($visited_boards));
                } else {
                    self::setAuxiliaryValue(self::getAuxiliaryValue() + 1); // Keep track of Dancing Girl's movements
                }
                break;
            
            // id 119, Artifacts age 1: Dancing Girl
            case "119N1":
                // Count the number of other boards that were visited (excluding the launcher's board)
                if ($this->innovationGameState->get('release_version') >= 3)  {
                    if (self::getAuxiliaryValue() == -1) { // The Dancing Girl didn't move at all
                        $num_other_boards_visited = 0;
                    } else {
                        $num_other_boards_visited = count(self::getAuxiliaryValueAsArray());
                    }
                } else {
                    $num_other_boards_visited = self::getAuxiliaryValue() + 1; // + 1 since the variable is initialized to -1, not 0
                }
                $initial_location = self::getCurrentNestedCardState()['card_location'];
                if ($player_id == $launcher_id) {
                    if ($num_other_boards_visited == self::countNonEliminatedPlayers() - 1 && $initial_location == 'board') {
                        self::notifyPlayer($player_id, 'log', clienttranslate('Dancing Girl has been on every board during this action, and it started on your board, so you win.'), array());
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('Dancing Girl has been on every board during this action, and it started on ${player_name}\'s board, so they win.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        $this->innovationGameState->set('winner_by_dogma', $player_id); // "You win"
                        self::trace('EOG bubbled from self::stPlayerInvolvedTurn Dancing Girl');
                        throw new EndOfGame();
                    } else {
                        self::notifyAll('log', clienttranslate('Dancing Girl has not been on every board during this action.'), array());
                    }
                }
                break;
            
            // id 120, Artifacts age 1: Lurgan Canoe
            case "120N1":
                $step_max = 1;
                break;
            
            // id 121, Artifacts age 1: Xianrendong Shards
            case "121N1":
                $this->innovationGameState->set('card_id_1', -1);
                $this->innovationGameState->set('card_id_2', -1);
                $this->innovationGameState->set('card_id_3', -1);
                $step_max = 2;
                break;

            // id 122, Artifacts age 1: Mask of Warka
            case "122N1":
                self::setAuxiliaryValue2FromArray(array());
                $step_max = 1;
                break;

            // id 123, Artifacts age 1: Ark of the Covenant
            case "123N1":
                $step_max = 1;
                break;
                
            // id 124, Artifacts age 1: Tale of the Shipwrecked Sailor
            case "124N1":
                $step_max = 2;
                break;
            
             // id 125, Artifacts age 2: Seikilos Epitaph
             case "125N1":
                // "Draw and meld a 3"
                $melded_card = self::executeDrawAndMeld($player_id, 3);
               
                // "Meld your bottom card of the drawn card's color"
                $number_of_cards = self::countCardsInLocationKeyedByColor($player_id, 'board')[$melded_card['color']];
                if ($number_of_cards > 1) {
                    $bottom_card = self::getBottomCardOnBoard($player_id, $melded_card['color']);
                    $melded_card = self::transferCardFromTo($bottom_card, $player_id, 'board');
                }

                // "Execute its non-demand dogma effects. Do not share them."
                self::executeNonDemandEffects($melded_card);
                break;
            
            // id 126, Artifacts age 2: Rosetta Stone
            case "126N1":
                $step_max = 3;
                break;

            // id 127, Artifacts age 2: Chronicle of Zuo
            case "127N1":
                $min_towers = self::getUniqueValueFromDB(self::format("SELECT MIN(player_icon_count_4) FROM player WHERE player_id != {player_id} AND player_eliminated = 0", array('player_id' => $player_id)));
                $min_crowns = self::getUniqueValueFromDB(self::format("SELECT MIN(player_icon_count_1) FROM player WHERE player_id != {player_id} AND player_eliminated = 0", array('player_id' => $player_id)));
                $min_bulbs = self::getUniqueValueFromDB(self::format("SELECT MIN(player_icon_count_3) FROM player WHERE player_id != {player_id} AND player_eliminated = 0",  array('player_id' => $player_id)));
                
                $this_player_icon_counts = self::getPlayerResourceCounts($player_id);
                
                if ($this_player_icon_counts[4] <= $min_towers) {
                    $card = self::executeDraw($player_id, 2); // "If you have the least towers, draw a 2"
                }
                if ($this_player_icon_counts[1] <= $min_crowns) {
                    $card = self::executeDraw($player_id, 3); // "If you have the least crowns, draw a 3"
                }
                if ($this_player_icon_counts[3] <= $min_bulbs) {
                    $card = self::executeDraw($player_id, 4); // "If you have the least bulbs, draw a 4"
                }
                break;
                
            // id 128, Artifacts age 2: Babylonian Chronicles
            case "128C1":
                $step_max = 1;
                break;
            
            case "128N1":
                // "Draw and score a 3"
                self::executeDraw($player_id, 3, 'score');
                break;

            // id 129, Artifacts age 2: Holy Lance
            case "129C1":
                $step_max = 1;
                break;

            case "129N1":
                // "If Holy Grail is a top card on your board, you win"
                $top_card = self::getTopCardOnBoard($player_id, 3); // top yellow card
                if ($top_card !== null && $top_card['id'] == 131) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have Holy Grail as a top card.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has Holy Grail as a top card.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    $this->innovationGameState->set('winner_by_dogma', $player_id);
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn HolyLance');
                    throw new EndOfGame();
                }
                break;
                
            // id 130, Artifacts age 1: Baghdad Battery
            case "130N1":
                self::setAuxiliaryValue(-1);
                $step_max = 1;
                break;
            
            // id 131, Artifacts age 2: Holy Grail
            case "131N1":
                $step_max = 1;
                break;

            // id 132, Artifacts age 2: Terracotta Army
            case "132C1":
                $step_max = 1;
                break;
            
            case "132N1":
                $step_max = 1;
                break;

            // id 133, Artifacts age 2: Dead Sea Scrolls
            case "133N1":
                // "Draw an Artifact of value equal to the value of your highest top card"
                self::executeDraw($player_id, self::getMaxAgeOnBoardTopCards($player_id), 'hand', /*bottom_to=*/ false, /*type=*/ 1);
                break;

            // id 134, Artifacts age 2: Cyrus Cylinder
            case "134N1":
                $step_max = 1;
                break;

            case "134N1+":
                $step_max = 1;
                break;

            // id 135, Artifacts age 3: Dunhuang Star Chart
            case "135N1":
                $step_max = 1;
                break;

            // id 136, Artifacts age 3: Charter of Liberties
            case "136N1":
                $step_max = 1;
                break;

            // id 137, Artifacts age 2: Excalibur
            case "137C1":
                // Determine colors where top card has a higher value than the launcher's top card of the same color
                $colors = array();
                for ($color = 0; $color < 5; $color++) {
                    $player_top_card = self::getTopCardOnBoard($player_id, $color);
                    if ($player_top_card === null) {
                        continue;
                    }
                    $launcher_top_card = self::getTopCardOnBoard($launcher_id, $color);
                    if ($launcher_top_card === null || $player_top_card['faceup_age'] > $launcher_top_card['faceup_age']) {
                        $colors[] = $color;
                    }
                }
                self::setAuxiliaryValueFromArray($colors);
                $step_max = 1;
                break;
            
            // id 138, Artifacts age 3: Mjolnir Amulet
            case "138C1":
                $step_max = 1;
                break;

            // id 139, Artifacts age 3: Philosopher's Stone
            case "139N1":
                $step_max = 1;
                break;

            // id 140, Artifacts age 3: Beauvais Cathedral Clock
            case "140N1":
                // "Draw and reveal a 4"
                $card = self::executeDraw($player_id, 4, 'revealed');
                // "Splay right the color matching the drawn card"
                self::splayRight($player_id, $player_id, $card['color']);
                self::transferCardFromTo($card, $player_id, 'hand');
                break;

            // id 141, Artifacts age 3: Moylough Belt Shrine
            case "141C1":
                // "I compel you to reveal all cards in your hand"
                // TODO(https://github.com/micahstairs/bga-innovation/issues/304): Use bulk reveal mechanism.
                $cards = self::getCardsInLocation($player_id, 'hand');
                foreach ($cards as $card) {
                    self::transferCardFromTo($card, $player_id, 'revealed');
                }
                $step_max = 1;
                break;
            
            // id 142, Artifacts age 3: Along the River during the Qingming Festival
            case "142N1":
                do {
                    $card = self::executeDraw($player_id, 4, 'revealed'); // "Draw and reveal a 4"
                    if ($card['color'] == 4) { // "If it is purple, score it"
                        self::transferCardFromTo($card, $player_id, 'score');
                    } else if ($card['color'] == 3) { // "If it is yellow, tuck it"
                        self::tuckCard($card, $player_id);
                    } else { // Put it in hand
                        self::transferCardFromTo($card, $player_id, 'hand');
                    }
                } while($card['color'] == 0 || $card['color'] == 1 || $card['color'] == 2); // "Otherwise, repeat this effect"
                break;
            
            // id 143, Artifacts age 3: Necronomicon
            case "143N1":
                $card = self::executeDraw($player_id, 3, 'revealed'); // "Draw and reveal a 3"
                self::notifyGeneralInfo(clienttranslate('This card is ${color}.'), array('i18n' => array('color'), 'color' => self::getColorInClear($card['color'])));
                if ($card['color'] == 0)  { // Blue
                    self::executeDraw($player_id, 9); // "Draw a 9"
                    self::transferCardFromTo($card, $player_id, 'hand'); // Keep revealed card
                } else if ($card['color'] == 2) { // Green
                    for ($color = 0; $color < 5; $color++) {
                        self::unsplay($player_id, $player_id, $color);
                    }
                    self::transferCardFromTo($card, $player_id, 'hand'); // Keep revealed card
                } else if ($card['color'] == 1 || $card['color'] == 3)  { // Red or yellow
                    self::setAuxiliaryValue($card['color']);
                    $step_max = 1;
                } else {
                    self::transferCardFromTo($card, $player_id, 'hand'); // Keep revealed card
                };
                break;
            
            // id 144, Artifacts age 3: Shroud of Turin
            case "144N1":
                $step_max = 1;
                break;
            
            // id 145, Artifacts age 4: Petition of Right
            case "145C1":
                $num_cards = 0;
                for ($color = 0; $color < 5 ; $color++) {
                    $top_card = self::getTopCardOnBoard($player_id, $color);
                    if (self::hasRessource($top_card, 4 /* tower */)) {
                        $num_cards++;
                    }
                }
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} top card(s) with a ${tower} on your board.'), array('i18n' => array('n'), 'You' => 'You', 'n' => self::getTranslatedNumber($num_cards), 'tower' => $tower));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} top card(s) with a ${tower} on his board.'), array('i18n' => array('n'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => self::getTranslatedNumber($num_cards), 'tower' => $tower));
                self::setAuxiliaryValue($num_cards);
                if ($num_cards > 0) {
                    $step_max = 1;
                }
                break;

            // id 146, Artifacts age 4: Delft Pocket Telescope
            case "146N1":
                $step_max = 1;
                break;

            // id 147, Artifacts age 4: East India Company Charter
            case "147N1":
                $step_max = 2;
                break;

            // id 148, Artifacts age 4: Tortugas Galleon
            case "148C1":
                $card_ids = self::getIdsOfHighestCardsInLocation($player_id, 'score');
                if (count($card_ids) > 0) {
                    // "I compel you to transfer all the highest cards from your score pile to my score pile!"
                    foreach ($card_ids as $card_id) {
                        $card = self::getCardInfo($card_id);
                        self::transferCardFromTo($card, $launcher_id, 'score', /*bottom_to=*/ false, /*score_keyword=*/ false);
                    }
                    self::setAuxiliaryValue($card['age']);
                    $step_max = 1;
                }
                break;
            
            // id 149, Artifacts age 4: Molasses Reef Caravel
            case "149N1":
                $step_max = 4;
                break;

            // id 150, Artifacts age 4: Hunt-Lenox Globe
            case "150N1":
                $step_max = 1;
                break;
            
            // id 151, Artifacts age 4: Moses
            case "151C1":    
                // "I compel you transfer all top cards with a crown from your board to my score pile"
                $no_top_card_with_crown = true;
                for ($color = 0; $color < 5 ; $color++) {
                    $top_card = self::getTopCardOnBoard($player_id, $color);
                    if (self::hasRessource($top_card, 1 /* crown */)) {
                        $no_top_card_with_crown = false;
                        self::transferCardFromTo($top_card, $launcher_id, 'score');
                    }
                }
                if ($no_top_card_with_crown) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no top cards with a ${crown} on your board.'), array('You' => 'You', 'crown' => $crown));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no top cards with a ${crown} on his board.'), array('player_name' => self::getColoredPlayerName($player_id), 'crown' => $crown));
                }
                break;

            case "151N1":
                $step_max = 1;
                break;

            // id 152, Artifacts age 4: Mona Lisa
            case "152N1":
                $step_max = 2;
                break;

            // id 153, Artifacts age 4: Cross of Coronado
            case "153N1":
                // "Reveal your hand"
                self::revealHand($player_id);
            
                // "If you have exactly five cards and five colors in your hand, you win"
                $card_count_by_color = self::countCardsInLocationKeyedByColor($player_id, 'hand');
                if (count(array_diff($card_count_by_color, array(1))) == 0) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have exactly five cards and five colors in your hand.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has exactly five cards and five colors in his hand.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    $this->innovationGameState->set('winner_by_dogma', $player_id);
                    self::trace('EOG bubbled from self::stInterInteractionStep CrossOfCoronado');
                    throw new EndOfGame();
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} do not have exactly five cards and five colors in your hand.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} does not have exactly five cards and five colors in his hand.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                break;

            // id 154, Artifacts age 4: Abell Gallery Harpsichord
            case "154N1":
                // "For each value of top card on your board appearing exactly once draw and score a card of that value in ascending order"
                $top_cards = self::getTopCardsOnBoard($player_id);
                $top_values = array();
                foreach ($top_cards as $top_card) {
                    $top_values[] = $top_card['faceup_age'];
                }
                asort($top_values);
                foreach (array_count_values($top_values) as $value => $count) {
                    // Appears exactly once
                    if ($count == 1) {
                        self::executeDraw($player_id, $value, 'score');
                    }
                }
                break;

            // id 155, Artifacts age 5: Boerhavve Silver Microscope
            case "155N1":
                $step_max = 2;
                break;

            // id 156, Artifacts age 5: Principia
            case "156N1":
                $step_max = 1;
                break;
            
            // id 157, Artifacts age 5: Bill of Rights
            case "157C1":
                // "A color where you have more visible cards than I do"
                $colors_with_more_visible_cards = array();
                for ($color = 0; $color < 5; $color++){
                    if (self::countVisibleCards($player_id, $color) > self::countVisibleCards($launcher_id, $color)) {
                        $colors_with_more_visible_cards[] = $color;
                        $step_max = 1;
                    }
                }
                $this->innovationGameState->setFromArray('color_array', $colors_with_more_visible_cards);
                break;

            // id 158, Artifacts age 5: Ship of the Line Sussex
            case "158N1":
                $number_of_cards_in_score_pile = self::countCardsInLocation($player_id, 'score');
                if ($number_of_cards_in_score_pile == 0) {
                    // Only do interaction B
                    $step = 2;
                    $step_max = 2;
                } else {
                    // Only do interaction A
                    $step_max = 1;
                }
                break;
 
            // id 159, Artifacts age 5: Barque-Longue La Belle
            case "159N1":
                do {
                    $card = self::executeDrawAndMeld($player_id, 5); // "Draw and meld a 5"
                } while ($card['color'] != 2); // // "If the drawn card is not green, repeat this effect"
                break;

            // id 160, Artifacts age 5: Hudson's Bay Company Archives
            case "160N1":
                // "Score the bottom card of every color on your board"
                for ($color = 0; $color< 5; $color++) {
                    $card = self::getBottomCardOnBoard($player_id, $color);
                    if ($card !== null) {
                        self::scoreCard($card, $player_id);
                    }
                }
                $step_max = 1;
                break;

            // id 161, Artifacts age 5: Gujin Tushu Jinsheng
            case "161N1":
                // "If Gujin Tushu Jinsheng is on your board"
                $top_yellow_card = self::getTopCardOnBoard($player_id, 3);
                if ($top_yellow_card !== null && $top_yellow_card['id'] == 161) {
                    $step_max = 1;
                }
                break;

            // id 162, Artifacts age 5: The Daily Courant
            case "162N1":
                $step_max = 3;
                break;

            // id 163, Artifacts age 5: Sandham Room Cricket Bat
            case "163N1":
                // "Draw and reveal a 6"
                $card = self::executeDraw($player_id, 6, 'revealed');
                if ($card['color'] == 1) { // "If it is red"
                    $step_max = 1;
                }
                self::notifyGeneralInfo(clienttranslate('This card is ${color}.'), array('i18n' => array('color'), 'color' => self::getColorInClear($card['color'])));
                self::transferCardFromTo($card, $player_id, 'hand');
                break;
 
            // id 164, Artifacts age 5: Almira, Queen of the Castle
            case "164N1":
                $step_max = 1;
                break;

            // id 165, Artifacts age 6: Kilogram of the Archives
            case "165N1":
                $step_max = 2;
                break;

            // id 166, Artifacts age 6: Puffing Billy
            case "166N1":
                $step_max = 1;
                break;

            // id 167, Artifacts age 6: Frigate Constitution
            case "167C1":
                $step_max = 1;
                break;

            // id 168, Artifacts age 6: U.S. Declaration of Independence
            case "168C1":
                $step_max = 3;
                break;

            // id 169, Artifacts age 6: The Wealth of Nations
            case "169N1":
                // "Draw and score a 1"
                self::executeDraw($player_id, 1, 'score');
                // "Add up the values of all the cards in your score pile, divide by five, and round up"
                $age_to_score = ceil(self::getPlayerScore($player_id) / 5);
                // "Draw and score a card of value equal to the result"
                self::executeDraw($player_id, $age_to_score, 'score');
                break;
                
            // id 170, Artifacts age 6: Buttonwood Agreement
            case "170N1":
                $step_max = 1;
                break;

            // id 171, Artifacts age 6: Stamp Act
            case "171C1":
                $top_yellow_card = self::getTopCardOnBoard($player_id, 3);
                if ($top_yellow_card !== null) {
                    self::setAuxiliaryValue($top_yellow_card['age']);
                    $step_max = 1;
                }
                break;

            // id 172, Artifacts age 6: Pride and Prejudice
            case "172N1":
                do {
                    // "Draw and meld a 6"
                    $card = self::executeDrawAndMeld($player_id, 6);
                    // "If the drawn card's color is the color with the fewest (or tied) number of visible cards on your board"
                    $num_visible_cards_of_drawn_color = self::countVisibleCards($player_id, $card['color']);
                    for ($color = 0; $color < 5; $color++) {
                        if ($num_visible_cards_of_drawn_color > self::countVisibleCards($player_id, $color)) {
                            break 2; // Exit do-while loop
                        }
                    }
                    // "Score the melded card"
                    self::scoreCard($card, $player_id);
                } while (true); // "Repeat this effect"
                break;

            // id 173, Artifacts age 6: Moonlight Sonata
            case "173N1":
                if (self::getMaxAgeOnBoardTopCards($player_id) > 0) {
                    $step_max = 2;
                }
                break;
                
            // id 174, Artifacts age 6: Marcha Real
            case "174N1":
                self::setAuxiliaryValue(-1);
                self::setAuxiliaryValue2(-1);
                $step_max = 1;
                break;

            // id 175, Artifacts age 7: Periodic Table
            case "175N1":
                // Determine if there are any top cards which have the same value as another top card on their board
                $colors = self::getColorsOfRepeatedValueOfTopCardsOnBoard($player_id);
                if (count($colors) >= 2) {
                    self::setAuxiliaryValueFromArray($colors);
                    $step_max = 2;
                } else {
                    self::notifyGeneralInfo(clienttranslate("No two top cards have the same value."));
                }
                break;

            // id 176, Artifacts age 7: Corvette Challenger
            case "176N1":
                // "Draw and tuck an 8"
                $card = self::executeDrawAndTuck($player_id, 8);
                // "Splay up the color of the tucked card"
                self::splayUp($player_id, $player_id, $card['color']);
                //  "Draw and score a card of value equal to the number of cards of that color visible on your board"
                $visible_card_count = self::countVisibleCards($player_id, $card['color']);
                self::notifyPlayer($player_id, 'log', clienttranslate('There are ${number} ${color} card(s) visible on ${your} board.'), array(
                    'i18n' => array('color'),
                    'number' => $visible_card_count,
                    'color' => self::getColorInClear($card['color']),
                    'your' => 'your')
                );
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('There are ${number} ${color} card(s) visible on ${player_name}\'s board.'), array(
                    'i18n' => array('color'),
                    'number' => $visible_card_count,
                    'color' => self::getColorInClear($card['color']),
                    'player_name' => self::getColoredPlayerName($player_id))
                );
                self::executeDraw($player_id, $visible_card_count, 'score');
                break;

            // id 177, Artifacts age 7: Submarine H. L. Hunley
            case "177C1":
                // "I compel you to draw and meld a 7" 
                $card = self::executeDrawAndMeld($player_id, 7);

                // "Reveal the bottom card on your board of the melded card's color"
                $bottom_card = self::getBottomCardOnBoard($player_id, $card['color']);
                self::transferCardFromTo($bottom_card, $player_id, 'revealed');

                // "If the revealed card is a 1"
                if ($bottom_card['faceup_age'] == 1) {
                    $step_max = 1;
                    self::setAuxiliaryValue($bottom_card['color']);
                }
                // Put the revealed card back on the bottom
                $revealed_card = self::getCardInfo($bottom_card['id']);
                self::tuckCard($revealed_card, $player_id);
                break;

            // id 178, Artifacts age 7: Jedlik's Electromagnetic Self-Rotor
            case "178N1":
                // "Draw and score an 8"
                $card = self::executeDraw($player_id, 8, 'score');
                // "Draw and meld an 8"
                $card = self::executeDrawAndMeld($player_id, 8);
                $step_max = 1;
                break;

            // id 179, Artifacts age 7: International Prototype Metre Bar
            case "179N1":
                $step_max = 1;
                break;

            // id 180, Artifacts age 7: Hansen Writing Ball
            case "180C1":
                // "I compel you to draw four 7s"
                self::executeDraw($player_id, 7);
                self::executeDraw($player_id, 7);
                self::executeDraw($player_id, 7);
                self::executeDraw($player_id, 7);

                $number_of_blue_cards = self::countCardsInLocationKeyedByColor($player_id, 'hand')[0];
                if ($number_of_blue_cards == 0) {
                    self::revealHand($player_id);
                    $color_in_clear = self::getColorInClear(0);
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no ${colored} cards in your hand.'), array('i18n' => array('colored'), 'You' => 'You', 'colored' => $color_in_clear));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no ${colored} cards in his hand.'), array('i18n' => array('colored'), 'player_name' => self::getColoredPlayerName($player_id), 'colored' => $color_in_clear));

                    // "Transfer all cards in your hand to my hand"
                    foreach (self::getIdsOfCardsInLocation($player_id, 'hand') as $id) {
                        self::transferCardFromTo(self::getCardInfo($id), $launcher_id, 'hand');
                    }
                } else {
                    $step_max = 1;
                }
                break;

            case "180N1":
                do {
                    // "Draw and reveal a 7"
                    $card = self::executeDraw($player_id, 7, 'revealed');
                    if (self::hasRessource($card, 6)) {
                        self::transferCardFromTo($card, $player_id, 'hand');
                        break;
                    } else {
                        // "If it has no clocks, tuck it"
                        self::tuckCard($card, $player_id);
                    }
                } while (true); // "Repeat this effect"
                break;

            // id 181, Artifacts age 7: Colt Paterson Revolver
            case "181C1":
                // "I compel you to reveal your hand"
                self::revealHand($player_id);

                // Store list of colors in hand before the new card is drawn.
                $cards = self::getCardsInHand($player_id);
                $colors_in_hand = array(0, 0, 0, 0, 0);
                foreach ($cards as $card) {
                    $colors_in_hand[$card['color']] = 1;
                }

                // "Draw a 7"
                if (count($cards) > 0) {
                    // If the player has other cards in hand, we need to reveal the card first in order to prove to other players
                    // whether the card matched the color of another card in hand.
                    $new_card = self::transferCardFromTo(self::executeDraw($player_id, 7, 'revealed'), $player_id, 'hand');
                } else {
                    $new_card = self::executeDraw($player_id, 7);
                }
                
                // "If the color of the drawn card matches the color of any other cards in your hand"
                if ($colors_in_hand[$new_card['color']] == 1) {
                    self::notifyGeneralInfo(clienttranslate("The drawn card's color matches the color of another card in hand."));
                    $step_max = 2;
                } else {
                    self::notifyGeneralInfo(clienttranslate("The drawn card's color does not match the color of another card in hand."));
                }
                break;
                
            // id 182, Artifacts age 7: Singer Model 27
            case "182N1":
                $step_max = 1;
                break;

            // id 183, Artifacts age 7: Roundhay Garden Scene
            case "183N1":
                $step_max = 1;
                break;

            // id 184, Artifacts age 7: The Communist Manifesto
            case "184N1":
                // "For each player in the game, draw and reveal a 7"
                foreach (self::getAllActivePlayerIds() as $any_player_id) {
                    self::executeDraw($player_id, 7, 'revealed');
                }
                $this->innovationGameState->setFromArray('player_array', self::getAllActivePlayers());
                $step_max = 2;
                break;

            // id 185, Artifacts age 8: Parnell Pitch Drop
            case "185N1":
                // "Draw and meld a card of value one higher than the highest top card on your board"
                $card = self::executeDrawAndMeld($player_id, self::getMaxAgeOnBoardTopCards($player_id) + 1);
                if (self::countIconsOnCard($card, 6) == 3) {
                    // "If the melded card has three clocks, you win"
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} melded a card with 3 ${clocks}.'), array('You' => 'You', 'clocks' => $clock));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} melded a card with 3 ${clocks}.'), array('player_name' => self::getColoredPlayerName($player_id), 'clocks' => $clock));
                    $this->innovationGameState->set('winner_by_dogma', $player_id);
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn Parnell Pitch Drop');
                    throw new EndOfGame();
                }
                break;

            // id 186, Artifacts age 8: Earhart's Lockheed Electra 10E
            case "186N1":
                self::setAuxiliaryValue(0);
                $this->innovationGameState->set('age_last_selected', 9);
                $step_max = 1;
                break;

            // id 187, Artifacts age 8: Battleship Bismarck
            case "187C1":
                // "Draw and reveal an 8"
                $card = self::executeDraw($player_id, 8, 'revealed');
                self::transferCardFromTo($card, $player_id, 'hand');
                self::setAuxiliaryValue($card['color']);
                $step_max = 1;
                break;

            // id 189, Artifacts age 8: Ocean Liner Titanic
            case "189N1":
                // "Score all bottom cards from your board"
                for ($color = 0; $color < 5; $color++) {
                    $card = self::getBottomCardOnBoard($player_id, $color);
                    if ($card !== null) {
                        $card = self::scoreCard($card, $player_id);
                    }
                }
                break;

            // id 190, Artifacts age 8: Meiji-Mura Stamp Vending Machine
            case "190N1":
                $step_max = 1;
                break;

            // id 191, Artifacts age 8: Plush Beweglich Rod Bear
            case "191N1":
                $step_max = 2;
                break;

           // id 192, Artifacts age 8: Time
            case "192C1":
                $step_max = 1;
                break;

           // id 193, Artifacts age 8: Garland's Ruby Slippers
            case "193N1":
                $step_max = 1;
                break;
                
            // id 194, Artifacts age 8: '30 World Cup Final Ball
            case "194C1":
                $step_max = 1;
                break;

            case "194N1":
                do {
                    // "Draw and reveal an 8"
                    $card = self::executeDraw($player_id, 8, 'revealed');
                    $color = $card['color'];
                    
                    // "The single player with the highest top card of the drawn card's color achieves it, ignoring eligibility"
                    $player_ids = self::getOwnersOfTopCardWithColorAndAge($color, self::getMaxAgeOfTopCardOfColor($color));
                    if (count($player_ids) == 1) {
                        $single_player_id = $player_ids[0];
                        self::notifyPlayer($single_player_id, 'log', clienttranslate('${You} have the highest top ${color} card.'), array(
                            'i18n' => array('color'),
                            'You' => 'You',
                            'color' => self::getColorInClear($color)
                        )); 
                        self::notifyAllPlayersBut($single_player_id, 'log', clienttranslate('${player_name} has the highest top ${color} card.'), array(
                            'i18n' => array('color'),
                            'player_name' => self::getColoredPlayerName($single_player_id),
                            'color' => self::getColorInClear($color)
                        ));
                        self::transferCardFromTo($card, $single_player_id, 'achievements');
                    } else {
                        break;
                    }
                } while (true); // "If that happens, repeat this effect"
                self::transferCardFromTo($card, $player_id, 'hand');
                break;
                
            
            // id 195, Artifacts age 9: Yeager's Bell X-1A
            case "195N1+":
                // "If that card has a clock, repeat this effect"
                if (self::getAuxiliaryValue() == 1) {
                    // Reset the post_execution_index so that we will return to 195N1+ (instead of 195N1++)
                    // if we repeat the effect again.
                    self::updateCurrentNestedCardState('post_execution_index', 0);
                    // Purposefully fall through to 195N1 so that the effect can be repeated.
                } else {
                    break;
                }

            case "195N1":
                // "Draw and meld a 9"
                $card = self::executeDrawAndMeld($player_id, 9);

                // Store information about whether the card has a clock or not
                if (self::hasRessource($card, 6)) {
                    self::setAuxiliaryValue(1);
                } else {
                    self::setAuxiliaryValue(0);
                }

                // "Execute the effects of the melded card as if they were on this card, without sharing"
                self::executeAllEffects($card);
                break;

            // id 196, Artifacts age 9: Luna 3
            case "196N1":
                $step_max = 1;
                break;            

            // id 197, Artifacts age 9: United Nations Charter
            case "197C1":
                $step_max = 1;
                break;            

            case "197N1":
                // "If you have a top card on your board with a demand effect, draw a 10"
                $top_cards = self::getTopCardsOnBoard($player_id);
                foreach ($top_cards as $card){
                    if ($card['has_demand'] == true) {
                        self::executeDraw($player_id, 10);
                        break;
                    }
                }
                break;            

            // id 198, Artifacts age 9: Velcro Shoes
            case "198C1":
                $step_max = 1;
                break;            

            // id 199, Artifacts age 9: Philips Compact Cassette
            case "199C1":
                // "I compel you to unsplay all splayed colors on your board!"
                for ($color = 0; $color < 5; $color++) {
                    self::unsplay($player_id, $player_id, $color);
                }
                break;

            case "199N1":
                // If there are only one or two splayable stacks then we can splay up automatically
                $splayable_colors = self::getSplayableColorsOnBoard($player_id, /*splay_direction=*/ 3);
                if (count($splayable_colors) <= 2) {
                    foreach ($splayable_colors as $color) {
                        self::splayUp($player_id, $player_id, $color);
                    }
                
                // Otherwise we need to prompt the player to choose which colors to splay up
                } else {
                    $step_max = 1;
                }
                break;

            // id 200, Artifacts age 9: Syncom 3
            case "200N1":
                $step_max = 1;
                break;

            // id 201, Artifacts age 9: Rock Around the Clock
            case "201N1":
                // "For each top card on your board with a clock, draw and score a 9"
                $top_cards = self::getTopCardsOnBoard($player_id);
                foreach ($top_cards as $card){
                    if (self::hasRessource($card, 6)) {
                        self::executeDraw($player_id, 9, 'score');
                    }
                }
                break;        
            
            // id 202, Artifacts age 9: Magnavox Odyssey
            case "202N1":
                // "Draw and meld two 10s"
                $card_1 = self::executeDrawAndMeld($player_id, 10);
                $card_2 = self::executeDrawAndMeld($player_id, 10);
                
                // "If they are the same color, you win"
                if ($card_1['color'] == $card_2['color']) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} melded two cards of the same color'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} melded two cards of the same color'), array('player_name' => self::getColoredPlayerName($player_id)));
                    $this->innovationGameState->set('winner_by_dogma', $player_id);
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn Magnavox Odyssey');
                    throw new EndOfGame();
                }
                break;
            
            // id 203, Artifacts age 9: The Big Bang
            case "203N1+":
                // "If this caused any change to occur, draw and remove a 10 from the game, then repeat this effect"
                if (self::getAuxiliaryValue() == 1) {
                    $card = self::executeDraw($player_id, 10, 'revealed');
                    self::transferCardFromTo($card, 0, 'removed');
                    // Reset the post_execution_index so that we will return to 203N1+ (instead of 203N1++)
                    // if we repeat the effect again.
                    self::updateCurrentNestedCardState('post_execution_index', 0);
                    // Purposefully fall through to 203N1 so that the effect can be repeated.
                } else {
                    break;
                }

            case "203N1":
                // "Execute the non-demand effects of your top blue card, without sharing"
                $top_blue_card = self::getTopCardOnBoard($player_id, 0);
                if ($top_blue_card !== null) {
                    self::setAuxiliaryValue(0);
                    self::executeNonDemandEffects($top_blue_card);
                }
                break;

            // id 204, Artifacts age 9: Marilyn Diptych
            case "204N1":
                $step_max = 2;
                break;

            // id 205, Artifacts age 10: Rover Curiosity
            case "205N1":
                // "Draw and meld an Artifact 10"
                $card = self::executeDrawAndMeld($player_id, 10, /*type=*/ 1);
                // "Execute the effects of the melded card as if they were on this card. Do not share them"
                self::executeAllEffects($card);
                break;
            
            // id 206, Artifacts age 10: Higgs Boson
            case "206N1":
                // "Transfer all cards on your board to your score pile"
                $piles = self::getCardsInLocationKeyedByColor($player_id, 'board');
                for ($i = 0; $i < 5 ; $i++){
                    $pile = $piles[$i];
                    for ($j = count($pile) - 1; $j >= 0; $j--) {
                        self::transferCardFromTo($pile[$j], $player_id, 'score', /*bottom_to=*/ false, /*score_keyword=*/ false);
                    }
                }
                break;
                
           // id 207, Artifacts age 10: Exxon Valdez
            case "207C1":
                // "I compel you to remove all cards from your hand, score pile, board, and achievements from the game"
                self::removeAllCardsFromPlayer($player_id);
                
                // "You lose! If there is only one player remaining in the game, that player wins"
                if (self::decodeGameType($this->innovationGameState->get('game_type')) == 'individual') {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} lose.'),  array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} loses.'), array(
                        'player_name' => self::getColoredPlayerName($player_id)
                    ));
                    self::eliminatePlayer($player_id);
                    if (count(self::getAllActivePlayers()) == 1) {
                        $this->innovationGameState->set('winner_by_dogma', $launcher_id);
                        self::trace('EOG bubbled from self::stInterInteractionStep Exxon Valdez');
                        throw new EndOfGame();
                    }
                } else { // Team play
                    // Entire team loses if one player loses 
                    $teammate_id = self::getPlayerTeammate($player_id);
                    $losing_team = array($player_id, $teammate_id);
                    self::notifyPlayer($player_id, 'log', clienttranslate('${Your} team loses.'), array('Your' => 'Your'));
                    self::notifyPlayer($teammate_id, 'log', clienttranslate('${Your} team loses.'), array('Your' => 'Your'));
                    self::notifyAllPlayersBut($losing_team, 'log', clienttranslate('The other team loses.'), array());
                    self::eliminatePlayer($player_id);
                    self::eliminatePlayer($teammate_id);
                    $this->innovationGameState->set('winner_by_dogma', $launcher_id);
                    self::trace('EOG bubbled from self::stInterInteractionStep Exxon Valdez');
                    throw new EndOfGame();
                }
                break;

            // id 208, Artifacts age 10: Maldives
            case "208C1":
                $step_max = 2;
                break;

            case "208N1":
                $score_cards = self::getCardsInLocation($player_id, 'score');
                self::setAuxiliaryValue(count($score_cards));
                if (count($score_cards) > 4) {
                    $step_max = 1;
                }
                break;

            // id 209, Artifacts age 10: Maastricht Treaty
            case "209N1":
                // "If you have the most cards in your score pile, you win"
                $win_condition_met = true;
                $cards_in_my_score_pile = self::countCardsInLocation($player_id, 'score');
                foreach (self::getAllActivePlayerIds() as $id) {
                    if ($player_id != $id && self::countCardsInLocation($id, 'score') >= $cards_in_my_score_pile) {
                        $win_condition_met = false;
                        break;
                    }
                }
                if ($win_condition_met) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have the most cards in your score pile.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has the most cards in his score pile.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    $this->innovationGameState->set('winner_by_dogma', $player_id);
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn Maastricht Treaty');
                    throw new EndOfGame();
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} do not have the most cards in your score pile.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} does not have the most cards in his score pile.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                break;

            // id 210, Artifacts age 10: Seikan Tunnel
            case "210N1":
                // "If you have the most cards of a color showing on your board out of all colors on all boards, you win"
                $win_condition_met = true;
                $max_visible_card_count = self::getSizeOfMaxVisiblePileOnBoard($player_id);
                foreach (self::getAllActivePlayerIds() as $id) {
                    if ($id != $player_id && self::getSizeOfMaxVisiblePileOnBoard($id) > $max_visible_card_count) {
                        $win_condition_met = false;
                        break;
                    }
                }

                // There is a stack on your board that has the most cards of all stacks on all boards
                if ($win_condition_met) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have the most cards of a color showing on your board out of all colors on all boards.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has the most cards of a color showing on his board out of all colors on all boards.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    $this->innovationGameState->set('winner_by_dogma', $player_id);
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn Seikan Tunnel');
                    throw new EndOfGame();
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} do not have the most cards of a color showing on your board out of all colors on all boards.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} does not have the most cards of a color showing on his board out of all colors on all boards.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                break;
                
            // id 211, Artifacts age 10: Dolly the Sheep
            case "211N1":
                $step_max = 3;
                break;
            
            // id 212, Artifacts age 10: Where's Waldo?
            case "212N1":
                // "You win"
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} found Waldo!'), array('You' => 'You'));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} found Waldo!'), array('player_name' => self::getColoredPlayerName($player_id)));
                $this->innovationGameState->set('winner_by_dogma', $player_id);
                self::trace('EOG bubbled from self::stPlayerInvolvedTurn Wheres Waldo');
                throw new EndOfGame();
                break;

             // id 213, Artifacts age 10: DeLorean DMC-12
            case "213N1":
                // "If DeLorean DMC-12 is a top card on any board, remove all top cards on all boards and all cards in all hands from the game"
                if (self::isTopBoardCard(self::getCardInfo(213))) {
                    self::removeAllTopCardsAndHands();
                }
                break;
            
            // id 214, Artifacts age 10: Twister
            case "214C1":
                // "I compel you to reveal your score pile"
                self::revealScorePile($player_id);
                $colors = array();
                foreach (self::getCardsInLocation($player_id, 'score') as $card) {
                    $colors[] = $card['color'];
                }
                if (count($colors) > 0) {
                    self::setAuxiliaryValueFromArray(array_unique($colors));
                    $step_max = 1;
                }
                break;

            // id 216, Relic age 4: Complex Numbers
            case "216N1":
                if (self::countCardsInLocation($player_id, 'hand') > 0) {
                    $step_max = 1;
                }
                break;

            // id 217, Relic age 5: Newton-Wickins Telescope
            case "217N1":
                $step_max = 1;
                break;

            // id 219, Relic age 7: Safety Pin
            case "219E1":
                // Draw and score a 7."
                self::executeDraw($player_id, 7, 'score');
                break;

            case "219D1":
                $step_max = 1;
                break;
                
            // id 330, Echoes age 1: Dice
            case "330N1":
                // "Draw and reveal a 1"
                $card = self::executeDraw($player_id, 1, 'revealed');
                self::transferCardFromTo($card, $player_id, 'hand');
                
                // "If the card has a bonus, draw and meld a card of value equal to its bonus"
                $bonuses = self::getBonusIcons($card);
                if (count($bonuses) > 0) {
                    // Only Cities cards can have more than one bonus (but these cards won't be drawn here) so we can just
                    // pick the first (and only) bonus on the Echoes card.
                    self::executeDrawAndMeld($player_id, $bonuses[0]);
                }
                break;

            // id 331, Echoes age 1: Perfume
            case "331D1":
                // Find all colors with ages that are on the player's board, but not on the launcher's board
                $colors = array();
                for ($color = 0; $color < 5; $color++) {
                    $player_top_card = self::getTopCardOnBoard($player_id, $color);
                    if ($player_top_card == null) {
                        continue;
                    }
                    $age_found = false;
                    for ($color2 = 0; $color2 < 5; $color2++) {
                        $launcher_top_card = self::getTopCardOnBoard($launcher_id, $color2);
                        if ($launcher_top_card == null) {
                            continue;
                        }
                        
                        if ($player_top_card['faceup_age'] == $launcher_top_card['faceup_age']) {
                            $age_found = true;
                        }
                    }
                    if ($age_found == false) {
                        $colors[] = $color;
                    }
                }
                
                if (count($colors) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryValueFromArray($colors);
                }
                else {
                    self::notifyGeneralInfo(clienttranslate('All top cards had identical values, so no transfer will occur.'));
                }
                break;

            case "331E1":
                // "Draw and tuck a 1."
                self::executeDrawAndTuck($player_id, 1);
                break;
                
            // id 332, Echoes age 1: Ruler
            case "332E1":
                // "Draw a 2."
                self::executeDraw($player_id, 2);
                break;            
            
            // id 333, Echoes age 1: Bangle
            case "333N1":
                //  "Draw and foreshadow a 3"
                self::executeDrawAndForeshadow($player_id, 3);
                break;

            case "333E1":
                $cards = self::countCardsInLocationKeyedByColor($player_id, 'hand');
                if ($cards[1 /* red */] == 0) {
                    self::revealHand($player_id);
                } else {
                    $step_max = 1;
                }
                break;
            
            // id 334, Echoes age 1: Candles
            case "334D1":
                $has_card_with_tower = false;
                foreach (self::getCardsInLocation($player_id, 'hand') as $card) {
                    if (self::hasRessource($card, 4 /* tower */)) {
                        $has_card_with_tower = true;
                        break;
                    }
                }
                if ($has_card_with_tower) {
                    $step_max = 1;
                } else {
                    self::revealHand($player_id);
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no cards with a ${tower} in your hand.'), array('You' => 'You', 'tower' => $tower));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no cards with a ${tower} in his hand.'), array('player_name' => self::getColoredPlayerName($player_id), 'tower' => $tower));
                }
                break;

            case "334E1":
                // "If every other player has a higher score than you, draw a 3."
                $player_score = self::getPlayerScore($player_id);
                $min_score = true;
                foreach (self::getActiveOpponentIds($player_id) as $p_id) {
                    if ($player_id != $p_id && $player_score >= self::getPlayerScore($p_id)) {
                        $min_score = false;
                    }
                }
                if ($min_score) {
                    self::executeDraw($player_id, 3);
                }
                break;

            // id 335, Echoes age 1: Plumbing
            case "335E1":
                $step_max = 1;
                break;
                
            // id 336, Echoes age 1: Comb
            case "336N1":
                $step_max = 2;
                break;

            // id 337, Echoes age 1: Ice skates
            case "337N1":
                $step_max = 3;
                break;

            // id 338, Echoes age 1: Umbrella
            case "338N1":
                $step_max = 1;
                break;

            case "338E1":
                $step_max = 1;
                break;

            // id 339, Echoes age 1: Chopsticks
            case "339E1":
                // "Draw a 1"
                self::executeDraw($player_id, 1);
                break;

            case "339N1":
                // "If the 1 deck has at least one card"
                $deck_cards = self::countCardsInLocationKeyedByAge(/*owner=*/ 0, 'deck', /*type=*/ 0);
                if ($deck_cards[1] > 0) {
                    $step_max = 1;
                }
                break;
                
            // id 340, Echoes age 1: Noodles
            case "340N1":
                // "If you have more 1s in your hand than every other player, draw and score a 2"
                $num_cards = self::countCardsInLocationKeyedByAge($player_id, 'hand');
                
                if ($num_cards[1] > 0) {
                    $score_a_2 = true;
                    foreach (self::getActiveOpponentIds($player_id) as $any_player_id) {
                        $num_other_cards = self::countCardsInLocationKeyedByAge($any_player_id, 'hand');
                        if ($num_cards[1] <= $num_other_cards[1]) {
                            $score_a_2 = false;
                        }
                    }
                    
                    if ($score_a_2) {
                        self::executeDrawAndScore($player_id, 2);
                    }
                }
                break;
            
            case "340N2":
                // "Draw and reveal a 1"
                $card = self::executeDraw($player_id, 1, 'revealed');
                self::notifyGeneralInfo(clienttranslate('This card is ${color}.'), array('i18n' => array('color'), 'color' => self::getColorInClear($card['color'])));
                self::transferCardFromTo($card, $player_id, 'hand');
                
                // "If it is yellow, score all 1s from your hand"
                if ($card['color'] == 3) {
                    $hand_cards = self::getCardsInHand($player_id);
                
                    foreach ($hand_cards as $card) {
                        $card = self::getCardInfo($card['id']);
                        if ($card['age'] == 1) {
                            self::scoreCard($card, $player_id);
                        }
                    }
                }
                break;

            // id 341, Echoes age 1: Soap
            case "341N1":
                if (self::countCardsInHand($player_id) > 0) {
                    $step_max = 2;
                }
                break;

            // id 342, Echoes age 1: Bell
            case "342N1":
                //  "Draw and foreshadow a 2."
                self::executeDrawAndForeshadow($player_id, 2);
                break;

            case "342E1":
                if (self::countCardsInHand($player_id) > 0) {
                    $step_max = 1;
                }
                break;

            // id 343, Echoes age 1: Flute
            case "343E1":
                $step_max = 1;
                break;

            case "343D1":
                $step_max = 1;
                break;

            case "343N1":
                //  "Draw and reveal a 1."
                $card = self::executeDraw($player_id, 1, 'revealed');
                self::transferCardFromTo($card, $player_id, 'hand');
                if (count(self::getBonusIcons($card)) > 0) {
                    // "If it has a bonus, draw a 1."
                    self::executeDraw($player_id, 1);
                }
                break;

            // id 345, Echoes age 2: Lever
            case "345E1":
                // "Draw two 2s"
                self::executeDraw($player_id, 2);
                self::executeDraw($player_id, 2);
                break;
            
            case "345N1":
                // Need at least one card in hand
                if (self::countCardsInLocation($player_id, 'hand') > 0) {
                    // Start with counts of 0 for each age
                    self::setAuxiliaryArray(array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0));
                    $step_max = 1;
                }
                break;
                
            // id 346, Echoes age 2: Linguistics
            case "346N1":
                $vis_bonuses = array_unique(self::getVisibleBonusesOnBoard($player_id));
                if (count($vis_bonuses) > 1) {
                    $step_max = 1;
                }
                elseif (count($vis_bonuses) == 1) {
                    self::executeDraw($player_id, $vis_bonuses[0]);
                }
                // Otherwise no bonuses present so no choice to be made
                break;

            case "346E1":
                $step_max = 1;
                break;

            // id 347, Echoes age 2: Crossbow
            case "347D1":
                if (self::countCardsInLocation($player_id, 'hand') > 0) {
                    $step_max = 1;
                }
                break;

            case "347N1":
                if (self::countCardsInLocation($player_id, 'hand') > 0) {
                    $step_max = 2;
                }
                break;

            // id 348 Echoes age 2: Horseshoes
            case "348E1":
                // "Draw and foreshadow a 2."
                self::executeDrawAndForeshadow($player_id, 2);
                break;
                
            case "348D1":
                // Find all colors with cards that don't have towers or factories
                $colors = array();
                for ($color = 0; $color < 5; $color++) {
                    $player_top_card = self::getTopCardOnBoard($player_id, $color);
                    if ($player_top_card == null) {
                        continue;
                    }
                    if (!self::hasRessource($player_top_card, 4) && !self::hasRessource($player_top_card, 5)) {
                        $colors[] = $color;
                    }
                } 
                if (count($colors) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryValueFromArray($colors);
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no top cards with a ${icon_4} or ${icon_5}, so no transfer will occur.'), array('You' => 'You', 'icon_4' => self::getIconSquare(4), 'icon_5' => self::getIconSquare(5)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('All of ${player_name}\'s top cards have ${icon_4} or ${icon_5}, so no transfer will occur.'), array('player_name' => self::getColoredPlayerName($player_id), 'icon_4' => self::getIconSquare(4), 'icon_5' => self::getIconSquare(5)));
                }
                break;

            // id 349, Echoes age 2: Glassblowing
            case "349E1":
                if (self::countCardsInHand($player_id) > 0) {
                    $step_max = 1;
                }
                break;

            case "349N1":
                $min_value = 10;
                $cards = self::getTopCardsOnBoard($player_id);
                foreach ($cards as $card) {
                    if ($card['color'] != 2 && $min_value > $card['age']) {
                        $min_value = $card['age'];
                    }
                }
                // "Draw and foreshadow a card of value three higher than the lowest non-green top card on your board."
                self::executeDrawAndForeshadow($player_id, $min_value + 3);
                break;

            // id 350, Echoes age 2: Scissors
            case "350E1":
                $step_max = 1;
                break;

            case "350N1":
                $step_max = 1;
                break;

            case "350N2":
                // "If Paper is a top card on any player's board, transfer it to your score pile."
                $paper_card = self::getCardInfo(30);
                if (self::isTopBoardCard($paper_card)) {
                    self::transferCardFromTo($paper_card, $player_id, 'score', false, /*score_keyword*/false);
                }
                break;
                
            // id 351, Echoes age 2: Toothbrush
            case "351E1":
                $ages = array();
                $cards = self::getCardsInLocationKeyedByAge($player_id, 'hand');
                for ($age = 1; $age <= 11; $age++) {
                    if (count($cards[$age]) > 0) {
                        $ages[] = $age;
                    }
                }
            
                if (count($ages) > 1) {
                    $step_max = 2;
                    self::setAuxiliaryValueFromArray($ages);
                }
                elseif (count($ages) == 1) {
                    $step_max = 2;
                    $step = 2; // no need to choose
                    self::setAuxiliaryValue($ages[0]); 
                }
                
                break;

            case "351N1":
                $step_max = 1;
                break;

            case "351N2":
                // "If the 2 deck has at least one card"
                $deck_cards = self::countCardsInLocationKeyedByAge(0, 'deck', 0);
                if ($deck_cards[2] > 0) {
                    $step_max = 1;
                }
                break;
                
            // id 352, Echoes age 2: Watermill
            case "352N1":
                $step_max = 1;
                break;

            // id 353 Echoes age 2: Pagoda
            case "353N1":
                // "Draw and reveal a 3."
                $revealed_card = self::executeDraw($player_id, 3, 'revealed');
                $cards = self::countCardsInLocationKeyedByColor($player_id, 'hand');
                $color = $revealed_card['color'];
                if ($cards[$color] > 0) {
                    //"If you have a card of matching color in your hand,"
                    $step_max = 1;
                    self::setAuxiliaryValue($color);
                } else {
                    // Reveal hand to confirm no matching cards are there.
                    self::revealHand($player_id);
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no ${color} cards in your hand.'), array('i18n' => array('color'), 'You' => 'You', 'color' => self::getColorInClear($color)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no ${color} cards in his hand.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($color)));
                    
                    // "Otherwise, foreshadow the drawn card."
                    self::transferCardFromTo($revealed_card, $player_id, 'forecast');
                }
                break;

            // id 354, Echoes age 2: Chaturanga
            case "354N1":
                $step_max = 1;
                break;

            // id 355, Echoes age 3: Almanac
            case "355E1":
                // "Draw and foreshadow a 4."
                self::executeDrawAndForeshadow($player_id, 4);
                break;

            case "355N1":
                $step_max = 1;
                break;

            // id 356, Echoes age 3: Magnifying Glass
            case "356E1":
                // "Draw a 4"
                $card = self::executeDraw($player_id, 4);
                $step_max = 1;
                break;

            case "356N1":
                // "You may return three cards of equal value from your hand"
                $cards_in_hand = self::getCardsInLocationKeyedByAge($player_id, 'hand');
                $ages_with_3 = array();
                for ($age = 1; $age <= 11; $age++) {
                    if (count($cards_in_hand[$age]) >= 3) {
                        $ages_with_3[] = $age;
                    }
                }
                $num_ages_with_3 = count($ages_with_3);
                if ($num_ages_with_3 > 0) {
                    $step_max = 2; // Need to select age and cards.
                    if ($num_ages_with_3 == 1) {
                        $step = 2; // Skip the age selection if there is no option.
                        self::setAuxiliaryValue($ages_with_3[0]); // store for selection later
                    }  else {
                        self::setAuxiliaryValueFromArray($ages_with_3); // store for selection later
                    }
                }
                break;

            case "356N2":
                $step_max = 1;
                break;
                
            // id 357, Echoes age 3: Liquid Fire
            case "357D1":
                // "I demand you draw a card of value equal to the highest bonus on your board!"
                $max_bonus = self::getMaxBonusIconOnBoard($player_id);
                $card = self::executeDraw($player_id, $max_bonus, 'revealed');
                
                // "Transfer it to my forecast! "
                self::transferCardFromTo($card, $launcher_id, 'forecast');
                
                if ($card['color'] == 1) { 
                    // "If it is red, transfer all cards from your hand to my score pile!"
                    $hand_cards = self::getCardsInHand($player_id);
                    foreach ($hand_cards as $card) {
                        self::transferCardFromTo($card, $launcher_id, 'score');
                    }
                }
                break;

            // id 358, Echoes age 3: Katana
            case "358D1":
                self::setAuxiliaryValue(0); // Total towers transferred
                $step_max = 2;
                break;

            // id 359, Echoes age 3: Charitable Trust
            case "359E1":
                $step_max = 1;
                break;

            case "359N1":
                // Only execute the non-demand if the echo effect was executed
                if (self::getIndexedAuxiliaryValue($player_id) >= 0) {
                    $step_max = 1;
                }
                break;

            // id 360, Echoes age 3: Homing Pigeons
            case "360D1":
                $cards_in_hand_count = self::countCardsInLocationKeyedByAge($launcher_id, 'hand');
                $score_cards = self::getCardsInLocation($player_id, 'score');
                
                $card_ids_to_return = array();
                foreach ($score_cards as $card) {
                    if ($cards_in_hand_count[$card['age']] > 0) {
                        $card_ids_to_return[] = $card['id'];
                    }
                }
                
                if (count($card_ids_to_return) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryArray($card_ids_to_return); // store ids for later
                }
                break;

            case "360N1":
                $step_max = 1;
                break;
                
            // id 361, Echoes age 3: Deoderant
            case "361N1":
                // "If you have a top card with a tower, draw and meld a 3. Otherwise, draw a 4."
                $has_tower = false;
                foreach (self::getTopCardsOnBoard($player_id) as $card) {
                    if (self::hasRessource($card, 4) ) {
                         $has_tower = true;
                    }
                }
                if ($has_tower) {
                    self::executeDrawAndMeld($player_id, 3);
                } else {
                    self::executeDraw($player_id, 4);
                }
                break;
 
            // id 361, Echoes age 3: Deoderant
            case "361E1":
                // "Draw and meld a 3."
                self::executeDrawAndMeld($player_id, 3);
                break;

            // id 362, Echoes age 3: Sandpaper
            case "362N1":
                $step_max = 2;
                break;

            // id 363, Echoes age 3: Novel
            case "363E1":
                // "Draw a 3"
                $card = self::executeDraw($player_id, 3);
                break;

            case "363N1":
                // "Draw a 3"
                $card = self::executeDraw($player_id, 3);
                $step_max = 1;
                break;

            case "363N2":
                // "If all your non-purple cards share a common icon other than crown, "
                $eligible = false;
                $card_count = 0;
                
                for ($icon = 2; $icon <= 7 && !$eligible; $icon++) { // start after crown
                    $matching_icon = true;
                    for ($color = 0; $color < 4; $color++) {
                        $top_card = self::getTopCardOnBoard($player_id, $color);
                        if ($top_card !== null) {
                            if (!self::hasRessource($top_card, $icon)) {
                                $matching_icon = false;
                            }
                            $card_count++;
                        }                            
                    }
                    if ($matching_icon && $card_count > 0) {
                        $eligible = true;
                        $icon_match = $icon;
                    }
                }
                
                if ($eligible) {
                    self::notifyPlayer($player_id, 'log', 
                        clienttranslate('${You} have at least one non-purple top card and all your top cards have at least one ${icon}.'), 
                        array('You' => 'You', 'icon' => self::getIconSquare($icon_match)));
                    self::notifyAllPlayersBut($player_id, 'log', 
                        clienttranslate('${player_name} has at least one non-purple top card and all his top cards have at least one ${icon}.'), 
                        array('player_name' => self::getColoredPlayerName($player_id), 'icon' => self::getIconSquare($icon_match)));
                    // "claim the Supremacy achievement."
                    self::claimSpecialAchievement($player_id, 439);
                }
                break;

            // id 364, Echoes age 3: Sunglasses
            case "364E1":
                // "Score a card from your hand of a color you have splayed"
                $color_array = array();
                for ($color = 0; $color < 5; $color++) {
                    if (self::getCurrentSplayDirection($player_id, $color) > 0) {
                        $color_array[] = $color;
                    }
                }                
                
                if (count($color_array) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryValueFromArray($color_array); // store colors for later
                }
                break;

            case "364N1":
                // The criteria for continuing is the following:
                //  1.  One purple card must be on the board (otherwise no splays can change)
                //  2.  At least one non-purple card must exist on the board
                //  3.  At least one different splay        
                $top_purple_card = self::getTopCardOnBoard($player_id, 4);
                if ($top_purple_card === null) {
                    // Need at least one purple card for the choice to have an effect.
                    self::notifyPlayer($player_id, 'log', 
                        clienttranslate('${You} do not have a purple card on your board.'),
                        array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', 
                        clienttranslate('${player_name} does not have a purple card on his board.'),
                        array('player_name' => self::getColoredPlayerName($player_id)));                    
                    break;
                } else {
                    $non_purple_card = false;
                    $same_splay_direction = true;
                    $purple_splay = $top_purple_card['splay_direction'];
                    $color_array = array();
                    $card_counts_by_color = self::countCardsInLocationKeyedByColor($player_id, 'board');
                    for ($color = 0; $color < 4; $color++) { // non-purple
                        $top_card = self::getTopCardOnBoard($player_id, $color);
                        if ($card_counts_by_color[$color] > 0 ) { // color present
                            $non_purple_card = true;
                            if ($top_card['splay_direction'] != $purple_splay) {
                                $same_splay_direction = false;
                            }
                        }
                        if ($card_counts_by_color[$color] > 1 ) { // splayable
                            $color_array[] = $color;
                        }
                    }
                    
                    if (!$non_purple_card) {
                        self::notifyPlayer($player_id, 'log', 
                            clienttranslate('${You} do not have a top non-purple card.'), 
                            array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', 
                            clienttranslate('${player_name} does not have a top non-purple card.'), 
                            array('player_name' => self::getColoredPlayerName($player_id)));
                    } else if ($same_splay_direction) {
                        self::notifyPlayer($player_id, 'log', 
                            clienttranslate('All of ${your} piles are already splayed the same direction.'), 
                            array('your' => 'your'));
                        self::notifyAllPlayersBut($player_id, 'log', 
                            clienttranslate('All of ${player_name}\'s piles are already splayed the same direction.'), 
                            array('player_name' => self::getColoredPlayerName($player_id)));
                    } else {
                        $step_max = 1;
                        self::setAuxiliaryValue2FromArray($color_array); // For color selection later
                    }
                }
                break;
                
            // id 365, Echoes age 4: Slide Rule
            case "365N1":
                $step_max = 1;
                break;

            case "365N2":
                // "Draw a card of value equal to the value of your lowest top card plus the number of colors you have splayed."
                $age_to_draw = self::getMinAgeOnBoardTopCards($player_id);
                for($color = 0; $color < 5 ; $color++) {
                    if (self::getCurrentSplayDirection($player_id, $color) > 0) { // This color is splayed
                        $age_to_draw++;
                    }
                }
                $card = self::executeDraw($player_id, $age_to_draw);
                break;

            // id 366, Echoes age 4: Telescope
            case "366E1":
                // "Draw and foreshadow a 5."
                self::executeDrawAndForeshadow($player_id, 5);
                break;

            case "366N1":
                $step_max = 1;
                break;

            // id 367, Echoes age 4: Kobukson
            case "367E1":
                self::setAuxiliaryValue(0);
                $step_max = 1;
                break;

            case "367D1":
                $step_max = 1;
                break;

            case "367N1":
                // "For every two cards returned as a result of the demand, draw and tuck a 4."
                $num_cards_to_draw_and_tuck = self::intDivision(self::getAuxiliaryValue(), 2);
                for ($i = 0; $i < $num_cards_to_draw_and_tuck; $i++) {
                    self::executeDrawAndTuck($player_id, 4);
                }
                break;

            // id 368, Echoes age 4: Shuriken
            case "368D1":
                $color_array = array();
                for ($color = 0; $color < 5; $color++) {
                    if ($color != 1) { // non-red
                        $top_card = self::getTopCardOnBoard($player_id, $color);
                        if (self::hasRessource($top_card, 4) || self::hasRessource($top_card, 3) ){
                            $color_array[] = $color; // has a tower or bulb
                        }
                    }
                }
                if (count($color_array) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryValueFromArray($color_array);
                }
                break;

            case "368N1":
                $step_max = 1;
                break;

            // id 369, Echoes age 4: Chintz
            case "369N1":
                self::executeDraw($player_id, 4);
                break;

            case "369N2":
                if (self::countCardsInLocation($player_id, 'hand') == 1 ) {
                    self::executeDraw($player_id, 4);
                    self::executeDrawAndScore($player_id, 4);
                }
                break;

            // id 370, Echoes age 4: Globe
            case "370N1":
                $hand_cards = self::getCardsInLocationKeyedByColor($player_id, 'hand');
                $color_array = array();
                for ($color = 0; $color < 5; $color++) {
                    if (count($hand_cards[$color]) > 0) {
                        $color_array[] = $color;
                    }
                }
                if (count($color_array) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryValueFromArray($color_array);
                }
                break;

            // id 371, Echoes age 4: Barometer
            case "371E1":
                $step_max = 1;
                break;

            case "371N1":
                // Determine what selections will be valid based on the visible bonuses on all boards.
                $all_player_ids = self::getAllActivePlayerIds();
                $all_bonuses = array();
                foreach ($all_player_ids as $this_player_id) {
                    $all_bonuses = array_merge($all_bonuses, self::getVisibleBonusesOnBoard($this_player_id));
                }
                $all_bonuses = array_unique($all_bonuses); // only need one selection per visible bonus value
                
                if (count($all_bonuses) > 1) {
                    $age_to_foreshadow = array();
                    foreach ($all_bonuses as $bonus) {
                        // TODO(https://github.com/micahstairs/bga-innovation/issues/472): The value here could be as high
                        // as 13 with a visible bonus of 11 which would end the game. This could be presented as a
                        // game-ending option like with Evolution.
                        $age_to_foreshadow[] = $bonus + 2;
                    }
                    $step_max = 1;
                    self::setAuxiliaryValueFromArray(array_unique($age_to_foreshadow));
                } else if (count($all_bonuses) == 1) {
                    self::executeDrawAndForeshadow($player_id, $all_bonuses[0] + 2);
                } else {
                    self::executeDrawAndForeshadow($player_id, 2);
                }
                break;   

            case "371N2":
                $step_max = 1;
                break;   

            // id 372, Echoes age 4: Pencil
            case "372E1":
                self::executeDraw($player_id, 5);
                break;

            case "372N1":
                $this->innovationGameState->set('card_id_1', -1);
                $this->innovationGameState->set('card_id_2', -1);
                $this->innovationGameState->set('card_id_3', -1);
                self::setAuxiliaryValue(0);
                $step_max = 1;
                break;

            // id 373, Echoes age 4: Clock
            case "373E1":
                // "You may splay your color with the most cards right"
                $stack_size = self::countCardsInLocationKeyedByColor($player_id, 'board');
                $largest_stack = max($stack_size);
                $color_array = array();
                for ($color = 0; $color < 5; $color++) {
                    if ($stack_size[$color] == $largest_stack) {
                        $color_array[] = $color;
                    }
                }
                $step_max = 1;
                self::setAuxiliaryValueFromArray($color_array);
                break;

            // id 374, Echoes age 4: Toilet
            case "374E1":
                // "Draw and tuck a 4."
                self::executeDrawAndTuck($player_id, 4);
                break;
            
            case "374D1":
                $max_bonus = self::getMaxBonusIconOnBoard($launcher_id);
                if ($max_bonus > 0) {
                    $step_max = 1;
                    self::setAuxiliaryValue($max_bonus);
                } else {
                    self::notifyPlayer($player_id, 'log', 
                        clienttranslate('${You} have no bonuses on your board.'), 
                        array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', 
                        clienttranslate('${player_name} has no bonuses on his board.'), 
                        array('player_name' => self::getColoredPlayerName($player_id)));

                }
                break;

            case "374N1":
               $step_max = 1;
                break;

            // id 373, Echoes age 4: Clock
            case "373D1":
                $total_clocks = 0;
                // "I demand you draw and reveal three 10s"
                for ($i = 0; $i < 3; $i++) {
                    $card = self::executeDraw($player_id, 10, 'revealed');
                    // "total the number of clocks on them"
                    $total_clocks = $total_clocks + self::countIconsOnCard($card, 6); // clocks
                }
                self::notifyGeneralInfo(clienttranslate('There were a total of ${n} ${clocks} on the drawn cards.'), array('n' => $total_clocks, 'clocks' => $clock));
                self::setAuxiliaryValue($total_clocks);
                $step_max = 1;
                break;

            // id 375, Echoes age 5: Lightning Rod
            case "375E1":
                // "Draw and tuck a 5."
                self::executeDrawAndTuck($player_id, 5);
                break;

            case "375D1":
                // "I demand you draw and tuck a 5!"
                $card = self::executeDrawAndTuck($player_id, 5);
                $top_card = self::getTopCardOnBoard($player_id, $card['color']);
                // "Return your top card of the tucked card's color!"
                self::transferCardFromTo($top_card, 0, 'deck'); 
                break;            
                
            case "375N1":
                // "Draw and tuck a 5."
                self::executeDrawAndTuck($player_id, 5);
                $step_max = 1;
                break;

            // id 376, Echoes age 5: Thermometer
            case "376E1":
                // "Meld your bottom green card. Maintain its splay."
                $bottom_card = self::getBottomCardOnBoard($player_id, 2);
                if ($bottom_card != null) {
                    self::transferCardFromTo($bottom_card, $player_id, 'board');
                }
                break;

            case "376N1":
                do {
                    // "Draw and meld a card of value one higher than the value of your top yellow card."
                    $top_yellow_card = self::getTopCardOnBoard($player_id, 3);
                    if ($top_yellow_card != null) {
                        $age_to_draw = $top_yellow_card['faceup_age'] + 1;
                    }
                    else {
                        $age_to_draw = 1; // No yellow card means melding a 1
                    }
                    $card = self::executeDrawAndMeld($player_id, $age_to_draw);
                } while ($card['color'] == 3); // "If the melded card is yellow, repeat this dogma effect."
                break;

            // id 377, Echoes age 5: Coke
            case "377E1":
                // "Draw and tuck a 4."
                self::executeDrawAndTuck($player_id, 4);
                break;

            case "377N1":
                // "Draw and reveal a 6."
                $keep_going = true;
                while ($keep_going) {
                    $card = self::executeDraw($player_id, 6, 'revealed');
                    if (!self::hasRessource($card, 5)) {
                        $keep_going = false;
                        // "Otherwise, foreshadow it."
                        self::transferCardFromTo($card, $player_id, 'forecast');
                    }
                    else {
                        // "If it has a factory, meld it"
                        self::transferCardFromTo($card, $player_id, 'board');
                    }
                } // "and repeat this dogma effect"
                break;

            // id 378, Echoes age 5: Octant
            case "378D1":
                $color_array = array();
                for ($color = 0; $color < 5; $color++) {
                    if ($color != 1) { // non-red
                        $top_card = self::getTopCardOnBoard($player_id, $color);
                        if (self::hasRessource($top_card, 2) || self::hasRessource($top_card, 5) ){
                            $color_array[] = $color; // has a leaf or factory
                        }
                    }
                }
                if (count($color_array) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryValueFromArray($color_array);
                }
                break;

            case "378N1":
                // Draw and foreshadow a 6."
                self::executeDrawAndForeshadow($player_id, 6);
                break;
                
                
            // id 379, Echoes age 5: Palampore
            case "379N1":
                $all_bonuses = self::getVisibleBonusesOnBoard($player_id);
                $repeat_bonus = array(0,0,0,0,0,0,0,0,0,0,0);
                foreach ($all_bonuses as $bonus) {
                    $repeat_bonus[$bonus - 1]++;
                }
                $bonus_select = array();
                for ($bonus = 0; $bonus < 11; $bonus++) {
                    if ($repeat_bonus[$bonus] > 1) {
                        $bonus_select[] = $bonus + 1;
                    }
                }
                if (count($bonus_select) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryValueFromArray($bonus_select);
                }
                break;
                
            case "379N2":
                $step_max = 1;
                break;

            case "379N3":
                // "If you have six or more bonuses on your board, claim the Wealth achievement."
                if (count(self::getVisibleBonusesOnBoard($player_id)) > 5) {
                    self::claimSpecialAchievement($player_id, 435);
                }
                break;

            // id 380, Echoes age 5: Seed Drill
            case "380D1":
                $color_array = array();
                for ($color = 0; $color < 5; $color++) {
                    $top_card = self::getTopCardOnBoard($player_id, $color);
                    if ($top_card != null && $top_card['faceup_age'] < 3 ){
                        $color_array[] = $color; // less than 3
                    }
                    
                }
                if (count($color_array) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryValueFromArray($color_array);
                }
                break;

            case "380N1":
                $step_max = 1;
                break;

            // id 381, Echoes age 5: Pressure Cooker
            case "381N1":
                $step_max = 1;
                break;  

            // id 382, Echoes age 5: Stove
            case "382E1":
                $step_max = 1;
                break;  

            case "382N1":
                // "Draw and tuck a 4."
                $tucked_card = self::executeDrawAndTuck($player_id, 4);
                $top_card = self::getTopCardOnBoard($player_id, $tucked_card['color']);
                // "If your top card of the tucked card's color has value less than 4, draw and score a 4."
                if ($top_card['faceup_age'] < 4) {
                    self::executeDraw($player_id, 4, 'score');
                }
                break; 

            case "382N2":
                $step_max = 1;
                break; 

            // id 383, Echoes age 5: Piano
            case "383E1":
                // Check for unique hand values across all players
                $age_array = array();
                foreach (self::getAllPlayerIds() as $this_player_id) {
                    $count_cards = self::countCardsInLocationKeyedByAge($this_player_id, 'hand');
                    
                    for ($age = 1; $age <= 11; $age++) {
                        if ($count_cards[$age] > 0) {
                            $age_array[] = $age;
                        }
                    }
                }
                $age_array = array_unique($age_array);
                if (count($age_array) > 1) { // at least two different cards were found
                    $step_max = 1;
                    self::setAuxiliaryValueFromArray($age_array);
                }
                else if (count($age_array) == 1) {
                    // Draw the card if there is only one choice
                    self::executeDraw($player_id, $age_array[0]);
                }
                break;

            case "383N1":
                // Get all top ages.  If they are unique, go to the first interaction
                $age_array = array();
                foreach(self::getTopCardsOnBoard($player_id) as $card) {
                    $age_array[] = $card['faceup_age'];
                }
                if (count(array_unique($age_array)) == 5) { // 5 unique values
                    $step_max = 1;
                    self::setAuxiliaryValue(Arrays::getValueFromBase16Array($age_array));
                }
                break;

            // id 384, Echoes age 5: Tuning Fork
            case "384E1":
                // "Look at the top card of any deck"
                $card_ids = array();
                for ($age = 1; $age <= 10; $age++) {
                    for ($type = 0; $type <= 4; $type++) {
                        $card = self::getDeckTopCard($age, $type);
                        if ($card !== null) {
                            $card_ids[] = $card['id'];
                        }
                    }
                }
                
                if (count($card_ids) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryArray($card_ids);
                }
                break;

            case "384N1":
                $step_max = 1;
                break;
                    
            // id 385, Echoes age 6: Bifocals
            case "385E1":
                $step_max = 1;
                break;

            case "385N1":
                $step_max = 1;
                break;

            case "385N2":
                $step_max = 1;
                break;

            // id 386, Echoes age 6: Stethoscope
            case "386E1":
                // Only reset the auxiliary value if the echo effect is not being repeated for a second time
                if (!self::isExecutingAgainDueToEndorsedAction()) {
                    self::setIndexedAuxiliaryValue($player_id, -1);
                }
                $step_max = 1;
                break;

            case "386N1":
                // "Draw a 7."
                self::executeDraw($player_id, 7);
                //  "If you melded a blue card due to Stethoscope's echo effect, draw an 8."
                if (self::getIndexedAuxiliaryValue($player_id) == 1) {
                    self::executeDraw($player_id, 8);
                }
                break;

            case "386N2":
                $step_max = 1;
                break;

            // id 387, Echoes age 6: Loom
            case "387E1":
                $step_max = 1;
                break;
                
            case "387N1":
                $card_ages = array();
                $score_cards = self::countCardsInLocationKeyedByAge($player_id, 'score');
                $count = 0;
                for ($age = 1; $age <= 11; $age++) {
                    if ($score_cards[$age] > 0) {
                        $count++;
                    }
                }
                
                if ($count >= 2) {
                    $step_max = 1;
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} do not have two different values in your score pile.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} does not have two different values in his score pile.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                break;
            
            case "387N2":
                // "If you have five or more hexes visible on your board in one color, claim the Heritage achievement."
                for ($color = 0; $color < 5 ; $color++) {
                    if (self::countVisibleIconsInPile($player_id, 0 /* empty hex */, $color) >= 5) {
                        self::claimSpecialAchievement($player_id, 437);
                        break;
                    }
                }
                
                break;
                
            // id 388, Echoes age 6: Shrapnel
            case "388D1":
                // "I demand you draw and tuck a 6!"
                $tucked_card = self::executeDrawAndTuck($player_id, 6);
                
                // "Transfer the top two cards of its color from your board to my score pile!"
                $top_card_1 = self::getTopCardOnBoard($player_id, $tucked_card['color']);
                self::transferCardFromTo($top_card_1, $launcher_id, 'score');
                
                $top_card_2 = self::getTopCardOnBoard($player_id, $tucked_card['color']);
                if ($top_card_2 != null) { // Make sure there is a second card
                    self::transferCardFromTo($top_card_2, $launcher_id, 'score');
                }
                
                // "Transfer the bottom card of its color from my board to your score pile!"
                $bottom_card = self::getBottomCardOnBoard($launcher_id, $tucked_card['color']);
                if ($bottom_card != null) {
                    self::transferCardFromTo($bottom_card, $player_id, 'score');
                }
                
                break;

            // id 389, Echoes age 6: Hot Air Balloon
            case "389E1":
                // "Draw and score a 7."
                self::executeDrawAndScore($player_id, 7);
                break;
                
            case "389N1":
                // "You may achieve (if eligible) a top card from any other player's board if they have an achievement of matching value."
                $card_id_list = array();
                foreach (self::getAllActivePlayerIds() as $any_player_id) {
                    if ($player_id != $any_player_id) {
                        $top_cards = self::getTopCardsOnBoard($any_player_id);
                        $achievement_age_counts = self::countCardsInLocationKeyedByAge($any_player_id, 'achievements', $type=null, $is_relic=false);
                        foreach ($top_cards as $card) {
                            if ($achievement_age_counts[$card['faceup_age']] > 0) {
                                $card_id_list[] = $card['id'];
                            }
                        }
                    }
                }
                if (count($card_id_list) > 0) {
                    self::setAuxiliaryArray($card_id_list);
                    $step_max = 1;
                } else {
                    // "Otherwise, draw and meld a 7"
                    self::executeDrawAndMeld($player_id, 7);
                }
                break;
                
            // id 390, Echoes age 6: Steamboat
            case "390D1":
                // "I demand you draw and reveal a 6!"
                $drawn_card = self::executeDraw($player_id, 6, 'revealed');
                
                if ($drawn_card['color'] == 0 || $drawn_card['color'] == 3) {
                    // "If it is blue or yellow, transfer it and all cards in your hand to my hand!"
                    $ids_of_cards_in_player_hand = self::getIdsOfCardsInLocation($player_id, 'hand');
                    
                    self::transferCardFromTo($drawn_card, $launcher_id, 'hand');
                    
                    foreach($ids_of_cards_in_player_hand as $id) {
                        $card = self::getCardInfo($id);
                        self::transferCardFromTo($card, $launcher_id, 'hand');
                    }
                } else if ($drawn_card['color'] == 1 || $drawn_card['color'] == 2) {
                    // "If it is red or green, keep it and transfer two cards from your score pile to mine!"
                    $step_max = 1;
                    self::transferCardFromTo($drawn_card, $player_id, 'hand');
                } else {
                    // "If it is purple, keep it!"
                    self::transferCardFromTo($drawn_card, $player_id, 'hand');
                }
                break;

            // id 391, Echoes age 6: Dentures
            case "391E1":
                // "Draw and tuck a 6."
                $card = self::executeDrawAndTuck($player_id, 6);
                self::setIndexedAuxiliaryValue($player_id, $card['color']);
                break;
                
            case "391N1":
                // "Score the top two non-bottom cards of the color of the last card you tucked due to Dentures."
                $color = self::getIndexedAuxiliaryValue($player_id); // NOTE: The color is -1 if the Echo effect was not executed
                $color_count = self::countCardsInLocationKeyedByColor($player_id, 'board');
                
                $continue = false;
                do {
                    if ($color >= 0 && $color_count[$color] > 2) {
                        // Score the top two cards
                        $card = self::getTopCardOnBoard($player_id, $color);
                        self::transferCardFromTo($card, $player_id, 'score', /*bottom_to=*/false, /*score_keyword=*/true);
                        $card = self::getTopCardOnBoard($player_id, $color);
                        self::transferCardFromTo($card, $player_id, 'score', /*bottom_to=*/false, /*score_keyword=*/true);
                        $continue = false;
                    } else if ($color >= 0 && $color_count[$color] == 2) {
                        // Score the top card only
                        $card = self::getTopCardOnBoard($player_id, $color);
                        self::transferCardFromTo($card, $player_id, 'score', /*bottom_to=*/false, /*score_keyword=*/true);
                        $continue = false;
                    } else if ($color < 0 || $color_count[$color] == 1) {
                        // "If there are none to score, draw and tuck a 6, then repeat this dogma effect."
                        $continue = true;
                        $card = self::executeDrawAndTuck($player_id, 6);
                        $color = $card['color'];
                        $color_count = self::countCardsInLocationKeyedByColor($player_id, 'board');
                    }
                } while($continue);
                break;

            case "391N2":
                $step_max = 1;
                break;

            // id 392, Echoes age 6: Morphine
            case "392E1":
                // Get list of odd-valued cards in hand
                $odd_card_ids = array();
                foreach (self::getCardsInHand($player_id) as $card) {
                    if ($card['age'] % 2 == 1) {
                        $odd_card_ids[] = $card['id'];
                    }
                }
                if (count($odd_card_ids) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryArray($odd_card_ids);
                }
                
                // Initialize the auxiliary value before the demand begins
                self::setAuxiliaryValue(0);
                break;

            case "392D1":
                $odd_card_ids = array();
                $max_value = self::getAuxiliaryValue();
                foreach (self::getCardsInHand($player_id) as $card) {
                    if ($card['age'] % 2 == 1) {
                        $odd_card_ids[] = $card['id'];
                        $max_value = max($card['age'], $max_value);
                    }
                }
                self::setAuxiliaryValue($max_value);
                
                if (count($odd_card_ids) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryArray($odd_card_ids);
                } else {
                    self::executeDraw($player_id, 6);
                }
                break;

            case "392N1":
                // "Draw a card of value one higher than the highest card returned due to the demand, if any were returned."
                $max_value_returned = self::getAuxiliaryValue();
                if ($max_value_returned > 0) {
                    self::executeDraw($player_id, $max_value_returned + 1);
                }
                break;

            case "392N2":
                $step_max = 1;
                break;
                
            // id 393, Echoes age 6: Indian Clubs
            case "393D1":
                $step_max = 1;
                break;

            case "393N1":
                $cards_in_score_pile = self::countCardsInLocationKeyedByAge($player_id, 'score');
                $cards_in_hand = self::countCardsInLocationKeyedByAge($player_id, 'hand');
                $ages_to_score = array();
                for ($age=1; $age <= 11; $age++) {
                    if ($cards_in_score_pile[$age] > 0 && $cards_in_hand[$age] > 0) {
                        self::setAuxiliaryValue($age);
                        $step_max = 1;
                        break;
                    }
                }
                break;
                
            // id 394, Echoes age 6: Kaleidoscope
            case "394N1":
                // "Draw and meld a 7"
                $card = self::executeDrawAndMeld($player_id, 7);
                self::setAuxiliaryValue($card['color']);
                $step_max = 1;
                break;

            // id 395, Echoes age 7: Photography
            case "395E1":
                $step_max = 1;
                break;

            case "395D1":
                $step_max = 1;
                break;

            case "395N1":
                // "If you have at least three echo effects visible in one color, claim the History achievement."
                $eligible = false;
                for ($color = 0; $color < 5 ; $color++) {
                    if (self::countVisibleIconsInPile($player_id, 10 /* echo effect */, $color) >= 3) {
                        self::claimSpecialAchievement($player_id, 438); // History
                        break;
                    }
                }
                break;

            // id 396, Echoes age 7: Typewriter
            case "396N1":
                $cards_to_draw = 0;
                $hand_color_counts = self::countCardsInLocationKeyedByColor($player_id, 'hand');
                for ($color = 0; $color < 5 ; $color++) {
                    if ($hand_color_counts[$color] > 0) {
                        $cards_to_draw++;
                    }
                }
                $step_max = 1;
                self::setAuxiliaryValue($cards_to_draw);
                break;

            // id 397, Echoes age 7: Machine Gun
            case "397E1":
                // "If you have five top cards, draw and score a 7."
                if (count(self::getTopCardsOnBoard($player_id)) == 5) {
                    self::executeDrawAndScore($player_id, 7);
                }
                break;

            case "397D1":
                $step_max = 1;
                break;
                
            case "397N1":
                $step_max = 1;
                break;
                
            // id 398, Echoes age 7: Rubber
            case "398E1":
                // "Draw and tuck two 8s."
                self::executeDrawAndTuck($player_id, 8);
                self::executeDrawAndTuck($player_id, 8);
                break;

            case "398N1":
                $step_max = 1;
                break;                

            case "398N2":
                $step_max = 1;
                break;  

           // id 399, Echoes age 7: Jeans
            case "399E1":
                // "Draw two 9s."
                $card_1 = self::executeDraw($player_id, 9);
                $card_2 = self::executeDraw($player_id, 9);
                $this->innovationGameState->set('card_id_1', $card_1['id']);
                $this->innovationGameState->set('card_id_2', $card_2['id']);
                $step_max = 1;
                break;

            case "399N1":
                $step_max = 4;
                break;

            // id 400, Echoes age 7: Telegraph
            case "400N1":
                $step_max = 1;
                break;
                
            case "400N2":
                $step_max = 1;
                break;

            // id 401, Echoes age 7: Elevator
            case "401E1":
                // TODO(LATER): Instead of clicking buttons to choose the top or bottom card, it would a better user experience
                // if we allowed them to directly click on the cards (we will require an option to force the pile to expand so
                // that the bottom and top cards are both visible).
                $green_card_count = self::countCardsInLocationKeyedByColor($player_id, 'board')[2];
                if ($green_card_count > 1) {
                    $step_max = 1;
                } else if ($green_card_count == 1) {
                    // No choice to be made. Score the card that is there.
                    $top_green_card = self::getTopCardOnBoard($player_id, 2);
                    self::scoreCard($top_green_card, $player_id);
                }
                break;

            case "401N1":
                $age_list = array();
                $cards = self::countCardsInLocationKeyedByAge($player_id, 'score');
                for ($age = 1; $age <= 11; $age++) {
                    if ($cards[$age] > 0) {
                        $age_list[] = $age;
                    }
                }

                // TODO(#601): Simplify this once choose_value choices are automated.
                if (count($age_list) > 1) {
                    self::setAuxiliaryValueFromArray($age_list);
                    $step_max = 2;
                } else if (count($age_list) == 1) {
                    // Only one card value present.  No decision needed.
                    $step_max = 2;
                    $step = 2; self::incrementStep(1);
                    self::setAuxiliaryValue($age_list[0]);
                }
                break;

            // id 402, Echoes age 7: Fertilizer
            case "402N1":
                $step_max = 1;
                break;

            case "402N2":
                $step_max = 1;
                break;

            // id 403, Echoes age 7: Ice Cream
            case "403E1":
                $step_max = 1;
                break;

            case "403D1":
                // "I demand you draw and meld a 1!"
                self::executeDrawAndMeld($player_id, 1);
                break;

            case "403N1":
                $step_max = 1;
                break;

            // id 404, Echoes age 7: Saxophone
            case "404N1":
                $step_max = 1;
                break;

            case "404N2":
                // "If the music note for Bell, Flute, Piano, and Saxophone are visible anywhere"
                $cards_to_draw = 0;
                
                // Check Bell
                $bell_card = self::getCardInfo(342);
                if (self::getIfTopCardOnBoard(342) || ($bell_card['location'] == 'board' && $bell_card['splay_direction'] >= 2)) { // up, right, or aslant
                    $cards_to_draw++;
                }
                // Check Flute
                $flute_card = self::getCardInfo(343);
                if (self::getIfTopCardOnBoard(343) || ($flute_card['location'] == 'board' && $flute_card['splay_direction'] >= 2)) { // up, right, or aslant
                    $cards_to_draw++;
                }                
                // Check Piano
                $piano_card = self::getCardInfo(383);
                if (self::getIfTopCardOnBoard(383) || ($piano_card['location'] == 'board' && $piano_card['splay_direction'] >= 3)) { // up or aslant
                    $cards_to_draw++;
                }
                // Check Saxophone
                $sax_card = self::getCardInfo(404);
                if (self::getIfTopCardOnBoard(404) || ($sax_card['location'] == 'board' && $sax_card['splay_direction'] >= 3)) { // up or aslant
                    $cards_to_draw++;
                }
                self::notifyGeneralInfo(clienttranslate('There is ${n} ${music_note} visible across all player boards.'), array('n' => $cards_to_draw, 'music_note' => self::getMusicNoteIcon()));
                if ($cards_to_draw == 4) {
                    // "you win"
                    $this->innovationGameState->set('winner_by_dogma', $player_id);
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn Saxophone');
                    throw new EndOfGame();
                } else {
                    // "Otherwise, draw a 7 for each music note that is visible."
                    for ($i = 0; $i < $cards_to_draw; $i++) {
                        self::executeDraw($player_id, 7);
                    }
                }
                break;

            // id 405, Echoes age 8: Radio Telescope
            case "405N1":
                // "For every two bulbs on your board, draw a 9."
                $number_of_bulbs = self::getPlayerSingleRessourceCount($player_id, 3);
                $cards_to_draw = self::intDivision($number_of_bulbs, 2);
                
                if ($cards_to_draw > 0) {
                    $card_array = array();
                    for ($i = 0; $i < $cards_to_draw; $i++) {
                        $card = self::executeDraw($player_id, 9);
                        $card_array[] = $card['id'];
                    }
                    if ($cards_to_draw > 1) {
                        $step_max = 2; // Do the rest of the interactions now.
                    } else {
                        $step_max = 1; // No cards to return
                    }
                    self::setAuxiliaryArray($card_array);
                }
                break;

            // id 406, Echoes age 8: X-Ray
            case "406E1":
                // "Draw and tuck an 8."
                self::executeDrawAndTuck($player_id, 8);
                break;

            case "406N1":
                // "For every three leaves on your board,"
                $number_of_leaves = self::getPlayerSingleRessourceCount($player_id, 2);
                $num_foreshadows = self::intDivision($number_of_leaves, 3);
                
                if ($num_foreshadows > 0) {
                    self::setAuxiliaryValue($num_foreshadows);
                    $step_max = 1;
                }
                break;

            case "406N2":
                $step_max = 1;
                break;      

            // id 407, Echoes age 8: Bandage
            case "407E1":
                $step_max = 1;
                break;

            case "407D1":
                // "I demand you return the highest card in your score pile for which you do not have a card of matching value in your hand"
                $step_max = 2;
                $score_counts = self::countCardsInLocationKeyedByAge($player_id, 'score');
                $hand_counts = self::countCardsInLocationKeyedByAge($player_id, 'hand');
                for ($age = 11; $age >= 1; $age--) {
                    if ($score_counts[$age] > 0 && $hand_counts[$age] == 0) {
                        self::setAuxiliaryValue($age);
                        break 2;
                    }
                }
                // No card to return so skip that step
                $step = 2;
                break;

            // id 408, Echoes age 8: Parachute
            case "408D1":
                // "I demand you transfer all cards without a clock from your hand to my hand!"
                foreach (self::getCardsInLocation($player_id, 'hand') as $card) {
                    $card = self::getCardInfo($card['id']);
                    if (!self::hasRessource($card, 6)) {
                        self::transferCardFromTo($card, $launcher_id, 'hand');
                    }
                }
                break;

            // id 409, Echoes age 8: Nylon
            case "409N1":
                // "Draw and tuck an 8 for every three factories on your board."
                do {
                    $number_of_factories = self::getPlayerSingleRessourceCount($player_id, 5);
                    $num_tucks = self::intDivision($number_of_factories, 3);

                    $green_tucked = false;
                    for ($i = 1; $i <= $num_tucks; $i++) {
                        $card = self::executeDrawAndTuck($player_id, 8);
                        if ($card['color'] == 2) {
                            // "If any of the tucked cards were green, repeat this dogma effect."
                            $green_tucked = true;
                        }
                    }
                    if ($green_tucked) {
                        self::notifyGeneralInfo("At least one of the tucked cards were green so the dogma effect is repeating.");
                    }
                } while ($green_tucked);
                break;
            
            case "409N2":
                $step_max = 1;
                break;

            // id 410, Echoes age 8: Sliced Bread
            case "410E1":
                $step_max = 1;
                break;

            case "410N1":
                $step_max = 1;
                break;

            // id 411, Echoes age 8: Air Conditioner
            case "411E1":
                $step_max = 1;
                break;

            case "411D1":
                // "I demand you return all cards from your score pile of value matching any of your top cards!"
                $top_cards = self::getTopCardsOnBoard($player_id);
                $card_ids_to_return = array();
                foreach (self::getCardsInLocation($player_id, 'score') as $score_card) {
                    $found = false;
                    foreach ($top_cards as $top_card) {
                        if ($top_card['faceup_age'] == $score_card['age']) {
                            $found = true;
                            break;
                        }
                    }
                    
                    if ($found) {
                        $card_ids_to_return[] = $score_card['id'];
                    }
                }   
                
                if (count($card_ids_to_return) > 0) {
                    $step_max = 1;
                    self::setAuxiliaryArray($card_ids_to_return);
                }
                break;

            // id 412, Echoes age 8: Tractor
            case "412E1":
                // "Draw a 7."
                self::executeDraw($player_id, 7);
                break;

            case "412N1":
                // "Draw and score a 7. Draw a 7."
                self::executeDrawAndScore($player_id, 7);
                self::executeDraw($player_id, 7);
                break;

            // id 413, Echoes age 8: Crossword
            case "413N1":
                // "For each visible bonus your board, draw a card of that value."
                $visible_bonuses = self::getVisibleBonusesOnBoard($player_id);
                $num_bonuses = count($visible_bonuses);

                // Automate the choice if there is no more than one unique bonus value or if the player already has an
                // Echoes card in hand (the drawing order only matters to allow the player to control which Echoes card they draw)
                // TODO(LATER): Move this logic to a more generic location so that this is not card-specific.
                if (count(array_unique($visible_bonuses)) <= 1 || self::countCardsInLocation($player_id, 'hand', /*type=*/ 3)) {
                    foreach ($visible_bonuses as $bonus) {
                        self::executeDraw($player_id, $bonus);
                    }
                } else {
                    $bonus_counts = array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
                    foreach ($visible_bonuses as $bonus) {
                        $bonus_counts[$bonus]++;
                    }
                    $step_max = 1;
                    self::setAuxiliaryArray($bonus_counts);
                }
                break;
                
            // id 414, Echoes age 8: Television
            case "414E1":
                // "Draw and meld an 8."
                self::executeDrawAndMeld($player_id, 8);
                break;
                
            case "414N1":
                $step_max = 3;
                break;

            // id 415, Echoes age 9: Calculator
            case "415N1":
                self::setAuxiliaryArray(array());
                $step_max = 1;
                break;

            case "415N2":
                $step_max = 1;
                break;

            // id 416, Echoes age 9: Laser
            case "416N1":
                $step_max = 2;
                break;
                
            // id 417, Echoes age 9: Helicopter
            case "417N1":
                $step_max = 2;
                break;
                
            // id 418, Echoes age 9: Jet
            case "418E1":
                if ($player_id == $launcher_id && !self::isExecutingAgainDueToEndorsedAction()) {
                    if ($this->innovationGameState->get('release_version') >= 3) {
                        self::setAuxiliaryArray(array());
                    } else {
                        self::setAuxiliaryValue(-1);
                    }
                }
                $step_max = 1;
                break;

            case "418D1":
                // "I demand you return your top card of the color I melded due to Jet's echo effect!"
                // NOTE: If the action was endorsed, there could be two colors (or the same color twice).
                if ($this->innovationGameState->get('release_version') >= 3) {
                    if (count(self::getAuxiliaryArray()) >= 1) {
                        if (!self::isExecutingAgainDueToEndorsedAction()) {
                            self::setIndexedAuxiliaryValue($player_id, -1);
                        }
                        $step_max = 1;
                    }
                } else {
                    $color = self::getAuxiliaryValue();
                    if ($color >= 0) {
                        $card = self::getTopCardOnBoard($player_id, $color);
                        if ($card !== null) {
                            self::transferCardFromTo($card, 0, 'deck');
                        }
                    }
                }
                break;

            // id 419, Echoes age 9: Credit Card
            case "419E1":
                // "Draw and foreshadow a 9."
                self::executeDrawAndForeshadow($player_id, 9);
                break;

            case "419N1":
                $step_max = 1;
                break;

            case "419N2":
                $step_max = 1;
                break;

            // id 420, Echoes age 9: Email
            case "420E1":
                self::executeDrawAndForeshadow($player_id, 10);
                break;

            case "420N1":
                self::executeDrawAndForeshadow($player_id, 9);
                break;

            case "420N2":
                // "Execute all non-demand dogma effects on your lowest non-green top card. Do not share them."
                $lowest_card_age = null;
                for ($color = 0; $color < 5; $color++) {
                    if ($color != 2) { // non-green
                        $top_card = self::getTopCardOnBoard($player_id, $color);
                        if ($top_card !== null && ($lowest_card_age == null || $top_card['faceup_age'] < $lowest_card_age)) {
                            $lowest_card_age = $top_card['faceup_age'];
                            self::setAuxiliaryValue($lowest_card_age);
                        }
                    }
                }
                
                if ($lowest_card_age != null) { // non-green card exists
                    $step_max = 1;
                }
                break;

            // id 421, Echoes age 9: ATM
            case "421E1":
                $step_max = 1;
                break;

            case "421D1":
                $step_max = 1;
                break;

            case "421N1":
                $step_max = 1;
                break;

            // id 422, Echoes age 9: Wristwatch
            case "422E1":
                $step_max = 1;
                break;

            case "422N1":
                // "For each visible bonus on your board, draw and tuck a card of that value, in ascending order."
                $bonuses = self::getVisibleBonusesOnBoard($player_id);
                sort($bonuses); // put in ascending order
                foreach ($bonuses as $bonus) {
                    self::executeDrawAndTuck($player_id, $bonus);
                }
                break;

            // id 423, Echoes age 9: Karaoke
            case "423E1":
                $step_max = 1;
                break;
                
            case "423N1":
                // "Execute all of the non-demand dogma effects of the card you melded due to Karaoke's echo effect. Do not share them."
                $melded_card_id = self::getIndexedAuxiliaryValue($player_id);
                if ($melded_card_id != null) { // This check is required since the echo effect is not always executed during nested execution
                    // If two cards were melded as part of the Endorse action, then let the player choose which one to execute
                    if ($melded_card_id >= 1000) {
                        $step_max = 1;
                    } else {
                        self::executeNonDemandEffects(self::getCardInfo($melded_card_id));
                    }
                }
                break;

            case "423N2":
                $step_max = 1;
                break;
                
            // id 424, Echoes age 9: Rock
            case "424D1":
                $step_max = 1;
                break;

            case "424N1":
                $step_max = 1;
                break;

            // id 425, Echoes age 10: Artificial Heart
            case "425N1":
                $age_max = self::getMaxAgeOnBoardTopCards($player_id);
                $player_score = self::getPlayerScore($player_id) * 2; // double the score
                $claimed_achievement_count = self::countCardsInLocationKeyedByAge($player_id, 'achievements', $type=null, $is_relic=false);
                $unclaimed_achievements = self::getCardsInLocation(0, 'achievements');

                $claimable_cards = array();
                foreach ($unclaimed_achievements as $card) {
                    $card_age = $card['age'];
                    if ($card_age !== null) { // ignore special achievements
                        // Rule: to achieve the age X, the player has to have a top card of his board of age >= X and 5*X points in his score pile
                        if ($card_age <= $age_max && $player_score >= 5 * $card_age * ($claimed_achievement_count[$card_age] + 1)) {
                            $claimable_cards[] = $card['id'];
                        }
                    }
                }
                
                if (count($claimable_cards) > 0) {
                    self::setAuxiliaryArray($claimable_cards);                
                    $step_max = 1;
                }
                break;

            // id 426, Echoes age 10: Human Genome
            case "426N1":
                $step_max = 2;
                break;
                
            // id 427, Echoes age 10: Camcorder
            case "427D1":
                $step_max = 1;
                break;

            case "427N1":
                $step_max = 2;
                break;

            // id 428, Echoes age 10: Social Networking
            case "428D1":
                $step_max = 2;
                break;

            case "428N1":
                // "If you have fewer factories, fewer crowns, and towers than each other player, you win."
                $min_factories = self::getUniqueValueFromDB(self::format("SELECT MIN(player_icon_count_5) FROM player WHERE player_id != {player_id} AND player_eliminated = 0", array('player_id' => $player_id)));
                $min_crowns = self::getUniqueValueFromDB(self::format("SELECT MIN(player_icon_count_1) FROM player WHERE player_id != {player_id} AND player_eliminated = 0", array('player_id' => $player_id)));
                $min_towers = self::getUniqueValueFromDB(self::format("SELECT MIN(player_icon_count_4) FROM player WHERE player_id != {player_id} AND player_eliminated = 0",  array('player_id' => $player_id)));
                
                $this_player_icon_counts = self::getPlayerResourceCounts($player_id);
                
                if ($this_player_icon_counts[5] < $min_factories &&
                    $this_player_icon_counts[1] < $min_crowns && 
                    $this_player_icon_counts[4] < $min_towers) {
                
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have the fewest ${factory}, ${crown}, and ${tower}.'), array('You' => 'You', 'factory' => $factory, 'crown' => $crown, 'tower' => $tower));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has the fewest ${factory}, ${crown}, and ${tower}.'), array('player_name' => self::getColoredPlayerName($player_id), 'factory' => $factory, 'crown' => $crown, 'tower' => $tower));
                    $this->innovationGameState->set('winner_by_dogma', $player_id);
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn Social Networking');
                    throw new EndOfGame();
                }
                break;

            // id 429, Echoes age 10: GPS
            case "429D1":
                $step_max = 1;
                break;

            case "429N1":
                // "Draw and foreshadow three 10s."
                self::executeDrawAndForeshadow($player_id, 10);
                self::executeDrawAndForeshadow($player_id, 10);
                self::executeDrawAndForeshadow($player_id, 10);
                break;

            case "429N2":
                $step_max = 1;
                break;

            // id 430, Echoes age 10: Flash Drive
            case "430D1":
                $step_max = 1;
                break;

            case "430N1":
                $step_max = 1;
                break;
                                
            // id 431, Echoes age 10: Cell Phone
            case "431N1":
                // "Draw a 10 for every two clocks on your board."
                $num_cards = self::intDivision(self::getPlayerSingleRessourceCount($player_id, 6), 2);
                for ($i = 0; $i < $num_cards; $i++) {
                    self::executeDraw($player_id, 10);
                }
                break;

            case "431N2":
                $step_max = 1;
                break;

            case "431N3":
                $step_max = 1;
                break;

            // id 432, Echoes age 10: MP3
            case "432N1":
                if (self::countCardsInLocation($player_id, 'hand') > 0) {
                    $step_max = 1;
                }
                break;

            case "432N2":
                $bonuses = self::getVisibleBonusesOnBoard($player_id);
                if (count($bonuses) > 0) {
                    self::setAuxiliaryValueFromArray(array_unique($bonuses));
                    $step_max = 1;
                }
                break;

            // id 433, Echoes age 10: Puzzle Cube
            case "433N1":
                $step_max = 1;
                break;

            case "433N2":
                // "Draw and meld a 10."
                self::executeDrawAndMeld($player_id, 10);
                break;
                
            // id 434, Echoes age 10: Sudoku
            case "434N1":
                $step_max = 1;
                break;

            // id 440, age 11: Climatology
            case "440D1":
                $step_max = 2;
                break;

            case "440N1":
                $step_max = 1;
                break;

            // id 441, age 11: Solar Sailing
            case "441N1":
                // "Draw and meld an 11."
                $card = self::executeDraw($player_id, 11, 'board');
                $color = $card['color'];
                    
                if ($card['splay_direction'] != 4) { // aslant
                    // "If the color of the melded card is not splayed aslant on your board, return all but your top two cards of this color"
                    $board_cards = self::countCardsInLocationKeyedByColor($player_id, 'board');
                    $num_color_cards = $board_cards[$color];
                    if ($num_color_cards > 2) { // verify that more than two cards are there so transfer can occur
                        $num_cards_transferred = 0;
                        do {
                            // "return all but your top two cards of this color"
                            $card = self::getBottomCardOnBoard($player_id, $color);
                            if ($card != null) {
                                self::transferCardFromTo($card, $player_id, 'deck');
                            }
                            $num_cards_transferred++;
                        } while ($num_cards_transferred < $num_color_cards - 2);
                    }
                    self::splayAslant($player_id, $player_id, $card['color']); // "and splay them aslant."				
                }
                
                // Need to recount the cards to verify that the number of cards is right. 
                if (self::countCardsInLocationKeyedByColor($player_id, 'board')[$color] >= 4) {
                    // "If there are four or more cards of this color on your board, you win."
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have 4 or more ${color} cards on your board.'), array('You' => 'You', 'color' => self::getColorInClear($color)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has 4 or more ${color} cards on their board.'), array('player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($color)));
                    $this->innovationGameState->set('winner_by_dogma', $player_id);
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn Solar Sailing');
                    throw new EndOfGame();
                }
                break;

            // id 442, age 11: Astrogeology
            case "442N1":
                // "Draw and reveal an 11."
                $card = self::executeDraw($player_id, 11, 'revealed');
                
                if ($card['splay_direction'] != 4) { // aslant
                    // "If the color of the drawn card is not splayed aslant on your board, "
                    $color = $card['color'];
                    
                    $board_cards = self::countCardsInLocationKeyedByColor($player_id, 'board');
                    $num_color_cards = $board_cards[$color];
                    if ($num_color_cards > 2) { // verify that at least two cards are there so transfer can occur
                        $num_cards_transferred = 0;
                        do {
                            // "transfer all but your top two cards of this color into your hand, "
                            $card = self::getBottomCardOnBoard($player_id, $color);
                            if ($card != null) {
                                self::transferCardFromTo($card, $player_id, 'hand');
                            }
                            $num_cards_transferred++;
                        } while ($num_cards_transferred < $num_color_cards - 2);
                    }
                    self::splayAslant($player_id, $player_id, $card['color']); // "and splay it aslant."				
                }
                self::transferCardFromTo($card, $player_id, 'hand'); // put revealed card in hand
                break;

            case "442N2":
                
                if (self::countCardsInLocation($player_id, 'hand') >= 11) { 
                    // If you have 11 or more cards in hand, you win.
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have 11 or more cards in hand.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has 11 or more cards in hand.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    $this->innovationGameState->set('winner_by_dogma', $player_id);
                    self::trace('EOG bubbled from self::stPlayerInvolvedTurn Astrogeology');
                    throw new EndOfGame();
                }
                break;
            
            // id 443, age 11: Fusion
            case "443N1":
                $card_ids_to_score = array();
                foreach (self::getTopCardsOnBoard($player_id) as $card) {
                    if ($card['faceup_age'] == 11) {
                        $card_ids_to_score[] = $card['id'];
                    }
                }
                if (count($card_ids_to_score) > 0) {
                    self::setAuxiliaryArray($card_ids_to_score);
                    $step_max = 1;
                }
                break;

            // id 444, age 11: Hypersonics
            case "444D1":
                $top_cards = self::getTopCardsOnBoard($player_id);
                $matching_cards = array();
                foreach ($top_cards as $first_card) {
                    foreach ($top_cards as $second_card) {
                        if ($first_card['id'] != $second_card['id'] && $first_card['faceup_age'] == $second_card['faceup_age']) {
                            $matching_cards[] = $first_card['id'];
                        }
                    }
                }
                
                if (count($matching_cards) > 0) {
                    $step_max = 2;
                    self::setAuxiliaryArray($matching_cards);
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} do not have two top cards of matching value on your board.'),  
                        array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} does not have two top cards of matching value on his board.'), 
                        array('player_name' => self::getColoredPlayerName($player_id)));
                }
                break;
                
            // id 445, age 11: Space Traffic
            case "445N1":
            
                $keep_going = false;
                do {
                    // "Draw and tuck an 11."
                    $card = self::executeDraw($player_id, 11);
                    $color = $card['color'];
                    $bottom_card = self::getBottomCardOnBoard($player_id, $color);
                    self::tuckCard($card, $player_id);
                    
                    if ($bottom_card !== null) {
                        if ($bottom_card['age'] == 11) {
                            // "If you tucked directly under an 11, you lose."
                        
                            self::removeAllCardsFromPlayer($player_id);
                            if (self::decodeGameType($this->innovationGameState->get('game_type')) == 'individual') {
                                // If there is only one player remaining in the game, that player wins
                                self::notifyPlayer($player_id, 'log', clienttranslate('${You} lose.'),  array('You' => 'You'));
                                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} loses.'), array(
                                    'player_name' => self::getColoredPlayerName($player_id)
                                ));
                                self::eliminatePlayer($player_id);
                                if (count(self::getAllActivePlayers()) == 1) {
                                    $this->innovationGameState->set('winner_by_dogma', self::getAllActivePlayerIds()[0]);
                                    self::trace('EOG bubbled from self::stInterInteractionStep Space Traffic');
                                    throw new EndOfGame();
                                }
                                break; // Stop the effect if the player loses
                            } else { // Team play
                                // Entire team loses if one player loses 
                                $teammate_id = self::getPlayerTeammate($player_id);
                                $losing_team = array($player_id, $teammate_id);
                                self::notifyPlayer($player_id, 'log', clienttranslate('${Your} team loses.'), array('Your' => 'Your'));
                                self::notifyPlayer($teammate_id, 'log', clienttranslate('${Your} team loses.'), array('Your' => 'Your'));
                                self::notifyAllPlayersBut($losing_team, 'log', clienttranslate('The other team loses.'), array());
                                self::eliminatePlayer($player_id);
                                self::eliminatePlayer($teammate_id);
                                $this->innovationGameState->set('winner_by_dogma', self::getAllActivePlayerIds()[0]);
                                self::trace('EOG bubbled from self::stInterInteractionStep Space Traffic');
                                throw new EndOfGame();
                            }
                        }
                        
                        // "Score all but your top three cards of the color of the tucked card,"
                        $card_counts = self::countCardsInLocationKeyedByColor($player_id, 'board');
                        for ($i = 0; $i < $card_counts[$color] - 3; $i++) {
                            $bottom_card = self::getBottomCardOnBoard($player_id, $color);
                            self::transferCardFromTo($bottom_card, $player_id, 'score'); // score the cards
                        }
                        self::splayAslant($player_id, $player_id, $color); // "and splay that color aslant."
                    }
                    
                    // "If you do not have the highest score, repeat this dogma effect."
                    $player_score = self::getPlayerScore($player_id);
                    foreach (self::getAllActivePlayerIds() as $players) {
                        if (self::getPlayerScore($players) > $player_score)  {
                            $keep_going = true;
                        }
                    }
                } while ($keep_going);
                break;

            // id 446, age 11: Near-Field Comm
            case "446D1":
                $step_max = 1;
                break;

            case "446N1":
                $step_max = 1;
                break;

            case "446N1+":
                // "If there is a card there, then put it back."
                foreach (self::getCardsInLocation($player_id, 'revealed') as $card) {
                    self::transferCardFromTo($card, $player_id, 'score');
                }
                break;

            // id 447, age 11: Reclamation
            case "447N1":
                // "Return your three bottom red cards."
                $color = 1; // start with red
                
                $keep_going = true;
                do {
                    $card_counts = self::countCardsInLocationKeyedByColor($player_id, 'board');
                    if ($card_counts[$color] >= 3) {
                        // "If you returned three cards, repeat this dogma effect using the color of the melded card."
                        $return_card_count = 3;
                    } else {
                        $return_card_count = $card_counts[$color];
                        $keep_going  = false; // stop the loop.  not enough cards returned
                    }
                    
                    $total_age_value = 0;
                    for ($i = 0; $i < $return_card_count; $i++) {
                        $bottom_card = self::getBottomCardOnBoard($player_id, $color);
                        self::transferCardFromTo($bottom_card, $player_id, 'deck'); // return the cards
                        
                        $total_age_value += $bottom_card['faceup_age'];
                    }
                    // "Draw and meld a card of value equal to half the total sum value of the returned cards, rounded up."
                    $melded_card = self::executeDrawAndMeld($player_id, ceil($total_age_value / 2));
                    $color = $melded_card['color']; // assign a new color for the next loop (if necessary)
                } while ($keep_going);
                break;

            // id 448, age 11: Escapism
            case "448N1":
                $step_max = 1;
                break;

            case "448N1+":
                // If there is a card there, then put it back.
                foreach (self::getCardsInLocation($player_id, 'revealed') as $card) {
                    $step_max = 1; // card was revealed, thus the second half of this effect should be executed.
                    self::transferCardFromTo($card, $player_id, 'hand');
                }                
                break;
                
            // id 449, age 11: Whataboutism
            case "449D1":
                $step_max = 1;
                break;

                
            default:
                // Do not throw an exception so that we are able to stop executing a card after it's popped from
                // the stack and there's nothing left to do.
                break;
            }
        }
        catch (EndOfGame $e) {
            // End of the game: the exception has reached the highest level of code
            self::trace('EOG bubbled from self::stPlayerInvolvedTurn');
            self::trace('playerInvolvedTurn->justBeforeGameEnd');
            $this->gamestate->nextState('justBeforeGameEnd');
            return;
        }

        if ($step_max === null) {
            // End of the effect for this player
            self::trace('playerInvolvedTurn->interPlayerInvolvedTurn');
            $this->gamestate->nextState('interPlayerInvolvedTurn');
            return;
        }
        // There is an interaction needed
        self::setStepMax($step_max);

        // Prepare the first step
        self::setStep($step === null ? 1 : $step);
        self::trace('playerInvolvedTurn->interactionStep');
        $this->gamestate->nextState('interactionStep');
    }
    
    function stInterPlayerInvolvedTurn() {

        // Switch to new card that was pushed onto the stack
        if (self::getNestedCardState($this->innovationGameState->get('current_nesting_index') + 1) != null) {
            $this->innovationGameState->increment('current_nesting_index');
            self::trace('interPlayerInvolvedTurn->dogmaEffect');
            $this->gamestate->nextState('dogmaEffect');
            return;
        }

        // A player has executed an effect of a dogma card (or passed). Is there another player on which the effect can apply?
        $player_id = self::getCurrentPlayerUnderDogmaEffect();
        $launcher_id = self::getLauncherId();

        $nesting_index = $this->innovationGameState->get('current_nesting_index');
        $current_effect_type = self::getNestedCardState($nesting_index)['current_effect_type'];

        if ($current_effect_type == 3) {
            self::incStat(1, 'executed_echo_effect_number', $player_id);
        }

        $nesting_index = $this->innovationGameState->get('current_nesting_index');
        self::updateCurrentNestedCardState('post_execution_index', 0);
        $nested_card_state = self::getNestedCardState($nesting_index);

        // If this is a nested card, don't allow other players to share the non-demand effect
        if ($nesting_index >= 1 && $nested_card_state['current_effect_type'] == 1) {
            $next_player = null;
        // If the dogma is being endorsed, allow the launcher to execute the non-demand or echo effect again
        } else if ($nesting_index == 0 && $this->innovationGameState->get('endorse_action_state') == 2 && $player_id == $launcher_id && ($current_effect_type == 1 || $current_effect_type == 3)) {
            $this->innovationGameState->set('endorse_action_state', 3);
            $next_player = $player_id;
        } else {
            $next_player = self::getNextPlayerUnderEffect($current_effect_type, $player_id, $launcher_id);
            // If the dogma is being endorsed and it's a demand (or compel) effect, go around a second time
            if ($next_player == null && $nesting_index == 0 && $this->innovationGameState->get('endorse_action_state') == 2 && ($current_effect_type == 0 || $current_effect_type == 2)) {
                $this->innovationGameState->set('endorse_action_state', 3);
                $next_player = self::getFirstPlayerUnderEffect($current_effect_type, $launcher_id);
            }
        }

        // There are no more players which are eligible to share this effect
        if ($next_player === null) {
            self::trace('interPlayerInvolvedTurn->interDogmaEffect');
            $this->gamestate->nextState('interDogmaEffect');
            return;
        }
        
        // Jump to this player
        if ($player_id != $next_player) {
            self::updateCurrentNestedCardState('current_player_id', $next_player);
            $this->gamestate->changeActivePlayer($next_player);
        }
        self::trace('interPlayerInvolvedTurn->playerInvolvedTurn');
        $this->gamestate->nextState('playerInvolvedTurn');
    }
    
    function stInteractionStep() {
        $player_id = self::getCurrentPlayerUnderDogmaEffect();
        $launcher_id = self::getLauncherId();

        $nested_card_state = self::getCurrentNestedCardState();
        $card_id = $nested_card_state['card_id'];
        $current_effect_type = $nested_card_state['current_effect_type'];
        $current_effect_number = $nested_card_state['current_effect_number'];
        // Echo effects are sometimes executed on cards other than the card being dogma'd
        if ($current_effect_type == 3) {
            $nesting_index = $nested_card_state['nesting_index'];
            $card_id = self::getUniqueValueFromDB(self::format("SELECT card_id FROM echo_execution WHERE nesting_index = {nesting_index} AND execution_index = {effect_number}", array('nesting_index' => $nesting_index, 'effect_number' => $current_effect_number)));
        }

        $step = self::getStep();
        $code = self::getCardExecutionCodeWithLetter($card_id, $current_effect_type, $current_effect_number, $step);

        $card_id_1 = $this->innovationGameState->get('card_id_1');
        $card_id_2 = $this->innovationGameState->get('card_id_2');
        $card_id_3 = $this->innovationGameState->get('card_id_3');
        
        $crown = self::getIconSquare(1);
        $leaf = self::getIconSquare(2);
        $lightbulb = self::getIconSquare(3);
        $tower = self::getIconSquare(4);
        $factory = self::getIconSquare(5);
        $clock = self::getIconSquare(6);

        $options = null;
        switch($code) {
        // The first number is the id of the card
        // D1 means the first (and single) I demand effect
        // C1 means the first (and single) I compel effect
        // N1 means the first non-demand effect
        // N2 means the second non-demand effect
        // N3 means the third non-demand effect
        // E1 means the first (and single) echo effect
        
        // The letter indicates the step : A for the first one, B for the second
        
        // Setting the $step_max variable means there is interaction needed with the player
        
        // id 0, age 1: Pottery
        case "0N1A":
            // "You may return up to three cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'n_max' => 3,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
            
        // id 1, age 1: Tools
        case "1N1A":
            // "You may return three cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 3,
                'solid_constraint' => true, // The player MUST have three cards in hand to trigger the effect
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
        case "1N2A":
            // "You may return a 3 from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'age' => 3
            );
            break;
        
        // id 3, age 1: Archery
        case "3D1A":
            // "Transfer the highest card in your hand to my hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'hand',
                
                'age' => self::getMaxAgeInHand($player_id)
            );
            break;

        case "3N1A":
            // "Junk an available achievement of value 1 or 2"
            // NOTE: This only occurs in the 4th edition and beyond
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => 0,
                'location_to' => 'junk',
                
                'age_min' => 1,
                'age_max' => 2,
            );
            break;
            
        // id 5, age 1: Oars
        case "5D1A":
            // "Transfer a card with a crown from your hand to my score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'with_icon' => 1
            );
            break;

        // id 6, age 1: Clothing
        case "6N1A":
            // "Meld a card from your hand of different color of any card on your board"
            $board = self::getCardsInLocationKeyedByColor($player_id, 'board');
            $selectable_colors = array();
            for ($color=0; $color<5; $color++) {
                if (count($board[$color]) == 0) { // This is a color the player does not have
                    $selectable_colors[] = $color;
                }
            }
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'color' => $selectable_colors
            );
            break;
        
        // id 9, age 1: Agriculture
        case "9N1A":
            // "You may return a card from you hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
            
        // id 10, age 1: Domestication
        case "10N1A":
            // "Meld the lowest card in your hand"
            $age = self::getMinAgeInHand($player_id);
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'age' => $age
            );
            break;
        
        // id 11, age 1: Masonry
        case "11N1A":
            // "You may meld any number of cards from your hand, each with a tower"
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'with_icon' => 4 
            );
            break;
        
        // id 12, age 1: City states
        case "12D1A":
            // "Transfer a top card with a tower from your board to my board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',
                
                'with_icon' => 4 
            );
            break;
            
        // id 13, age 1: Code of laws
        case "13N1A":
            // "You may tuck a card from your hand of the same color of any card on your board"
            $board = self::getCardsInLocationKeyedByColor($player_id, 'board');
            $selectable_colors = array();
            for ($color=0; $color<5; $color++) {
                if (count($board[$color]) > 0) { // This is a color the player already have
                    $selectable_colors[] = $color;
                }
            }
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                'bottom_to' => true,
                
                'color' => $selectable_colors
            );
            break;
        
        case "13N1B":
            // "You may splay that color left"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 1 /* left */,
                'color' => array($this->innovationGameState->get('color_last_selected'))
            );
            break;
        
        // id 16, age 2: Mathematics
        case "16N1A":
            // "You may return a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
            
        // id 17, age 2: Construction
        case "17D1A":
            // "Transfer two cards from you hand to my hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 2,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'hand'
            );
            break;
            
        // id 18, age 2: Road building
        case "18N1A":
            // "Meld one or two cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'n_max' => 2,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board'
            );
            break;
            
        case "18N1B":
            // "You may transfer your top red card to another player's board. If you do, transfer that player's top green card to your board.
            $options = array(
                'player_id' => $player_id,
                'can_pass' => true,
                
                'choose_player' => true,
                'players' => self::getOtherActivePlayers($player_id)
            );
            break;
            
        // id 19, age 2: Currency
        case "19N1A":
            // "You may return any number of card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
        
        // id 20, age 2: Mapmaking
        case "20D1A":
            // "Transfer a 1 from your score pile to my score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'age' => 1
            );
            break;
            
        // id 21, age 2: Canal building         
        case "21N1A":
            // "You may exchange all the highest cards in your hand with all the highest cards in your score pile"
            $options = array(
                'player_id' => $player_id,
                
                'choose_yes_or_no' => true
            );
            break;
            
        // id 23, age 2: Monotheism        
        case "23D1A":
            // "I demand you transfer a top card on your board of different color from any card on my board to my score pile!"
            $board = self::getCardsInLocationKeyedByColor($launcher_id, 'board');
            $selectable_colors = array();
            for ($color=0; $color<5; $color++) {
                if (count($board[$color]) == 0) { // This is a color the player does not have
                    $selectable_colors[] = $color;
                }
            }
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'color' => $selectable_colors,
            );
            break;
            
        // id 24, age 2: Philosophy        
        case "24N1A":
            // "You may splay any one color of your cards"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 1 /* left */
            );
            break;
        
        case "24N2A":
            // "You may score a card from your board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'score_keyword' => true
            );
            break;
            
        // id 25, age 3: Alchemy        
        case "25N1A":
            // "Return the drawn cards and all cards from your hand"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'revealed,hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;
            
        case "25N2A":
            // "Meld a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
            );
            break;
            
        case "25N2B":
            // "Score a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'score_keyword' => true
            );
            break;
            
        // id 26, age 3: Translation        
        case "26N1A":
            // "You may meld all the cards in your score pile. If you meld one, you must meld them all"
            $options = array(
                'player_id' => $player_id,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $player_id,
                'location_to' => 'board',
            );
            break;
        
        // id 27, age 3: Engineering        
        case "27N1A":
            // "You may splay your red cards left"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 1 /* left */,
                'color' => array(1) /* red */
            );
            break;
                
            case "27N1":
                $step_max = 1;
                break;
                
        // id 28, age 3: Optics
        case "28N1A":
            // "An opponent with fewer points than you"
            $options = array(
                'player_id' => $player_id,
                
                'choose_player' => true,
                'players' => self::getActiveOpponentsWithFewerPoints($player_id)
            );
            break;
            
        case "28N1B":
            // "Transfer a card from your score pile to the opponent score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $this->innovationGameState->get('choice'), // ie the opponent chosen on the previous step
                'location_to' => 'score'
            );
            break;

        // id 29, age 3: Compass        
        case "29D1A":
            // "Transfer a top non-green card with a leaf from your board to my board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',
                
                'color' => array(0,1,3,4) /* non-green */,
                'with_icon' => 2 /* with a leaf */
            );
            break;
            
        case "29D1B":
            // "Transfer a top card without a leaf from my board to your board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $launcher_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'without_icon' => 2 /* without a leaf */
            );
            break;
            
        // id 30, age 3: Paper        
        case "30N1A":
            // "You may splay your green or blue cards left"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 1 /* left */,
                'color' => array(0, 2) /* blue or green */
            );
            break;
            
        // id 31, age 3: Machinery        
        case "31N1A":
            // "Score a card from your hand with a tower"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed,score',
                
                'with_icon' => 4, /* tower */
                
                'score_keyword' => true,
            );
            break;
          
        case "31N1B":
            // "You may splay your red cards left"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 1 /* left */,
                'color' => array(1) /* red */
            );
            break;

        // id 32, age 3: Medicine
        case "32D1A":
            // "... with the lowest card in my score pile"
            $options = array(
                'player_id' => $launcher_id,
                'n' => 1,
                
                'owner_from' => $launcher_id,
                'location_from' => 'score',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'age' => self::getMinAgeInScore($launcher_id)
            );
            break;
            
        case "32D1B":
            // "Exchange the highest card in your score pile..."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'age' => self::getMaxAgeInScore($player_id)
            );
            break;

            
        // id 33, age 3: Education        
        case "33N1A":
            // You may return the highest card from your score pile
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'age' => self::getMaxAgeInScore($player_id)
            );
            break;

        // id 34, age 3: Feudalism        
        case "34D1A":
            // "Transfer a card with a tower from your hand to my hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'hand',
                
                'with_icon' => 4 /* tower */
            );
            break;
            
        case "34N1A":
            // "You may splay your yellow or purple cards left"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 1, /* left */
                'color' => array(3, 4) /* yellow or purple */
            );
            break;
            
        // id 36, age 4: Printing press        
        case "36N1A":
            // "You may return a card from your score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
            
        case "36N2A":
            // "You may splay your blue cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */,
                'color' => array(0) /* blue */
            );
            break;
            
        // id 38, age 4: Gunpowder
        case "38D1A":
            // "Transfer a top card with a tower from your board to my score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'with_icon' => 4 /* tower */
            );
            break;
        
        // id 39, age 4: Invention
        case "39N1A":
            $splayed_left_colors = array();
            for($color=0; $color<5; $color++) {
                if (self::getCurrentSplayDirection($player_id, $color)==1 /* left */) {
                    $splayed_left_colors[] = $color;
                }
            }
            // "You may splay right any one color of your cards currently splayed left"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */,
                'color' => $splayed_left_colors
            );
            break;
            
        // id 40, age 4: Navigation
        case "40D1A":
            // "Transfer a 2 or a 3 from your score pile to my score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'age_min' => 2,
                'age_max' => 3
            );
            break;
            
        // id 41, age 4: Anatomy
        case "41D1A":
            // "Return a card from your score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
        
        case "41D1B":
            // "Return a card of equal value from your board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'age' => self::getAuxiliaryValue(),
                'not_id' => 188 // Battleship Yamato should not be returned even if an 8 is returned from the score pile
            );
            break;
            
        // id 42, age 4: Perspective
        case "42N1A":
            // "You may return a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
        
        case "42N1B":
            $number_of_lightbulbs = self::getPlayerSingleRessourceCount($player_id, 3 /* lightbulb */);
            self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} ${lightbulbs}.'), array('You' => 'You', 'n' => $number_of_lightbulbs, 'lightbulbs' => $lightbulb));
            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} ${lightbulbs}.'), array('player_name' => self::getColoredPlayerName($player_id), 'n' => $number_of_lightbulbs, 'lightbulbs' => $lightbulb));
            // "Score a card from your hand for every two lightbulbs on your board"
            $options = array(
                'player_id' => $player_id,
                'n' => self::intDivision($number_of_lightbulbs, 2),
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'score_keyword' => true
            );
            break;
            
        // id 43, age 4: Enterprise
        case "43D1A":
            // "Transfer a top non-purple card with a crown from your board to my board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',
                
                'color' => array(0,1,2,3) /* non-purple */,
                'with_icon' => 1 /* with a crown */
            );
            break;
        
        case "43N1A":
            // "You may splay your green cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */,
                'color' => array(2) /* green */
            );
            break;
        
        // id 44, age 4: Reformation
        case "44N1A":
            $number_of_leaves = self::getPlayerSingleRessourceCount($player_id, 2);
            self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} ${leaves}.'), array('You' => 'You', 'n' => $number_of_leaves, 'leaves' => $leaf));
            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} ${leaves}.'), array('player_name' => self::getColoredPlayerName($player_id), 'n' => $number_of_leaves, 'leaves' => $leaf));
            // "You may tuck a card from your hand for every two leaves on your board"
            $options = array(
                'player_id' => $player_id,
                'n' => self::intDivision($number_of_leaves, 2),
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'bottom_to' => true
            );
            break;
        
        case "44N2A":
            // "You may splay your yellow or purple cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */,
                'color' => array(3,4) /* yellow, purple */
            );
            break;

        // id 45, age 5: Chemistry
        case "45N1A":
            // "You may splay your blue cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */,
                'color' => array(0) /* blue */
            );
            break;
        
        case "45N2A":
            // "Return a card from your score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;
            
        // id 46, age 5: Physics        
        case "46N1A":
            // "Return the drawn cards and all cards from your hand"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'revealed,hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        // id 47, age 5: Coal
        case "47N2A":
            // "You may splay your red cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */,
                'color' => array(1) /* red */
            );
            break;
            
        case "47N3A":
            // "You may score any one of your top cards"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'score_keyword' => true
            );
            break;
        
        // id 48, age 5: The pirate code
        case "48D1A":
            // "Transfer two cards of value 4 or less from your score pile to my score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 2,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'age_max' => 4
            );
            break;

        case "48N1A":
            // "Score the lowest top card with a crown from your board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'age' => self::getMinAgeOnBoardTopCardsWithIcon($player_id, 1 /* crown */),
                'with_icon' => 1, /* crown */

                'score_keyword' => true
            );
            break;

        // id 49, age 5: Banking
        case "49D1A":
            // "Transfer a top non-green card with a factory from your board to my board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',
                
                'color' => array(0,1,3,4) /* non-green */,
                'with_icon' => 5 /* with a factory */
            );
            break;

        case "49N1A":
            // "You may splay your green cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */,
                'color' => array(2) /* green */
            );
            break;

        // id 50, age 5: Measurement
        case "50N1A":
            if ($this->innovationGameState->usingFirstEditionRules()) {
                // "You may return a card from your hand"
                $options = array(
                    'player_id' => $player_id,
                    'n' => 1,
                    'can_pass' => true,
                    
                    'owner_from' => $player_id,
                    'location_from' => 'hand',
                    'owner_to' => 0,
                    'location_to' => 'deck',
                );
            } else {
                // "You may reveal and return a card from your hand"
                $options = array(
                    'player_id' => $player_id,
                    'n' => 1,
                    'can_pass' => true,
                    
                    'owner_from' => $player_id,
                    'location_from' => 'hand',
                    'owner_to' => $player_id,
                    'location_to' => 'revealed,deck',
                );
            }
            break;
            
        case "50N1B":
            // "Choose a color"
            $options = array(
                'player_id' => $player_id,
                
                'choose_color' => true
            );
            break;

        // id 51, age 5: Statistics
        case "51D1A":
            // First edition only
            // "I demand you transfer the highest card in your score pile to your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $player_id,
                'location_to' => 'hand',
                
                'age' => self::getMaxAgeInScore($player_id)
            );
            break;

        case "51N1A":
            // "You may splay your yellow cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */,
                'color' => array(3) /* yellow */
            );
            break;
        
        // id 54, age 5: Societies
        case "54D1A":
            // Last edition: "Transfer a card with a lightbulb higher than my top card of the same color from your board to my board"
            // First edition: "Transfer a top non-purple card with a lightbulb from your board to my board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',
                
                'color' => self::getAuxiliaryValueAsArray(),
                'with_icon' => 3 /* with a lightbulb */
            );
            break;
            
        // id 55, age 6: Atomic theory
        case "55N1A":
            // "You may splay your blue cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */,
                'color' => array(0) /* blue */
            );
            break;
            
        // id 56, age 6: Encyclopedia
        case "56N1A":
            // "You may meld all the highest cards on your score pile. If you meld one, you must meld them all"
            $options = array(
                'player_id' => $player_id,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'age' => self::getMaxAgeInScore($player_id),
            );
            break;
        
        // id 57, age 6: Industrialisation
        case "57N2A":
            // "You may splay your red or purple cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */,
                'color' => array(1,4) /* red or purple */
            );
            break;

        // id 59, age 6: Classification
        case "59N1A":
            // "Reveal the color of a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed'
            );
            break;
            
        case "59N1B":
            // "Meld of cards of that color from your hand"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'color' => array(self::getAuxiliaryValue()), /* The color the player has revealed */
            );
            break;
        
        // id 60, age 6: Metric system
        case "60N1A":
            // "You may splay any one color of your cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */
            );
            break;
        
        case "60N2A":
            // "You may splay your green cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2, /* right */
                'color' => array(2) /* green */
            );
            break;
            
        // id 61, age 6: Canning
        case "61N1A":
            // "You may draw and tuck a 6"
            $options = array(
                'player_id' => $player_id,
                
                'choose_yes_or_no' => true
            );
            break;
        
        case "61N2A":
            // "You may splay your yellow cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */,
                'color' => array(3) /* yellow */
            );
            break;
        
        // id 62, age 6: Vaccination
        case "62D1A":
            // "Return all the lowest cards in your score pile"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'age' => self::getMinAgeInScore($player_id)
            );
            break;
            
        // id 63, age 6: Democracy          
        case "63N1A":
            // "You may return any number of cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
            
        // id 64, age 6: Emancipation
        case "64D1A":
            // "Transfer a card from your hand to my score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'score'
            );
            break;
        
        case "64N1A":
            // "You may splay your red or purple cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 2 /* right */,
                'color' => array(1,4) /* red or purple */
            );
            break;
            
        // id 65, age 7: Evolution          
        case "65N1A":
            // The player faces a choice
            $options = array(
                'player_id' => $player_id,
                'can_pass' => true, // Interpretation of the rules: the player can pass
                
                'choose_yes_or_no' => true
            );
            break;
             
        case "65N1B":
            // "Return a card from your score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
        
        // id 66, age 7: Publications
        case "66N1A":
            // "You may rearrange the order of one color of cards on your board"
            $options = array(
                'player_id' => $player_id,
                'can_pass' => true,
                
                'choose_rearrange' => true
            );
            break;
        
        case "66N2A":
            // "You may splay your blue or yellow cards up"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 3 /* up */,
                'color' => array(0,3) /* blue or yellow */
            );
            break;
            
        // id 67, age 7: Combustion
        case "67D1A":
            // Last edition => "Transfer one card from your score pile to my score pile for every four crown on my board"
            // First edition => "Transfer two cards from your score pile to my score pile"
            // Cf A
            $options = array(
                'player_id' => $player_id,
                'n' => self::getAuxiliaryValue(),
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $launcher_id,
                'location_to' => 'score'
            );
            break;
            
        // id 68, age 7: Explosives
        case "68D1A":
        case "68D1B":
        case "68D1C":
            // "Transfer the highest cards from your hand to my hand" (three times)
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'hand',
                
                'age' => self::getMaxAgeInHand($player_id)
            );
            break;
            
        // id 69, age 7: Bicycle      
        case "69N1A":
            // "You may exchange all the highest cards in your hand with all the highest cards in your score pile"
            $options = array(
                'player_id' => $player_id,
                
                'choose_yes_or_no' => true
            );
            break;

        // id 70, age 7: Electricity
        case "70N1A":
            // "Return all your top cards without a factory"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'without_icon' => 5, /* factory */
            );
            break;
        
        // id 71, age 7: Refrigeration
        case "71D1A":
            // "Return half (rounded down) of the cards in your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => self::intDivision(self::countCardsInLocation($player_id, 'hand'), 2), // Half (rounded down)
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;
            
        case "71N1A":
            // "You may score a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'score_keyword' => true
            );
            break;
        
        // id 72, age 7: Sanitation
        case "72D1A":
            // "... with the lowest card in my hand"
            $options = array(
                'player_id' => $launcher_id,
                'n' => 1,
                
                'owner_from' => $launcher_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'hand',
                
                'age' => self::getMinAgeInHand($launcher_id)
            );
            break;
        
        case "72D1B":
        case "72D1C":
            // "Exchange the highest card in your hand..." (two times)
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'hand',
                
                'age' => self::getMaxAgeInHand($player_id)
            );
            break;
        
        // id 73, age 7: Lighting        
        case "73N1A":
            // "You may tuck up to three cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'n_max' => 3,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'bottom_to' => true
            );
            break;
        
        // id 74, age 7: Railroad        
        case "74N1A":
            // "Return all the cards in your hand"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;
        
        case "74N2A":
            $splayed_right_colors = array();
            for($color=0; $color<5; $color++) {
                if (self::getCurrentSplayDirection($player_id, $color)==2 /* right */) {
                    $splayed_right_colors[] = $color;
                }
            }
            // "You may splay up any one color of your cards currently splayed right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 3 /* up */,
                'color' => $splayed_right_colors
            );
            break;
            
        // id 75, age 8: Quantum theory        
        case "75N1A":
            // "You may return up to two cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'n_max' => 2,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;
        
        // id 76, age 8: Rocketry       
        case "76N1A":
            $number_of_clocks = self::getPlayerSingleRessourceCount($player_id, 6 /* clock */);
            self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} ${clocks}.'), array('You' => 'You', 'n' => $number_of_clocks, 'clocks' => $clock));
            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has ${n} ${clocks}.'), array('player_name' => self::getColoredPlayerName($player_id), 'n' => $number_of_clocks, 'clocks' => $clock));
            // "Return a card in any opponent's score pile for every two clocks on your board"
            $options = array(
                'player_id' => $player_id,
                'n' => self::intDivision($number_of_clocks, 2),
                
                'owner_from' => 'any opponent',
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
        
        // id 77, age 8: Flight
        case "77N1A":
            // "You may splay any one color of your cards up"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 3 /* up */
            );
            break;
        
        case "77N2A":
            // "You may splay your red cards up"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 3, /* up */
                'color' => array(1) /* red */
            );
            break;
        
        // id 78, age 8: Mobility        
        case "78D1A":
        case "78D1B":
            // "Transfer your highest non-red top cards without a factory from your board to my score pile" (twice)
            $selectable_colors = self::getAuxiliaryValueAsArray(); /* not red, and for the second card, not the same color as the first */
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'age' => self::getMaxAgeOnBoardOfColorsWithoutIcon($player_id, $selectable_colors, 5 /* with no factory*/),
                'color' => $selectable_colors,
                'without_icon' => 5 /* factory */
            );
            break;
        
        // id 79, age 8: Corporations        
        case "79D1A":
            // "Transfer a top non-green card with a factory from your board to my score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'color' => array(0,1,3,4), /* not green */
                'with_icon' => 5 /* factory */
            );
            break;
            
        // id 80, age 8: Mass media         
        case "80N1A":
            // "You may return a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;

        case "80N1B":
            // "Choose a value"
            $options = array(
                'player_id' => $player_id,
                
                'choose_value' => true
            );
            break;
            
        case "80N1C":
            // "Return all cards of that value from all score piles"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => 'any player',
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'age' => self::getAuxiliaryValue()
            );
            break;
            
        case "80N2A":
            // "You may splay your purple cards up"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 3, /* up */
                'color' => array(4) /* purple */
            );
            break;
        
        // id 81, age 8: Antibiotics
        case "81N1A":
            // "You may return up to three cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'n_max' => 3,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
    
        // id 82, age 8: Skyscrapers
        case "82D1A":
            // "Transfer a top non-yellow card with a clock from your board to my board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',
                
                'color' => array(0,1,2,4), /* not yellow */
                'with_icon' => 6 /* clock */
             );
            break;
        
        case "82D1B":
            // "Return all the cards from that pile"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'pile',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'color' => array(self::getAuxiliaryValue()), /* the color of the card chosen on the first step */
             );
            break;
        
        // id 83, age 8: Empiricism     
        case "83N1A":
            // "Choose two colors"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_two_colors' => true 
            );
            break;
            
        case "83N1B":
            // "You may splay that color of your cards up"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 3, /* up */
                'color' => array(self::getAuxiliaryValue())
            );            
            break;
        
        // id 84, age 8: Socialism     
        case "84N1A":
            // "You may tuck all cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'bottom_to' => true
            );    
            break;
        
        // id 85, age 9: Computers     
        case "85N1A":
            // "You may splay your red or green cards up"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 3, /* up */
                'color' => array(1,2) /* red or green */
            );
            break;

        // id 87, age 9: Composites     
        case "87D1A":
            // "Transfer all but one card from your hand to my hand"
            $options = array(
                'player_id' => $player_id,
                'n' => self::countCardsInLocation($player_id, 'hand') - 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'hand'
            );        
            break;
            
        case "87D1B":
            // "Transfer the highest card from your score pile to my score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'age' => self::getMaxAgeInScore($player_id)
            );
            break;
        
        // id 88, age 9: Fission
        case "88N1A":
            // "Return a top card other than Fission from any player board"
             $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => 'any player',
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'not_id' => 88 /* Fission */
            );
            break;
        
        // id 89, age 9: Collaboration
        case "89D1A":
            // "Transfer the card of my choice to my board"
            $options = array(
                'player_id' => $launcher_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'revealed',
                'owner_to' => $launcher_id,
                'location_to' => 'board'
            );
            break;        
        
        // id 90, age 9: Satellites
        case "90N1A":
            // "Return all cards from you hand"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;

        case "90N2A":
            // "You may splay your purple cards up"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 3, /* up */
                'color' => array(4) /* purple */
            );
            break;
            
        case "90N3A":
            // "Meld a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board'
            );
            break;        

        // id 91, age 9: Ecology
        case "91N1A":
            // "You may return a card from you hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
            
        case "91N1B":
            // "Score a card from you hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'score_keyword' => true
            );
            break;
        
        // id 92, age 9: Suburbia
        case "92N1A":
            // "You may tuck any number of cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'bottom_to' => true
            );
            break;
        
        // id 93, age 9: Services
        case "93D1A":
            // "Transfer a top card from my board without a leaf to your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $launcher_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'hand',
                
                'without_icon' => 2 /* leaf */
            );
            break;
        
        // id 94, age 9: Specialization
        case "94N1A":
            // "Reveal a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed'
            );
            break;

        case "94N2A":
            // "You may splay your yellow or blue cards up"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 3, /* up */
                'color' => array(0,3) /* blue or yellow */
            );
            break;
        
        // id 95, age 10: Bioengineering
        case "95N1A":
            // "Transfer a top card with a leaf from any opponent's board to your score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => 'any opponent',
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'with_icon' => 2 /* leaf */
            );
            break;
        
        // id 97, age 10: Miniaturization
        case "97N1A":
            // "You may return a card from you hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
        
        // id 99, age 10: Databases
        case "99D1A":
            // "Return half (rounded up) of the cards in your score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => ceil(self::countCardsInLocation($player_id, 'score') / 2),
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck'
            );        
            break;
        
        // id 100, age 10: Self service
        case "100N1A":
            // "Execute each of the non-demand dogma effects of any other top card on your board" (a card with no non-demand effect can be chosen)
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id, // Nothing is to be done with that card
                'location_to' => 'board',
                
                // Exclude the card currently being executed (it's possible for the effects of Self Service to be executed as if it were on another card)
                'not_id' => self::getCurrentNestedCardState()['executing_as_if_on_card_id'],
            );       
            break;
        
        // id 101, age 10: Globalization
        case "101D1A":
            // "Return a top card with a ${icon_2} on your board" 
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'with_icon' => 2 /* leaf */
            );
            break;
        
        // id 102, age 10: Stem cells
        case "102N1A":
            // The player faces a choice
            $options = array(
                'player_id' => $player_id,
                
                'choose_yes_or_no' => true
            );
            break;
        
        // id 104, age 10: The internet.
        case "104N1A":
            // "You may splay your green cards up"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 3, /* up */
                'color' => array(2) /* green */
            );
            break;
            
         // id 110, Artifacts age 1: Treaty of Kadesh
         case "110C1A":
            // "Return all top cards from your board with a demand effect"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',

                'has_demand_effect' => true,
            );
            break;
        
        case "110N1A":
            // "Score a top, non-blue card from your board with a demand effect"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'color' => array(1,2,3,4), // non-blue
                'has_demand_effect' => true,

                'score_keyword' => true
            );
            break;
        
        // id 112, Artifacts age 1: Basur Hoyuk Tokens
        case "112N1A":
            // "Return the drawn card and all cards from your score pile"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'revealed,score',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        // id 113, Artifacts age 1: Holmegaard Bows
        case "113C1A":
            // "Transfer the highest top card with a tower on your board to my hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'hand',
                
                'with_icon' => 4, // tower
                'age' => self::getMaxAgeOnBoardTopCardsWithIcon($player_id, 4 /* tower */),
            );
            break;
        
        // id 114, Artifacts age 1: Papyrus of Ani
        case "114N1A":
            // "Return a purple card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed,deck',

                'color' => array(4),
            );
            break;

        case "114N1B":
            // Choose any type
            $options = array(
                'player_id' => $player_id,
                
                'choose_type' => true,
                'type' => self::getActiveCardTypes()
            );
            break;
        
        
        // id 115, Artifacts age 1: Pavlovian Tusk
        case "115N1A":
            // "Return one of the drawn cards"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',

                'card_id_1' => $card_id_1,
                'card_id_2' => $card_id_2,
                'card_id_3' => $card_id_3
            );
            break;
        
        case "115N1B":
            // "Score one of the drawn cards"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'card_id_1' => $card_id_1,
                'card_id_2' => $card_id_2,
                'card_id_3' => $card_id_3,

                'score_keyword' => true
            );
            break;

        // id 116, Artifacts age 1: Priest-King
        case "116N1A":
            // "Score a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed,score',

                'score_keyword' => true
            );
            break;

        case "116N2A":
            // "Claim an achievement, if eligible"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => $player_id,
                'location_to' => 'achievements',

                'require_achievement_eligibility' => true
            );
            break;
        
        // id 118, Artifacts age 1: Jiskairumoko Necklace
        case "118C1A":
            // "Return a card from your score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
        
        case "118C1B":
            // "Transfer an achievement of the same value from your achievements to mine"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'achievements',
                'owner_to' => $launcher_id,
                'location_to' => 'achievements',
                
                'age' => $this->innovationGameState->get('age_last_selected')
            );
            break;
        
        // id 120, Artifacts age 1: Lurgan Canoe
        case "120N1A":
            // "Meld a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board'
            );
            break;
        
        // id 121, Artifacts age 1: Xianrendong Shards
        case "121N1A":
            // "Reveal three cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 3,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed'
            );
            break;
        
        case "121N1B":
            // "Score two"
            $options = array(
                'player_id' => $player_id,
                'n' => 2,

                // Propagate values required to detect whether the scored cards are the same color
                'card_id_1' => $card_id_1,
                'card_id_2' => $card_id_2,
                'card_id_3' => $card_id_3,
                
                'owner_from' => $player_id,
                'location_from' => 'revealed',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'score_keyword' => true
            );
            break;
        
        // id 122, Artifacts age 1: Mask of Warka
        case "122N1A":
            // "Choose a color"
            $options = array(
                'player_id' => $player_id,
                
                'choose_color' => true
            );
            break;

        case "122N1B":
            // "return them"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',

                'color' => array(self::getAuxiliaryValue()),
            );
            break;
            
        // id 123, Artifacts age 1: Ark of the Covenant
        case "123N1A":
            // "Return a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed,deck',
            );
            break;
            
        // id 124, Artifacts age 1: Tale of the Shipwrecked Sailor
        case "124N1A":
            // "Choose a color"
            $options = array(
                'player_id' => $player_id,
                
                'choose_color' => true
            );
            break;
        
        case "124N1B":
            // "Meld a card of the chosen color from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'color' => array(self::getAuxiliaryValue())
            );
            break;
        
        // id 126, Artifacts age 1: Rosetta Stone
        case "126N1A":
            // "Choose a type"
            $options = array(
                'player_id' => $player_id,

                'choose_type' => true,
                'type' => self::getActiveCardTypes()
            );
            break;

        case "126N1B":
            // "Meld one (of the drawn cards)"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',

                'card_id_1' => $card_id_1,
                'card_id_2' => $card_id_2
            );
            break;

        case "126N1C":
            // Choose an opponent to transfer the other card to
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_player' => true,
                'players' => self::getActiveOpponents($player_id)
            );
            break;
        
        // id 128, Artifacts age 2: Babylonian Chronicles
        case "128C1A":
            // "Transfer a top non-red card with a tower from your board to my board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',
                
                'with_icon' => 4, // tower
                'color' => array(0, 2, 3, 4) // non-red
            );
            break;

        // id 129, Artifacts age 2: Holy Lance
        case "129C1A":
            // "Transfer a top Artifact from your board to my board!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',
                 
                'type' => array(1) // Artifact
            );
            break;

        // id 130, Artifacts age 1: Baghdad Battery
        case "130N1A":
            // "Meld two cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 2,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
            );
            break;

        // id 131, Artifacts age 2: Holy Grail
        case "131N1A":
            // "Return a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
            
        case "131N1B":
            // "Claim an achievement of matching value, ignoring eligibility"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'age' => $this->innovationGameState->get('age_last_selected'),
                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => $player_id,
                'location_to' => 'achievements',

                'require_achievement_eligibility' => false
            );
            break;

        // id 132, Artifacts age 2: Terracotta Army
        case "132C1A":
            // "I compel you to return a top card on your board with no tower"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'without_icon' => 4 // tower
            );
            break;

        case "132N1A":
            // "Score a card from your hand with no towers"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'without_icon' => 4, // tower

                'score_keyword' => true
            );
            break;
        
        // id 134, Artifacts age 2: Cyrus Cylinder
        case "134N1A":
            // "Choose any other top purple card on any player's board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => 'any player',
                'location_from' => 'board',
                'location_to' => 'none',

                'color' => array(4), // Purple

                // Exclude the card currently being executed (it's possible for the effects of Cyrus Cylinder to be executed as if it were on another card)
                'not_id' => self::getCurrentNestedCardState()['executing_as_if_on_card_id'],
            );
            break;

        case "134N1B":
        case "134N1+A":
            // Prompt player to pick a stack which to splay left.
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => 'any player',
                'location_from' => 'board',
                'location_to' => 'none',
            );
            break;
            
        // id 135, Artifacts age 3: Dunhuang Star Chart
        case "135N1A":
            // "Return all cards from your hand"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;

        // id 136, Artifacts age 3: Charter of Liberties
        case "136N1A":
            // "Tuck a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'bottom_to' => true
            );
            break;

        case "136N1B":
            // "Choose a splayed color on any player's board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => 'any player',
                'location_from' => 'board',
                'location_to' => 'none',
                
                'has_splay_direction' => array(1, 2, 3, 4) // Left, right, up, or aslant
            );
            break;

        // id 137, Artifacts age 2: Excalibur
        case "137C1A":
            // "I compel you to transfer a top card of higher value than my
            // top card of the same color from your board to my board!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',
                
                'color' => self::getAuxiliaryValueAsArray()
            );
            break;
            
        // id 138, Artifacts age 3: Mjolnir Amulet
        case "138C1A":
            // "I compel you to choose a top card on your board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'none',
            );
            break;
            
        // id 139, Artifacts age 3: Philosopher's Stone
        case "139N1A":
            // "Return a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;

        case "139N1B":
            // "Score a number of cards from your hand equal to the value of the card returned"
            $age_selected = $this->innovationGameState->get('age_last_selected');
            $options = array(
                'player_id' => $player_id,
                'n' => $age_selected,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'score_keyword' => true
            );
            break;

        // id 141, Artifacts age 3: Moylough Belt Shrine
        case "141C1A":
            // "Transfer the card of my choice to my board"
            $options = array(
                'player_id' => $launcher_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'revealed',
                'owner_to' => $launcher_id,
                'location_to' => 'board'
            );
            break;

        // id 143, Artifacts age 3: Necronomicon
        case "143N1A":
            // "If red, return all cards in your score pile"
            if (self::getAuxiliaryValue() == 1) { // Red
                $options = array(
                    'player_id' => $player_id,
                    'can_pass' => false,
                    
                    'owner_from' => $player_id,
                    'location_from' => 'score',
                    'owner_to' => 0,
                    'location_to' => 'deck'
                );     
            // "If yellow, return all cards in your hand"
            } else if (self::getAuxiliaryValue() == 3) { // Yellow
                $options = array(
                    'player_id' => $player_id,
                    'can_pass' => false,
                    
                    'owner_from' => $player_id,
                    'location_from' => 'revealed,hand',
                    'owner_to' => 0,
                    'location_to' => 'deck',
                );
            };
            break;
        
        // id 144, Artifacts age 3: Shroud of Turin
        case "144N1A":
            // "Return a card from hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed,deck'
            );
            break;

        case "144N1B":
            // "Return a top card from your board of the returned card's color"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',

                'color' => array($this->innovationGameState->get('color_last_selected'))
            );
            break;

        case "144N1C":
            // "Return a card from score pile of the returned card's color"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $player_id,
                'location_to' => 'revealed,deck',

                'color' => array($this->innovationGameState->get('color_last_selected'))
            );
            break;

        case "144N1D":
            // "Claim an achievement ignoring eligibility"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => $player_id,
                'location_to' => 'achievements',

                'require_achievement_eligibility' => false
            );
            break;

        // id 145, Artifacts age 4: Petition of Right
        case "145C1A":    
            // "I compel you to transfer a card from your score pile to my score pile for each top card with a tower on your board!"
            $options = array(
                'player_id' => $player_id,
                'n' => self::getAuxiliaryValue(),
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $launcher_id,
                'location_to' => 'score'
            );
            break;

        // id 146, Artifacts age 4: Delft Pocket Telescope
        case "146N1A":
            // "Return a card from your score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $player_id,
                'location_to' => 'revealed,deck'
            );
            break;
            
        case "146N1B":            
            // "Return the drawn cards"
             $options = array(
                'player_id' => $player_id,
                'n' => 2,

                'owner_from' => $player_id,
                'location_from' => 'revealed',
                'owner_to' => 0,
                'location_to' => 'deck',

                'card_id_1' => $card_id_1,
                'card_id_2' => $card_id_2
            );            
            break;

        case "146N1C":
            // "Reveal one of the drawn cards that has a symbol in common with the returned card"   
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed',

                'card_id_1' => $card_id_1,
                'card_id_2' => $card_id_2,

                'enable_autoselection' => false, // Automating this always reveals hidden info
            );
            break;

        // id 147, Artifacts age 4: East India Company Charter
        case "147N1A":
            // "Choose a value other than 5"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,

                'age' => array(1, 2, 3, 4, 6, 7, 8, 9, 10, 11)
            );
            break;

        case "147N1B":
            // "Return all cards of that value from all score piles"
            $value_to_return = self::getAuxiliaryValue();
            $num_players_who_returned = 0;
            foreach (self::getAllActivePlayerIds() as $id) {
                $score_pile = self::getCardsInLocation($id, 'score');
                foreach ($score_pile as $card) {
                    if ($card['age'] == $value_to_return) {
                        $num_players_who_returned++;
                        break;
                    }
                }
            }
            self::setAuxiliaryValue($num_players_who_returned);
            
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => 'any player',
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'age' => $value_to_return
            );
            break;

        // id 148, Artifacts age 4: Tortugas Galleon
        case "148C1A":
            // "Transfer a top card on your board of that value to my board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',

                'age' => self::getAuxiliaryValue()
            );
            break;
            
        // id 149, Artifacts age 4: Molasses Reef Caravel
        case "149N1A":
            // "Return all cards from your hand"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
            
        case "149N1B":
            // "Meld a blue card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',

                'color' => array(0) // blue
            );
            break;

        case "149N1C":
            // "Score a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'score_keyword' => true
            );
            break;
            
        case "149N1D":
            // "Return a card from your score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
            
        // id 150, Artifacts age 4: Hunt-Lenox Globe
        case "150N1A":
            // "If you have fewer than four cards in your hand"
            if (self::countCardsInLocation($player_id, 'hand') < 4) {
                // "Return all non-green top cards from your board"
                self::setAuxiliaryValue(1); // Indicate that player had fewer than four cards in hands
                $options = array(
                    'player_id' => $player_id,
                    'can_pass' => false,

                    'owner_from' => $player_id,
                    'location_from' => 'board',
                    'owner_to' => 0,
                    'location_to' => 'deck',

                    'color' => array(0,1,3,4)
                );
                self::incrementStepMax(1);

            // "Meld a card from your hand"
            } else {
                self::setAuxiliaryValue(0); // Indicate that player had at least four cards in hands
                $options = array(
                    'player_id' => $player_id,
                    'n' => 1,
                    'can_pass' => false,

                    'owner_from' => $player_id,
                    'location_from' => 'hand',
                    'owner_to' => $player_id,
                    'location_to' => 'board'
                );
            }
            break;
            
        case "150N1B":
            // "Meld a card from your hand"
            self::setAuxiliaryValue(0);
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board'
            );
            break;

        // id 151, Artifacts age 4: Moses
        case "151N1A":    
            // "Score a top card on your board with a crown"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'with_icon' => 1, /* crown */

                'score_keyword' => true
            );
            break;
        
        // id 152, Artifacts age 4: Mona Lisa
        case "152N1A":
            // Choose a color
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_color' => true,
            );
            break;

        case "152N1B":
            // Help the UI pick a reasonable default for the integer selection
            $chosen_color = self::getAuxiliaryValue2();
            $cards = self::getCardsInLocationKeyedByColor($player_id, 'hand');
            self::setAuxiliaryValue(count($cards[$chosen_color]));

            // Choose a number
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_non_negative_integer' => true,
            );
            break;

        case "152N1C":
            // "Otherwise, return all cards from your hand"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;
            
        // id 155, Artifacts age 5: Boerhavve Silver Microscope
        case "155N1A":
            // "Return the lowest card in your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',

                'age' => self::getMinAgeInHand($player_id)
            );
            break;

        case "155N1B":
            // "and the lowest top card on your board"
            // TODO(LATER): Create new getMinAgeOnBoardTopCards function instead (based on getMaxAgeOnBoardTopCards).
            $all_cards = self::getTopCardsOnBoard($player_id);
            $ages = array();
            foreach($all_cards as $card) {
                $ages[] = $card['faceup_age'];
            }
            if (empty($ages)) {
                $ages[] = 0;
            }

            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',

                'age' => min($ages)
            );
            break;

        // id 156, Artifacts age 5: Principia
        case "156N1A":
            // Record the values of all non-blue top cards.
            $ages_on_top = array();
            for ($color = 1; $color < 5; $color++) { // non-blue
                $top_card = self::getTopCardOnBoard($player_id, $color);
                if ($top_card !== null) {
                    $ages_on_top[] = $top_card['faceup_age'];
                }
            }
            self::setAuxiliaryValue(Arrays::getValueFromBase16Array($ages_on_top));

            // "Return all non-blue top cards from your board"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',

                'color' => array(1, 2, 3, 4), // non-blue
            );
            break;

        // id 157, Artifacts age 5: Bill of Rights
        case "157C1A":
            $options = array(
                'player_id' => $player_id,
                
                'choose_color' => true,
                'color' => $this->innovationGameState->getAsArray('color_array')
            );            
            break;
        
        // id 158, Artifacts age 5: Ship of the Line Sussex
        case "158N1A":
            // "Return all cards from your score pile"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;
        
        case "158N1B":
            // "Choose a color"
            $options = array(
                'player_id' => $player_id,
                
                'choose_color' => true
            );
            break;
            
        // id 160, Artifacts age 5: Hudson's Bay Company Archives
        case "160N1A":    
            // "Meld a card from your score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $player_id,
                'location_to' => 'board'
            );
            break;
            
        // id 161, Artifacts age 5: Gujin Tushu Jinsheng
        case "161N1A":
            // "Choose any other top card on any other board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => 'any other player',
                'location_from' => 'board',
                'location_to' => 'none'               
            );
            break;
        
        // id 162, age 5: The Daily Courant
        case "162N1A":
            // Choose value to draw
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true
            );       
            break;

        case "162N1B":
            // Return the card to top of deck
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'enable_autoselection' => false, // Give the player the chance to read the card
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',

                'bottom_to' => false, // Topdeck
                
                'card_id_1' => $this->innovationGameState->get('card_id_1')
            );       
            break;
            
        case "162N1C":
            // "You may execute the effects of one of your other top cards as if they were on this card. Do not share them."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'none',
                
                // Exclude the card currently being executed (it's possible for the effects of The Daily Courant to be executed as if it were on another card)
                'not_id' => self::getCurrentNestedCardState()['executing_as_if_on_card_id'],
            );       
            break;      
            
        // id 163, Artifacts age 5: Sandham Room Cricket Bat
        case "163N1A":
            // "Claim an achievement ignoring eligibility"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => $player_id,
                'location_to' => 'achievements',

                'require_achievement_eligibility' => false
            );
            break;

        // id 164, Artifacts age 5: Almira, Queen of the Castle
        case "164N1A":
            // "Meld a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board'
            );
            break;

        case "164N1B":
            // "Claim an achievement of matching value, ignoring eligibility"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => $player_id,
                'location_to' => 'achievements',

                'age' => self::getFaceupAgeLastSelected(),
                'require_achievement_eligibility' => false
            );
            break;

        // id 165, Artifacts age 6: Kilogram of the Archives
        case "165N1A":
            // "Return a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;

        case "165N1B":
            // "Return a top card from your board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;

        // id 166, Artifacts age 6: Puffing Billy
        case "166N1A":
            // "Return a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed,deck'
            );
            break;

        // id 167, Artifacts age 6: Frigate Constitution
        case "167C1A":
            // "I compel you to reveal a card in your hand!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed'
            );
            break;

        case "167C1B":
            // "Return it"
            $revealed_card = self::getCardsInLocation($player_id, 'revealed')[0];
            self::returnCard($revealed_card);

            // "And all cards of its color from your board"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'pile',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'color' => array($this->innovationGameState->get('color_last_selected')),
            );
            break;

        // id 168, Artifacts age 6: U.S. Declaration of Independence
        case "168C1A":
            // "Transfer the highest card in your hand to my hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'hand',

                'age' => self::getMaxAgeInHand($player_id)
            );
            break;

        case "168C1B":
            // "Transfer the highest card in your score pile to my score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $launcher_id,
                'location_to' => 'score',

                'age' => self::getMaxAgeInScore($player_id)
            );
            break;
            
        case "168C1C":
            // "Transfer the highest top card with a factory from your board to my board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',

                'age' => self::getMaxAgeOnBoardTopCardsWithIcon($player_id, 5),
                'with_icon' => 5
            );
            break;

        // id 170, Artifacts age 6: Buttonwood Agreement
        case "170N1A":
            // "Choose three colors"
            $options = array(
                'player_id' => $player_id,
                
                'choose_three_colors' => true
            );
            break;

        case "170N1B":
            // Reveal score pile to prove to other players that they are returning the correct cards.
            self::revealScorePile($player_id);
            // "Return all cards of the drawn card's color from your score pile"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',

                'color' => array(self::getAuxiliaryValue()),
            );
            break;

        // id 171, Artifacts age 6: Stamp Act
        case "171C1A":
            // "Transfer a card of value equal to the top yellow card on your board from your score pile to mine"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $launcher_id,
                'location_to' => 'score',

                'age' => self::getAuxiliaryValue()
            );
            break;

        case "171C1B":
            // "Return a card from your score pile of value equal to the top green card on your board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',

                'age' => self::getAuxiliaryValue()
            );
            break;

        // id 173, Artifacts age 6: Moonlight Sonata
        case "173N1A":
            // "Choose a color on your board having the highest top card"
            $max_age = self::getMaxAgeOnBoardTopCards($player_id);
            $color_array = array();
            for ($color = 0; $color < 5; $color++) {
                $top_card = self::getTopCardOnBoard($player_id, $color);
                if ($top_card !== null && $top_card['age'] == $max_age) {
                    $color_array[] = $color;
                }
            }
            
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'choose_color' => true,
                'color' =>  $color_array
            );
            break;
            
        case "173N1B":
            // "Claim an achievement ignoring eligibility"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => $player_id,
                'location_to' => 'achievements',

                'require_achievement_eligibility' => false
            );
            break;
            
        // id 174, Artifacts age 6: Marcha Real
        case "174N1A":
            // "Reveal and return two cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 2,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed,deck'
            );
            break;
    
        case "174N1B":
            // "Claim an achievement ignoring eligibility"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => $player_id,
                'location_to' => 'achievements',

                'require_achievement_eligibility' => false
            );
            break;

        // id 175, Artifacts age 7: Periodic Table
        case "175N1A":
            // "Choose two top cards on your board of the same value"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'none',

                'color' => self::getAuxiliaryValueAsArray(),
            );

            break;

        case "175N1B":
            // "Choose two top cards on your board of the same value"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'none',

                'not_id' => $this->innovationGameState->get('id_last_selected'),
                'age' => $this->innovationGameState->get('age_last_selected'),
            );
            break;

        // id 177, Artifacts age 7: Submarine H. L. Hunley
        case "177C1A":
            // "Return all cards of its color from your board"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'pile',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'color' => array(self::getAuxiliaryValue()),
             );
            break;
            
        // id 178, Artifacts age 7: Jedlik's Electromagnetic Self-Rotor
        case "178N1A":
            // "Claim an achievement of value 8 if it is available, ignoring eligibility"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => $player_id,
                'location_to' => 'achievements',

                'age' => 8,
                'require_achievement_eligibility' => false
            );
            break;            

        // id 179, Artifacts age 7: International Prototype Metre Bar
        case "179N1A":
            // "Choose a value"
            $options = array(
                'player_id' => $player_id,

                'choose_value' => true
            );
            break;

        // id 180, Artifacts age 7: Hansen Writing Ball
        case "180C1A":
            // "Meld a blue card"
            $options = array(
                'player_id' => $player_id,  
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',

                'color' => array(0),
            );
            break;

        // id 181, Artifacts age 7: Colt Paterson Revolver
        case "181C1A":
            // "Return all cards in your hand"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;            

        case "181C1B":
            // "Return all cards in your score pile"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;            

        // id 182, Artifacts age 7: Singer Model 27
        case "182N1A":
            // "Tuck a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                'bottom_to' => true
            );
            break;            

        case "182N1B":
            // "Tuck all cards from your score pile of that color"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $player_id,
                'location_to' => 'board',
                'bottom_to' => true,

                'color' => array($this->innovationGameState->get('color_last_selected'))
            );
            break;

        // id 183, Artifacts age 7: Roundhay Garden Scene
        case "183N1A":
            // "Meld the highest card from your score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'age' => self::getMaxAgeInScore($player_id),
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $player_id,
                'location_to' => 'board'
            );
            break;
            
        // id 184, Artifacts age 7: The Communist Manifesto
        case "184N1A":
            // Choose a player
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_player' => true,
                'players' => $this->innovationGameState->getAsArray('player_array')
            );
            break;

        case "184N1B":
            // "Transfer one of the drawn cards to each player's board"
            $player_choice = self::getAuxiliaryValue();            
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'revealed',
                'owner_to' => $player_choice,
                'location_to' => 'board'
            );
            break;
            
        // id 186, Artifacts age 8: Earhart's Lockheed Electra 10E'),
        case "186N1A":
            // "For each value below nine, return a top card of that value from your board, in descending order"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',

                'age' => $this->innovationGameState->get('age_last_selected') - 1,
                'not_id' => 188 // Battleship Yamato's face-up age is 11 (not 8), so it's never a valid selection
            );
            break;

        case "186N1B":
            // "Otherwise, claim an achievement, ignoring eligibility"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => $player_id,
                'location_to' => 'achievements',

                'require_achievement_eligibility' => false
            );
            break;
        
        // id 187, Artifacts age 8: Battleship Bismarck
        case "187C1A":
            // "Return all cards of the drawn color from your board"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'pile',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'color' => array(self::getAuxiliaryValue()),
            );
            break;
            
        // id 190, Artifacts age 8: Meiji-Mura Stamp Vending Machine
        case "190N1A":
            // "Return a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;

        // id 191, Artifacts age 8: Plush Beweglich Rod Bear
        case "191N1A":
            // "Choose a value"
            $selectable_ages = array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10);
            // The value 11 should only be an option when Battleship Yamato is a top card on the player's board or if
            // 4th edition is in use.
            $battleship_yamato = self::getCardInfo(188);
            if ($this->innovationGameState->usingFourthEditionRules() || (self::isTopBoardCard($battleship_yamato) && $battleship_yamato['owner'] === $player_id)) {
                $selectable_ages[] = 11;
            }
            
            $options = array(
                'player_id' => $player_id,

                'choose_value' => true,
                'age' => $selectable_ages
            );
            break;

        case "191N1B":
            // "Return all cards of that value from all score piles"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => 'any player',
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'age' => self::getAuxiliaryValue()
            );
            break;

        // id 192, Artifacts age 8: Time
        case "192C1A":
            // "Transfer a non-yellow top card with a clock from your board to my board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',
                
                'with_icon' => 6,
                'color' => array(0, 1, 2, 4)
            );
            break;

       // id 193, Artifacts age 8: Garland's Ruby Slippers
        case "193N1A":
            // "Meld an 8 from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'age' => 8
            );
            break;

        // id 194, Artifacts age 8: 30 World Cup Final Ball
        case "194C1A":
            // "I compel you to return one of your achievements"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'achievements',
                'owner_to' => 0,
                'location_to' => 'deck',

                'include_relics' => false,
            );
            break;

        // id 196, Artifacts age 9: Luna 3
        case "196N1A":
            // "Return all cards from your score pile"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;            

         // id 197, Artifacts age 9: United Nations Charter
         case "197C1A":
            // "Transfer all top cards on your board with a demand effect to my score pile"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'score',

                'has_demand_effect' => true,
            );
            break;

         // id 198, Artifacts age 9: Velcro Shoes
         case "198C1A":
            // "Transfer a 9 from your hand to my hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'hand',

                'age' => 9
            );
            break;

         case "198C1B":
            // "Transfer a 9 from your score pile to my score pile"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $launcher_id,
                'location_to' => 'score',

                'age' => 9
            );

            break;
            
        // id 199, Artifacts age 9: Philips Compact Cassette
        case "199N1A":
            // "Splay up two colors on your board"
            $options = array(
                'player_id' => $player_id,
                'n' => 2,
                
                'splay_direction' => 3
            );
            break;
            
        // id 200, Artifacts age 9: Syncom 3
        case "200N1A":
            // "Return all cards from your hand"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;

        // id 204, Artifacts age 9: Marilyn Diptych
        case "204N1A":
            // "You may score a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'score_keyword' => true
            );
            break;

        case "204N1B":
            // "You may transfer any card from your score pile to your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $player_id,
                'location_to' => 'hand'
            );
            break;
            
        // id 208, Artifacts age 10: Maldives
        case "208C1A":
            // "I compel you to return all cards in your hand but two"
            $num_cards_in_hand = count(self::getCardsInLocation($player_id, 'hand'));
            if ($num_cards_in_hand > 2) {
                $options = array(
                    'player_id' => $player_id,
                    'n' => $num_cards_in_hand - 2,
                    'can_pass' => false,
                        
                    'owner_from' => $player_id,
                    'location_from' => 'hand',
                    'owner_to' => 0,
                    'location_to' => 'deck'
                );
            }
            break;

        case "208C1B":
            // "Return all cards in your score pile but two"
            $num_cards_in_score_pile = count(self::getCardsInLocation($player_id, 'score'));
            if ($num_cards_in_score_pile > 2) {
                $options = array(
                    'player_id' => $player_id,
                    'n' => $num_cards_in_score_pile - 2,
                    'can_pass' => false,
                    
                    'owner_from' => $player_id,
                    'location_from' => 'score',
                    'owner_to' => 0,
                    'location_to' => 'deck'
                );
            }
            break;

        case "208N1A":
            // "Return all cards in your score pile but four"
            $num_cards = self::getAuxiliaryValue();
            $options = array(
                'player_id' => $player_id,
                'n' => $num_cards - 4,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;

        // id 211, Artifacts age 10: Dolly the Sheep
        case "211N1A":
            // "You may score your bottom yellow card"
            $bottom_yellow_card = self::getBottomCardOnBoard($player_id, 3);
            if ($bottom_yellow_card != null) {
                $options = array(
                    'player_id' => $player_id,
                    'can_pass' => false,
                    
                    'choose_yes_or_no' => true
                );
            }
            break;

        case "211N1B":
            // "You may draw and tuck a 1"
            $options = array(
                'player_id' => $player_id,
                
                'choose_yes_or_no' => true
            );
            break;    
            
        case "211N1C":
            // "Meld the highest card in your hand"
            if (count(self::getCardsInLocation($player_id, 'hand')) > 0) {
                $options = array(
                    'player_id' => $player_id,
                    'n' => 1,
                    'can_pass' => false,
                    
                    'owner_from' => $player_id,
                    'location_from' => 'hand',
                    'owner_to' => $player_id,
                    'location_to' => 'board',

                    'age' => self::getMaxAgeInHand($player_id)
                );
            }
            break;
        

       // id 214, Artifacts age 10: Twister
       case "214C1A":
        // "For each color, meld a card of that color from your score pile"
        $options = array(
            'player_id' => $player_id,
            'n' => 1,
            'can_pass' => false,
            
            'owner_from' => $player_id,
            'location_from' => 'score',
            'owner_to' => $player_id,
            'location_to' => 'board',

            'color' => self::getAuxiliaryValueAsArray()
        );
        break;

        // id 216, Relic age 4: Complex Numbers
        case "216N1A":
            // "You may reveal a card from your hand having exactly the same icons, in type and number, as a top card on your board"
            if ($this->innovationGameState->get('release_version') >= 2)  {
                $card_ids = array();
                $hand_cards = self::getCardsInLocation($player_id, 'hand');
                $top_cards = self::getTopCardsOnBoard($player_id);
                // Bonus icons and other special city icons are counted as per https://boardgamegeek.com/thread/1872362/article/40784224.
                foreach ($hand_cards as $card) {
                    $eligible = false;
                        
                    foreach ($top_cards as $top_card) {
                        $match_found = true;
                        if ($top_card !== null) {
                            // search icons are considered different than basic icons so they need to be handled separately
                            if ($card['spot_6'] !== null && $top_card['spot_6'] !== null && $card['spot_6'] != $top_card['spot_6']) {
                                $match_found = false; // If the search icons don't match
                                break;
                            }
                            for ($icon = 1; $icon <= 13; $icon++) { 
                                // Echo effects are not considered icons, so they are skipped
                                if ($icon == 10) {
                                    continue;
                                }
                                if (self::countIconsOnCard($card, $icon) != self::countIconsOnCard($top_card, $icon)) {
                                    $match_found = false; // If any icon counts mismatch, then the card isn't eligible
                                    break;
                                }
                            }
                            for ($icon = 101; $icon <= 111; $icon++) { // count bonus icons
                                if (self::countIconsOnCard($card, $icon) != self::countIconsOnCard($top_card, $icon)) {
                                    $match_found = false; // If any icon counts mismatch, then the card isn't eligible
                                    break;
                                }
                            }
                            if ($match_found) {
                                $eligible = true;
                            }
                        }
                    }
                    if ($eligible) {
                        $card_ids[] = $card['id'];
                    }
                    
                }
                self::setAuxiliaryArray($card_ids);
                
                $options = array(
                    'player_id' => $player_id,
                    'n' => 1,
                    'can_pass' => true,
                    
                    'owner_from' => $player_id,
                    'location_from' => 'hand',
                    'owner_to' => $player_id,
                    'location_to' => 'revealed',
                    
                    'card_ids_are_in_auxiliary_array' => true,
                    'enable_autoselection' => false,
                );
            } else {                
                $options = array(
                    'player_id' => $player_id,
                    'n' => 1,
                    'can_pass' => true,
                    
                    'owner_from' => $player_id,
                    'location_from' => 'hand',
                    'owner_to' => $player_id,
                    'location_to' => 'revealed'
                );
                $i = 1;
                foreach (self::getTopCardsOnBoard($player_id) as $top_card) {
                    $options += array('icon_hash_'.$i++ => $top_card['icon_hash']);
                }   
            }
            break;

        case "216N1B":
            // "Claim an achievement of matching value, ignoring eligibility"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => $player_id,
                'location_to' => 'achievements',

                'age' => $this->innovationGameState->get('age_last_selected'),
                'require_achievement_eligibility' => false
            );
            break;

        // id 217, Relic age 5: Newton-Wickins Telescope
        case "217N1A":
            // "You may return any number of cards from your score pile"
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;

        // id 219, Relic age 7: Safety Pin
        case "219D1A":
            // "I demand you return all cards of value higher than 6 from your hand!"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'age_min' => 7,
            );
            break;
            
        // id 331, Echoes age 1: Perfume
        case "331D1A":
            // "I demand you transfer a top card of different value from any top card on my board from your board to mine! "
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'color' => self::getAuxiliaryValueAsArray(),
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board'
            );
            break;

        // id 333, Echoes age 1: Bangle
        case "333E1A":
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                'bottom_to' => true,
                
                'color' => array(1),
            );
            break;
        
        // 334, Echoes age 1: Candles
        case "334D1A":
            // "you transfer a card with a tower from your hand to my hand!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'hand',
                
                'with_icon' => 4, /* tower */
            );
            break;

        // id 335, Echoes age 1: Plumbing
        case "335E1A":
            // "Score a bottom card from your board."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'score_keyword' => true,

                'bottom_from' => true,
            );            
            break;

        // id 336, Echoes age 1: Comb
        case "336N1A":
            // "Choose a color"
            $options = array(
                'player_id' => $player_id,

                'choose_color' => true,
            );
            break;
            
        case "336N1B":
            // "Return the rest of the drawn cards"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'revealed',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;
                
        // id 337, Echoes age 1: Ice skates
        case "337N1A":
            // "Return up to three cards from your hand."
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'n_max' => 3,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;
        
        case "337N1B":
            // "draw and meld a 2, or draw and foreshadow a 3"
            $options = array(
                'player_id' => $player_id, 

                'choose_yes_or_no' => true
            );
            break;

        case "337N1C":
            // "Return your highest top card."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'age' => self::getMaxAgeOnBoardTopCards($player_id),
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck'
            );
            break;

        // id 338, Echoes age 1: Umbrella
        case "338N1A":
            // "Return any number of cards from your hand."
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        case "338N1B":
            // "Score two cards from your hand for every card you returned."
            $options = array(
                'player_id' => $player_id,
                'n' => self::getAuxiliaryValue() * 2,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'score_keyword' => true,
            );
            break;

        case "338E1A":
            // "You may meld a card from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
            );
            break;

        // id 339, Echoes age 1: Chopsticks
        case "339N1A":
            // "you may transfer its bottom card to the available achievements."
            $options = array(
                'player_id' => $player_id, 
                
                'choose_yes_or_no' => true,
            );

        // id 341, Echoes age 1: Soap
        case "341N1A":
            // "Choose a color"
            $options = array(
                'player_id' => $player_id,

                'choose_color' => true,
            );
            break;

        case "341N1B":
            // "You may tuck any number of cards of that color from your hand."
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'can_pass' => true,
                
                'color' => array(self::getAuxiliaryValue()),
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'bottom_to' => true,
            );
            break;
        
        case "341N1C":
            // "you may achieve (if eligible) a card from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'achievements',

                'require_achievement_eligibility' => true,
            );
            break;
            
        // id 342, Echoes age 1: Bell
        case "342E1A":
            // "You may score a card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'score_keyword' => true,
            );            
            break;

        // id 343, Echoes age 1: Flute
        case "343E1A":
            // "You may splay any one color of your cards"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 1 /* left */
            );
            break;

        case "343D1A":
            // "I demand you return a card with a bonus from your hand!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'with_bonus' => true,
            );            
            break;

        // id 345, age 2: Lever          
        case "345N1A":
            // "You may return any number of cards from your hand"
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        case "345N1B":
            $ages_to_draw = self::getAuxiliaryArray();
            $age_array = array();
            for ($age = 1; $age <= 11; $age++) { // It's possible to draw an 11
                if ($ages_to_draw[$age - 1] > 0) {
                    $age_array[] = $age;
                }
            }
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
                'age' => $age_array,
            );
            break;
            
        // id 346, age 2: Linguistics          
        case "346N1A":
            // "Draw a card of value equal to a bonus on your board, if you have any."
            $selectable_ages = array_unique(self::getVisibleBonusesOnBoard($player_id));
            $options = array(
                'player_id' => $player_id,

                'choose_value' => true,
                'age' => $selectable_ages,
            );
            break;

        case "346E1A":
            // "Draw a 3 OR Draw and foreshadow a 4."
            $options = array(
                'player_id' => $player_id, 
                
                'choose_yes_or_no' => true,
            );
            break;

        // id 347, Echoes age 2: Crossbow
        case "347D1A":
            // "I demand you transfer a card with a bonus from your hand to my score pile!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'score',

                'with_bonus' => true,
            );       
            break;

        case "347N1A":
            // Choose a player for the transfer
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'choose_player' => true,
                'players' => self::getOtherActivePlayers($player_id),
            );
            break;

        case "347N1B":
            // "Transfer a card from your hand to any other player's board."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => self::getAuxiliaryValue(),
                'location_to' => 'board',
            );       
            break;

        // id 348, Echoes age 2: Horseshoes
        case "348D1A":
            // "I demand you transfer a top card without a tower or factory from your board to my board!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'color' => self::getAuxiliaryValueAsArray(),
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',
            );
            break;

        // id 349, Echoes age 2: Glassblowing
        case "349E1A":
            // "Score a card with a bonus from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'score_keyword' => true,

                'with_bonus' => true,
            );       
            break;

        // id 350, Echoes age 2: Scissors
        case "350E1A":
            // "Take a bottom card from your board into your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'hand',

                'bottom_from' => true,
            );       
            break;

        case "350N1A":
            // "You may choose up to two cards from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'none',
            );       
            break;

        case "350N1B":
            // "For each card chosen, either meld it or score it."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'choose_yes_or_no' => true,
            );
            break;

        case "350N1C":
            // "You may choose up to two cards from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'none',
            );       
            break;

        case "350N1D":
            // "For each card chosen, either meld it or score it."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'choose_yes_or_no' => true,
            );
            break;
            
        // id 351, age 2: Toothbrush          
        case "351E1A":
            // Choose value to tuck.           
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
                'age' => self::getAuxiliaryValueAsArray(),
            );
            break;
            
        case "351E1B":
            // "Tuck all cards of one present value from your hand."
            $options = array(
                'player_id' => $player_id,
                
                'age' => self::getAuxiliaryValue(),
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'bottom_to' => true,
            );
            break;
            
        case "351N1A":
            // "You may splay any one color of your cards left."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'splay_direction' => 1 /* left */
            );
            break;
            
        case "351N2A":
            // "you may transfer its bottom card to the available achievements."
            $options = array(
                'player_id' => $player_id, 
                
                'choose_yes_or_no' => true,
            );
            break;
            
        // id 352, Echoes age 2: Watermill
        case "352N1A":
            // "Tuck a card with a bonus from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',

                'bottom_to' => true,

                'with_bonus' => true,
            );            
            break;

        case "352N1B":
            // "you may return a card from your hand to repeat this dogma effect."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
                );
            break;

        // id 353 Echoes age 2: Pagoda
        case "353N1A":
            // "tuck the card from your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                         
                'color' => array(self::getAuxiliaryValue()),
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'bottom_to' => true,
            );            
            break;

        // id 354, Echoes age 2: Chaturanga
        case "354N1A":
            // "Meld a card with a bonus from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',

                'with_bonus' => true,
            );            
            break;

        // id 355, Echoes age 3: Almanac
        case "355N1A":
            // "You may return a card from your forecast with a bonus."
            // First reveal the card to prove that it has a bonus.
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'forecast',
                'owner_to' => $player_id,
                'location_to' => 'revealed,deck',

                'with_bonus' => true,
            );
            break;

        // id 356, Echoes age 3: Magnifying Glass
        case "356E1A":
            // "then return a card from your hand."
             $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        case "356N1A":
            // "You may return three cards of equal value from your hand."
            // First, select the value to return.
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'choose_value' => true,
                'age' => self::getAuxiliaryValueAsArray(),
            );
            break;

        case "356N1B":
            // "You may return three cards of equal value from your hand."
            // Second, return the cards of the selected value.
            $options = array(
                'player_id' => $player_id,
                'n' => 3,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',

                'age' => self::getAuxiliaryValue(), // return cards of age chosen
            );
            break;

        case "356N2A":
            // "You may splay your yellow or blue cards left."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 1 /* left */,
                'color' => array(0,3) /* blue or yellow */
            );
            break;

        // id 358, Echoes age 3: Katana
        case "358D1A":
        case "358D1B":
            // "I demand you transfer two top cards with a tower from your board to my score pile!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'score',

                'with_icon' => 4, /* tower */
            );
            break;

        // id 359, Echoes age 3: Charitable Trust
        case "359E1A":
            // "Draw a 3 or 4."
            $options = array(
                'player_id' => $player_id, 

                'choose_yes_or_no' => true,
            );
            break;

        case "359N1A":
            // "You may meld the card you drew due to Charitable Trust's echo effect."
            $options = array(
                'player_id' => $player_id,                
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',

                'card_id_1' => self::getIndexedAuxiliaryValue($player_id),
            );
            // Special case if Charitable Trust was endorsed
            if ($options['card_id_1'] >= 1000) {
                $encoded_card_ids = $options['card_id_1'];
                $options['card_id_1'] = $encoded_card_ids % 1000;
                $options['card_id_2'] = (($encoded_card_ids - $options['card_id_1']) / 1000) - 1;
            }
            break;

        case "359N1B":
            // "either return or achieve (if eligible) your top green card."
            $options = array(
                'player_id' => $player_id, 

                'choose_yes_or_no' => true,
            );
            break;

        // id 360, Echoes age 3: Homing Pigeons
        case "360D1A":
            // "I demand you return two cards from your score pile whose values each match at least one card in my hand!"
            $options = array(
                'player_id' => $player_id,                
                'n' => 2,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',

                'card_ids_are_in_auxiliary_array' => true,
            );
            break;

        case "360N1A":
            // "You may splay your red or green cards left."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 1 /* left */,
                'color' => array(1,2) /* blue or yellow */
            );
            break;

        // id 362, Echoes age 3: Sandpaper
        case "362N1A":
            // "You may return any number of cards from your hand."
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        case "362N1B":
            // "meld a card from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
            );
            break;

        // id 363, Echoes age 3: Novel
        case "363N1A":
            // "You may splay your purple cards left."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 1 /* left */,
                'color' => array(4) /* purple */
            );
            break;

        // id 364, Echoes age 3: Sunglasses
        case "364E1A":
            // "Score a card from your hand of a color you have splayed."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'color' => self::getAuxiliaryValueAsArray(),
                
                'score_keyword' => true,
            );
            break;

        case "364N1A":
            // "You may either splay your purple cards in the 
            // direction one of your other cards is splayed, or 
            // you may splay one of your other colors in the direction 
            // that your purple cards are splayed."
            $options = array(
                'player_id' => $player_id,
                'can_pass' => true, 

                'choose_yes_or_no' => true,
            );
            break;

        case "364N1B":
            // Choose a color for purple to match
            $options = array(
                'player_id' => $player_id, 

                'choose_color' => true,
                'color' => self::getAuxiliaryValue2AsArray(),
            );
            break;

        case "364N1C":
            // Choose a color to match purple's splay
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'splay_direction' => self::getCurrentSplayDirection($player_id, 4),
                'color' => self::getAuxiliaryValue2AsArray(), // non-purple
            );
            break;

        // id 365, Echoes age 4: Slide Rule
        case "365N1A":
            // "You may splay your yellow cards right."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 2 /* right */,
                'color' => array(3) /* yellow */
            );
            break;
            
        // id 366, Echoes age 4: Telescope
        case "366N1A":
            // "You may place a card from your forecast on top of its deck."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'forecast',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'bottom_to' => false, // put on top
            );
            break;

        case "366N1B":
            // "achieve a card from your forecast if you meet the requirements to do so."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'forecast',
                'owner_to' => $player_id,
                'location_to' => 'achievements',
                
                'require_achievement_eligibility' => true,
            );
            break;

        // id 367, Echoes age 4: Kobukson
        case "367E1A":
            // "Splay left one color on any player's board."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => 'any player',
                'location_from' => 'board',
                'location_to' => 'none',
            );
            break;

        case "367D1A":
            // "I demand you you return all your top cards with a tower"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',

                'with_icon' => 4, /* tower */
            );
            break;

        // id 368, Echoes age 4: Shuriken
        case "368D1A":
            // "I demand you transfer a top non-red card with a tower or bulb from your board to my board!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',

                'color' => self::getAuxiliaryValueAsArray(), 
            );
            break;

        case "368N1A":
            // "You may splay your purple cards right."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 2 /* right */,
                'color' => array(4) /* purple */
            );
            break;

        // id 370, Echoes age 4: Globe
        case "370N1A":
            // Choose color to return
            $options = array(
                'player_id' => $player_id,
                'can_pass' => true,

                'choose_color' => true,
                'color' => self::getAuxiliaryValueAsArray(),
            );
            break;

        case "370N1B": 
             $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'n_max' => 3,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed,deck',

                'color' => array(self::getAuxiliaryValue()), 
            );
            break;

        case "370N1C":
            // "If you return one, splay any color left; two, right; three, up."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'splay_direction' => self::getAuxiliaryValue(),
                'color' => array(0,1,2,3,4) /* any color */
            );
            break;

        // id 371, Echoes age 4: Barometer
        case "371E1A":
            // "Transfer a 5 from your forecast to your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'forecast',
                'owner_to' => $player_id,
                'location_to' => 'hand',

                'age' => 5, 
            );
            break;

        case "371N1A":
            // "Draw and foreshadow a card of value two higher than a bonus on any board."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'choose_value' => true,
                'age' => self::getAuxiliaryValueAsArray(),
            );
            break;

        case "371N2A":
            // "You may reveal and return all cards in your forecast."
            $options = array(
                'player_id' => $player_id,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'forecast',
                'owner_to' => $player_id,
                'location_to' => 'revealed,deck',                
            );
            break;   

        // id 372, Echoes age 4: Pencil
        case "372N1A":
            // "You may return up to three cards from your hand."
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'n_max' => 3,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );            
            break;

        case "372N1B":
            // "Foreshadow one of them"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'forecast',
                
                'card_id_1' => $card_id_1,
                'card_id_2' => $card_id_2,
                'card_id_3' => $card_id_3,
            );
            
            break;

        case "372N1C":
            // "return the rest of the drawn cards."
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'card_id_1' => $card_id_1,
                'card_id_2' => $card_id_2,
                'card_id_3' => $card_id_3,
            );
            break;         
            
        // id 373, Echoes age 4: Clock
        case "373E1A":
            // "You may splay your color with the most cards right"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 2,
                'color' => self::getAuxiliaryValueAsArray(),
            );
            break;

        case "373D1A":
            // "I demand you draw and reveal three 10s, total the number of clocks on them, and then return them!"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'revealed',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        // id 374, Echoes age 4: Toilet            
        case "374D1A":
            // "I demand you return all cards from your score pile of value matching the highest bonus on my board!"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'age' => self::getAuxiliaryValue(),
            );
            break;

        case "374N1A":
            // "'You may return a card in your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        // id 375, Echoes age 5: Lightning Rod
        case "375N1A":
            // "You may return a top card from your board."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        // id 378, Echoes age 5: Octant
        case "378D1A":
            // "I demand you transfer a top non-red card with a tower or bulb from your board to my board!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',

                'color' => self::getAuxiliaryValueAsArray(), 
            );
            break;

        // id 379, Echoes age 5: Palampore
        case "379N1A":
            // "Draw and score a card of value equal to a bonus that occurs more than once on your board, if you have such a bonus."
            // TODO(https://github.com/micahstairs/bga.innovationkahlia/issues/472): This needs to have the "choose_draw_value" when
            // that is implemented since 11s can appear as bonuses
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'choose_value' => true,
                'age' => self::getAuxiliaryValueAsArray(),
            );
            break;

        case "379N2A":
            // "You may splay your purple cards right."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 2 /* right */,
                'color' => array(4) /* purple */
            );
            break;

        // id 380, Echoes age 5: Seed Drill
        case "380D1A":
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',

                'color' => self::getAuxiliaryValueAsArray(), 
            );
            break;

        case "380N1A":
            // "Choose the 3, 4, or 5 deck."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
                'age' => array(3,4,5),
            );
            break;

        case "380N1B":
            // "you may transfer its bottom card to the available achievements."
            $options = array(
                'player_id' => $player_id, 
                
                'choose_yes_or_no' => true,
            );
            break;

        // id 381, Echoes age 5: Pressure Cooker
        case "381N1A":
            // "Return all cards from your hand."
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        case "381N1B":
            // "For each top card on your board with a bonus, draw a card of value equal to that bonus"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
                'age' => array_unique(Arrays::getBase16ArrayFromValue(self::getAuxiliaryValue())),
            );
            break;

        // id 382, Echoes age 5: Stove
        case "382E1A":
            // "Score a top card from your board without a factory."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'score_keyword' => true,
                
                'without_icon' => 5, /* factory */
            );
            break;

        case "382N2A":
            // "You may splay your green cards right."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 2 /* right */,
                'color' => array(2) /* green */
            );
            break;

        // id 383, Echoes age 5: Piano
        case "383E1A":
            // "Draw a card of a value present in any player's hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
                'age' => self::getAuxiliaryValueAsArray(),
            );
            break;

        case "383N1A":
            // "If you have five top cards, each with a different value, return five cards from your score pile "
            $options = array(
                'player_id' => $player_id,
                'n' => 5,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        // id 384, Echoes age 5: Tuning Fork
        case "384E1A":
            // "Look at the top card of any deck,"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => 0,
                'location_from' => 'deck',
                'owner_to' => $player_id,
                'location_to' => 'hand',

                'card_ids_are_in_auxiliary_array' => true,
            );
            break;
            
        case "384E1B":
            // "then place it back on top."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'enable_autoselection' => false, // Give the player the chance to read the card
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',

                'bottom_to' => false, // Topdeck
                
                'card_id_1' => $this->innovationGameState->get('card_id_1'),
            );       
            break;

        case "384N1A":
            // "Return a card from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        case "384N1B":
            // "You may repeat this dogma effect."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;
            
        // id 385, Echoes age 6: Bifocals
        case "385E1A":
            // "Draw and foreshadow a card of any value."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
            );
            break;

        case "385N1A":
            // "You may return a card from your forecast. "
           $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'forecast',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        case "385N2A":
            // "You may splay your green cards right."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 2 /* right */,
                'color' => array(2) /* green */
            );
            break;

        // id 386, Echoes age 6: Stethoscope
        case "386E1A":
            // "Meld a blue or yellow card from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'color' => array(0,3), /* blue or yellow */
            );
            break;

        case "386N2A":
            // "You may splay your yellow cards right."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 2 /* right */,
                'color' => array(3) /* yellow */
            );
            break;
        
        // id 389 Echoes age 6: Hot Air Balloon
        case "389N1A":
            // "You may achieve (if eligible) a top card from any player's board if they have an achievement of matching value."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => 'any player',
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'achievements',

                'card_ids_are_in_auxiliary_array' => true,
                
                'require_achievement_eligibility' => true,
            );
            break;

        // id 387 Echoes age 6: Loom
        case "387E1A":
            // "Score your lowest top card."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'score_keyword' => true,
                
                'age' => self::getMinAgeOnBoardTopCards($player_id),
            );
            break;

        case "387N1A":
            // "You may return two cards of different value from your score pile."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        case "387N1B":
            // "You may return two cards of different value from your score pile."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',

                'card_ids_are_in_auxiliary_array' => true,
            );
            break;
            
        // id 390 Echoes age 6: Steamboat
        case "390D1A":
            // "transfer two cards from your score pile to mine!"
            $options = array(
                'player_id' => $player_id,
                'n' => 2,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
            );
            break;

        // id 391 Echoes age 6: Dentures
        case "391N2A":
            // "You may splay your blue cards right."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 2 /* right */,
                'color' => array(0) /* blue */
            );
            break;

        // id 392 Echoes age 6: Morphine
        case "392E1A":
            // "Score an odd-valued card from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'score_keyword' => true,

                'card_ids_are_in_auxiliary_array' => true,
            );
            break;

        case "392D1A":
            // "I demand you return all odd-valued cards in your hand!"
            $options = array(
                'player_id' => $player_id,
                'n' => count(self::getAuxiliaryArray()),

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',

                'card_ids_are_in_auxiliary_array' => true,
            );
            break;
            
        case "392N2A":
            // "You may splay your red cards right."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 2 /* right */,
                'color' => array(1), /* red */
            );
            break;
            
        // id 393, Echoes age 6: Indian Clubs
        case "393D1A":
            // "I demand you return two cards from your score pile!"
            $options = array(
                'player_id' => $player_id,
                'n' => 2,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        case "393N1A":
            // "For every value of card you have in your score pile, score a card from your hand of that value."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'score_keyword' => true,
                
                'age' => self::getAuxiliaryValue(),
            );
            break;
            
        // id 394 Echoes age 6: Kaleidoscope
        case "394N1A":
            // "You may splay your cards of that color right."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 2 /* right */,
                'color' => array(self::getAuxiliaryValue()),
            );
            break;

        // id 395 Echoes age 7: Photography
        case "395E1A":
            // "Meld a card from your forecast."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'forecast',
                'owner_to' => $player_id,
                'location_to' => 'board',
            );
            break;

        case "395D1A":
            // "I demand you take the highest top card from your board into your hand!"
            // TODO(ECHOES): Test that this behaves correctly with Battleship Yamato.
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'hand',
                
                'age' => self::getMaxAgeOnBoardTopCards($player_id),
            );
            break;

        // id 396 Echoes age 7: Typewriter
        case "396N1A":
            // "Return all cards from your hand."
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed,deck',
            );
            break;

        // id 397 Echoes age 7: Machine Gun
        case "397D1A":
            // "I demand you transfer all of your top cards with a bonus to my score pile!"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'with_bonus' => true,
            );
            break;

        case "397N1A":
            // "Return all your top non-red cards."
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'color' => array(0,2,3,4),
            );
            break;
        
        // id 398 Echoes age 7: Rubber
        case "398N1A":
            // "Score a top card from your board without a bonus."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'without_bonus' => true,
                
                'score_keyword' => true,
            );
            break;
        
        case "398N2A":
            // "You may splay your red cards up."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 3 /* up */,
                'color' => array(1) /* red */
            );
            break;

        // id 399 Echoes age 7: Jeans
        case "399E1A":
            // "Return one, "
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'card_id_1' => $card_id_1,
                'card_id_2' => $card_id_2,
            );
            break;

        case "399N1A":
            // "Choose two different values less than ${age_7}."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
                'age' => array(1,2,3,4,5,6),
            );
            break;

        case "399N1B":
            // "Choose two different values less than ${age_7}."
            // Get the second value which is different from the first
            $age_list = array_diff(array(1,2,3,4,5,6), array(self::getAuxiliaryValue())); 
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
                'age' => $age_list, 
            );
            break;

        case "399N1C":
            // "Meld one, "
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'revealed',
                'owner_to' => $player_id,
                'location_to' => 'board',
            );
            break;

        case "399N1D":
            // "and return the other."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'revealed',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        // id 400, Echoes age 7: Telegraph
        case "400N1A":
            // "You may choose an opponent"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'choose_player' => true,
                'players' => self::getActiveOpponents($player_id),
            );
            break;

        case "400N1B":
            // "and a color."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'choose_color' => true,
            );
            break;

        case "400N2A":
            // "You may splay your blue cards up."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 3 /* up */,
                'color' => array(0) /* blue */
            );
            break;

        // id 401, Echoes age 7: Elevator
        case "401E1A":
            // "Score your top or bottom green card."
            $options = array(
                'player_id' => $player_id,
                
                'choose_yes_or_no' => true
            );
            break;
            
        case "401N1A":
            // "Choose a value present in your score pile."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
                'age' => self::getAuxiliaryValueAsArray(),
            );
            break;

        case "401N1B":
            // "Choose to transfer all cards of the chosen value from either all other players' hands or all their score piles to your score pile."
            $options = array(
                'player_id' => $player_id,
                
                'choose_yes_or_no' => true
            );
            break;
        
        // id 402, Echoes age 7: Fertilizer
        case "402N1A":
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;            

        case "402N2A":
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
            );
            break;        

        // id 403, Echoes age 7: Ice Cream
        case "403E1A":
            // "Score a non-purple top card from your board without a bonus."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'without_bonus' => true,
                
                'color' => array(0,1,2,3),
                
                'score_keyword' => true,
            );
            break;         

        case "403N1A":
            // "Choose the 6, 7, 8, or 9 deck."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
                'age' => array(6,7,8,9),
            );
            break;

        case "403N1B":
            // "you may transfer its bottom card to the available achievements."
            $options = array(
                'player_id' => $player_id, 
                
                'choose_yes_or_no' => true,
            );
            break;
            
        // id 404, Echoes age 7: Saxophone
        case "404N1A":
            // "You may splay your purple cards up."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 3 /* up */,
                'color' => array(4) /* purple */
            );
            break;  

        // id 405 Echoes age 8: Radio Telescope
        case "405N1A":
            // "Meld one of the cards drawn."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',

                'card_ids_are_in_auxiliary_array' => true,
            );
            break;

        case "405N1B":
            // "and return the rest"
            $options = array(
                'player_id' => $player_id,
                'n' => count(self::getAuxiliaryArray()),

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',

                'card_ids_are_in_auxiliary_array' => true,
            );
            break;

        // id 406, Echoes age 8: X-Ray
        case "406N1A":
            // "draw and foreshadow a card of any value."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
            );
            break;

        case "406N2A":
            // "You may splay your yellow cards up."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 3 /* up */,
                'color' => array(3) /* yellow */
            );
            break; 

        // id 407, Echoes age 8: Bandage
        case "407E1A":
            // "Meld a card from hand with a leaf"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'with_icon' => 2, /* leaf */
            );
            break;

        case "407D1A":
            // "I demand you return the highest card in your score pile 
            // for which you do not have a card of matching value in your hand!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'age' => self::getAuxiliaryValue(),
            );
            break;

        case "407D1B":
            // "Return a top card from your board with a clock!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'with_icon' => 6,
            );
            break;

        // id 409, Echoes age 8: Nylon
        case "409N2A":
            // "You may splay your red cards up."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 3 /* up */,
                'color' => array(1) /* red */
            );
            break; 

        // id 410, Echoes age 8: Sliced Bread
        case "410E1A":
            // "Return all cards from your hand"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;         

        case "410N1A":
            // "Return a card from your score pile."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;     
            
        // id 411, Echoes age 8: Air Conditioner
        case "411E1A":
            // "You may score a card from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'score_keyword' => true,
            );
            break;

        case "411D1A":
            // "I demand you return all cards from your score pile of value matching any of your top cards!"
            $options = array(
                'player_id' => $player_id,
                'n' => count(self::getAuxiliaryArray()),

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',

                'card_ids_are_in_auxiliary_array' => true,
            );
            break;

        // id 413, Echoes age 8: Crossword
        case "413N1A":
            // "For each visible bonus on your board, draw a card of that value."
            $age_counts = self::getAuxiliaryArray();
            $age_choices = array();
            for ($age = 1; $age <= 11; $age++) {
                if ($age_counts[$age] > 0) {
                    $age_choices[] = $age;
                }
            }

            // Guaranteed that if we are in this state, we have at least 2+ ages 
            // to choose from; otherwise: would have drawn in A, or not looped back around
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'choose_value' => true,
                'age' => $age_choices,
            );
            break;
            
        // id 414, Echoes age 8: Television
        case "414N1A":
            // "Choose a value "
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
            );
            break;  
            
        case "414N1B":
            // "and an opponent."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_player' => true,
                'players' => self::getActiveOpponents($player_id),
            );
            break;

        case "414N1C":
            // "Transfer a card of that value from their score pile to their board."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => self::getAuxiliaryValue2(),
                'location_from' => 'score',
                'owner_to' => self::getAuxiliaryValue2(),
                'location_to' => 'board',
                
                'age' => self::getAuxiliaryValue(),
            );
            break;

        case "414N1D":
            // "If they have an achievement of the same value, achieve (if eligible) 
            // a card of that value from their score pile."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => self::getAuxiliaryValue2(),
                'location_from' => 'score',
                'owner_to' => $player_id,
                'location_to' => 'achievements',
                
                'age' => self::getAuxiliaryValue(),
                
                'require_achievement_eligibility' => true,
            );
            break;

        // id 415, Echoes age 9: Calculator
        case "415N1A":
            // "Score two bottom non-blue cards from your board."
            $options = array(
                'player_id' => $player_id,
                'n' => 2,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'score_keyword' => true,

                'bottom_from' => true,
                
                'color' => array(1, 2, 3, 4), // non-blue
            );
            break; 

       case "415N1B":
            // "and repeat this dogma effect (once only)."
            $options = array(
                'player_id' => $player_id,
                'n' => 2,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'score_keyword' => true,

                'bottom_from' => true,
                
                'color' => array(1, 2, 3, 4), // non-blue
            );
            break; 

        case "415N2A":
            // "You may splay your blue cards up."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 3, // up
                'color' => array(0), // blue
            );
            break; 
            
        // id 416, Echoes age 9: Laser
        case "416N1A":
            // "Return all unclaimed standard achievements."
            $options = array(
                'player_id' => $player_id,

                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => 0,
                'location_to' => 'deck',                
            );
            break;
            
        case "416N1B":
            // "Then, return half (rounded up) of the cards in your score pile."
            $options = array(
                'player_id' => $player_id,
                'n' => ceil(self::countCardsInLocation($player_id, 'score') / 2),

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',                
            );
            break;

        // id 417, Echoes age 9: Helicopter
        case "417N1A":
            // "Transfer a top card other than Helicopter from any player's board to its owner's score pile."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => 'any player',
                'location_from' => 'board',
                'location_to' => 'none',
                
                'not_id' => 417, // Helicopter
            );
            break;

        case "417N1B":
            // "You may return a card from your hand which shares an icon with the transferred card."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'card_ids_are_in_auxiliary_array' => true,
                'enable_autoselection' => false,
            );
            break;
            
        // id 418, Echoes age 9: Jet
        case "418E1A":
            // "Meld a card from your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
            );
            break;

        case "418D1A":
            // "I demand you return your top card of the color I melded due to Jet's echo effect!"
            $colors = self::getAuxiliaryArray();
            $last_returned_color = self::getIndexedAuxiliaryValue($player_id);
            if ($last_returned_color >= 0) {
                if (count($colors) == 2 && $colors[0] == $colors[1]) {
                    $colors = array($colors[0]);
                } else {
                    $colors = array_diff($colors, array($last_returned_color));
                }
            }
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',

                'color' => array_unique($colors),
            );
            break;
        
        // id 419, Echoes age 9: Credit Card
        case "419N1A":
            // "You may take a top non-green card from your board into your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'hand',
                
                'color' => array(0,1,3,4),
            );
            break;

        case "419N2A":
            // "You may splay your green cards up."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 3, // up
                'color' => array(2), // green
            );
            break; 

        // id 420, Echoes age 9: Email
        case "420N2A":
            // "Execute all non-demand dogma effects on your lowest non-green top card. Do not share them."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'none',
                
                'age' => self::getAuxiliaryValue(), // lowest age
                
                'color' => array(0,1,3,4), // non-green
            );
            break;

        // id 421, Echoes age 9: ATM
        case "421E1A":
            // "Draw and score a card of any value."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
            );
            break;

        case "421D1A":
            // "I demand you transfer the highest top non-yellow card without a crown from your board to my board!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',
                
                'age' => self::getMaxAgeOnBoardOfColorsWithoutIcon($player_id, array(0,1,2,4), 1), // no crown
                
                'color' => array(0,1,2,4), // non-yellow
            );
            break;
            
        case "421N1A":
            // "You may splay your purple cards up."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 3, // up
                'color' => array(4), // purple
            );
            break; 

        // id 422, Echoes age 9: Wristwatch
        case "422E1A":
            // "Take a non-yellow top card from your board and tuck it."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'bottom_to' => true,
                
                'color' => array(0,1,2,4), // non-yellow
            );
            break;

        // id 423, Echoes age 9: Karaoke
        case "423E1A":
            // "Draw and meld a card of value less than 10."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
                'age' => array(1,2,3,4,5,6,7,8,9),
            );
            break;

        case "423N1A":
            // If two cards were melded due to the Endorse action, let the player choose which gets executed
            $options = array(
                'player_id' => $player_id,
                'choose_yes_or_no' => true,
            );
            break;
        
        case "423N2A":
            // "You may take a bottom card from your board into your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'hand',
                
                'bottom_from' => true,
             );
            break;

        // id 424, Echoes age 9: Rock
        case "424D1A":
            // "I demand you transfer your top green card to my hand!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'hand',
                
                'color' => array(2), // green
             );
            break;

        case "424N1A":
            // "You may score a top card from your board."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'score_keyword' => true,
             );
            break;
        
        // id 425, Echoes age 10: Artificial Heart
        case "425N1A":
            // "Claim one standard achievement, if eligible. Your current score is doubled for the purpose of checking eligibility."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => $player_id,
                'location_to' => 'achievements',
                
                'card_ids_are_in_auxiliary_array' => true,
            );
            break;

        // id 426, Echoes age 10: Human Genome
        case "426N1A":
            // "You may draw and score a card of any value."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,
                
                'choose_value' => true,
            );
            break;

        case "426N1B":
            // "Take a bottom card from your board into your hand."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'hand',

                'bottom_from' => true,
            );       
            break;
            
        // id 427, Echoes age 10: Camcorder
        case "427D1A":
            // "I demand you transfer all cards in your hand to my hand!"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $launcher_id,
                'location_to' => 'hand',
             );
            break;

        case "427N1A":
            // "Meld all 9s from your hand."
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'age' => 9,
             );
            break;

        case "427N1B":
            // "Return all other cards from your hand."
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
             );
            break;

        // id 428, Echoes age 10: Social Networking
        case "428D1A":
            // "I demand you choose an icon type!"
            $options = array(
                'player_id' => $player_id,

                'choose_icon_type' => true,
             );
            break;

        case "428D1B":
            // "Transfer all top cards without that icon from your board to my score pile!"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'without_icon' => self::getAuxiliaryValue(),
             );
            break;

        // id 429, Echoes age 10: GPS
        case "429D1A":
            // "I demand you return all cards from your forecast!"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'forecast',
                'owner_to' => 0,
                'location_to' => 'deck',
             );
            break;

        case "429N2A":
            // "You may splay your yellow cards up."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 3, // up
                'color' => array(3), // yellow
            );
            break; 

        // id 430, Echoes age 10: Flash Drive
        case "430D1A":
            // "I demand you return four cards from your score pile!"
            $options = array(
                'player_id' => $player_id,
                'n' => 4,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
             );
            break;

        case "430N1A":
            // "Return a card from your score pile."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',
             );
            break; 
            
        case "430N1B":
            // "you may splay any one color of your cards up."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 3, // up
                'color' => array(0,1,2,3,4), // any color
            );
            break; 

        // id 431, Echoes age 10: Cell Phone
        case "431N2A":
            // "You may splay your green cards up."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'splay_direction' => 3, // up
                'color' => array(2), // green
            );
            break; 

        case "431N3A":
            // "You may tuck any number of cards with a clock from your hand"
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'board',
                
                'with_icon' => 6, /* clock */
                
                'bottom_to' => true,
             );
            break; 

        // id 432, Echoes age 10: MP3
        case "432N1A":
            // "Return any number of cards from your hand."
            $options = array(
                'player_id' => $player_id,
                'n_min' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',
             );
            break;

        case "432N1B":
            // "For each card returned, claim two standard achievements for which you are eligible."
            $options = array(
                'player_id' => $player_id,
                'n' => self::getAuxiliaryValue(),

                'owner_from' => 0,
                'location_from' => 'achievements',
                'owner_to' => $player_id,
                'location_to' => 'achievements',
                
                'require_achievement_eligibility' => true,
             );
            break;

        case "432N2A":
            // "Draw and score a card of value equal to a bonus on your board."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'choose_value' => true,
                'age' => self::getAuxiliaryValueAsArray(),
             );
            break;

        // id 433, Echoes age 10: Puzzle Cube
        case "433N1A":
            // "You may score the bottom card or two bottom cards of one color from your board."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'bottom_from' => true,
                
                'score_keyword' => true,
            );       
            break;

        case "433N1B":
            // "You may score the bottom card or two bottom cards of one color from your board."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                'can_pass' => true,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',
                
                'bottom_from' => true,
                
                'score_keyword' => true,
                
                'color' => array($this->innovationGameState->get('color_last_selected')),
            );       
            break;
            
        // id 434, Echoes age 10: Sudoku
        case "434N1A":
            // "Draw and meld a card of any value."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'choose_value' => true,
            );
            break;

        // id 440, age 11: Climatology
        case "440D1A":
            // "I demand you return two top cards on your board each with the icon of my choice other than leaf!"
            $options = array(
                'player_id' => $launcher_id,

                'choose_icon_type' => true,
                'icon' => [1, 3, 4, 5, 6, 7],
             );
            break;

        case "440D1B":
            // "I demand you return two top cards on your board each with the icon of my choice other than leaf!"
            $options = array(
                'player_id' => $player_id,
                'n' => 2,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',
                
                'with_icon' => self::getAuxiliaryValue(),
            );
            break;

        case "440N1A":
            // "Return a top card on your board"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',
            );
            break;

        case "440N1B":
            // " and all cards in your score pile of equal or higher value than the top card."
            $options = array(
                'player_id' => $player_id,                
                'n' => 2,

                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => 0,
                'location_to' => 'deck',

                'card_ids_are_in_auxiliary_array' => true,
            );
            break;

        // id 443, age 11: Fusion
        case "443N1A":
            // "Score a top card of value 11 on your board."    
            $options = array(
                'player_id' => $player_id,                
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $player_id,
                'location_to' => 'score',

                'card_ids_are_in_auxiliary_array' => true,
                
                'score_keyword' => true,
             );
            break;

        // id 444, age 11: Hypersonics
        case "444D1A":
            // "I demand you return two top cards on your board of the same value!"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',

                'card_ids_are_in_auxiliary_array' => true,
            );
            break;

        case "444D1B":
            // "I demand you return two top cards on your board of the same value!"  (second card)
            $options = array(
                'player_id' => $player_id,
                'n' => 1,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => 0,
                'location_to' => 'deck',

                'age' => $this->innovationGameState->get('age_last_selected'), // matches previous selection
            );
            break;

        case "444D1C":
            // "return all cards of that value or less in your hand and score pile!"
            $options = array(
                'player_id' => $player_id,                

                'owner_from' => $player_id,
                'location_from' => 'hand,score',
                'owner_to' => 0,
                'location_to' => 'deck',

                'card_ids_are_in_auxiliary_array' => true,
            );
            break;
        
        // id 446, age 11: Near-Field Comm
        case "446D1A":
            // "I demand you transfer all the highest cards in your score pile to my score pile!"
            $options = array(
                'player_id' => $player_id,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $launcher_id,
                'location_to' => 'score',
                
                'age' => self::getMaxAgeInScore($player_id),
            );
            break;

        case "446N1A":
            // "Reveal the highest card in your score pile and execute its non-demand dogma effects. Do not share them."
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'score',
                'owner_to' => $player_id,
                'location_to' => 'revealed',
                
                'age' => self::getMaxAgeInScore($player_id),
            );
            break;
            
            
        // id 448, age 11: Escapism
        case "448N1A":
            // "Reveal a card in your hand"
            $options = array(
                'player_id' => $player_id,
                'n' => 1,
                
                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => $player_id,
                'location_to' => 'revealed',
            );
            break;

        case "448N1+A":
            // "Return from your hand all cards of value equal to the value of the revealed card."
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'hand',
                'owner_to' => 0,
                'location_to' => 'deck',

                'age' => $this->innovationGameState->get('age_last_selected')
            );
            break;
            
        // id 449, age 11: Whataboutism
        case "449D1A":
            // "I demand you transfer all your top cards with a demand effect from your board to my board!"
            $options = array(
                'player_id' => $player_id,

                'owner_from' => $player_id,
                'location_from' => 'board',
                'owner_to' => $launcher_id,
                'location_to' => 'board',

                'has_demand_effect' => true,
            );
            break;
            
            
        default:
            // This should not happens
            throw new BgaVisibleSystemException(self::format(self::_("Unreferenced card effect code in section B: '{code}'"), array('code' => $code)));
            break;
        }
        
        // There wasn't an interaction needed in this step after all
        if ($options == null || (array_key_exists('n', $options) && $options['n'] <= 0)) {
            // The last step has been completed, so it's the end of the turn for the player involved
            if ($step == self::getStepMax()) {
                self::trace('interactionStep->interPlayerInvolvedTurn');
                $this->gamestate->nextState('interPlayerInvolvedTurn');
                return;
            }
            // There's at least one more interaction step to attempt
            self::incrementStep(1);
            self::trace('interactionStep->interactionStep');
            $this->gamestate->nextState('interactionStep');
            return;
        }

        self::setSelectionRange($options);
        
        self::trace('interactionStep->preSelectionMove');
        $this->gamestate->nextState('preSelectionMove');
    }
    
    function stInterInteractionStep() {
        $player_id = self::getCurrentPlayerUnderDogmaEffect();
        $launcher_id = self::getLauncherId();

        $nested_card_state = self::getCurrentNestedCardState();

        // There won't be any nested card state if a player is returning cards after the Search icon was triggered.
        if ($nested_card_state == null) {
            $code = null;
            $step = 1;
            $step_max = 1;
        } else {
            $card_id = $nested_card_state['card_id'];
            $current_effect_type = $nested_card_state['current_effect_type'];
            $current_effect_number = $nested_card_state['current_effect_number'];
            // Echo effects are sometimes executed on cards other than the card being dogma'd
            if ($current_effect_type == 3) {
                $nesting_index = $nested_card_state['nesting_index'];
                $card_id = self::getUniqueValueFromDB(
                    self::format("SELECT card_id FROM echo_execution WHERE nesting_index = {nesting_index} AND execution_index = {effect_number}",
                        array('nesting_index' => $nesting_index, 'effect_number' => $current_effect_number)));
            }
            $step = self::getStep();
            $code = self::getCardExecutionCodeWithLetter($card_id, $current_effect_type, $current_effect_number, $step);
        }

        $n = $this->innovationGameState->get('n');
        
        $crown = self::getIconSquare(1);
        $leaf = self::getIconSquare(2);
        $lightbulb = self::getIconSquare(3);
        $tower = self::getIconSquare(4);
        $factory = self::getIconSquare(5);
        $clock = self::getIconSquare(6);
        
        if (!self::isZombie(self::getActivePlayerId())) {
            try {
                switch($code) {
                // The first number is the id of the card
                // D1 means the first (and single) I demand effect
                // C1 means the first (and single) I compel effect
                // N1 means the first non-demand effect
                // N2 means the second non-demand effect
                // N3 means the third non-demand effect
                // E1 means the first (and single) echo effect
                
                // The letter indicates the step : A for the first one, B for the second
                
                // Setting the $step_max variable means there is interaction needed with the player
                
                // id 0, age 1: Pottery
                case "0N1A":
                    if ($n > 0) { // "If you returned any"
                        switch($n) {
                        case 1:
                            self::notifyGeneralInfo(clienttranslate("One card has been returned"));
                            break;
                        case 2:
                            self::notifyGeneralInfo(clienttranslate("Two cards have been returned"));
                            break;
                        case 3:
                            self::notifyGeneralInfo(clienttranslate("Three cards have been returned"));
                            break;
                        }
                        self::executeDraw($player_id, $n, 'score'); // "Draw and score a card of value equal to the number of cards you returned" 
                    }
                    break;
                
                // id 1, age 1: Tools
                case "1N1A":
                    if ($n > 0) { // "If you do"
                        self::executeDrawAndMeld($player_id, 3); // "Draw and meld a 3"
                    }
                    break;
                case "1N2A":
                    if ($n > 0) {
                        for ($times = 0; $times < 3; $times++) { // "If you do"
                            self::executeDraw($player_id, 1); // "Draw three 1"                
                        }
                    }
                    break;
                    
                // id 5, age 1: Oars
                case "5D1A":
                    if ($n > 0) { // "If you do"
                        self::executeDraw($player_id, 1); // "Draw a 1"
                        self::setAuxiliaryValue(1); // A transfer has been made, flag it
                        if (!$this->innovationGameState->usingFirstEditionRules()) {
                            $step--; self::incrementStep(-1); // "Repeat that dogma effect"
                        }
                    } else {
                        // Reveal hand to prove that they have no crowns.
                        self::revealHand($player_id);
                    }
                    break;

                // id 6, age 1: Clothing
                case "6N1A":
                    if ($n == 0) { // "If you don't"
                        // Only reveal hand if there is at least one card in hand and fewer than 5 top cards
                        $hand_count = self::countCardsInLocation($player_id, 'hand');
                        if ($hand_count > 0) {
                            $pile_sizes = self::countCardsInLocationKeyedByColor($player_id, 'board');
                            for ($color = 0; $color < 5; $color++) {
                                if ($pile_sizes[$color] == 0) {
                                    self::revealHand($player_id);
                                    break;
                                }
                            }
                        }
                    }
                    break;
                
                // id 9, age 1: Agriculture
                case "9N1A":
                    if ($n > 0) { // "If you do"
                        $age_to_draw_in = $this->innovationGameState->get('age_last_selected') + 1;
                        self::executeDraw($player_id, $age_to_draw_in, 'score'); // "Draw and score a card of value one higher than the card you returned"
                    }
                    break;
                
                // id 10, age 1: Domestication
                case "10N1A":
                    self::executeDraw($player_id, 1); // "Draw a 1"
                    break;
                
                // id 11, age 1: Masonry
                case "11N1A":
                    if ($n >= 4) { // "If you melded four or more cards this way"
                        $achievement = self::getCardInfo(106); // Monument achievement
                        if ($achievement['owner'] == 0) {
                            self::notifyGeneralInfo(clienttranslate("At least four cards have been melded."));
                            self::transferCardFromTo($achievement, $player_id, 'achievements'); // "Claim the Monument achievement"
                        }
                        else {
                            self::notifyGeneralInfo(clienttranslate("At least four cards have been melded but the Monument achievement has already been claimed."));
                        }
                    }
                    break;
                    
                // id 12, age 1: City states
                case "12D1A":
                    if ($n > 0) { // "If you do"
                        self::executeDraw($player_id, 1); // "Draw a 1"
                    }
                    break;
                    
                // id 13, age 1: Code of laws
                case "13N1A":
                    if ($n > 0) { // "If you do"
                        self::incrementStepMax(1);
                    }
                    break;
                
                // id 16, age 2: Mathematics
                case "16N1A":
                    if ($n > 0) { // "If you do"
                        self::executeDrawAndMeld($player_id, $this->innovationGameState->get('age_last_selected') + 1); // "Draw and meld a card of value one higher than the card you returned"
                    }
                    break;
               
                // id 17, age 2: Construction
                case "17D1A":
                    self::executeDraw($player_id, 2); // "Draw a 2"
                    break;
                
                // id 18, age 2: Road building
                case "18N1A":
                    if ($n == 2) { // "If you melded two"
                        if (self::getTopCardOnBoard($player_id, 1) !== null) { // The player has a top red board card
                            self::incrementStepMax(1);
                        }
                        else {
                            self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no top red card on your board.'), array('You' => 'You'));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no top red card on your board.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        }
                    }
                    break;
                    
                // id 19, age 2: Currency
                case "19N1A":
                    if ($n > 0) { // "If you do"
                        $different_values_selected_so_far = self::getAuxiliaryValueAsArray();
                        $number_of_cards_to_score = count($different_values_selected_so_far);
                        
                        if ($number_of_cards_to_score == 1) {
                            self::notifyPlayer($player_id, 'log', clienttranslate('Each card ${you} returned has the same value.'), array('you' => 'you'));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('Each card ${player_name} returned has the same value.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        }
                        else if ($number_of_cards_to_score > 1) {
                            $n = self::getTranslatedNumber($number_of_cards_to_score);
                            self::notifyPlayer($player_id, 'log', clienttranslate('${You} returned cards of ${n} different values.'), array('i18n' => array('n'), 'You' => 'You', 'n' => $n));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('There are ${n} different values that can be found in the cards ${player_name} returned.'), array('i18n' => array('n'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => $n));
                        }
                        
                        // "For every different value of card you returned"
                        for($i=0; $i<$number_of_cards_to_score; $i++) {
                            self::executeDraw($player_id, 2, 'score'); // "Draw and score a 2"
                        }
                    }
                    break;
                    
                // id 20, age 2: Mapmaking
                case "20D1A":
                    if ($n > 0) {
                        self::setAuxiliaryValue(1); // A transfer has been made, flag it
                    }
                    break;
                
                // id 23, age 2: Monotheism        
                case "23D1A":
                    if ($n > 0) { // "If you do"
                        self::executeDrawAndTuck($player_id, 1); // "Draw an tuck a 1"
                    }
                    break;
                            
                // id 32, age 3: Medicine
                case "32D1B":
                    // Finish the exchange
                    $this->gamestate->changeActivePlayer($launcher_id); // This exchange was initiated by $launcher_id
                    $id = self::getAuxiliaryValue();
                    if ($id != -1) { // The attacking player could indeed choose a card
                        $card = self::getCardInfo($id);
                        self::transferCardFromTo($card, $player_id, 'score'); // $launcher_id -> $player_id
                        self::setAuxiliaryValue(-1);
                    }
                    break;
                
                // id 33, age 3: Education        
                case "33N1A":
                    if ($n > 0) { // "If you do"
                        self::executeDraw($player_id, self::getMaxAgeInScore($player_id) + 2); // "Draw a card of value two higher than the highest card remaining in your score pile"
                    }
                    break;
                    
                // id 34, age 3: Feudalism        
                case "34D1A":
                    if (!$this->innovationGameState->usingFirstEditionRules()) {
                        if ($n > 0) { // "If you do"
                            self::unsplay($player_id, $player_id, $this->innovationGameState->get('color_last_selected')); // "Unsplay that color of your cards"
                        }
                    }
                    break;
                
                // id 36, age 4: Printing press        
                case "36N1A":
                    if ($n > 0) { // "If you do"
                        $top_purple_card = self::getTopCardOnBoard($player_id, 4 /* purple */);
                        if ($top_purple_card !== null) {
                            self::executeDraw($player_id, $top_purple_card['age'] + 2); // "Draw a card of value two higher than the top purple card on your board"
                        }
                        else {
                            self::executeDraw($player_id, 2); // If no purple card, draw a 2.
                        }
                    }
                    break;
                    
                // id 38, age 4: Gunpowder
                case "38D1A":
                    if ($n > 0) {
                        self::setAuxiliaryValue(1); // A transfer has been made, flag it
                    }
                    break;
                    
                // id 39, age 4: Invention
                case "39N1A":
                    if ($n > 0) { // "If you do"
                        self::executeDraw($player_id, 4, 'score'); // "Draw and score a 4"
                    }
                    break;
                    
                // id 41, age 4: Anatomy
                case "41D1A":
                    if ($n > 0) { // "If you do"
                        self::setAuxiliaryValue($this->innovationGameState->get('age_last_selected')); // Save the age of the returned card
                        self::incrementStepMax(1);
                    }
                    break;

                // id 42, age 4: Perspective
                case "42N1A":
                    if ($n > 0) { // "If you do"
                        self::incrementStepMax(1);
                    }
                    break;
                    
                // id 43, age 4: Enterprise
                case "43D1A":
                    if ($n > 0) { // "If you do"
                        self::executeDrawAndMeld($player_id, 4); // "Draw and meld a 4"
                    }
                    break;
                
                // id 47, age 5: Coal
                case "47N3A":
                    if ($n > 0) { // "If you do"
                        $card = self::getTopCardOnBoard($player_id, $this->innovationGameState->get('color_last_selected'));
                        if ($card !== null) { // Check if the p^layer has a card beneath the card he scored
                            self::scoreCard($card, $player_id); // "Also score the card beneath it"
                        }
                    }                
                    break;

                // id 48, age 5: The pirate code
                case "48D1A":
                    if ($n > 0) {
                        self::setAuxiliaryValue(1); // A transfer has been made, flag it
                    }
                    break;

                // id 49, age 5: Banking
                case "49D1A":
                    if ($n > 0) { // "If you do"
                        self::executeDraw($player_id, 5, 'score'); // "Draw and score a 5"
                    }
                    break;
                    
                // id 50, age 5: Measurement
                case "50N1A":
                    if ($n > 0) { // "If you do"
                        if ($this->innovationGameState->usingFirstEditionRules()) {
                            // In the first edition, color is chosen by the player
                            self::incrementStepMax(1);
                        } else {
                            $color = $this->innovationGameState->get('color_last_selected');
                            self::splayRight($player_id, $player_id, $color); // "Splay that color of your cards right"
                            $number_of_cards = self::countCardsInLocationKeyedByColor($player_id, 'board')[$color];
                            if ($number_of_cards == 1) {
                                self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} ${colored} card.'), array('i18n' => array('n', 'colored'), 'You' => 'You', 'n' => self::getTranslatedNumber($number_of_cards), 'colored' => self::getColorInClear($color)));
                                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has  ${n} ${colored} card.'), array('i18n' => array('n', 'colored'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => self::getTranslatedNumber($number_of_cards), 'colored' => self::getColorInClear($color)));
                            } else {
                                self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} ${colored_cards}.'), array('i18n' => array('n', 'colored_cards'), 'You' => 'You', 'n' => self::getTranslatedNumber($number_of_cards), 'colored_cards' => self::getColorInClearWithCards($color)));
                                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has  ${n} ${colored_cards}.'), array('i18n' => array('n', 'colored_cards'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => self::getTranslatedNumber($number_of_cards), 'colored_cards' => self::getColorInClearWithCards($color)));
                            }
                            self::executeDraw($player_id, $number_of_cards); // "Draw a card of value equal to the number of cards of that color on your board"
                        }
                    }
                    break;
                    
                // id 51, age 5: Statistics
                case "51D1A":
                    // First edition only
                    if ($n > 0 && self::countCardsInLocation($player_id, 'hand') == 1) { // "If you do, and have only one card in hand afterwards"
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have now only one card in your hand.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has now only one card in his hand.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        $step--; self::incrementStep(-1); // --> "Repeat this demand"
                    }
                    break;
                    
                // id 54, age 5: Societies
                case "54D1A":
                    if ($n > 0) { // "If you do"
                        self::executeDraw($player_id, 5); // Draw a 5
                    }
                    break;
                    
                // id 59, age 6: Classification
                case "59N1A":
                    if ($n > 0) { // Unsaid rule: the player must have at least one card to show from his hand, else, the effect can't continue
                        $color = $this->innovationGameState->get('color_last_selected');
                        self::setAuxiliaryValue($color); // Save the color of the revealed card
                        $revealed_card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                        
                        foreach (self::getActiveOpponentIds($player_id) as $other_player_id) {
                            self::revealHand($other_player_id);
                            $transfer = false;
                            foreach (self::getIdsOfCardsInLocation($other_player_id, 'hand') as $id) {
                                $card = self::getCardInfo($id);
                                if ($card['color'] == $color) { // This card must be given to the player
                                    self::transferCardFromTo($card, $player_id, 'hand'); // "Take into your hand all cards of that color from all other player's hands"
                                    $transfer = true;
                                }
                            }
                            if (!$transfer) { // The player had no card of this color in his hand
                                $color_in_clear = self::getColorInClear($color);
                                self::notifyPlayer($other_player_id, 'log', clienttranslate('${You} have no ${colored} cards in your hand.'), array('i18n' => array('colored'), 'You' => 'You', 'colored' => $color_in_clear));
                                self::notifyAllPlayersBut($other_player_id, 'log', clienttranslate('${player_name} has no ${colored} cards in his hand.'), array('i18n' => array('colored'), 'player_name' => self::getColoredPlayerName($other_player_id), 'colored' => $color_in_clear));
                            }
                        }
                        self::transferCardFromTo($revealed_card, $player_id, 'hand'); // Place back the card into player's hand
                        self::incrementStepMax(1);
                    }
                    break;
                    
                // id 62, age 6: Vaccination
                case "62D1A":
                    if ($n > 0) { // "If you returned any"
                        self::executeDrawAndMeld($player_id, 6); // "Draw and meld a 6"
                        self::setAuxiliaryValue(1); // Flag that a card has been returned
                    }
                    break;
                    
                // id 63, age 6: Democracy
                case "63N1A":
                    // "If you have returned more cards than any other player due to Democracy so far during this dogma action, draw and score an 8."
                    if ($this->innovationGameState->get('release_version') >= 3) {
                        $num_cards_returned_by_this_player = $n + self::getUniqueValueFromDB(self::format("SELECT democracy_counter FROM player WHERE player_id = {player_id}", array('player_id' => $player_id)));
                        $max_cards_returned_by_another_player = self::getUniqueValueFromDB(self::format("SELECT MAX(democracy_counter) FROM player WHERE player_id != {player_id}", array('player_id' => $player_id)));
                        if ($num_cards_returned_by_this_player > $max_cards_returned_by_another_player) {
                            self::executeDraw($player_id, 8, 'score');
                            self::DbQuery(self::format("UPDATE player SET democracy_counter = {count} WHERE player_id = {player_id}", array('count' => $num_cards_returned_by_this_player, 'player_id' => $player_id)));
                        }
                    } else {
                        if ($n > self::getAuxiliaryValue()) {
                            self::executeDraw($player_id, 8, 'score');
                            self::setAuxiliaryValue($n); // Set the new maximum
                        }
                    }
                    break;
                    
                // id 64, age 6: Emancipation
                case "64D1A":
                    if ($n > 0) { // "If you do"
                        self::executeDraw($player_id, 6); // "Draw a 6"
                    }
                    break;
                
                // id 68, age 7: Explosives
                case "68D1A":
                    // TODO(LATER): Remove the use of the auxilary value.
                    if ($n > 0) {
                        self::setAuxiliaryValue(1);  // Flag that at least one card has been transfered
                    }
                    break;
                    
                case "68D1C":
                    // TODO(LATER): Remove the use of the auxilary value.
                    if (self::getAuxiliaryValue() == 1 && self::countCardsInLocation($player_id, 'hand') == 0) { // "If you transferred any, and then have no cards in hand"
                        self::executeDraw($player_id, 7); // "Draw a 7"
                    }
                    break;
                
                // id 70, age 7: Electricity
                case "70N1A":
                    for($i=0; $i<$n; $i++){ // "For each card you returned"
                        self::executeDraw($player_id, 8);  // "Draw a 8"
                    }
                    break;
                    
                // id 72, age 7: Sanitation
                case "72D1C":
                    // Finish the exchange
                    $this->gamestate->changeActivePlayer($launcher_id); // This exchange was initiated by $launcher_id
                    $id = self::getAuxiliaryValue();
                    if ($id != -1) { // The attacking player could indeed choose a card
                        $card = self::getCardInfo($id);
                        self::transferCardFromTo($card, $player_id, 'hand'); // $launcher_id -> $player_id
                        self::setAuxiliaryValue(-1);
                    }
                    break;
                    
                // id 73, age 7: Lighting
                case "73N1A":
                    if ($n > 0) { // "If you do"
                        $different_values_selected_so_far = self::getAuxiliaryValueAsArray();
                        $number_of_cards_to_score = count($different_values_selected_so_far);
                        
                        if ($number_of_cards_to_score == 1) {
                            self::notifyPlayer($player_id, 'log', clienttranslate('Each card ${you} tucked has the same value.'), array('you' => 'you'));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('Each card ${player_name} tucked has the same value.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        }
                        else if ($number_of_cards_to_score > 1) {
                            $n = self::getTranslatedNumber($number_of_cards_to_score);
                            self::notifyPlayer($player_id, 'log', clienttranslate('${You} tucked cards of ${n} different values.'), array('i18n' => array('n'), 'You' => 'You', 'n' => $n));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('There are ${n} different values that can be found in the cards ${player_name} tucked.'), array('i18n' => array('n'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => $n));
                        }
                        
                        // "For every different value of card you tucked"
                        for($i=0; $i<$number_of_cards_to_score; $i++) {
                            self::executeDraw($player_id, 7, 'score'); // "Draw and score a 7"
                        }
                    }
                    break;
                
                // id 74, age 7: Railroad        
                case "74N1A":
                    self::executeDraw($player_id, 6); // Draw three 6
                    self::executeDraw($player_id, 6); //
                    self::executeDraw($player_id, 6); //
                    break;
                
                // id 75, age 8: Quantum theory        
                case "75N1A":
                    if ($n == 2) { // "If you return two"
                        self::executeDraw($player_id, 10); // "Draw a 10"
                        self::executeDraw($player_id, 10, 'score'); // "Draw and score a 10"
                    }
                    break;
                
                // id 78, age 8: Mobility        
                case "78D1A":
                    if ($n > 0) {
                        $color = $this->innovationGameState->get('color_last_selected');
                        $selectable_colors = self::getAuxiliaryValueAsArray();
                        $selectable_colors = array_diff($selectable_colors, array($color)); // Remove the color of the card the player has chosen: he could not choose the same for his next card
                        self::setAuxiliaryValueFromArray($selectable_colors);
                    }
                    break;
                    
                case "78D1B":
                    if (self::getAuxiliaryValueAsArray() <> array(0,2,3,4)) { // "If you transferred any cards" (ie: a color has been removed from the initial array)
                        self::executeDraw($player_id, 8); // "Draw a 8"
                    }
                    break;
                    
                // id 79, age 8: Corporations        
                case "79D1A":
                    if ($n > 0) { // "If you transfered any cards"
                        self::executeDrawAndMeld($player_id, 8); // "Draw and meld a 8"
                    }
                    break;

                // id 80, age 8: Mass media         
                case "80N1A":
                    if ($n > 0) { // "If you do
                        self::incrementStepMax(2);
                    }
                    break;
                
                // id 81, age 8: Antibiotics
                case "81N1A":
                    if ($n > 0) { // If you do (implicit)
                        $different_values_selected_so_far = self::getAuxiliaryValueAsArray();
                        $number_of_cards_to_draw = count($different_values_selected_so_far);
                        
                        if ($number_of_cards_to_draw == 1) {
                            self::notifyPlayer($player_id, 'log', clienttranslate('Each card ${you} returned has the same value.'), array('you' => 'you'));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('Each card ${player_name} returned has the same value.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        }
                        else if ($number_of_cards_to_draw > 1) {
                            $n = self::getTranslatedNumber($number_of_cards_to_draw);
                            self::notifyPlayer($player_id, 'log', clienttranslate('${You} returned cards of ${n} different values.'), array('i18n' => array('n'), 'You' => 'You', 'n' => $n));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('There are ${n} different values that can be found in the cards ${player_name} returned.'), array('i18n' => array('n'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => $n));
                        }
                        
                        // "For every different value of card that you returned"
                        for($i=0; $i<$number_of_cards_to_draw; $i++) {
                            self::executeDraw($player_id, 8); // "Draw two 8"
                            self::executeDraw($player_id, 8); //
                        }
                    }
                    break;
                
                // id 82, age 8: Skyscrapers
                case "82D1A":
                    if ($n > 0) { // "If you do
                        $color = $this->innovationGameState->get('color_last_selected');
                        $card = self::getTopCardOnBoard($player_id, $color); // The card now on top of the pile
                        if ($card !== null) {
                            self::scoreCard($card, $player_id); // "Score the card beneath it"
                        }
                        self::setAuxiliaryValue($color);// Flag the chosen color for the next interaction
                        self::incrementStepMax(1);
                    }
                    break;
                
                // id 84, age 8: Socialism     
                case "84N1A":
                    if ($n > 0) {
                        if (self::getAuxiliaryValue() == 1) { // "If you tucked at least one purple card"
                            self::notifyGeneralInfo(clienttranslate('At least one purple card has been tucked.'));
                            
                            foreach (self::getActiveOpponentIds($player_id) as $opponent_id) {
                                $ids_of_lowest_cards_in_hand = self::getIdsOfLowestCardsInLocation($opponent_id, 'hand');
                                foreach ($ids_of_lowest_cards_in_hand as $card_id) {
                                    $card = self::getCardInfo($card_id);
                                    self::transferCardFromTo($card, $player_id, 'hand'); // "Take all the lowest cards in each other opponent's hand into your hand" 
                                }
                            }
                        } else {
                            self::notifyGeneralInfo(clienttranslate('No purple card has been tucked.'));
                        }
                    }
                    break;
                
                // id 88, age 9: Fission
                case "88N1A":
                    if (!$this->innovationGameState->usingFirstEditionRules()) {
                        self::executeDraw($player_id, 10); // "Draw a 10"
                    }
                    break;
                
                // id 89, age 9: Collaboration
                case "89D1A":
                    $this->gamestate->changeActivePlayer($player_id);
                    $remaining_revealed_card = self::getCardsInLocation($player_id, 'revealed')[0]; // There is one card left revealed
                    self::transferCardFromTo($remaining_revealed_card, $player_id, 'board'); // "Meld the other one"
                    break;
                    
                // id 90, age 9: Satellites
                case "90N1A":
                    self::executeDraw($player_id, 8); // "Draw three 8"
                    self::executeDraw($player_id, 8); //
                    self::executeDraw($player_id, 8); //
                    break;
                    
                case "90N3A":
                    if ($n > 0) {
                        $card = self::getCardInfo($this->innovationGameState->get('id_last_selected')); // The card the player melded from his hand
                        self::executeNonDemandEffects($card); // "Execute each of its non-demand dogma effects"
                    }
                    break;
                    
                // id 91, age 9: Ecology
                case "91N1A":
                    if ($n > 0) { // "If you do
                        self::incrementStepMax(1);
                    }
                    break;
                    
                case "91N1B":
                    self::executeDraw($player_id, 10); // "Draw two 10"
                    self::executeDraw($player_id, 10); //
                    break;

                // id 92, age 9: Suburbia
                case "92N1A":
                    for($i=0; $i<$n; $i++) { // "For each card you tucked"
                        self::executeDraw($player_id, 1, 'score'); // "Draw and score a 1"
                    }
                    break;
                    
                // id 94, age 9: Specialization
                case "94N1A":
                    if ($n > 0) { // Unsaid rule: the player must have at least one card to show from his hand, else, the effect cant' continue
                        $color = $this->innovationGameState->get('color_last_selected');
                        $revealed_card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                        
                        foreach (self::getActiveOpponentIds($player_id) as $opponent_id) { // "From all other opponents' boards"
                            $top_card = self::getTopCardOnBoard($opponent_id, $color);
                            if ($top_card !== null) { // If the opponent has indeed a top card of that color on his board
                                self::transferCardFromTo($top_card, $player_id, 'hand'); // "Take into your hand the top card of that color"
                            }
                        }
                        self::transferCardFromTo($revealed_card, $player_id, 'hand'); // Place back the card into player's hand
                    }
                    break;
                    
                // id 97, age 10: Miniaturization
                case "97N1A":
                    $age_last_selected = $this->innovationGameState->get('age_last_selected') == 10;
                    if ($n > 0 && $age_last_selected == 10) { // "If you returned a 10"
                        $number_of_cards_in_score = self::countCardsInLocationKeyedByAge($player_id, 'score');
                        $number_of_different_value = 0;
                        for($age=1; $age<=11; $age++) {
                            if ($number_of_cards_in_score[$age] > 0) {
                                $number_of_different_value++;
                            }
                        }
                        
                        if ($number_of_different_value == 0) {
                            self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no card in your score pile.'), array('You' => 'You'));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name}\'s has no card in his score pile.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        }
                        else if ($number_of_different_value == 1) {
                            self::notifyPlayer($player_id, 'log', clienttranslate('Each card in ${your} score pile has the same value.'), array('your' => 'your'));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('Each card ${player_name}\'s score pile has the same value.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        }
                        else if ($number_of_different_value > 1) {
                            $n = self::getTranslatedNumber($number_of_different_value);
                            self::notifyPlayer($player_id, 'log', clienttranslate('There are ${n} different values that can be found in ${your} score pile.'), array('i18n' => array('n'), 'your' => 'your', 'n' => $n));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('There are ${n} different values that can be found in ${player_name}\'s score pile.'), array('i18n' => array('n'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => $n));
                        }
                        
                        for($i=0; $i<$number_of_different_value; $i++) { // "For every different value of card in your score pile"
                            self::executeDraw($player_id, 10); // "Draw a 10"                    
                        }
                    }
                    else if ($n > 0 && $age_last_selected != 10) {
                        self::notifyGeneralInfo(clienttranslate('The returned card is not of value ${age}'), array('age' => self::getAgeSquare(10)));
                    }
                    break;
                    
                // id 114, Artifacts age 1: Papyrus of Ani
                case "114N1A":
                    // "If you do"
                    if ($n > 0) {
                        self::incrementStepMax(1);
                    }
                    break;
                
                // id 116, Artifacts age 1: Priest-King
                case "116N1A":
                    // "If you do"
                    if ($n > 0) {
                        $color_scored = $this->innovationGameState->get('color_last_selected');
                        $top_card = self::getTopCardOnBoard($player_id, $color_scored);
                        if ($top_card !== null) { // "If you have a top card matching its color"
                            self::executeNonDemandEffects($top_card); // "Execute each of the top card's non-demand dogma effects. Do not share them."
                            break;
                        }
                    }
                    break;

                // id 118, Artifacts age 1: Jiskairumoko Necklace
                case "118C1A":
                    // "If you do"
                    if ($n > 0) {
                        self::incrementStepMax(1);
                    }
                    break;

                // id 120, Artifacts age 1: Lurgan Canoe
                case "120N1A":
                    if ($n > 0) {
                        $board = self::getCardsInLocationKeyedByColor($player_id, 'board');
                        $pile = $board[$this->innovationGameState->get('color_last_selected')];
                        $scored = false;
                        for ($i = 0; $i < count($pile) - 1; $i++) { // "Score all other cards of the same color from your board"
                            $card = self::getCardInfo($pile[$i]['id']);
                            self::scoreCard($card, $player_id);
                            $scored = true;
                        }
                        if ($scored) { // "If you scored at least one card, repeat this effect"
                            $step--; self::incrementStep(-1);
                        }
                    }
                    break;
                
                // id 121, Artifacts age 1: Xianrendong Shards
                case "121N1A":
                    // Store IDs of revealed cards so that we are later able to see if the scored cards had the same color.
                    $revealed_cards = self::getCardsInLocation($player_id, 'revealed');
                    for ($i = 1; $i <= count($revealed_cards); $i++) {
                        $this->innovationGameState->set('card_id_'.$i, $revealed_cards[$i-1]['id']);
                    }
                    break;

                case "121N1B":
                    $revealed_card_ids = array($this->innovationGameState->get('card_id_1'), $this->innovationGameState->get('card_id_2'), $this->innovationGameState->get('card_id_3'));

                    // "Tuck the other"
                    $remaining_revealed_cards = self::getCardsInLocation($player_id, 'revealed');
                    if (count($remaining_revealed_cards) == 1) {
                        $remaining_card = $remaining_revealed_cards[0];
                        self::tuckCard($remaining_card, $player_id);
                        for ($i = 0; $i < 3; $i++) {
                            if ($revealed_card_ids[$i] == $remaining_card['id']) {
                                $revealed_card_ids[$i] = -1;
                            }
                        }
                    }

                    // Now revealed_card_ids contains only -1's and the IDs of the scored cards.
                    $first_color = null;
                    foreach ($revealed_card_ids as $card_id) {
                        if ($card_id < 0) {
                            continue;
                        }
                        $current_card = self::getCardInfo($card_id);
                        if ($first_color == null) {
                            $first_color = $current_card['color'];
                        // "If the scored cards were the same color, draw three 1s"
                        } else if ($first_color == $current_card['color']) {
                            self::notifyGeneralInfo(clienttranslate('The scored cards were the same color.'), array());
                            self::executeDraw($player_id, 1);
                            self::executeDraw($player_id, 1);
                            self::executeDraw($player_id, 1);
                            break;
                        } else {
                            self::notifyGeneralInfo(clienttranslate('The scored cards were not the same color.'), array());
                            break;
                        }
                    }
                    break;

                // id 122, Artifacts age 1: Mask of Warka
                case "122N1B":
                    // "Claim all achievements of value matching those [returned] cards, ignoring eligibility"
                    $achievements_by_age = self::getCardsInLocationKeyedByAge(0, "achievements");
                    $different_values_selected_so_far = self::getAuxiliaryValue2AsArray();
                    $achievement_was_claimed = false;
                    foreach ($different_values_selected_so_far as $returned_age) {
                        foreach ($achievements_by_age[$returned_age] as $achievement) {
                            self::transferCardFromTo($achievement, $player_id, 'achievements');
                            $achievement_was_claimed = true;
                        }
                    }
                    if (!$achievement_was_claimed) {
                        self::notifyGeneralInfo(clienttranslate('There are no claimable achievements matching the returned values.'));
                    }
                    break;
                
                // id 123, Artifacts age 1: Ark of the Covenant
                case "123N1A":
                    $player_ids = self::getActivePlayerIdsInTurnOrderStartingWithCurrentPlayer();
                    
                    if ($n > 0) { // Unsaid rule: the player must have returned a card or else this part of the effect can't continue
                        $returned_color = $this->innovationGameState->get('color_last_selected');
                            
                        foreach ($player_ids as $id) {
                            $top_cards = self::getTopCardsOnBoard($id);
                            
                            $artifact_found = false;
                            foreach ($top_cards as &$card) {
                                if ($card['type'] == 1) { // Artifact
                                    $artifact_found = true;
                                    break;
                                }
                            }
                            
                            if (!$artifact_found) {
                                while (($top_card = self::getTopCardOnBoard($id, $returned_color)) !== null) {   
                                    // "Transfer all cards of the same color from the boards of all players with no top artifacts to your score pile."
                                    self::transferCardFromTo($top_card, $player_id, 'score');
                                }
                            }
                            
                        }
                    }

                    // "If Ark of the Covenant is a top card on any board, transfer it to your hand"
                    $ark_of_the_covenant = self::getIfTopCardOnBoard(123);
                    if ($ark_of_the_covenant !== null) {
                        self::transferCardFromTo($ark_of_the_covenant, $player_id, 'hand');
                    }
                    break;
                
                // id 124, Artifacts age 1: Tale of the Shipwrecked Sailor
                case "124N1A":
                    // "Draw a 1"
                    self::executeDraw($player_id, 1);
                    break;

                case "124N1B":
                    // "If you (melded a card)"
                    if ($n > 0) {
                        // "Splay that color left"
                        self::splayLeft($player_id, $player_id, $this->innovationGameState->get('color_last_selected')); 
                    } else {
                        self::revealHand($player_id);
                    }
                    break;

                // id 131, Artifacts age 2: Holy Grail
                case "131N1A":
                    // if you do
                    if ($n > 0) {
                        self::incrementStepMax(1);
                    }
                    break;

                // id 132, Artifacts age 2: Terracotta Army
                case "132N1A":
                    // if you don't
                    if ($n == 0) {
                        // Reveal hand to prove to others that they didn't have any cards without a tower
                        self::revealHand($player_id);
                    }
                    break;
                
                // id 134, Artifacts age 2: Cyrus Cylinder
                case "134N1A":
                    // "Execute its non-demand dogma effects"
                    $card_id = $this->innovationGameState->get('id_last_selected');
                    if ($n > 0 && self::getNonDemandEffect($card_id, 1) != null) {
                        self::executeNonDemandEffects(self::getCardInfo($card_id));
                    } else {
                        self::incrementStepMax(1); // Still need to do the splay
                    }
                    break;

                case "134N1B":
                case "134N1+A":
                    // "Splay left a color on any player's board"
                    if ($n > 0) {
                        $color = $this->innovationGameState->get('color_last_selected');
                        $target_player_id = $this->innovationGameState->get('owner_last_selected');
                        self::splayLeft($player_id, $target_player_id, $color);
                    }
                    break;
                
                // id 135, Artifacts age 3: Dunhuang Star Chart
                case "135N1A":
                    // "Draw a card of value equal to the number of cards returned"
                    self::executeDraw($player_id, $n);
                    break;

                // id 136, Artifacts age 3: Charter of Liberties
                case "136N1A":
                    if ($n > 0) {
                        // "If you do, splay left its color"
                        self::splayLeft($player_id, $player_id, $this->innovationGameState->get('color_last_selected'));
                        self::incrementStepMax(1);
                    }
                    break;

                case "136N1B":
                    if ($n > 0) {
                        // "Execute all of that color's top card's non-demand effects, without sharing"
                        self::executeNonDemandEffects(self::getCardInfo($this->innovationGameState->get('id_last_selected')));
                    }
                    break;
                    
                // id 138, Artifacts age 3: Mjolnir Amulet
                case "138C1A":
                    if ($n > 0) {
                        // "Transfer all cards of that card's color from your board to my score pile"
                        $board = self::getCardsInLocationKeyedByColor($player_id, 'board');
                        $pile = $board[$this->innovationGameState->get('color_last_selected')];
                        for ($i = count($pile) - 1; $i >= 0; $i--) {
                            self::transferCardFromTo($pile[$i], $launcher_id, 'score', /*bottom_to=*/ false, /*score_keyword=*/ false); 
                        }
                    }
                    break;

                // id 139, Artifacts age 3: Philosopher's Stone
                case "139N1A":
                    // Move to next interaction if a card was returned
                    if ($n > 0) {
                        self::incrementStepMax(1);
                    }
                    break;
            
                // id 141, Artifacts age 3: Moylough Belt Shrine
                case "141C1A":
                    // Return revealed cards back to player's hand.
                    $this->gamestate->changeActivePlayer($player_id);
                    $cards = self::getCardsInLocation($player_id, 'revealed');
                    foreach ($cards as $card) {
                        self::transferCardFromTo($card, $player_id, 'hand');
                    }
                    break;
                    
                // id 143, Artifacts age 3: Necronomicon
                case "143N1A":
                    if (self::getAuxiliaryValue() == 1) { // Red
                        $revealed_card = self::getCardsInLocation($player_id, 'revealed')[0];
                        self::transferCardFromTo($revealed_card, $player_id, 'hand'); // Keep revealed card
                    }
                    break;

                // id 144, Artifacts age 3: Shroud of Turin
                case "144N1A":
                    if ($n > 0) {
                        self::notifyGeneralInfo(clienttranslate('This card is ${color}.'), array(
                            'i18n' => array('color'),
                            'color' => self::getColorInClear($this->innovationGameState->get('color_last_selected'))
                        ));
                        self::setAuxiliaryValue(1);
                        self::incrementStepMax(2);
                    }
                    break;
                
                case "144N1B":
                    if ($n > 0) {
                        self::setAuxiliaryValue(2);
                    }
                    break;
                
                case "144N1C":
                    // "If you did all three"
                    if ($n == 0) {
                        // Reveal score pile to prove that no cards of the specified color could have been returned
                        self::revealScorePile($player_id);
                    } else if ($n > 0 && self::getAuxiliaryValue() == 2) {
                        self::incrementStepMax(1);
                    }
                    break;

                // id 146, Artifacts age 4: Delft Pocket Telescope
                case "146N1A":
                    // Reset the max steps in case the effect is being repeated
                    self::setStepMax(1);

                    if ($n > 0) { // "If you do"
                        // "Draw a 5 and a 6"
                        $card_1 = self::executeDraw($player_id, 5);
                        $this->innovationGameState->set('card_id_1', $card_1['id']);
                        $card_2 = self::executeDraw($player_id, 6);
                        $this->innovationGameState->set('card_id_2', $card_2['id']);

                        // Check if any icons on the returned card match one of the drawn cards
                        $returned_card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                        $matching_icon_on_card_1 = false;
                        $matching_icon_on_card_2 = false;
                        for ($icon = 1; $icon <= 7; $icon++) { 
                            $has_icon = self::hasRessource($returned_card, $icon);
                            if ($has_icon && self::hasRessource($card_1, $icon)) {
                                $matching_icon_on_card_1 = true;
                            }
                            if ($has_icon && self::hasRessource($card_2, $icon)) {
                                $matching_icon_on_card_2 = true;
                            }
                        }
                        
                        if (!$matching_icon_on_card_1 && !$matching_icon_on_card_2) {
                            // Reveal cards to prove that no icons matched with the previously returned card
                            self::transferCardFromTo($card_1, $player_id, 'revealed');
                            self::transferCardFromTo($card_2, $player_id, 'revealed');
                            self::notifyGeneralInfo(clienttranslate('Neither card has a symbol in common with the returned card.'));
                            self::setStepMax(2);
                        } else {
                            // Skip to the third interaction
                            $step++;
                            self::incrementStep(1);
                            self::setStepMax(3);

                            // Remove card as an option if it does not have any matching symbols
                            if (!$matching_icon_on_card_1) {
                                $this->innovationGameState->set('card_id_1', -1);
                            } else if (!$matching_icon_on_card_2) {
                                $this->innovationGameState->set('card_id_2', -1);
                            }
                        }
                    }
                    break;

                case "146N1B":
                    $step = $step - 2;
                    self::incrementStep(-2); // "And repeat this effect"
                    break;

                case "146N1C":
                    // Move revealed card back to the player's hand
                    self::transferCardFromTo(self::getCardInfo($this->innovationGameState->get('id_last_selected')), $player_id, 'hand');
                    break;
                    
                // id 147, Artifacts age 4: East India Company Charter
                case "147N1B":
                    // "For each player that returned cards, draw and score a 5"
                    for ($i = 0; $i < self::getAuxiliaryValue(); $i++) {
                        self::executeDraw($player_id, 5, 'score');
                    }
                    break;
                    
                // id 149, Artifacts age 4: Molasses Reef Caravel
                case "149N1A":
                    // "Draw three 4's"
                    self::executeDraw($player_id, 4);
                    self::executeDraw($player_id, 4);
                    self::executeDraw($player_id, 4);

                    $number_of_blue_cards = self::countCardsInLocationKeyedByColor($player_id, 'hand')[0];
                    if ($number_of_blue_cards == 0) {
                        self::revealHand($player_id);
                        $color_in_clear = self::getColorInClear(0);
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no ${colored} cards in your hand.'), array('i18n' => array('colored'), 'You' => 'You', 'colored' => $color_in_clear));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no ${colored} cards in his hand.'), array('i18n' => array('colored'), 'player_name' => self::getColoredPlayerName($player_id), 'colored' => $color_in_clear));
                        $step = $step + 1;
                        self::incrementStep(1);
                    }
                    break;
                    
                // id 150, Artifacts age 4: Hunt-Lenox Globe
                case "150N1A":
                    if (self::getAuxiliaryValue() == 1) {
                        // "Draw a 5 for each card returned"
                        for ($i = 1; $i <= $n; $i++) {
                            self::executeDraw($player_id, 5);
                        }
                    }
                    break;

                // id 157, Artifacts age 5: Bill of Rights
                case "157C1A":
                    $color = self::getAuxiliaryValue();
                    do {
                        // "Transfer all cards of that color from your board to my board, from the bottom up!"
                        $card = self::getBottomCardOnBoard($player_id, $color);
                        if ($card != null) {
                            self::transferCardFromTo($card, $launcher_id, 'board');
                        }
                    } while ($card != null);
                    break;

                // id 167, Artifacts age 6: Frigate Constitution
                case "167C1A":
                    if ($n > 0) { // "If you do"
                        // "and its value is equal to the value of any of my top cards"
                        $value_to_match = $this->innovationGameState->get('age_last_selected');
                        $found_match = false;
                        $top_cards = self::getTopCardsOnBoard($launcher_id);
                        foreach ($top_cards as $top_card) {
                            if ($top_card['faceup_age'] == $value_to_match) {
                                self::incrementStepMax(1);
                                $found_match = true;
                                break;
                            }
                        }
                        // Otherwise keep the card
                        if (!$found_match) {
                            $card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                            self::transferCardFromTo($card, $player_id, 'hand');
                        }
                    }
                    break;
                    
                // id 171, Artifacts age 6: Stamp Act
                case "171C1A":
                    if ($n > 0) { // "If you do"
                        $top_green_card = self::getTopCardOnBoard($player_id, 2);
                        if ($top_green_card != null) {
                            self::setAuxiliaryValue($top_green_card['age']);
                            self::incrementStepMax(1);
                        }
                    }
                    break;
 
                // id 173, Artifacts age 6: Moonlight Sonata
                case "173N1A":
                    // "Meld the bottom card on your board of that color"
                    $bottom_card = self::getBottomCardOnBoard($player_id, self::getAuxiliaryValue());
                    self::transferCardFromTo($bottom_card, $player_id, 'board');
                    break;
                    
                // id 152, Artifacts age 4: Mona Lisa
                case "152N1B":
                    // "Draw five 4s, then reveal your hand"
                    for ($i = 0; $i < 5; $i++) {
                        self::executeDraw($player_id, 4);
                    }
                    self::revealHand($player_id);
                    
                    $chosen_color = self::getAuxiliaryValue2();
                    $cards = self::getCardsInLocationKeyedByColor($player_id, 'hand');
                    $colored_cards = $cards[$chosen_color];
                    $num_cards = count($colored_cards);
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} revealed ${n} ${color} cards.'), array('i18n' => array('color'), 'You' => 'You', 'n' => $num_cards, 'color' => self::getColorInClear($chosen_color)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} revealed ${n} ${color} cards.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => $num_cards, 'color' => self::getColorInClear($chosen_color)));
                    
                    // "If you have exactly that many cards of that color, score them, and splay right your cards of that color"
                    if ($num_cards == self::getAuxiliaryValue()) {
                        foreach ($colored_cards as $card) {
                            $card = self::getCardInfo($card['id']);
                            self::scoreCard($card, $player_id);
                        }
                        self::splayRight($player_id, $player_id, $chosen_color);
                    // "Otherwise"
                    } else {
                        self::incrementStepMax(1);
                    }
                    break;

                // id 155, Artifacts age 5: Boerhavve Silver Microscope
                case "155N1A":
                    if ($n > 0) {
                        self::setAuxiliaryValue($this->innovationGameState->get('age_last_selected'));
                    } else {
                        self::setAuxiliaryValue(0);
                    }
                    break;

                case "155N1B":
                    $first_age = self::getAuxiliaryValue();
                    if ($n > 0) {
                        $second_age = self::getFaceupAgeLastSelected();
                    } else {
                        $second_age = 0;
                    }
                    
                    // "Draw and score a card of value equal to the sum of the values of the cards returned"
                    $sum = $first_age + $second_age;
                    self::notifyGeneralInfo(clienttranslate('The values sum to ${number}'), array('number' => $sum));
                    self::executeDraw($player_id, $sum, 'score');
                    break;
                    
                // id 156, Artifacts age 5: Principia
                case "156N1A":
                    $ages_on_top = Arrays::getBase16ArrayFromValue(self::getAuxiliaryValue());
                    sort($ages_on_top);
                    // "For each card returned, draw and meld a card of value one higher than the value of the returned card, in ascending order"
                    foreach ($ages_on_top as $card_age) {
                        self::executeDrawAndMeld($player_id, $card_age + 1);
                    }
                    break;

                // id 158, Artifacts age 5: Ship of the Line Sussex
                case "158N1B":
                    // "Score all cards of that color from your board"
                    $board = self::getCardsInLocationKeyedByColor($player_id, 'board');
                    $pile = $board[self::getAuxiliaryValue()];
                    for ($i = count($pile) - 1; $i >= 0; $i--) {
                        self::scoreCard($pile[$i], $player_id);
                    }
                    break;

                // id 160, Artifacts age 5: Hudson's Bay Company Archives
                case "160N1A":
                    if ($n > 0) {
                        // "Splay right the color of the melded card"
                        self::splayRight($player_id, $player_id, $this->innovationGameState->get('color_last_selected'));
                    }
                    break;

                // id 161, Artifacts age 5: Gujin Tushu Jinsheng
                case "161N1A":
                    // "Execute the effects on the chosen card as if they were on this card. Do not share them"
                    if ($n > 0) {
                        self::executeAllEffects(self::getCardInfo($this->innovationGameState->get('id_last_selected')));
                    }
                    break;

                // id 162, Artifacts age 5: The Daily Courant
                case "162N1A":
                    // "Draw a card of any value"
                    $card = self::executeDraw($player_id, self::getAuxiliaryValue());
                    $this->innovationGameState->set('card_id_1', $card['id']);
                    break;

                case "162N1C":
                    // "Execute the effects of one of your other top cards as if they were on this card. Do not share them."
                    if ($n > 0) {
                        self::executeAllEffects(self::getCardInfo($this->innovationGameState->get('id_last_selected')));
                    }
                    break;

                // id 164, Artifacts age 5: Almira, Queen of the Castle
                case "164N1A":
                    if ($n > 0) { // If no card is melded, then the value cannot match an achievement
                        self::incrementStepMax(1);
                    }
                    break;

                // id 165, Artifacts age 6: Kilogram of the Archives
                case "165N1A":
                    if ($n > 0) {
                        // Log the value of the first returned card
                        self::setAuxiliaryValue($this->innovationGameState->get('age_last_selected'));
                    } else {
                        // No card was returned
                        self::setAuxiliaryValue(0);
                    }
                    
                    break;

                case "165N1B":
                    // "If you returned two cards and their values sum to ten, draw and score a 10"
                    $first_value = self::getAuxiliaryValue();
                    if ($n > 0) {
                        $second_value = self::getFaceupAgeLastSelected();
                    } else {
                        $second_value = 0;
                    }
                    $sum = $first_value + $second_value;
                    self::notifyGeneralInfo(clienttranslate('The values sum to ${number}'), array('number' => $sum));
                    if ($sum == 10) {
                        self::executeDraw($player_id, 10, 'score');
                    }
                    break;

                // id 166, Artifacts age 6: Puffing Billy
                case "166N1A":
                    if ($n > 0) {
                        // "Draw a card of value equal to the highest number of symbols of the same type visible in that color on your board"
                        $color = $this->innovationGameState->get('color_last_selected');
                        $max_symbols = 0;
                        for ($icon = 1; $icon <= 7; $icon++) {
                            $icon_count = self::countVisibleIconsInPile($player_id, $icon, $color);
                            if ($icon_count > $max_symbols){
                                $max_symbols = $icon_count;
                            }
                        }
                        self::executeDraw($player_id, $max_symbols);

                        // "Splay right that color"
                        self::splayRight($player_id, $player_id, $color);
                    }
                    break;
                    
                // id 170, Artifacts age 6: Buttonwood Agreement
                case "170N1B":
                    // "Unsplay that color"
                    self::unsplay($player_id, $player_id, self::getAuxiliaryValue());
                    break;

                // id 171, Artifacts age 6: Stamp Act
                case "171C1A":
                    if ($n > 0) { // "If you do"
                        $top_green_card = self::getTopCardOnBoard($player_id, 2);
                        if ($top_green_card !== null) {
                            self::setAuxiliaryValue($top_green_card['age']);
                            self::incrementStepMax(1);
                        }
                    }
                    break;
            
                // id 174, Artifacts age 6: Marcha Real
                case "174N1A":
                    // TODO(LATER): Clean up the dead code branch.
                    if ($this->innovationGameState->get('release_version') >= 2) {
                        $card_id_1 = self::getAuxiliaryValue();
                        $card_1 = $card_id_1 < 0 ? null : self::getCardInfo($card_id_1);
                        $card_id_2 = self::getAuxiliaryValue2();
                        $card_2 = $card_id_2 < 0 ? null : self::getCardInfo($card_id_2);
                    } else {
                        $revealed_cards = self::getCardsInLocation($player_id, 'revealed');
                        $card_1 = count($revealed_cards) >= 1 ? $revealed_cards[0] : null;
                        $card_2 = count($revealed_cards) >= 2 ? $revealed_cards[1] : null;

                        // Return revealed cards from your hand
                        if ($card_1 != null) {
                            self::returnCard($card_1);
                        }
                        if ($card_2 != null) {
                            self::returnCard($card_2);
                        }
                    }

                    if ($card_1 != null && $card_2 != null) {
                        // "If they have the same value, draw a card of value one higher"
                        if ($card_1['age'] == $card_2['age']) {
                            self::notifyGeneralInfo(clienttranslate('They both have the same value.'));
                            self::executeDraw($player_id, $card_1['age'] + 1);
                        } else {
                            self::notifyGeneralInfo(clienttranslate('They do not have the same value.'));
                        }
                        // "If they have the same color, claim an achievement, ignoring eligibility"
                        if ($card_1['color'] == $card_2['color']) {
                            self::notifyGeneralInfo(clienttranslate('They both have the same color.'));
                            self::incrementStepMax(1);
                        } else {
                            self::notifyGeneralInfo(clienttranslate('They do not have the same color.'));
                        }
                    } else if ($card_1 == null && $card_2 == null) { // If none are returned, they are still considered to have the same value (0)
                        self::executeDraw($player_id, 1);
                    }
                    break;

                // id 175, Artifacts age 7: Periodic Table
                case "175N1A":
                    self::setAuxiliaryValue($this->innovationGameState->get('color_last_selected'));
                    break;

                case "175N1B":
                    $color_1 = self::getAuxiliaryValue();
                    $color_2 = $this->innovationGameState->get('color_last_selected');
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose your top ${color_1} and ${color_2} cards.'), array('i18n' => array('color_1', 'color_2'), 'You' => 'You', 'color_1' => self::getColorInClear($color_1), 'color_2' => self::getColorInClear($color_2)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses his top ${color_1} and ${color_2} cards.'), array('i18n' => array('color_1', 'color_2'), 'player_name' => self::getColoredPlayerName($player_id), 'color_1' => self::getColorInClear($color_1), 'color_2' => self::getColorInClear($color_2)));

                    // "Draw a card of value one higher and meld it"
                    $age_selected = self::getFaceupAgeLastSelected();
                    $card = self::executeDrawAndMeld($player_id, $age_selected + 1);
                    
                    // "If it melded over one of the chosen cards, repeat this effect"
                    if ($card['color'] == $color_1 || $card['color'] == $color_2) {
                        // Determine if there are still any top cards which have the same value as another top card on their board
                        $colors = self::getColorsOfRepeatedValueOfTopCardsOnBoard($player_id);
                        if (count($colors) >= 2) {
                            self::setAuxiliaryValueFromArray($colors);
                            $step = $step - 2;
                            self::incrementStep(-2);
                        } else {
                            self::notifyGeneralInfo(clienttranslate("No two top cards have the same value."));
                        }
                    }
                    break;

                // id 179, Artifacts age 7: International Prototype Metre Bar   
                case "179N1A":
                    $age_value = self::getAuxiliaryValue();
                    
                    // "Draw and meld a card of that value"
                    $card = self::executeDrawAndMeld($player_id, $age_value);

                    // "Splay up the color of the melded card"
                    self::splayUp($player_id, $player_id, $card['color']);
                    
                    // "If the number of cards of that color visible on your board is exactly equal to the card's value, you win"
                    if ($card['faceup_age'] == self::countVisibleCards($player_id, $card['color'])) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} melded a card whose value is equal to the number of visible cards in your ${color} stack.'), array('You' => 'You', 'color'=> self::getColorInClear($card['color'])));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} melded a card whose value is equal to the number of visible cards in his ${color} stack.'), array('player_name' => self::getColoredPlayerName($player_id), 'color'=> self::getColorInClear($card['color'])));
                        $this->innovationGameState->set('winner_by_dogma', $player_id);
                        self::trace('EOG bubbled from self::stInterInteractionStep International Prototype Metre Bar');
                        throw new EndOfGame();
                    
                    // "Otherwise, return the melded card"
                    } else {
                        self::returnCard($card);
                    }
                    break;
                
                // id 180, Artifacts age 7: Hansen Writing Ball
                case "180C1A":
                    // "Transfer all cards in your hand to my hand"
                    foreach (self::getIdsOfCardsInLocation($player_id, 'hand') as $id) {
                        self::transferCardFromTo(self::getCardInfo($id), $launcher_id, 'hand');
                    }
                    break;
                             
                // id 182, Artifacts age 7: Singer Model 27
                case "182N1A":
                    if ($n > 0) { // "If you do"
                        // "Splay up its color"
                        self::splayUp($player_id, $player_id, $this->innovationGameState->get('color_last_selected'));
                        self::incrementStepMax(1);
                    }
                    break;
                
                case "182N1B":
                    // Reveal remaining score pile to prove that no more cards can be tucked
                    self::revealScorePile($player_id);
                    break;

                // id 183, Artifacts age 7: Roundhay Garden Scene
                case "183N1A":
                     if ($n > 0) {
                        // "Draw and score two cards of value equal to the melded card"
                        $melded_card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                        self::executeDraw($player_id, $melded_card['faceup_age'], 'score');
                        self::executeDraw($player_id, $melded_card['faceup_age'], 'score');
                        
                        // "Execute the effects of the melded card as if they were on this card. Do not share them."
                        self::executeAllEffects($melded_card);
                    } else { // If no card is melded, the absence is treated like a 0 and cards are still scored.
                        self::executeDraw($player_id, 0, 'score');
                        self::executeDraw($player_id, 0, 'score');
                    }
                    break;
                    
                // id 184, Artifacts age 7: The Communist Manifesto
                case "184N1B":
                    $revealed_cards = self::getCardsInLocation($player_id, 'revealed');
                    if (self::getAuxiliaryValue() == $player_id) {
                        // Track which card was melded by the launcher so it can be executed later.
                        self::setAuxiliaryValue2($this->innovationGameState->get('id_last_selected'));
                    }
                    if (count($revealed_cards) > 0) {
                        // Remove the chosen player from the list of options.
                        $selectable_players = $this->innovationGameState->getAsArray('player_array');
                        $selected_player = self::getAuxiliaryValue();
                        $selectable_players = array_diff($selectable_players, array(self::playerIdToPlayerNo($selected_player)));
                        $this->innovationGameState->setFromArray('player_array', $selectable_players);
                        
                        // Repeat for next player
                        $step = $step - 2;
                        self::incrementStep(-2);
                    } else {
                        // "Execute the non-demand effects of your card. Do not share them"
                        self::executeNonDemandEffects(self::getCardInfo(self::getAuxiliaryValue2()));
                    }
                    break;
                    
                // id 186, Artifacts age 8: Earhart's Lockheed Electra 10E
                case "186N1A":
                    if ($n > 0) {
                        self::setAuxiliaryValue(self::getAuxiliaryValue() + 1);
                    } else {
                        $this->innovationGameState->increment('age_last_selected', -1);
                    }

                    // There are no more values to return
                    if ($this->innovationGameState->get('age_last_selected') == 0) {
                        // "If you return eight cards, you win"
                        if (self::getAuxiliaryValue() == 8) {
                            self::notifyPlayer($player_id, 'log', clienttranslate('${You} returned 8 cards.'), array('You' => 'You'));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} returned 8 cards.'), array('player_name' => self::getColoredPlayerName($player_id)));
                            $this->innovationGameState->set('winner_by_dogma', $player_id);
                            self::trace('EOG bubbled from self::stInterInteractionStep Earharts Lockheed Electra 10E');
                            throw new EndOfGame();

                        // "Otherwise"
                        } else {
                            self::incrementStepMax(1);
                        }
                    
                    // Repeat interaction with a lower value than last time
                    } else {
                        $step--; self::incrementStep(-1);
                    }
                    break;
                    
                // id 190, Artifacts age 8: Meiji-Mura Stamp Vending Machine
                case "190N1A":
                    // "Draw and score three cards of the returned card's value"
                    if ($n > 0) {
                        $age_to_score = $this->innovationGameState->get('age_last_selected');
                    } else {
                        $age_to_score = 0;
                    }
                    self::executeDraw($player_id, $age_to_score, 'score');
                    self::executeDraw($player_id, $age_to_score, 'score');
                    self::executeDraw($player_id, $age_to_score, 'score');
                    break;

                // id 191, Artifacts age 8: Plush Beweglich Rod Bear
                case "191N1A":
                    // "Splay up each color with a top card of the chosen value"
                    $age_value = self::getAuxiliaryValue();
                    $top_cards = self::getTopCardsOnBoard($player_id);
                    foreach ($top_cards as $top_card) {
                        if ($top_card['faceup_age'] == $age_value) {
                            self::splayUp($player_id, $player_id, $top_card['color']);
                        }
                    }
                    break;

                // id 192, Artifacts age 8: Time
                case "192C1A":
                    // "If you do, repeat this effect"
                    if ($n > 0) {
                        $step--;
                        self::incrementStep(-1);
                    }
                    break;

                // id 193, Artifacts age 8: Garland's Ruby Slippers
                case "193N1A":
                    // If a card was melded
                    if ($n > 0) {
                        $melded_card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                        
                        // "If the melded card has no effects, you win"
                        if ($melded_card['dogma_icon'] == null || $melded_card['type'] == 2) {
                            self::notifyPlayer($player_id, 'log', clienttranslate('${You} melded a card with no effects.'), array('You' => 'You'));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} melded a card with no effects.'), array('player_name' => self::getColoredPlayerName($player_id)));
                            $this->innovationGameState->set('winner_by_dogma', $player_id);
                            self::trace('EOG bubbled from self::stPlayerInvolvedTurn Garlands Ruby Slippers');
                            throw new EndOfGame();
                        } else {
                            // "Otherwise, execute the effects of the melded card as if they were on this card. Do not share them"
                            self::executeAllEffects($melded_card);
                        }
                    }
                    break;
                    
                // id 196, Artifacts age 9: Luna 3
                case "196N1A":
                    // "Draw and score a card of value equal to the number of cards returned"
                    self::executeDraw($player_id, $n, 'score');
                    break;

                // id 198, Artifacts age 9: Velcro Shoes
                case "198C1A":
                    // "If you do not"
                    if ($n == 0) {
                        self::incrementStepMax(1);
                    }
                    break;

                case "198C1B":
                    // "If you do neither, I win"
                    if ($n == 0) {
                        self::notifyGeneralInfo(clienttranslate('Neither transfer took place.'));
                        $this->innovationGameState->set('winner_by_dogma', $launcher_id);
                        self::trace('EOG bubbled from self::stInterInteractionStep Velcro Shoes');
                        throw new EndOfGame();
                    }
                    break;

                // id 200, Artifacts age 9: Syncom 3
                case "200N1A":
                    // "Draw and reveal five 9s"
                    $revealed_cards = array();
                    $revealed_colors = array();
                    for ($i = 0; $i < 5; $i++) {
                        $card = self::executeDraw($player_id, 9, 'revealed');
                        $revealed_cards[] = $card;
                        $revealed_colors[] = $card['color'];
                    }
                    
                    // "If you revealed all five colors, you win"
                    if (count(array_count_values($revealed_colors)) == 5) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} revealed all 5 colors.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} revealed all 5 colors.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        $this->innovationGameState->set('winner_by_dogma', $player_id);
                        self::trace('EOG bubbled from self::stInterInteractionStep Syncom 3');
                        throw new EndOfGame();
                    }

                    // Put the revealed cards in hand
                    foreach ($revealed_cards as $card) {
                        self::transferCardFromTo($card, $player_id, 'hand');
                    }
                    break;                    
                    
                case "204N1B":
                    // "If you have exactly 25 points, you win"
                    if (self::getPlayerScore($player_id) == 25) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have exactly 25 points.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has exactly 25 points.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        $this->innovationGameState->set('winner_by_dogma', $player_id);
                        self::trace('EOG bubbled from self::stInterInteractionStep Marilyn Diptych');
                        throw new EndOfGame();
                    }
                    break;

                // id 211, Artifacts age 10: Dolly the Sheep
                case "211N1A":
                    // "You may score your bottom yellow card"
                    $choice = self::getAuxiliaryValue();
                    if ($choice == 1) {
                        $bottom_yellow_card = self::getBottomCardOnBoard($player_id, 3);
                        self::scoreCard($bottom_yellow_card, $player_id);
                    }
                    break;

                case "211N1B":
                    // "You may draw and tuck a 1"
                    if (self::getAuxiliaryValue() == 1) {
                        self::executeDrawAndTuck($player_id, 1);
                    }
                    
                    // "If your bottom yellow card is Domestication, you win"
                    $bottom_yellow_card = self::getBottomCardOnBoard($player_id, 3);
                    if ($bottom_yellow_card != null && $bottom_yellow_card['id'] == 10) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have Domestication as a bottom card.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has Domestication as a bottom card.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        $this->innovationGameState->set('winner_by_dogma', $player_id);
                        self::trace('EOG bubbled from self::stInterInteractionStep Dolly the Sheep');
                        throw new EndOfGame();
                    }
                    break;       

                case "211N1C":
                    // "Then draw a 10"
                    self::executeDraw($player_id, 10);
                    break;

                // id 214, Artifacts age 10: Twister
                case "214C1A":
                    if ($n > 0) {
                        $selectable_colors = self::getAuxiliaryValueAsArray();
                        $selectable_colors = array_diff($selectable_colors, [$this->innovationGameState->get('color_last_selected')]);

                        // Repeat this interaction if there are more cards to meld
                        if (count($selectable_colors) > 0) {
                            self::setAuxiliaryValueFromArray($selectable_colors);
                            $step = 0;
                            self::setStep(0);
                        }
                    }
                    break;

                // id 216, Relic age 4: Complex Numbers
                case "216N1A":
                    // "If you do"
                    if ($n > 0) {
                        // Return card to hand
                        $revealed_card = self::getCardsInLocation($player_id, 'revealed')[0];
                        self::transferCardFromTo($revealed_card, $player_id, 'hand');
                        self::incrementStepMax(1);
                    }
                    break;
                    
                // id 217, Relic age 5: Newton-Wickins Telescope
                case "217N1A":
                    // "If you do, draw and meld a card of value equal to the number of cards returned"
                    if ($n > 0) {
                        $card = self::executeDrawAndMeld($player_id, $n);
                        
                        // "If the melded card has a clock, return it"
                        if (self::countIconsOnCard($card, 6) > 0) {
                            self::returnCard($card);
                        }
                    }
                    break;

                // id 219, Relic age 7: Safety Pin
                case "219D1A":
                    // "Draw a 6!"
                    self::executeDraw($player_id, 6);
                    break;
                    
                // id 331, Echoes age 1: Perfume
                case "331D1A":
                    // "If you do, draw and meld a card of equal value!"
                    if ($n > 0) {
                        self::executeDrawAndMeld($player_id, $this->innovationGameState->get('age_last_selected'));
                    }
                    break;

                // id 334, Echoes age 1: Candles
                case "334D1A":
                    // "If you do, draw a 1!"
                    if ($n > 0) {
                        self::executeDraw($player_id, 1);
                    }
                    break;

                // id 336, Echoes age 1: Comb
                case "336N1A":
                    // "Then draw and reveal five 1s"
                    for ($i = 0; $i < 5; $i++) {
                        self::executeDraw($player_id, 1, 'revealed');
                    }
                    // "Keep all cards that match the color chosen"
                    $drawn_cards = self::getCardsInLocation($player_id, 'revealed');
                    foreach ($drawn_cards as $card) {
                        if ($card['color'] == self::getAuxiliaryValue()) {
                            $card = self::getCardInfo($card['id']);
                            self::transferCardFromTo($card, $player_id, 'hand');
                        }
                    }
                    break;
                    
                // id 337, Echoes age 1: Ice skates
                case "337N1A":
                    if ($n == 0) {
                        // No cards returned, skip the B interaction.
                        self::incrementStep(1);
                    }
                    self::setAuxiliaryValue($n);                    
                    break;

                case "337N1B":
                    // "For each card returned, either draw and meld a 2, or draw and foreshadow a 3."
                    if (self::getAuxiliaryValue2() == 0) {
                        self::executeDrawAndForeshadow($player_id, 3);
                    }
                    else {
                        self::executeDrawAndMeld($player_id, 2);
                    }
                    
                    $iterations_left = self::getAuxiliaryValue();
                    if ($iterations_left > 1) {                        
                        self::incrementStep(-1);
                        self::setAuxiliaryValue($iterations_left - 1);
                    }
                    break;

                // id 338, Echoes age 1: Umbrella
                case "338N1A":
                    if ($n > 0) {
                        self::incrementStepMax(1);
                        self::setAuxiliaryValue($n);
                    }
                    break;                    

                // id 339, Echoes age 1: Chopsticks
                case "339N1A":
                    // "you may transfer its bottom card to the available achievements"
                    if (self::getAuxiliaryValue() == 1) { // yes
                        self::executeDraw(0, /*age=*/ 1, 'achievements', /*bottom_to=*/ false, 0, /*bottom_from=*/ true);
                    }
                    break;  

                // id 341, Echoes age 1: Soap
                case "341N1B":
                    // "If you tucked at least three,"
                    if ($n >= 3) {
                        self::incrementStepMax(1); // select a card
                    }
                    break; 

                // id 343, Echoes age 1: Flute
                case "343D1A":
                    if ($n == 0) {
                        // No cards returned, so reveal hand.
                        self::revealHand($player_id);
                    }
                    break;
                    
                // id 345, Echoes age 2: Lever
                case "345N1A":
                    if ($n >= 2) { // If at least two cards were returned, then the second part is possible
                        // "For every two cards of matching value returned, draw a card of value one higher"
                        $age_count_array = self::getAuxiliaryArray();
                        $age_draw_count_array = array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
                        for ($age = 1; $age <= 11; $age++) {
                            // Calculate how many of each age to draw by dividing the age below it by 2
                            $age_draw_count_array[$age] = self::intDivision($age_count_array[$age - 1], 2);
                            if ($age_draw_count_array[$age] > 0) {
                                self::setStepMax(2); // Drawing is now possible
                            }
                        }
                        self::setAuxiliaryArray($age_draw_count_array);
                    }
                    break;

                case "345N1B":
                    // Determine if the draw should happen again
                    $keep_going = false;
                    $age_count_array = self::getAuxiliaryArray();
                    for ($age = 1; $age < 12; $age++) {
                        if ($age_count_array[$age - 1] > 0) {
                            $keep_going = true;
                        }
                    }
                    self::setAuxiliaryArray($age_count_array);
                    
                    if ($keep_going) {
                        self::incrementStep(-1); $step--;
                    }
                    break;
                
                // id 346, Echoes age 2: Linguistics
                case "346N1A":
                    // "Draw a card of value equal to a bonus on your board, if you have any."
                    self::executeDraw($player_id, self::getAuxiliaryValue());
                    break;

                case "346E1A":
                    // "Draw a card of value equal to a bonus on your board, if you have any."
                    if (self::getAuxiliaryValue() == 1) {
                        self::executeDraw($player_id, 3);
                    } else {
                        self::executeDrawAndForeshadow($player_id, 4);
                    }
                    break;  

                // id 348, Echoes age 2: Horseshoes
                case "348D1A":
                    // "If you do, draw and meld a 2!"
                    if ($n > 0) {
                        self::executeDrawAndMeld($player_id, 2);
                    }
                    break;

                // id 349, Echoes age 2: Glassblowing
                case "349E1A":
                    if ($n == 0) {
                        // Reveal a hand with no bonuses
                        self::revealHand($player_id);
                    }
                    break;

                // id 350, Echoes age 2: Scissors
                case "350N1A":
                    if ($n > 0) { // card needs to be melded or returned
                        $hand_card_count = self::countCardsInLocation($player_id, 'hand');
                        if ($hand_card_count > 1) {
                            self::incrementStepMax(1); // Next card choice must be given
                        }
                        self::incrementStepMax(1); // Must proceed to the meld/score choice
                        
                        self::setAuxiliaryValue2($this->innovationGameState->get('id_last_selected'));
                    }
                    break;

                case "350N1B":
                    $choice = self::getAuxiliaryValue();
                    $chosen_card_id = self::getAuxiliaryValue2();
                    $card = self::getCardInfo($chosen_card_id);
                    
                    if ($choice == 1) {
                        // meld
                        self::transferCardFromTo($card, $player_id, 'board');
                    } else {
                        // score
                        self::transferCardFromTo($card, $player_id, 'score', false, /*score_keyword*/true);
                    }                    
                    break;
                    
                case "350N1C":
                    if ($n > 0) {
                        self::incrementStepMax(1); // Must proceed to the meld/score choice
                        self::setAuxiliaryValue2($this->innovationGameState->get('id_last_selected'));
                    }
                    break;

                case "350N1D":
                    $choice = self::getAuxiliaryValue();
                    $chosen_card_id = self::getAuxiliaryValue2();
                    $card = self::getCardInfo($chosen_card_id);
                    
                    if ($choice == 1) {
                        // meld
                        self::transferCardFromTo($card, $player_id, 'board');
                    } else {
                        // score
                        self::transferCardFromTo($card, $player_id, 'score', false, /*score_keyword*/true);
                    }                    
                    break;
                    
                // 351, Echoes age 2: Toothbrush
                case "351N2A":
                    // "you may transfer its bottom card to the available achievements"
                    if (self::getAuxiliaryValue() == 1) { // yes
                        self::executeDraw(0, /*age=*/ 2, 'achievements', /*bottom_to=*/ false, 0, /*bottom_from=*/ true);
                    }
                    break;

                // id 352, Echoes age 2: Watermill
                case "352N1A":
                    if ($n > 0) {
                        // "If you do, draw a card of value equal to that card's bonus."
                        $tucked_card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                        $bonuses = self::getBonusIcons($tucked_card);
                        $card = self::executeDraw($player_id, $bonuses[0]);
                        
                        if (count(self::getBonusIcons($card)) > 0) {
                            // "If the drawn card also has a bonus"
                            self::setStepMax(2); // Add optional repeatable step
                        }
                    } else {
                        // Reveal a hand with no bonuses
                        self::revealHand($player_id);
                    }
                    break;

                case "352N1B":
                    if ($n > 0) {
                        // card is returned, go back to step 1
                        self::incrementStep(-2); $step -= 2;
                        self::setStepMax(1);
                    }
                    break;  

                // 353, Echoes age 2: Pagoda
                case "353N1A":
                    // "and meld the drawn card."
                    $card = self::getCardsInLocation($player_id, 'revealed');
                    self::transferCardFromTo($card[0], $player_id, 'board');
                    break;

                // id 354, Echoes age 2: Chaturanga
                case "354N1A":
                    if ($n > 0) {
                        // "If you do, draw a two cards of value equal to that card's bonus."
                        $melded_card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                        $bonuses = self::getBonusIcons($melded_card);
                        self::executeDraw($player_id, $bonuses[0]);
                        self::executeDraw($player_id, $bonuses[0]);
                    }
                    else {
                        // Reveal a hand with no bonuses
                        self::revealHand($player_id);
                        
                        // "Otherwise, draw and foreshadow a card of value equal to the number of top cards on your board."
                        self::executeDrawAndForeshadow($player_id, count(self::getTopCardsOnBoard($player_id)));
                    }
                    break;

                // id 355, Echoes age 3: Almanac
                case "355N1A":
                    // "If you do, draw and score a card of value one higher than that bonus."
                    if ($n > 0) {
                        $card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                        $bonuses = self::getBonusIcons($card);
                        self::executeDrawAndScore($player_id, $bonuses[0] + 1);
                    }
                    break;

                // id 356, Echoes age 3: Magnifying Glass
                case "356N1B":
                    // "If you do, draw a card of value two higher than the cards you returned."
                    if ($n > 0) {
                        self::executeDraw($player_id, $this->innovationGameState->get('age_last_selected') + 2);
                    }
                    break;
                
                // id 358, Echoes age 3: Katana
                case "358D1B":
                    // "If you transferred any, draw a card of value equal to the total number of towers on those cards and transfer it to my forecast!"
                    $num_towers = self::getAuxiliaryValue();
                    if ($num_towers > 0) {
                        $card = self::executeDraw($player_id, $num_towers);
                        self::transferCardFromTo($card, $launcher_id, 'forecast');
                    }
                    break;

                // id 359, Echoes age 3: Charitable Trust
                case "359E1A":
                    // "Draw a 3 or 4."
                    if (self::getAuxiliaryValue() == 1) {
                        $card = self::executeDraw($player_id, 3);
                    } else {
                        $card = self::executeDraw($player_id, 4);
                    }
                    if (self::isExecutingAgainDueToEndorsedAction()) {
                        // NOTE: This encoding assumes that highest card ID won't be more than 999. The +1 in the encoding is necessary since the lowest card ID is 0 (not 1).
                        self::setIndexedAuxiliaryValue($player_id, (self::getIndexedAuxiliaryValue($player_id) + 1) * 1000 + $card['id']);
                    } else {
                        self::setIndexedAuxiliaryValue($player_id, $card['id']);
                    }
                    break;

                case "359N1A":
                    // "If you do"
                    if ($n > 0) {
                        $top_green_card = self::getTopCardOnBoard($player_id, 2);
                        if ($top_green_card != null) {
                            $claimable_ages = self::getClaimableAgesIgnoringAvailability($player_id);
                            if (in_array($top_green_card['faceup_age'], $claimable_ages)) {
                                self::incrementStepMax(1); // need to choose between returning and achieving
                            } else {
                                // If not eligible, then return green if present
                                self::transferCardFromTo($top_green_card, 0, 'deck'); // return green
                            }
                        }
                    }
                    break;
                    
                case "359N1B":
                    // "either return or achieve (if eligible) your top green card."
                    $top_green_card = self::getTopCardOnBoard($player_id, 2);
                    
                    if (self::getAuxiliaryValue() == 1) {
                        self::transferCardFromTo($top_green_card, 0, 'deck'); // return
                    } else {
                        self::transferCardFromTo($top_green_card, $player_id, 'achievements');
                    }
                    break;
                
                // id 362, Echoes age 3: Sandpaper                   
                case "362N1A":
                    for ($i = 0; $i < $n; $i++) {
                        self::executeDraw($player_id, 3);
                    }
                    break;
                    
                // id 364, Echoes age 3: Sunglasses
                case "364E1A":
                    if ($n == 0) {
                        for ($color = 0; $color < 5; $color++) {
                            if (self::getCurrentSplayDirection($player_id, $color) > 0) {
                                // If at least one pile is splayed, reveal hand to prove that
                                // that no cards are a matching color to a splayed pile.
                                self::revealHand($player_id);
                                break;
                            }
                        }
                    }
                    break;

                case "364N1A":
                    $choice = self::getAuxiliaryValue();
                    if ($choice == 1) {
                        $splayable_colors = self::getAuxiliaryValue2AsArray();
                        if (count($splayable_colors) > 0) {
                            self::incrementStepMax(1);
                        }
                        else {
                            self::splay($player_id, $player_id, 4, 0); // matching an unsplay
                        }
                    } else if ($choice == 0) { // Proceed to selecting a matching color to splay purple's direction
                        self::incrementStepMax(2);
                        self::incrementStep(1); $step++;
                    }
                    break;

                case "364N1B":
                    $color_chosen = self::getAuxiliaryValue();
                    self::splay($player_id, $player_id, 4, self::getCurrentSplayDirection($player_id, $color_chosen));
                    break;
                    
                // id 366, Echoes age 4: Telescope
                case "366N1A":
                    // "If you do,"
                    if ($n > 0) {
                        self::incrementStepMax(1);
                    }
                    break;
                    
                // id 367, Echoes age 4: Kobukson
                case "367E1A":
                    // "Splay left a color on any player's board"
                    if ($n > 0) {
                        $color = $this->innovationGameState->get('color_last_selected');
                        $target_player_id = $this->innovationGameState->get('owner_last_selected');
                        self::splayLeft($player_id, $target_player_id, $color);
                    }
                    break;
                    
                case "367D1A":
                    //"Draw and tuck a 4!"
                    self::executeDrawAndTuck($player_id, 4);
                    
                    self::setAuxiliaryValue(self::getAuxiliaryValue() + $n); // track the number of cards returned
                    break;

                // id 368, Echoes age 4: Shuriken
                case "368D1A":
                    // "If you do, draw a 4!"
                    if ($n > 0) {
                        self::executeDraw($player_id, 4);
                    }
                    break;

                // id 370, Echoes age 4: Globe
                case "370N1A":
                    // If you do not pass, proceed to color selection
                    if ($this->innovationGameState->get('choice') >= 0) {
                        self::incrementStepMax(1);
                    }
                    break;

                case "370N1B":
                    // "If you do,"
                    if ($n > 0) {
                        self::incrementStepMax(1);
                        
                        self::setAuxiliaryValue($n); // determines the splay direction.  If $n=3: up, $n=2: right, $n=1: left
                    }
                    break;

                case "370N1C":
                    // "If you returned at least one card, draw and foreshadow a 6."
                    self::executeDrawAndForeshadow($player_id, 6);
                    // TODO(LATER): Remove the following line. This was only necessary to fix a game which got stuck during a release push (https://boardgamearena.com/bug?id=79588).
                    self::setStepMax(3);
                    break;
                    
                // id 372, Echoes age 4: Pencil
                case "372N1A":
                    // "If you do,"
                    if($n > 0) {
                        // "draw that many cards of value one higher than the highest card you returned."
                        $max_age_returned = self::getAuxiliaryValue();
                        for ($i = 1; $i <= $n; $i++) {
                            $card = self::executeDraw($player_id, $max_age_returned + 1);
                            $this->innovationGameState->set('card_id_'.$i, $card['id']);
                        }
                        self::incrementStepMax(2); // Add interactions
                    }
                    break;
                    
                // id 373, Echoes age 4: Clock
                case "373D1A":
                    // "Transfer all cards of that value from your hand and score pile to my score pile!"
                    $age_to_transfer = self::getAuxiliaryValue();
                    
                    $hand_cards = self::getCardsInLocationKeyedByAge($player_id, 'hand')[$age_to_transfer];
                    for ($i = 0; $i < count($hand_cards); $i++) {
                        $hand_cards[$i] = self::getCardInfo($hand_cards[$i]['id']);
                        self::transferCardFromTo($hand_cards[$i], $launcher_id, 'score');
                    }

                    $score_cards = self::getCardsInLocationKeyedByAge($player_id, 'score')[$age_to_transfer];
                    for ($i = 0; $i < count($score_cards); $i++) {
                        $score_cards[$i] = self::getCardInfo($score_cards[$i]['id']);
                        self::transferCardFromTo($score_cards[$i], $launcher_id, 'score');
                    }
                    break;

                // id 374, Echoes age 4: Toilet
                case "374N1A":
                    // "and draw a card of the same value."
                    if ($n > 0) {
                        self::executeDraw($player_id, $this->innovationGameState->get('age_last_selected'));
                    }
                    break;

                // id 378, Echoes age 5: Octant
                case "378D1A":
                    // "If you do, draw and foreshadow a 6!"
                    if ($n > 0) {
                        self::executeDrawAndForeshadow($player_id, 6);
                    }
                    break;

                // id 379, Echoes age 5: Palampore
                case "379N1A":
                    self::executeDrawAndScore($player_id, self::getAuxiliaryValue());
                    break;

                // id 380, Echoes age 5: Seed Drill
                case "380N1A":
                    // "If there is at least one card in that deck"
                    $cards_to_draw_from = self::countCardsInLocationKeyedByAge(0, 'deck', /*base*/0);
                    if ($cards_to_draw_from[self::getAuxiliaryValue2()] > 0) {
                        self::incrementStepMax(1);
                    }
                    break;

                case "380N1B":
                    // "you may transfer its bottom card to the available achievements"
                    if (self::getAuxiliaryValue() == 1) { // yes
                        self::executeDraw(0, /*age=*/ self::getAuxiliaryValue2(), 'achievements', /*bottom_to=*/ false, 0, /*bottom_from=*/ true);
                    }
                    break;

                // id 381, Echoes age 5: Pressure Cooker
                case "381N1A":
                    $bonus_array = array();
                    for ($color = 0; $color < 5; $color++) {
                        $top_card = self::getTopCardOnBoard($player_id, $color);
                        $bonuses = self::getBonusIcons($top_card);
                        if (count($bonuses) > 0) {
                            $bonus_array[] = $bonuses[0];
                        }
                    }
                    
                    if (count(array_unique($bonus_array)) == 1) {
                        // multiple identical bonuses
                        for ($i=0; $i < count($bonus_array); $i++) {
                            self::executeDraw($player_id, $bonus_array[0]);
                        }
                    } elseif (count($bonus_array) > 1) {
                        // multiple bonuses, but different
                        self::setStepMax(2);
                        self::setAuxiliaryValue(Arrays::getValueFromBase16Array($bonus_array));
                    }
                    break;
                    
                case "381N1B":
                    $curr_bonuses = Arrays::getBase16ArrayFromValue(self::getAuxiliaryValue());
                    $this_bonus = self::getAuxiliaryValue2();
                    
                    self::executeDraw($player_id, $this_bonus);
                    
                    $found = false;
                    $next_bonuses = array();
                    for ($i=0; $i < count($curr_bonuses); $i++) {
                        if ($this_bonus == $curr_bonuses[$i] && $found == false){
                            $found = true;
                        }
                        else {
                            $next_bonuses[] = $curr_bonuses[$i];
                        }
                    }

                    if (count(array_unique($next_bonuses)) == 1) {
                        // identical bonuses
                        for ($i=0; $i < count($next_bonuses); $i++) {
                            self::executeDraw($player_id, $next_bonuses[0]);
                        }
                    } elseif (count($next_bonuses) > 1) {
                        // multiple bonuses left, but different
                        self::setAuxiliaryValue(Arrays::getValueFromBase16Array($next_bonuses));
                        $step--; self::incrementStep(-1); // repeat until no bonuses remain
                    }
                    break;

                // id 383, Echoes age 5: Piano
                case "383E1A":
                    self::executeDraw($player_id, self::getAuxiliaryValue2());
                    break;

                case "383N1A":
                    // "and then draw and score a card of each of your top card's values in ascending order."
                    $top_card_values = Arrays::getBase16ArrayFromValue(self::getAuxiliaryValue());
                    sort($top_card_values);
                    
                    foreach ($top_card_values as $sorted_value) {
                        self::executeDrawAndScore($player_id, $sorted_value);
                    }
                    break;

                // id 384, Echoes age 5: Tuning Fork
                case "384E1A":
                    if ($n > 0) {
                        $this->innovationGameState->set('card_id_1', $this->innovationGameState->get('id_last_selected'));
                        self::incrementStepMax(1); // return it
                    }
                    break;

                case "384N1A":
                    if ($n > 0) { // "If you do,"
                        // "draw and reveal a card of the same value"
                        $card = self::executeDrawAndReveal($player_id, $this->innovationGameState->get('age_last_selected'));
                        $top_card_by_color = self::getTopCardOnBoard($player_id, $card['color']);
                        if ($top_card_by_color == null || $card['faceup_age'] > $top_card_by_color['faceup_age']) {
                            // "and meld it if it is higher than a top card of the same color on your board. "
                            self::transferCardFromTo($card, $player_id, 'board');
                        } else {
                            // "Otherwise, return it."
                            self::returnCard($card);
                        }
                        self::setStepMax(2); // see if the player wants to repeat
                    }
                    break;

                case "384N1B":
                    if ($n > 0) { // "If you do,"
                        // "draw and reveal a card of the same value"
                        $card = self::executeDrawAndReveal($player_id, $this->innovationGameState->get('age_last_selected'));
                        $top_card_by_color = self::getTopCardOnBoard($player_id, $card['color']);
                        if ($top_card_by_color == null || $card['faceup_age'] > $top_card_by_color['faceup_age']) {
                            // "and meld it if it is higher than a top card of the same color on your board. "
                            self::transferCardFromTo($card, $player_id, 'board');
                        } else {
                            // "Otherwise, return it."
                            self::returnCard($card);
                        }
                        self::setStep(1); $step=1; // repeat this step
                    }
                    break;
                    
                // id 385, Echoes age 6: Bifocals
                case "385E1A":
                    self::executeDrawAndForeshadow($player_id, self::getAuxiliaryValue2());
                    break;

                case "385N1A":
                    // " If you do, draw and foreshadow a card of equal value to the card returned."
                    if ($n > 0) {
                        self::executeDrawAndForeshadow($player_id, $this->innovationGameState->get('age_last_selected'));
                    }
                    break;

                // id 386, Echoes age 6: Stethoscope
                case "386E1A":
                    if ($n <= 0) {
                        // Prove that they did not have any blue or yellow cards in hand.
                        self::revealHand($player_id);
                    }
                    if ($n > 0 && $this->innovationGameState->get('color_last_selected') == 0) {
                        self::setIndexedAuxiliaryValue($player_id, 1); // it is blue
                    }
                    break;

                // id 387, Echoes age 6: Loom
                case "387N1A":
                    if ($n > 0) { // card returned
                        $selectable_card_ids = array();
                        foreach (self::getCardsInLocation($player_id, 'score') as $card) {
                            if ($this->innovationGameState->get('age_last_selected') != $card['age']) {
                                $selectable_card_ids[] = $card['id'];
                            }
                        }
                        self::setAuxiliaryArray($selectable_card_ids);
                        self::incrementStepMax(1);
                    }
                    break;

                case "387N1B":
                    if ($n > 0) { // "If you do"
                        // "draw and tuck three 6s."
                        self::executeDrawAndTuck($player_id, 6);
                        self::executeDrawAndTuck($player_id, 6);
                        self::executeDrawAndTuck($player_id, 6);
                    }
                    break;
    
                // id 389, Echoes age 6: Hot Air Balloon
                case "389N1A":
                    // "If you do, transfer your top green card to that player's board."
                    if ($n > 0) {
                        $top_green_card = self::getTopCardOnBoard($player_id, 2);
                        if ($top_green_card != null) {
                            $last_owner = $this->innovationGameState->get('owner_last_selected');
                            self::transferCardFromTo($top_green_card, $last_owner, 'board');
                        }
                        // "Otherwise, draw and meld a 7."
                    } else {
                        self::executeDrawAndMeld($player_id, 7);
                    }
                    break;
                    
                // id 392, Echoes age 6: Morphine
                case "392D1A":
                    // "Draw a 6!"
                    self::executeDraw($player_id, 6);
                    break;
                    
                // id 393, Echoes age 6: Indian Clubs
                case "393N1A":
                    $prev_value = self::getAuxiliaryValue();
                    
                    $cards_in_score_pile = self::countCardsInLocationKeyedByAge($player_id, 'score');
                    $cards_in_hand = self::countCardsInLocationKeyedByAge($player_id, 'hand');
                    for ($age=$prev_value+1; $age <= 11; $age++) {
                        if ($cards_in_score_pile[$age] > 0 && $cards_in_hand[$age] > 0) {
                            self::setAuxiliaryValue($age);
                            $step--;
                            self::incrementStep(-1);
                            break;
                        }
                    }
                    break;

                // id 396, Echoes age 7: Typewriter
                case "396N1A":
                    // "Draw a 6. For each color of card returned, draw a card of the next higher value."
                    for ($i = 0; $i <= self::getAuxiliaryValue(); $i++) {
                        self::executeDraw($player_id, 6 + $i);
                    }
                    break;

                // id 397 Echoes age 7: Machine Gun
                case "397D1A":
                    if ($n > 0) { // "If you transfered any, draw a 7!"
                        self::executeDraw($player_id, 7);
                    }
                    break;

                // id 399 Echoes age 7: Jeans
                case "399E1A":
                    if ($n > 0) {
                        // "foreshadow the other."
                        $card_id_returned = $this->innovationGameState->get('id_last_selected');
                        $card_id_1 = $this->innovationGameState->get('card_id_1');
                        
                        if ($card_id_1 == $card_id_returned) {
                            $card_id_2 = $this->innovationGameState->get('card_id_2');
                            $other_card = self::getCardInfo($card_id_2);
                        } else {
                            $other_card = self::getCardInfo($card_id_1);
                        }
                        self::transferCardFromTo($other_card, $player_id, 'forecast');
                    }
                    break;
                
                case "399N1B":
                    // "Draw and reveal a card of each value."
                    self::executeDraw($player_id, self::getAuxiliaryValue(), 'revealed');
                    self::executeDraw($player_id, self::getAuxiliaryValue2(), 'revealed');
                    break;
                    
                // id 400 Echoes age 7: Telegraph
                case "400N1B":
                    $splay_direction = self::getCurrentSplayDirection(self::getAuxiliaryValue(), self::getAuxiliaryValue2());
                    self::splay($player_id, $player_id, self::getAuxiliaryValue2(), $splay_direction);
                    break;

                // id 401, Echoes age 7: Elevator
                case "401N1B":
                    // "Choose to transfer all cards of the chosen value from either all other players' hands or all their score piles to your score pile."
                    $age_to_transfer = self::getAuxiliaryValue();
                    if (self::getAuxiliaryValue2() == 1) {
                        $source = 'hand';
                    } else {
                        $source = 'score';
                    }
                    foreach (self::getAllActivePlayerIds() as $player) {
                        if ($player != $player_id) {
                            $cards = self::getCardsInLocationKeyedByAge($player, $source)[$age_to_transfer];
                            for ($i = 0; $i < count($cards); $i++) {
                                $cards[$i] = self::getCardInfo($cards[$i]['id']);
                                self::transferCardFromTo($cards[$i], $player_id, 'score');
                            }
                        }
                    }
                    break;
                    
                // id 402, Echoes age 7: Fertilizer
                case "402N1A":
                    if ($n > 0) { // "if you do"
                        // "transfer all cards from all score piles to your hand of value to the returned card."
                        $age_to_transfer = $this->innovationGameState->get('age_last_selected');
                        
                        $all_players = self::getAllActivePlayerIds();
                        foreach ($all_players as $player) {
                            $cards = self::getCardsInLocationKeyedByAge($player, 'score')[$age_to_transfer];
                            for ($i = 0; $i < count($cards); $i++) {
                                $cards[$i] = self::getCardInfo($cards[$i]['id']);
                                self::transferCardFromTo($cards[$i], $player_id, 'hand');
                            }
                            
                        }
                    }
                    break;                

                // id 403, Echoes age 7: Ice Cream
                case "403N1A":
                    // "If there is at least one card in that deck"
                    $cards_to_draw_from = self::countCardsInLocationKeyedByAge(0, 'deck', /*base*/0);
                    if ($cards_to_draw_from[self::getAuxiliaryValue2()] > 0) {
                        self::incrementStepMax(1);
                    }
                    break;

                case "403N1B":
                    // "you may transfer its bottom card to the available achievements"
                    if (self::getAuxiliaryValue() == 1) { // yes
                        self::executeDraw(0, /*age=*/ self::getAuxiliaryValue2(), 'achievements', /*bottom_to=*/ false, 0, /*bottom_from=*/ true);
                    }
                    break;

                // id 405, Echoes age 8: Radio Telescope
                case "405N1A":
                    if ($n > 0) { // If a card was melded
                        // Remove selected card from the list so it isn't returned.
                        $selected_card_id = $this->innovationGameState->get('id_last_selected');
                        $card_list = self::getAuxiliaryArray();
                        $new_card_list = array_diff($card_list, array($selected_card_id));
                        self::setAuxiliaryArray($new_card_list);
                        
                        // "If you meld A. I. due to this dogma effect, you win."
                        if ($selected_card_id == 103) { // A. I.
                            $this->innovationGameState->set('winner_by_dogma', $player_id);
                            self::trace('EOG bubbled from self::stInterInteractionStep Radio Telescope');
                            throw new EndOfGame();
                        }
                    }
                    break;

                // id 406, Echoes age 8: X-ray
                case "406N1A":
                    self::executeDrawAndForeshadow($player_id, self::getAuxiliaryValue2());
                    $cards_left = self::getAuxiliaryValue() - 1;
                    if ($cards_left > 0) {
                        self::setAuxiliaryValue($cards_left);
                        self::incrementStep(-1);
                        $step--;
                    }
                    break;            

                // id 410, Echoes age 8: Sliced Bread
                case "410E1A":
                    self::executeDraw($player_id, 8);
                    self::executeDraw($player_id, 8);
                    break;            

                case "410N1A":
                    // "Draw and score two cards of value one less than the value of the card returned."
                    $value_to_score = 1;
                    if ($n > 0) {
                        $value_to_score = $this->innovationGameState->get('age_last_selected') - 1;
                    }
                    self::executeDrawAndScore($player_id, $value_to_score);
                    self::executeDrawAndScore($player_id, $value_to_score);
                    break;     

                // id 413, Echoes age 8: Crossword
                case "413N1A":
                    $age_counts = self::getAuxiliaryArray();
                    $unique_values_left_to_draw = 0;
                    for ($age = 1; $age <= 11; $age++) {
                        if ($age_counts[$age] > 0) {
                            $unique_values_left_to_draw++;
                        }
                    }
                    
                    // Automate the choice if there is no more than one unique bonus value or if the player already has an
                    // Echoes card in hand (the drawing order only matters to allow the player to control which Echoes card they draw)
                    // TODO(LATER): Move this logic to a more generic location so that this is not card-specific.
                    if ($unique_values_left_to_draw <= 1 || self::countCardsInLocation($player_id, 'hand', /*type=*/ 3)) {
                        for ($age = 1; $age <= 11; $age++) {
                            for ($i = 0; $i < $age_counts[$age]; $i++) {
                                self::executeDraw($player_id, $age);
                            }
                        }
                    } else {
                        $step--;
                        self::incrementStep(-1);
                    }
                    break;
                    
                // id 414, Echoes age 8: Television
                case "414N1C":
                    if ($n > 0) {
                        // check for achievement match
                        $achieve_cards = self::countCardsInLocationKeyedByAge(self::getAuxiliaryValue2(), 'achievements', null, /*is_relic*/false);
                        if ($achieve_cards[self::getAuxiliaryValue()] > 0) {
                            // matching achievement value found.
                            self::incrementStepMax(1);
                        }
                    }
                    break;
                    
               // id 415, Echoes age 9: Calculator
                case "415N1A":
                    if ($n == 2) {
                        // "If you scored two"
                        $card_values = self::getAuxiliaryArray();
                        // "and they have a total value less than 11"
                        $total_value = $card_values[0] + $card_values[1];
                        if ($total_value < 11) {
                            // "draw a card of that total value and repeat this dogma effect (once only)."
                            self::executeDraw($player_id, $total_value);
                            self::setAuxiliaryArray(array());
                            self::incrementStepMax(1);
                        }
                    } 
                    break;
                    
                case "415N1B":
                    if ($n == 2) {
                        // "If you scored two"
                        $card_values = self::getAuxiliaryArray();
                        // "and they have a total value less than 11"
                        $total_value = $card_values[0] + $card_values[1];
                        if ($total_value < 11) {
                            // "draw a card of that total value."
                            self::executeDraw($player_id, $total_value);
                        }
                    } 
                    break;                    

                // id 416, Echoes age 9: Laser
                case "416N1A":
                    $number_of_cards_to_return = ceil(self::countCardsInLocation($player_id, 'score') / 2);
                    if ($number_of_cards_to_return == 0) {
                        // "Draw and meld two 10s."
                        self::executeDrawAndMeld($player_id, 10);
                        self::executeDrawAndMeld($player_id, 10);
                    }
                    break;

                case "416N1B":
                    // "Draw and meld two 10s."
                    self::executeDrawAndMeld($player_id, 10);
                    self::executeDrawAndMeld($player_id, 10);
                    break;
                    
                // id 417, Echoes age 9: Helicopter
                case "417N1A":
                    if ($n > 0) {
                        $transferred_card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                        self::transferCardFromTo($transferred_card, $this->innovationGameState->get('owner_last_selected'), 'score', false, /*score_keyword*/false);
                        
                        // Fill the auxiliary array with all eligible cards in hand.
                        $eligible_cards = array();
                        foreach (self::getCardsInHand($player_id) as $card) {
                            // TODO(LATER): It's not clear whether we should be checking for other matching icons too (e.g. bonus icons).
                            for ($icon = 1; $icon <= 7; $icon++) {
                                if (self::hasRessource($card, $icon) && self::hasRessource($transferred_card, $icon)) {
                                    $eligible_cards[] = $card['id'];
                                    break; // only 1 icon needs to be common
                                }
                            }
                        }
                        self::setAuxiliaryArray($eligible_cards);
                    }
                    break;

                case "417N1B":
                    // "If you do, repeat this dogma effect."
                    if ($n > 0) {
                        $step = 0; self::setStep(0); // go back to the first interaction
                    }
                    break;
                    
                // id 418, Echoes age 9: Jet
                case "418E1A":
                    if ($n > 0 && $player_id == $launcher_id) {
                        // Remember which color was melded
                        if ($this->innovationGameState->get('release_version') >= 3) {
                            $colors = self::getAuxiliaryArray();
                            $colors[] = $this->innovationGameState->get('color_last_selected');
                            self::setAuxiliaryArray($colors);
                        } else {
                            self::setAuxiliaryValue($this->innovationGameState->get('color_last_selected'));
                        }
                    }
                    break;

                case "418D1A":
                    if ($n > 0) {
                        self::setIndexedAuxiliaryValue($player_id, $this->innovationGameState->get('color_last_selected'));
                    }
                    break;
                    
                // id 419, Echoes age 9: Credit Card
                case "419N1A":
                    if ($n > 0) { // "if you do, draw and score a card of equal value."
                        self::executeDrawAndScore($player_id, $this->innovationGameState->get('age_last_selected'));
                    }
                    break;

                // id 420, Echoes age 9: Email
                case "420N2A":
                    if ($n > 0) {
                        self::executeNonDemandEffects(self::getCardInfo($this->innovationGameState->get('id_last_selected')));
                    }
                    break;
                    
                // id 421, Echoes age 9: ATM
                case "421E1A":
                    // "Draw and score a card of any value."
                    $card = self::executeDrawAndScore($player_id, self::getAuxiliaryValue());
                    break;

                // id 423, Echoes age 9: Karaoke
                case "423E1A":
                    $card = self::executeDrawAndMeld($player_id, self::getAuxiliaryValue());
                    // Save the card's ID for later
                    if (self::isExecutingAgainDueToEndorsedAction()) {
                        // NOTE: This encoding assumes that highest card ID won't be more than 999. The +1 in the encoding is necessary since the lowest card ID is 0 (not 1).
                        self::setIndexedAuxiliaryValue($player_id, (self::getIndexedAuxiliaryValue($player_id) + 1) * 1000 + $card['id']);
                    } else {
                        self::setIndexedAuxiliaryValue($player_id, $card['id']);
                    }
                    break;

                case "423N1A":
                    // "Execute all of the non-demand dogma effects of the card you melded due to Karaoke's echo effect. Do not share them."
                    // NOTE: This code is only hit when the action is endorsed (otherwise we don't need an interaction to choose which card to execute)
                    self::executeNonDemandEffects(self::getCardInfo(self::getAuxiliaryValue()));
                    break;

                // id 424, Echoes age 9: Rock
                case "424D1A":
                    // "If Scissors is your new top green card, I win!"
                    $top_green_card = self::getTopCardOnBoard($player_id, 2);
                    if ($top_green_card !== null && $top_green_card['id'] == 350) {
                        $card_args = self::getNotificationArgsForCardList([$top_green_card]);
                        self::notifyPlayer($player_id, 'logWithCardTooltips', clienttranslate('${card} is ${your} new top green card.'), array('card' => $card_args, 'card_ids' => [$top_green_card['id']], 'your' => 'your'));
                        self::notifyAllPlayersBut($player_id, 'logWithCardTooltips', clienttranslate('${card} is ${player_name}\'s new top green card.'), array('card' => $card_args, 'card_ids' => [$top_green_card['id']], 'player_name' => self::getColoredPlayerName($player_id)));
                        $this->innovationGameState->set('winner_by_dogma', $launcher_id);
                        self::trace('EOG bubbled from self::stPlayerInvolvedTurn Rock');
                        throw new EndOfGame();
                    }
                    break;

                case "424N1A":
                    // "If Paper is your top green card, you win."
                    $top_green_card = self::getTopCardOnBoard($player_id, 2);
                    if ($top_green_card !== null && $top_green_card['id'] == 30) {
                        $card_args = self::getNotificationArgsForCardList([$top_green_card]);
                        self::notifyPlayer($player_id, 'logWithCardTooltips', clienttranslate('${card} is ${your} top green card.'), array('card' => $card_args, 'card_ids' => [$top_green_card['id']], 'your' => 'your'));
                        self::notifyAllPlayersBut($player_id, 'logWithCardTooltips', clienttranslate('${card} is ${player_name}\'s top green card.'), array('card' => $card_args, 'card_ids' => [$top_green_card['id']], 'player_name' => self::getColoredPlayerName($player_id)));
                        $this->innovationGameState->set('winner_by_dogma', $player_id);
                        self::trace('EOG bubbled from self::stPlayerInvolvedTurn Rock');
                        throw new EndOfGame();
                    }
                    break;

                // id 426, Echoes age 10: Human Genome
                case "426N1A":
                    // "You may draw and score a card of any value."
                    $choice = self::getAuxiliaryValue();
                    if ($choice > 0) {
                        $card = self::executeDrawAndScore($player_id, self::getAuxiliaryValue());
                    }
                    break;
                    
                case "426N1B":
                    // "If the values of all of the cards in your hand match the values of all the cards in your score pile exactly, you win."
                    $hand_card_counts = self::countCardsInLocationKeyedByAge($player_id, 'hand');
                    $score_card_counts = self::countCardsInLocationKeyedByAge($player_id, 'score');
                    $eligible = true;
                    for ($age = 1; $age <= 11; $age++) {
                        if ($hand_card_counts[$age] != $score_card_counts[$age]) {
                            $eligible = false;
                        }
                    }
                    if ($eligible) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have the exact same values in your score pile and in hand.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has the exact same values in his score pile and in hand.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        $this->innovationGameState->set('winner_by_dogma', $player_id); // "You win"
                        self::trace('EOG bubbled from self::stPlayerInvolvedTurn Human Genome');
                        throw new EndOfGame();
                    }
                    else {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} do not have the exact same values in your score pile and hand.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} does not have the exact same values in his score pile and hand.'), array('player_name' => self::getColoredPlayerName($player_id)));                        
                    }
                    break;
                    
                // id 427, Echoes age 10: Camcorder
                case "427D1A":
                    // "Draw a 9!"
                    self::executeDraw($player_id, 9);
                    break;                 

                case "427N1B":
                    // "Draw three 9s."
                    self::executeDraw($player_id, 9);
                    self::executeDraw($player_id, 9);
                    self::executeDraw($player_id, 9);
                    break; 

                // id 430, Echoes age 10: Flash Drive
                case "430N1A":
                    if ($n > 0) { // "if you do"
                        self::incrementStepMax(1);
                    }
                    break;

                // id 432, Echoes age 10: MP3
                case "432N1A":
                    // "For each card returned, claim two standard achievements for which you are eligible."
                    if ($n > 0) {
                        self::incrementStepMax(1);
                        self::setAuxiliaryValue($n * 2);
                    }
                    break;
                    
                case "432N2A":
                    // "Draw and score a card of value equal to a bonus on your board"
                    self::executeDrawAndScore($player_id, self::getAuxiliaryValue());
                    break;  

                // id 433, Echoes age 10: Puzzle Cube
                case "433N1A":
                    if ($n > 0) {
                        self::incrementStepMax(1);
                    }
                    
                    // "If all the colors on your board contain the same number of visible cards (unsplayed = 1), you win."
                    $card_counts = array();
                    for ($color = 0; $color < 5; $color++) {
                        $card_count =  self::countVisibleCards($player_id, $color);
                        if ($card_count > 0) { // ignore the empty piles
                            $card_counts[] = $card_count;
                        }
                    }
                    
                    if (count(array_unique($card_counts)) <= 1) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have the same number of visible cards in every pile on your board.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has the same number of visible cards in every pile on his board.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        $this->innovationGameState->set('winner_by_dogma', $player_id); // "You win"
                        self::trace('EOG bubbled from self::stPlayerInvolvedTurn Puzzle Cube');
                        throw new EndOfGame();
                    }
                    break;

                case "433N1B":                   
                    // "If all the colors on your board contain  the same number of visible cards (unsplayed = 1), you win."
                    $card_counts = array();
                    for ($color = 0; $color < 5; $color++) {
                        $card_count =  self::countVisibleCards($player_id, $color);
                        if ($card_count > 0) { // ignore the empty piles
                            $card_counts[] = $card_count;
                        }
                    }
                    
                    if (count(array_unique($card_counts)) == 1) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have the same number of visible cards in every pile on your board.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has the same number of visible cards in every pile on his board.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        $this->innovationGameState->set('winner_by_dogma', $player_id); // "You win"
                        self::trace('EOG bubbled from self::stPlayerInvolvedTurn Puzzle Cube');
                        throw new EndOfGame();
                    }
                    break;
                    
                // id 434, Echoes age 10: Sudoku
                case "434N1A":
                    // "Draw and meld a card of any value."
                    $card = self::executeDrawAndMeld($player_id, self::getAuxiliaryValue());
                    
                    // "If you have at least nine different bonus values visible on your board, you win."
                    if (count(array_unique(self::getVisibleBonusesOnBoard($player_id))) >= 9) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} have at least nine unique bonues visible on your board.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has at least nine unique bonuses visible on his board.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        $this->innovationGameState->set('winner_by_dogma', $player_id); // "You win"
                        self::trace('EOG bubbled from self::stPlayerInvolvedTurn Sudoku');
                        throw new EndOfGame();                
                    }
                    // "Execute each of the melded card's non-demand dogma effects. Do not share them."
                    self::executeNonDemandEffects($card);
                    break;        

                // id 440, age 11: Climatology
                case "440N1A":
                    
                    $cards_in_score = self::getCardsInLocation($player_id, 'score');
                    
                    $card_ids_to_return = array();
                    foreach ($cards_in_score as $card) {
                        if ($card['age'] >= $this->innovationGameState->get('age_last_selected')) {
                            $card_ids_to_return[] = $card['id'];
                        }
                    }
                    
                    if (count($card_ids_to_return) > 0) {
                        self::incrementStepMax(1);
                        self::setAuxiliaryArray($card_ids_to_return); // store ids for later
                    }
                    break;

                // id 443, age 11: Fusion
                case "443N1A":
                    if($n > 0) { // "If you do, "
                        // "repeat this dogma effect using a value one or two lower."
                        $last_card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                        $age_last_selected = $last_card['age'];
                        $card_ids_to_score = array();
                        $top_cards = self::getTopCardsOnBoard($player_id);
                        $upper_age = $age_last_selected - 1;
                        $lower_age = $age_last_selected - 2;
                        
                        foreach ($top_cards as $card) {
                            if ($card['age'] == $upper_age || $card['age'] == $lower_age) {
                                $card_ids_to_score[] = $card['id'];
                            }
                        }
                        if (count($card_ids_to_score) > 0) {
                            self::setStep(0); $step=0;
                            self::setAuxiliaryArray($card_ids_to_score);
                        } else {
                            self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no cards of value ${lower_age} or ${upper_age} on your board.'), array('You' => 'You', 'lower_age' => self::getAgeSquare($lower_age), 'upper_age' => self::getAgeSquare($upper_age)));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no cards of value ${lower_age} or ${upper_age} on their board.'), array('player_name' => self::getColoredPlayerName($player_id), 'lower_age' => self::getAgeSquare($lower_age), 'upper_age' => self::getAgeSquare($upper_age)));                                 
                        }
                    }
                    break;
                
                // id 444, age 11: Hypersonics
                case "444D1B":
                    if ($n > 0) { // "if you do"
                        // TODO(4E): There might be a Battleship Yamato bug here which could be solved with a faceup_age_last_selected global variable.
                        $returned_age = $this->innovationGameState->get('age_last_selected');

                        $hand_cards = self::getCardsInHand($player_id);
                        $cards_to_return = array();
                        foreach ($hand_cards as $card) {
                            if ($card['age'] <= $returned_age) {
                                $cards_to_return[] = $card['id'];
                            }
                        }

                        $score_cards = self::getCardsInScorePile($player_id);
                        foreach ($score_cards as $card) {
                            if ($card['age'] <= $returned_age) {
                                $cards_to_return[] = $card['id'];
                            }
                        }
                        if (count($cards_to_return) > 0) {
                            self::incrementStepMax(1);
                            self::setAuxiliaryArray($cards_to_return);
                        } else {
                            self::notifyPlayer($player_id, 'log', clienttranslate('${You} have no cards of value ${age} or less in your hand or score pile.'),  
                                array('You' => 'You', 'age' => self::getAgeSquare($returned_age)));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has no cards of value ${age} or less in his hand or score pile.'), 
                                array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($returned_age)));
                        }
                    }
                    break;

                // id 446, age 11: Near-Field Comm
                case "446N1A":
                    // "Reveal the highest card in your score pile and execute its non-demand dogma effects. Do not share them."
                    if ($n > 0) {
                        $card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                        self::executeNonDemandEffects($card);
                    }
                    break;

                // id 448, age 11: Escapism
                case "448N1A":
                    // "and execute its non-demand dogma effects. Do not share them."
                    if ($n > 0) {
                        $card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                        self::setAuxiliaryValue($card['age']);
                        self::executeNonDemandEffects($card);
                    }
                    break;

                case "448N1+A":
                    // "Draw three cards of that value."
                    $age = self::getAuxiliaryValue();
                    self::executeDraw($player_id, $age);
                    self::executeDraw($player_id, $age);
                    self::executeDraw($player_id, $age);
                    break;
                    
                // id 449, age 11: Whataboutism
                case "449D1A":
                    if ($n > 0) { // "if you do"
                        // "exchange all cards in your score pile with all cards in my score pile!"
                        $launcher_score_cards = self::getCardsInScorePile($launcher_id);
                        $player_score_cards = self::getCardsInScorePile($player_id);
                        foreach ($launcher_score_cards as $card) {
                            self::transferCardFromTo($card, $player_id, 'score');
                        }
                        foreach ($player_score_cards as $card) {
                            self::transferCardFromTo($card, $launcher_id, 'score');
                        }
                    }
                    break;


                }
                
            } catch (EndOfGame $e) {
                // End of the game: the exception has reached the highest level of code
                self::trace('EOG bubbled from self::stInterInteractionStep');
                self::trace('interInteractionStep->justBeforeGameEnd');
                $this->gamestate->nextState('justBeforeGameEnd');
                return;
            }
        }

        // There won't be any nested card state if a player is returning cards after the Search icon was triggered.
        if ($nested_card_state == null) {
            self::trace('interInteractionStep->digArtifact');
            $this->gamestate->nextState('digArtifact');
            return;
        }

        if ($step == self::getStepMax()) { // The last step has been completed
            // End of the turn for the player involved
            self::trace('interInteractionStep->interPlayerInvolvedTurn');
            $this->gamestate->nextState('interPlayerInvolvedTurn');
            return;
        }
        // New interaction step
        self::incrementStep(1);
        self::trace('interInteractionStep->interactionStep');
        $this->gamestate->nextState('interactionStep');
    }
    
    function stPreSelectionMove() {
        $special_type_of_choice = $this->innovationGameState->get('special_type_of_choice');
        $can_pass = $this->innovationGameState->get('can_pass') == 1;

        if ($special_type_of_choice == 0) {
            $selection_size = self::countSelectedCards();
            $cards_chosen_so_far = $this->innovationGameState->get('n');
            $n_min = $this->innovationGameState->get('n_min');
            $n_max = $this->innovationGameState->get('n_max');
            $splay_direction = $this->innovationGameState->get('splay_direction');
            $enable_autoselection = $this->innovationGameState->get('enable_autoselection') == 1;
            $owner_from = $this->innovationGameState->get('owner_from');
            $location_from = self::decodeLocation($this->innovationGameState->get('location_from'));
            $location_to = self::decodeLocation($this->innovationGameState->get('location_to'));
            $bottom_to = $this->innovationGameState->get('bottom_to');
            $colors = $this->innovationGameState->getAsArray('color_array');
            $with_icon = $this->innovationGameState->get('with_icon');
            $without_icon = $this->innovationGameState->get('without_icon');
            $with_bonus = $this->innovationGameState->get('with_bonus');
            $without_bonus = $this->innovationGameState->get('without_bonus');
            $card_id_returning_to_unique_supply_pile = $location_to == 'deck' || $location_to == 'revealed,deck' ? self::getSelectedCardIdBelongingToUniqueSupplyPile(self::getSelectedCards()) : null;
            $card_id_with_unique_color = $location_to == 'board' ? self::getSelectedCardIdWithUniqueColor(self::getSelectedCards()) : null;

            $nested_card_state = self::getCurrentNestedCardState();

            // There won't be any nested card state if a player is returning cards after the Search icon was triggered.
            if ($nested_card_state == null) {
                $code = null;
            } else {
                $card_id = $nested_card_state['card_id'];
                $current_effect_type = $nested_card_state['current_effect_type'];
                $current_effect_number = $nested_card_state['current_effect_number'];
                $step = self::getStep();
                $code = self::getCardExecutionCodeWithLetter($card_id, $current_effect_type, $current_effect_number, $step);
            }

            // Special automation case for Periodic Table (it's broken into two interactions only because the choice is sometimes complex)
            if ($code == '175N1A' && $selection_size == 2) {
                $card = self::getSelectedCards()[0];
                $this->innovationGameState->set('id_last_selected', $card['id']);
                self::unmarkAsSelected($card['id']);
                self::trace('preSelectionMove->interSelectionMove (Periodic Table automation)');
                $this->gamestate->nextState('interSelectionMove');
                return;
            }

            // TODO(FIGURES): Figure out if we need to make any updates to this logic.
            $num_cards_in_location_from = self::countCardsInLocation($owner_from, $location_from);
            $selection_will_reveal_hidden_information =
                // The player making the decision has hiddden information about the card(s) that other players do not have.
                ($location_from == 'hand' || $location_from == 'score' || $location_from == 'forecast') &&
                // All players can see the number of cards (even in hidden locations) so if there aren't any cards there
                // it's obvious a selection can't be made.
                $num_cards_in_location_from > 0 &&
                // Player is forced to choose a card based on a hidden property (e.g. color or icons). There are
                // other hidden properties (has_demand_effect, icon_hash_X) that aren't included here because there
                // are currently no cards where this would actually matter.
                ($colors != array(0, 1, 2, 3, 4) || $with_icon > 0 || $without_icon > 0 || $with_bonus > 0 || $without_bonus > 0);

            // If all cards from the location must be chosen, then it doesn't matter if the information is hidden or not. It will soon come to light.
            if (($cards_chosen_so_far == 0 && $num_cards_in_location_from <= $n_max && !$can_pass) || ($cards_chosen_so_far > 0 && $n_min >= $num_cards_in_location_from)) {
                $selection_will_reveal_hidden_information = false;
            }
            
            // There is no selectable card
            if ($selection_size == 0) {
                
                if (($splay_direction == -1 && ($can_pass || $n_min <= 0)) && ($selection_will_reveal_hidden_information || !$enable_autoselection)) {
                    // The player can pass or stop and the opponents can't know that the player has no eligible card
                    // This can happen for example in the Masonry effect
                    
                    // No automatic pass or stop: the only choice the player will have in client side is to pass/stop
                    // This way the other players won't get the information that the player was forced to pass/stop
                    self::trace('preSelectionMove->selectionMove (player has to pass)');
                    $this->gamestate->nextState('selectionMove');
                    return;
                }
                
                // The player passes or stops automatically
                self::notifyNoSelectableCards();
                self::trace('preSelectionMove->interInteractionStep (no card)');
                $this->gamestate->nextState('interInteractionStep');
                return;

            // All selectable cards must be chosen
            } else if ($enable_autoselection
                    // Make sure choosing these cards won't reveal hidden information (unless all cards in that location need to be chosen anyway)
                    && (!$selection_will_reveal_hidden_information || self::countCardsInLocation($owner_from, $location_from) <= $selection_size)
                    // The player must choose at least all of the selectable cards
                    && (($cards_chosen_so_far == 0 && !$can_pass && $selection_size <= $n_min) || ($cards_chosen_so_far > 0 && $n_min >= $selection_size))
                    // If there's more than one selectable card, only automate the choices if the order does not matter
                    && ($selection_size == 1 || ($location_to != 'board' && $location_to != 'deck' && $location_to != 'revealed,deck'))) {
                // A card is chosen automatically for the player
                $card = self::getSelectedCards()[0];
                // Simplified version of self::choose()
                $this->innovationGameState->set('id_last_selected', $card['id']);
                self::unmarkAsSelected($card['id']);
                $this->innovationGameState->set('can_pass', 0);

                self::trace('preSelectionMove->interSelectionMove (automated card selection)');
                $this->gamestate->nextState('interSelectionMove');
                return;
            // Try to return cards to the deck where the order doesn't matter
            } else if ($enable_autoselection
                    // Make sure choosing these cards won't reveal hidden information
                    && (!$selection_will_reveal_hidden_information)
                    // The player must choose at least all of the selectable cards
                    && (($cards_chosen_so_far == 0 && !$can_pass && $selection_size <= $n_min) || ($cards_chosen_so_far > 0 && $n_min >= $selection_size))
                    // There must be at least one card which goes to a unique supply pile
                    && $card_id_returning_to_unique_supply_pile != null
                    // The cards are coming from anywhere but the board
                    // TODO(LATER): Extend this automation to the board once the special achievement check is moved to the end of the action.
                    && $location_from != 'board') {
                $this->innovationGameState->set('id_last_selected', $card_id_returning_to_unique_supply_pile);
                self::unmarkAsSelected($card_id_returning_to_unique_supply_pile);
                $this->innovationGameState->set('can_pass', 0);

                self::trace('preSelectionMove->interSelectionMove (automated card selection)');
                $this->gamestate->nextState('interSelectionMove');
                return;
            // Try to tuck cards to the deck where the order doesn't matter
            } else if ($enable_autoselection
                    // Make sure choosing these cards won't reveal hidden information
                    && (!$selection_will_reveal_hidden_information)
                    // The player must choose at least all of the selectable cards
                    && (($cards_chosen_so_far == 0 && !$can_pass && $selection_size <= $n_min) || ($cards_chosen_so_far > 0 && $n_min >= $selection_size))
                    // The cards are being tucked
                    // TODO(LATER): Extend this automation to melding once the special achievement check is moved to the end of the action.
                    && $bottom_to > 0
                    // There must be at least one card which has a unique color
                    && $card_id_with_unique_color != null) {
                $this->innovationGameState->set('id_last_selected', $card_id_with_unique_color);
                self::unmarkAsSelected($card_id_with_unique_color);
                $this->innovationGameState->set('can_pass', 0);

                self::trace('preSelectionMove->interSelectionMove (automated card selection)');
                $this->gamestate->nextState('interSelectionMove');
                return;
            // There are selectable cards, but not enough to fulfill the requirement ("May effects only")
            } else if ($n_min < 800 && $selection_size < $n_min) {
                if ($this->innovationGameState->get('solid_constraint') == 1) {
                    self::notifyGeneralInfo(clienttranslate("There are not enough cards to fulfill the condition."));
                    self::deselectAllCards();
                    self::trace('preSelectionMove->interInteractionStep (not enough cards)');
                    $this->gamestate->nextState('interInteractionStep');
                    return;
                } else {
                    // Reduce n_min and n_max to the selection size
                    $this->innovationGameState->set('n_min', $selection_size);
                    $this->innovationGameState->set('n_max', $selection_size);
                }

            // Reduce n_max to the selection size (Globe is an exception because it would reveal hidden info)
            } else if ($n_max < 800 && $selection_size < $n_max && !$selection_will_reveal_hidden_information) {
                $this->innovationGameState->set('n_max', $selection_size);
            }
        } else if ($special_type_of_choice == 3) { // choose_value
            $age_array = $this->innovationGameState->getAsArray('age_array');
            // Automatically choose the value if there's only one option (and passing isn't allowed)
            if (count($age_array) == 1 && !$can_pass) {
                $this->innovationGameState->set('choice', $age_array[0]);
                self::trace('preSelectionMove->interSelectionMove (only one value)');
                $this->gamestate->nextState('interSelectionMove');
                return;
            }
        } else if ($special_type_of_choice == 4) { // choose_color
            $color_array = $this->innovationGameState->getAsArray('color_array');
            // Automatically choose the color if there's only one option (and passing isn't allowed)
            if (count($color_array) == 1 && !$can_pass) {
                $this->innovationGameState->set('choice', $color_array[0]);
                self::trace('preSelectionMove->interSelectionMove (only one color)');
                $this->gamestate->nextState('interSelectionMove');
                return;
            }
        } else if ($special_type_of_choice == 10) { // choose_player
            $player_array = $this->innovationGameState->getAsArray('player_array');
            // Automatically choose the player if there's only one option (and passing isn't allowed)
            if (count($player_array) == 1 && !$can_pass) {
                $this->innovationGameState->set('choice', self::playerNoToPlayerId($player_array[0]));
                self::trace('preSelectionMove->interSelectionMove (only one player)');
                $this->gamestate->nextState('interSelectionMove');
                return;
            }
        }

        // Let the player make his choice
        self::trace('preSelectionMove->selectionMove');
        $this->gamestate->nextState('selectionMove');
    }

    function getSelectedCardIdBelongingToUniqueSupplyPile() {
        return self::getUniqueValueFromDB("
            SELECT
                id
            FROM
                card AS a
            LEFT JOIN(
                SELECT
                    COUNT(*) AS size, age, type, is_relic
                FROM
                    card
                WHERE
                    selected
                GROUP BY
                    age, type, is_relic
            ) AS b
            ON
                a.age = b.age AND a.type = b.type AND a.is_relic = b.is_relic
            WHERE
                selected AND b.size = 1
            ORDER BY
                a.location, a.age, a.type, a.is_relic, a.position
            LIMIT 1
        ");
    }

    function getSelectedCardIdWithUniqueColor() {
        return self::getUniqueValueFromDB("
            SELECT
                id
            FROM
                card AS a
            LEFT JOIN(
                SELECT
                    COUNT(*) AS size, color
                FROM
                    card
                WHERE
                    selected
                GROUP BY
                    color
            ) AS b
            ON
                a.color = b.color
            WHERE
                selected AND b.size = 1
            ORDER BY
                a.location, a.color, a.position
            LIMIT 1
        ");
    }
    
    function stInterSelectionMove() {
        $player_id = self::getCurrentPlayerUnderDogmaEffect();
        $special_type_of_choice = $this->innovationGameState->get('special_type_of_choice');
        if ($special_type_of_choice == 0) { // The player had to choose a card
            $selected_card_id = $this->innovationGameState->get('id_last_selected');
            if ($selected_card_id == -1) {
                // The player passed or stopped
                if ($this->innovationGameState->get('can_pass') == 1) {
                    self::notifyPass($player_id);
                }
                // Unset the selection
                self::deselectAllCards();
                self::trace('interSelectionMove->interInteractionStep');
                $this->gamestate->nextState('interInteractionStep');
                return;
            }
            
            // The player has chosen one card
            $card = self::getCardInfo($selected_card_id);
            
            // Flags
            $owner_to = $this->innovationGameState->get('owner_to');
            $location_to = self::decodeLocation($this->innovationGameState->get('location_to'));
            $bottom_to = $this->innovationGameState->get('bottom_to');
            $score_keyword = $this->innovationGameState->get('score_keyword') == 1;
            
            $splay_direction = $this->innovationGameState->get('splay_direction'); // -1 if that was not a choice for splay
        }
        else { // The player had to make a special choice
            $choice = $this->innovationGameState->get('choice');
            if ($choice == -2) {
                // The player passed
                self::notifyPass($player_id);
                self::trace('interSelectionMove->interInteractionStep');
                $this->gamestate->nextState('interInteractionStep');
                return;
            }
        }
        
        $launcher_id = self::getLauncherId();
        $nested_card_state = self::getCurrentNestedCardState();

        // There won't be any nested card state if a player is returning cards after the Search icon was triggered.
        if ($nested_card_state == null) {
            $code = null;
        } else {
            $card_id = $nested_card_state['card_id'];
            $current_effect_type = $nested_card_state['current_effect_type'];
            $current_effect_number = $nested_card_state['current_effect_number'];
            $step = self::getStep();
            $code = self::getCardExecutionCodeWithLetter($card_id, $current_effect_type, $current_effect_number, $step);
        }
        
        $crown = self::getIconSquare(1);
        $leaf = self::getIconSquare(2);
        $lightbulb = self::getIconSquare(3);
        $tower = self::getIconSquare(4);
        $factory = self::getIconSquare(5);
        $clock = self::getIconSquare(6);
        
        try {
            switch($code) {
            // The first number is the id of the card
            // D1 means the first (and single) I demand effect
            // C1 means the first (and single) I compel effect
            // N1 means the first non-demand effect
            // N2 means the second non-demand effect
            // N3 means the third non-demand effect
            // E1 means the first (and single) echo effect
            
            // The letter indicates the step : A for the first one, B for the second
            
            // Default behaviour: make the transfer or the splay as stated in B
            
            // id 18, age 2: Road building
            case "18N1B":
                // $choice is the chosen player id
                $top_red_card = self::getTopCardOnBoard($player_id, 1);
                self::transferCardFromTo($top_red_card, $choice, 'board'); // "Transfer your top red card to another's player's board"
                $top_green_card = self::getTopCardOnBoard($choice, 2);
                if ($top_green_card !== null) {
                    self::transferCardFromTo($top_green_card, $player_id, 'board'); // "Transfer that player's top green card to your board"
                }
                else {
                    self::notifyPlayer($choice, 'log', clienttranslate('${You} have no top green card on your board.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($choice, 'log', clienttranslate('${player_name} has no top green card on his board.'), array('player_name' => self::getColoredPlayerName($choice)));
                }
                break;
                
            // id 19, age 2: Currency
            case "19N1A":
                $different_values_selected_so_far = self::getAuxiliaryValueAsArray();
                if (!in_array($card['age'], $different_values_selected_so_far)) { // The player choose to return a card of a new value
                    $different_values_selected_so_far[] = $card['age'];
                    self::setAuxiliaryValueFromArray($different_values_selected_so_far);
                }
                // Do the transfer as stated in B (return)
                self::transferCardFromTo($card, $owner_to, $location_to, $bottom_to, $score_keyword);
                break;
            
            // id 21, age 2: Canal building         
            case "21N1A":
                // $choice is yes or no
                if ($choice == 0) { // No exchange
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} decide not to exchange.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} decides not to exchange.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                else { // "Exchange all the highest cards in your hand with all the highest cards in your score pile"
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} decide to exchange.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} decides to exchange.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    
                    // Get highest cards in hand and highest cards in score
                    $ids_of_highest_cards_in_hand = self::getIdsOfHighestCardsInLocation($player_id, 'hand');
                    $ids_of_highest_cards_in_score = self::getIdsOfHighestCardsInLocation($player_id, 'score');

                    // Make the transfers
                    foreach($ids_of_highest_cards_in_score as $id) {
                        $card = self::getCardInfo($id);
                        self::transferCardFromTo($card, $player_id, 'hand');
                    }
                    foreach($ids_of_highest_cards_in_hand as $id) {
                        $card = self::getCardInfo($id);
                        self::transferCardFromTo($card, $player_id, 'score'); // Note: this has no score keyword 
                    }
                }
                break;
            
            // id 28, age 3: Optics        
            case "28N1A":
                // Nothing to do but to go to the next step
                break;
                
            // id 32, age 3: Medicine
            case "32D1A":
                // Delay the transfer: this way the launcher can not choose the card he would just receive
                self::setAuxiliaryValue($card['id']);
                break;
            
            // id 50, age 5: Measurement
            case "50N1B":
                // $choice is a color
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color}.'), array('i18n' => array('color'), 'You' => 'You', 'color' => self::getColorInClear($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color}.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($choice)));
                self::splayRight($player_id, $player_id, $choice); // "Splay that color of your cards right"
                $number_of_cards = self::countCardsInLocationKeyedByColor($player_id, 'board')[$choice];
                if ($number_of_cards == 1) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} ${colored} card.'), array('i18n' => array('n', 'colored'), 'You' => 'You', 'n' => self::getTranslatedNumber($number_of_cards), 'colored' => self::getColorInClear($choice)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has  ${n} ${colored} card.'), array('i18n' => array('n', 'colored'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => self::getTranslatedNumber($number_of_cards), 'colored' => self::getColorInClear($choice)));
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} have ${n} ${colored_cards}.'), array('i18n' => array('n', 'colored_cards'), 'You' => 'You', 'n' => self::getTranslatedNumber($number_of_cards), 'colored_cards' => self::getColorInClearWithCards($choice)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} has  ${n} ${colored_cards}.'), array('i18n' => array('n', 'colored_cards'), 'player_name' => self::getColoredPlayerName($player_id), 'n' => self::getTranslatedNumber($number_of_cards), 'colored_cards' => self::getColorInClearWithCards($choice)));
                }
                self::executeDraw($player_id, $number_of_cards); // "Draw a card of value equal to the number of cards of that color on your board"
                break;
                
            // id 61, age 6: Canning
            case "61N1A":
                // $choice is yes or no
                if ($choice == 0) { // No tuck
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} decide not to tuck.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} decides not to tuck.'), array('player_name' => self::getColoredPlayerName($player_id)));
                } else { // Draw and tuck
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} decide to tuck.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} decides to tuck.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    
                    self::executeDrawAndTuck($player_id, 6); // "Draw and tuck a 6"
                    
                    // Make the transfers
                    for ($color = 0; $color < 5; $color++) {
                        $card = self::getTopCardOnBoard($player_id, $color);
                        if ($card !== null && !self::hasRessource($card, 5)) {
                            self::scoreCard($card, $player_id); // "Score all your top cards without a factory"
                        }
                    }
                }
                break;
            
            // id 65, age 7: Evolution          
            case "65N1A":
                if ($choice == 0) { // Draw
                    self::executeDraw($player_id, self::getMaxAgeInScore($player_id) + 1); // "Draw a card of one value higher than the highest card in your score pile"
                }
                else { // Draw and score, then return
                    self::executeDraw($player_id, 8, 'score'); // "Draw and score a 8"
                    self::incrementStepMax(1);
                }
                break;
                
            // id 66, age 7: Publications          
            case "66N1A":
                // All was done before
                break;
            
            // id 67, age 7: Bicycle         
            case "69N1A":
                // $choice is yes or no
                if ($choice == 0) { // No exchange
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} decide not to exchange.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} decides not to exchange.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                else { // "Exchange all the cards in your hand with all the cards in your score pile"
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} decide to exchange.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} decides to exchange.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    
                    // Get all in hand and all cards in score
                    $ids_of_cards_in_hand = self::getIdsOfCardsInLocation($player_id, 'hand');
                    $ids_of_cards_in_score = self::getIdsOfCardsInLocation($player_id, 'score');

                    // Make the transfers
                    foreach($ids_of_cards_in_score as $id) {
                        $card = self::getCardInfo($id);
                        self::transferCardFromTo($card, $player_id, 'hand');
                    }
                    foreach($ids_of_cards_in_hand as $id) {
                        $card = self::getCardInfo($id);
                        self::transferCardFromTo($card, $player_id, 'score'); // Nota: this has no score keyword 
                    }
                }
                break;
                
            // id 72, age 7: Sanitation
            case "72D1A":
                // Delay the transfer: this way the player can not choose the card he would just receive
                self::setAuxiliaryValue($card['id']);
                break;
            
            // id 73, age 7: Lighting
            case "73N1A":
                $different_values_selected_so_far = self::getAuxiliaryValueAsArray();
                if (!in_array($card['age'], $different_values_selected_so_far)) { // The player choose to tuck a card of a new value
                    $different_values_selected_so_far[] = $card['age'];
                    self::setAuxiliaryValueFromArray($different_values_selected_so_far);
                }
                // Do the transfer as stated in B (tuck)
                self::transferCardFromTo($card, $owner_to, $location_to, $bottom_to, $score_keyword);
                break;
            
            // id 80, age 8, Mass media
            case "80N1B":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;
                
            // id 81, age 8: Antibiotics
            case "81N1A":
                $different_values_selected_so_far = self::getAuxiliaryValueAsArray();
                if (!in_array($card['age'], $different_values_selected_so_far)) { // The player choose to return a card of a new value
                    $different_values_selected_so_far[] = $card['age'];
                    self::setAuxiliaryValueFromArray($different_values_selected_so_far);
                }
                // Do the transfer as stated in B (tuck)
                self::transferCardFromTo($card, $owner_to, $location_to, $bottom_to, $score_keyword);
                break;
            
            // id 83, age 8: Empiricism     
            case "83N1A":
                // $choice was two colors
                $colors = Arrays::getValueAsArray($choice);
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color_1} and ${color_2}.'), array('i18n' => array('color_1', 'color_2'), 'You' => 'You', 'color_1' => self::getColorInClear($colors[0]), 'color_2' => self::getColorInClear($colors[1])));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color_1} and ${color_2}.'), array('i18n' => array('color_1', 'color_2'), 'player_name' => self::getColoredPlayerName($player_id), 'color_1' => self::getColorInClear($colors[0]), 'color_2' => self::getColorInClear($colors[1])));
                
                $card = self::executeDraw($player_id, 9, 'revealed'); // "Draw and reveal a 9"
                if ($card['color'] <> $colors[0] && $card['color'] <> $colors[1]) {
                    self::notifyGeneralInfo(clienttranslate('It does not match any of the chosen colors.'));
                    self::transferCardFromTo($card, $player_id, 'hand'); // (Implicit) "Keep it in your hand"
                }
                else { // "If it is either of the colors you chose"
                    self::notifyGeneralInfo(clienttranslate('It matches a chosen color: ${color}.'), array('i18n' => array('color'), 'color' => self::getColorInClear($card['color'])));
                    self::transferCardFromTo($card, $player_id, 'board'); // "Meld it"
                    self::setAuxiliaryValue($card['color']); // Flag the sucessful colors
                    self::incrementStepMax(1);
                }
                break;
            
            // id 84, age 8: Socialism     
            case "84N1A":
                if ($card['color'] == 4 /* purple*/) { // A purple card has been tucked
                    self::setAuxiliaryValue(1); // Flag that
                }
                // Do the transfer as stated in B (tuck)
                self::transferCardFromTo($card, $owner_to, $location_to, $bottom_to, $score_keyword);
                break;
            
            // id 100, age 10: Self service
            case "100N1A":
                self::executeNonDemandEffects($card); // The player chose this card for execution
                break;
            
            // id 102, age 10: Stem cells 
            case "102N1A":
                // $choice is yes or no
                if ($choice == 0) { // No scoring
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} decide not to score the cards in your hand.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} decides not to score the cards in his hand.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                else { // "Score all cards from your hand"
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} decide to score the cards in your hand.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} decides to score the cards in his hand.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    
                    // Get all cards in hand
                    $ids_of_cards_in_hand = self::getIdsOfCardsInLocation($player_id, 'hand');

                    // Make the transfers
                    foreach($ids_of_cards_in_hand as $id) {
                        $card = self::getCardInfo($id);
                        self::scoreCard($card, $player_id);
                    }
                }                
                break;

            // id 114, Artifacts age 1: Papyrus of Ani
            case "114N1B":
                // "Reveal a card of of any type of value two higher"
                $age_to_draw_in = $this->innovationGameState->get('age_last_selected') + 2;
                $card = self::executeDraw($player_id, $age_to_draw_in, 'revealed', /*bottom_to=*/ false, /*type=*/ $choice);
                if ($card['color'] == 4) { // "If the drawn card is purple"
                    self::transferCardFromTo($card, $player_id, 'board'); // "Meld it"
                    self::executeNonDemandEffects($card); // "Execute each of its non-demand effects. Do not share them."
                    break;
                } else {
                    // Non-purple card is placed in the hand
                    self::transferCardFromTo($card, $player_id, 'hand');
                }
                break;
            
            // id 122, Artifacts age 1: Mask of Warka
            case "122N1A":
                $color_in_clear = self::getColorInClear($choice);
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color}.'), array('i18n' => array('color'), 'You' => 'You', 'color' => $color_in_clear));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color}.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => $color_in_clear));
                self::setAuxiliaryValue($choice);

                // "Each player reveals all cards of that color from their hand"
                $player_revealed_cards = false;
                $other_players_revealed_cards = false;
                $player_ids = self::getActivePlayerIdsInTurnOrderStartingWithCurrentPlayer();
                foreach ($player_ids as $id) {
                    self::revealHand($id);
                    $num_cards = self::countCardsInLocationKeyedByColor($id, 'hand')[$choice];
                    self::notifyPlayer($id, 'log', clienttranslate('${You} revealed ${n} ${color} card(s).'), array('i18n' => array('n', 'color'), 'You' => 'You', 'color' => $color_in_clear, 'n' => self::getTranslatedNumber($num_cards)));
                    self::notifyAllPlayersBut($id, 'log', clienttranslate('${player_name} revealed ${n} ${color} card(s).'), array('i18n' => array('n', 'color'), 'player_name' => self::getColoredPlayerName($id), 'color' => $color_in_clear, 'n' => self::getTranslatedNumber($num_cards)));
                    if ($num_cards > 0) {
                        if ($id == $player_id) {
                            $player_revealed_cards = true;
                        } else {
                            $other_players_revealed_cards = true;
                        }
                    }
                }

                // "If you are the only player to reveal cards, return them"
                if ($player_revealed_cards && !$other_players_revealed_cards) {
                    $this->notifyPlayer($player_id, 'log', clienttranslate('No other player revealed a ${color} card.'), ['i18n' => ['color'], 'color' => self::getColorInClear($choice)]);
                    $this->notifyAllPlayersBut($player_id, 'log', clienttranslate('No player other than ${player_name} revealed a ${color} card.'), ['i18n' => ['color'], 'color' => self::getColorInClear($choice), 'player_name' => self::getPlayerNameFromId($player_id)]);
                    self::incrementStepMax(1);
                } else if ($player_revealed_cards && $other_players_revealed_cards) {
                    $this->notifyGeneralInfo(clienttranslate('More than one player revealed a ${color} card.'), ['i18n' => ['color'], 'color' => self::getColorInClear($choice)]);
                } else {
                    $this->notifyPlayer($player_id, 'log', clienttranslate('${You} did not reveal a ${color} card.'), ['i18n' => ['color'], 'color' => self::getColorInClear($choice), 'You' => 'You']);
                    $this->notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} did not reveal a ${color} card.'), ['i18n' => ['color'], 'color' => self::getColorInClear($choice), 'player_name' => self::getPlayerNameFromId($player_id)]);
                }
                break;

            case "122N1B":
                $different_values_selected_so_far = self::getAuxiliaryValue2AsArray();
                if (!in_array($card['age'], $different_values_selected_so_far)) { // The player choose to return a card of a new value
                    $different_values_selected_so_far[] = $card['age'];
                    self::setAuxiliaryValue2FromArray($different_values_selected_so_far);
                }
                // Do the transfer as stated in B (return)
                self::transferCardFromTo($card, $owner_to, $location_to, $bottom_to, $score_keyword);
                break;
            
            // id 124, Artifacts age 1: Tale of the Shipwrecked Sailor
            case "124N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color}.'), array('i18n' => array('color'), 'You' => 'You', 'color' => self::getColorInClear($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color}.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($choice)));
                self::setAuxiliaryValue($choice);
                break;
            
            // id 126, Artifacts age 2: Rosetta Stone
            case "126N1A":
                // "Draw two 2s of that type"
                $this->innovationGameState->set('card_id_1', self::executeDraw($player_id, 2, 'hand', /*bottom_to=*/ false, /*type=*/ $choice)['id']);
                $this->innovationGameState->set('card_id_2', self::executeDraw($player_id, 2, 'hand', /*bottom_to=*/ false, /*type=*/ $choice)['id']);
                break;

            case "126N1C":
                // "Transfer the other to an opponent's board"
                $card_1 = self::getCardInfo($this->innovationGameState->get('card_id_1'));
                $card_2 = self::getCardInfo($this->innovationGameState->get('card_id_2'));
                $remaining_card = $card_1['location'] == 'hand' ? $card_1 : $card_2;
                self::transferCardFromTo($remaining_card, $choice, 'board');
                break;

            // id 130, Artifacts age 1: Baghdad Battery
            case "130N1A":
                if (self::getAuxiliaryValue() == -1) {
                    // Log the card that is melded first
                    $card_id = $this->innovationGameState->get('id_last_selected');
                    self::setAuxiliaryValue($card_id);
                    self::transferCardFromTo(self::getCardInfo($card_id), $player_id, 'board');
                } else {
                    // If you melded two of the same color and they are of different types
                    $first_card = self::getCardInfo(self::getAuxiliaryValue());
                    $second_card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                    self::transferCardFromTo($second_card, $player_id, 'board');
                    if ($first_card['type'] == $second_card['type']) {
                        self::notifyPlayer($player_id, 'log', clienttranslate('${You} chose cards from the same card set.'), array('You' => 'You'));
                        self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chose cards from the same card set.'), array('player_name' => self::getColoredPlayerName($player_id)));
                    } else {
                        if ($first_card['color'] == $second_card['color']) {
                            // "Draw and score five 2s"
                            for ($i = 1; $i <= 5; $i++) {
                                self::executeDraw($player_id, 2, 'score');
                            }
                        } else {
                            self::notifyPlayer($player_id, 'log', clienttranslate('${You} chose different colors.'), array('You' => 'You'));
                            self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chose different colors.'), array('player_name' => self::getColoredPlayerName($player_id)));
                        }
                    }
                }
                break;

            // id 147, Artifacts age 4: East India Company Charter
            case "147N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;

            // id 152, Artifacts age 5: Mona Lisa
            case "152N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color}.'), array('i18n' => array('color'), 'You' => 'You', 'color' => self::getColorInClear($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color}.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($choice)));
                self::setAuxiliaryValue2($choice);
                break;

            case "152N1B":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the number ${n}.'), array('You' => 'You', 'n' => $choice));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the number ${n}.'), array('player_name' => self::getColoredPlayerName($player_id), 'n' => $choice));
                self::setAuxiliaryValue($choice);
                break;

            // id 157, Artifacts age 5: Bill of Rights
            case "157C1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color}.'), array('i18n' => array('color'), 'You' => 'You', 'color' => self::getColorInClear($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color}.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($choice)));
                self::setAuxiliaryValue($choice);
                break;
            
            // id 158, Artifacts age 5: Ship of the Line Sussex
            case "158N1B":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color}.'), array('i18n' => array('color'), 'You' => 'You', 'color' => self::getColorInClear($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color}.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($choice)));
                self::setAuxiliaryValue($choice);
                break;
            
            // id 162, Artifacts age 5: The Daily Courant
            case "162N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;
            
            // id 170, Artifacts age 6: Buttonwood Agreement
            case "170N1A":
                $colors = Arrays::getValueAsArray($choice);
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color_1}, ${color_2}, and ${color_3}.'), array(
                    'i18n' => array('color_1', 'color_2', 'color_3'),
                    'You' => 'You',
                    'color_1' => self::getColorInClear($colors[0]),
                    'color_2' => self::getColorInClear($colors[1]),
                    'color_3' => self::getColorInClear($colors[2]))
                );
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color_1}, ${color_2}, and ${color_3}.'), array(
                    'i18n' => array('color_1', 'color_2', 'color_3'),
                    'player_name' => self::getColoredPlayerName($player_id),
                    'color_1' => self::getColorInClear($colors[0]),
                    'color_2' => self::getColorInClear($colors[1]),
                    'color_3' => self::getColorInClear($colors[2]))
                );
                
                // "Draw and reveal a 8"
                $card = self::executeDraw($player_id, 8, 'revealed');
                // "If the drawn card is one of the chosen colors, score it and splay up that color"
                if ($card['color'] == $colors[0] || $card['color'] == $colors[1] || $card['color'] == $colors[2]) {
                    self::notifyGeneralInfo(clienttranslate('It matches a chosen color: ${color}.'), array('i18n' => array('color'), 'color' => self::getColorInClear($card['color'])));
                    self::scoreCard($card, $player_id);
                    self::splayUp($player_id, $player_id, $card['color']);

                // "Otherwise"
                } else {
                    self::notifyGeneralInfo(clienttranslate('It does not match any of the chosen colors.'));
                    self::transferCardFromTo($card, $player_id, 'hand');
                    self::setAuxiliaryValue($card['color']);
                    self::incrementStepMax(1);
                }
                break;

            // id 173, Artifacts age 6: Moonlight Sonata
            case "173N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color}.'), array('i18n' => array('color'), 'You' => 'You', 'color' => self::getColorInClear($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color}.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($choice)));
                self::setAuxiliaryValue($choice);
                break;

            // id 174, Artifacts age 6: Marcha Real
            case "174N1A":
                // TODO(LATER): Clean up the dead code branch.
                if ($this->innovationGameState->get('release_version') >= 2) {
                    if (self::getAuxiliaryValue() < 0) {
                        self::setAuxiliaryValue($card['id']);
                    } else {
                        self::setAuxiliaryValue2($card['id']);
                    }
                    $card = self::transferCardFromTo($card, $owner_to, 'revealed');
                    self::transferCardFromTo($card, 0, 'deck');
                } else {
                    // Do the transfer
                    $card = self::transferCardFromTo($card, $owner_to, 'revealed');
                    self::transferCardFromTo($card, 0, 'deck');
                }
                break;
                
            // id 179, Artifacts age 7: International Prototype Metre Bar
            case "179N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;

            // id 184, Artifacts age 7: The Communist Manifesto
            case "184N1A":
                // NOTE: It doesn't add any value if we log which player was chosen, since it will be obvious which player
                // is chosen when the card is transferred to them.
                self::setAuxiliaryValue($choice);
                break;
                
            // id 191, Artifacts age 8: Plush Beweglich Rod Bear
            case "191N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;

            // id 211, Artifacts age 10: Dolly the Sheep
            case "211N1A":
                if ($choice == 0) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose not to score your bottom yellow card.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses not to score his bottom yellow card.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                self::setAuxiliaryValue($choice);
                break;

            case "211N1B":
                $age_to_draw_in = self::getAgeToDrawIn($player_id, 1);
                if ($choice == 0) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose not to draw and tuck.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses not to draw and tuck.'), array('player_name' => self::getColoredPlayerName($player_id)));
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to draw and tuck.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to draw and tuck.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                self::setAuxiliaryValue($choice);
                break;
                
            // id 336, Echoes age 1: Comb
            case "336N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color}.'), array('i18n' => array('color'), 'You' => 'You', 'color' => self::getColorInClear($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color}.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($choice)));
                self::setAuxiliaryValue($choice);
                break;

            // id 337, Echoes age 1: Ice skates
            case "337N1B":
                if ($choice == 0) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to draw and foreshadow a ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare(3)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to draw and foreshadow a ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare(3)));
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to draw and meld a ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare(2)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to draw and meld a ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare(2)));
                }
                self::setAuxiliaryValue2($choice);
                break;
                
            // id 339, Echoes age 1: Chopsticks
            case "339N1A":
                if ($choice == 0) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose not to transfer a ${age} to the available achievements.'), array('You' => 'You', 'age' => self::getAgeSquare(1)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to not transfer a ${age} to the available achievements.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare(1)));
                }
                self::setAuxiliaryValue($choice);
                break;
                
            // id 341, Echoes age 1: Soap
            case "341N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color}.'), array('i18n' => array('color'), 'You' => 'You', 'color' => self::getColorInClear($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color}.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($choice)));
                self::setAuxiliaryValue($choice);
                break;

            // id 345, Echoes age 2: Lever
            case "345N1A":
                // Track the age of cards returned
                $age_counts = self::getAuxiliaryArray();
                $age_counts[$card['age'] - 1]++;
                self::setAuxiliaryArray($age_counts);

                // Do the transfer (return)
                self::transferCardFromTo($card, $owner_to, $location_to, $bottom_to, $score_keyword);
                break;

            case "345N1B":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                $age_counts = self::getAuxiliaryArray();
                $age_counts[$choice - 1]--; // there has to be at least one entry for this value
                self::setAuxiliaryArray($age_counts);
                
                // Draw the card of the selected age
                self::executeDraw($player_id, $choice);
                break;

            // id 346, Echoes age 2: Linguistics
            case "346E1A":
                if ($choice == 1) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to draw a ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare(3)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to draw a ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare(3)));
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to foreshadow a ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare(4)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to foreshadow a ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare(4)));
                }
                self::setAuxiliaryValue($choice);
                break;

            case "346N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;
            
            // id 347, Echoes age 2: Crossbow
            case "347N1A":
                self::setAuxiliaryValue($choice);
                break;

            // id 350, Echoes age 2: Scissors
            case "350N1B":
                self::setAuxiliaryValue($choice);
                break;

            case "350N1D":
                self::setAuxiliaryValue($choice);
                break;

            // id 351, Echoes age 2: Toothbrush
            case "351E1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;

            case "351N2A":
                if ($choice == 1) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to transfer a ${age} to the available achievements.'), array('You' => 'You', 'age' => self::getAgeSquare(2)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to transfer a ${age} to the available achievements.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare(2)));
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose not to transfer a ${age} to the available achievements.'), array('You' => 'You', 'age' => self::getAgeSquare(2)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to not transfer a ${age} to the available achievements.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare(2)));
                }
                self::setAuxiliaryValue($choice);
                break;
                
            // id 356, Echoes age 3: Magnifying Glass
            case "356N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;

            // id 358, Echoes age 3: Katana
            case "358D1A":
            case "358D1B":
                $card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                self::setAuxiliaryValue(self::getAuxiliaryValue() + self::countIconsOnCard($card, 4));
                
                // Do the transfer
                self::transferCardFromTo($card, $owner_to, $location_to, $bottom_to, $score_keyword);
                break;

            // id 359, Echoes age 3: Charitable Trust
            case "359E1A":
                if ($choice == 1) {
                    $age = 3;
                } else {
                    $age = 4;                
                }
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to draw a ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($age)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to draw a ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($age)));
                self::setAuxiliaryValue($choice);
                break;

            case "359N1B":
                if ($choice == 1) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to return your top green card.'), array('You' => 'You', 'age' => self::getAgeSquare(3)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to return his top green card.'), array('player_name' => self::getColoredPlayerName($player_id)));
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to achieve your top green card.'), array('You' => 'You', 'age' => self::getAgeSquare(4)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to achieve his top green card.'), array('player_name' => self::getColoredPlayerName($player_id)));
                }
                self::setAuxiliaryValue($choice);
                break;
            
            // id 364, Echoes age 3: Sunglasses
            case "364N1A":
                if ($choice == 1) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to splay your purple cards.'), array('You' => 'You'));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to splay his purple cards.'), array('player_name' => self::getColoredPlayerName($player_id)));                    
                } else {
                    $splay_direction = self::getCurrentSplayDirection($player_id, 4);
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to splay a non-purple pile ${splay_direction}.'), array('You' => 'You', 'splay_direction' => self::getSplayDirectionInClear($splay_direction)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to splay a non-purple pile ${splay_direction}.'), array('player_name' => self::getColoredPlayerName($player_id), 'splay_direction' => self::getSplayDirectionInClear($splay_direction)));
                }
                self::setAuxiliaryValue($choice);
                break;

            case "364N1B":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color}.'), array('i18n' => array('color'), 'You' => 'You', 'color' => self::getColorInClear($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color}.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($choice)));
                self::setAuxiliaryValue($choice);
                break;
                
            // id 370, Echoes age 4: Globe
            case "370N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color}.'), array('i18n' => array('color'), 'You' => 'You', 'color' => self::getColorInClear($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color}.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($choice)));
                self::setAuxiliaryValue($choice);
                break;

            // id 371, Echoes age 4: Barometer
            case "371N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                // "Draw and foreshadow a card of value two higher than a bonus on any board."
                self::executeDrawAndForeshadow($player_id, $choice);
                break;

            case "371N2A":
                // "You may reveal and return all cards in your forecast."
                $card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                $card = self::transferCardFromTo($card, $player_id, 'revealed');
                if ($card['color'] == 0) {
                    // "If any were blue, claim the Destiny achievement."
                    self::claimSpecialAchievement($player_id, 436);
                }
                self::transferCardFromTo($card, 0, 'deck');
                break;
                
            // id 372, Echoes age 4: Pencil
            case "372N1A":
                $card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                if ($card['age'] > self::getAuxiliaryValue()) {
                    self::setAuxiliaryValue($card['age']); // track max age
                }
                
                // Do the transfer
                self::transferCardFromTo($card, $owner_to, $location_to, $bottom_to, $score_keyword);
                break;

            // id 379, Echoes age 5: Palampore
            case "379N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;

            // id 380, Echoes age 5: Seed Drill
            case "380N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue2($choice);
                break;

            case "380N1B":
                $age_value = self::getAuxiliaryValue2();
                if ($choice == 1) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to transfer a ${age} to the available achievements.'), array('You' => 'You', 'age' => self::getAgeSquare($age_value)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to transfer a ${age} to the available achievements.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($age_value)));
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose not to transfer a ${age} to the available achievements.'), array('You' => 'You', 'age' => self::getAgeSquare($age_value)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to not transfer a ${age} to the available achievements.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($age_value)));
                }
                self::setAuxiliaryValue($choice);
                break;

            // id 381, Echoes age 5: Pressure Cooker
            case "381N1B":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue2($choice);
                break;

            // id 383, Echoes age 5: Piano
            case "383E1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue2($choice);
                break;

            // id 385, Echoes age 6: Bifocals
            case "385E1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue2($choice);
                break;

            // id 399, Echoes age 7: Jeans
            case "399N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;

            case "399N1B":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue2($choice);
                break;
            
            // id 400, Echoes age 7: Telegraph
            case "400N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the player ${player_choice}.'), 
                    array('You' => 'You', 
                    'player_choice' => self::getColoredPlayerName($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the player ${player_choice}.'), 
                    array('player_name' => self::getColoredPlayerName($player_id),
                    'player_choice' => self::getColoredPlayerName($choice)));
                self::setAuxiliaryValue($choice);
                self::incrementStepMax(1); // continue to next action if a selection was made
                break;

            case "400N1B":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${color}.'), array('i18n' => array('color'), 'You' => 'You', 'color' => self::getColorInClear($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${color}.'), array('i18n' => array('color'), 'player_name' => self::getColoredPlayerName($player_id), 'color' => self::getColorInClear($choice)));
                self::setAuxiliaryValue2($choice);
                break;

            // id 401, Echoes age 7: Elevator
            case "401E1A":
                if ($choice == 1) {
                    $card = self::getTopCardOnBoard($player_id, 2); /* green */
                } else {
                    $card = self::getBottomCardOnBoard($player_id, 2); /* green */
                }
                self::transferCardFromTo($card, $player_id, 'score', /*bottom_to=*/false, /*score_keyword=*/true);
                break;

            case "401N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;

            case "401N1B":
                $age = self::getAuxiliaryValue();
                if ($choice == 0) { // Score piles
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to transfer the ${age}s from all other score piles to your score pile.'), array('You' => 'You', 'age' => self::getAgeSquare($age)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to transfer the ${age}s from all other score piles to his score pile.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($age)));
                } else { // Hands
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to transfer the ${age}s from all other hands to your score pile.'), array('You' => 'You', 'age' => self::getAgeSquare($age)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to transfer the ${age}s from all other hands to his score pile.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($age)));
                }
                self::setAuxiliaryValue2($choice);
                break;

            // id 402, Echoes age 7: Fertilizer
            case "402N2A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                // "Draw and foreshadow a card of any value."
                self::executeDrawAndForeshadow($player_id, $choice);
                break;

            // id 403, Echoes age 7: Ice Cream
            case "403N1A":
                 self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue2($choice);
                break;

            // id 406, Echoes age 8: X-ray
            case "406N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue2($choice);
                break;
                
            case "403N1B":
                $age_value = self::getAuxiliaryValue2();
                if ($choice == 1) {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose to transfer a ${age} to the available achievements.'), array('You' => 'You', 'age' => self::getAgeSquare($age_value)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses to transfer a ${age} to the available achievements.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($age_value)));
                } else {
                    self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose not to transfer a ${age} to the available achievements.'), array('You' => 'You', 'age' => self::getAgeSquare($age_value)));
                    self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses not to transfer a ${age} to the available achievements.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($age_value)));
                }
                self::setAuxiliaryValue($choice);
                break;

            // id 413, Echoes age 8: Crossword
            case "413N1A":   
                $age_counts = self::getAuxiliaryArray();
                $age_counts[$choice]--;
                self::setAuxiliaryArray($age_counts);

                // Draw the card of the selected age
                self::executeDraw($player_id, $choice);
                break;
                
            // id 414, Echoes age 8: Television
            case "414N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;
                
            case "414N1B":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the player ${player_choice}.'), 
                    array('You' => 'You', 
                    'player_choice' => self::getColoredPlayerName($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the player ${player_choice}.'), 
                    array('player_name' => self::getColoredPlayerName($player_id),
                    'player_choice' => self::getColoredPlayerName($choice)));
                self::setAuxiliaryValue2($choice);
                break;

            // id 415, Echoes age 9: Calculator
            case "415N1A":
            case "415N1B":
                // Track the cards scored
                $card = self::getCardInfo($this->innovationGameState->get('id_last_selected'));
                $card_values = self::getAuxiliaryArray();
                $card_values[] = $card['faceup_age'];
                self::setAuxiliaryArray($card_values);
                self::transferCardFromTo($card, $owner_to, $location_to, $bottom_to, $score_keyword);
                break;

            // id 421, Echoes age 9: ATM
            case "421E1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;

            // id 423, Echoes age 9: Karaoke
            case "423E1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;

            case "423N1A":
                $encoded_card_ids = self::getIndexedAuxiliaryValue($player_id);
                $card_id_1 = $encoded_card_ids % 1000;
                $card_id_2 = (($encoded_card_ids - $card_id_1) / 1000) - 1;

                if ($choice == 1) {
                    self::setAuxiliaryValue($card_id_1);
                } else {
                    self::setAuxiliaryValue($card_id_2);
                }
                break;

            // id 426, Echoes age 10: Human Genome
            case "426N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;
                
            // id 428, Echoes age 10: Social Networking
            case "428D1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${icon}.'), array('You' => 'You', 'icon' => self::getIconSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${icon}.'), array('player_name' => self::getColoredPlayerName($player_id), 'icon' => self::getIconSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;

            // id 431, Echoes age 10: Cell Phone
            case "431N3A":
                // Do the transfer
                self::transferCardFromTo($card, $owner_to, $location_to, $bottom_to, $score_keyword);
                
                // "splaying up each color you tucked into."
                self::splayUp($player_id, $player_id, $card['color']);                
                break;

            // id 432, Echoes age 10: MP3
            case "432N2A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;
                
            // id 434, Echoes age 10: Sudoku
            case "434N1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose the value ${age}.'), array('You' => 'You', 'age' => self::getAgeSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses the value ${age}.'), array('player_name' => self::getColoredPlayerName($player_id), 'age' => self::getAgeSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;
                            
            // id 440, age 11: Climatology
            case "440D1A":
                self::notifyPlayer($player_id, 'log', clienttranslate('${You} choose ${icon}.'), array('You' => 'You', 'icon' => self::getIconSquare($choice)));
                self::notifyAllPlayersBut($player_id, 'log', clienttranslate('${player_name} chooses ${icon}.'), array('player_name' => self::getColoredPlayerName($player_id), 'icon' => self::getIconSquare($choice)));
                self::setAuxiliaryValue($choice);
                break;

                            
            default:
                if ($splay_direction == -1) {
                    if ($location_to == 'revealed,deck') {
                        self::transferCardFromTo($card, $owner_to, 'revealed'); // Reveal
                        self::returnCard($card); // Return
                    } else if ($location_to == 'revealed,score') {
                        self::transferCardFromTo($card, $owner_to, 'revealed'); // Reveal
                        self::transferCardFromTo($card, $owner_to, 'score', $bottom_to, $score_keyword); // Score
                    } else {
                        self::transferCardFromTo($card, $owner_to, $location_to, $bottom_to, $score_keyword);
                    }
                }
                else {
                    // Do the splay as stated in B
                    self::splay($player_id, $card['owner'], $card['color'], $splay_direction);
                }
                break;
            }
        }
        catch (EndOfGame $e) {
            // End of the game: the exception has reached the highest level of code
            self::trace('EOG bubbled from self::stInterSelectionMove');
            self::trace('interSelectionMove->justBeforeGameEnd');
            $this->gamestate->nextState('justBeforeGameEnd');
            return;
        }
        
        if ($special_type_of_choice == 0) {
            // Mark that one more card has been chosen and proceeded in that step
            $this->innovationGameState->increment('n');
            $this->innovationGameState->increment('n_min', -1);
            $this->innovationGameState->increment('n_max', -1);
            
            // Mark extra information about this chosen card
            $this->innovationGameState->set("age_last_selected", $card['age']);
            $this->innovationGameState->set("color_last_selected", $card['color']);
            $this->innovationGameState->set("owner_last_selected", $card['owner']);
        }
        // Check if another selection is to be done
        if ($special_type_of_choice != 0 || $this->innovationGameState->get('n_max') == 0) { // No more choice can be made
            // Unset the selection
            self::deselectAllCards();
            // End of this interaction step
            self::trace('interSelectionMove->interInteractionStep');
            $this->gamestate->nextState('interInteractionStep');
            return;
        }
        // New selection move
        $this->innovationGameState->set('can_pass', 0); // Passing is no longer possible (stopping will be if n_min == 0)
        self::trace('interSelectionMove->preSelectionMove');
        $this->gamestate->nextState('preSelectionMove');        
    }
    
    function stJustBeforeGameEnd() {
        switch($this->innovationGameState->get('game_end_type')) {
        case 0: // achievements
            self::notifyEndOfGameByAchievements();
            self::setStat(true, 'end_achievements');
            self::notifyAll('endOfGame', '', array('end_of_game_type' => 'achievements'));
            break;
        case 1: // score
            // Important value for winning is no more the number of achievements but the score
            // Promote player score to BGA score
            // Keeping the number of achivement as BGA auxiliary score as tie breaker
            self::promoteScoreToBGAScore();
            self::notifyEndOfGameByScore();
            self::setStat(true, 'end_score');
            self::notifyAll('endOfGame', '', array('end_of_game_type' => 'score'));
            break;
        case -1: // dogma
            // In that case, the score is modified so that the winner team got 1, the losers 0, there is no tie breaker
            self::binarizeBGAScore();
            self::notifyEndOfGameByDogma();
            self::setStat(true, 'end_dogma');
            self::notifyAll('endOfGame', '', array('end_of_game_type' => 'dogma'));
            break;
        default:
            break;
        }
        
        self::trace('justBeforeGameEnd->gameEnd');
        $this->gamestate->nextState(); // End the game
    }

//////////////////////////////////////////////////////////////////////////////
//////////// Zombie
////////////

    /*
        zombieTurn:
        
        This method is called each time it is the turn of a player who has quit the game (= "zombie" player).
        You can do whatever you want in order to make sure the turn of this player ends appropriately
        (ex: pass).
    */

    function zombieTurn($state, $active_player) {
        throw new feException( "Zombie mode not supported at this moment" );
        $statename = $state['name'];
        
        if ($state['type'] == "activeplayer") {
            $player_name = self::getPlayerNameFromId($active_player);
            self::notifyAll('log', clienttranslate('The turn of ${player_name} is skipped.'), array('player_name' => $player_name));
            switch ($statename) {
                case 'playerTurn':
                    self::trace('playerTurn->interPlayerTurn (zombie)');
                    $this->gamestate->nextState('interPlayerTurn');
                    break;
                case 'selectionMove':
                    self::trace('selectionMove->interInteractionStep (zombie)');
                    $this->gamestate->nextState('interInteractionStep');
                    // Set the player choices as "pass" (this will work even if he is normally not supposed to)
                    $this->innovationGameState->set('id_last_selected', -1);
                    $this->innovationGameState->set('choice', -2);
                    self::deselectAllCards(); // Deselect all the cards the player could choose if he had not quitted
                    // --> There are further implications in self::stInterInteractionStep
                    break;
                default:
                    break;
            }

            return;
        }

        if ($state['type'] == "multipleactiveplayer") {
            // state turn0
            // Make sure player is in a non blocking status for role turn
            $sql = "
                UPDATE  player
                SET     player_is_multiactive = 0
                WHERE   player_id = $active_player
            ";
            self::DbQuery($sql);

            $this->gamestate->updateMultiactiveOrNextState('');
            return;
        }

        throw new feException("Zombie mode not supported at this game state: ".$statename);
    }
    
    function isZombie($player_id) {
        return self::getUniqueValueFromDB(self::format("
            SELECT player_zombie FROM player WHERE player_id={player_id}
        ", array('player_id' => $player_id)));
    }
}
